<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Analysis Report - WGS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            border-bottom: 4px solid #667eea;
            padding-bottom: 15px;
        }
        .meta {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 30px;
        }
        .severity {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85em;
            margin: 5px 0;
        }
        .critical { background: #ff4444; color: white; }
        .high { background: #ff9800; color: white; }
        .medium { background: #ffc107; color: #333; }
        .low { background: #4caf50; color: white; }
        
        .issue {
            margin: 30px 0;
            padding: 20px;
            border-left: 5px solid #ddd;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .issue.critical-issue { border-left-color: #ff4444; background: #fff5f5; }
        .issue.high-issue { border-left-color: #ff9800; background: #fff8f3; }
        .issue.medium-issue { border-left-color: #ffc107; background: #fffdf3; }
        
        .issue h3 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .issue-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .file-reference {
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #d63384;
            border-left: 3px solid #d63384;
            overflow-x: auto;
        }
        
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .quick-fix {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .quick-fix h4 {
            color: #2e7d32;
            margin-bottom: 8px;
        }
        
        .impact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        .impact-item {
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .impact-item strong {
            color: #667eea;
        }
        
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
        }
        .summary-table thead {
            background: #667eea;
            color: white;
        }
        .summary-table th, .summary-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .summary-table tbody tr:hover {
            background: #f5f5f5;
        }
        
        .priority-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        .priority-box {
            padding: 20px;
            border-radius: 8px;
            color: white;
        }
        .priority-box h4 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .priority-box ul {
            list-style: none;
            padding-left: 0;
        }
        .priority-box li {
            margin: 5px 0;
            padding-left: 20px;
            position: relative;
        }
        .priority-box li:before {
            content: "✓";
            position: absolute;
            left: 0;
        }
        
        .priority-immediate { background: linear-gradient(135deg, #ff4444, #ff6666); }
        .priority-high { background: linear-gradient(135deg, #ff9800, #ffb74d); }
        .priority-medium { background: linear-gradient(135deg, #ffc107, #ffd54f); }
        .priority-nice { background: linear-gradient(135deg, #4caf50, #66bb6a); }
        
        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Security Analysis Report</h1>
        <div class="meta">
            <strong>Project:</strong> White Glove Service Authentication System<br>
            <strong>Date:</strong> 2025-11-16<br>
            <strong>Focus:</strong> Authentication & Session Management
        </div>

        <h2 style="margin-top: 40px; margin-bottom: 20px;">Top 10 Critical Issues</h2>
        
        <!-- ISSUE 1 -->
        <div class="issue critical-issue">
            <h3>
                <span class="issue-number">1</span>
                KRITICKÉ: Chybí brute-force protection pro user login
                <span class="severity critical">CRITICAL 9.8/10</span>
            </h3>
            <div class="file-reference">
                /home/user/moje-stranky/app/controllers/login_controller.php (řádky 105-129)
            </div>
            <div class="impact-grid">
                <div class="impact-item">
                    <strong>Impact:</strong> Vysoké - Přímý útok na všechny uživatelské účty
                </div>
                <div class="impact-item">
                    <strong>Exploitability:</strong> Triviální - Jednoduchý brute-force skript
                </div>
            </div>
            <p><strong>Problém:</strong> Funkce handleUserLogin() nemá checkRateLimit() call. Útočník může provádět neomezené přihlašovací pokusy.</p>
            <div class="code-block">// CHYBÍ:
$identifier = $_SERVER['REMOTE_ADDR'] . ':' . $email;
$rate = checkRateLimit('user_login_' . $identifier, 5, 900);
if (!$rate['allowed']) {
    respondError('Příliš mnoho pokusů...', 429);
}</div>
            <div class="quick-fix">
                <h4>Fix:</h4>
                Přidejte checkRateLimit() na začátku handleUserLogin() jako je v handleAdminLogin()
            </div>
        </div>

        <!-- ISSUE 2 -->
        <div class="issue high-issue">
            <h3>
                <span class="issue-number">2</span>
                VYSOKÉ: Client-side admin_login_attempts tracking
                <span class="severity high">HIGH 8.5/10</span>
            </h3>
            <div class="file-reference">
                /home/user/moje-stranky/assets/js/login.js (řádky 98-134)
            </div>
            <div class="impact-grid">
                <div class="impact-item">
                    <strong>Impact:</strong> Vysoké - Obejití rate limitingu
                </div>
                <div class="impact-item">
                    <strong>Exploitability:</strong> Velmi snadné - DevTools console
                </div>
            </div>
            <p><strong>Exploit:</strong> Útočník může spustit: <code>localStorage.removeItem('admin_login_attempts')</code></p>
            <div class="code-block">// DevTools Console
localStorage.removeItem('admin_login_attempts')
// Counter je resetován - lze pokusit se znovu!</div>
            <div class="quick-fix">
                <h4>Fix:</h4>
                Přesunout počítání pokusů do session/serveru namísto localStorage
            </div>
        </div>

        <!-- ISSUE 3 -->
        <div class="issue high-issue">
            <h3>
                <span class="issue-number">3</span>
                VYSOKÉ: Slabé frontend password requirements
                <span class="severity high">HIGH 8.0/10</span>
            </h3>
            <div class="file-reference">
                /home/user/moje-stranky/assets/js/registration.js (řádka 46)<br>
                /home/user/moje-stranky/config/config.php (řádky 200-241)
            </div>
            <div class="impact-grid">
                <div class="impact-item">
                    <strong>Impact:</strong> Střední - UX problém
                </div>
                <div class="impact-item">
                    <strong>Issue:</strong> Mismatch frontend vs backend
                </div>
            </div>
            <p><strong>Frontend:</strong> Přijímá 8+ znaků | <strong>Backend:</strong> Vyžaduje 12+ + velké/malé/číslo/speciální</p>
            <div class="quick-fix">
                <h4>Fix:</h4>
                Synchronizovat frontend validaci s backend isStrongPassword()
            </div>
        </div>

        <!-- ISSUE 4 -->
        <div class="issue high-issue">
            <h3>
                <span class="issue-number">4</span>
                VYSOKÉ: Session cookie SameSite=Lax místo Strict
                <span class="severity high">HIGH 7.8/10</span>
            </h3>
            <div class="file-reference">
                /home/user/moje-stranky/init.php (řádka 62)
            </div>
            <p><strong>Problém:</strong> <code>ini_set('session.cookie_samesite', 'Lax')</code></p>
            <p>Lax umožňuje cookie v cross-site TOP-level navigaci - mělo by být Strict</p>
            <div class="quick-fix">
                <h4>Fix:</h4>
                <code>ini_set('session.cookie_samesite', 'Strict');</code>
            </div>
        </div>

        <!-- ISSUE 5 -->
        <div class="issue high-issue">
            <h3>
                <span class="issue-number">5</span>
                VYSOKÉ: CSRF token se neobnovuje během session
                <span class="severity high">HIGH 7.5/10</span>
            </h3>
            <div class="file-reference">
                /home/user/moje-stranky/includes/csrf_helper.php (řádky 17-22)
            </div>
            <p><strong>Problém:</strong> Token se vygeneruje jednou a používá po dobu celé session</p>
            <p><strong>Risk:</strong> Pokud je token uniknut (XSS), je kompromitován dlouhodobě</p>
            <div class="quick-fix">
                <h4>Fix:</h4>
                Implementovat regenerateCSRFToken() s regenerací po login/logout a periodicky
            </div>
        </div>

        <!-- ISSUE 6 -->
        <div class="issue high-issue">
            <h3>
                <span class="issue-number">6</span>
                VYSOKÉ: Absence inactivity timeout
                <span class="severity high">HIGH 7.2/10</span>
            </h3>
            <div class="file-reference">
                /home/user/moje-stranky/init.php (řádky 63-64)
            </div>
            <p><strong>Problém:</strong> Pouze absolutní timeout (3600s), chybí inactivity timeout</p>
            <p><strong>Risk:</strong> Neopuštěné okno = aktivní session 60 minut bez ohledu na aktivitu</p>
            <div class="quick-fix">
                <h4>Fix:</h4>
                Přidat last_activity tracking a kontrolu v každém controlleru
            </div>
        </div>

        <!-- ISSUE 7 -->
        <div class="issue medium-issue">
            <h3>
                <span class="issue-number">7</span>
                STŘEDNĚ VYSOKÉ: Login bez CSRF token refresh
                <span class="severity medium">MEDIUM-HIGH 7.0/10</span>
            </h3>
            <div class="file-reference">
                /home/user/moje-stranky/app/controllers/login_controller.php (řádka 136)
            </div>
            <p><strong>Problém:</strong> Po session_regenerate_id() se CSRF token neobnovuje</p>
            <div class="quick-fix">
                <h4>Fix:</h4>
                Zavolat regenerateCSRFToken() po úspěšném login a vrátit nový token v response
            </div>
        </div>

        <!-- ISSUE 8 -->
        <div class="issue medium-issue">
            <h3>
                <span class="issue-number">8</span>
                STŘEDNĚ VYSOKÉ: Logout bez CSRF ochrany
                <span class="severity medium">MEDIUM-HIGH 6.8/10</span>
            </h3>
            <div class="file-reference">
                /home/user/moje-stranky/logout.php (celý soubor)
            </div>
            <p><strong>Problém:</strong> Logout nevaliduje CSRF token</p>
            <p><strong>Risk:</strong> Logout CSRF - <code>&lt;img src="logout.php"&gt;</code> na cizí stránce</p>
            <div class="quick-fix">
                <h4>Fix:</h4>
                Vyžadovat POST s CSRF tokenem a require_once init.php + csrf_helper.php
            </div>
        </div>

        <!-- ISSUE 9 -->
        <div class="issue medium-issue">
            <h3>
                <span class="issue-number">9</span>
                STŘEDNĚ VYSOKÉ: Slabý admin rate limiting
                <span class="severity medium">MEDIUM-HIGH 6.5/10</span>
            </h3>
            <div class="file-reference">
                /home/user/moje-stranky/app/controllers/login_controller.php (řádka 62)
            </div>
            <p><strong>Problém:</strong> Jen 5 pokusů za 900 sekund (15 minut)</p>
            <p><strong>Doporučení:</strong> 3 pokusy za 10 minut + přidat 2FA/MFA</p>
        </div>

        <!-- ISSUE 10 -->
        <div class="issue medium-issue">
            <h3>
                <span class="issue-number">10</span>
                NÍZKÉ-STŘEDNÍ: Absence session fingerprinting
                <span class="severity medium">MEDIUM 6.0/10</span>
            </h3>
            <div class="file-reference">
                /home/user/moje-stranky/includes/user_session_check.php (řádky 12-26)
            </div>
            <p><strong>Problém:</strong> Session se nevaliduje na User-Agent nebo IP</p>
            <p><strong>Risk:</strong> Session hijacking - pokud je cookie украden, útočník se může přihlásit</p>
            <div class="quick-fix">
                <h4>Fix:</h4>
                Implementovat validateSessionFingerprint() pro User-Agent a IP validation
            </div>
        </div>

        <!-- SUMMARY TABLE -->
        <h2 style="margin-top: 50px; margin-bottom: 20px;">Quick Reference Table</h2>
        <table class="summary-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Issue</th>
                    <th>Severity</th>
                    <th>File</th>
                    <th>Priority</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>1</strong></td>
                    <td>Bez brute-force pro user login</td>
                    <td><span class="severity critical">CRITICAL</span></td>
                    <td>login_controller.php:105</td>
                    <td><strong>IMMEDIATE</strong></td>
                </tr>
                <tr>
                    <td><strong>2</strong></td>
                    <td>Client-side login attempts</td>
                    <td><span class="severity high">HIGH</span></td>
                    <td>login.js:98</td>
                    <td><strong>IMMEDIATE</strong></td>
                </tr>
                <tr>
                    <td><strong>3</strong></td>
                    <td>Slabé password validation</td>
                    <td><span class="severity high">HIGH</span></td>
                    <td>registration.js:46</td>
                    <td><strong>IMMEDIATE</strong></td>
                </tr>
                <tr>
                    <td><strong>4</strong></td>
                    <td>SameSite=Lax</td>
                    <td><span class="severity high">HIGH</span></td>
                    <td>init.php:62</td>
                    <td><strong>HIGH</strong></td>
                </tr>
                <tr>
                    <td><strong>5</strong></td>
                    <td>CSRF token se neobnovuje</td>
                    <td><span class="severity high">HIGH</span></td>
                    <td>csrf_helper.php:17</td>
                    <td><strong>HIGH</strong></td>
                </tr>
                <tr>
                    <td><strong>6</strong></td>
                    <td>Absence inactivity timeout</td>
                    <td><span class="severity high">HIGH</span></td>
                    <td>init.php:63</td>
                    <td><strong>HIGH</strong></td>
                </tr>
                <tr>
                    <td><strong>7</strong></td>
                    <td>Login bez CSRF token refresh</td>
                    <td><span class="severity medium">MEDIUM-HIGH</span></td>
                    <td>login_controller.php:136</td>
                    <td><strong>MEDIUM</strong></td>
                </tr>
                <tr>
                    <td><strong>8</strong></td>
                    <td>Logout bez CSRF ochrany</td>
                    <td><span class="severity medium">MEDIUM-HIGH</span></td>
                    <td>logout.php:1</td>
                    <td><strong>MEDIUM</strong></td>
                </tr>
                <tr>
                    <td><strong>9</strong></td>
                    <td>Slabý admin rate limiting</td>
                    <td><span class="severity medium">MEDIUM-HIGH</span></td>
                    <td>login_controller.php:62</td>
                    <td><strong>MEDIUM</strong></td>
                </tr>
                <tr>
                    <td><strong>10</strong></td>
                    <td>Absence session fingerprinting</td>
                    <td><span class="severity medium">MEDIUM</span></td>
                    <td>user_session_check.php:12</td>
                    <td><strong>MEDIUM</strong></td>
                </tr>
            </tbody>
        </table>

        <!-- PRIORITY GRID -->
        <h2 style="margin-top: 50px; margin-bottom: 20px;">Action Items by Priority</h2>
        <div class="priority-grid">
            <div class="priority-box priority-immediate">
                <h4>IMMEDIATE (24 hodin)</h4>
                <ul>
                    <li>Přidat rate limiting pro user login</li>
                    <li>Přesunout admin_login_attempts na server</li>
                    <li>Synchronizovat frontend password validation</li>
                </ul>
            </div>
            <div class="priority-box priority-high">
                <h4>HIGH (1 týden)</h4>
                <ul>
                    <li>Změnit SameSite na Strict</li>
                    <li>Implementovat CSRF token regeneraci</li>
                    <li>Přidat inactivity timeout</li>
                    <li>Obnovit CSRF token po login</li>
                </ul>
            </div>
            <div class="priority-box priority-medium">
                <h4>MEDIUM (2 týdny)</h4>
                <ul>
                    <li>Chraňte logout CSRF tokenem</li>
                    <li>Zvyšte admin rate limiting</li>
                    <li>Přidejte session fingerprinting</li>
                </ul>
            </div>
            <div class="priority-box priority-nice">
                <h4>NICE-TO-HAVE (1 měsíc)</h4>
                <ul>
                    <li>Přidat 2FA/MFA</li>
                    <li>Email notifications</li>
                    <li>Account lockout</li>
                    <li>Vylepšit password reset</li>
                </ul>
            </div>
        </div>

        <footer>
            <strong>Security Analysis Report</strong><br>
            Generated: 2025-11-16 | White Glove Service Authentication System<br>
            Detailní MD report: SECURITY_ANALYSIS_2025.md
        </footer>
    </div>
</body>
</html>
