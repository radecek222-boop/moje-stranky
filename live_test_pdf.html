<!DOCTYPE html>
<html lang='cs'>
<head>
    <meta charset='UTF-8'>
    <title>LIVE TEST: PDF Upload</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1400px;
               margin: 20px auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px;
                     box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2D5016; }
        .btn { padding: 12px 24px; background: #2D5016; color: white;
               border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #1a300d; }
        .section { background: #f8f9fa; padding: 20px; border-radius: 5px;
                   margin: 20px 0; border-left: 4px solid #007acc; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        pre { background: #1e1e1e; color: #d4d4d4; padding: 15px;
              border-radius: 5px; overflow-x: auto; }
        #log { min-height: 200px; max-height: 600px; overflow-y: auto; }
    </style>
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }
    </script>
</head>
<body>
<div class='container'>
    <h1>üîç LIVE TEST: PDF Parsov√°n√≠</h1>

    <div class='section'>
        <h2>Krok 1: Vyberte PDF soubor</h2>
        <input type="file" id="pdfInput" accept="application/pdf">
        <button class='btn' onclick="testPDF()">üìÑ ANALYZOVAT PDF</button>
    </div>

    <div class='section'>
        <h2>V√Ωsledky testu:</h2>
        <div id="log">
            <p style="color: #666;">ƒåek√°m na nahr√°n√≠ PDF...</p>
        </div>
    </div>
</div>

<script>
function log(message, type = 'info') {
    const logDiv = document.getElementById('log');
    const time = new Date().toLocaleTimeString();
    const colors = {
        info: '#007acc',
        success: '#28a745',
        error: '#dc3545',
        warning: '#ffc107'
    };

    const entry = document.createElement('div');
    entry.style.marginBottom = '10px';
    entry.style.color = colors[type] || colors.info;
    entry.innerHTML = `<strong>[${time}]</strong> ${message}`;

    logDiv.appendChild(entry);
    logDiv.scrollTop = logDiv.scrollHeight;
}

function logJSON(label, data) {
    const logDiv = document.getElementById('log');
    const pre = document.createElement('pre');
    pre.textContent = `${label}:\n${JSON.stringify(data, null, 2)}`;
    logDiv.appendChild(pre);
    logDiv.scrollTop = logDiv.scrollHeight;
}

async function testPDF() {
    const input = document.getElementById('pdfInput');
    const file = input.files[0];

    if (!file) {
        log('‚ùå Nebyl vybr√°n ≈æ√°dn√Ω soubor!', 'error');
        return;
    }

    document.getElementById('log').innerHTML = '';
    log(`üìÑ Naƒç√≠t√°m PDF: ${file.name}`, 'info');

    try {
        // KROK 1: Extrakce textu pomoc√≠ PDF.js
        log('üîç KROK 1: Extrahuji text z PDF pomoc√≠ PDF.js...', 'info');

        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        log(`‚úÖ PDF naƒçteno: ${pdf.numPages} str√°nek`, 'success');

        let celkovyText = '';
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const textContent = await page.getTextContent();
            const textItems = textContent.items.map(item => item.str).join(' ');
            celkovyText += textItems + ' ';
        }

        log(`‚úÖ Text extrahov√°n: ${celkovyText.length} znak≈Ø`, 'success');
        logJSON('RAW TEXT (prvn√≠ch 500 znak≈Ø)', celkovyText.substring(0, 500));

        // KROK 2: Odesl√°n√≠ na API
        log('üåê KROK 2: Odes√≠l√°m text na API...', 'info');

        // Z√≠skat CSRF token
        const csrfResponse = await fetch('app/controllers/get_csrf_token.php');
        const csrfData = await csrfResponse.json();
        const csrfToken = csrfData.token || '';

        log(`‚úÖ CSRF token z√≠sk√°n: ${csrfToken.substring(0, 20)}...`, 'success');

        // Odeslat na parsing API
        const formData = new FormData();
        formData.append('pdf_text', celkovyText);
        formData.append('csrf_token', csrfToken);

        const apiResponse = await fetch('api/parse_povereni_pdf.php', {
            method: 'POST',
            body: formData
        });

        const apiResult = await apiResponse.json();

        log(`üì° API odpovƒõƒè status: ${apiResponse.status}`, apiResponse.ok ? 'success' : 'error');
        logJSON('API ODPOVƒöƒé', apiResult);

        // KROK 3: Anal√Ωza v√Ωsledk≈Ø
        log('üß™ KROK 3: Anal√Ωza dat z API...', 'info');

        if (apiResult.status === 'success') {
            const data = apiResult.data.data || apiResult.data;

            const poleKontrola = [
                { key: 'cislo', label: 'ƒå√≠slo reklamace' },
                { key: 'ulice', label: 'Ulice a ƒåP' },
                { key: 'jmeno', label: 'Jm√©no' },
                { key: 'email', label: 'Email' },
                { key: 'telefon', label: 'Telefon' },
                { key: 'mesto', label: 'Mƒõsto' },
                { key: 'psc', label: 'PSƒå' }
            ];

            log('<br><strong>KONTROLA VYPLNƒöN√ùCH POL√ç:</strong>', 'info');

            poleKontrola.forEach(pole => {
                const hodnota = data[pole.key];
                if (hodnota && hodnota.trim()) {
                    log(`‚úÖ ${pole.label}: <strong>"${hodnota}"</strong>`, 'success');
                } else {
                    log(`‚ùå ${pole.label}: NEN√ç VYPLNƒöNO`, 'error');
                }
            });

            if (!data.ulice || !data.ulice.trim()) {
                log('<br>üîç DIAGNOSTIKA: Pole "ulice" nen√≠ vyplnƒõno!', 'warning');
                log('Mo≈æn√© p≈ô√≠ƒçiny:', 'warning');
                log('1. Pattern v datab√°zi nen√≠ spr√°vn√Ω', 'warning');
                log('2. Mapping kl√≠ƒç se neshoduje', 'warning');
                log('3. Text v PDF m√° jin√Ω form√°t', 'warning');
            }

            if (!data.cislo || !data.cislo.trim()) {
                log('<br>üîç DIAGNOSTIKA: Pole "cislo" nen√≠ vyplnƒõno!', 'warning');
                log('Pattern pro ƒç√≠slo reklamace nena≈°el shodu v textu', 'warning');
            }

        } else {
            log(`‚ùå API vr√°tilo chybu: ${apiResult.message}`, 'error');
        }

    } catch (error) {
        log(`‚ùå CHYBA: ${error.message}`, 'error');
        console.error(error);
    }
}
</script>
</body>
</html>
