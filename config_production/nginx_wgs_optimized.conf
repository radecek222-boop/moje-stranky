# ==========================================
# Nginx Configuration for WGS Service
# ==========================================
# Soubor: /etc/nginx/sites-available/wgs-service.cz
# Symlink: ln -s /etc/nginx/sites-available/wgs-service.cz /etc/nginx/sites-enabled/
# Test: sudo nginx -t
# Reload: sudo systemctl reload nginx
#
# OptimalizovÃ¡no pro:
# - 150+ concurrent users
# - HTTPS only
# - Gzip compression
# - Static file caching
# - PHP-FPM backend
# ==========================================

# HTTP -> HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name wgs-service.cz www.wgs-service.cz;

    # Redirect all HTTP to HTTPS
    return 301 https://www.wgs-service.cz$request_uri;
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name wgs-service.cz www.wgs-service.cz;

    # Root directory
    root /home/user/moje-stranky;
    index index.php index.html;

    # ==========================================
    # SSL CONFIGURATION
    # ==========================================

    ssl_certificate /etc/letsencrypt/live/wgs-service.cz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/wgs-service.cz/privkey.pem;

    # SSL protocols (TLS 1.2+)
    ssl_protocols TLSv1.2 TLSv1.3;

    # SSL ciphers (modern, secure)
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # SSL session cache (improve performance)
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # OCSP stapling (faster SSL handshake)
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/wgs-service.cz/chain.pem;

    # ==========================================
    # SECURITY HEADERS
    # ==========================================

    # HSTS (force HTTPS for 1 year)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # XSS protection
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # CSP (Content Security Policy)
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; img-src 'self' data: blob: https://maps.geoapify.com; font-src 'self' data: https://fonts.googleapis.com https://fonts.gstatic.com; connect-src 'self' https://api.geoapify.com https://maps.geoapify.com;" always;

    # Referrer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Permissions policy (disable unused features)
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # ==========================================
    # LOGGING
    # ==========================================

    access_log /var/log/nginx/wgs-access.log combined buffer=32k flush=5s;
    error_log /var/log/nginx/wgs-error.log warn;

    # ==========================================
    # CLIENT LIMITS
    # ==========================================

    # Max upload size (must match PHP upload_max_filesize)
    client_max_body_size 50M;

    # Client body timeout
    client_body_timeout 60s;

    # Client header timeout
    client_header_timeout 60s;

    # ==========================================
    # GZIP COMPRESSION (CRITICAL for performance!)
    # ==========================================

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;  # 1-9, higher = more CPU, better compression
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;

    # Disable gzip for IE6
    gzip_disable "msie6";

    # Min file size to compress (bytes)
    gzip_min_length 1000;

    # ==========================================
    # STATIC FILE CACHING
    # ==========================================

    # CSS, JS - cache for 7 days
    location ~* \.(css|js)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Images - cache for 30 days
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Fonts - cache for 1 year
    location ~* \.(woff|woff2|ttf|otf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # PDFs, documents - cache for 1 day
    location ~* \.(pdf|doc|docx|xls|xlsx)$ {
        expires 1d;
        add_header Cache-Control "private";
    }

    # ==========================================
    # DENY ACCESS TO SENSITIVE FILES
    # ==========================================

    # Deny .env files
    location ~ /\.env {
        deny all;
        return 404;
    }

    # Deny .git directory
    location ~ /\.git {
        deny all;
        return 404;
    }

    # Deny .htaccess files (Apache config)
    location ~ /\.ht {
        deny all;
        return 404;
    }

    # Deny backup files
    location ~ \.(sql|bak|backup|old)$ {
        deny all;
        return 404;
    }

    # Deny access to logs
    location ^~ /logs/ {
        deny all;
        return 404;
    }

    # Deny access to config
    location ^~ /config/ {
        deny all;
        return 404;
    }

    # ==========================================
    # PHP-FPM BACKEND
    # ==========================================

    location ~ \.php$ {
        # Security: Check that file exists
        try_files $uri =404;

        # Pass to PHP-FPM
        fastcgi_pass unix:/run/php/php8.4-fpm-wgs.sock;
        fastcgi_index index.php;

        # FastCGI params
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        # FastCGI timeouts (must be >= PHP request_terminate_timeout)
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_read_timeout 60s;

        # FastCGI buffering (improves performance)
        fastcgi_buffering on;
        fastcgi_buffer_size 16k;
        fastcgi_buffers 16 16k;
        fastcgi_busy_buffers_size 32k;

        # Hide PHP version
        fastcgi_hide_header X-Powered-By;
    }

    # ==========================================
    # PHP-FPM STATUS PAGE (monitoring)
    # ==========================================

    location = /fpm-status {
        access_log off;
        allow 127.0.0.1;  # Only localhost
        allow ::1;
        deny all;

        fastcgi_pass unix:/run/php/php8.4-fpm-wgs.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    location = /fpm-ping {
        access_log off;
        allow 127.0.0.1;
        allow ::1;
        deny all;

        fastcgi_pass unix:/run/php/php8.4-fpm-wgs.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # ==========================================
    # NGINX STATUS (monitoring)
    # ==========================================

    location = /nginx-status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow ::1;
        deny all;
    }

    # ==========================================
    # DEFAULT LOCATION
    # ==========================================

    location / {
        # Try files, then directory, then PHP handler
        try_files $uri $uri/ /index.php?$query_string;
    }

    # ==========================================
    # API ENDPOINTS (special handling)
    # ==========================================

    # API cache headers (NO cache for API responses)
    location ^~ /api/ {
        add_header Cache-Control "no-store, no-cache, must-revalidate, private";
        add_header Pragma "no-cache";
        expires -1;

        try_files $uri $uri/ /index.php?$query_string;
    }

    # ==========================================
    # UPLOADS DIRECTORY
    # ==========================================

    # Protect uploads - only authenticated access
    location ^~ /uploads/ {
        # This should be handled by PHP (authentication check)
        # But we can add basic protection here
        try_files $uri =404;
    }
}

# ==========================================
# MAIN NGINX.CONF OPTIMIZATIONS
# ==========================================
# Add to /etc/nginx/nginx.conf inside http {}:
#
# # Worker processes (= CPU cores)
# worker_processes auto;
#
# # Worker connections (max connections per worker)
# events {
#     worker_connections 2048;
#     use epoll;  # Linux optimization
#     multi_accept on;
# }
#
# # Connection handling
# http {
#     # Keepalive (reuse connections)
#     keepalive_timeout 65;
#     keepalive_requests 100;
#
#     # Sendfile (efficient file transfer)
#     sendfile on;
#     tcp_nopush on;
#     tcp_nodelay on;
#
#     # Server tokens (hide Nginx version)
#     server_tokens off;
#
#     # Types hash
#     types_hash_max_size 2048;
#
#     # Open file cache (improves performance)
#     open_file_cache max=10000 inactive=30s;
#     open_file_cache_valid 60s;
#     open_file_cache_min_uses 2;
#     open_file_cache_errors on;
#
#     # Buffer sizes
#     client_body_buffer_size 128k;
#     client_header_buffer_size 1k;
#     large_client_header_buffers 4 4k;
# }
#
# ==========================================
# MONITORING COMMANDS
# ==========================================
#
# Check Nginx status:
#   curl http://localhost/nginx-status
#
# Check PHP-FPM status:
#   curl http://localhost/fpm-status?full
#
# Test configuration:
#   sudo nginx -t
#
# Reload config (no downtime):
#   sudo systemctl reload nginx
#
# View access log live:
#   tail -f /var/log/nginx/wgs-access.log
#
# View error log:
#   tail -f /var/log/nginx/wgs-error.log
#
# Check SSL certificate:
#   sudo certbot certificates
#
# Renew SSL certificate:
#   sudo certbot renew --dry-run
