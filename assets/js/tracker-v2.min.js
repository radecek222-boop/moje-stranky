!function(){"use strict";const e={sessionTimeout:18e5,heartbeatInterval:3e4,apiEndpoint:"/api/track_v2.php",debug:!1};let t=null,n=null,o=null,i=Date.now(),a=[],r=[];async function s(){try{e.debug&&console.log("[WGS Analytics V2] Inicializuji tracking..."),await async function(){const o=localStorage.getItem("wgs_last_activity"),i=Date.now();o&&i-parseInt(o)<e.sessionTimeout?(t=localStorage.getItem("wgs_session_id"),e.debug&&console.log("[WGS Analytics V2] Používám existující relaci:",t)):(t="sess_"+c(),localStorage.setItem("wgs_session_id",t),sessionStorage.setItem("wgs_session_start",i),sessionStorage.setItem("wgs_entry_page",window.location.href),e.debug&&console.log("[WGS Analytics V2] Vytvořena nová relace:",t));localStorage.setItem("wgs_last_activity",i),n=await async function(){if(void 0===window.FingerprintModule)return e.debug&&console.warn("[WGS Analytics V2] FingerprintModule není dostupný, používám fallback"),l();try{return(await window.FingerprintModule.getOrGenerateFingerprint()).fingerprintId}catch(e){return console.error("[WGS Analytics V2] Chyba při získání fingerprintu:",e),l()}}()}(),await u(),o=setInterval(()=>{const t=Date.now();localStorage.setItem("wgs_last_activity",t),e.debug&&console.log("[WGS Analytics V2] Heartbeat - aktivita aktualizována")},e.heartbeatInterval),e.debug&&console.log("[WGS Analytics V2] Heartbeat spuštěn (interval:",e.heartbeatInterval,"ms)"),e.debug&&(console.log("[WGS Analytics V2] Tracking inicializován úspěšně"),console.log("[WGS Analytics V2] Session ID:",t),console.log("[WGS Analytics V2] Fingerprint ID:",n))}catch(e){console.error("[WGS Analytics V2] Chyba při inicializaci:",e)}}function c(){return Date.now().toString(36)+Math.random().toString(36).substring(2,15)}function l(){let e=localStorage.getItem("wgs_fallback_fingerprint");return e||(e="fp_fallback_"+c(),localStorage.setItem("wgs_fallback_fingerprint",e)),e}async function u(){try{const o=function(){const t=new URLSearchParams(window.location.search),n={utm_source:t.get("utm_source"),utm_medium:t.get("utm_medium"),utm_campaign:t.get("utm_campaign"),utm_term:t.get("utm_term"),utm_content:t.get("utm_content")},o=n.utm_source||n.utm_medium||n.utm_campaign;if(o){localStorage.getItem("wgs_utm_first_click")||localStorage.setItem("wgs_utm_first_click",JSON.stringify({...n,timestamp:Date.now()})),sessionStorage.setItem("wgs_utm_last_click",JSON.stringify({...n,timestamp:Date.now()}));let t=[];const o=localStorage.getItem("wgs_utm_conversion_path");if(o)try{t=JSON.parse(o)}catch(e){t=[]}const i=`${n.utm_source}|${n.utm_medium}|${n.utm_campaign}`;return t.some(e=>`${e.utm_source}|${e.utm_medium}|${e.utm_campaign}`===i)||(t.push({...n,timestamp:Date.now()}),t.length>10&&(t=t.slice(-10)),localStorage.setItem("wgs_utm_conversion_path",JSON.stringify(t))),e.debug&&(console.log("[WGS Analytics V2] UTM Parameters detected:",n),console.log("[WGS Analytics V2] Conversion Path length:",t.length)),n}{const e=sessionStorage.getItem("wgs_utm_last_click");if(e)try{const t=JSON.parse(e);return{utm_source:t.utm_source,utm_medium:t.utm_medium,utm_campaign:t.utm_campaign,utm_term:t.utm_term,utm_content:t.utm_content}}catch(e){}const t=localStorage.getItem("wgs_utm_first_click");if(t)try{const e=JSON.parse(t);return{utm_source:e.utm_source,utm_medium:e.utm_medium,utm_campaign:e.utm_campaign,utm_term:e.utm_term,utm_content:e.utm_content}}catch(e){}}return n}(),s={device_type:g(),browser:d(),os:m(),screen_width:screen.width,screen_height:screen.height,viewport_width:window.innerWidth,viewport_height:window.innerHeight,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,language:navigator.language},c=p(),l=function(){const e={};e.webdriver=!!(navigator.webdriver||window.navigator.webdriver||window.callPhantom||window._phantom),e.headless=!1,navigator.userAgent.includes("HeadlessChrome")&&(e.headless=!0);navigator.plugins&&0===navigator.plugins.length&&!navigator.userAgent.includes("Mobile")&&(e.headless=!0);navigator.userAgent.includes("Firefox")&&!window.sidebar&&(e.headless=!0);e.automation=!!(window.phantom||window._phantom||window.callPhantom||window.Buffer||window.emit&&window.spawn);const t=Date.now()-i;e.pageview_speed_ms=t,a.length>0?e.mouse_movement_entropy=function(e){if(e.length<5)return 0;let t=0,n=null;for(let o=1;o<e.length;o++){const i=e[o].x-e[o-1].x,a=e[o].y-e[o-1].y,r=Math.atan2(a,i);if(null!==n){t+=Math.abs(r-n)}n=r}const o=(e.length-2)*Math.PI,i=Math.min(t/o,1);return parseFloat(i.toFixed(2))}(a):e.mouse_movement_entropy=0;r.length>1?e.keyboard_timing_variance=function(e){if(e.length<2)return 0;const t=[];for(let n=1;n<e.length;n++)t.push(e[n]-e[n-1]);const n=t.reduce((e,t)=>e+t,0)/t.length,o=t.reduce((e,t)=>e+Math.pow(t-n,2),0)/t.length,i=Math.min(o/1e4,1);return parseFloat(i.toFixed(2))}(r):e.keyboard_timing_variance=null;navigator.permissions&&(e.permissions_available=!0);navigator.getBattery||navigator.userAgent.includes("Mobile")||(e.no_battery_api=!0);return e}(),u={csrf_token:c,session_id:t,fingerprint_id:n,page_url:window.location.href,page_title:document.title,referrer:document.referrer||null,...o,...s,bot_signals:l};e.debug&&console.log("[WGS Analytics V2] Odesílám pageview:",u);const _=await fetch(e.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)}),w=await _.json();"success"===w.status?(e.debug&&console.log("[WGS Analytics V2] Pageview zaznamenán:",w),w.data&&w.data.session&&w.data.session.engagement_score&&sessionStorage.setItem("wgs_engagement_score",w.data.session.engagement_score)):console.error("[WGS Analytics V2] Chyba při sledování pageview:",w.message)}catch(e){console.error("[WGS Analytics V2] Síťová chyba při sledování pageview:",e)}}function g(){const e=navigator.userAgent.toLowerCase();return/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(e)?"tablet":/mobile|iphone|ipod|android|blackberry|opera mini|iemobile|wpdesktop/i.test(e)?"mobile":"desktop"}function d(){const e=navigator.userAgent;return e.indexOf("Firefox")>-1?"Firefox":e.indexOf("Edg")>-1?"Edge":e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Safari")>-1?"Safari":e.indexOf("Opera")>-1||e.indexOf("OPR")>-1?"Opera":e.indexOf("Trident")>-1?"Internet Explorer":"Unknown"}function m(){const e=navigator.userAgent;return e.indexOf("Win")>-1?"Windows":e.indexOf("Mac")>-1?"macOS":e.indexOf("Linux")>-1?"Linux":e.indexOf("Android")>-1?"Android":e.indexOf("iOS")>-1||e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1?"iOS":"Unknown"}function p(){const e=document.querySelector('meta[name="csrf-token"]');if(e)return e.getAttribute("content");const t=document.querySelector('input[name="csrf_token"]');return t?t.value:(console.warn("[WGS Analytics V2] CSRF token nebyl nalezen"),"")}document.addEventListener("mousemove",function(e){(0===a.length||Date.now()-a[a.length-1].timestamp>100)&&(a.push({x:e.clientX,y:e.clientY,timestamp:Date.now()}),a.length>50&&a.shift())}),document.addEventListener("keydown",function(){r.push(Date.now()),r.length>30&&r.shift()}),document.addEventListener("visibilitychange",function(){document.hidden&&(localStorage.setItem("wgs_last_activity",Date.now()),e.debug&&console.log("[WGS Analytics V2] Stránka skryta - aktivita uložena"))}),window.addEventListener("beforeunload",function(){localStorage.setItem("wgs_last_activity",Date.now()),o&&(clearInterval(o),o=null,e.debug&&console.log("[WGS Analytics V2] Heartbeat zastaven"))}),window.WgsTrackerV2={trackPageview:async function(){await u()},getSessionId:function(){return t},getFingerprintId:function(){return n},setDebug:function(t){e.debug=t},getEngagementScore:function(){return sessionStorage.getItem("wgs_engagement_score")},trackConversion:async function(n,o=null,i=0,a=null){try{if(!t)throw new Error("Session ID není k dispozici. Tracker ještě není inicializován.");if(!n)throw new Error("Conversion type je povinný parametr.");const r=p();if(!r)throw new Error("CSRF token není k dispozici.");const s={session_id:t,conversion_type:n,conversion_label:o,conversion_value:parseFloat(i)||0,metadata:a?JSON.stringify(a):null,csrf_token:r};e.debug&&console.log("[WGS Analytics V2] Tracking conversion:",s);const c=await fetch("/api/track_conversion.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(s)}),l=await c.json();if("success"===l.status)return e.debug&&console.log("[WGS Analytics V2] Conversion tracked successfully:",l.data),l;throw console.error("[WGS Analytics V2] Chyba při trackování konverze:",l.message),new Error(l.message)}catch(e){throw console.error("[WGS Analytics V2] Chyba při trackování konverze:",e),e}}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s(),setTimeout(function e(){if("undefined"!=typeof EventTracker){if(!t||!n)return console.warn("[WGS Analytics V2] Session ID nebo Fingerprint ID není k dispozici, opakuji za 1s..."),void setTimeout(e,1e3);console.log("[WGS Analytics V2] Inicializuji Event Tracker..."),EventTracker.init({sessionId:t,fingerprintId:n,csrfToken:csrfToken,apiEndpoint:"/api/track_event.php",batchSize:50,sendInterval:5e3,trackClicks:!0,trackScroll:!0,trackRageClicks:!0,trackCopyPaste:!0,trackFormInteractions:!0,trackIdleState:!0,scrollDebounce:500,idleTimeout:3e4}),console.log("[WGS Analytics V2] Event Tracker inicializován")}else console.warn("[WGS Analytics V2] EventTracker není načten, přeskakuji event tracking.")},2e3),setTimeout(function e(){if("undefined"==typeof ReplayRecorder)return void console.warn("[WGS Analytics V2] ReplayRecorder není načten, přeskakuji session replay.");if(!t)return console.warn("[WGS Analytics V2] Session ID není k dispozici, opakuji za 1s..."),void setTimeout(e,1e3);const n=parseInt(sessionStorage.getItem("wgs_page_index")||"0");console.log("[WGS Analytics V2] Inicializuji Replay Recorder (page_index: "+n+")..."),ReplayRecorder.init({sessionId:t,pageUrl:window.location.href,pageIndex:n,csrfToken:csrfToken,recordMouseMove:!0,recordClicks:!0,recordScroll:!0,recordResize:!0,mouseMoveThrottle:100,scrollThrottle:150,maxBatchSize:50,batchInterval:3e4,apiEndpoint:"/api/track_replay.php"}),sessionStorage.setItem("wgs_page_index",n+1),console.log("[WGS Analytics V2] Replay Recorder inicializován")},2500)}();
//# sourceMappingURL=tracker-v2.min.js.map