console.log("üîç SEZNAM.JS NAƒåTEN - VERZE: 20251123-03 (event listener cleanup)"),window.csrfTokenCache=window.csrfTokenCache||null;let originalFetch=window.fetch||fetch;async function getCSRFToken(){if(window.csrfTokenCache)return window.csrfTokenCache;try{var e=await(await originalFetch("/app/controllers/get_csrf_token.php")).json();return window.csrfTokenCache=e.token,e.token}catch(e){return"undefined"!=typeof logger&&logger.error("Chyba z√≠sk√°n√≠ CSRF tokenu:",e),""}}function showToast(e,t="info"){var o=document.getElementById("wgs-toast");o&&o.remove();let a=document.createElement("div");a.id="wgs-toast",a.textContent=e,a.style.cssText=`
    position: fixed;
    top: 80px;
    right: 20px;
    background: ${"success"!==t&&"error"===t?"#666":"#333"};
    color: white;
    padding: 16px 24px;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    font-size: 14px;
    font-weight: 600;
    min-width: 250px;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
  `;o=document.createElement("style");o.textContent=`
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  `,document.getElementById("wgs-toast-styles")||(o.id="wgs-toast-styles",document.head.appendChild(o)),document.body.appendChild(a),setTimeout(()=>{a.style.animation="slideOut 0.3s ease-in",setTimeout(()=>a.remove(),300)},3e3)}let WGS_DATA_CACHE=[],ACTIVE_FILTER="all",CURRENT_RECORD=null,SELECTED_DATE=null,SELECTED_TIME=null,CURRENT_PAGE=1,HAS_MORE_PAGES=!1,LOADING_MORE=!1,PER_PAGE=50,CAL_MONTH=(new Date).getMonth(),CAL_YEAR=(new Date).getFullYear(),SEARCH_QUERY="",WGS_ADDRESS="Dubƒçe 364, Bƒõchovice 190 11, ƒåesk√° republika",WGS_COORDS={lat:50.0472,lng:14.5881},DISTANCE_CACHE={},Utils={getCustomerName:e=>e.jmeno||e.zakaznik||"Nezn√°m√Ω z√°kazn√≠k",getAddress:e=>e.adresa||(0<(e=[e.ulice,e.mesto,e.psc].filter(e=>e)).length?e.join(", "):"‚Äî"),getProduct:e=>e.model||e.vyrobek||"‚Äî",getOrderId:(e,t=0)=>e.cislo||e.reklamacniCislo||e.id||"WGS-"+(t+1),isCompleted:e=>"HOTOVO"===e.stav||"done"===e.stav,escapeHtml:e=>{var t=document.createElement("div");return t.textContent=e,t.innerHTML},addCountryToAddress:e=>e&&(e.toLowerCase().includes("ƒçesk")?e:e+", ƒåesk√° republika"),filterByUserRole:e=>{if(!CURRENT_USER||CURRENT_USER.is_admin||"prodejce"!==CURRENT_USER.role)return e;let t=String(CURRENT_USER.id),o=(CURRENT_USER.supervised_user_ids||[]).map(String);return e.filter(e=>{e=String(e.zpracoval_id);return e===t||!!o.includes(e)})}},CacheManager={load:()=>{try{var e=localStorage.getItem("wgs_distance_cache");e&&(DISTANCE_CACHE=JSON.parse(e),logger.log("Naƒçteno",Object.keys(DISTANCE_CACHE).length,"vzd√°lenost√≠ z cache"))}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ cache:",e)}},save:()=>{try{localStorage.setItem("wgs_distance_cache",JSON.stringify(DISTANCE_CACHE))}catch(e){logger.error("Chyba p≈ôi ukl√°d√°n√≠ cache:",e)}}},AUTO_REFRESH_INTERVAL=6e4,autoRefreshTimer=null,lastRefreshTime=Date.now();function startAutoRefresh(){autoRefreshTimer&&clearInterval(autoRefreshTimer),autoRefreshTimer=setInterval(async()=>{"visible"===document.visibilityState&&(logger.log("[AutoRefresh] Automaticka aktualizace dat..."),await loadAll(ACTIVE_FILTER),lastRefreshTime=Date.now())},AUTO_REFRESH_INTERVAL),logger.log(`[AutoRefresh] Spusten - interval ${AUTO_REFRESH_INTERVAL/1e3}s`)}function stopAutoRefresh(){autoRefreshTimer&&(clearInterval(autoRefreshTimer),autoRefreshTimer=null,logger.log("[AutoRefresh] Zastaven"))}function initSearch(){var e=document.getElementById("searchInput");let t=document.getElementById("searchClear");var o=new URLSearchParams(window.location.search).get("search");o&&(e.value=o,SEARCH_QUERY=o.trim().toLowerCase(),t.classList.add("visible"),window.history.replaceState({},document.title,window.location.pathname)),e.addEventListener("input",e=>{SEARCH_QUERY=e.target.value.trim().toLowerCase(),t.classList.toggle("visible",0<SEARCH_QUERY.length),renderOrders(Utils.filterByUserRole(WGS_DATA_CACHE))}),e.addEventListener("keydown",e=>{"Escape"===e.key&&clearSearch()})}function clearSearch(){var e=document.getElementById("searchInput"),t=document.getElementById("searchClear"),e=(e.value="",SEARCH_QUERY="",t.classList.remove("visible"),Utils.filterByUserRole(WGS_DATA_CACHE));renderOrders(e)}function highlightText(e,t){return Utils.highlightText?Utils.highlightText(e,t):Utils.escapeHtml(e)}function matchesSearch(e,t){return!t||[Utils.getCustomerName(e),e.telefon||"",e.email||"",Utils.getAddress(e),Utils.getProduct(e),Utils.getOrderId(e),e.popis_problemu||""].join(" ").toLowerCase().includes(t)}function initFilters(){document.querySelectorAll(".filter-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),ACTIVE_FILTER=e.dataset.filter,renderOrders(Utils.filterByUserRole(WGS_DATA_CACHE))})})}function updateCounts(e){var t,o,a;Array.isArray(e)&&(t=e.length,o=e.filter(e=>{e=e.stav||"wait";return"ƒåEK√Å"===e||"wait"===e}).length,a=e.filter(e=>{e=e.stav||"wait";return"DOMLUVEN√Å"===e||"open"===e}).length,e=e.filter(e=>{e=e.stav||"wait";return"HOTOVO"===e||"done"===e}).length,document.getElementById("count-all").textContent=`(${t})`,document.getElementById("count-wait").textContent=`(${o})`,document.getElementById("count-open").textContent=`(${a})`,document.getElementById("count-done").textContent=`(${e})`)}async function loadAll(o="all",a=!1){try{var n=a?CURRENT_PAGE+1:1,i=await fetch(`app/controllers/load.php?status=${o}&page=${n}&per_page=`+PER_PAGE);if(!i.ok)throw new Error("Chyba naƒç√≠t√°n√≠");var r=await i.json();let e=[];"success"===r.status&&Array.isArray(r.data)?e=r.data:Array.isArray(r)&&(e=r),CURRENT_PAGE=a?(WGS_DATA_CACHE=[...WGS_DATA_CACHE,...e],n):(WGS_DATA_CACHE=e,1),HAS_MORE_PAGES=e.length===PER_PAGE,LOADING_MORE=!1;var d=Utils.filterByUserRole(WGS_DATA_CACHE);updateCounts(d),renderOrders(d),updateLoadMoreButton(),lastRefreshTime=Date.now()}catch(e){logger.error("Chyba:",e),WGS_DATA_CACHE=[],document.getElementById("orderGrid").innerHTML=`
      <div class="empty-state">
        <div class="empty-state-text">${t("data_load_error")}</div>
      </div>
    `}}async function renderOrders(e=null){var o=document.getElementById("orderGrid"),a=document.getElementById("searchResultsInfo");e=e||Utils.filterByUserRole(WGS_DATA_CACHE);let n=e=Array.isArray(e)?e:[];if("all"!==ACTIVE_FILTER){let t={wait:["ƒåEK√Å","wait"],open:["DOMLUVEN√Å","open"],done:["HOTOVO","done"]};n=e.filter(e=>{e=e.stav||"wait";return t[ACTIVE_FILTER]?.includes(e)})}e=n.length;if(SEARCH_QUERY?(0<(n=n.filter(e=>matchesSearch(e,SEARCH_QUERY))).length?(a.className="search-results-info",a.textContent=t("search_results_found").replace("{count}",n.length).replace("{total}",e).replace("{query}",SEARCH_QUERY)):(a.className="search-results-info no-results",a.textContent=t("no_search_results").replace("{query}",SEARCH_QUERY)),a.classList.remove("hidden")):a.classList.add("hidden"),0===n.length)o.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-text">${SEARCH_QUERY?t("no_results_found"):t("no_claims_to_display")}</div>
      </div>
    `;else{let p={};try{var i=await(await fetch("api/notes_api.php?action=get_unread_counts")).json();"success"===i.status&&(p=i.unread_counts||{})}catch(e){logger.warn("Nepoda≈ôilo se naƒç√≠st unread counts:",e)}n.sort((e,t)=>{e=new Date(e.created_at||e.datum_reklamace||e.timestamp||0);return new Date(t.created_at||t.datum_reklamace||t.timestamp||0)-e}),o.innerHTML=n.map((e,t)=>{var o=Utils.getCustomerName(e),a=Utils.getProduct(e),n=formatDate(e.created_at||e.datum_reklamace),i=getStatus(e.stav),t=Utils.getOrderId(e,t);let r=Utils.getAddress(e),d=("‚Äî"!==r&&(s=r.split(",").map(e=>e.trim()),r=s.slice(0,2).join(", ")),"");"open"===i.class&&e.termin&&e.cas_navstevy&&(d=formatAppointment(e.termin,e.cas_navstevy));var s=e.id,s=p[s]||0,l=0<s,o=SEARCH_QUERY?highlightText(o,SEARCH_QUERY):o,c=SEARCH_QUERY?highlightText(r,SEARCH_QUERY):r,a=SEARCH_QUERY?highlightText(a,SEARCH_QUERY):a,t=SEARCH_QUERY?highlightText(t,SEARCH_QUERY):t;return`
      <div class="order-box ${SEARCH_QUERY&&matchesSearch(e,SEARCH_QUERY)?"search-match":""} ${"status-bg-"+i.class}" data-action="showDetailById" data-id="${e.id}">
        <div class="order-header">
          <div class="order-number">${t}</div>
          <div style="display: flex; gap: 0.4rem; align-items: center;">
            <div class="order-notes-badge ${l?"has-unread pulse":""}" data-action="showNotes" data-id="${e.id}" title="${0<s?s+" nep≈ôeƒçten√©":"Pozn√°mky"}">
              <span class="notes-icon">‚úé</span>${0<s?s:""}
            </div>
            <div class="order-status status-${i.class}"></div>
          </div>
        </div>
        <div class="order-body">
          <div class="order-customer">${o}</div>
          <div class="order-detail-line">${c}</div>
          <div class="order-detail-row">
            <div class="order-detail-left">
              <div class="order-detail-line">${a}</div>
              <div class="order-detail-line" style="opacity: 0.6;">${n}</div>
            </div>
            <div class="order-detail-right">
              ${d?`<span class="order-appointment">${d}</span>`:`<span class="order-status-text status-${i.class}">${i.text}</span>`}
            </div>
          </div>
        </div>
      </div>
    `}).join("");e=Object.values(p).reduce((e,t)=>e+t,0),a=document.getElementById("unreadNotesIndicator"),i=document.getElementById("unreadNotesCount");a&&i&&(0<e?(i.textContent=e,a.style.display="block"):a.style.display="none"),window.UNREAD_COUNTS_MAP=p}}function filterUnreadNotes(){let t=window.UNREAD_COUNTS_MAP||{};var e=WGS_DATA_CACHE.filter(e=>{e=e.id;return 0<t[e]}),o=(logger.log(`[Seznam] Filtrov√°n√≠ nep≈ôeƒçten√Ωch pozn√°mek: ${e.length} karet`),document.getElementById("orderGrid"));0===e.length?o.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-text">≈Ω√°dn√© nep≈ôeƒçten√© pozn√°mky</div>
      </div>
    `:(renderOrders(e),window.scrollTo({top:0,behavior:"smooth"}))}window.addEventListener("DOMContentLoaded",async()=>{CacheManager.load(),initFilters(),initSearch(),await loadAll(),startAutoRefresh(),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&3e4<Date.now()-lastRefreshTime&&(logger.log("[AutoRefresh] Tab aktivni - nacitam nova data..."),loadAll(ACTIVE_FILTER))}),setTimeout(()=>{window.WGSNotifikace&&"function"==typeof window.WGSNotifikace.zobrazitDialogPovoleni&&window.WGSNotifikace.zobrazitDialogPovoleni()},3e3)});let ModalManager={show:e=>{document.getElementById("modalContent").innerHTML=e,window.detailModal&&window.detailModal.open?window.detailModal.open():(window.scrollLock&&window.scrollLock.enable("detail-overlay"),document.body.classList.add("modal-open"),document.getElementById("detailOverlay").classList.add("active")),setTimeout(()=>{var e=document.querySelector("#detailOverlay .modal-content");e&&(e.scrollTop=0)},10)},close:()=>{window.detailModal&&window.detailModal.close?window.detailModal.close():(document.getElementById("detailOverlay").classList.remove("active"),setTimeout(()=>{document.body.classList.remove("modal-open"),window.scrollLock&&window.scrollLock.disable("detail-overlay")},50)),CURRENT_RECORD=null,SELECTED_DATE=null,SELECTED_TIME=null},createHeader:(e,t)=>`
      <div class="modal-header">
        <button class="modal-close-btn" data-action="closeDetail" aria-label="Zav≈ô√≠t" title="Zav≈ô√≠t">√ó</button>
        <h2 class="modal-title">${e}</h2>
        ${t?`<p class="modal-subtitle">${t}</p>`:""}
      </div>
    `,createActions:e=>`
      <div class="modal-actions">
        ${e.join("")}
      </div>
    `};function createCustomerHeader(){var e,t,o,a,n;return CURRENT_RECORD?(e=Utils.getCustomerName(CURRENT_RECORD),t=Utils.getAddress(CURRENT_RECORD),o=CURRENT_RECORD.termin?formatDate(CURRENT_RECORD.termin):"‚Äî",a=CURRENT_RECORD.cas_navstevy||"‚Äî",n=getStatus(CURRENT_RECORD.stav),ModalManager.createHeader(e,`
    <strong>Adresa:</strong> ${t}<br>
    <strong>Term√≠n:</strong> ${o} ${"‚Äî"!==a?"v "+a:""}<br>
    <strong>Stav:</strong> ${n.text}
  `)):""}async function showDetail(o){let e;if("string"==typeof o){if(!(e=WGS_DATA_CACHE.find(e=>e.id==o||e.reklamace_id==o)))return void wgsToast.error(t("record_not_found"))}else e=WGS_DATA_CACHE.find(e=>e.id==o.id||e.reklamace_id==o.reklamace_id)||o;autoAssignTechnician((CURRENT_RECORD=e).reklamace_id||e.cislo||e.id).catch(e=>logger.warn("Auto-assign technika se nezda≈ôilo:",e.message));Utils.getCustomerName(e),Utils.getAddress(e),e.termin&&formatDate(e.termin),e.cas_navstevy,getStatus(e.stav);var a=Utils.isCompleted(e);let n="";n=a?`
      <div class="detail-info-box">
        <div class="detail-info-box-title">Zak√°zka dokonƒçena</div>
        <div class="detail-info-box-subtitle">Vy≈ô√≠zeno dne ${e.updated_at?formatDate(e.updated_at):"‚Äî"} v ${(a=e.updated_at?new Date(e.updated_at):null)?a.getHours()+":"+String(a.getMinutes()).padStart(2,"0"):"‚Äî"}</div>
      </div>

      <div class="detail-buttons">
        ${CURRENT_USER&&"prodejce"===CURRENT_USER.role?"":`
          <button class="detail-btn detail-btn-primary" data-action="reopenOrder" data-id="${e.id}">Znovu otev≈ô√≠t</button>
          <button class="detail-btn detail-btn-secondary" data-action="showContactMenu" data-id="${e.id}">Kontaktovat</button>
        `}
        <button class="detail-btn detail-btn-secondary" data-action="showCustomerDetail" data-id="${e.id}">Detail z√°kazn√≠ka</button>
        ${e.original_reklamace_id?`
          <button class="detail-btn detail-btn-secondary" data-action="showHistoryPDF" data-original-id="${e.original_reklamace_id}">Historie z√°kazn√≠ka</button>
        `:""}
        ${e.documents&&0<e.documents.length?`
          <button class="detail-btn detail-btn-primary" data-action="openPDF" data-pdf-path="${e.documents[0].file_path}" data-id="${e.id}">PDF Report</button>
        `:`
          <div class="detail-info-box" style="margin: 0; padding: 0.5rem;">
            <div class="detail-info-box-subtitle">PDF report je≈°tƒõ nebyl vytvo≈ôen</div>
          </div>
        `}
        <button class="detail-btn detail-btn-secondary" data-action="showVideoteka" data-id="${e.id}">Videot√©ka</button>
      </div>
    `:`
      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <button class="btn" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem; background: #1a1a1a; color: white;" data-action="startVisit" data-id="${e.id}">Zah√°jit n√°v≈°tƒõvu</button>

        <button class="btn" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem; background: #1a1a1a; color: white;" data-action="showCalendar" data-id="${e.id}">Napl√°novat term√≠n</button>

        <button class="btn" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem;" data-action="showContactMenu" data-id="${e.id}">Kontaktovat</button>
        <button class="btn" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem;" data-action="showCustomerDetail" data-id="${e.id}">Detail z√°kazn√≠ka</button>
        <button class="btn" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem;" data-action="showVideoteka" data-id="${e.id}">Videot√©ka</button>
        <button class="btn btn-secondary" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem;" data-action="closeDetail">Zav≈ô√≠t</button>
      </div>
    `;a=`
    ${createCustomerHeader()}

    <div class="modal-body">
      ${n}
    </div>
  `;ModalManager.show(a)}function closeDetail(){ModalManager.close()}async function reopenOrder(o){var e=WGS_DATA_CACHE.find(e=>e.id==o);if(e){var a=Utils.getCustomerName(e),e=Utils.getProduct(e);if(await wgsConfirm(t("confirm_reopen_order").replace("{customer}",a).replace("{product}",e),t("confirm_yes")||"Ano",t("confirm_no")||"Ne"))try{var n=await getCSRFToken(),i=new FormData,r=(i.append("action","reopen"),i.append("original_id",o),i.append("csrf_token",n),await fetch("/app/controllers/save.php",{method:"POST",body:i})),d=await r.json();if(!r.ok)throw new Error(`HTTP ${r.status}: `+(d.message||r.statusText));if("success"!==d.status)throw new Error(d.message||"Nepoda≈ôilo se vytvo≈ôit novou zak√°zku");var s=d.new_id,l=d.new_workflow_id;logger.log(`Nov√° zak√°zka vytvo≈ôena: ${l} (ID: ${s})`),wgsToast.success(`Nov√° zak√°zka ${l} vytvo≈ôena`,5e3),"function"==typeof loadAll&&await loadAll(ACTIVE_FILTER),showDetail(s)}catch(e){logger.error("Chyba p≈ôi znovuotev≈ôen√≠ zak√°zky:",e),wgsToast.error(t("error_reopening_order")+": "+e.message)}else logger.log("Znovuotev≈ôen√≠ zru≈°eno u≈æivatelem")}else wgsToast.error(t("record_not_found"))}async function showHistoryPDF(e){if(e)try{logger.log("üìö Naƒç√≠t√°m historii PDF z p≈Øvodn√≠ zak√°zky: "+e);var t=await fetch("/api/get_original_documents.php?reklamace_id="+encodeURIComponent(e));if(!t.ok)throw new Error(`HTTP ${t.status}: `+t.statusText);var o,a=await t.json();if("error"===a.status){if(a.message&&a.message.includes("nebyla nalezena"))return void wgsToast.error("P≈Øvodn√≠ zak√°zka byla smaz√°na.\n\nHistorie PDF nen√≠ k dispozici.");throw new Error(a.message||"Nepoda≈ôilo se naƒç√≠st dokumenty")}a.documents&&0!==a.documents.length?(o=a.documents[0],logger.log("Otev√≠r√°m PDF: "+o.file_path),zobrazPDFModal(o.file_path,e,"historie")):wgsToast.info("Historie PDF nen√≠ k dispozici.\n\nP≈Øvodn√≠ zak√°zka je≈°tƒõ nem√° vytvo≈ôen√Ω PDF dokument.")}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ historie PDF:",e),wgsToast.error(`Nepoda≈ôilo se naƒç√≠st historii PDF:
`+e.message)}else wgsToast.error("Chyb√≠ ID p≈Øvodn√≠ zak√°zky")}function normalizeCustomerData(e){var t,e={...e};return!e.jmeno&&e.zakaznik&&(e.jmeno=e.zakaznik),!e.zakaznik&&e.jmeno&&(e.zakaznik=e.jmeno),!e.adresa&&(e.ulice||e.mesto||e.psc)&&(t=[],e.ulice&&t.push(e.ulice),e.mesto&&t.push(e.mesto),e.psc&&t.push(e.psc),e.adresa=t.join(", ")),!e.adresa||e.ulice&&e.mesto||(t=e.adresa.split(",").map(e=>e.trim()),!e.ulice&&t[0]&&(e.ulice=t[0]),!e.mesto&&t[1]&&(e.mesto=t[1]),!e.psc&&t[2]&&(e.psc=t[2])),e}window.reopenOrder=reopenOrder;let startVisitInProgress=!1;function startVisit(o){var e,a;startVisitInProgress||(startVisitInProgress=!0,(e=WGS_DATA_CACHE.find(e=>e.id==o))?Utils.isCompleted(e)?(wgsToast.warning(t("visit_already_completed")),startVisitInProgress=!1):(e=normalizeCustomerData(e),localStorage.setItem("currentCustomer",JSON.stringify(e)),localStorage.setItem("visitStartTime",(new Date).toISOString()),a="photoSections_"+e.id,localStorage.removeItem(a),logger.log("Normalizovan√° data ulo≈æena:",e),window.location.href="photocustomer.php?new=true"):(wgsToast.error(t("record_not_found")),startVisitInProgress=!1))}async function saveData(a,e){try{var n=await getCSRFToken();let o=new FormData;Object.keys(a).forEach(e=>{o.append(e,a[e])}),o.append("action","update"),o.append("csrf_token",n);var i=await fetch("/app/controllers/save.php",{method:"POST",body:o}),r=await i.json();if(!i.ok)throw new Error(`HTTP ${i.status}: `+(r.message||i.statusText));"success"===r.status?(Object.keys(a).forEach(e=>{var t=WGS_DATA_CACHE.find(e=>e.id==a.id);t&&"action"!==e&&(t[e]=a[e]),CURRENT_RECORD&&CURRENT_RECORD.id==a.id&&"action"!==e&&(CURRENT_RECORD[e]=a[e])}),wgsToast.success(e),await loadAll(ACTIVE_FILTER),a.id?(closeDetail(),setTimeout(()=>showDetail(a.id),100)):closeDetail()):wgsToast.error(t("error")+": "+(r.message||t("failed_to_save")))}catch(e){logger.error("Chyba p≈ôi ukl√°d√°n√≠:",e),wgsToast.error(t("save_error")+": "+e.message)}}function showLoading(e=null){e=e||t("loading");var o=document.getElementById("loadingOverlay"),a=document.getElementById("loadingText");o&&a&&(a.textContent=e,o.classList.add("show"))}function hideLoading(){var e=document.getElementById("loadingOverlay");e&&e.classList.remove("show")}function showCalendar(t){var e=WGS_DATA_CACHE.find(e=>e.id==t);e&&(CURRENT_RECORD=e,SELECTED_DATE=null,SELECTED_TIME=null,e=`
    ${createCustomerHeader()}

    <!-- Vybran√Ω term√≠n - fixn√≠ nad kalend√°≈ôem -->
    <div id="selectedDateDisplay" style="display: none; background: #f5f5f5; border: 2px solid #666; color: #333; font-size: 0.85rem; padding: 0.5rem 1rem; margin: 0 1rem; border-radius: 4px; font-weight: 600; text-align: center; font-family: inherit;"></div>

    <!-- Varov√°n√≠ o kolizi - skryt√©, zobraz√≠ se p≈ôi v√Ωbƒõru obsazen√©ho ƒçasu -->
    <div id="collisionWarning" style="display: none; background: #fee; border: 2px solid #c00; color: #900; font-size: 0.85rem; padding: 0.5rem 1rem; margin: 0.5rem 1rem 0; border-radius: 4px; font-weight: 600; text-align: center; font-family: inherit;"></div>

    <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 1rem;">
      <div class="calendar-container">
        <div id="calGrid"></div>
        <div id="distanceInfo"></div>
        <div id="dayBookings"></div>
        <div id="timeGrid"></div>
      </div>
    </div>

    <div class="detail-buttons">
      <button class="detail-btn detail-btn-primary" data-action="saveSelectedDate">Ulo≈æit term√≠n</button>
      <button class="detail-btn detail-btn-secondary" data-action="showDetail">Zpƒõt</button>
    </div>
  `,ModalManager.show(e),e=new Date,CAL_MONTH=e.getMonth(),CAL_YEAR=e.getFullYear(),renderCalendar(CAL_MONTH,CAL_YEAR))}function previousMonth(){var e=new Date,o=e.getMonth(),e=e.getFullYear();let a=CAL_MONTH-1,n=CAL_YEAR;a<0&&(a=11,n--),n<e||n===e&&a<o?wgsToast.warning(t("cannot_show_past_months")):(CAL_MONTH=a,CAL_YEAR=n,renderCalendar(CAL_MONTH,CAL_YEAR))}function nextMonth(e){e&&e.stopPropagation(),11<++CAL_MONTH&&(CAL_MONTH=0,CAL_YEAR++),renderCalendar(CAL_MONTH,CAL_YEAR)}function renderCalendar(i,r){var e=document.getElementById("calGrid"),o=(e.innerHTML="",document.createElement("div")),o=(o.className="calendar-controls",o.innerHTML=`
    <button class="calendar-nav-btn" data-action="previousMonth">‚óÄ P≈ôedchoz√≠</button>
    <span class="calendar-month-title">${["Leden","√önor","B≈ôezen","Duben","Kvƒõten","ƒåerven","ƒåervenec","Srpen","Z√°≈ô√≠","≈ò√≠jen","Listopad","Prosinec"][i]} ${r}</span>
    <button class="calendar-nav-btn" data-action="nextMonth">Dal≈°√≠ ‚ñ∂</button>
  `,e.appendChild(o),document.createElement("div")),d=(o.className="calendar-weekdays",o.innerHTML=`<div>${t("monday")}</div><div>${t("tuesday")}</div><div>${t("wednesday")}</div><div>${t("thursday")}</div><div>${t("friday")}</div><div>${t("saturday")}</div><div>${t("sunday")}</div>`,e.appendChild(o),document.createElement("div")),o=(d.className="calendar-days",new Date(r,i,1)),a=new Date(r,i+1,0).getDate(),n=(o.getDay()+6)%7;let s=new Set;WGS_DATA_CACHE.forEach(e=>{var t,o;e.termin&&e.id!==CURRENT_RECORD?.id&&3===(e=e.termin.split(".")).length&&(t=parseInt(e[0]),o=parseInt(e[1]),e=parseInt(e[2]),o===i+1)&&e===r&&s.add(t)});for(let e=0;e<n;e++){var l=document.createElement("div");l.className="cal-day empty",d.appendChild(l)}var c=new Date;c.setHours(0,0,0,0);for(let n=1;n<=a;n++){let o=document.createElement("div");o.className="cal-day";var p=new Date(r,i,n);p.setHours(0,0,0,0);let a=p<c;a?(o.classList.add("disabled"),o.title="Nelze vybrat minul√© datum",o.style.opacity="0.3",o.style.cursor="not-allowed",o.style.backgroundColor="#f0f0f0"):s.has(n)&&(o.classList.add("occupied"),o.title="Tento den m√° ji≈æ nƒõjak√© term√≠ny"),o.textContent=n,o.onclick=()=>{var e;a?wgsToast.warning(t("cannot_select_past_date")):(SELECTED_DATE=n+`.${i+1}.`+r,document.querySelectorAll(".cal-day").forEach(e=>e.classList.remove("selected")),o.classList.add("selected"),e="Vybran√Ω den: "+SELECTED_DATE,document.getElementById("selectedDateDisplay").textContent=e,renderTimeGrid(),showDayBookingsWithDistances(SELECTED_DATE))},d.appendChild(o)}e.appendChild(d)}async function getDistance(t,o){var a=t+"|"+o;if(DISTANCE_CACHE[a])return DISTANCE_CACHE[a];try{let e=new AbortController;var n=setTimeout(()=>e.abort(),15e3),i=await fetchCsrfToken(),r=await fetch("/app/controllers/get_distance.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({origin:t,destination:o,csrf_token:i}),signal:e.signal});if(clearTimeout(n),r.ok){var d,s=await r.json();if(("success"===s.status||!0===s.success)&&s.distance)return d={km:(s.distance.value/1e3).toFixed(1),text:s.distance.text,duration:s.duration?s.duration.text:null},DISTANCE_CACHE[a]=d,CacheManager.save(),d}}catch(e){}return null}async function getDistancesBatch(e){e=e.map(e=>getDistance(e.from,e.to));return Promise.all(e)}async function showDayBookingsWithDistances(a){let n=document.getElementById("distanceInfo");var e=document.getElementById("dayBookings");if(n&&e){var i=(WGS_DATA_CACHE=Array.isArray(WGS_DATA_CACHE)?WGS_DATA_CACHE:[]).filter(e=>e.termin===a&&e.id!==CURRENT_RECORD?.id);if(i.sort((e,t)=>{e=e.cas_navstevy||"00:00",t=t.cas_navstevy||"00:00";return e.localeCompare(t)}),(r=Utils.getAddress(CURRENT_RECORD))&&"‚Äî"!==r){var r=Utils.addCountryToAddress(r),d=WGS_ADDRESS+"|"+r;if(void 0!==DISTANCE_CACHE[d]||(n.innerHTML=`<div style="text-align: center; color: var(--c-grey); font-size: 0.7rem; padding: 0.5rem;">${t("loading")}</div>`),0===i.length)getDistance(WGS_ADDRESS,r).then(e=>{n.innerHTML=e?`
            <div class="distance-info-panel">
              <div class="distance-info-title">Informace o trase</div>
              <div class="distance-stats">
                <div class="distance-stat">
                  <div class="distance-stat-label">Vzd√°lenost</div>
                  <div class="distance-stat-value">${e.km} <span class="distance-stat-unit">km</span></div>
                </div>
                <div class="distance-stat">
                  <div class="distance-stat-label">ƒåas j√≠zdy</div>
                  <div class="distance-stat-value">${e.duration||"‚Äî"}</div>
                </div>
              </div>
              <div class="route-info">
                <div class="route-item">
                  <div class="route-item-left">
                    <span>WGS S√≠dlo</span>
                    <span class="route-arrow">‚Üí</span>
                    <span>${Utils.getCustomerName(CURRENT_RECORD)}</span>
                  </div>
                  <span class="route-distance">${e.km} km</span>
                </div>
              </div>
            </div>
          `:""}).catch(e=>{logger.error("Chyba p≈ôi v√Ωpoƒçtu vzd√°lenosti:",e),n.innerHTML=""}),e.innerHTML="";else{var s=[];let t=WGS_ADDRESS;for(let e=0;e<i.length;e++){var l=i[e],c=Utils.getAddress(l);c&&"‚Äî"!==c&&(c=Utils.addCountryToAddress(c),s.push({from:t,to:c,booking:l}),t=c)}s.push({from:t,to:r,booking:null,isNew:!0});var p=await getDistancesBatch(s.map(e=>({from:e.from,to:e.to})));let o=0;var m=[];for(let e=0;e<s.length;e++){var u,g,v,h=s[e],y=p[e];y&&(o+=parseFloat(y.km),u=0===e?"WGS S√≠dlo":Utils.getCustomerName(s[e-1].booking),g=h.isNew?Utils.getCustomerName(CURRENT_RECORD):Utils.getCustomerName(h.booking),v=h.isNew?SELECTED_TIME||"‚Äî":h.booking?.cas_navstevy||"‚Äî",m.push({from:u,to:g,time:v,km:y.km,isNew:h.isNew}))}d=m.map(e=>`
    <div class="route-item ${e.isNew?"new-customer":""}">
      <div class="route-item-left">
        <span>${e.from}</span>
        <span class="route-arrow">‚Üí</span>
        <span>${e.to} ${"‚Äî"!==e.time?"("+e.time+")":""}</span>
      </div>
      <span class="route-distance">${e.km} km</span>
    </div>
  `).join("");if(n.innerHTML=`
    <div class="distance-info-panel">
      <div class="distance-info-title">Trasa pro ${a}</div>
      <div class="distance-stats">
        <div class="distance-stat">
          <div class="distance-stat-label">Celkem za den</div>
          <div class="distance-stat-value">${o.toFixed(1)} <span class="distance-stat-unit">km</span></div>
        </div>
        <div class="distance-stat">
          <div class="distance-stat-label">Poƒçet n√°v≈°tƒõv</div>
          <div class="distance-stat-value">${i.length+1}</div>
        </div>
      </div>
      <div class="route-info">
        ${d}
      </div>
    </div>
  `,0<i.length){let o='<div class="day-bookings" style="margin-top: 0.5rem;"><h4>Term√≠ny v tento den:</h4>';i.forEach(e=>{var t=Utils.getCustomerName(e);o+=`
        <div class="booking-item" data-action="showBookingDetail" data-id="${e.id}">
          <strong>${e.cas_navstevy||"‚Äî"}</strong> ‚Äî ${t}
          <span style="opacity:.7">(${Utils.getProduct(e)})</span>
        </div>`}),o+="</div>",e.innerHTML=o}else e.innerHTML=""}}else n.innerHTML="",e.innerHTML=""}}function showBookingDetail(o){let e;if("string"==typeof o||"number"==typeof o){if(!(e=WGS_DATA_CACHE.find(e=>e.id==o||e.reklamace_id==o)))return void wgsToast.error(t("record_not_found"))}else e=o;var a=Utils.getCustomerName(e),n=Utils.getAddress(e),i=Utils.getProduct(e),r=e.popis_problemu||"‚Äî",a=`
    ${ModalManager.createHeader("Detail obsazen√©ho term√≠nu",'<p style="color: var(--c-error); font-weight: 600;">Tento term√≠n je ji≈æ obsazen</p>')}
    
    <div class="modal-body">
      <div style="padding: 1.5rem; background: rgba(139, 0, 0, 0.05); border: 2px solid var(--c-error); margin-bottom: 1.5rem;">
        <div class="info-grid" style="font-family: 'Poppins', sans-serif;">
          <div class="info-label">Z√°kazn√≠k:</div>
          <div class="info-value"><strong>${a}</strong></div>
          
          <div class="info-label">Term√≠n:</div>
          <div class="info-value"><strong>${formatDate(e.termin||"")} v ${e.cas_navstevy||"‚Äî"}</strong></div>
          
          <div class="info-label">Adresa:</div>
          <div class="info-value">${n}</div>
          
          <div class="info-label">Produkt:</div>
          <div class="info-value">${i}</div>
          
          <div class="info-label">Popis:</div>
          <div class="info-value" style="line-height: 1.6;">${r}</div>
        </div>
      </div>
    </div>

    <div class="detail-buttons">
      <button class="detail-btn detail-btn-secondary" data-action="showCalendarBack">Zpƒõt na kalend√°≈ô</button>
    </div>
  `;ModalManager.show(a)}function renderTimeGrid(){var a=document.getElementById("timeGrid");a.innerHTML="";let n={};WGS_DATA_CACHE.forEach(e=>{var t;e.termin===SELECTED_DATE&&e.cas_navstevy&&e.id!==CURRENT_RECORD?.id&&(t=Utils.getCustomerName(e),n[e.cas_navstevy]={zakaznik:t,model:Utils.getProduct(e)})});for(let e=8;e<=19;e++)for(var i of[0,30]){let t=String(e).padStart(2,"0")+":"+(0===i?"00":"30"),o=document.createElement("div");o.className="time-slot",n[t]&&(o.classList.add("occupied"),o.title=n[t].zakaznik+" ‚Äî "+n[t].model),o.textContent=t,o.onclick=()=>{SELECTED_TIME=t,document.querySelectorAll(".time-slot").forEach(e=>e.classList.remove("selected")),o.classList.add("selected");var e=document.getElementById("selectedDateDisplay"),e=(e.textContent=`Vybran√Ω term√≠n: ${SELECTED_DATE} ‚Äî `+SELECTED_TIME,e.style.display="block",document.getElementById("collisionWarning"));n[t]&&e?(e.textContent=`KOLIZE: ${n[t].zakaznik} ‚Äî `+n[t].model,e.style.display="block"):e&&(e.style.display="none")},a.appendChild(o)}}async function saveSelectedDate(){if(SELECTED_DATE&&SELECTED_TIME)if(CURRENT_RECORD){var o=(WGS_DATA_CACHE=Array.isArray(WGS_DATA_CACHE)?WGS_DATA_CACHE:[]).find(e=>e.termin===SELECTED_DATE&&e.cas_navstevy===SELECTED_TIME&&e.id!==CURRENT_RECORD.id);if(o){o=Utils.getCustomerName(o);if(!await wgsConfirm(t("confirm_appointment_collision").replace("{date}",SELECTED_DATE).replace("{time}",SELECTED_TIME).replace("{customer}",o),t("confirm_yes")||"Ano",t("confirm_no")||"Ne"))return}showLoading(t("saving_appointment"));o=performance.now();logger.log("‚è±Ô∏è START ukl√°d√°n√≠ term√≠nu...");try{var e=performance.now(),a=await getCSRFToken(),n=performance.now(),i=(logger.log(`‚è±Ô∏è CSRF token z√≠sk√°n za ${(n-e).toFixed(0)}ms`),new FormData),r=(i.append("action","update"),i.append("id",CURRENT_RECORD.id),i.append("termin",SELECTED_DATE),i.append("cas_navstevy",SELECTED_TIME),i.append("stav","DOMLUVEN√Å"),i.append("csrf_token",a),showLoading(t("saving_appointment_to_db")),performance.now()),d=(logger.log("‚è±Ô∏è Odes√≠l√°m POST request na save.php..."),await fetch("/app/controllers/save.php",{method:"POST",body:i})),s=performance.now(),l=(logger.log(`‚è±Ô∏è POST request dokonƒçen za ${(s-r).toFixed(0)}ms`),await d.json());if(!d.ok)throw new Error(`HTTP ${d.status}: `+(l.message||d.statusText));if("success"===l.status){var c=performance.now(),p=(logger.log(`‚è±Ô∏è SUCCESS block started: ${(c-o).toFixed(0)}ms od zaƒç√°tku`),performance.now()),m=(CURRENT_RECORD.termin=SELECTED_DATE,CURRENT_RECORD.cas_navstevy=SELECTED_TIME,CURRENT_RECORD.stav="DOMLUVEN√Å",performance.now()),u=(logger.log(`‚è±Ô∏è CURRENT_RECORD update: ${(m-p).toFixed(0)}ms`),performance.now()),g=WGS_DATA_CACHE.find(e=>e.id===CURRENT_RECORD.id),v=(g&&(g.termin=SELECTED_DATE,g.cas_navstevy=SELECTED_TIME,g.stav="DOMLUVEN√Å"),performance.now()),h=(logger.log(`‚è±Ô∏è Cache update: ${(v-u).toFixed(0)}ms`),performance.now()),y=(hideLoading(),performance.now()),f=(logger.log(`‚è±Ô∏è hideLoading(): ${(y-h).toFixed(0)}ms`),performance.now()),w=(logger.log(`‚è±Ô∏è TƒöSNƒö P≈òED ALERT: ${(f-o).toFixed(0)}ms od zaƒç√°tku`),wgsToast.success(t("appointment_saved_success").replace("{date}",SELECTED_DATE).replace("{time}",SELECTED_TIME)),performance.now()),b=(logger.log(`‚è±Ô∏è alert() dokonƒçen: ${(w-f).toFixed(0)}ms`),performance.now()),E=(sendAppointmentConfirmation(CURRENT_RECORD,SELECTED_DATE,SELECTED_TIME).catch(e=>logger.warn("‚ö† Email se nepoda≈ôilo odeslat:",e.message)),performance.now()),C=(logger.log(`‚è±Ô∏è sendAppointmentConfirmation() launch: ${(E-b).toFixed(0)}ms`),performance.now());logger.log("‚è±Ô∏è Aktualizuji detail...");let e=CURRENT_RECORD.id;var x=performance.now(),_=(closeDetail(),performance.now()),T=(logger.log(`‚è±Ô∏è closeDetail(): ${(_-x).toFixed(0)}ms`),performance.now()),k=(setTimeout(()=>showDetail(e),100),performance.now()),R=(logger.log(`‚è±Ô∏è setTimeout() scheduled: ${(k-T).toFixed(0)}ms`),performance.now()),A=(logger.log(`‚è±Ô∏è Detail aktualizov√°n za ${(R-C).toFixed(0)}ms`),performance.now());logger.log(`‚è±Ô∏è CELKOV√ù ƒåAS: ${(A-o).toFixed(0)}ms (${((A-o)/1e3).toFixed(1)}s)`)}else hideLoading(),wgsToast.error(t("error")+": "+(l.message||t("failed_to_save")))}catch(e){hideLoading(),logger.error("Chyba p≈ôi ukl√°d√°n√≠:",e),wgsToast.error(t("save_error")+": "+e.message);n=performance.now();logger.log(`‚è±Ô∏è ƒåas do chyby: ${(n-o).toFixed(0)}ms`)}}else wgsToast.warning(t("no_record_to_save"));else wgsToast.warning(t("select_date_and_time"))}function showContactMenu(e){var t=CURRENT_RECORD.telefon||"",o=Utils.getAddress(CURRENT_RECORD),e=`
    ${createCustomerHeader()}

    <div class="modal-body">
      <div class="detail-buttons">
        ${t?`<a href="tel:${t}" class="detail-btn detail-btn-primary" style="text-decoration: none;">Zavolat</a>`:""}
        <button class="detail-btn detail-btn-primary" data-action="openCalendarFromDetail" data-id="${e}">Term√≠n n√°v≈°tƒõvy</button>
        ${t?`<button class="detail-btn detail-btn-secondary" data-action="sendContactAttemptEmail" data-id="${e}" data-phone="${t}">Odeslat SMS</button>`:""}
        ${o&&"‚Äî"!==o?`<a href="https://waze.com/ul?q=${encodeURIComponent(o)}&navigate=yes" class="detail-btn detail-btn-secondary" style="text-decoration: none;" target="_blank">Navigovat (Waze)</a>`:""}
        <button class="detail-btn detail-btn-secondary" data-action="showDetail">Zpƒõt</button>
      </div>
    </div>
  `;ModalManager.show(e)}function toggleMap(){var e=document.getElementById("mapContent"),t=document.getElementById("mapToggleIcon");e.classList.contains("active")?(e.classList.remove("active"),t.classList.remove("active")):(e.classList.add("active"),t.classList.add("active"),e.dataset.loaded||(e.dataset.loaded="true",loadMapAndRoute()))}async function loadMapAndRoute(){var o=document.getElementById("mapContainer");if(CURRENT_RECORD){var e=Utils.getAddress(CURRENT_RECORD);if(e&&"‚Äî"!==e){e=Utils.addCountryToAddress(e);try{var a=encodeURIComponent(WGS_ADDRESS),n=encodeURIComponent(e);o.innerHTML=`
      <div style="background: var(--c-bg); padding: 1rem; text-align: center; border: 1px solid var(--c-border);">
        <div style="font-size: 0.8rem; color: var(--c-grey); margin-bottom: 0.8rem; line-height: 1.4;">
          <strong>Z:</strong> WGS<br>
          <strong>Do:</strong> ${e}<br>
          <strong>Vzd√°lenost:</strong> <span id="mapDistance">Naƒç√≠t√°m...</span><br>
          <strong>ƒåas:</strong> <span id="mapDuration">‚Äî</span>
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: center;">
          <a href="https://www.google.com/maps/dir/?api=1&origin=${a}&destination=${n}&travelmode=driving"
             class="btn" target="_blank" style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.75rem;">
            Google Maps
          </a>
          <a href="https://waze.com/ul?q=${n}&navigate=yes"
             class="btn" target="_blank" style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.75rem;">
            Waze
          </a>
        </div>
      </div>
    `,document.getElementById("mapDistance").textContent="‚Äî",document.getElementById("mapDuration").textContent="‚Äî"}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ mapy:",e),o.innerHTML=`
      <div class="map-error">
        Nepoda≈ôilo se naƒç√≠st mapu<br>
        <small>${e.message}</small>
      </div>
    `}}else o.innerHTML=`<div class="map-error">${t("customer_address_not_available")}</div>`}}async function showCustomerDetail(e){var t=Utils.getCustomerName(CURRENT_RECORD),o=CURRENT_RECORD.telefon||"",a=CURRENT_RECORD.email||"",n=Utils.getAddress(CURRENT_RECORD),i=Utils.getProduct(CURRENT_RECORD),r=CURRENT_RECORD.popis_problemu||"",d=CURRENT_RECORD.cislo||"",s=CURRENT_RECORD.reklamace_id||"",l=CURRENT_RECORD.created_by_name||CURRENT_RECORD.prodejce||"",c=CURRENT_RECORD.datum_prodeje||"",p=CURRENT_RECORD.datum_reklamace||"",m=CURRENT_RECORD.provedeni||"",u=CURRENT_RECORD.barva||"",g=CURRENT_RECORD.doplnujici_info||"",v=CURRENT_RECORD.fakturace_firma||"CZ",h=await loadPhotosFromDB(s);let y=0<h.length?h:[];if(0===y.length){h=localStorage.getItem("photoSections_"+e);if(h)try{var f=JSON.parse(h);Object.values(f).forEach(e=>{e.photos&&Array.isArray(e.photos)&&(y=y.concat(e.photos))})}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ fotek:",e)}}s=`
    ${createCustomerHeader()}

    <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 1rem;">

      <!-- KOMPAKTN√ç INFO BLOK -->
      <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 4px; padding: 0.75rem; margin-bottom: 1rem;">
        <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; font-size: 0.9rem;">
          <span style="color: #666; font-weight: 600;">ƒå√≠slo objedn√°vky:</span>
          <input type="text" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: white;" value="${Utils.escapeHtml(s)}" readonly>

          <span style="color: #666; font-weight: 600;">Zadavatel:</span>
          <input type="text" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #f8f9fa;" value="${Utils.escapeHtml(l)}" readonly placeholder="Prodejce/U≈æivatel">

          <span style="color: #666; font-weight: 600;">ƒå√≠slo reklamace:</span>
          <input type="text" id="edit_cislo" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${Utils.escapeHtml(d)}">

          <span style="color: #666; font-weight: 600;">Fakturace:</span>
          <span style="color: #1a1a1a; font-weight: 600; padding: 0.25rem 0;">${"SK"===v.toUpperCase()?"Slovensko (SK)":"ƒåesk√° republika (CZ)"}</span>

          <span style="color: #666; font-weight: 600;">Datum prodeje:</span>
          <input type="text" id="edit_datum_prodeje" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${Utils.escapeHtml(c)}" placeholder="DD.MM.RRRR">

          <span style="color: #666; font-weight: 600;">Datum reklamace:</span>
          <input type="text" id="edit_datum_reklamace" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${Utils.escapeHtml(p)}" placeholder="DD.MM.RRRR">

          <span style="color: #666; font-weight: 600;">Jm√©no:</span>
          <input type="text" id="edit_jmeno" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${t}">

          <span style="color: #666; font-weight: 600;">Telefon:</span>
          <input type="tel" id="edit_telefon" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${o}">

          <span style="color: #666; font-weight: 600;">Email:</span>
          <input type="email" id="edit_email" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${a}">

          <span style="color: #666; font-weight: 600;">Adresa:</span>
          <input type="text" id="edit_adresa" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${n}">

          <span style="color: #666; font-weight: 600;">Model:</span>
          <input type="text" id="edit_model" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${i}">

          <span style="color: #666; font-weight: 600;">Proveden√≠:</span>
          <input type="text" id="edit_provedeni" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${Utils.escapeHtml(m)}" placeholder="L√°tka / K≈Ø≈æe">

          <span style="color: #666; font-weight: 600;">Barva:</span>
          <input type="text" id="edit_barva" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${Utils.escapeHtml(u)}">
        </div>
      </div>

      <!-- DOPL≈áUJ√çC√ç INFORMACE OD PRODEJCE -->
      <div style="margin-bottom: 1rem;">
        <label style="display: block; color: #666; font-weight: 600; font-size: 0.8rem; margin-bottom: 0.25rem;">Dopl≈àuj√≠c√≠ informace od prodejce:</label>
        <textarea id="edit_doplnujici_info"
                  style="width: 100%; border: 1px solid #ddd; padding: 0.5rem; border-radius: 3px; font-size: 0.9rem; min-height: 60px; background: white; resize: vertical; font-family: inherit;"
                  placeholder="Zadejte dopl≈àuj√≠c√≠ informace od prodejce">${Utils.escapeHtml(g)}</textarea>
      </div>

      <!-- POPIS PROBL√âMU OD Z√ÅKAZN√çKA -->
      <div style="margin-bottom: 2rem;">
        <label style="display: block; color: #666; font-weight: 600; font-size: 0.8rem; margin-bottom: 0.25rem;">Popis probl√©mu od z√°kazn√≠ka:</label>
        <textarea id="edit_popis_problemu"
                  style="width: 100%; border: 1px solid #ddd; padding: 0.5rem; border-radius: 3px; font-size: 0.9rem; min-height: 80px; background: white; resize: vertical; font-family: inherit;"
                  placeholder="Zadejte popis probl√©mu od z√°kazn√≠ka">${Utils.escapeHtml(r)}</textarea>
      </div>

      <!-- FOTOGRAFIE -->
      ${0<y.length?`
        <div style="margin-bottom: 1rem;">
          <label style="display: block; color: #666; font-weight: 600; font-size: 0.8rem; margin-bottom: 0.5rem;">Fotografie (${y.length}):</label>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem;">
            ${y.map((e,t)=>{var o="object"==typeof e?e.photo_path:e,e="object"==typeof e?e.id:null,a=o.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/'/g,"\\'");return`
                <div class="foto-wrapper" style="position: relative;">
                  <img src='${o}'
                       style='width: 100%; aspect-ratio: 1; object-fit: cover; border: 1px solid #ddd; cursor: pointer; border-radius: 3px;'
                       alt='Fotka ${t+1}'
                       data-action="showPhotoFullscreen"
                       data-url="${a}">
                  ${e?`
                    <button class="foto-delete-btn"
                            data-action="smazatFotku"
                            data-photo-id="${e}"
                            data-url="${a}"
                            title="Smazat fotku">
                      √ó
                    </button>
                  `:""}
                </div>
              `}).join("")}
          </div>
        </div>
      `:""}

      <!-- PDF DOKUMENTY -->
      ${h=CURRENT_RECORD.documents||[],f=h.find(e=>"complete_report"===e.document_type),h=0<h.length?h[0]:null,f=f||h,f?`
          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: #666; font-weight: 600; font-size: 0.8rem; margin-bottom: 0.5rem;">PDF Report:</label>
            <button class="btn customer-detail-btn"
                    data-action="openPDF"
                    data-pdf-path="${f.file_path.replace(/\\/g,"\\\\").replace(/'/g,"\\'")}">
              Otev≈ô√≠t PDF Report
            </button>
          </div>
        `:`
            <div style="padding: 0.75rem; text-align: center; background: #f8f9fa; border: 1px dashed #dee2e6; border-radius: 4px; margin-bottom: 1rem;">
              <p style="margin: 0; color: #6c757d; font-size: 0.8rem;">PDF report je≈°tƒõ nebyl vytvo≈ôen</p>
            </div>
          `}

      ${CURRENT_USER.is_admin?`
        <div style="border-top: 1px solid #e0e0e0; padding-top: 1rem; margin-top: 1rem;">
          <button class="btn customer-detail-btn danger" data-action="deleteReklamace" data-id="${e}">
            Smazat reklamaci
          </button>
          <p style="font-size: 0.7rem; color: #999; margin-top: 0.25rem; text-align: center;">Sma≈æe v≈°e vƒçetnƒõ fotek a PDF</p>
        </div>
      `:""}

    </div>

    <div class="detail-buttons">
      <button class="detail-btn detail-btn-primary" data-action="saveAllCustomerData" data-id="${e}">Ulo≈æit zmƒõny</button>
      <button class="detail-btn detail-btn-secondary" data-action="showDetail" data-id="${e}">Zpƒõt</button>
    </div>
  `;ModalManager.show(s)}function zobrazPDFModal(o,a,e="report"){let n="historie"===e?"Historie PDF":"PDF Report",t=document.createElement("div");t.id="pdfModalOverlay",t.style.cssText=`
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.95); z-index: 10003;
    display: flex; flex-direction: column;
  `;var e=document.createElement("div"),i=(e.style.cssText=`
    flex-shrink: 0; padding: 12px 16px;
    background: #222; color: white;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #444;
  `,e.innerHTML=`
    <div>
      <div style="font-weight: 600; font-size: 1rem;">${n}</div>
      <div style="font-size: 0.75rem; opacity: 0.7;">ID: ${a||"-"}</div>
    </div>
    <button id="pdfCloseBtn" style="
      background: #555; color: white; border: none;
      padding: 10px 20px; border-radius: 6px;
      font-weight: 600; font-size: 0.9rem; cursor: pointer;
    ">Zav≈ô√≠t</button>
  `,document.createElement("div")),r=(i.style.cssText="flex: 1; overflow: hidden; display: flex; align-items: center; justify-content: center; padding: 16px;",document.createElement("iframe")),r=(r.src=o,r.style.cssText="width: 100%; height: 100%; max-width: 900px; border: none; background: white; border-radius: 8px;",i.appendChild(r),document.createElement("div")),d=(r.style.cssText=`
    flex-shrink: 0; padding: 12px 16px;
    background: #222; border-top: 1px solid #444;
    display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;
  `,document.createElement("button"));d.textContent="St√°hnout",d.style.cssText="padding: 12px 24px; font-size: 0.9rem; font-weight: 600; background: #444; color: white; border: none; border-radius: 6px; cursor: pointer;",d.onclick=()=>{var e=document.createElement("a");e.href=o,e.download=`PDF_Report_${a||"dokument"}.pdf`,e.click()};let s=document.createElement("button");s.textContent="Sd√≠let",s.style.cssText="padding: 12px 24px; font-size: 0.9rem; font-weight: 600; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer;",s.onclick=async()=>{if(navigator.share)try{s.textContent="Naƒç√≠t√°m...";var e=await(await fetch(o)).blob(),t=new File([e],`PDF_Report_${a||"dokument"}.pdf`,{type:"application/pdf"});await navigator.share({files:[t],title:n})}catch(e){"AbortError"!==e.name&&wgsToast.error("Chyba: "+e.message)}finally{s.textContent="Sd√≠let"}else wgsToast.info("Sd√≠len√≠ nen√≠ podporov√°no. Pou≈æijte tlaƒç√≠tko St√°hnout.")};var l=document.createElement("button");l.textContent="Zav≈ô√≠t",l.style.cssText="padding: 12px 24px; font-size: 0.9rem; font-weight: 600; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;",l.onclick=()=>t.remove(),r.appendChild(d),r.appendChild(s),r.appendChild(l),t.appendChild(e),t.appendChild(i),t.appendChild(r),e.querySelector("#pdfCloseBtn").onclick=()=>t.remove();let c=e=>{"Escape"===e.key&&(t.remove(),document.removeEventListener("keydown",c))};document.addEventListener("keydown",c),document.body.appendChild(t)}function showPhotoFullscreen(e){let t=document.createElement("div");t.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer;",t.onclick=()=>t.remove();var o=document.createElement("img");o.alt="Zvƒõt≈°en√° fotka reklamace",o.src=e,o.style.cssText="max-width: 95%; max-height: 95%; object-fit: contain;",t.appendChild(o),document.body.appendChild(t)}function showTextOverlay(s){if(CURRENT_RECORD){var e="popis_problemu"===s?"Popis probl√©mu":"Dopl≈àuj√≠c√≠ informace",o=CURRENT_RECORD[s]||"";let r=document.createElement("div");r.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 2rem;";var a=document.createElement("div"),n=(a.style.cssText="background: white; padding: 1.5rem; border-radius: 6px; max-width: 700px; width: 100%; max-height: 85vh; display: flex; flex-direction: column;",a.onclick=e=>e.stopPropagation(),document.createElement("div")),e=(n.style.cssText="font-weight: 600; font-size: 1rem; color: #1a1a1a; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #dee2e6;",n.textContent=e,document.createElement("div"));e.style.cssText="flex: 1; overflow-y: auto; margin-bottom: 1rem;";let d=document.createElement("textarea");d.style.cssText="width: 100%; min-height: 300px; border: 1px solid #ddd; padding: 0.75rem; border-radius: 4px; font-size: 0.9rem; line-height: 1.6; font-family: inherit; resize: vertical;",d.value=o,d.placeholder="Zadejte text...",e.appendChild(d);var o=document.createElement("div"),i=(o.style.cssText="display: flex; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid #dee2e6;",document.createElement("button")),l=(i.style.cssText="flex: 1; padding: 0.5rem 1rem; background: #1a1a1a; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; font-weight: 600;",i.textContent=t("save_changes"),i.onclick=async()=>{var e=d.value;try{var o=await getCSRFToken(),a=new FormData;a.append("action","update"),a.append("id",CURRENT_RECORD.id),a.append(s,e),a.append("csrf_token",o);var n,i=await(await fetch("/app/controllers/save.php",{method:"POST",body:a})).json();"success"===i.status?(CURRENT_RECORD[s]=e,(n=WGS_DATA_CACHE.find(e=>e.id==CURRENT_RECORD.id))&&(n[s]=e),r.remove(),showCustomerDetail(CURRENT_RECORD.id),wgsToast.success(t("text_saved_successfully"))):wgsToast.error(t("save_error")+": "+i.message)}catch(e){wgsToast.error(t("save_error")+": "+e.message)}},document.createElement("button"));l.style.cssText="flex: 1; padding: 0.5rem 1rem; background: #666; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer;",l.textContent=t("cancel"),l.onclick=()=>r.remove(),o.appendChild(i),o.appendChild(l),a.appendChild(n),a.appendChild(e),a.appendChild(o),r.appendChild(a),document.body.appendChild(r),r.onclick=e=>{e.target===r&&r.remove()},setTimeout(()=>d.focus(),100)}}async function saveAllCustomerData(e){await saveData({action:"update",id:e,cislo:document.getElementById("edit_cislo").value,datum_prodeje:document.getElementById("edit_datum_prodeje").value,datum_reklamace:document.getElementById("edit_datum_reklamace").value,jmeno:document.getElementById("edit_jmeno").value,telefon:document.getElementById("edit_telefon").value,email:document.getElementById("edit_email").value,adresa:document.getElementById("edit_adresa").value,model:document.getElementById("edit_model").value,provedeni:document.getElementById("edit_provedeni").value,barva:document.getElementById("edit_barva").value,doplnujici_info:document.getElementById("edit_doplnujici_info").value,popis_problemu:document.getElementById("edit_popis_problemu").value},"V≈°echny √∫daje byly aktualizov√°ny")}async function sendAppointmentConfirmation(e,t,o){var a=Utils.getCustomerName(e),n=e.telefon||"",i=e.email||"",r=Utils.getOrderId(e),d=Utils.getAddress(e)||"",s=e.nazev_produktu||e.produkt||e.popis_produktu||"",l=e.technik_jmeno||e.assigned_technician||"",c=e.technik_email||"",p=e.technik_telefon||"",e=e.created_by_email||"admin@wgs-service.cz";try{var m=await getCSRFToken(),u=await(await fetch("app/notification_sender.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({notification_id:"appointment_confirmed",csrf_token:m,data:{customer_name:a,customer_email:i,customer_phone:n,seller_email:e,date:t,time:o,order_id:r,address:d,product:s,technician_name:l,technician_email:c,technician_phone:p}})})).json();!0===u.success?(logger.log("Potvrzen√≠ term√≠nu odesl√°no z√°kazn√≠kovi"),u.sent&&logger.log("  Email odesl√°n na:",u.to||i),u.sms_sent&&logger.log("  SMS odesl√°na na:",n)):logger.error("‚ö† Chyba p≈ôi odes√≠l√°n√≠ potvrzen√≠:",u.error||u.message)}catch(e){logger.error("Chyba p≈ôi odes√≠l√°n√≠ potvrzen√≠:",e)}}async function autoAssignTechnician(t){try{var e,o=await getCSRFToken(),a=await(await fetch("api/auto_assign_technician.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:t,csrf_token:o})})).json();a.success&&a.assigned?(logger.log(`‚úì Technik ${a.technician_name} (${a.technician_email}) byl automaticky p≈ôi≈ôazen`),CURRENT_RECORD&&(CURRENT_RECORD.assigned_to=a.technician_id,CURRENT_RECORD.technik_jmeno=a.technician_name||"",CURRENT_RECORD.technik_email=a.technician_email||"",CURRENT_RECORD.technik_telefon=a.technician_phone||""),(e=WGS_DATA_CACHE.find(e=>e.reklamace_id==t||e.cislo==t||e.id==t))&&(e.assigned_to=a.technician_id,e.technik_jmeno=a.technician_name||"",e.technik_email=a.technician_email||"",e.technik_telefon=a.technician_phone||"")):a.success&&!a.assigned?logger.log("Auto-assign: "+(a.message||"≈Ω√°dn√© p≈ôi≈ôazen√≠")):logger.warn("Auto-assign selhalo:",a.error)}catch(e){logger.error("Chyba p≈ôi auto-assign technika:",e)}}async function getNotes(t){try{var e,o,a=WGS_DATA_CACHE.find(e=>e.id==t||e.reklamace_id==t);return a?(e=a.reklamace_id||a.id,("success"===(o=await(await fetch("api/notes_api.php?action=get&reklamace_id="+encodeURIComponent(e))).json()).status||!0===o.success)&&o.notes||[]):[]}catch(e){return logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ pozn√°mek:",e),[]}}async function addNote(t,e,o=null){try{var a=WGS_DATA_CACHE.find(e=>e.id==t||e.reklamace_id==t);if(!a)throw new Error("Reklamace nenalezena");var n=await getCSRFToken(),i=a.reklamace_id||a.id,r=new FormData;if(r.append("action","add"),r.append("reklamace_id",i),r.append("text",e.trim()),r.append("csrf_token",n),logger.log("[Audio] audioBlob status:",o?"existuje":"null",o?o.size+" bytes":""),o){let e="webm";o.type.includes("mp4")?e="m4a":o.type.includes("ogg")?e="ogg":o.type.includes("mp3")||o.type.includes("mpeg")?e="mp3":o.type.includes("wav")&&(e="wav"),r.append("audio",o,"nahravka."+e),logger.log("[Audio] Odesilam nahravku:",Math.round(o.size/1024),"KB, type:",o.type)}logger.log("[Notes] Odesilam poznamku na API...");var d=await fetch("api/notes_api.php",{method:"POST",body:r}),s=(logger.log("[Notes] API odpoved status:",d.status),await d.json());if(logger.log("[Notes] API odpoved data:",JSON.stringify(s)),"success"===s.status||!0===s.success)return{success:!0,note_id:s.note_id};throw new Error(s.error||s.message||"Chyba pri pridavani poznamky")}catch(e){throw logger.error("Chyba pri pridavani poznamky:",e),e}}async function deleteNote(e,t){if(console.log("[deleteNote] Zacinam mazat poznamku ID:",e),await wgsConfirm("Opravdu chcete smazat tuto pozn√°mku?","Smazat","Zru≈°it")){console.log("[deleteNote] Uzivatel potvrdil, pripravuji request...");try{var o,a,n=await getCSRFToken(),i=(console.log("[deleteNote] CSRF token:",n?"OK ("+n.substring(0,10)+"...)":"CHYBI!"),new URLSearchParams),r=(i.append("action","delete"),i.append("note_id",e),i.append("csrf_token",n),console.log("[deleteNote] Params pripraveny:",i.toString().substring(0,50)+"..."),console.log("[deleteNote] Odesilam POST na /api/notes_api.php..."),await fetch("/api/notes_api.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i})),d=(console.log("[deleteNote] Response status:",r.status,r.statusText),await r.json());"success"===d.status?((o=document.querySelector(`[data-note-id="${e}"]`))&&o.remove(),(a=document.querySelector(".notes-container"))&&0===a.querySelectorAll(".note-item").length&&(a.innerHTML='<div class="empty-notes">Zatim zadne poznamky</div>'),await loadAll(ACTIVE_FILTER)):wgsToast.error("Chyba: "+(d.error||d.message||"Neznama chyba"))}catch(e){logger.error("Chyba pri mazani poznamky:",e),wgsToast.error("Chyba pri mazani poznamky: "+e.message)}}else console.log("[deleteNote] Uzivatel zrusil")}async function markNotesAsRead(t){try{var e,o,a,n=WGS_DATA_CACHE.find(e=>e.id==t||e.reklamace_id==t);n&&(e=await getCSRFToken(),o=n.reklamace_id||n.id,(a=new FormData).append("action","mark_read"),a.append("reklamace_id",o),a.append("csrf_token",e),await fetch("api/notes_api.php",{method:"POST",body:a}))}catch(e){logger.error("Chyba p≈ôi oznaƒçov√°n√≠ pozn√°mek:",e)}}async function showNotes(o){let n;if("string"==typeof o||"number"==typeof o){if(!(n=WGS_DATA_CACHE.find(e=>e.id==o||e.reklamace_id==o)))return void wgsToast.error(t("record_not_found"))}else n=o;CURRENT_RECORD=n;var e=`
    ${createCustomerHeader()}
    <div class="modal-body" style="text-align: center; padding: 3rem;">
      <div class="loading">Naƒç√≠t√°n√≠ pozn√°mek...</div>
    </div>
  `,e=(ModalManager.show(e),await getNotes(n.id)),e=(e.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),`
    ${createCustomerHeader()}

    <div class="modal-body">
      <div class="notes-container">
        ${0<e.length?e.map(e=>{var t=CURRENT_USER&&(CURRENT_USER.is_admin||e.author===CURRENT_USER.email),o=e.has_audio&&e.audio_url,a="[Hlasov√° pozn√°mka]"===e.text||"[Hlasova poznamka]"===e.text;return`
              <div class="note-item ${e.read?"":"unread"} ${o?"has-audio":""}" data-note-id="${e.id}">
                <div class="note-header">
                  <span class="note-author">${e.author_name||e.author}</span>
                  <span class="note-time">${formatDateTime(e.timestamp)}</span>
                  ${t?`<button class="note-delete-btn" data-note-id="${e.id}" data-order-id="${n.id}" onclick="event.stopPropagation(); potvrditSmazaniPoznamky(this);" title="Smazat poznamku">x</button>`:""}
                </div>
                ${a?"":`<div class="note-text">${Utils.escapeHtml(e.text)}</div>`}
                ${o?`
                <div class="note-audio">
                  <audio controls preload="metadata" class="note-audio-player">
                    <source src="${e.audio_url}" type="audio/mp4">
                    <source src="${e.audio_url}" type="audio/webm">
                    <source src="${e.audio_url}" type="audio/mpeg">
                    Vas prohlizec nepodporuje prehravani audia.
                  </audio>
                </div>
                `:""}
              </div>
            `}).join(""):'<div class="empty-notes">Zatim zadne poznamky</div>'}
      </div>

      <div class="note-input-area">
        <textarea
          class="note-textarea"
          id="newNoteText"
          placeholder="Napiste poznamku..."
        ></textarea>
        <div class="note-audio-controls">
          <button type="button" class="btn-record" id="btnStartRecord" data-action="startRecording" data-id="${n.id}" title="Nahrat hlasovou zpravu">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
              <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            </svg>
          </button>
          <div class="recording-indicator" id="recordingIndicator" style="display: none;">
            <span class="recording-dot"></span>
            <span class="recording-time" id="recordingTime">0:00</span>
            <button type="button" class="btn-stop-record" id="btnStopRecord" data-action="stopRecording" data-id="${n.id}">Stop</button>
          </div>
          <div class="audio-preview" id="audioPreview" style="display: none;">
            <audio id="audioPreviewPlayer" controls></audio>
            <button type="button" class="btn-delete-audio" id="btnDeleteAudio" data-action="deleteAudioPreview" title="Smazat nahravku">x</button>
          </div>
        </div>
      </div>
    </div>

    <div class="detail-buttons">
      <button class="detail-btn detail-btn-primary" data-action="saveNewNote" data-id="${n.id}">Pridat poznamku</button>
      <button class="detail-btn detail-btn-secondary" data-action="closeNotesModal">Zavrit</button>
    </div>
  `);ModalManager.show(e),setTimeout(()=>{document.querySelectorAll(".note-audio-player").forEach(t=>{t.onerror=function(){logger.log("[Audio] Chyba pri nacitani ulozene nahravky");var e=t.closest(".note-audio");e&&(e.innerHTML='<span style="color: var(--c-grey); font-size: 0.75rem;">Audio nelze nacist</span>')}})},100),setTimeout(async()=>{await markNotesAsRead(n.id),await loadAll(ACTIVE_FILTER),window.WGSNotifikace&&window.WGSNotifikace.aktualizovat()},1e3)}async function saveNewNote(e){var o=document.getElementById("newNoteText").value.trim(),a=window.wgsAudioRecorder?window.wgsAudioRecorder.audioBlob:null;if(o||a)try{await addNote(e,o,a),window.wgsAudioRecorder&&(window.wgsAudioRecorder.audioBlob=null,window.wgsAudioRecorder.audioChunks=[]),closeNotesModal(),await loadAll(ACTIVE_FILTER),window.WGSNotifikace&&window.WGSNotifikace.aktualizovat()}catch(e){wgsToast.error(t("note_save_error")+": "+e.message)}else wgsToast.warning(t("write_note_text"))}function closeNotesModal(){window.wgsAudioRecorder&&window.wgsAudioRecorder.isRecording&&stopRecording(),"function"==typeof releaseMicrophone&&releaseMicrophone(),closeDetail(),renderOrders()}async function checkMicrophonePermission(){try{var e;if(navigator.permissions&&navigator.permissions.query)return e=await navigator.permissions.query({name:"microphone"}),logger.log("[Audio] Stav opravneni mikrofonu:",e.state),"granted"===e.state?(window.wgsAudioRecorder.permissionGranted=!0,"granted"):"denied"===e.state?"denied":"prompt"}catch(e){logger.log("[Audio] Permissions API neni podporovano, zkusim primo")}return"unknown"}async function startRecording(e){logger.log("[Audio] Spoustim nahravani...");try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Vas prohlizec nepodporuje nahravani zvuku");var t=await checkMicrophonePermission();if("denied"===t)throw new Error("Pristup k mikrofonu byl trvale odepren. Povolte ho v nastaveni prohlizece.");window.wgsAudioRecorder.permissionGranted||"granted"===t||localStorage.getItem("wgs_mic_explained")||(wgsToast.info("Pro nahravani hlasovych poznamek potrebujeme pristup k mikrofonu. Po kliknuti na OK vas prohlizec pozada o povoleni."),localStorage.setItem("wgs_mic_explained","1"));var a=await navigator.mediaDevices.getUserMedia({audio:!0}),n=(window.wgsAudioRecorder.stream=a,window.wgsAudioRecorder.permissionGranted=!0,/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||/iPad|iPhone|iPod/.test(navigator.userAgent));let e="audio/webm",o=(n?(MediaRecorder.isTypeSupported("audio/mp4")?e="audio/mp4":MediaRecorder.isTypeSupported("audio/aac")&&(e="audio/aac"),logger.log("[Audio] Safari detekovan, preferuji MP4")):MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?e="audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/webm")?e="audio/webm":MediaRecorder.isTypeSupported("audio/mp4")?e="audio/mp4":MediaRecorder.isTypeSupported("audio/ogg")&&(e="audio/ogg"),logger.log("[Audio] Pouzivam format:",e),window.wgsAudioRecorder);o.mimeType=e,o.mediaRecorder=new MediaRecorder(a,{mimeType:e}),o.audioChunks=[],o.isRecording=!0,o.recordingStartTime=Date.now(),o.mediaRecorder.ondataavailable=e=>{0<e.data.size&&(o.audioChunks.push(e.data),logger.log("[Audio] Data chunk:",e.data.size,"bytes"))},o.mediaRecorder.onstop=()=>{var e;logger.log("[Audio] Nahravani ukonceno, chunks:",o.audioChunks.length),0===o.audioChunks.length?(logger.error("[Audio] Zadna data nebyla nahrana"),wgsToast.warning("Nahravka je prazdna. Zkuste to prosim znovu."),document.getElementById("btnStartRecord").classList.remove("hidden"),document.getElementById("recordingIndicator").classList.add("hidden")):(e=o.mimeType||"audio/webm",o.audioBlob=new Blob(o.audioChunks,{type:e}),o.isRecording=!1,logger.log("[Audio] Blob vytvoren:",o.audioBlob.size,"bytes, type:",e),releaseMicrophone(),showAudioPreview(o.audioBlob))},o.mediaRecorder.start(1e3),document.getElementById("btnStartRecord").classList.add("hidden"),document.getElementById("recordingIndicator").classList.remove("hidden"),o.recordingTimer=setInterval(()=>{var e=Math.floor((Date.now()-o.recordingStartTime)/1e3),t=Math.floor(e/60),e=e%60;document.getElementById("recordingTime").textContent=t+":"+e.toString().padStart(2,"0")},1e3),logger.log("[Audio] Nahravani spusteno")}catch(e){logger.error("[Audio] Chyba pri nahravani:",e),releaseMicrophone(),"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?wgsToast.error("Pristup k mikrofonu byl odepren. Povolte pristup v nastaveni prohlizece."):wgsToast.error("Chyba pri nahravani: "+e.message)}}function stopRecording(){logger.log("[Audio] Zastavuji nahravani...");let t=window.wgsAudioRecorder;if(t.recordingTimer&&(clearInterval(t.recordingTimer),t.recordingTimer=null),t.mediaRecorder&&t.isRecording)if("recording"===t.mediaRecorder.state)try{t.mediaRecorder.requestData(),setTimeout(()=>{t.mediaRecorder&&"recording"===t.mediaRecorder.state&&(t.mediaRecorder.stop(),logger.log("[Audio] MediaRecorder zastaven po requestData zpozdeni"))},150)}catch(e){logger.log("[Audio] requestData neni podporovano:",e.message),t.mediaRecorder.stop()}else"inactive"!==t.mediaRecorder.state&&t.mediaRecorder.stop();var e=document.getElementById("recordingIndicator");e&&e.classList.add("hidden")}function releaseMicrophone(){var e=window.wgsAudioRecorder;e.stream&&(e.stream.getTracks().forEach(e=>{e.stop(),logger.log("[Audio] Track zastaven:",e.kind)}),e.stream=null),e.mediaRecorder&&(e.mediaRecorder=null),e.isRecording=!1,e.audioChunks=[],logger.log("[Audio] Mikrofon a MediaRecorder uvolneny")}function showAudioPreview(e){var t=URL.createObjectURL(e);let o=document.getElementById("audioPreviewPlayer"),a=document.getElementById("audioPreview"),n=(o.onerror=null,o.oncanplay=null,!1);o.onerror=function(e){n||(n=!0,logger.log("[Audio] Chyba pri nacitani nahravky:",e),a.classList.add("hidden"),document.getElementById("btnStartRecord").classList.remove("hidden"),o.src&&(URL.revokeObjectURL(o.src),o.src=""),logger.error("[Audio] Nahravka se nepodarila nacist"))},o.src=t,a.classList.remove("hidden"),logger.log("[Audio] Nahled zobrazen, velikost:",Math.round(e.size/1024),"KB")}function deleteAudioPreview(){var e=window.wgsAudioRecorder,e=(e.audioBlob=null,e.audioChunks=[],document.getElementById("audioPreviewPlayer")),t=document.getElementById("audioPreview");e.src&&(URL.revokeObjectURL(e.src),e.src=""),t.classList.add("hidden"),document.getElementById("btnStartRecord").classList.remove("hidden"),logger.log("[Audio] Nahled smazan")}function formatDateTime(e){var e=new Date(e),t=new Date-e;return t<6e4?"Pr√°vƒõ teƒè":t<36e5?`P≈ôed ${Math.floor(t/6e4)} min`:t<864e5?`P≈ôed ${Math.floor(t/36e5)} h`:["ne","po","ut","st","ct","pa","so"][e.getDay()]+` ${e.getDate()}.${e.getMonth()+1}.${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:`+e.getMinutes().toString().padStart(2,"0")}function getStatus(e){return{"ƒåEK√Å":{class:"wait",text:"NOV√Å"},wait:{class:"wait",text:"NOV√Å"},"DOMLUVEN√Å":{class:"open",text:"DOMLUVEN√Å"},open:{class:"open",text:"DOMLUVEN√Å"},HOTOVO:{class:"done",text:"HOTOVO"},done:{class:"done",text:"HOTOVO"}}[e]||{class:"wait",text:"NOV√Å"}}function formatDate(e){var t;return e?(t=new Date(e),isNaN(t)?e:["ne","po","ut","st","ct","pa","so"][t.getDay()]+` ${t.getDate()}.${t.getMonth()+1}.`+t.getFullYear()):"‚Äî"}function formatAppointment(e,t){var o,a;return e&&t?3!==(a=e.split(".")).length?e+" "+t:(e=parseInt(a[0]),o=parseInt(a[1]),a=parseInt(a[2]),["ne","po","√∫t","st","ƒçt","p√°","so"][new Date(a,o-1,e).getDay()]+` ${e}.${o}.-`+t):""}function showDeleteConfirmModal(a){return new Promise(e=>{let t=document.createElement("div");t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10003;display:flex;align-items:center;justify-content:center;";var o=document.createElement("div");o.style.cssText="background:white;padding:30px;border-radius:8px;max-width:450px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);",o.innerHTML=`
      <h2 style="margin:0 0 20px 0;color:#666;font-size:1.3rem;font-weight:700;">Smazat reklamaci?</h2>
      <p style="margin:0 0 15px 0;color:#555;line-height:1.6;font-size:1rem;">
        Opravdu chcete <strong>TRVALE SMAZAT</strong> reklamaci<br>
        <strong style="color:#666;font-size:1.1rem;">${a}</strong>?
      </p>
      <p style="margin:0 0 25px 0;color:#666;font-size:0.9rem;font-weight:600;">
        Tato akce sma≈æe V≈†E vƒçetnƒõ fotek a PDF!<br>
        Tuto akci NELZE vr√°tit zpƒõt!
      </p>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <button id="deleteConfirmYes" style="padding:14px 28px;background:#666;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:700;">
          Ano, pokraƒçovat ‚Üí
        </button>
        <button id="deleteConfirmNo" style="padding:14px 28px;background:#999;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:600;">
          Zru≈°it
        </button>
      </div>
    `,t.appendChild(o),document.body.appendChild(t),document.getElementById("deleteConfirmNo").onclick=()=>{document.body.removeChild(t),e(!1)},document.getElementById("deleteConfirmYes").onclick=()=>{document.body.removeChild(t),e(!0)}})}function showDeleteInputModal(n){return new Promise(t=>{let o=document.createElement("div");o.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10003;display:flex;align-items:center;justify-content:center;";var e=document.createElement("div");e.style.cssText="background:white;padding:30px;border-radius:8px;max-width:450px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);",e.innerHTML=`
      <h2 style="margin:0 0 20px 0;color:#666;font-size:1.3rem;font-weight:700;">Posledn√≠ ovƒõ≈ôen√≠</h2>
      <p style="margin:0 0 15px 0;color:#555;line-height:1.6;font-size:1rem;">
        Pro potvrzen√≠ smaz√°n√≠ zadejte p≈ôesnƒõ ƒç√≠slo reklamace:
      </p>
      <p style="margin:0 0 15px 0;color:#666;font-size:1.2rem;font-weight:700;">
        ${n}
      </p>
      <input type="text" id="deleteInputField"
             placeholder="Zadejte ƒç√≠slo reklamace"
             style="width:100%;padding:12px;border:2px solid #666;border-radius:6px;font-size:1rem;text-align:center;margin-bottom:20px;">
      <div style="display:flex;flex-direction:column;gap:12px;">
        <button id="deleteInputConfirm" style="padding:14px 28px;background:#666;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:700;">
          SMAZAT NAV≈ΩDY
        </button>
        <button id="deleteInputCancel" style="padding:14px 28px;background:#999;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:600;">
          Zru≈°it
        </button>
      </div>
    `,o.appendChild(e),document.body.appendChild(o);let a=document.getElementById("deleteInputField");a.focus(),document.getElementById("deleteInputCancel").onclick=()=>{document.body.removeChild(o),t("")},document.getElementById("deleteInputConfirm").onclick=()=>{var e=a.value.trim();document.body.removeChild(o),t(e)},a.addEventListener("keypress",e=>{"Enter"===e.key&&(e=a.value.trim(),document.body.removeChild(o),t(e))})})}async function deleteReklamace(e){logger.log("[deleteReklamace] Zobrazuji 1. confirmation modal");var o=CURRENT_RECORD.reklamace_id||CURRENT_RECORD.id||e,a=await showDeleteConfirmModal(o);if(a)if(await showDeleteInputModal(o)!==o)logger.log("Maz√°n√≠ zru≈°eno - ≈°patn√© ƒç√≠slo (2. krok)"),(a=document.createElement("div")).style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10003;display:flex;align-items:center;justify-content:center;",a.innerHTML=`
      <div style="background:white;padding:30px;border-radius:8px;max-width:400px;width:90%;text-align:center;">
        <h2 style="margin:0 0 20px 0;color:#666;">Nespr√°vn√© ƒç√≠slo!</h2>
        <p style="margin:0 0 25px 0;color:#555;">Zadali jste nespr√°vn√© ƒç√≠slo reklamace.<br>Maz√°n√≠ bylo zru≈°eno.</p>
        <button data-action="closeErrorModal" style="padding:12px 24px;background:#999;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
          OK
        </button>
      </div>
    `,document.body.appendChild(a);else{logger.log("üóëÔ∏è Maz√°n√≠ reklamace:",e);try{var n,i=await getCSRFToken(),r=await fetch("api/delete_reklamace.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:e,csrf_token:i})}),d=await r.json();if(!r.ok)throw new Error(`HTTP ${r.status}: `+(d.message||d.error||r.statusText));d.success||"success"===d.status?(logger.log("Smaz√°no!"),wgsToast.success(t("claim_deleted_successfully")),closeDetail(),setTimeout(()=>location.reload(),500)):(n=d.message||d.error||t("delete_failed"),logger.error("Chyba:",n),wgsToast.error(t("error")+": "+n))}catch(e){logger.error("Chyba p≈ôi maz√°n√≠:",e),wgsToast.error(t("delete_error")+": "+e.message)}}else logger.log("Maz√°n√≠ zru≈°eno (1. krok)")}async function smazatFotku(a,n){return logger.log("[smazatFotku] Vytv√°≈ô√≠m confirmation modal pro ID:",a),new Promise(e=>{let t=document.createElement("div");t.id="deleteFotoModal",t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10003;display:flex;align-items:center;justify-content:center;";var o=document.createElement("div");o.style.cssText="background:white;padding:30px;border-radius:8px;max-width:400px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);",o.innerHTML=`
      <h2 style="margin:0 0 20px 0;color:#333;font-size:1.2rem;font-weight:700;">Smazat fotku?</h2>
      <p style="margin:0 0 25px 0;color:#555;line-height:1.6;font-size:1rem;">
        Opravdu chcete smazat tuto fotografii?<br><br>
        <strong>Tato akce je nevratn√°!</strong>
      </p>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <button id="deleteFotoYes" style="padding:14px 28px;background:#666;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:700;">
          Ano, smazat
        </button>
        <button id="deleteFotoNo" style="padding:14px 28px;background:#999;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:600;">
          Zru≈°it
        </button>
      </div>
    `,t.appendChild(o),document.body.appendChild(t),document.getElementById("deleteFotoNo").onclick=()=>{logger.log("[smazatFotku] U≈æivatel zru≈°il"),document.body.removeChild(t),e(!1)},document.getElementById("deleteFotoYes").onclick=async()=>{logger.log("[smazatFotku] U≈æivatel potvrdil, maz√°m..."),document.body.removeChild(t),await pokracovatSmazaniFotky(a,n),e(!0)}})}async function pokracovatSmazaniFotky(e,o){logger.log("üóëÔ∏è Maz√°n√≠ fotky ID:",e);try{var a,n=await getCSRFToken(),i=new FormData,r=(i.append("photo_id",e),i.append("csrf_token",n),await fetch("api/delete_photo.php",{method:"POST",body:i})),d=await r.json();if(!r.ok)throw new Error(`HTTP ${r.status}: `+(d.message||d.error||r.statusText));if("success"===d.status){logger.log("Fotka smaz√°na!");for(a of document.querySelectorAll(".foto-wrapper img"))if(a.src.includes(o.replace(/\\/g,""))){a.closest(".foto-wrapper").remove();break}var s,l,c=document.querySelector('[style*="Fotografie"]');c&&(s=document.querySelectorAll(".foto-wrapper").length,c.textContent=`Fotografie (${s})`,0===s)&&(l=c.closest("div").querySelector('[style*="grid"]'))&&(l.innerHTML=`<p style="color: var(--c-grey); text-align: center; padding: 1rem; font-size: 0.9rem;">${t("no_photos")}</p>`),wgsToast.success(t("photo_deleted_successfully"))}else{var p=d.message||d.error||t("delete_failed");logger.error("Chyba:",p),wgsToast.error(t("error")+": "+p)}}catch(e){logger.error("Chyba p≈ôi maz√°n√≠ fotky:",e),wgsToast.error(t("photo_delete_error")+": "+e.message)}}async function loadPhotosFromDB(e){try{var t,o=await fetch("api/get_photos_api.php?reklamace_id="+e);return o.ok?(t=await o.json()).success&&t.photos?t.photos.map(e=>({id:e.id,photo_path:e.photo_path,section_name:e.section_name})):[]:[]}catch(e){return logger.error("Chyba naƒç√≠t√°n√≠ fotek:",e),[]}}async function loadMoreOrders(){var e;!LOADING_MORE&&HAS_MORE_PAGES&&(LOADING_MORE=!0,(e=document.getElementById("loadMoreBtn"))&&(e.disabled=!0,e.textContent=t("loading")),await loadAll(ACTIVE_FILTER,!0))}function updateLoadMoreButton(){let e=document.getElementById("loadMoreBtn");var o;e||(o=document.getElementById("orderGrid"))&&o.parentElement&&((e=document.createElement("button")).id="loadMoreBtn",e.className="load-more-btn",e.textContent=t("load_more_orders"),e.onclick=loadMoreOrders,o.parentElement.appendChild(e)),e&&(e.classList.toggle("hidden",!HAS_MORE_PAGES),e.disabled=LOADING_MORE,e.textContent=LOADING_MORE?t("loading"):t("load_more_page").replace("{page}",CURRENT_PAGE+1))}async function sendContactAttemptEmail(t,o){try{if(WGS_DATA_CACHE.find(e=>e.id==t||e.reklamace_id==t)){showLoading("Odes√≠l√°m email z√°kazn√≠kovi... Pros√≠m ƒçekejte");var e=await getCSRFToken(),a=await(await fetch("/api/send_contact_attempt_email.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:t,csrf_token:e})})).json();if(hideLoading(),a.success){logger.log("Email o pokusu o kontakt odesl√°n z√°kazn√≠kovi"),closeDetail(),"undefined"!=typeof WGSToast?WGSToast.zobrazit("Email odesl√°n z√°kazn√≠kovi",{titulek:"WGS"}):showToast("Email odesl√°n z√°kazn√≠kovi","success");let t=a.sms_text||"Dobr√Ω den, pokusili jsme se V√°s kontaktovat. Zavolejte pros√≠m zpƒõt na +420 725 965 826. Dƒõkujeme, WGS Service";setTimeout(()=>{var e=encodeURIComponent(t);window.location.href=`sms:${o}?body=`+e},2e3)}else logger.error("‚ö† Chyba p≈ôi odes√≠l√°n√≠ emailu:",a.error||a.message),showToast(a.error||"Chyba p≈ôi odes√≠l√°n√≠ emailu","error")}else showToast("Z√°znam nenalezen","error")}catch(e){logger.error("Chyba p≈ôi odes√≠l√°n√≠ kontaktn√≠ho emailu:",e),showToast("Nepoda≈ôilo se odeslat email","error"),hideLoading()}}async function zobrazVideotekaArchiv(r){if(logger.log("[Videot√©ka] Otev√≠r√°m archiv pro zak√°zku ID: "+r),document.getElementById("videotekaOverlay"))logger.log("[Videot√©ka] Overlay u≈æ existuje, ignoruji");else{let t=document.createElement("div");t.id="videotekaOverlay",t.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10004; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem;";var e=document.createElement("div"),d=(e.style.cssText="width: 95%; max-width: 900px; height: 90%; background: #222; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;",window.innerWidth<600),s=document.createElement("div");s.style.cssText=d?"padding: 12px 16px; background: #333; color: white; font-weight: 600; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 2px; border-bottom: 2px solid #444;":"padding: 16px 20px; background: #333; color: white; font-weight: 600; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #444;",s.innerHTML="<span>Naƒç√≠t√°n√≠...</span>";let o=document.createElement("div"),a=(o.id="videotekaContent",o.style.cssText="flex: 1; overflow-y: auto; padding: 16px; background: #1a1a1a; display: flex; flex-direction: column; gap: 12px; align-content: start; position: relative; transition: background 0.2s ease;",document.createElement("div")),n=(a.id="videotekaDropOverlay",a.style.cssText="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(45, 80, 22, 0.3); border: 3px dashed #2D5016; display: none; align-items: center; justify-content: center; z-index: 10; pointer-events: none;",a.innerHTML='<div style="color: white; font-size: 1.2rem; font-weight: 600; text-align: center; padding: 2rem;">Pus≈•te video pro nahr√°n√≠</div>',0);o.addEventListener("dragenter",e=>{e.preventDefault(),e.stopPropagation(),n++,a.classList.remove("hidden"),o.style.background="#252525"}),o.addEventListener("dragleave",e=>{e.preventDefault(),e.stopPropagation(),0===--n&&(a.classList.add("hidden"),o.style.background="#1a1a1a")}),o.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation()}),o.addEventListener("drop",async e=>{e.preventDefault(),e.stopPropagation(),n=0,a.classList.add("hidden"),o.style.background="#1a1a1a";var e=e.dataTransfer.files;0<e.length&&((e=e[0]).type.startsWith("video/")?(logger.log(`[Videot√©ka] Drag & drop: ${e.name} (${(e.size/1024/1024).toFixed(2)} MB)`),await nahratVideoDragDrop(e,r,t)):showToast("Lze nahr√°t pouze video soubory","error"))});try{var l,c=await(await fetch("/api/video_api.php?action=list_videos&claim_id="+r)).json();"success"===c.status&&(p=c.customer_name||"Nezn√°m√Ω z√°kazn√≠k",m=c.reklamace_cislo||r,s.innerHTML=d?`
          <span style="font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">${p}</span>
          <span style="font-size: 0.75rem; opacity: 0.6;">${m}</span>
        `:`<span>${p}</span><span style="font-size: 0.85rem; opacity: 0.7;">${m}</span>`,c.videos&&0<c.videos.length?c.videos.forEach(e=>{e=vytvorVideoKartu(e,r);o.appendChild(e)}):(o.classList.add("flex-center"),(l=document.createElement("div")).style.cssText="text-align: center; padding: 3rem; color: #999;",l.innerHTML=`
          <div style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 1rem;">≈Ω√°dn√° videa v archivu</div>
          <div style="font-size: 1.05rem; font-weight: 500; margin-bottom: 0.5rem;">P≈ôet√°hnƒõte video sem</div>
          <div style="font-size: 0.85rem; opacity: 0.7;">nebo pou≈æijte tlaƒç√≠tko n√≠≈æe</div>
        `,o.appendChild(l)))}catch(e){logger.error("[Videot√©ka] Chyba p≈ôi naƒç√≠t√°n√≠ vide√≠:",e),s.innerHTML="<span>Chyba</span>",o.innerHTML=`
      <div style="text-align: center; padding: 3rem; color: #f44;">
        <div style="font-size: 1rem; margin-bottom: 0.5rem;">Chyba p≈ôi naƒç√≠t√°n√≠ vide√≠</div>
        <div style="font-size: 0.85rem; opacity: 0.7;">${e.message}</div>
      </div>
    `}var d=document.createElement("div"),p=(d.style.cssText="padding: 16px 20px; background: #333; border-top: 2px solid #444; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;",document.createElement("button")),m=(p.textContent="Nahr√°t video",p.style.cssText="padding: 12px 24px; font-size: 0.95rem; font-weight: 600; background: #2D5016; color: white; border: none; border-radius: 6px; cursor: pointer; min-width: 140px; touch-action: manipulation;",p.onclick=()=>otevritNahravaniVidea(r,t),document.createElement("button"));m.textContent="Zav≈ô√≠t",m.style.cssText="padding: 12px 24px; font-size: 0.95rem; font-weight: 600; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; min-width: 140px; touch-action: manipulation;",m.onclick=()=>t.remove(),d.appendChild(p),d.appendChild(m),o.appendChild(a),e.appendChild(s),e.appendChild(o),e.appendChild(d),t.appendChild(e),t.onclick=e=>{e.target===t&&t.remove()};let i=e=>{"Escape"===e.key&&(t.remove(),document.removeEventListener("keydown",i))};document.addEventListener("keydown",i),document.body.appendChild(t)}}function generujNahledVidea(e,s,l){return new Promise(i=>{let r=document.createElement("video"),d=(r.crossOrigin="anonymous",r.muted=!0,r.preload="metadata",setTimeout(()=>{r.src="",i(null)},5e3));r.onloadedmetadata=()=>{var e=Math.min(1,.1*r.duration);r.currentTime=e},r.onseeked=()=>{clearTimeout(d);try{var e=document.createElement("canvas"),t=r.videoWidth,o=r.videoHeight,a=Math.min(s/t,l/o,1);e.width=Math.round(t*a*2),e.height=Math.round(o*a*2);e.getContext("2d").drawImage(r,0,0,e.width,e.height);var n=e.toDataURL("image/jpeg",.7);r.src="",i(n)}catch(e){r.src="",i(null)}},r.onerror=()=>{clearTimeout(d),i(null)},r.src=e})}function vytvorVideoKartu(a,e){let n=window.innerWidth<600,i=document.createElement("div"),t=(i.style.cssText=`
    background: #2a2a2a;
    border-radius: 6px;
    padding: ${n?"8px":"12px"};
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    gap: ${n?"8px":"12px"};
    border: 1px solid #444;
    width: 100%;
    box-sizing: border-box;
  `,document.createElement("div"));var o=n?100:120,r=n?60:68,o=(t.style.cssText=`
    flex-shrink: 0;
    width: ${o}px;
    height: ${r}px;
    background: #1a1a1a;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #555;
    cursor: pointer;
    overflow: hidden;
    position: relative;
  `,t.innerHTML=`<span style="font-size: ${n?"1.5rem":"2rem"}; opacity: 0.5; color: #fff;">‚ñ∂</span>`,t.onclick=()=>prehratVideo(a.video_path,a.video_name),generujNahledVidea(a.video_path,o,r).then(e=>{e&&(t.innerHTML=`
        <img src="${e}" style="width: 100%; height: 100%; object-fit: cover;">
        <span style="position: absolute; font-size: ${n?"1.2rem":"1.5rem"}; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.8); opacity: 0.9;">‚ñ∂</span>
      `)}).catch(()=>{}),document.createElement("div")),d=(o.style.cssText="flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 2px; min-width: 0;",o.title=a.video_name,document.createElement("div")),s=(d.style.cssText=`font-weight: 500; font-size: ${n?"0.7rem":"0.9rem"}; color: ${n?"#aaa":"#fff"};`,a.uploader_email?(s=a.uploader_email.split("@")[0],d.textContent=s,d.title=a.uploader_email):(d.textContent="Admin",d.style.color="#888"),document.createElement("div")),l=(s.style.cssText=`display: flex; gap: ${n?"6px":"8px"}; flex-wrap: wrap; align-items: center;`,document.createElement("span")),c=(l.style.cssText=`font-size: ${n?"0.6rem":"0.7rem"}; color: #666;`,l.textContent=(a.file_size/1024/1024).toFixed(1)+" MB",document.createElement("span"));c.style.cssText=`font-size: ${n?"0.6rem":"0.7rem"}; color: #666;`;let p="‚Äî";a.uploaded_at&&(m=["ne","po","ut","st","ct","pa","so"][(g=new Date(a.uploaded_at)).getDay()],p=n?`${m} ${g.getDate()}.${g.getMonth()+1}.`:`${m} ${g.getDate()}.${g.getMonth()+1}.${g.getFullYear()} ${g.getHours().toString().padStart(2,"0")}:`+g.getMinutes().toString().padStart(2,"0")),c.textContent=p,s.appendChild(l),s.appendChild(c),o.appendChild(d),o.appendChild(s);var m=document.createElement("div");m.style.cssText=n?`display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; height: ${r}px; max-height: ${r}px; overflow: hidden; box-sizing: border-box;`:"display: flex; flex-direction: row; align-items: center; gap: 6px; flex-shrink: 0;";let u="height: 28px !important; min-height: 28px !important; max-height: 28px !important; width: 36px; padding: 0; margin: 0; border-radius: 3px; cursor: pointer; touch-action: manipulation; display: flex; align-items: center; justify-content: center; border: 1px solid #555; box-sizing: border-box;";var g=document.createElement("button");n?(g.innerHTML='<i class="fas fa-download"></i>',g.title="St√°hnout video",g.style.cssText=u+" background: #444; color: #ccc; font-size: 0.75rem;"):(g.textContent="St√°hnout",g.style.cssText="min-height: 36px; padding: 0.4rem 0.8rem; font-size: 0.8rem; border: 1px solid #555; border-radius: 4px; cursor: pointer; touch-action: manipulation; white-space: nowrap; background: #444; color: white;"),g.onclick=()=>{var e=document.createElement("a");e.href=a.video_path,e.download=a.video_name||"video.mp4",e.click()};let v=document.createElement("button"),h=n?u+" background: #442222; color: #c66; font-size: 0.85rem; font-weight: bold;":"min-height: 36px; width: 36px; padding: 0; font-size: 1.1rem; font-weight: bold; background: #553333; color: #c66; border: 1px solid #664444; border-radius: 4px; cursor: pointer; touch-action: manipulation; display: flex; align-items: center; justify-content: center;",y=(v.innerHTML="&#10005;",v.title="Smazat video",v.style.cssText=h,null);return v.onclick=async e=>{if(e.stopPropagation(),v.classList.contains("potvrzeni-video")){clearTimeout(y),v.innerHTML="...",v.disabled=!0;try{var t=new FormData;t.append("action","delete_video"),t.append("video_id",a.id),t.append("csrf_token",document.querySelector('input[name="csrf_token"]')?.value||"");var o=await(await fetch("/api/video_api.php",{method:"POST",body:t})).json();if("success"!==o.status)throw new Error(o.message||"Chyba p≈ôi maz√°n√≠");showToast("Video bylo smaz√°no","success"),i.remove()}catch(e){logger.error("[Videot√©ka] Chyba p≈ôi maz√°n√≠ videa:",e),showToast("Chyba p≈ôi maz√°n√≠ videa: "+e.message,"error"),v.classList.remove("potvrzeni-video"),v.innerHTML="&#10005;",v.style.cssText=h,v.disabled=!1}}else v.classList.add("potvrzeni-video"),v.innerHTML="Smazat?",v.style.cssText=n?u+" background: #662222; color: #fff; font-size: 0.7rem; font-weight: bold; min-width: 50px;":"min-height: 36px; padding: 0 8px; font-size: 0.75rem; font-weight: bold; background: #662222; color: #fff; border: 1px solid #884444; border-radius: 4px; cursor: pointer; touch-action: manipulation; white-space: nowrap;",y=setTimeout(()=>{v.classList.remove("potvrzeni-video"),v.innerHTML="&#10005;",v.style.cssText=h},3e3)},m.appendChild(g),m.appendChild(v),i.appendChild(t),i.appendChild(o),i.appendChild(m),i}function prehratVideo(e,t){let o=document.createElement("div"),a=(o.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10005; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem;",document.createElement("video"));a.src=e,a.controls=!0,a.autoplay=!0,a.style.cssText="max-width: 95%; max-height: 85vh; border-radius: 8px;";e=document.createElement("div"),e.style.cssText="color: white; font-size: 1rem; margin-top: 16px; text-align: center;",e.textContent=t||"Video",t=document.createElement("button");t.textContent="Zav≈ô√≠t",t.style.cssText="margin-top: 16px; padding: 10px 24px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;",t.onclick=()=>{a.pause(),o.remove()},o.appendChild(a),o.appendChild(e),o.appendChild(t),o.onclick=e=>{e.target===o&&(a.pause(),o.remove())};let n=e=>{"Escape"===e.key&&(a.pause(),o.remove(),document.removeEventListener("keydown",n))};document.addEventListener("keydown",n),document.body.appendChild(o)}function otevritNahravaniVidea(r,d){logger.log("[Videot√©ka] Otev√≠r√°m upload pro zak√°zku ID: "+r);let s=document.createElement("div");s.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10006; display: flex; align-items: center; justify-content: center; padding: 1rem;";var e=document.createElement("div"),t=(e.style.cssText="background: #2a2a2a; border-radius: 8px; padding: 24px; max-width: 500px; width: 100%; border: 2px solid #444;",document.createElement("h3"));t.style.cssText="color: white; margin: 0 0 20px 0; font-size: 1.1rem;",t.textContent="Nahr√°t video";let l=document.createElement("input");l.type="file",l.id="video",l.name="video",l.accept="video/*",l.style.cssText="display: block; width: 100%; padding: 12px; background: #1a1a1a; color: white; border: 1px solid #555; border-radius: 4px; margin-bottom: 16px; font-size: 0.9rem;";var o=document.createElement("div");o.style.cssText="background: #1a1a1a; padding: 12px; border-radius: 4px; margin-bottom: 16px; color: #999; font-size: 0.85rem; border: 1px solid #555;",o.innerHTML=`
    <div style="margin-bottom: 6px;">‚ÑπÔ∏è <strong>Informace o nahr√°v√°n√≠:</strong></div>
    <div style="margin-left: 24px;">
      <div>‚Ä¢ Maxim√°ln√≠ velikost: 500 MB</div>
      <div>‚Ä¢ Podporovan√© form√°ty: MP4, MOV, AVI, WebM</div>
      <div>‚Ä¢ Video nad 500 MB bude automaticky komprimov√°no</div>
    </div>
  `;let c=document.createElement("div");c.style.cssText="display: none; margin-bottom: 16px;";var a=document.createElement("div");a.style.cssText="width: 100%; height: 24px; background: #1a1a1a; border-radius: 4px; overflow: hidden; border: 1px solid #555;";let p=document.createElement("div"),m=(p.style.cssText="height: 100%; background: #2D5016; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;",a.appendChild(p),c.appendChild(a),document.createElement("div"));m.style.cssText="text-align: center; color: #999; font-size: 0.85rem; margin-top: 8px; display: none;",c.appendChild(m);a=document.createElement("div");a.style.cssText="display: flex; gap: 12px; justify-content: flex-end;";let u=document.createElement("button"),g=(u.textContent="Zru≈°it",u.style.cssText="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;",u.onclick=()=>s.remove(),document.createElement("button")),n=(g.textContent="Nahr√°t",g.style.cssText="padding: 10px 20px; background: #2D5016; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600;",g.onclick=async()=>{var o=l.files[0];if(o){var e=524288e3<o.size;g.disabled=!0,u.disabled=!0,c.classList.remove("hidden"),m.classList.remove("hidden");try{let t=o;if(e){m.textContent="Komprimuji video...",p.style.width="10%",p.textContent="10%";try{if("undefined"==typeof MediaRecorder)throw new Error("MediaRecorder nen√≠ podporov√°n");t=await komprimovatVideo(o,e=>{e=Math.round(10+40*e);p.style.width=e+"%",p.textContent=e+"%"}),logger.log(`[Videot√©ka] Video komprimov√°no: ${o.size} ‚Üí ${t.size} byt≈Ø`)}catch(e){if(logger.warn("[Videot√©ka] Komprese selhala, pou≈æ√≠v√°m origin√°l: "+e.message),t=o,m.textContent="Komprese nedostupn√°, nahr√°v√°m origin√°l...",524288e3<o.size)throw showToast("Video je p≈ô√≠li≈° velk√© (max 500 MB). Komprese selhala.","error"),new Error("Video p≈ô√≠li≈° velk√© a komprese nen√≠ dostupn√°")}}m.textContent="Nahr√°v√°m video...",p.style.width="50%",p.textContent="50%";var a=new FormData,n=(a.append("action","upload_video"),a.append("claim_id",r),a.append("video",t,t.name||o.name),a.append("csrf_token",document.querySelector('input[name="csrf_token"]')?.value||""),await fetch("/api/video_api.php",{method:"POST",body:a})),i=(p.style.width="90%",p.textContent="90%",await n.json());if("success"!==i.status)throw new Error(i.message||"Chyba p≈ôi nahr√°v√°n√≠");p.style.width="100%",p.textContent="100%",m.textContent="Hotovo!",p.style.background="#333","undefined"!=typeof WGSToast?WGSToast.zobrazit("Video bylo √∫spƒõ≈°nƒõ nahr√°no",{titulek:"WGS"}):showToast("Video bylo √∫spƒõ≈°nƒõ nahr√°no","success"),setTimeout(()=>{s.remove(),d.remove(),zobrazVideotekaArchiv(r)},1e3)}catch(e){logger.error("[Videot√©ka] Chyba p≈ôi uploadu:",e),p.style.background="#c33",m.textContent="Chyba: "+e.message,g.disabled=!1,u.disabled=!1,showToast("Chyba p≈ôi nahr√°v√°n√≠ videa: "+e.message,"error")}}else wgsToast.warning("Vyberte video soubor")},a.appendChild(u),a.appendChild(g),e.appendChild(t),e.appendChild(o),e.appendChild(l),e.appendChild(c),e.appendChild(a),s.appendChild(e),e=>{"Escape"!==e.key||g.disabled||(s.remove(),document.removeEventListener("keydown",n))});document.addEventListener("keydown",n),document.body.appendChild(s)}async function nahratVideoDragDrop(t,o,a){logger.log("[Videot√©ka] Zahajuji drag & drop upload: "+t.name);let n=document.createElement("div");n.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10007; display: flex; align-items: center; justify-content: center; padding: 1rem;";var e=document.createElement("div"),i=(e.style.cssText="background: #2a2a2a; border-radius: 8px; padding: 24px; max-width: 400px; width: 100%; border: 2px solid #444; text-align: center;",document.createElement("div")),r=(i.style.cssText="color: white; font-size: 1rem; font-weight: 600; margin-bottom: 16px;",i.textContent="Nahr√°v√°n√≠ videa...",document.createElement("div"));r.style.cssText="width: 100%; height: 24px; background: #1a1a1a; border-radius: 4px; overflow: hidden; border: 1px solid #555;";let d=document.createElement("div");d.style.cssText="height: 100%; background: #2D5016; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;",d.textContent="0%";var s=document.createElement("div");s.style.cssText="color: #999; font-size: 0.85rem; margin-top: 12px;",s.textContent=t.name,r.appendChild(d),e.appendChild(i),e.appendChild(r),e.appendChild(s),n.appendChild(e),document.body.appendChild(n);try{let e=t;524288e3<t.size&&(s.textContent="Komprimuji video...",d.style.width="10%",d.textContent="10%",e=await komprimovatVideo(t,e=>{e=Math.round(10+40*e);d.style.width=e+"%",d.textContent=e+"%"}),logger.log(`[Videot√©ka] Video komprimov√°no: ${t.size} ‚Üí ${e.size} byt≈Ø`)),s.textContent="Odes√≠l√°m na server...",d.style.width="50%",d.textContent="50%";var l=new FormData,c=(l.append("action","upload_video"),l.append("claim_id",o),l.append("video",e,e.name||t.name),l.append("csrf_token",document.querySelector('input[name="csrf_token"]')?.value||""),await fetch("/api/video_api.php",{method:"POST",body:l})),p=(d.style.width="90%",d.textContent="90%",await c.json());if("success"!==p.status)throw new Error(p.message||"Chyba p≈ôi nahr√°v√°n√≠");d.style.width="100%",d.textContent="100%",s.textContent="Hotovo!",d.style.background="#333","undefined"!=typeof WGSToast?WGSToast.zobrazit("Video bylo √∫spƒõ≈°nƒõ nahr√°no",{titulek:"WGS"}):showToast("Video bylo √∫spƒõ≈°nƒõ nahr√°no","success"),setTimeout(()=>{n.remove(),a.remove(),zobrazVideotekaArchiv(o)},1e3)}catch(e){logger.error("[Videot√©ka] Chyba p≈ôi drag & drop uploadu:",e),d.style.background="#c33",d.style.width="100%",s.textContent="Chyba: "+e.message,showToast("Chyba p≈ôi nahr√°v√°n√≠ videa: "+e.message,"error"),setTimeout(()=>{n.remove()},3e3)}}async function komprimovatVideo(u,g){return new Promise((p,m)=>{try{let c=document.createElement("video");c.preload="metadata",c.muted=!0,c.playsInline=!0,c.onloadedmetadata=()=>{var e=c.videoWidth,n=c.videoHeight;let i=e,r=n;(1920<e||1080<n)&&(l=Math.min(1920/e,1080/n),i=Math.round(e*l),r=Math.round(n*l));e=document.createElement("canvas");e.width=i,e.height=r;let d=e.getContext("2d");var t,n=e.captureStream(30);let s="";for(t of["video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm","video/mp4"])if(MediaRecorder.isTypeSupported(t)){s=t;break}if(s){logger.log("[Videot√©ka] Pou≈æ√≠v√°m kodek: "+s);var l={mimeType:s,videoBitsPerSecond:25e5};let t;try{t=new MediaRecorder(n,l)}catch(e){t=new MediaRecorder(n,{mimeType:s})}let o=[],a=(t.ondataavailable=e=>{0<e.data.size&&o.push(e.data)},t.onstop=()=>{var e=new Blob(o,{type:s}),t=s.includes("mp4")?"mp4":"webm";e.name=u.name.replace(/\.[^.]+$/,"")+"_compressed."+t,p(e)},t.onerror=e=>{m(new Error("Chyba p≈ôi kompresi videa: "+(e.error?.message||"nezn√°m√°")))},t.start(1e3),c.play().catch(e=>{m(new Error("Nelze p≈ôehr√°t video pro kompresi: "+e.message))}),()=>{var e;c.paused||c.ended?setTimeout(()=>t.stop(),100):(d.drawImage(c,0,0,i,r),g&&(e=c.currentTime/c.duration,g(e)),requestAnimationFrame(a))});c.onplay=()=>{a()},c.onerror=()=>{m(new Error("Chyba p≈ôi naƒç√≠t√°n√≠ videa pro kompresi"))}}else m(new Error("≈Ω√°dn√Ω video kodek nen√≠ podporov√°n"))},c.onerror=()=>{m(new Error("Video soubor nelze naƒç√≠st"))},c.src=URL.createObjectURL(u)}catch(e){m(e)}})}window.wgsAudioRecorder={mediaRecorder:null,audioChunks:[],audioBlob:null,isRecording:!1,recordingStartTime:null,recordingTimer:null,permissionGranted:!1,stream:null},document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{var e=e.target.closest("[data-action]");e&&(e=e.getAttribute("data-action"),["reopenOrder","openPDF","startVisit","showCalendar","showContactMenu","showCustomerDetail","closeDetail","deleteReklamace","showDetailById","showDetail","showNotes","closeNotesModal","deleteNote","saveNewNote","showHistoryPDF","showVideoteka","saveSelectedDate","previousMonth","nextMonth","showBookingDetail","showCalendarBack","openCalendarFromDetail","sendContactAttemptEmail","showPhotoFullscreen","smazatFotku","saveAllCustomerData","startRecording","stopRecording","deleteAudioPreview","closeErrorModal","filterUnreadNotes"].includes(e)||("reload"===e?location.reload():"function"==typeof window[e]&&window[e]()))}),document.addEventListener("click",e=>{e=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");e&&("function"==typeof navigateTo?navigateTo(e):location.href=e)}),document.addEventListener("change",e=>{var t,e=e.target.closest("[data-onchange]");e&&(t=e.getAttribute("data-onchange"),e=e.getAttribute("data-onchange-value")||e.value,"function"==typeof window[t])&&window[t](e)})});