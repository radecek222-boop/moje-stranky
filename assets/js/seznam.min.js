window.csrfTokenCache=window.csrfTokenCache||null;const originalFetch=window.fetch||fetch;async function getCSRFToken(){if(window.csrfTokenCache)return window.csrfTokenCache;try{const e=await originalFetch("/app/controllers/get_csrf_token.php"),t=await e.json();return window.csrfTokenCache=t.token,t.token}catch(e){return"undefined"!=typeof logger&&logger.error("Chyba z√≠sk√°n√≠ CSRF tokenu:",e),""}}function showToast(e,t="info"){const o=document.getElementById("wgs-toast");o&&o.remove();const n=document.createElement("div");n.id="wgs-toast",n.textContent=e,n.style.cssText=`\n    position: fixed;\n    top: 80px;\n    right: 20px;\n    background: ${"success"===t?"#333":"error"===t?"#666":"#333"};\n    color: white;\n    padding: 16px 24px;\n    border-radius: 4px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n    z-index: 10000;\n    font-size: 14px;\n    font-weight: 600;\n    min-width: 250px;\n    max-width: 400px;\n    animation: slideIn 0.3s ease-out;\n  `;const a=document.createElement("style");a.textContent="\n    @keyframes slideIn {\n      from {\n        transform: translateX(400px);\n        opacity: 0;\n      }\n      to {\n        transform: translateX(0);\n        opacity: 1;\n      }\n    }\n    @keyframes slideOut {\n      from {\n        transform: translateX(0);\n        opacity: 1;\n      }\n      to {\n        transform: translateX(400px);\n        opacity: 0;\n      }\n    }\n  ",document.getElementById("wgs-toast-styles")||(a.id="wgs-toast-styles",document.head.appendChild(a)),document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease-in",setTimeout(()=>n.remove(),300)},3e3)}let WGS_DATA_CACHE=[],ACTIVE_FILTER="all",CURRENT_RECORD=null,SELECTED_DATE=null,SELECTED_TIME=null,CURRENT_PAGE=1,HAS_MORE_PAGES=!1,LOADING_MORE=!1;const PER_PAGE=50;let CAL_MONTH=(new Date).getMonth(),CAL_YEAR=(new Date).getFullYear(),SEARCH_QUERY="";const WGS_ADDRESS="Dubƒçe 364, Bƒõchovice 190 11, ƒåesk√° republika",WGS_COORDS={lat:50.0472,lng:14.5881};let DISTANCE_CACHE={};const Utils={getCustomerName:e=>e.jmeno||e.zakaznik||"Nezn√°m√Ω z√°kazn√≠k",getAddress:e=>{if(e.adresa)return e.adresa;const t=[e.ulice,e.mesto,e.psc].filter(e=>e);return t.length>0?t.join(", "):"‚Äî"},getProduct:e=>e.model||e.vyrobek||"‚Äî",getOrderId:(e,t=0)=>e.cislo||e.reklamacniCislo||e.id||"WGS-"+(t+1),isCompleted:e=>"HOTOVO"===e.stav||"done"===e.stav,escapeHtml:e=>{const t=document.createElement("div");return t.textContent=e,t.innerHTML},addCountryToAddress:e=>e?e.toLowerCase().includes("ƒçesk")?e:e+", ƒåesk√° republika":e,filterByUserRole:e=>{if(!CURRENT_USER||CURRENT_USER.is_admin||"prodejce"!==CURRENT_USER.role)return e;const t=String(CURRENT_USER.id),o=(CURRENT_USER.supervised_user_ids||[]).map(String);return e.filter(e=>{const n=String(e.zpracoval_id);return n===t||!!o.includes(n)})}},CacheManager={load:()=>{try{const e=localStorage.getItem("wgs_distance_cache");e&&(DISTANCE_CACHE=JSON.parse(e),logger.log("Naƒçteno",Object.keys(DISTANCE_CACHE).length,"vzd√°lenost√≠ z cache"))}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ cache:",e)}},save:()=>{try{localStorage.setItem("wgs_distance_cache",JSON.stringify(DISTANCE_CACHE))}catch(e){logger.error("Chyba p≈ôi ukl√°d√°n√≠ cache:",e)}}},AUTO_REFRESH_INTERVAL=6e4;let autoRefreshTimer=null,lastRefreshTime=Date.now();function startAutoRefresh(){autoRefreshTimer&&clearInterval(autoRefreshTimer),autoRefreshTimer=setInterval(async()=>{"visible"===document.visibilityState&&(logger.log("[AutoRefresh] Automaticka aktualizace dat..."),await loadAll(ACTIVE_FILTER),lastRefreshTime=Date.now())},6e4),logger.log("[AutoRefresh] Spusten - interval 60s")}function stopAutoRefresh(){autoRefreshTimer&&(clearInterval(autoRefreshTimer),autoRefreshTimer=null,logger.log("[AutoRefresh] Zastaven"))}function initSearch(){const e=document.getElementById("searchInput"),t=document.getElementById("searchClear"),o=new URLSearchParams(window.location.search).get("search");o&&(e.value=o,SEARCH_QUERY=o.trim().toLowerCase(),t.classList.add("visible"),window.history.replaceState({},document.title,window.location.pathname)),e.addEventListener("input",e=>{SEARCH_QUERY=e.target.value.trim().toLowerCase(),t.classList.toggle("visible",SEARCH_QUERY.length>0),renderOrders(Utils.filterByUserRole(WGS_DATA_CACHE))}),e.addEventListener("keydown",e=>{"Escape"===e.key&&clearSearch()})}function clearSearch(){const e=document.getElementById("searchInput"),t=document.getElementById("searchClear");e.value="",SEARCH_QUERY="",t.classList.remove("visible"),renderOrders(Utils.filterByUserRole(WGS_DATA_CACHE))}function highlightText(e,t){return Utils.highlightText?Utils.highlightText(e,t):Utils.escapeHtml(e)}function matchesSearch(e,t){if(!t)return!0;return[Utils.getCustomerName(e),e.telefon||"",e.email||"",Utils.getAddress(e),Utils.getProduct(e),Utils.getOrderId(e),e.popis_problemu||""].join(" ").toLowerCase().includes(t)}function initFilters(){document.querySelectorAll(".filter-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),ACTIVE_FILTER=e.dataset.filter,renderOrders(Utils.filterByUserRole(WGS_DATA_CACHE))})})}function updateCounts(e){if(!Array.isArray(e))return;const t=e.length,o=e.filter(e=>{const t=e.stav||"wait";return"ƒåEK√Å"===t||"wait"===t}).length,n=e.filter(e=>{const t=e.stav||"wait";return"DOMLUVEN√Å"===t||"open"===t}).length,a=e.filter(e=>{const t=e.stav||"wait";return"HOTOVO"===t||"done"===t}).length;document.getElementById("count-all").textContent=`(${t})`,document.getElementById("count-wait").textContent=`(${o})`,document.getElementById("count-open").textContent=`(${n})`,document.getElementById("count-done").textContent=`(${a})`}async function loadAll(e="all",o=!1){try{const t=o?CURRENT_PAGE+1:1,n=await fetch(`app/controllers/load.php?status=${e}&page=${t}&per_page=50`);if(!n.ok)throw new Error("Chyba naƒç√≠t√°n√≠");const a=await n.json();let i=[];"success"===a.status&&Array.isArray(a.data)?i=a.data:Array.isArray(a)&&(i=a),o?(WGS_DATA_CACHE=[...WGS_DATA_CACHE,...i],CURRENT_PAGE=t):(WGS_DATA_CACHE=i,CURRENT_PAGE=1),HAS_MORE_PAGES=50===i.length,LOADING_MORE=!1;let r=Utils.filterByUserRole(WGS_DATA_CACHE);updateCounts(r),renderOrders(r),updateLoadMoreButton(),lastRefreshTime=Date.now()}catch(e){logger.error("Chyba:",e),WGS_DATA_CACHE=[],document.getElementById("orderGrid").innerHTML=`\n      <div class="empty-state">\n        <div class="empty-state-text">${t("data_load_error")}</div>\n      </div>\n    `}}async function renderOrders(e=null){const o=document.getElementById("orderGrid"),n=document.getElementById("searchResultsInfo");e||(e=Utils.filterByUserRole(WGS_DATA_CACHE)),Array.isArray(e)||(e=[]);let a=e;if("all"!==ACTIVE_FILTER){const t={wait:["ƒåEK√Å","wait"],open:["DOMLUVEN√Å","open"],done:["HOTOVO","done"]};a=e.filter(e=>{const o=e.stav||"wait";return t[ACTIVE_FILTER]?.includes(o)})}const i=a.length;if(SEARCH_QUERY?(a=a.filter(e=>matchesSearch(e,SEARCH_QUERY)),a.length>0?(n.className="search-results-info",n.textContent=t("search_results_found").replace("{count}",a.length).replace("{total}",i).replace("{query}",SEARCH_QUERY)):(n.className="search-results-info no-results",n.textContent=t("no_search_results").replace("{query}",SEARCH_QUERY)),n.classList.remove("hidden")):n.classList.add("hidden"),0===a.length)return void(o.innerHTML=`\n      <div class="empty-state">\n        <div class="empty-state-text">${SEARCH_QUERY?t("no_results_found"):t("no_claims_to_display")}</div>\n      </div>\n    `);let r={};try{const e=await fetch("api/notes_api.php?action=get_unread_counts"),t=await e.json();"success"===t.status&&(r=t.unread_counts||{})}catch(e){logger.warn("Nepoda≈ôilo se naƒç√≠st unread counts:",e)}a.sort((e,t)=>{const o=new Date(e.created_at||e.datum_reklamace||e.timestamp||0);return new Date(t.created_at||t.datum_reklamace||t.timestamp||0)-o}),o.innerHTML=a.map((e,t)=>{const o=Utils.getCustomerName(e),n=Utils.getProduct(e),a=formatDate(e.created_at||e.datum_reklamace),i=getStatus(e.stav),s=Utils.getOrderId(e,t);let d=Utils.getAddress(e);if("‚Äî"!==d){const e=d.split(",").map(e=>e.trim());d=e.slice(0,2).join(", ")}let l="";"open"===i.class&&e.termin&&e.cas_navstevy&&(l=formatAppointment(e.termin,e.cas_navstevy));const c=e.id,p=r[c]||0,m=p>0,u=SEARCH_QUERY?highlightText(o,SEARCH_QUERY):o,g=SEARCH_QUERY?highlightText(d,SEARCH_QUERY):d,h=SEARCH_QUERY?highlightText(n,SEARCH_QUERY):n,f=SEARCH_QUERY?highlightText(s,SEARCH_QUERY):s;return`\n      <div class="order-box ${SEARCH_QUERY&&matchesSearch(e,SEARCH_QUERY)?"search-match":""} ${`status-bg-${i.class}`}" data-action="showDetailById" data-id="${e.id}">\n        <div class="order-header">\n          <div class="order-number">${f}</div>\n          <div style="display: flex; gap: 0.4rem; align-items: center;">\n            <div class="order-notes-badge ${m?"has-unread pulse":""}" data-action="showNotes" data-id="${e.id}" title="${p>0?p+" nep≈ôeƒçten√©":"Pozn√°mky"}">\n              <span class="notes-icon">‚úé</span>${p>0?p:""}\n            </div>\n            <div class="order-status status-${i.class}"></div>\n          </div>\n        </div>\n        <div class="order-body">\n          <div class="order-customer">${u}</div>\n          <div class="order-detail-line">${g}</div>\n          <div class="order-detail-row">\n            <div class="order-detail-left">\n              <div class="order-detail-line">${h}</div>\n              <div class="order-detail-line" style="opacity: 0.6;">${a}</div>\n            </div>\n            <div class="order-detail-right">\n              ${l?`<span class="order-appointment">${l}</span>`:`<span class="order-status-text status-${i.class}">${i.text}</span>`}\n            </div>\n          </div>\n        </div>\n      </div>\n    `}).join("");const s=Object.values(r).reduce((e,t)=>e+t,0),d=document.getElementById("unreadNotesIndicator"),l=document.getElementById("unreadNotesCount");d&&l&&(s>0?(l.textContent=s,d.style.display="block"):d.style.display="none"),window.UNREAD_COUNTS_MAP=r}function filterUnreadNotes(){const e=window.UNREAD_COUNTS_MAP||{},t=WGS_DATA_CACHE.filter(t=>{const o=t.id;return e[o]>0});logger.log(`[Seznam] Filtrov√°n√≠ nep≈ôeƒçten√Ωch pozn√°mek: ${t.length} karet`);const o=document.getElementById("orderGrid");0!==t.length?(renderOrders(t),window.scrollTo({top:0,behavior:"smooth"})):o.innerHTML='\n      <div class="empty-state">\n        <div class="empty-state-text">≈Ω√°dn√© nep≈ôeƒçten√© pozn√°mky</div>\n      </div>\n    '}window.addEventListener("DOMContentLoaded",async()=>{CacheManager.load(),initFilters(),initSearch(),await loadAll(),startAutoRefresh(),document.addEventListener("visibilitychange",()=>{if("visible"===document.visibilityState){Date.now()-lastRefreshTime>3e4&&(logger.log("[AutoRefresh] Tab aktivni - nacitam nova data..."),loadAll(ACTIVE_FILTER))}}),setTimeout(()=>{window.WGSNotifikace&&"function"==typeof window.WGSNotifikace.zobrazitDialogPovoleni&&window.WGSNotifikace.zobrazitDialogPovoleni()},3e3)});const ModalManager={show:e=>{document.getElementById("modalContent").innerHTML=e,window.detailModal&&window.detailModal.open?window.detailModal.open():(window.scrollLock&&window.scrollLock.enable("detail-overlay"),document.body.classList.add("modal-open"),document.getElementById("detailOverlay").classList.add("active")),setTimeout(()=>{const e=document.querySelector("#detailOverlay .modal-content");e&&(e.scrollTop=0)},10)},close:()=>{if(window.detailModal&&window.detailModal.close)window.detailModal.close();else{document.getElementById("detailOverlay").classList.remove("active"),setTimeout(()=>{document.body.classList.remove("modal-open"),window.scrollLock&&window.scrollLock.disable("detail-overlay")},50)}CURRENT_RECORD=null,SELECTED_DATE=null,SELECTED_TIME=null},createHeader:(e,t)=>`\n      <div class="modal-header">\n        <h2 class="modal-title">${e}</h2>\n        ${t?`<p class="modal-subtitle">${t}</p>`:""}\n      </div>\n    `,createActions:e=>`\n      <div class="modal-actions">\n        ${e.join("")}\n      </div>\n    `};function createCustomerHeader(){if(!CURRENT_RECORD)return"";const e=Utils.getCustomerName(CURRENT_RECORD),t=Utils.getAddress(CURRENT_RECORD),o=CURRENT_RECORD.termin?formatDate(CURRENT_RECORD.termin):"‚Äî",n=CURRENT_RECORD.cas_navstevy||"‚Äî",a=getStatus(CURRENT_RECORD.stav);return ModalManager.createHeader(e,`\n    <strong>Adresa:</strong> ${t}<br>\n    <strong>Term√≠n:</strong> ${o} ${"‚Äî"!==n?"v "+n:""}<br>\n    <strong>Stav:</strong> ${a.text}\n  `)}async function showDetail(e){let o;if("string"==typeof e){if(o=WGS_DATA_CACHE.find(t=>t.id==e||t.reklamace_id==e),!o)return void wgsToast.error(t("record_not_found"))}else o=WGS_DATA_CACHE.find(t=>t.id==e.id||t.reklamace_id==e.reklamace_id)||e;CURRENT_RECORD=o,autoAssignTechnician(o.reklamace_id||o.cislo||o.id).catch(e=>logger.warn("Auto-assign technika se nezda≈ôilo:",e.message));Utils.getCustomerName(o),Utils.getAddress(o),o.termin&&formatDate(o.termin),o.cas_navstevy,getStatus(o.stav);let n="";if(Utils.isCompleted(o)){const e=o.updated_at?formatDate(o.updated_at):"‚Äî",t=o.updated_at?new Date(o.updated_at):null;n=`\n      <div class="detail-info-box">\n        <div class="detail-info-box-title">Zak√°zka dokonƒçena</div>\n        <div class="detail-info-box-subtitle">Vy≈ô√≠zeno dne ${e} v ${t?`${t.getHours()}:${String(t.getMinutes()).padStart(2,"0")}`:"‚Äî"}</div>\n      </div>\n\n      <div class="detail-buttons">\n        ${CURRENT_USER&&"prodejce"===CURRENT_USER.role?"":`\n          <button class="detail-btn detail-btn-primary" data-action="reopenOrder" data-id="${o.id}">Znovu otev≈ô√≠t</button>\n          <button class="detail-btn detail-btn-secondary" data-action="showContactMenu" data-id="${o.id}">Kontaktovat</button>\n        `}\n        <button class="detail-btn detail-btn-secondary" data-action="showCustomerDetail" data-id="${o.id}">Detail z√°kazn√≠ka</button>\n        ${o.original_reklamace_id?`\n          <button class="detail-btn detail-btn-secondary" data-action="showHistoryPDF" data-original-id="${o.original_reklamace_id}">Historie z√°kazn√≠ka</button>\n        `:""}\n        ${o.documents&&o.documents.length>0?`\n          <button class="detail-btn detail-btn-primary" data-action="openPDF" data-pdf-path="${o.documents[0].file_path}" data-id="${o.id}">PDF Report</button>\n        `:'\n          <div class="detail-info-box" style="margin: 0; padding: 0.5rem;">\n            <div class="detail-info-box-subtitle">PDF report je≈°tƒõ nebyl vytvo≈ôen</div>\n          </div>\n        '}\n        <button class="detail-btn detail-btn-secondary" data-action="showVideoteka" data-id="${o.id}">Videot√©ka</button>\n      </div>\n    `}else{n=`\n      <div class="detail-buttons">\n        ${CURRENT_USER&&"prodejce"===CURRENT_USER.role?"":`\n          <button class="detail-btn detail-btn-primary" data-action="startVisit" data-id="${o.id}">Zah√°jit n√°v≈°tƒõvu</button>\n          <button class="detail-btn detail-btn-primary" data-action="showCalendar" data-id="${o.id}">Napl√°novat term√≠n</button>\n          <button class="detail-btn detail-btn-secondary" data-action="showContactMenu" data-id="${o.id}">Kontaktovat</button>\n        `}\n        <button class="detail-btn detail-btn-secondary" data-action="showCustomerDetail" data-id="${o.id}">Detail z√°kazn√≠ka</button>\n        ${o.original_reklamace_id?`\n          <button class="detail-btn detail-btn-secondary" data-action="showHistoryPDF" data-original-id="${o.original_reklamace_id}">Historie PDF</button>\n        `:""}\n        <button class="detail-btn detail-btn-secondary" data-action="showVideoteka" data-id="${o.id}">Videot√©ka</button>\n      </div>\n    `}const a=`\n    ${createCustomerHeader()}\n\n    <div class="modal-body">\n      ${n}\n    </div>\n  `;ModalManager.show(a)}function closeDetail(){ModalManager.close()}async function reopenOrder(e){const o=WGS_DATA_CACHE.find(t=>t.id==e);if(!o)return void wgsToast.error(t("record_not_found"));const n=Utils.getCustomerName(o),a=Utils.getProduct(o);if(await wgsConfirm(t("confirm_reopen_order").replace("{customer}",n).replace("{product}",a),t("confirm_yes")||"Ano",t("confirm_no")||"Ne"))try{const t=await getCSRFToken(),o=new FormData;o.append("action","reopen"),o.append("original_id",e),o.append("csrf_token",t);const n=await fetch("/app/controllers/save.php",{method:"POST",body:o}),a=await n.json();if(!n.ok)throw new Error(`HTTP ${n.status}: ${a.message||n.statusText}`);if("success"!==a.status)throw new Error(a.message||"Nepoda≈ôilo se vytvo≈ôit novou zak√°zku");{const e=a.new_id,t=a.new_workflow_id;logger.log(`Nov√° zak√°zka vytvo≈ôena: ${t} (ID: ${e})`),wgsToast.success(`Nov√° zak√°zka ${t} vytvo≈ôena`,5e3),"function"==typeof loadAll&&await loadAll(ACTIVE_FILTER),showDetail(e)}}catch(e){logger.error("Chyba p≈ôi znovuotev≈ôen√≠ zak√°zky:",e),wgsToast.error(t("error_reopening_order")+": "+e.message)}else logger.log("Znovuotev≈ôen√≠ zru≈°eno u≈æivatelem")}async function showHistoryPDF(e){if(e)try{logger.log(`üìö Naƒç√≠t√°m historii PDF z p≈Øvodn√≠ zak√°zky: ${e}`);const t=await fetch(`/api/get_original_documents.php?reklamace_id=${encodeURIComponent(e)}`);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const o=await t.json();if("error"===o.status){if(o.message&&o.message.includes("nebyla nalezena"))return void wgsToast.error("P≈Øvodn√≠ zak√°zka byla smaz√°na.\n\nHistorie PDF nen√≠ k dispozici.");throw new Error(o.message||"Nepoda≈ôilo se naƒç√≠st dokumenty")}if(!o.documents||0===o.documents.length)return void wgsToast.info("Historie PDF nen√≠ k dispozici.\n\nP≈Øvodn√≠ zak√°zka je≈°tƒõ nem√° vytvo≈ôen√Ω PDF dokument.");const n=o.documents[0];logger.log(`Otev√≠r√°m PDF: ${n.file_path}`),zobrazPDFModal(n.file_path,e,"historie")}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ historie PDF:",e),wgsToast.error(`Nepoda≈ôilo se naƒç√≠st historii PDF:\n${e.message}`)}else wgsToast.error("Chyb√≠ ID p≈Øvodn√≠ zak√°zky")}function normalizeCustomerData(e){const t={...e};if(!t.jmeno&&t.zakaznik&&(t.jmeno=t.zakaznik),!t.zakaznik&&t.jmeno&&(t.zakaznik=t.jmeno),!t.adresa&&(t.ulice||t.mesto||t.psc)){const e=[];t.ulice&&e.push(t.ulice),t.mesto&&e.push(t.mesto),t.psc&&e.push(t.psc),t.adresa=e.join(", ")}if(t.adresa&&(!t.ulice||!t.mesto)){const e=t.adresa.split(",").map(e=>e.trim());!t.ulice&&e[0]&&(t.ulice=e[0]),!t.mesto&&e[1]&&(t.mesto=e[1]),!t.psc&&e[2]&&(t.psc=e[2])}return t}window.reopenOrder=reopenOrder;let startVisitInProgress=!1;function startVisit(e){if(startVisitInProgress)return;startVisitInProgress=!0;const o=WGS_DATA_CACHE.find(t=>t.id==e);if(!o)return wgsToast.error(t("record_not_found")),void(startVisitInProgress=!1);if(Utils.isCompleted(o))return wgsToast.warning(t("visit_already_completed")),void(startVisitInProgress=!1);const n=normalizeCustomerData(o);localStorage.setItem("currentCustomer",JSON.stringify(n)),localStorage.setItem("visitStartTime",(new Date).toISOString());const a="photoSections_"+n.id;localStorage.removeItem(a),logger.log("Normalizovan√° data ulo≈æena:",n),window.location.href="photocustomer.php?new=true"}async function saveData(e,o){try{const n=await getCSRFToken(),a=new FormData;Object.keys(e).forEach(t=>{a.append(t,e[t])}),a.append("action","update"),a.append("csrf_token",n);const i=await fetch("/app/controllers/save.php",{method:"POST",body:a}),r=await i.json();if(!i.ok)throw new Error(`HTTP ${i.status}: ${r.message||i.statusText}`);"success"===r.status?(Object.keys(e).forEach(t=>{const o=WGS_DATA_CACHE.find(t=>t.id==e.id);o&&"action"!==t&&(o[t]=e[t]),CURRENT_RECORD&&CURRENT_RECORD.id==e.id&&"action"!==t&&(CURRENT_RECORD[t]=e[t])}),wgsToast.success(o),await loadAll(ACTIVE_FILTER),e.id?(closeDetail(),setTimeout(()=>showDetail(e.id),100)):closeDetail()):wgsToast.error(t("error")+": "+(r.message||t("failed_to_save")))}catch(e){logger.error("Chyba p≈ôi ukl√°d√°n√≠:",e),wgsToast.error(t("save_error")+": "+e.message)}}function showLoading(e=null){e||(e=t("loading"));const o=document.getElementById("loadingOverlay"),n=document.getElementById("loadingText");o&&n&&(n.textContent=e,o.classList.add("show"))}function hideLoading(){const e=document.getElementById("loadingOverlay");e&&e.classList.remove("show")}function showCalendar(e){const t=WGS_DATA_CACHE.find(t=>t.id==e);if(!t)return;CURRENT_RECORD=t,SELECTED_DATE=null,SELECTED_TIME=null;const o=`\n    ${createCustomerHeader()}\n\n    \x3c!-- Vybran√Ω term√≠n - fixn√≠ nad kalend√°≈ôem --\x3e\n    <div id="selectedDateDisplay" style="display: none; background: #f5f5f5; border: 2px solid #666; color: #333; font-size: 0.85rem; padding: 0.5rem 1rem; margin: 0 1rem; border-radius: 4px; font-weight: 600; text-align: center; font-family: inherit;"></div>\n\n    \x3c!-- Varov√°n√≠ o kolizi - skryt√©, zobraz√≠ se p≈ôi v√Ωbƒõru obsazen√©ho ƒçasu --\x3e\n    <div id="collisionWarning" style="display: none; background: #fee; border: 2px solid #c00; color: #900; font-size: 0.85rem; padding: 0.5rem 1rem; margin: 0.5rem 1rem 0; border-radius: 4px; font-weight: 600; text-align: center; font-family: inherit;"></div>\n\n    <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 1rem;">\n      <div class="calendar-container">\n        <div id="calGrid"></div>\n        <div id="distanceInfo"></div>\n        <div id="dayBookings"></div>\n        <div id="timeGrid"></div>\n      </div>\n    </div>\n\n    <div class="detail-buttons">\n      <button class="detail-btn detail-btn-primary" data-action="saveSelectedDate">Ulo≈æit term√≠n</button>\n      <button class="detail-btn detail-btn-secondary" data-action="showDetail">Zpƒõt</button>\n    </div>\n  `;ModalManager.show(o);const n=new Date;CAL_MONTH=n.getMonth(),CAL_YEAR=n.getFullYear(),renderCalendar(CAL_MONTH,CAL_YEAR)}function previousMonth(){const e=new Date,o=e.getMonth(),n=e.getFullYear();let a=CAL_MONTH-1,i=CAL_YEAR;a<0&&(a=11,i--),i<n||i===n&&a<o?wgsToast.warning(t("cannot_show_past_months")):(CAL_MONTH=a,CAL_YEAR=i,renderCalendar(CAL_MONTH,CAL_YEAR))}function nextMonth(e){e&&e.stopPropagation(),CAL_MONTH++,CAL_MONTH>11&&(CAL_MONTH=0,CAL_YEAR++),renderCalendar(CAL_MONTH,CAL_YEAR)}function renderCalendar(e,o){const n=document.getElementById("calGrid");n.innerHTML="";const a=document.createElement("div");a.className="calendar-controls",a.innerHTML=`\n    <button class="calendar-nav-btn" data-action="previousMonth">‚óÄ P≈ôedchoz√≠</button>\n    <span class="calendar-month-title">${["Leden","√önor","B≈ôezen","Duben","Kvƒõten","ƒåerven","ƒåervenec","Srpen","Z√°≈ô√≠","≈ò√≠jen","Listopad","Prosinec"][e]} ${o}</span>\n    <button class="calendar-nav-btn" data-action="nextMonth">Dal≈°√≠ ‚ñ∂</button>\n  `,n.appendChild(a);const i=document.createElement("div");i.className="calendar-weekdays",i.innerHTML=`<div>${t("monday")}</div><div>${t("tuesday")}</div><div>${t("wednesday")}</div><div>${t("thursday")}</div><div>${t("friday")}</div><div>${t("saturday")}</div><div>${t("sunday")}</div>`,n.appendChild(i);const r=document.createElement("div");r.className="calendar-days";const s=new Date(o,e,1),d=new Date(o,e+1,0).getDate(),l=(s.getDay()+6)%7,c=new Set;WGS_DATA_CACHE.forEach(t=>{if(t.termin&&t.id!==CURRENT_RECORD?.id){const n=t.termin.split(".");if(3===n.length){const t=parseInt(n[0]),a=parseInt(n[1]),i=parseInt(n[2]);a===e+1&&i===o&&c.add(t)}}});for(let e=0;e<l;e++){const e=document.createElement("div");e.className="cal-day empty",r.appendChild(e)}const p=new Date;p.setHours(0,0,0,0);for(let n=1;n<=d;n++){const a=document.createElement("div");a.className="cal-day";const i=new Date(o,e,n);i.setHours(0,0,0,0);const s=i<p;s?(a.classList.add("disabled"),a.title="Nelze vybrat minul√© datum",a.style.opacity="0.3",a.style.cursor="not-allowed",a.style.backgroundColor="#f0f0f0"):c.has(n)&&(a.classList.add("occupied"),a.title="Tento den m√° ji≈æ nƒõjak√© term√≠ny"),a.textContent=n,a.onclick=()=>{if(s)return void wgsToast.warning(t("cannot_select_past_date"));SELECTED_DATE=`${n}.${e+1}.${o}`,document.querySelectorAll(".cal-day").forEach(e=>e.classList.remove("selected")),a.classList.add("selected");let i=`Vybran√Ω den: ${SELECTED_DATE}`;document.getElementById("selectedDateDisplay").textContent=i,renderTimeGrid()},r.appendChild(a)}n.appendChild(r)}async function getDistance(e,t){const o=`${e}|${t}`;if(DISTANCE_CACHE[o])return DISTANCE_CACHE[o];try{const n=new AbortController,a=setTimeout(()=>n.abort(),5e3),i=await fetchCsrfToken(),r=await fetch("/app/controllers/get_distance.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({origin:e,destination:t,csrf_token:i}),signal:n.signal});if(clearTimeout(a),r.ok){const e=await r.json();if(("success"===e.status||!0===e.success)&&e.distance){const t={km:(e.distance.value/1e3).toFixed(1),text:e.distance.text,duration:e.duration?e.duration.text:null};return DISTANCE_CACHE[o]=t,CacheManager.save(),t}}}catch(e){"AbortError"===e.name?logger.log("Request timeout"):logger.error("Chyba p≈ôi v√Ωpoƒçtu vzd√°lenosti:",e)}return null}async function getDistancesBatch(e){const t=e.map(e=>getDistance(e.from,e.to));return await Promise.all(t)}async function showDayBookingsWithDistances(e){const t=document.getElementById("distanceInfo"),o=document.getElementById("dayBookings");t&&(t.innerHTML=""),o&&(o.innerHTML="")}function showBookingDetail(e){let o;if("string"==typeof e||"number"==typeof e){if(o=WGS_DATA_CACHE.find(t=>t.id==e||t.reklamace_id==e),!o)return void wgsToast.error(t("record_not_found"))}else o=e;const n=Utils.getCustomerName(o),a=Utils.getAddress(o),i=Utils.getProduct(o),r=o.popis_problemu||"‚Äî",s=`\n    ${ModalManager.createHeader("Detail obsazen√©ho term√≠nu",'<p style="color: var(--c-error); font-weight: 600;">Tento term√≠n je ji≈æ obsazen</p>')}\n    \n    <div class="modal-body">\n      <div style="padding: 1.5rem; background: rgba(139, 0, 0, 0.05); border: 2px solid var(--c-error); margin-bottom: 1.5rem;">\n        <div class="info-grid" style="font-family: 'Poppins', sans-serif;">\n          <div class="info-label">Z√°kazn√≠k:</div>\n          <div class="info-value"><strong>${n}</strong></div>\n          \n          <div class="info-label">Term√≠n:</div>\n          <div class="info-value"><strong>${formatDate(o.termin||"")} v ${o.cas_navstevy||"‚Äî"}</strong></div>\n          \n          <div class="info-label">Adresa:</div>\n          <div class="info-value">${a}</div>\n          \n          <div class="info-label">Produkt:</div>\n          <div class="info-value">${i}</div>\n          \n          <div class="info-label">Popis:</div>\n          <div class="info-value" style="line-height: 1.6;">${r}</div>\n        </div>\n      </div>\n    </div>\n\n    <div class="detail-buttons">\n      <button class="detail-btn detail-btn-secondary" data-action="showCalendarBack">Zpƒõt na kalend√°≈ô</button>\n    </div>\n  `;ModalManager.show(s)}function renderTimeGrid(){const e=document.getElementById("timeGrid");e.innerHTML="";const t={};WGS_DATA_CACHE.forEach(e=>{if(e.termin===SELECTED_DATE&&e.cas_navstevy&&e.id!==CURRENT_RECORD?.id){const o=Utils.getCustomerName(e);t[e.cas_navstevy]={zakaznik:o,model:Utils.getProduct(e)}}});for(let o=8;o<=19;o++)for(const n of[0,30]){const a=`${String(o).padStart(2,"0")}:${0===n?"00":"30"}`,i=document.createElement("div");i.className="time-slot",t[a]&&(i.classList.add("occupied"),i.title=`${t[a].zakaznik} ‚Äî ${t[a].model}`),i.textContent=a,i.onclick=()=>{SELECTED_TIME=a,document.querySelectorAll(".time-slot").forEach(e=>e.classList.remove("selected")),i.classList.add("selected");const e=document.getElementById("selectedDateDisplay");e.textContent=`Vybran√Ω term√≠n: ${SELECTED_DATE} ‚Äî ${SELECTED_TIME}`,e.style.display="block";const o=document.getElementById("collisionWarning");t[a]&&o?(o.textContent=`KOLIZE: ${t[a].zakaznik} ‚Äî ${t[a].model}`,o.style.display="block"):o&&(o.style.display="none")},e.appendChild(i)}}async function saveSelectedDate(){if(!SELECTED_DATE||!SELECTED_TIME)return void wgsToast.warning(t("select_date_and_time"));if(!CURRENT_RECORD)return void wgsToast.warning(t("no_record_to_save"));Array.isArray(WGS_DATA_CACHE)||(WGS_DATA_CACHE=[]);const e=WGS_DATA_CACHE.find(e=>e.termin===SELECTED_DATE&&e.cas_navstevy===SELECTED_TIME&&e.id!==CURRENT_RECORD.id);if(e){const o=Utils.getCustomerName(e);if(!await wgsConfirm(t("confirm_appointment_collision").replace("{date}",SELECTED_DATE).replace("{time}",SELECTED_TIME).replace("{customer}",o),t("confirm_yes")||"Ano",t("confirm_no")||"Ne"))return}showLoading(t("saving_appointment"));const o=performance.now();logger.log("‚è±Ô∏è START ukl√°d√°n√≠ term√≠nu...");try{const e=performance.now(),n=await getCSRFToken(),a=performance.now();logger.log(`‚è±Ô∏è CSRF token z√≠sk√°n za ${(a-e).toFixed(0)}ms`);const i=new FormData;i.append("action","update"),i.append("id",CURRENT_RECORD.id),i.append("termin",SELECTED_DATE),i.append("cas_navstevy",SELECTED_TIME),i.append("stav","DOMLUVEN√Å"),i.append("csrf_token",n),showLoading(t("saving_appointment_to_db"));const r=performance.now();logger.log("‚è±Ô∏è Odes√≠l√°m POST request na save.php...");const s=await fetch("/app/controllers/save.php",{method:"POST",body:i}),d=performance.now();logger.log(`‚è±Ô∏è POST request dokonƒçen za ${(d-r).toFixed(0)}ms`);const l=await s.json();if(!s.ok)throw new Error(`HTTP ${s.status}: ${l.message||s.statusText}`);if("success"===l.status){const e=performance.now();logger.log(`‚è±Ô∏è SUCCESS block started: ${(e-o).toFixed(0)}ms od zaƒç√°tku`);const n=performance.now();CURRENT_RECORD.termin=SELECTED_DATE,CURRENT_RECORD.cas_navstevy=SELECTED_TIME,CURRENT_RECORD.stav="DOMLUVEN√Å";const a=performance.now();logger.log(`‚è±Ô∏è CURRENT_RECORD update: ${(a-n).toFixed(0)}ms`);const i=performance.now(),r=WGS_DATA_CACHE.find(e=>e.id===CURRENT_RECORD.id);r&&(r.termin=SELECTED_DATE,r.cas_navstevy=SELECTED_TIME,r.stav="DOMLUVEN√Å");const s=performance.now();logger.log(`‚è±Ô∏è Cache update: ${(s-i).toFixed(0)}ms`);const d=performance.now();hideLoading();const l=performance.now();logger.log(`‚è±Ô∏è hideLoading(): ${(l-d).toFixed(0)}ms`);const c=performance.now();logger.log(`‚è±Ô∏è TƒöSNƒö P≈òED ALERT: ${(c-o).toFixed(0)}ms od zaƒç√°tku`),wgsToast.success(t("appointment_saved_success").replace("{date}",SELECTED_DATE).replace("{time}",SELECTED_TIME));const p=performance.now();logger.log(`‚è±Ô∏è alert() dokonƒçen: ${(p-c).toFixed(0)}ms`);const m=performance.now();sendAppointmentConfirmation(CURRENT_RECORD,SELECTED_DATE,SELECTED_TIME).catch(e=>logger.warn("‚ö† Email se nepoda≈ôilo odeslat:",e.message));const u=performance.now();logger.log(`‚è±Ô∏è sendAppointmentConfirmation() launch: ${(u-m).toFixed(0)}ms`);const g=performance.now();logger.log("‚è±Ô∏è Aktualizuji detail...");const h=CURRENT_RECORD.id,f=performance.now();closeDetail();const v=performance.now();logger.log(`‚è±Ô∏è closeDetail(): ${(v-f).toFixed(0)}ms`);const y=performance.now();setTimeout(()=>showDetail(h),100);const b=performance.now();logger.log(`‚è±Ô∏è setTimeout() scheduled: ${(b-y).toFixed(0)}ms`);const w=performance.now();logger.log(`‚è±Ô∏è Detail aktualizov√°n za ${(w-g).toFixed(0)}ms`);const E=performance.now();logger.log(`‚è±Ô∏è CELKOV√ù ƒåAS: ${(E-o).toFixed(0)}ms (${((E-o)/1e3).toFixed(1)}s)`)}else hideLoading(),wgsToast.error(t("error")+": "+(l.message||t("failed_to_save")))}catch(e){hideLoading(),logger.error("Chyba p≈ôi ukl√°d√°n√≠:",e),wgsToast.error(t("save_error")+": "+e.message);const n=performance.now();logger.log(`‚è±Ô∏è ƒåas do chyby: ${(n-o).toFixed(0)}ms`)}}function showContactMenu(e){const t=CURRENT_RECORD.telefon||"",o=Utils.getAddress(CURRENT_RECORD),n=`\n    ${createCustomerHeader()}\n\n    <div class="modal-body">\n      <div class="detail-buttons">\n        ${t?`<a href="tel:${t}" class="detail-btn detail-btn-primary" style="text-decoration: none;">Zavolat</a>`:""}\n        <button class="detail-btn detail-btn-primary" data-action="openCalendarFromDetail" data-id="${e}">Term√≠n n√°v≈°tƒõvy</button>\n        ${t?`<button class="detail-btn detail-btn-secondary" data-action="sendContactAttemptEmail" data-id="${e}" data-phone="${t}">Odeslat SMS</button>`:""}\n        ${o&&"‚Äî"!==o?`<a href="https://waze.com/ul?q=${encodeURIComponent(o)}&navigate=yes" class="detail-btn detail-btn-secondary" style="text-decoration: none;" target="_blank">Navigovat (Waze)</a>`:""}\n        <button class="detail-btn detail-btn-secondary" data-action="showDetail">Zpƒõt</button>\n      </div>\n    </div>\n  `;ModalManager.show(n)}function toggleMap(){const e=document.getElementById("mapContent"),t=document.getElementById("mapToggleIcon");e.classList.contains("active")?(e.classList.remove("active"),t.classList.remove("active")):(e.classList.add("active"),t.classList.add("active"),e.dataset.loaded||(e.dataset.loaded="true",loadMapAndRoute()))}async function loadMapAndRoute(){const e=document.getElementById("mapContainer");if(!CURRENT_RECORD)return;let o=Utils.getAddress(CURRENT_RECORD);if(o&&"‚Äî"!==o){o=Utils.addCountryToAddress(o);try{const t=encodeURIComponent(WGS_ADDRESS),n=encodeURIComponent(o);e.innerHTML=`\n      <div style="background: var(--c-bg); padding: 1rem; text-align: center; border: 1px solid var(--c-border);">\n        <div style="font-size: 0.8rem; color: var(--c-grey); margin-bottom: 0.8rem; line-height: 1.4;">\n          <strong>Z:</strong> WGS<br>\n          <strong>Do:</strong> ${o}<br>\n          <strong>Vzd√°lenost:</strong> <span id="mapDistance">Naƒç√≠t√°m...</span><br>\n          <strong>ƒåas:</strong> <span id="mapDuration">‚Äî</span>\n        </div>\n        <div style="display: flex; gap: 0.5rem; justify-content: center;">\n          <a href="https://www.google.com/maps/dir/?api=1&origin=${t}&destination=${n}&travelmode=driving"\n             class="btn" target="_blank" style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.75rem;">\n            Google Maps\n          </a>\n          <a href="https://waze.com/ul?q=${n}&navigate=yes"\n             class="btn" target="_blank" style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.75rem;">\n            Waze\n          </a>\n        </div>\n      </div>\n    `,document.getElementById("mapDistance").textContent="‚Äî",document.getElementById("mapDuration").textContent="‚Äî"}catch(t){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ mapy:",t),e.innerHTML=`\n      <div class="map-error">\n        Nepoda≈ôilo se naƒç√≠st mapu<br>\n        <small>${t.message}</small>\n      </div>\n    `}}else e.innerHTML=`<div class="map-error">${t("customer_address_not_available")}</div>`}async function showCustomerDetail(e){const t=Utils.getCustomerName(CURRENT_RECORD),o=CURRENT_RECORD.telefon||"",n=CURRENT_RECORD.email||"",a=Utils.getAddress(CURRENT_RECORD),i=Utils.getProduct(CURRENT_RECORD),r=CURRENT_RECORD.popis_problemu||"",s=CURRENT_RECORD.cislo||"",d=CURRENT_RECORD.reklamace_id||"",l=CURRENT_RECORD.created_by_name||CURRENT_RECORD.prodejce||"",c=CURRENT_RECORD.datum_prodeje||"",p=CURRENT_RECORD.datum_reklamace||"",m=CURRENT_RECORD.provedeni||"",u=CURRENT_RECORD.barva||"",g=CURRENT_RECORD.doplnujici_info||"",h=CURRENT_RECORD.fakturace_firma||"CZ",f=await loadPhotosFromDB(d);let v=f.length>0?f:[];if(0===v.length){const t="photoSections_"+e,o=localStorage.getItem(t);if(o)try{const e=JSON.parse(o);Object.values(e).forEach(e=>{e.photos&&Array.isArray(e.photos)&&(v=v.concat(e.photos))})}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ fotek:",e)}}const y=`\n    ${createCustomerHeader()}\n\n    <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 1rem;">\n\n      \x3c!-- KOMPAKTN√ç INFO BLOK --\x3e\n      <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 4px; padding: 0.75rem; margin-bottom: 1rem;">\n        <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; font-size: 0.9rem;">\n          <span style="color: #666; font-weight: 600;">ƒå√≠slo objedn√°vky:</span>\n          <input type="text" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: white;" value="${Utils.escapeHtml(d)}" readonly>\n\n          <span style="color: #666; font-weight: 600;">Zadavatel:</span>\n          <input type="text" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #f8f9fa;" value="${Utils.escapeHtml(l)}" readonly placeholder="Prodejce/U≈æivatel">\n\n          <span style="color: #666; font-weight: 600;">ƒå√≠slo reklamace:</span>\n          <input type="text" id="edit_cislo" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${Utils.escapeHtml(s)}">\n\n          <span style="color: #666; font-weight: 600;">Fakturace:</span>\n          <span style="color: #1a1a1a; font-weight: 600; padding: 0.25rem 0;">${"SK"===h.toUpperCase()?"Slovensko (SK)":"ƒåesk√° republika (CZ)"}</span>\n\n          <span style="color: #666; font-weight: 600;">Datum prodeje:</span>\n          <input type="text" id="edit_datum_prodeje" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${Utils.escapeHtml(c)}" placeholder="DD.MM.RRRR">\n\n          <span style="color: #666; font-weight: 600;">Datum reklamace:</span>\n          <input type="text" id="edit_datum_reklamace" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${Utils.escapeHtml(p)}" placeholder="DD.MM.RRRR">\n\n          <span style="color: #666; font-weight: 600;">Jm√©no:</span>\n          <input type="text" id="edit_jmeno" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${t}">\n\n          <span style="color: #666; font-weight: 600;">Telefon:</span>\n          <input type="tel" id="edit_telefon" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${o}">\n\n          <span style="color: #666; font-weight: 600;">Email:</span>\n          <input type="email" id="edit_email" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${n}">\n\n          <span style="color: #666; font-weight: 600;">Adresa:</span>\n          <input type="text" id="edit_adresa" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${a}">\n\n          <span style="color: #666; font-weight: 600;">Model:</span>\n          <input type="text" id="edit_model" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${i}">\n\n          <span style="color: #666; font-weight: 600;">Proveden√≠:</span>\n          <input type="text" id="edit_provedeni" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${Utils.escapeHtml(m)}" placeholder="L√°tka / K≈Ø≈æe">\n\n          <span style="color: #666; font-weight: 600;">Barva:</span>\n          <input type="text" id="edit_barva" style="border: 1px solid #ddd; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem;" value="${Utils.escapeHtml(u)}">\n        </div>\n      </div>\n\n      \x3c!-- DOPL≈áUJ√çC√ç INFORMACE OD PRODEJCE --\x3e\n      <div style="margin-bottom: 1rem;">\n        <label style="display: block; color: #666; font-weight: 600; font-size: 0.8rem; margin-bottom: 0.25rem;">Dopl≈àuj√≠c√≠ informace od prodejce:</label>\n        <textarea id="edit_doplnujici_info"\n                  style="width: 100%; border: 1px solid #ddd; padding: 0.5rem; border-radius: 3px; font-size: 0.9rem; min-height: 60px; background: white; resize: vertical; font-family: inherit;"\n                  placeholder="Zadejte dopl≈àuj√≠c√≠ informace od prodejce">${Utils.escapeHtml(g)}</textarea>\n      </div>\n\n      \x3c!-- POPIS PROBL√âMU OD Z√ÅKAZN√çKA --\x3e\n      <div style="margin-bottom: 2rem;">\n        <label style="display: block; color: #666; font-weight: 600; font-size: 0.8rem; margin-bottom: 0.25rem;">Popis probl√©mu od z√°kazn√≠ka:</label>\n        <textarea id="edit_popis_problemu"\n                  style="width: 100%; border: 1px solid #ddd; padding: 0.5rem; border-radius: 3px; font-size: 0.9rem; min-height: 80px; background: white; resize: vertical; font-family: inherit;"\n                  placeholder="Zadejte popis probl√©mu od z√°kazn√≠ka">${Utils.escapeHtml(r)}</textarea>\n      </div>\n\n      \x3c!-- FOTOGRAFIE --\x3e\n      ${v.length>0?`\n        <div style="margin-bottom: 1rem;">\n          <label style="display: block; color: #666; font-weight: 600; font-size: 0.8rem; margin-bottom: 0.5rem;">Fotografie (${v.length}):</label>\n          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem;">\n            ${v.map((e,t)=>{const o="object"==typeof e?e.photo_path:e,n="object"==typeof e?e.id:null,a=o.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/'/g,"\\'");return`\n                <div class="foto-wrapper" style="position: relative;">\n                  <img src='${o}'\n                       style='width: 100%; aspect-ratio: 1; object-fit: cover; border: 1px solid #ddd; cursor: pointer; border-radius: 3px;'\n                       alt='Fotka ${t+1}'\n                       data-action="showPhotoFullscreen"\n                       data-url="${a}">\n                  ${n?`\n                    <button class="foto-delete-btn"\n                            data-action="smazatFotku"\n                            data-photo-id="${n}"\n                            data-url="${a}"\n                            title="Smazat fotku">\n                      √ó\n                    </button>\n                  `:""}\n                </div>\n              `}).join("")}\n          </div>\n        </div>\n      `:""}\n\n      \x3c!-- PDF DOKUMENTY --\x3e\n      ${(()=>{const e=CURRENT_RECORD.documents||[],t=e.find(e=>"complete_report"===e.document_type),o=e.length>0?e[0]:null,n=t||o;return n?`\n          <div style="margin-bottom: 1rem;">\n            <label style="display: block; color: #666; font-weight: 600; font-size: 0.8rem; margin-bottom: 0.5rem;">PDF Report:</label>\n            <button class="btn customer-detail-btn"\n                    data-action="openPDF"\n                    data-pdf-path="${n.file_path.replace(/\\/g,"\\\\").replace(/'/g,"\\'")}">\n              Otev≈ô√≠t PDF Report\n            </button>\n          </div>\n        `:'\n            <div style="padding: 0.75rem; text-align: center; background: #f8f9fa; border: 1px dashed #dee2e6; border-radius: 4px; margin-bottom: 1rem;">\n              <p style="margin: 0; color: #6c757d; font-size: 0.8rem;">PDF report je≈°tƒõ nebyl vytvo≈ôen</p>\n            </div>\n          '})()}\n\n      ${CURRENT_USER.is_admin?`\n        <div style="border-top: 1px solid #e0e0e0; padding-top: 1rem; margin-top: 1rem;">\n          <button class="btn customer-detail-btn danger" data-action="deleteReklamace" data-id="${e}">\n            Smazat reklamaci\n          </button>\n          <p style="font-size: 0.7rem; color: #999; margin-top: 0.25rem; text-align: center;">Sma≈æe v≈°e vƒçetnƒõ fotek a PDF</p>\n        </div>\n      `:""}\n\n    </div>\n\n    <div class="detail-buttons">\n      <button class="detail-btn detail-btn-primary" data-action="saveAllCustomerData" data-id="${e}">Ulo≈æit zmƒõny</button>\n      <button class="detail-btn detail-btn-secondary" data-action="showDetail" data-id="${e}">Zpƒõt</button>\n    </div>\n  `;ModalManager.show(y)}function zobrazPDFModal(e,t,o="report"){const n="historie"===o?"Historie PDF":"PDF Report",a=document.createElement("div");a.id="pdfModalOverlay",a.style.cssText="\n    position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n    background: rgba(0,0,0,0.95); z-index: 10003;\n    display: flex; flex-direction: column;\n  ";const i=document.createElement("div");i.style.cssText="\n    flex-shrink: 0; padding: 12px 16px;\n    background: #222; color: white;\n    display: flex; justify-content: space-between; align-items: center;\n    border-bottom: 1px solid #444;\n  ",i.innerHTML=`\n    <div>\n      <div style="font-weight: 600; font-size: 1rem;">${n}</div>\n      <div style="font-size: 0.75rem; opacity: 0.7;">ID: ${t||"-"}</div>\n    </div>\n    <button id="pdfCloseBtn" style="\n      background: #555; color: white; border: none;\n      padding: 10px 20px; border-radius: 6px;\n      font-weight: 600; font-size: 0.9rem; cursor: pointer;\n    ">Zav≈ô√≠t</button>\n  `;const r=document.createElement("div");r.style.cssText="flex: 1; overflow: hidden; display: flex; align-items: center; justify-content: center; padding: 16px;";const s=document.createElement("iframe");s.src=e,s.style.cssText="width: 100%; height: 100%; max-width: 900px; border: none; background: white; border-radius: 8px;",r.appendChild(s);const d=document.createElement("div");d.style.cssText="\n    flex-shrink: 0; padding: 12px 16px;\n    background: #222; border-top: 1px solid #444;\n    display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;\n  ";const l=document.createElement("button");l.textContent="St√°hnout",l.style.cssText="padding: 12px 24px; font-size: 0.9rem; font-weight: 600; background: #444; color: white; border: none; border-radius: 6px; cursor: pointer;",l.onclick=()=>{const o=document.createElement("a");o.href=e,o.download=`PDF_Report_${t||"dokument"}.pdf`,o.click()};const c=document.createElement("button");c.textContent="Sd√≠let",c.style.cssText="padding: 12px 24px; font-size: 0.9rem; font-weight: 600; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer;",c.onclick=async()=>{if(navigator.share)try{c.textContent="Naƒç√≠t√°m...";const o=await fetch(e),a=await o.blob(),i=new File([a],`PDF_Report_${t||"dokument"}.pdf`,{type:"application/pdf"});await navigator.share({files:[i],title:n})}catch(e){"AbortError"!==e.name&&wgsToast.error("Chyba: "+e.message)}finally{c.textContent="Sd√≠let"}else wgsToast.info("Sd√≠len√≠ nen√≠ podporov√°no. Pou≈æijte tlaƒç√≠tko St√°hnout.")};const p=document.createElement("button");p.textContent="Zav≈ô√≠t",p.style.cssText="padding: 12px 24px; font-size: 0.9rem; font-weight: 600; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;",p.onclick=()=>a.remove(),d.appendChild(l),d.appendChild(c),d.appendChild(p),a.appendChild(i),a.appendChild(r),a.appendChild(d),i.querySelector("#pdfCloseBtn").onclick=()=>a.remove();const m=e=>{"Escape"===e.key&&(a.remove(),document.removeEventListener("keydown",m))};document.addEventListener("keydown",m),document.body.appendChild(a)}function showPhotoFullscreen(e){const t=document.createElement("div");t.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer;",t.onclick=()=>t.remove();const o=document.createElement("img");o.alt="Zvƒõt≈°en√° fotka reklamace",o.src=e,o.style.cssText="max-width: 95%; max-height: 95%; object-fit: contain;",t.appendChild(o),document.body.appendChild(t)}function showTextOverlay(e){if(!CURRENT_RECORD)return;const o="popis_problemu"===e?"Popis probl√©mu":"Dopl≈àuj√≠c√≠ informace",n=CURRENT_RECORD[e]||"",a=document.createElement("div");a.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 2rem;";const i=document.createElement("div");i.style.cssText="background: white; padding: 1.5rem; border-radius: 6px; max-width: 700px; width: 100%; max-height: 85vh; display: flex; flex-direction: column;",i.onclick=e=>e.stopPropagation();const r=document.createElement("div");r.style.cssText="font-weight: 600; font-size: 1rem; color: #1a1a1a; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #dee2e6;",r.textContent=o;const s=document.createElement("div");s.style.cssText="flex: 1; overflow-y: auto; margin-bottom: 1rem;";const d=document.createElement("textarea");d.style.cssText="width: 100%; min-height: 300px; border: 1px solid #ddd; padding: 0.75rem; border-radius: 4px; font-size: 0.9rem; line-height: 1.6; font-family: inherit; resize: vertical;",d.value=n,d.placeholder="Zadejte text...",s.appendChild(d);const l=document.createElement("div");l.style.cssText="display: flex; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid #dee2e6;";const c=document.createElement("button");c.style.cssText="flex: 1; padding: 0.5rem 1rem; background: #1a1a1a; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; font-weight: 600;",c.textContent=t("save_changes"),c.onclick=async()=>{const o=d.value;try{const n=await getCSRFToken(),i=new FormData;i.append("action","update"),i.append("id",CURRENT_RECORD.id),i.append(e,o),i.append("csrf_token",n);const r=await fetch("/app/controllers/save.php",{method:"POST",body:i}),s=await r.json();if("success"===s.status){CURRENT_RECORD[e]=o;const n=WGS_DATA_CACHE.find(e=>e.id==CURRENT_RECORD.id);n&&(n[e]=o),a.remove(),showCustomerDetail(CURRENT_RECORD.id),wgsToast.success(t("text_saved_successfully"))}else wgsToast.error(t("save_error")+": "+s.message)}catch(e){wgsToast.error(t("save_error")+": "+e.message)}};const p=document.createElement("button");p.style.cssText="flex: 1; padding: 0.5rem 1rem; background: #666; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer;",p.textContent=t("cancel"),p.onclick=()=>a.remove(),l.appendChild(c),l.appendChild(p),i.appendChild(r),i.appendChild(s),i.appendChild(l),a.appendChild(i),document.body.appendChild(a),a.onclick=e=>{e.target===a&&a.remove()},setTimeout(()=>d.focus(),100)}async function saveAllCustomerData(e){const t={action:"update",id:e,cislo:document.getElementById("edit_cislo").value,datum_prodeje:document.getElementById("edit_datum_prodeje").value,datum_reklamace:document.getElementById("edit_datum_reklamace").value,jmeno:document.getElementById("edit_jmeno").value,telefon:document.getElementById("edit_telefon").value,email:document.getElementById("edit_email").value,adresa:document.getElementById("edit_adresa").value,model:document.getElementById("edit_model").value,provedeni:document.getElementById("edit_provedeni").value,barva:document.getElementById("edit_barva").value,doplnujici_info:document.getElementById("edit_doplnujici_info").value,popis_problemu:document.getElementById("edit_popis_problemu").value};await saveData(t,"V≈°echny √∫daje byly aktualizov√°ny")}async function sendAppointmentConfirmation(e,t,o){const n=Utils.getCustomerName(e),a=e.telefon||"",i=e.email||"",r=Utils.getOrderId(e),s=Utils.getAddress(e)||"",d=e.nazev_produktu||e.produkt||e.popis_produktu||"",l=e.technik_jmeno||e.assigned_technician||"",c=e.technik_email||"",p=e.technik_telefon||"",m=e.created_by_email||"admin@wgs-service.cz";try{const e=await getCSRFToken(),u=await fetch("app/notification_sender.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({notification_id:"appointment_confirmed",csrf_token:e,data:{customer_name:n,customer_email:i,customer_phone:a,seller_email:m,date:t,time:o,order_id:r,address:s,product:d,technician_name:l,technician_email:c,technician_phone:p}})}),g=await u.json();!0===g.success?(logger.log("Potvrzen√≠ term√≠nu odesl√°no z√°kazn√≠kovi"),g.sent&&logger.log("  Email odesl√°n na:",g.to||i),g.sms_sent&&logger.log("  SMS odesl√°na na:",a)):logger.error("‚ö† Chyba p≈ôi odes√≠l√°n√≠ potvrzen√≠:",g.error||g.message)}catch(e){logger.error("Chyba p≈ôi odes√≠l√°n√≠ potvrzen√≠:",e)}}async function autoAssignTechnician(e){try{const t=await getCSRFToken(),o=await fetch("api/auto_assign_technician.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:e,csrf_token:t})}),n=await o.json();n.success&&n.assigned?(logger.log(`‚úì Technik ${n.technician_name} (${n.technician_email}) byl automaticky p≈ôi≈ôazen`),await loadData(ACTIVE_FILTER)):n.success&&!n.assigned?logger.log("Auto-assign: "+(n.message||"≈Ω√°dn√© p≈ôi≈ôazen√≠")):logger.warn("Auto-assign selhalo:",n.error)}catch(e){logger.error("Chyba p≈ôi auto-assign technika:",e)}}async function getNotes(e){try{const t=WGS_DATA_CACHE.find(t=>t.id==e||t.reklamace_id==e);if(!t)return[];const o=t.reklamace_id||t.id,n=await fetch(`api/notes_api.php?action=get&reklamace_id=${encodeURIComponent(o)}`),a=await n.json();return("success"===a.status||!0===a.success)&&a.notes||[]}catch(e){return logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ pozn√°mek:",e),[]}}async function addNote(e,t,o=null){try{const n=WGS_DATA_CACHE.find(t=>t.id==e||t.reklamace_id==e);if(!n)throw new Error("Reklamace nenalezena");const a=await getCSRFToken(),i=n.reklamace_id||n.id,r=new FormData;if(r.append("action","add"),r.append("reklamace_id",i),r.append("text",t.trim()),r.append("csrf_token",a),logger.log("[Audio] audioBlob status:",o?"existuje":"null",o?o.size+" bytes":""),o){let e="webm";o.type.includes("mp4")?e="m4a":o.type.includes("ogg")?e="ogg":o.type.includes("mp3")||o.type.includes("mpeg")?e="mp3":o.type.includes("wav")&&(e="wav"),r.append("audio",o,`nahravka.${e}`),logger.log("[Audio] Odesilam nahravku:",Math.round(o.size/1024),"KB, type:",o.type)}logger.log("[Notes] Odesilam poznamku na API...");const s=await fetch("api/notes_api.php",{method:"POST",body:r});logger.log("[Notes] API odpoved status:",s.status);const d=await s.json();if(logger.log("[Notes] API odpoved data:",JSON.stringify(d)),"success"===d.status||!0===d.success)return{success:!0,note_id:d.note_id};throw new Error(d.error||d.message||"Chyba pri pridavani poznamky")}catch(e){throw logger.error("Chyba pri pridavani poznamky:",e),e}}async function deleteNote(e,t){if(console.log("[deleteNote] Zacinam mazat poznamku ID:",e),await wgsConfirm("Opravdu chcete smazat tuto pozn√°mku?","Smazat","Zru≈°it")){console.log("[deleteNote] Uzivatel potvrdil, pripravuji request...");try{const t=await getCSRFToken();console.log("[deleteNote] CSRF token:",t?"OK ("+t.substring(0,10)+"...)":"CHYBI!");const o=new URLSearchParams;o.append("action","delete"),o.append("note_id",e),o.append("csrf_token",t),console.log("[deleteNote] Params pripraveny:",o.toString().substring(0,50)+"..."),console.log("[deleteNote] Odesilam POST na /api/notes_api.php...");const n=await fetch("/api/notes_api.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o});console.log("[deleteNote] Response status:",n.status,n.statusText);const a=await n.json();if("success"===a.status){const t=document.querySelector(`[data-note-id="${e}"]`);t&&t.remove();const o=document.querySelector(".notes-container");o&&0===o.querySelectorAll(".note-item").length&&(o.innerHTML='<div class="empty-notes">Zatim zadne poznamky</div>'),await loadAll(ACTIVE_FILTER)}else wgsToast.error("Chyba: "+(a.error||a.message||"Neznama chyba"))}catch(e){logger.error("Chyba pri mazani poznamky:",e),wgsToast.error("Chyba pri mazani poznamky: "+e.message)}}else console.log("[deleteNote] Uzivatel zrusil")}async function markNotesAsRead(e){try{const t=WGS_DATA_CACHE.find(t=>t.id==e||t.reklamace_id==e);if(!t)return;const o=await getCSRFToken(),n=t.reklamace_id||t.id,a=new FormData;a.append("action","mark_read"),a.append("reklamace_id",n),a.append("csrf_token",o),await fetch("api/notes_api.php",{method:"POST",body:a})}catch(e){logger.error("Chyba p≈ôi oznaƒçov√°n√≠ pozn√°mek:",e)}}async function showNotes(e){let o;if("string"==typeof e||"number"==typeof e){if(o=WGS_DATA_CACHE.find(t=>t.id==e||t.reklamace_id==e),!o)return void wgsToast.error(t("record_not_found"))}else o=e;CURRENT_RECORD=o;const n=`\n    ${createCustomerHeader()}\n    <div class="modal-body" style="text-align: center; padding: 3rem;">\n      <div class="loading">Naƒç√≠t√°n√≠ pozn√°mek...</div>\n    </div>\n  `;ModalManager.show(n);const a=await getNotes(o.id);a.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp));const i=`\n    ${createCustomerHeader()}\n\n    <div class="modal-body">\n      <div class="notes-container">\n        ${a.length>0?a.map(e=>{const t=CURRENT_USER&&(CURRENT_USER.is_admin||e.author===CURRENT_USER.email),n=e.has_audio&&e.audio_url,a="[Hlasov√° pozn√°mka]"===e.text||"[Hlasova poznamka]"===e.text;return`\n              <div class="note-item ${e.read?"":"unread"} ${n?"has-audio":""}" data-note-id="${e.id}">\n                <div class="note-header">\n                  <span class="note-author">${e.author_name||e.author}</span>\n                  <span class="note-time">${formatDateTime(e.timestamp)}</span>\n                  ${t?`<button class="note-delete-btn" data-note-id="${e.id}" data-order-id="${o.id}" onclick="event.stopPropagation(); potvrditSmazaniPoznamky(this);" title="Smazat poznamku">x</button>`:""}\n                </div>\n                ${a?"":`<div class="note-text">${Utils.escapeHtml(e.text)}</div>`}\n                ${n?`\n                <div class="note-audio">\n                  <audio controls preload="metadata" class="note-audio-player">\n                    <source src="${e.audio_url}" type="audio/mp4">\n                    <source src="${e.audio_url}" type="audio/webm">\n                    <source src="${e.audio_url}" type="audio/mpeg">\n                    Vas prohlizec nepodporuje prehravani audia.\n                  </audio>\n                </div>\n                `:""}\n              </div>\n            `}).join(""):'<div class="empty-notes">Zatim zadne poznamky</div>'}\n      </div>\n\n      <div class="note-input-area">\n        <textarea\n          class="note-textarea"\n          id="newNoteText"\n          placeholder="Napiste poznamku..."\n        ></textarea>\n        <div class="note-audio-controls">\n          <button type="button" class="btn-record" id="btnStartRecord" data-action="startRecording" data-id="${o.id}" title="Nahrat hlasovou zpravu">\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>\n              <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>\n            </svg>\n          </button>\n          <div class="recording-indicator" id="recordingIndicator" style="display: none;">\n            <span class="recording-dot"></span>\n            <span class="recording-time" id="recordingTime">0:00</span>\n            <button type="button" class="btn-stop-record" id="btnStopRecord" data-action="stopRecording" data-id="${o.id}">Stop</button>\n          </div>\n          <div class="audio-preview" id="audioPreview" style="display: none;">\n            <audio id="audioPreviewPlayer" controls></audio>\n            <button type="button" class="btn-delete-audio" id="btnDeleteAudio" data-action="deleteAudioPreview" title="Smazat nahravku">x</button>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <div class="detail-buttons">\n      <button class="detail-btn detail-btn-primary" data-action="saveNewNote" data-id="${o.id}">Pridat poznamku</button>\n      <button class="detail-btn detail-btn-secondary" data-action="closeNotesModal">Zavrit</button>\n    </div>\n  `;ModalManager.show(i),setTimeout(()=>{document.querySelectorAll(".note-audio-player").forEach(e=>{e.onerror=function(){logger.log("[Audio] Chyba pri nacitani ulozene nahravky");const t=e.closest(".note-audio");t&&(t.innerHTML='<span style="color: var(--c-grey); font-size: 0.75rem;">Audio nelze nacist</span>')}})},100),setTimeout(async()=>{await markNotesAsRead(o.id),await loadAll(ACTIVE_FILTER),window.WGSNotifikace&&window.WGSNotifikace.aktualizovat()},1e3)}async function saveNewNote(e){const o=document.getElementById("newNoteText").value.trim(),n=window.wgsAudioRecorder?window.wgsAudioRecorder.audioBlob:null;if(o||n)try{await addNote(e,o,n),window.wgsAudioRecorder&&(window.wgsAudioRecorder.audioBlob=null,window.wgsAudioRecorder.audioChunks=[]),closeNotesModal(),await loadAll(ACTIVE_FILTER),window.WGSNotifikace&&window.WGSNotifikace.aktualizovat()}catch(e){wgsToast.error(t("note_save_error")+": "+e.message)}else wgsToast.warning(t("write_note_text"))}function closeNotesModal(){window.wgsAudioRecorder&&window.wgsAudioRecorder.isRecording&&stopRecording(),"function"==typeof releaseMicrophone&&releaseMicrophone(),closeDetail(),renderOrders()}async function checkMicrophonePermission(){try{if(navigator.permissions&&navigator.permissions.query){const e=await navigator.permissions.query({name:"microphone"});return logger.log("[Audio] Stav opravneni mikrofonu:",e.state),"granted"===e.state?(window.wgsAudioRecorder.permissionGranted=!0,"granted"):"denied"===e.state?"denied":"prompt"}}catch(e){logger.log("[Audio] Permissions API neni podporovano, zkusim primo")}return"unknown"}async function startRecording(e){logger.log("[Audio] Spoustim nahravani...");try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Vas prohlizec nepodporuje nahravani zvuku");const e=await checkMicrophonePermission();if("denied"===e)throw new Error("Pristup k mikrofonu byl trvale odepren. Povolte ho v nastaveni prohlizece.");if(!window.wgsAudioRecorder.permissionGranted&&"granted"!==e){localStorage.getItem("wgs_mic_explained")||(wgsToast.info("Pro nahravani hlasovych poznamek potrebujeme pristup k mikrofonu. Po kliknuti na OK vas prohlizec pozada o povoleni."),localStorage.setItem("wgs_mic_explained","1"))}const t=await navigator.mediaDevices.getUserMedia({audio:!0});window.wgsAudioRecorder.stream=t,window.wgsAudioRecorder.permissionGranted=!0;const o=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||/iPad|iPhone|iPod/.test(navigator.userAgent);let n="audio/webm";o?(MediaRecorder.isTypeSupported("audio/mp4")?n="audio/mp4":MediaRecorder.isTypeSupported("audio/aac")&&(n="audio/aac"),logger.log("[Audio] Safari detekovan, preferuji MP4")):MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?n="audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/webm")?n="audio/webm":MediaRecorder.isTypeSupported("audio/mp4")?n="audio/mp4":MediaRecorder.isTypeSupported("audio/ogg")&&(n="audio/ogg"),logger.log("[Audio] Pouzivam format:",n);const a=window.wgsAudioRecorder;a.mimeType=n,a.mediaRecorder=new MediaRecorder(t,{mimeType:n}),a.audioChunks=[],a.isRecording=!0,a.recordingStartTime=Date.now(),a.mediaRecorder.ondataavailable=e=>{e.data.size>0&&(a.audioChunks.push(e.data),logger.log("[Audio] Data chunk:",e.data.size,"bytes"))},a.mediaRecorder.onstop=()=>{if(logger.log("[Audio] Nahravani ukonceno, chunks:",a.audioChunks.length),0===a.audioChunks.length)return logger.error("[Audio] Zadna data nebyla nahrana"),wgsToast.warning("Nahravka je prazdna. Zkuste to prosim znovu."),document.getElementById("btnStartRecord").classList.remove("hidden"),void document.getElementById("recordingIndicator").classList.add("hidden");const e=a.mimeType||"audio/webm";a.audioBlob=new Blob(a.audioChunks,{type:e}),a.isRecording=!1,logger.log("[Audio] Blob vytvoren:",a.audioBlob.size,"bytes, type:",e),releaseMicrophone(),showAudioPreview(a.audioBlob)},a.mediaRecorder.start(1e3),document.getElementById("btnStartRecord").classList.add("hidden"),document.getElementById("recordingIndicator").classList.remove("hidden"),a.recordingTimer=setInterval(()=>{const e=Math.floor((Date.now()-a.recordingStartTime)/1e3),t=Math.floor(e/60),o=e%60;document.getElementById("recordingTime").textContent=`${t}:${o.toString().padStart(2,"0")}`},1e3),logger.log("[Audio] Nahravani spusteno")}catch(e){logger.error("[Audio] Chyba pri nahravani:",e),releaseMicrophone(),"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?wgsToast.error("Pristup k mikrofonu byl odepren. Povolte pristup v nastaveni prohlizece."):wgsToast.error("Chyba pri nahravani: "+e.message)}}function stopRecording(){logger.log("[Audio] Zastavuji nahravani...");const e=window.wgsAudioRecorder;if(e.mediaRecorder&&e.isRecording){if("recording"===e.mediaRecorder.state)try{e.mediaRecorder.requestData()}catch(e){logger.log("[Audio] requestData neni podporovano:",e.message)}e.mediaRecorder.stop()}e.recordingTimer&&(clearInterval(e.recordingTimer),e.recordingTimer=null);const t=document.getElementById("recordingIndicator"),o=document.getElementById("btnStartRecord");t&&t.classList.add("hidden"),o&&o.classList.remove("hidden")}function releaseMicrophone(){const e=window.wgsAudioRecorder;e.stream&&(e.stream.getTracks().forEach(e=>{e.stop(),logger.log("[Audio] Track zastaven:",e.kind)}),e.stream=null),e.mediaRecorder&&(e.mediaRecorder=null),e.isRecording=!1,e.audioChunks=[],logger.log("[Audio] Mikrofon a MediaRecorder uvolneny")}function showAudioPreview(e){const t=URL.createObjectURL(e),o=document.getElementById("audioPreviewPlayer"),n=document.getElementById("audioPreview");o.onerror=null,o.oncanplay=null;let a=!1;o.onerror=function(e){a||(a=!0,logger.log("[Audio] Chyba pri nacitani nahravky:",e),n.classList.add("hidden"),document.getElementById("btnStartRecord").classList.remove("hidden"),o.src&&(URL.revokeObjectURL(o.src),o.src=""),logger.error("[Audio] Nahravka se nepodarila nacist"))},o.src=t,n.classList.remove("hidden"),logger.log("[Audio] Nahled zobrazen, velikost:",Math.round(e.size/1024),"KB")}function deleteAudioPreview(){const e=window.wgsAudioRecorder;e.audioBlob=null,e.audioChunks=[];const t=document.getElementById("audioPreviewPlayer"),o=document.getElementById("audioPreview");t.src&&(URL.revokeObjectURL(t.src),t.src=""),o.classList.add("hidden"),document.getElementById("btnStartRecord").classList.remove("hidden"),logger.log("[Audio] Nahled smazan")}function formatDateTime(e){const t=new Date(e),o=new Date-t;if(o<6e4)return"Pr√°vƒõ teƒè";if(o<36e5){return`P≈ôed ${Math.floor(o/6e4)} min`}if(o<864e5){return`P≈ôed ${Math.floor(o/36e5)} h`}return`${["ne","po","ut","st","ct","pa","so"][t.getDay()]} ${t.getDate()}.${t.getMonth()+1}.${t.getFullYear()} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`}function getStatus(e){return{"ƒåEK√Å":{class:"wait",text:"NOV√Å"},wait:{class:"wait",text:"NOV√Å"},"DOMLUVEN√Å":{class:"open",text:"DOMLUVEN√Å"},open:{class:"open",text:"DOMLUVEN√Å"},HOTOVO:{class:"done",text:"HOTOVO"},done:{class:"done",text:"HOTOVO"}}[e]||{class:"wait",text:"NOV√Å"}}function formatDate(e){if(!e)return"‚Äî";const t=new Date(e);if(isNaN(t))return e;return`${["ne","po","ut","st","ct","pa","so"][t.getDay()]} ${t.getDate()}.${t.getMonth()+1}.${t.getFullYear()}`}function formatAppointment(e,t){if(!e||!t)return"";const o=e.split(".");if(3!==o.length)return`${e} ${t}`;const n=parseInt(o[0]),a=parseInt(o[1]),i=parseInt(o[2]);return`${["ne","po","√∫t","st","ƒçt","p√°","so"][new Date(i,a-1,n).getDay()]} ${n}.${a}.-${t}`}function showDeleteConfirmModal(e){return new Promise(t=>{const o=document.createElement("div");o.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10003;display:flex;align-items:center;justify-content:center;";const n=document.createElement("div");n.style.cssText="background:white;padding:30px;border-radius:8px;max-width:450px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);",n.innerHTML=`\n      <h2 style="margin:0 0 20px 0;color:#666;font-size:1.3rem;font-weight:700;">Smazat reklamaci?</h2>\n      <p style="margin:0 0 15px 0;color:#555;line-height:1.6;font-size:1rem;">\n        Opravdu chcete <strong>TRVALE SMAZAT</strong> reklamaci<br>\n        <strong style="color:#666;font-size:1.1rem;">${e}</strong>?\n      </p>\n      <p style="margin:0 0 25px 0;color:#666;font-size:0.9rem;font-weight:600;">\n        Tato akce sma≈æe V≈†E vƒçetnƒõ fotek a PDF!<br>\n        Tuto akci NELZE vr√°tit zpƒõt!\n      </p>\n      <div style="display:flex;flex-direction:column;gap:12px;">\n        <button id="deleteConfirmYes" style="padding:14px 28px;background:#666;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:700;">\n          Ano, pokraƒçovat ‚Üí\n        </button>\n        <button id="deleteConfirmNo" style="padding:14px 28px;background:#999;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:600;">\n          Zru≈°it\n        </button>\n      </div>\n    `,o.appendChild(n),document.body.appendChild(o),document.getElementById("deleteConfirmNo").onclick=()=>{document.body.removeChild(o),t(!1)},document.getElementById("deleteConfirmYes").onclick=()=>{document.body.removeChild(o),t(!0)}})}function showDeleteInputModal(e){return new Promise(t=>{const o=document.createElement("div");o.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10003;display:flex;align-items:center;justify-content:center;";const n=document.createElement("div");n.style.cssText="background:white;padding:30px;border-radius:8px;max-width:450px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);",n.innerHTML=`\n      <h2 style="margin:0 0 20px 0;color:#666;font-size:1.3rem;font-weight:700;">Posledn√≠ ovƒõ≈ôen√≠</h2>\n      <p style="margin:0 0 15px 0;color:#555;line-height:1.6;font-size:1rem;">\n        Pro potvrzen√≠ smaz√°n√≠ zadejte p≈ôesnƒõ ƒç√≠slo reklamace:\n      </p>\n      <p style="margin:0 0 15px 0;color:#666;font-size:1.2rem;font-weight:700;">\n        ${e}\n      </p>\n      <input type="text" id="deleteInputField"\n             placeholder="Zadejte ƒç√≠slo reklamace"\n             style="width:100%;padding:12px;border:2px solid #666;border-radius:6px;font-size:1rem;text-align:center;margin-bottom:20px;">\n      <div style="display:flex;flex-direction:column;gap:12px;">\n        <button id="deleteInputConfirm" style="padding:14px 28px;background:#666;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:700;">\n          SMAZAT NAV≈ΩDY\n        </button>\n        <button id="deleteInputCancel" style="padding:14px 28px;background:#999;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:600;">\n          Zru≈°it\n        </button>\n      </div>\n    `,o.appendChild(n),document.body.appendChild(o);const a=document.getElementById("deleteInputField");a.focus(),document.getElementById("deleteInputCancel").onclick=()=>{document.body.removeChild(o),t("")},document.getElementById("deleteInputConfirm").onclick=()=>{const e=a.value.trim();document.body.removeChild(o),t(e)},a.addEventListener("keypress",e=>{if("Enter"===e.key){const e=a.value.trim();document.body.removeChild(o),t(e)}})})}async function deleteReklamace(e){logger.log("[deleteReklamace] Zobrazuji 1. confirmation modal");const o=CURRENT_RECORD.reklamace_id||CURRENT_RECORD.id||e;if(!await showDeleteConfirmModal(o))return void logger.log("Maz√°n√≠ zru≈°eno (1. krok)");if(await showDeleteInputModal(o)!==o){logger.log("Maz√°n√≠ zru≈°eno - ≈°patn√© ƒç√≠slo (2. krok)");const e=document.createElement("div");return e.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10003;display:flex;align-items:center;justify-content:center;",e.innerHTML='\n      <div style="background:white;padding:30px;border-radius:8px;max-width:400px;width:90%;text-align:center;">\n        <h2 style="margin:0 0 20px 0;color:#666;">Nespr√°vn√© ƒç√≠slo!</h2>\n        <p style="margin:0 0 25px 0;color:#555;">Zadali jste nespr√°vn√© ƒç√≠slo reklamace.<br>Maz√°n√≠ bylo zru≈°eno.</p>\n        <button data-action="closeErrorModal" style="padding:12px 24px;background:#999;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">\n          OK\n        </button>\n      </div>\n    ',void document.body.appendChild(e)}logger.log("üóëÔ∏è Maz√°n√≠ reklamace:",e);try{const o=await getCSRFToken(),n=await fetch("api/delete_reklamace.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:e,csrf_token:o})}),a=await n.json();if(!n.ok)throw new Error(`HTTP ${n.status}: ${a.message||a.error||n.statusText}`);if(a.success||"success"===a.status)logger.log("Smaz√°no!"),wgsToast.success(t("claim_deleted_successfully")),closeDetail(),setTimeout(()=>location.reload(),500);else{const e=a.message||a.error||t("delete_failed");logger.error("Chyba:",e),wgsToast.error(t("error")+": "+e)}}catch(e){logger.error("Chyba p≈ôi maz√°n√≠:",e),wgsToast.error(t("delete_error")+": "+e.message)}}async function smazatFotku(e,t){return logger.log("[smazatFotku] Vytv√°≈ô√≠m confirmation modal pro ID:",e),new Promise(o=>{const n=document.createElement("div");n.id="deleteFotoModal",n.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10003;display:flex;align-items:center;justify-content:center;";const a=document.createElement("div");a.style.cssText="background:white;padding:30px;border-radius:8px;max-width:400px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);",a.innerHTML='\n      <h2 style="margin:0 0 20px 0;color:#333;font-size:1.2rem;font-weight:700;">Smazat fotku?</h2>\n      <p style="margin:0 0 25px 0;color:#555;line-height:1.6;font-size:1rem;">\n        Opravdu chcete smazat tuto fotografii?<br><br>\n        <strong>Tato akce je nevratn√°!</strong>\n      </p>\n      <div style="display:flex;flex-direction:column;gap:12px;">\n        <button id="deleteFotoYes" style="padding:14px 28px;background:#666;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:700;">\n          Ano, smazat\n        </button>\n        <button id="deleteFotoNo" style="padding:14px 28px;background:#999;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:600;">\n          Zru≈°it\n        </button>\n      </div>\n    ',n.appendChild(a),document.body.appendChild(n),document.getElementById("deleteFotoNo").onclick=()=>{logger.log("[smazatFotku] U≈æivatel zru≈°il"),document.body.removeChild(n),o(!1)},document.getElementById("deleteFotoYes").onclick=async()=>{logger.log("[smazatFotku] U≈æivatel potvrdil, maz√°m..."),document.body.removeChild(n),await pokracovatSmazaniFotky(e,t),o(!0)}})}async function pokracovatSmazaniFotky(e,o){logger.log("üóëÔ∏è Maz√°n√≠ fotky ID:",e);try{const n=await getCSRFToken(),a=new FormData;a.append("photo_id",e),a.append("csrf_token",n);const i=await fetch("api/delete_photo.php",{method:"POST",body:a}),r=await i.json();if(!i.ok)throw new Error(`HTTP ${i.status}: ${r.message||r.error||i.statusText}`);if("success"===r.status){logger.log("Fotka smaz√°na!");const e=document.querySelectorAll(".foto-wrapper img");for(const t of e)if(t.src.includes(o.replace(/\\/g,""))){t.closest(".foto-wrapper").remove();break}const n=document.querySelector('[style*="Fotografie"]');if(n){const e=document.querySelectorAll(".foto-wrapper").length;if(n.textContent=`Fotografie (${e})`,0===e){const e=n.closest("div").querySelector('[style*="grid"]');e&&(e.innerHTML=`<p style="color: var(--c-grey); text-align: center; padding: 1rem; font-size: 0.9rem;">${t("no_photos")}</p>`)}}wgsToast.success(t("photo_deleted_successfully"))}else{const e=r.message||r.error||t("delete_failed");logger.error("Chyba:",e),wgsToast.error(t("error")+": "+e)}}catch(e){logger.error("Chyba p≈ôi maz√°n√≠ fotky:",e),wgsToast.error(t("photo_delete_error")+": "+e.message)}}async function loadPhotosFromDB(e){try{const t=await fetch(`api/get_photos_api.php?reklamace_id=${e}`);if(!t.ok)return[];const o=await t.json();return o.success&&o.photos?o.photos.map(e=>({id:e.id,photo_path:e.photo_path,section_name:e.section_name})):[]}catch(e){return logger.error("Chyba naƒç√≠t√°n√≠ fotek:",e),[]}}async function loadMoreOrders(){if(LOADING_MORE||!HAS_MORE_PAGES)return;LOADING_MORE=!0;const e=document.getElementById("loadMoreBtn");e&&(e.disabled=!0,e.textContent=t("loading")),await loadAll(ACTIVE_FILTER,!0)}function updateLoadMoreButton(){let e=document.getElementById("loadMoreBtn");if(!e){const o=document.getElementById("orderGrid");o&&o.parentElement&&(e=document.createElement("button"),e.id="loadMoreBtn",e.className="load-more-btn",e.textContent=t("load_more_orders"),e.onclick=loadMoreOrders,o.parentElement.appendChild(e))}e&&(e.classList.toggle("hidden",!HAS_MORE_PAGES),e.disabled=LOADING_MORE,e.textContent=LOADING_MORE?t("loading"):t("load_more_page").replace("{page}",CURRENT_PAGE+1))}async function sendContactAttemptEmail(e,t){try{if(!WGS_DATA_CACHE.find(t=>t.id==e||t.reklamace_id==e))return void showToast("Z√°znam nenalezen","error");showLoading("Odes√≠l√°m email z√°kazn√≠kovi... Pros√≠m ƒçekejte");const o=await getCSRFToken(),n=await fetch("/api/send_contact_attempt_email.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:e,csrf_token:o})}),a=await n.json();if(hideLoading(),a.success){logger.log("Email o pokusu o kontakt odesl√°n z√°kazn√≠kovi"),closeDetail(),"undefined"!=typeof WGSToast?WGSToast.zobrazit("Email odesl√°n z√°kazn√≠kovi",{titulek:"WGS"}):showToast("Email odesl√°n z√°kazn√≠kovi","success");const e=a.sms_text||"Dobr√Ω den, pokusili jsme se V√°s kontaktovat. Zavolejte pros√≠m zpƒõt na +420 725 965 826. Dƒõkujeme, WGS Service";setTimeout(()=>{const o=encodeURIComponent(e);window.location.href=`sms:${t}?body=${o}`},2e3)}else logger.error("‚ö† Chyba p≈ôi odes√≠l√°n√≠ emailu:",a.error||a.message),showToast(a.error||"Chyba p≈ôi odes√≠l√°n√≠ emailu","error")}catch(e){logger.error("Chyba p≈ôi odes√≠l√°n√≠ kontaktn√≠ho emailu:",e),showToast("Nepoda≈ôilo se odeslat email","error"),hideLoading()}}async function zobrazVideotekaArchiv(e){logger.log(`[Videot√©ka] Otev√≠r√°m archiv pro zak√°zku ID: ${e}`);if(document.getElementById("videotekaOverlay"))return void logger.log("[Videot√©ka] Overlay u≈æ existuje, ignoruji");const t=document.createElement("div");t.id="videotekaOverlay",t.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10004; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem;";const o=document.createElement("div");o.style.cssText="width: 95%; max-width: 900px; height: 90%; background: #222; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;";const n=window.innerWidth<600,a=document.createElement("div");a.style.cssText=n?"padding: 12px 16px; background: #333; color: white; font-weight: 600; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 2px; border-bottom: 2px solid #444;":"padding: 16px 20px; background: #333; color: white; font-weight: 600; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #444;",a.innerHTML="<span>Naƒç√≠t√°n√≠...</span>";const i=document.createElement("div");i.id="videotekaContent",i.style.cssText="flex: 1; overflow-y: auto; padding: 16px; background: #1a1a1a; display: flex; flex-direction: column; gap: 12px; align-content: start; position: relative; transition: background 0.2s ease;";const r=document.createElement("div");r.id="videotekaDropOverlay",r.style.cssText="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(45, 80, 22, 0.3); border: 3px dashed #2D5016; display: none; align-items: center; justify-content: center; z-index: 10; pointer-events: none;",r.innerHTML='<div style="color: white; font-size: 1.2rem; font-weight: 600; text-align: center; padding: 2rem;">Pus≈•te video pro nahr√°n√≠</div>';let s=0;i.addEventListener("dragenter",e=>{e.preventDefault(),e.stopPropagation(),s++,r.classList.remove("hidden"),i.style.background="#252525"}),i.addEventListener("dragleave",e=>{e.preventDefault(),e.stopPropagation(),s--,0===s&&(r.classList.add("hidden"),i.style.background="#1a1a1a")}),i.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation()}),i.addEventListener("drop",async o=>{o.preventDefault(),o.stopPropagation(),s=0,r.classList.add("hidden"),i.style.background="#1a1a1a";const n=o.dataTransfer.files;if(n.length>0){const o=n[0];o.type.startsWith("video/")?(logger.log(`[Videot√©ka] Drag & drop: ${o.name} (${(o.size/1024/1024).toFixed(2)} MB)`),await nahratVideoDragDrop(o,e,t)):showToast("Lze nahr√°t pouze video soubory","error")}});try{const t=await fetch(`/api/video_api.php?action=list_videos&claim_id=${e}`),o=await t.json();if("success"===o.status){const t=o.customer_name||"Nezn√°m√Ω z√°kazn√≠k",r=o.reklamace_cislo||e;if(a.innerHTML=n?`\n          <span style="font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">${t}</span>\n          <span style="font-size: 0.75rem; opacity: 0.6;">${r}</span>\n        `:`<span>${t}</span><span style="font-size: 0.85rem; opacity: 0.7;">${r}</span>`,o.videos&&o.videos.length>0)o.videos.forEach(t=>{const o=vytvorVideoKartu(t,e);i.appendChild(o)});else{i.classList.add("flex-center");const e=document.createElement("div");e.style.cssText="text-align: center; padding: 3rem; color: #999;",e.innerHTML='\n          <div style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 1rem;">≈Ω√°dn√° videa v archivu</div>\n          <div style="font-size: 1.05rem; font-weight: 500; margin-bottom: 0.5rem;">P≈ôet√°hnƒõte video sem</div>\n          <div style="font-size: 0.85rem; opacity: 0.7;">nebo pou≈æijte tlaƒç√≠tko n√≠≈æe</div>\n        ',i.appendChild(e)}}}catch(e){logger.error("[Videot√©ka] Chyba p≈ôi naƒç√≠t√°n√≠ vide√≠:",e),a.innerHTML="<span>Chyba</span>",i.innerHTML=`\n      <div style="text-align: center; padding: 3rem; color: #f44;">\n        <div style="font-size: 1rem; margin-bottom: 0.5rem;">Chyba p≈ôi naƒç√≠t√°n√≠ vide√≠</div>\n        <div style="font-size: 0.85rem; opacity: 0.7;">${e.message}</div>\n      </div>\n    `}const d=document.createElement("div");d.style.cssText="padding: 16px 20px; background: #333; border-top: 2px solid #444; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;";const l=document.createElement("button");l.textContent="Nahr√°t video",l.style.cssText="padding: 12px 24px; font-size: 0.95rem; font-weight: 600; background: #2D5016; color: white; border: none; border-radius: 6px; cursor: pointer; min-width: 140px; touch-action: manipulation;",l.onclick=()=>otevritNahravaniVidea(e,t);const c=document.createElement("button");c.textContent="Zav≈ô√≠t",c.style.cssText="padding: 12px 24px; font-size: 0.95rem; font-weight: 600; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; min-width: 140px; touch-action: manipulation;",c.onclick=()=>t.remove(),d.appendChild(l),d.appendChild(c),i.appendChild(r),o.appendChild(a),o.appendChild(i),o.appendChild(d),t.appendChild(o),t.onclick=e=>{e.target===t&&t.remove()};const p=e=>{"Escape"===e.key&&(t.remove(),document.removeEventListener("keydown",p))};document.addEventListener("keydown",p),document.body.appendChild(t)}function generujNahledVidea(e,t,o){return new Promise(n=>{const a=document.createElement("video");a.crossOrigin="anonymous",a.muted=!0,a.preload="metadata";const i=setTimeout(()=>{a.src="",n(null)},5e3);a.onloadedmetadata=()=>{const e=Math.min(1,.1*a.duration);a.currentTime=e},a.onseeked=()=>{clearTimeout(i);try{const e=document.createElement("canvas"),i=a.videoWidth,r=a.videoHeight,s=Math.min(t/i,o/r,1);e.width=Math.round(i*s*2),e.height=Math.round(r*s*2);e.getContext("2d").drawImage(a,0,0,e.width,e.height);const d=e.toDataURL("image/jpeg",.7);a.src="",n(d)}catch(e){a.src="",n(null)}},a.onerror=()=>{clearTimeout(i),n(null)},a.src=e})}function vytvorVideoKartu(e,t){const o=window.innerWidth<600,n=document.createElement("div");n.style.cssText=`\n    background: #2a2a2a;\n    border-radius: 6px;\n    padding: ${o?"8px":"12px"};\n    display: flex;\n    flex-direction: row;\n    align-items: flex-start;\n    gap: ${o?"8px":"12px"};\n    border: 1px solid #444;\n    width: 100%;\n    box-sizing: border-box;\n  `;const a=document.createElement("div"),i=o?100:120,r=o?60:68;a.style.cssText=`\n    flex-shrink: 0;\n    width: ${i}px;\n    height: ${r}px;\n    background: #1a1a1a;\n    border-radius: 4px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border: 1px solid #555;\n    cursor: pointer;\n    overflow: hidden;\n    position: relative;\n  `,a.innerHTML=`<span style="font-size: ${o?"1.5rem":"2rem"}; opacity: 0.5; color: #fff;">‚ñ∂</span>`,a.onclick=()=>prehratVideo(e.video_path,e.video_name),generujNahledVidea(e.video_path,i,r).then(e=>{e&&(a.innerHTML=`\n        <img src="${e}" style="width: 100%; height: 100%; object-fit: cover;">\n        <span style="position: absolute; font-size: ${o?"1.2rem":"1.5rem"}; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.8); opacity: 0.9;">‚ñ∂</span>\n      `)}).catch(()=>{});const s=document.createElement("div");s.style.cssText="flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 2px; min-width: 0;",s.title=e.video_name;const d=document.createElement("div");if(d.style.cssText=`font-weight: 500; font-size: ${o?"0.7rem":"0.9rem"}; color: ${o?"#aaa":"#fff"};`,e.uploader_email){const t=e.uploader_email.split("@")[0];d.textContent=t,d.title=e.uploader_email}else d.textContent="Admin",d.style.color="#888";const l=document.createElement("div");l.style.cssText=`display: flex; gap: ${o?"6px":"8px"}; flex-wrap: wrap; align-items: center;`;const c=document.createElement("span");c.style.cssText=`font-size: ${o?"0.6rem":"0.7rem"}; color: #666;`,c.textContent=`${(e.file_size/1024/1024).toFixed(1)} MB`;const p=document.createElement("span");p.style.cssText=`font-size: ${o?"0.6rem":"0.7rem"}; color: #666;`;let m="‚Äî";if(e.uploaded_at){const t=new Date(e.uploaded_at),n=["ne","po","ut","st","ct","pa","so"][t.getDay()];m=o?`${n} ${t.getDate()}.${t.getMonth()+1}.`:`${n} ${t.getDate()}.${t.getMonth()+1}.${t.getFullYear()} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`}p.textContent=m,l.appendChild(c),l.appendChild(p),s.appendChild(d),s.appendChild(l);const u=document.createElement("div");u.style.cssText=o?`display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; height: ${r}px; max-height: ${r}px; overflow: hidden; box-sizing: border-box;`:"display: flex; flex-direction: row; align-items: center; gap: 6px; flex-shrink: 0;";const g="height: 28px !important; min-height: 28px !important; max-height: 28px !important; width: 36px; padding: 0; margin: 0; border-radius: 3px; cursor: pointer; touch-action: manipulation; display: flex; align-items: center; justify-content: center; border: 1px solid #555; box-sizing: border-box;",h=document.createElement("button");o?(h.innerHTML='<i class="fas fa-download"></i>',h.title="St√°hnout video",h.style.cssText=g+" background: #444; color: #ccc; font-size: 0.75rem;"):(h.textContent="St√°hnout",h.style.cssText="min-height: 36px; padding: 0.4rem 0.8rem; font-size: 0.8rem; border: 1px solid #555; border-radius: 4px; cursor: pointer; touch-action: manipulation; white-space: nowrap; background: #444; color: white;"),h.onclick=()=>{const t=document.createElement("a");t.href=e.video_path,t.download=e.video_name||"video.mp4",t.click()};const f=document.createElement("button"),v=o?g+" background: #442222; color: #c66; font-size: 0.85rem; font-weight: bold;":"min-height: 36px; width: 36px; padding: 0; font-size: 1.1rem; font-weight: bold; background: #553333; color: #c66; border: 1px solid #664444; border-radius: 4px; cursor: pointer; touch-action: manipulation; display: flex; align-items: center; justify-content: center;";f.innerHTML="&#10005;",f.title="Smazat video",f.style.cssText=v;let y=null;return f.onclick=async t=>{if(t.stopPropagation(),!f.classList.contains("potvrzeni-video"))return f.classList.add("potvrzeni-video"),f.innerHTML="Smazat?",f.style.cssText=o?g+" background: #662222; color: #fff; font-size: 0.7rem; font-weight: bold; min-width: 50px;":"min-height: 36px; padding: 0 8px; font-size: 0.75rem; font-weight: bold; background: #662222; color: #fff; border: 1px solid #884444; border-radius: 4px; cursor: pointer; touch-action: manipulation; white-space: nowrap;",void(y=setTimeout(()=>{f.classList.remove("potvrzeni-video"),f.innerHTML="&#10005;",f.style.cssText=v},3e3));clearTimeout(y),f.innerHTML="...",f.disabled=!0;try{const t=new FormData;t.append("action","delete_video"),t.append("video_id",e.id),t.append("csrf_token",document.querySelector('input[name="csrf_token"]')?.value||"");const o=await fetch("/api/video_api.php",{method:"POST",body:t}),a=await o.json();if("success"!==a.status)throw new Error(a.message||"Chyba p≈ôi maz√°n√≠");showToast("Video bylo smaz√°no","success"),n.remove()}catch(e){logger.error("[Videot√©ka] Chyba p≈ôi maz√°n√≠ videa:",e),showToast("Chyba p≈ôi maz√°n√≠ videa: "+e.message,"error"),f.classList.remove("potvrzeni-video"),f.innerHTML="&#10005;",f.style.cssText=v,f.disabled=!1}},u.appendChild(h),u.appendChild(f),n.appendChild(a),n.appendChild(s),n.appendChild(u),n}function prehratVideo(e,t){const o=document.createElement("div");o.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10005; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem;";const n=document.createElement("video");n.src=e,n.controls=!0,n.autoplay=!0,n.style.cssText="max-width: 95%; max-height: 85vh; border-radius: 8px;";const a=document.createElement("div");a.style.cssText="color: white; font-size: 1rem; margin-top: 16px; text-align: center;",a.textContent=t||"Video";const i=document.createElement("button");i.textContent="Zav≈ô√≠t",i.style.cssText="margin-top: 16px; padding: 10px 24px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;",i.onclick=()=>{n.pause(),o.remove()},o.appendChild(n),o.appendChild(a),o.appendChild(i),o.onclick=e=>{e.target===o&&(n.pause(),o.remove())};const r=e=>{"Escape"===e.key&&(n.pause(),o.remove(),document.removeEventListener("keydown",r))};document.addEventListener("keydown",r),document.body.appendChild(o)}function otevritNahravaniVidea(e,t){logger.log(`[Videot√©ka] Otev√≠r√°m upload pro zak√°zku ID: ${e}`);const o=document.createElement("div");o.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10006; display: flex; align-items: center; justify-content: center; padding: 1rem;";const n=document.createElement("div");n.style.cssText="background: #2a2a2a; border-radius: 8px; padding: 24px; max-width: 500px; width: 100%; border: 2px solid #444;";const a=document.createElement("h3");a.style.cssText="color: white; margin: 0 0 20px 0; font-size: 1.1rem;",a.textContent="Nahr√°t video";const i=document.createElement("input");i.type="file",i.id="video",i.name="video",i.accept="video/*",i.style.cssText="display: block; width: 100%; padding: 12px; background: #1a1a1a; color: white; border: 1px solid #555; border-radius: 4px; margin-bottom: 16px; font-size: 0.9rem;";const r=document.createElement("div");r.style.cssText="background: #1a1a1a; padding: 12px; border-radius: 4px; margin-bottom: 16px; color: #999; font-size: 0.85rem; border: 1px solid #555;",r.innerHTML='\n    <div style="margin-bottom: 6px;">‚ÑπÔ∏è <strong>Informace o nahr√°v√°n√≠:</strong></div>\n    <div style="margin-left: 24px;">\n      <div>‚Ä¢ Maxim√°ln√≠ velikost: 500 MB</div>\n      <div>‚Ä¢ Podporovan√© form√°ty: MP4, MOV, AVI, WebM</div>\n      <div>‚Ä¢ Video nad 500 MB bude automaticky komprimov√°no</div>\n    </div>\n  ';const s=document.createElement("div");s.style.cssText="display: none; margin-bottom: 16px;";const d=document.createElement("div");d.style.cssText="width: 100%; height: 24px; background: #1a1a1a; border-radius: 4px; overflow: hidden; border: 1px solid #555;";const l=document.createElement("div");l.style.cssText="height: 100%; background: #2D5016; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;",d.appendChild(l),s.appendChild(d);const c=document.createElement("div");c.style.cssText="text-align: center; color: #999; font-size: 0.85rem; margin-top: 8px; display: none;",s.appendChild(c);const p=document.createElement("div");p.style.cssText="display: flex; gap: 12px; justify-content: flex-end;";const m=document.createElement("button");m.textContent="Zru≈°it",m.style.cssText="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;",m.onclick=()=>o.remove();const u=document.createElement("button");u.textContent="Nahr√°t",u.style.cssText="padding: 10px 20px; background: #2D5016; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600;",u.onclick=async()=>{const n=i.files[0];if(!n)return void wgsToast.warning("Vyberte video soubor");const a=n.size>524288e3;u.disabled=!0,m.disabled=!0,s.classList.remove("hidden"),c.classList.remove("hidden");try{let i=n;if(a){c.textContent="Komprimuji video...",l.style.width="10%",l.textContent="10%";try{if("undefined"==typeof MediaRecorder)throw new Error("MediaRecorder nen√≠ podporov√°n");i=await komprimovatVideo(n,e=>{const t=Math.round(10+40*e);l.style.width=t+"%",l.textContent=t+"%"}),logger.log(`[Videot√©ka] Video komprimov√°no: ${n.size} ‚Üí ${i.size} byt≈Ø`)}catch(e){if(logger.warn(`[Videot√©ka] Komprese selhala, pou≈æ√≠v√°m origin√°l: ${e.message}`),i=n,c.textContent="Komprese nedostupn√°, nahr√°v√°m origin√°l...",n.size>524288e3)throw showToast("Video je p≈ô√≠li≈° velk√© (max 500 MB). Komprese selhala.","error"),new Error("Video p≈ô√≠li≈° velk√© a komprese nen√≠ dostupn√°")}}c.textContent="Nahr√°v√°m video...",l.style.width="50%",l.textContent="50%";const r=new FormData;r.append("action","upload_video"),r.append("claim_id",e),r.append("video",i,i.name||n.name),r.append("csrf_token",document.querySelector('input[name="csrf_token"]')?.value||"");const s=await fetch("/api/video_api.php",{method:"POST",body:r});l.style.width="90%",l.textContent="90%";const d=await s.json();if("success"!==d.status)throw new Error(d.message||"Chyba p≈ôi nahr√°v√°n√≠");l.style.width="100%",l.textContent="100%",c.textContent="Hotovo!",l.style.background="#333","undefined"!=typeof WGSToast?WGSToast.zobrazit("Video bylo √∫spƒõ≈°nƒõ nahr√°no",{titulek:"WGS"}):showToast("Video bylo √∫spƒõ≈°nƒõ nahr√°no","success"),setTimeout(()=>{o.remove(),t.remove(),zobrazVideotekaArchiv(e)},1e3)}catch(e){logger.error("[Videot√©ka] Chyba p≈ôi uploadu:",e),l.style.background="#c33",c.textContent="Chyba: "+e.message,u.disabled=!1,m.disabled=!1,showToast("Chyba p≈ôi nahr√°v√°n√≠ videa: "+e.message,"error")}},p.appendChild(m),p.appendChild(u),n.appendChild(a),n.appendChild(r),n.appendChild(i),n.appendChild(s),n.appendChild(p),o.appendChild(n);const g=e=>{"Escape"!==e.key||u.disabled||(o.remove(),document.removeEventListener("keydown",g))};document.addEventListener("keydown",g),document.body.appendChild(o)}async function nahratVideoDragDrop(e,t,o){logger.log(`[Videot√©ka] Zahajuji drag & drop upload: ${e.name}`);const n=document.createElement("div");n.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10007; display: flex; align-items: center; justify-content: center; padding: 1rem;";const a=document.createElement("div");a.style.cssText="background: #2a2a2a; border-radius: 8px; padding: 24px; max-width: 400px; width: 100%; border: 2px solid #444; text-align: center;";const i=document.createElement("div");i.style.cssText="color: white; font-size: 1rem; font-weight: 600; margin-bottom: 16px;",i.textContent="Nahr√°v√°n√≠ videa...";const r=document.createElement("div");r.style.cssText="width: 100%; height: 24px; background: #1a1a1a; border-radius: 4px; overflow: hidden; border: 1px solid #555;";const s=document.createElement("div");s.style.cssText="height: 100%; background: #2D5016; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;",s.textContent="0%";const d=document.createElement("div");d.style.cssText="color: #999; font-size: 0.85rem; margin-top: 12px;",d.textContent=e.name,r.appendChild(s),a.appendChild(i),a.appendChild(r),a.appendChild(d),n.appendChild(a),document.body.appendChild(n);try{const a=524288e3;let i=e;e.size>a&&(d.textContent="Komprimuji video...",s.style.width="10%",s.textContent="10%",i=await komprimovatVideo(e,e=>{const t=Math.round(10+40*e);s.style.width=t+"%",s.textContent=t+"%"}),logger.log(`[Videot√©ka] Video komprimov√°no: ${e.size} ‚Üí ${i.size} byt≈Ø`)),d.textContent="Odes√≠l√°m na server...",s.style.width="50%",s.textContent="50%";const r=new FormData;r.append("action","upload_video"),r.append("claim_id",t),r.append("video",i,i.name||e.name),r.append("csrf_token",document.querySelector('input[name="csrf_token"]')?.value||"");const l=await fetch("/api/video_api.php",{method:"POST",body:r});s.style.width="90%",s.textContent="90%";const c=await l.json();if("success"!==c.status)throw new Error(c.message||"Chyba p≈ôi nahr√°v√°n√≠");s.style.width="100%",s.textContent="100%",d.textContent="Hotovo!",s.style.background="#333","undefined"!=typeof WGSToast?WGSToast.zobrazit("Video bylo √∫spƒõ≈°nƒõ nahr√°no",{titulek:"WGS"}):showToast("Video bylo √∫spƒõ≈°nƒõ nahr√°no","success"),setTimeout(()=>{n.remove(),o.remove(),zobrazVideotekaArchiv(t)},1e3)}catch(e){logger.error("[Videot√©ka] Chyba p≈ôi drag & drop uploadu:",e),s.style.background="#c33",s.style.width="100%",d.textContent="Chyba: "+e.message,showToast("Chyba p≈ôi nahr√°v√°n√≠ videa: "+e.message,"error"),setTimeout(()=>{n.remove()},3e3)}}async function komprimovatVideo(e,t){return new Promise((o,n)=>{try{const a=document.createElement("video");a.preload="metadata",a.muted=!0,a.playsInline=!0,a.onloadedmetadata=()=>{const i=a.videoWidth,r=a.videoHeight;let s=i,d=r;if(i>1920||r>1080){const e=Math.min(1920/i,1080/r);s=Math.round(i*e),d=Math.round(r*e)}const l=document.createElement("canvas");l.width=s,l.height=d;const c=l.getContext("2d"),p=l.captureStream(30),m=["video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm","video/mp4"];let u="";for(const e of m)if(MediaRecorder.isTypeSupported(e)){u=e;break}if(!u)return void n(new Error("≈Ω√°dn√Ω video kodek nen√≠ podporov√°n"));logger.log(`[Videot√©ka] Pou≈æ√≠v√°m kodek: ${u}`);const g={mimeType:u,videoBitsPerSecond:25e5};let h;try{h=new MediaRecorder(p,g)}catch(e){h=new MediaRecorder(p,{mimeType:u})}const f=[];h.ondataavailable=e=>{e.data.size>0&&f.push(e.data)},h.onstop=()=>{const t=new Blob(f,{type:u}),n=u.includes("mp4")?"mp4":"webm";t.name=e.name.replace(/\.[^.]+$/,"")+"_compressed."+n,o(t)},h.onerror=e=>{n(new Error("Chyba p≈ôi kompresi videa: "+(e.error?.message||"nezn√°m√°")))},h.start(1e3),a.play().catch(e=>{n(new Error("Nelze p≈ôehr√°t video pro kompresi: "+e.message))});const v=()=>{if(a.paused||a.ended)setTimeout(()=>h.stop(),100);else{if(c.drawImage(a,0,0,s,d),t){const e=a.currentTime/a.duration;t(e)}requestAnimationFrame(v)}};a.onplay=()=>{v()},a.onerror=()=>{n(new Error("Chyba p≈ôi naƒç√≠t√°n√≠ videa pro kompresi"))}},a.onerror=()=>{n(new Error("Video soubor nelze naƒç√≠st"))},a.src=URL.createObjectURL(e)}catch(e){n(e)}})}window.wgsAudioRecorder={mediaRecorder:null,audioChunks:[],audioBlob:null,isRecording:!1,recordingStartTime:null,recordingTimer:null,permissionGranted:!1,stream:null},document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{const t=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");t&&("function"==typeof navigateTo?navigateTo(t):location.href=t)}),document.addEventListener("change",e=>{const t=e.target.closest("[data-onchange]");if(!t)return;const o=t.getAttribute("data-onchange"),n=t.getAttribute("data-onchange-value")||t.value;"function"==typeof window[o]&&window[o](n)})}),document.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;const o=t.getAttribute("data-action"),n=t.getAttribute("data-id"),a=t.getAttribute("data-url"),i=t.getAttribute("data-pdf-path");switch(logger.log(`[Seznam] Tlaƒç√≠tko kliknuto: ${o}`,{id:n,url:a,pdfPath:i}),o){case"reopenOrder":n&&reopenOrder(n);break;case"showContactMenu":n&&showContactMenu(n);break;case"showCustomerDetail":n&&showCustomerDetail(n);break;case"showDetail":CURRENT_RECORD&&showDetail(CURRENT_RECORD);break;case"openPDF":e.preventDefault(),e.stopPropagation(),i&&zobrazPDFModal(i,n);break;case"showHistoryPDF":const r=t.getAttribute("data-original-id");r&&showHistoryPDF(r);break;case"showPhotoFullscreen":a&&showPhotoFullscreen(a);break;case"smazatFotku":const s=t.getAttribute("data-photo-id");s&&a&&(e.stopPropagation(),smazatFotku(s,a));break;case"deleteReklamace":n&&deleteReklamace(n);break;case"saveAllCustomerData":n&&saveAllCustomerData(n);break;case"closeDetail":closeDetail();break;case"showNotes":n&&"function"==typeof showNotes&&(e.stopPropagation(),showNotes(n));break;case"filterUnreadNotes":"function"==typeof filterUnreadNotes&&filterUnreadNotes();break;case"closeNotesModal":"function"==typeof closeNotesModal&&closeNotesModal();break;case"saveNewNote":n&&"function"==typeof saveNewNote&&saveNewNote(n);break;case"deleteNote":const d=t.getAttribute("data-note-id"),l=t.getAttribute("data-order-id");d&&"function"==typeof deleteNote&&(e.stopPropagation(),deleteNote(d,l));break;case"startRecording":n&&"function"==typeof startRecording&&(e.stopPropagation(),startRecording(n));break;case"stopRecording":"function"==typeof stopRecording&&(e.stopPropagation(),stopRecording());break;case"deleteAudioPreview":"function"==typeof deleteAudioPreview&&(e.stopPropagation(),deleteAudioPreview());break;case"showVideoteka":n&&"function"==typeof zobrazVideotekaArchiv&&(e.stopPropagation(),zobrazVideotekaArchiv(n));break;case"showDetailById":n&&"function"==typeof showDetail&&showDetail(n);break;case"closeModal":ModalManager.close&&ModalManager.close();break;case"saveSelectedDate":"function"==typeof saveSelectedDate&&saveSelectedDate();break;case"previousMonth":"function"==typeof previousMonth&&(e.stopPropagation(),previousMonth());break;case"nextMonth":"function"==typeof nextMonth&&(e.stopPropagation(),nextMonth(e));break;case"showBookingDetail":n&&"function"==typeof showBookingDetail&&showBookingDetail(n);break;case"showCalendarBack":CURRENT_RECORD&&"function"==typeof showCalendar&&showCalendar(CURRENT_RECORD.id);break;case"openCalendarFromDetail":n&&(closeDetail(),setTimeout(()=>showCalendar(n),100));break;case"sendContactAttemptEmail":const c=t.getAttribute("data-phone");n&&c&&"function"==typeof sendContactAttemptEmail&&sendContactAttemptEmail(n,c);break;case"openPdfNewWindow":a&&window.open(a,"_blank");break;case"closeErrorModal":const p=t.closest('div[style*="position:fixed"]');p&&p.remove();break;default:logger.warn(`[Seznam] Nezn√°m√° akce: ${o}`)}});