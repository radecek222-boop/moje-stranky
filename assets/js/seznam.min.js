window.csrfTokenCache=window.csrfTokenCache||null;let originalFetch=window.fetch||fetch;async function getCSRFToken(){if(window.csrfTokenCache)return window.csrfTokenCache;try{var e=await(await originalFetch("/app/controllers/get_csrf_token.php")).json();return window.csrfTokenCache=e.token,e.token}catch(e){return"undefined"!=typeof logger&&logger.error("Chyba z√≠sk√°n√≠ CSRF tokenu:",e),""}}function showToast(e,t="info"){var a=document.getElementById("wgs-toast");a&&a.remove();let o=document.createElement("div");o.id="wgs-toast",o.textContent=e,o.style.cssText=`
    position: fixed;
    top: 80px;
    right: 20px;
    background: ${"success"!==t&&"error"===t?"#666":"#333"};
    color: white;
    padding: 16px 24px;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    font-size: 14px;
    font-weight: 600;
    min-width: 250px;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
  `;a=document.createElement("style");a.textContent=`
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  `,document.getElementById("wgs-toast-styles")||(a.id="wgs-toast-styles",document.head.appendChild(a)),document.body.appendChild(o),setTimeout(()=>{o.style.animation="slideOut 0.3s ease-in",setTimeout(()=>o.remove(),300)},3e3)}let WGS_DATA_CACHE=[],ACTIVE_FILTER="all",CURRENT_RECORD=null,SELECTED_DATE=null,SELECTED_TIME=null,EMAILS_S_CN=[],STAVY_NABIDEK={},CURRENT_PAGE=1,HAS_MORE_PAGES=!1,LOADING_MORE=!1,PER_PAGE=50,CAL_MONTH=(new Date).getMonth(),CAL_YEAR=(new Date).getFullYear(),SEARCH_QUERY="",WGS_ADDRESS="Dubƒçe 364, Bƒõchovice 190 11, ƒåesk√° republika",WGS_COORDS={lat:50.0472,lng:14.5881},DISTANCE_CACHE={},Utils={getCustomerName:e=>e.jmeno||e.zakaznik||"Nezn√°m√Ω z√°kazn√≠k",getAddress:e=>e.adresa||(0<(e=[e.ulice,e.mesto,e.psc].filter(e=>e)).length?e.join(", "):"‚Äî"),getProduct:e=>e.model||e.vyrobek||"‚Äî",getOrderId:(e,t=0)=>e.cislo||e.reklamacniCislo||e.id||"WGS-"+(t+1),isCompleted:e=>"HOTOVO"===e.stav||"done"===e.stav,escapeHtml:e=>{var t=document.createElement("div");return t.textContent=e,t.innerHTML},addCountryToAddress:e=>e&&(e.toLowerCase().includes("ƒçesk")?e:e+", ƒåesk√° republika"),filterByUserRole:e=>{if(!CURRENT_USER||CURRENT_USER.is_admin||"prodejce"!==CURRENT_USER.role)return e;let t=String(CURRENT_USER.id),a=(CURRENT_USER.supervised_user_ids||[]).map(String);return e.filter(e=>{e=String(e.created_by||"");return e===t||!!a.includes(e)})}},CacheManager={load:()=>{try{var e=localStorage.getItem("wgs_distance_cache");e&&(DISTANCE_CACHE=JSON.parse(e),logger.log("Naƒçteno",Object.keys(DISTANCE_CACHE).length,"vzd√°lenost√≠ z cache"))}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ cache:",e)}},save:()=>{try{localStorage.setItem("wgs_distance_cache",JSON.stringify(DISTANCE_CACHE))}catch(e){logger.error("Chyba p≈ôi ukl√°d√°n√≠ cache:",e)}}},AUTO_REFRESH_INTERVAL=6e4,autoRefreshTimer=null,lastRefreshTime=Date.now();function startAutoRefresh(){autoRefreshTimer&&clearInterval(autoRefreshTimer),autoRefreshTimer=setInterval(async()=>{"visible"===document.visibilityState&&(logger.log("[AutoRefresh] Automaticka aktualizace dat..."),await loadAll(),lastRefreshTime=Date.now())},AUTO_REFRESH_INTERVAL),logger.log(`[AutoRefresh] Spusten - interval ${AUTO_REFRESH_INTERVAL/1e3}s`)}function stopAutoRefresh(){autoRefreshTimer&&(clearInterval(autoRefreshTimer),autoRefreshTimer=null,logger.log("[AutoRefresh] Zastaven"))}function initSearch(){var e=document.getElementById("searchInput");let t=document.getElementById("searchClear");var a=new URLSearchParams(window.location.search).get("search");a&&(e.value=a,SEARCH_QUERY=a.trim().toLowerCase(),t.classList.add("visible"),window.history.replaceState({},document.title,window.location.pathname)),e.addEventListener("input",e=>{SEARCH_QUERY=e.target.value.trim().toLowerCase(),t.classList.toggle("visible",0<SEARCH_QUERY.length),renderOrders(Utils.filterByUserRole(WGS_DATA_CACHE))}),e.addEventListener("keydown",e=>{"Escape"===e.key&&clearSearch()})}function clearSearch(){var e=document.getElementById("searchInput"),t=document.getElementById("searchClear"),e=(e.value="",SEARCH_QUERY="",t.classList.remove("visible"),Utils.filterByUserRole(WGS_DATA_CACHE));renderOrders(e)}function highlightText(e,t){return Utils.highlightText?Utils.highlightText(e,t):Utils.escapeHtml(e)}function matchesSearch(e,t){return!t||[Utils.getCustomerName(e),e.telefon||"",e.email||"",Utils.getAddress(e),Utils.getProduct(e),Utils.getOrderId(e),e.popis_problemu||""].join(" ").toLowerCase().includes(t)}function initFilters(){document.querySelectorAll(".filter-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),ACTIVE_FILTER=e.dataset.filter,renderOrders(Utils.filterByUserRole(WGS_DATA_CACHE))})})}function updateCounts(e){var t,a,o;Array.isArray(e)&&(t=e.length,a=e.filter(e=>{var t=e.stav||"wait";return!("ƒåEK√Å"!==t&&"wait"!==t||(t=(e.email||"").toLowerCase().trim())&&EMAILS_S_CN.includes(t))}).length,o=e.filter(e=>{e=e.stav||"wait";return"DOMLUVEN√Å"===e||"open"===e}).length,e=e.filter(e=>{e=e.stav||"wait";return"HOTOVO"===e||"done"===e}).length,document.getElementById("count-all").textContent=`(${t})`,document.getElementById("count-wait").textContent=`(${a})`,document.getElementById("count-open").textContent=`(${o})`,document.getElementById("count-done").textContent=`(${e})`)}async function loadAll(a="all",o=!1){try{var n=o?CURRENT_PAGE+1:1,i=Date.now(),r=await fetch(`app/controllers/load.php?status=${a}&page=${n}&per_page=${PER_PAGE}&_t=`+i,{cache:"no-store",headers:{"Cache-Control":"no-cache"}});if(!r.ok)throw new Error("Chyba naƒç√≠t√°n√≠");var d=await r.json();let e=[];"success"===d.status&&Array.isArray(d.data)?e=d.data:Array.isArray(d)&&(e=d),CURRENT_PAGE=o?(WGS_DATA_CACHE=[...WGS_DATA_CACHE,...e],n):(WGS_DATA_CACHE=e,1),HAS_MORE_PAGES=e.length===PER_PAGE,LOADING_MORE=!1;var s=Utils.filterByUserRole(WGS_DATA_CACHE);updateCounts(s),renderOrders(s),updateLoadMoreButton(),lastRefreshTime=Date.now()}catch(e){logger.error("Chyba:",e),WGS_DATA_CACHE=[],document.getElementById("orderGrid").innerHTML=`
      <div class="empty-state">
        <div class="empty-state-text">${t("data_load_error")}</div>
      </div>
    `}}async function renderOrders(e=null){var a=document.getElementById("orderGrid"),o=document.getElementById("searchResultsInfo");e=e||Utils.filterByUserRole(WGS_DATA_CACHE);let n=e=Array.isArray(e)?e:[];if("all"!==ACTIVE_FILTER&&"cn"!==ACTIVE_FILTER){let a={wait:["ƒåEK√Å","wait"],open:["DOMLUVEN√Å","open"],done:["HOTOVO","done"]};n=e.filter(e=>{var t=e.stav||"wait",t=a[ACTIVE_FILTER]?.includes(t);if("wait"===ACTIVE_FILTER&&t){e=(e.email||"").toLowerCase().trim();if(e&&EMAILS_S_CN.includes(e))return!1}return t})}var i=n.length;if(SEARCH_QUERY?(0<(n=n.filter(e=>matchesSearch(e,SEARCH_QUERY))).length?(o.className="search-results-info",o.textContent=t("search_results_found").replace("{count}",n.length).replace("{total}",i).replace("{query}",SEARCH_QUERY)):(o.className="search-results-info no-results",o.textContent=t("no_search_results").replace("{query}",SEARCH_QUERY)),o.classList.remove("hidden")):o.classList.add("hidden"),0===n.length)a.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-text">${SEARCH_QUERY?t("no_results_found"):t("no_claims_to_display")}</div>
      </div>
    `;else{let b={};try{var r=await(await fetch("/api/notes_api.php?action=get_unread_counts")).json();"success"===r.status&&(b=r.unread_counts||{})}catch(e){logger.warn("Nepoda≈ôilo se naƒç√≠st unread counts:",e)}try{var d=await(await fetch("/api/nabidka_api.php?action=emaily_s_nabidkou&_t="+Date.now(),{cache:"no-store",headers:{"Cache-Control":"no-cache"}})).json();"success"===d.status&&(EMAILS_S_CN=d.data?.emaily||d.emaily||[],STAVY_NABIDEK=d.data?.stavy||d.stavy||{})}catch(e){logger.warn("Nepoda≈ôilo se naƒç√≠st emaily s CN:",e)}i=document.getElementById("count-cn"),r=(i&&(o=e.filter(e=>{e=(e.email||"").toLowerCase().trim();return e&&EMAILS_S_CN.includes(e)}).length,i.textContent=`(${o})`),document.getElementById("count-wait")),i=(r&&(d=e.filter(e=>{var t=e.stav||"wait";return!("ƒåEK√Å"!==t&&"wait"!==t||(t=(e.email||"").toLowerCase().trim())&&EMAILS_S_CN.includes(t))}).length,r.textContent=`(${d})`),(n="cn"===ACTIVE_FILTER?n.filter(e=>{e=(e.email||"").toLowerCase().trim();return e&&EMAILS_S_CN.includes(e)}):n).sort((e,t)=>{var a=e.stav||"wait",o=t.stav||"wait",n={"ƒåEK√Å":1,wait:1,"DOMLUVEN√Å":2,open:2,HOTOVO:3,done:3},i=n[a]||1,n=n[o]||1;return i!==n?i-n:"ƒåEK√Å"===a||"wait"===a?(o=new Date(e.created_at||e.datum_reklamace||0),new Date(t.created_at||t.datum_reklamace||0)-o):"DOMLUVEN√Å"===a||"open"===a?(i=e=>e.termin?new Date(e.termin+`T${e.cas_navstevy||"00:00"}:00`):new Date("9999-12-31"))(e)-i(t):(n=new Date(e.datum_dokonceni||e.completed_at||e.updated_at||e.created_at||0),new Date(t.datum_dokonceni||t.completed_at||t.updated_at||t.created_at||0)-n)}),a.innerHTML=n.map((e,t)=>{var a=Utils.getCustomerName(e),o=Utils.getProduct(e),n=formatDate(e.created_at||e.datum_reklamace),i=getStatus(e.stav),t=Utils.getOrderId(e,t);let r=Utils.getAddress(e),d=("‚Äî"!==r&&(s=r.split(",").map(e=>e.trim()),r=s.slice(0,2).join(", ")),"");"open"===i.class&&e.termin&&e.cas_navstevy&&(d=formatAppointment(e.termin,e.cas_navstevy));var s=e.id,s=b[s]||0,l=0<s,c=(e.email||"").toLowerCase().trim(),p=c&&EMAILS_S_CN.includes(c),c=STAVY_NABIDEK[c]||null,m="potvrzena"===c,c="cekame_nd"===c,a=SEARCH_QUERY?highlightText(a,SEARCH_QUERY):a,u=SEARCH_QUERY?highlightText(r,SEARCH_QUERY):r,o=SEARCH_QUERY?highlightText(o,SEARCH_QUERY):o,t=SEARCH_QUERY?highlightText(t,SEARCH_QUERY):t,g=SEARCH_QUERY&&matchesSearch(e,SEARCH_QUERY)?"search-match":"",h="status-bg-"+i.class;let v="",f=(p&&!d&&(v=c?"cn-cekame-nd":m?"cn-odsouhlasena":"ma-cenovou-nabidku"),"Posl√°na CN"),y="order-cn-text";return c?(f="Cekame ND",y="order-cn-text cekame-nd"):m&&(f="Odsouhlasena",y="order-cn-text odsouhlasena"),`
      <div class="order-box ${g} ${h} ${v}" data-action="showDetailById" data-id="${e.id}">
        <div class="order-header">
          <div class="order-number">${t}</div>
          <div style="display: flex; gap: 0.4rem; align-items: center;">
            <div class="order-notes-badge ${l?"has-unread pulse":""}" data-action="showNotes" data-id="${e.id}" title="${0<s?s+" nep≈ôeƒçten√©":"Pozn√°mky"}">
              <span class="notes-icon">‚úé</span>${0<s?s:""}
            </div>
            <div class="order-status status-${i.class}"></div>
          </div>
        </div>
        <div class="order-body">
          <div class="order-customer">${a}</div>
          <div class="order-detail-line">${u}</div>
          <div class="order-detail-row">
            <div class="order-detail-left">
              <div class="order-detail-line">${o}</div>
              <div class="order-detail-line" style="opacity: 0.6;">${n}</div>
            </div>
            <div class="order-detail-right">
              ${d?`<span class="order-appointment">${d}</span>`:p?`<span class="${y}">${f}</span>`:`<span class="order-status-text status-${i.class}">${i.text}</span>`}
            </div>
          </div>
        </div>
      </div>
    `}).join(""),Object.values(b).reduce((e,t)=>e+t,0)),o=document.getElementById("unreadNotesIndicator"),e=document.getElementById("unreadNotesCount");o&&e&&(0<i?(e.textContent=i,o.style.display="block"):o.style.display="none"),window.UNREAD_COUNTS_MAP=b}}function filterUnreadNotes(){let t=window.UNREAD_COUNTS_MAP||{};var e=WGS_DATA_CACHE.filter(e=>{e=e.id;return 0<t[e]}),a=(logger.log(`[Seznam] Filtrov√°n√≠ nep≈ôeƒçten√Ωch pozn√°mek: ${e.length} karet`),document.getElementById("orderGrid"));0===e.length?a.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-text">≈Ω√°dn√© nep≈ôeƒçten√© pozn√°mky</div>
      </div>
    `:(renderOrders(e),window.scrollTo({top:0,behavior:"smooth"}))}window.addEventListener("DOMContentLoaded",async()=>{CacheManager.load(),initFilters(),initSearch(),await loadAll(),startAutoRefresh(),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&3e4<Date.now()-lastRefreshTime&&(logger.log("[AutoRefresh] Tab aktivni - nacitam nova data..."),loadAll())}),setTimeout(()=>{window.WGSNotifikace&&"function"==typeof window.WGSNotifikace.zobrazitDialogPovoleni&&window.WGSNotifikace.zobrazitDialogPovoleni()},3e3)});let ModalManager={show:e=>{document.getElementById("modalContent").innerHTML=e,window.detailModal&&window.detailModal.open?window.detailModal.open():(window.scrollLock&&window.scrollLock.enable("detail-overlay"),document.body.classList.add("modal-open"),document.getElementById("detailOverlay").classList.add("active")),setTimeout(()=>{var e=document.querySelector("#detailOverlay .modal-content");e&&(e.scrollTop=0)},10)},close:()=>{window.detailModal&&window.detailModal.close?window.detailModal.close():(document.getElementById("detailOverlay").classList.remove("active"),setTimeout(()=>{document.body.classList.remove("modal-open"),window.scrollLock&&window.scrollLock.disable("detail-overlay")},50)),CURRENT_RECORD=null,SELECTED_DATE=null,SELECTED_TIME=null},createHeader:(e,t)=>`
      <div class="modal-header">
        <button class="modal-close-btn" data-action="closeDetail" aria-label="Zav≈ô√≠t" title="Zav≈ô√≠t">√ó</button>
        <h2 class="modal-title">${e}</h2>
        ${t?`<p class="modal-subtitle">${t}</p>`:""}
      </div>
    `,createActions:e=>`
      <div class="modal-actions">
        ${e.join("")}
      </div>
    `};function createCustomerHeader(){var e,t,a,o,n;return CURRENT_RECORD?(e=Utils.getCustomerName(CURRENT_RECORD),t=Utils.getAddress(CURRENT_RECORD),a=CURRENT_RECORD.termin?formatDate(CURRENT_RECORD.termin):"‚Äî",o=CURRENT_RECORD.cas_navstevy||"‚Äî",n=getStatus(CURRENT_RECORD.stav),ModalManager.createHeader(e,`
    <strong>Adresa:</strong> ${t}<br>
    <strong>Term√≠n:</strong> ${a} ${"‚Äî"!==o?"v "+o:""}<br>
    <strong>Stav:</strong> ${n.text}
  `)):""}async function showDetail(a){let e;if("string"==typeof a){if(!(e=WGS_DATA_CACHE.find(e=>e.id==a||e.reklamace_id==a)))return void wgsToast.error(t("record_not_found"))}else e=WGS_DATA_CACHE.find(e=>e.id==a.id||e.reklamace_id==a.reklamace_id)||a;autoAssignTechnician((CURRENT_RECORD=e).reklamace_id||e.cislo||e.id).catch(e=>logger.warn("Auto-assign technika se nezda≈ôilo:",e.message));Utils.getCustomerName(e),Utils.getAddress(e),e.termin&&formatDate(e.termin),e.cas_navstevy,getStatus(e.stav);var o=Utils.isCompleted(e);let n="";n=o?`
      <div class="detail-info-box">
        <div class="detail-info-box-title">Zak√°zka dokonƒçena</div>
        <div class="detail-info-box-subtitle">Vy≈ô√≠zeno dne ${e.updated_at?formatDate(e.updated_at):"‚Äî"} v ${(o=e.updated_at?new Date(e.updated_at):null)?o.getHours()+":"+String(o.getMinutes()).padStart(2,"0"):"‚Äî"}</div>
      </div>

      <div class="detail-buttons">
        ${CURRENT_USER&&"prodejce"===CURRENT_USER.role?"":`
          <button class="detail-btn detail-btn-primary" data-action="showContactMenu" data-id="${e.id}">Kontaktovat</button>
        `}
        <button class="detail-btn detail-btn-primary" data-action="showCustomerDetail" data-id="${e.id}">Detail z√°kazn√≠ka</button>
        ${e.original_reklamace_id?`
          <button class="detail-btn detail-btn-primary" data-action="showHistoryPDF" data-original-id="${e.original_reklamace_id}">Historie z√°kazn√≠ka</button>
        `:""}
        <button class="detail-btn detail-btn-primary" data-action="openKnihovnaPDF" data-id="${e.id}">KNIHOVNA PDF</button>
        <button class="detail-btn detail-btn-primary" data-action="showVideoteka" data-id="${e.id}">Videot√©ka</button>
      </div>
    `:`
      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        ${CURRENT_USER&&CURRENT_USER.is_admin?`
        <button class="btn" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem; background: #28a745; color: white;" data-action="vytvorCenovouNabidku" data-id="${e.id}">Vytvo≈ôit CN</button>
    `:""}
        ${CURRENT_USER&&"prodejce"===CURRENT_USER.role?"":`
        <button class="btn" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem; background: #1a1a1a; color: white;" data-action="startVisit" data-id="${e.id}">Zah√°jit n√°v≈°tƒõvu</button>
        <button class="btn" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem; background: #1a1a1a; color: white;" data-action="showCalendar" data-id="${e.id}">Napl√°novat term√≠n</button>
        <button class="btn" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem; background: #1a1a1a; color: white;" data-action="showContactMenu" data-id="${e.id}">Kontaktovat</button>
    `}
        <button class="btn" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem; background: #1a1a1a; color: white;" data-action="showCustomerDetail" data-id="${e.id}">Detail z√°kazn√≠ka</button>
        <button class="btn" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem; background: #1a1a1a; color: white;" data-action="showVideoteka" data-id="${e.id}">Videot√©ka</button>
        <button class="btn" style="width: 100%; padding: 0.5rem 0.75rem; min-height: 38px; font-size: 0.85rem; background: #1a1a1a; color: white;" data-action="closeDetail">Zav≈ô√≠t</button>
      </div>
    `;o=`
    ${createCustomerHeader()}

    <div class="modal-body">
      ${n}
    </div>
  `;ModalManager.show(o)}function closeDetail(){ModalManager.close()}async function showHistoryPDF(e){if(e)try{logger.log("üìö Naƒç√≠t√°m historii PDF z p≈Øvodn√≠ zak√°zky: "+e);var t=await fetch("/api/get_original_documents.php?reklamace_id="+encodeURIComponent(e));if(!t.ok)throw new Error(`HTTP ${t.status}: `+t.statusText);var a,o=await t.json();if("error"===o.status){if(o.message&&o.message.includes("nebyla nalezena"))return void wgsToast.error("P≈Øvodn√≠ zak√°zka byla smaz√°na.\n\nHistorie PDF nen√≠ k dispozici.");throw new Error(o.message||"Nepoda≈ôilo se naƒç√≠st dokumenty")}o.documents&&0!==o.documents.length?(a=o.documents[0],logger.log("Otev√≠r√°m PDF: "+a.file_path),zobrazPDFModal(a.file_path,e,"historie")):wgsToast.info("Historie PDF nen√≠ k dispozici.\n\nP≈Øvodn√≠ zak√°zka je≈°tƒõ nem√° vytvo≈ôen√Ω PDF dokument.")}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ historie PDF:",e),wgsToast.error(`Nepoda≈ôilo se naƒç√≠st historii PDF:
`+e.message)}else wgsToast.error("Chyb√≠ ID p≈Øvodn√≠ zak√°zky")}function normalizeCustomerData(e){var t,e={...e};return!e.jmeno&&e.zakaznik&&(e.jmeno=e.zakaznik),!e.zakaznik&&e.jmeno&&(e.zakaznik=e.jmeno),!e.adresa&&(e.ulice||e.mesto||e.psc)&&(t=[],e.ulice&&t.push(e.ulice),e.mesto&&t.push(e.mesto),e.psc&&t.push(e.psc),e.adresa=t.join(", ")),!e.adresa||e.ulice&&e.mesto||(t=e.adresa.split(",").map(e=>e.trim()),!e.ulice&&t[0]&&(e.ulice=t[0]),!e.mesto&&t[1]&&(e.mesto=t[1]),!e.psc&&t[2]&&(e.psc=t[2])),e}let startVisitInProgress=!1;function startVisit(a){var e,o;startVisitInProgress||(startVisitInProgress=!0,(e=WGS_DATA_CACHE.find(e=>e.id==a))?Utils.isCompleted(e)?(wgsToast.warning(t("visit_already_completed")),startVisitInProgress=!1):(e=normalizeCustomerData(e),localStorage.setItem("currentCustomer",JSON.stringify(e)),localStorage.setItem("visitStartTime",(new Date).toISOString()),o="photoSections_"+e.id,localStorage.removeItem(o),logger.log("Normalizovan√° data ulo≈æena:",e),window.location.href="photocustomer.php?new=true"):(wgsToast.error(t("record_not_found")),startVisitInProgress=!1))}function vytvorCenovouNabidku(e){e?window.location.href="cenova-nabidka.php?reklamace_id="+encodeURIComponent(e):wgsToast.error("Chyb√≠ ID reklamace")}async function saveData(o,e){try{var n=await getCSRFToken();let a=new FormData;Object.keys(o).forEach(e=>{a.append(e,o[e])}),a.append("action","update"),a.append("csrf_token",n);var i=await fetch("/app/controllers/save.php",{method:"POST",body:a}),r=await i.json();if(!i.ok)throw new Error(`HTTP ${i.status}: `+(r.message||i.statusText));"success"===r.status?(Object.keys(o).forEach(e=>{var t=WGS_DATA_CACHE.find(e=>e.id==o.id);t&&"action"!==e&&(t[e]=o[e]),CURRENT_RECORD&&CURRENT_RECORD.id==o.id&&"action"!==e&&(CURRENT_RECORD[e]=o[e])}),wgsToast.success(e),await loadAll(),o.id?(closeDetail(),setTimeout(()=>showDetail(o.id),100)):closeDetail()):wgsToast.error(t("error")+": "+(r.message||t("failed_to_save")))}catch(e){logger.error("Chyba p≈ôi ukl√°d√°n√≠:",e),wgsToast.error(t("save_error")+": "+e.message)}}function showLoading(e=null){e=e||t("loading");var a=document.getElementById("loadingOverlay"),o=document.getElementById("loadingText");a&&o&&(o.textContent=e,a.classList.add("show"))}function hideLoading(){var e=document.getElementById("loadingOverlay");e&&e.classList.remove("show")}function showCalendar(t){var e=WGS_DATA_CACHE.find(e=>e.id==t);e&&(CURRENT_RECORD=e,SELECTED_DATE=null,SELECTED_TIME=null,e=`
    ${createCustomerHeader()}

    <!-- Vybran√Ω term√≠n - fixn√≠ nad kalend√°≈ôem -->
    <div id="selectedDateDisplay" style="display: none; background: #f5f5f5; border: 2px solid #666; color: #333; font-size: 0.85rem; padding: 0.5rem 1rem; margin: 0 1rem; border-radius: 4px; font-weight: 600; text-align: center; font-family: inherit;"></div>

    <!-- Varov√°n√≠ o kolizi - skryt√©, zobraz√≠ se p≈ôi v√Ωbƒõru obsazen√©ho ƒçasu -->
    <div id="collisionWarning" style="display: none; background: #fee; border: 2px solid #c00; color: #900; font-size: 0.85rem; padding: 0.5rem 1rem; margin: 0.5rem 1rem 0; border-radius: 4px; font-weight: 600; text-align: center; font-family: inherit;"></div>

    <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 1rem;">
      <div class="calendar-container">
        <div id="calGrid"></div>
        <div id="distanceInfo"></div>
        <div id="dayBookings"></div>
        <div id="timeGrid"></div>
      </div>
    </div>

    <div class="detail-buttons">
      <button class="detail-btn detail-btn-primary" data-action="saveSelectedDate">Ulo≈æit term√≠n</button>
      <button class="detail-btn detail-btn-secondary" data-action="showDetail">Zpƒõt</button>
    </div>
  `,ModalManager.show(e),e=new Date,CAL_MONTH=e.getMonth(),CAL_YEAR=e.getFullYear(),renderCalendar(CAL_MONTH,CAL_YEAR))}function previousMonth(){var e=new Date,a=e.getMonth(),e=e.getFullYear();let o=CAL_MONTH-1,n=CAL_YEAR;o<0&&(o=11,n--),n<e||n===e&&o<a?wgsToast.warning(t("cannot_show_past_months")):(CAL_MONTH=o,CAL_YEAR=n,renderCalendar(CAL_MONTH,CAL_YEAR))}function nextMonth(e){e&&e.stopPropagation(),11<++CAL_MONTH&&(CAL_MONTH=0,CAL_YEAR++),renderCalendar(CAL_MONTH,CAL_YEAR)}function renderCalendar(i,r){var e=document.getElementById("calGrid"),a=(e.innerHTML="",document.createElement("div")),a=(a.className="calendar-controls",a.innerHTML=`
    <button class="calendar-nav-btn" data-action="previousMonth">‚óÄ P≈ôedchoz√≠</button>
    <span class="calendar-month-title">${["Leden","√önor","B≈ôezen","Duben","Kvƒõten","ƒåerven","ƒåervenec","Srpen","Z√°≈ô√≠","≈ò√≠jen","Listopad","Prosinec"][i]} ${r}</span>
    <button class="calendar-nav-btn" data-action="nextMonth">Dal≈°√≠ ‚ñ∂</button>
  `,e.appendChild(a),document.createElement("div")),d=(a.className="calendar-weekdays",a.innerHTML=`<div>${t("monday")}</div><div>${t("tuesday")}</div><div>${t("wednesday")}</div><div>${t("thursday")}</div><div>${t("friday")}</div><div>${t("saturday")}</div><div>${t("sunday")}</div>`,e.appendChild(a),document.createElement("div")),a=(d.className="calendar-days",new Date(r,i,1)),o=new Date(r,i+1,0).getDate(),n=(a.getDay()+6)%7;let s=new Set;WGS_DATA_CACHE.forEach(e=>{var t,a;e.termin&&e.id!==CURRENT_RECORD?.id&&3===(e=e.termin.split(".")).length&&(t=parseInt(e[0]),a=parseInt(e[1]),e=parseInt(e[2]),a===i+1)&&e===r&&s.add(t)});for(let e=0;e<n;e++){var l=document.createElement("div");l.className="cal-day empty",d.appendChild(l)}var c=new Date;c.setHours(0,0,0,0);for(let n=1;n<=o;n++){let a=document.createElement("div");a.className="cal-day";var p=new Date(r,i,n);p.setHours(0,0,0,0);let o=p<c;o?(a.classList.add("disabled"),a.title="Nelze vybrat minul√© datum",a.style.opacity="0.3",a.style.cursor="not-allowed",a.style.backgroundColor="#f0f0f0"):s.has(n)&&(a.classList.add("occupied"),a.title="Tento den m√° ji≈æ nƒõjak√© term√≠ny"),a.textContent=n,a.onclick=()=>{var e;o?wgsToast.warning(t("cannot_select_past_date")):(SELECTED_DATE=n+`.${i+1}.`+r,document.querySelectorAll(".cal-day").forEach(e=>e.classList.remove("selected")),a.classList.add("selected"),e="Vybran√Ω den: "+SELECTED_DATE,document.getElementById("selectedDateDisplay").textContent=e,renderTimeGrid(),showDayBookingsWithDistances(SELECTED_DATE))},d.appendChild(a)}e.appendChild(d)}async function getDistance(t,a){var o=t+"|"+a;if(DISTANCE_CACHE[o])return DISTANCE_CACHE[o];try{let e=new AbortController;var n=setTimeout(()=>e.abort(),15e3),i=await fetchCsrfToken(),r=await fetch("/app/controllers/get_distance.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({origin:t,destination:a,csrf_token:i}),signal:e.signal});if(clearTimeout(n),r.ok){var d,s=await r.json();if(("success"===s.status||!0===s.success)&&s.distance)return d={km:(s.distance.value/1e3).toFixed(1),text:s.distance.text,duration:s.duration?s.duration.text:null},DISTANCE_CACHE[o]=d,CacheManager.save(),d}}catch(e){}return null}async function getDistancesBatch(e){e=e.map(e=>getDistance(e.from,e.to));return Promise.all(e)}async function showDayBookingsWithDistances(o){let n=document.getElementById("distanceInfo");var e=document.getElementById("dayBookings");if(n&&e){var i=(WGS_DATA_CACHE=Array.isArray(WGS_DATA_CACHE)?WGS_DATA_CACHE:[]).filter(e=>e.termin===o&&e.id!==CURRENT_RECORD?.id);if(i.sort((e,t)=>{e=e.cas_navstevy||"00:00",t=t.cas_navstevy||"00:00";return e.localeCompare(t)}),(r=Utils.getAddress(CURRENT_RECORD))&&"‚Äî"!==r){var r=Utils.addCountryToAddress(r),d=WGS_ADDRESS+"|"+r;if(void 0!==DISTANCE_CACHE[d]||(n.innerHTML=`<div style="text-align: center; color: var(--c-grey); font-size: 0.7rem; padding: 0.5rem;">${t("loading")}</div>`),0===i.length)getDistance(WGS_ADDRESS,r).then(e=>{n.innerHTML=e?`
            <div class="distance-info-panel">
              <div class="distance-info-title">Informace o trase</div>
              <div class="distance-stats">
                <div class="distance-stat">
                  <div class="distance-stat-label">Vzd√°lenost</div>
                  <div class="distance-stat-value">${e.km} <span class="distance-stat-unit">km</span></div>
                </div>
                <div class="distance-stat">
                  <div class="distance-stat-label">ƒåas j√≠zdy</div>
                  <div class="distance-stat-value">${e.duration||"‚Äî"}</div>
                </div>
              </div>
              <div class="route-info">
                <div class="route-item">
                  <div class="route-item-left">
                    <span>WGS S√≠dlo</span>
                    <span class="route-arrow">‚Üí</span>
                    <span>${Utils.getCustomerName(CURRENT_RECORD)}</span>
                  </div>
                  <span class="route-distance">${e.km} km</span>
                </div>
              </div>
            </div>
          `:""}).catch(e=>{logger.error("Chyba p≈ôi v√Ωpoƒçtu vzd√°lenosti:",e),n.innerHTML=""}),e.innerHTML="";else{var s=[];let t=WGS_ADDRESS;for(let e=0;e<i.length;e++){var l=i[e],c=Utils.getAddress(l);c&&"‚Äî"!==c&&(c=Utils.addCountryToAddress(c),s.push({from:t,to:c,booking:l}),t=c)}s.push({from:t,to:r,booking:null,isNew:!0});var p=await getDistancesBatch(s.map(e=>({from:e.from,to:e.to})));let a=0;var m=[];for(let e=0;e<s.length;e++){var u,g,h,v=s[e],f=p[e];f&&(a+=parseFloat(f.km),u=0===e?"WGS S√≠dlo":Utils.getCustomerName(s[e-1].booking),g=v.isNew?Utils.getCustomerName(CURRENT_RECORD):Utils.getCustomerName(v.booking),h=v.isNew?SELECTED_TIME||"‚Äî":v.booking?.cas_navstevy||"‚Äî",m.push({from:u,to:g,time:h,km:f.km,isNew:v.isNew}))}d=m.map(e=>`
    <div class="route-item ${e.isNew?"new-customer":""}">
      <div class="route-item-left">
        <span>${e.from}</span>
        <span class="route-arrow">‚Üí</span>
        <span>${e.to} ${"‚Äî"!==e.time?"("+e.time+")":""}</span>
      </div>
      <span class="route-distance">${e.km} km</span>
    </div>
  `).join("");if(n.innerHTML=`
    <div class="distance-info-panel">
      <div class="distance-info-title">Trasa pro ${o}</div>
      <div class="distance-stats">
        <div class="distance-stat">
          <div class="distance-stat-label">Celkem za den</div>
          <div class="distance-stat-value">${a.toFixed(1)} <span class="distance-stat-unit">km</span></div>
        </div>
        <div class="distance-stat">
          <div class="distance-stat-label">Poƒçet n√°v≈°tƒõv</div>
          <div class="distance-stat-value">${i.length+1}</div>
        </div>
      </div>
      <div class="route-info">
        ${d}
      </div>
    </div>
  `,0<i.length){let a='<div class="day-bookings" style="margin-top: 0.5rem;"><h4>Term√≠ny v tento den:</h4>';i.forEach(e=>{var t=Utils.getCustomerName(e);a+=`
        <div class="booking-item" data-action="showBookingDetail" data-id="${e.id}">
          <strong>${e.cas_navstevy||"‚Äî"}</strong> ‚Äî ${t}
          <span style="opacity:.7">(${Utils.getProduct(e)})</span>
        </div>`}),a+="</div>",e.innerHTML=a}else e.innerHTML=""}}else n.innerHTML="",e.innerHTML=""}}function showBookingDetail(a){let e;if("string"==typeof a||"number"==typeof a){if(!(e=WGS_DATA_CACHE.find(e=>e.id==a||e.reklamace_id==a)))return void wgsToast.error(t("record_not_found"))}else e=a;var o=Utils.getCustomerName(e),n=Utils.getAddress(e),i=Utils.getProduct(e),r=e.popis_problemu||"‚Äî",o=`
    ${ModalManager.createHeader("Detail obsazen√©ho term√≠nu",'<p style="color: var(--c-error); font-weight: 600;">Tento term√≠n je ji≈æ obsazen</p>')}
    
    <div class="modal-body">
      <div style="padding: 1.5rem; background: rgba(139, 0, 0, 0.05); border: 2px solid var(--c-error); margin-bottom: 1.5rem;">
        <div class="info-grid" style="font-family: 'Poppins', sans-serif;">
          <div class="info-label">Z√°kazn√≠k:</div>
          <div class="info-value"><strong>${o}</strong></div>
          
          <div class="info-label">Term√≠n:</div>
          <div class="info-value"><strong>${formatDate(e.termin||"")} v ${e.cas_navstevy||"‚Äî"}</strong></div>
          
          <div class="info-label">Adresa:</div>
          <div class="info-value">${n}</div>
          
          <div class="info-label">Produkt:</div>
          <div class="info-value">${i}</div>
          
          <div class="info-label">Popis:</div>
          <div class="info-value" style="line-height: 1.6;">${r}</div>
        </div>
      </div>
    </div>

    <div class="detail-buttons">
      <button class="detail-btn detail-btn-secondary" data-action="showCalendarBack">Zpƒõt na kalend√°≈ô</button>
    </div>
  `;ModalManager.show(o)}function renderTimeGrid(){var a=document.getElementById("timeGrid");a.innerHTML="";let g=WGS_DATA_CACHE.filter(e=>e.termin===SELECTED_DATE&&e.cas_navstevy&&e.id!==CURRENT_RECORD?.id).sort((e,t)=>e.cas_navstevy.localeCompare(t.cas_navstevy)),h={};g.forEach(e=>{var t=Utils.getCustomerName(e);h[e.cas_navstevy]={zakaznik:t,model:Utils.getProduct(e),record:e}});for(let t=8;t<=19;t++)for(var o of[0,30]){let u=String(t).padStart(2,"0")+":"+(0===o?"00":"30"),e=document.createElement("div");e.className="time-slot",h[u]&&(e.classList.add("occupied"),e.title=h[u].zakaznik+" ‚Äî "+h[u].model),e.textContent=u,e.onclick=async()=>{SELECTED_TIME=u,document.querySelectorAll(".time-slot").forEach(e=>e.classList.remove("selected")),e.classList.add("selected");var a=document.getElementById("selectedDateDisplay"),a=(a.textContent=`Vybran√Ω term√≠n: ${SELECTED_DATE} ‚Äî `+SELECTED_TIME,a.style.display="block",document.getElementById("collisionWarning"));if(h[u]&&a){a.innerHTML=`KOLIZE: ${h[u].zakaznik} ‚Äî ${h[u].model}<br><span style="font-size: 0.75rem; opacity: 0.8;">Poƒç√≠t√°m vzd√°lenost...</span>`,a.style.display="block";let t=h[u].record;var o=Utils.getAddress(CURRENT_RECORD),n=Utils.getAddress(t);if(o&&"‚Äî"!==o&&n&&"‚Äî"!==n)try{var i,r,d,s,l=g.findIndex(e=>e.id===t.id),c=0<l?g[l-1]:null,p=l<g.length-1?g[l+1]:null,m=await getDistance(Utils.addCountryToAddress(o),Utils.addCountryToAddress(n));let e=`KOLIZE: ${h[u].zakaznik} ‚Äî `+h[u].model;m&&(e+=`<div class="collision-distance-box">Vzd√°lenost mezi z√°kazn√≠ky: <strong>${m.km} km</strong></div>`),(c||p)&&(e+='<div class="collision-context">',c&&(i=Utils.getAddress(c))&&"‚Äî"!==i&&(r=await getDistance(Utils.addCountryToAddress(i),Utils.addCountryToAddress(o)))&&(e+=`<span class="collision-route">Od ${Utils.getCustomerName(c)} (${c.cas_navstevy}): <strong>${r.km} km</strong></span>`),p&&(d=Utils.getAddress(p))&&"‚Äî"!==d&&(s=await getDistance(Utils.addCountryToAddress(o),Utils.addCountryToAddress(d)))&&(e+=`<span class="collision-route">K ${Utils.getCustomerName(p)} (${p.cas_navstevy}): <strong>${s.km} km</strong></span>`),e+="</div>"),a.innerHTML=e}catch(e){logger.error("Chyba p≈ôi v√Ωpoƒçtu vzd√°lenosti kolize:",e),a.innerHTML=`KOLIZE: ${h[u].zakaznik} ‚Äî `+h[u].model}}else a&&(a.style.display="none")},a.appendChild(e)}}async function saveSelectedDate(){if(SELECTED_DATE&&SELECTED_TIME)if(CURRENT_RECORD){var a=(WGS_DATA_CACHE=Array.isArray(WGS_DATA_CACHE)?WGS_DATA_CACHE:[]).find(e=>e.termin===SELECTED_DATE&&e.cas_navstevy===SELECTED_TIME&&e.id!==CURRENT_RECORD.id);if(a){a=Utils.getCustomerName(a);if(!await wgsConfirm(t("confirm_appointment_collision").replace("{date}",SELECTED_DATE).replace("{time}",SELECTED_TIME).replace("{customer}",a),t("confirm_yes")||"Ano",t("confirm_no")||"Ne"))return}showLoading(t("saving_appointment"));a=performance.now();logger.log("‚è±Ô∏è START ukl√°d√°n√≠ term√≠nu...");try{var e=performance.now(),o=await getCSRFToken(),n=performance.now(),i=(logger.log(`‚è±Ô∏è CSRF token z√≠sk√°n za ${(n-e).toFixed(0)}ms`),new FormData),r=(i.append("action","update"),i.append("id",CURRENT_RECORD.id),i.append("termin",SELECTED_DATE),i.append("cas_navstevy",SELECTED_TIME),i.append("stav","DOMLUVEN√Å"),i.append("csrf_token",o),showLoading(t("saving_appointment_to_db")),performance.now()),d=(logger.log("‚è±Ô∏è Odes√≠l√°m POST request na save.php..."),await fetch("/app/controllers/save.php",{method:"POST",body:i})),s=performance.now(),l=(logger.log(`‚è±Ô∏è POST request dokonƒçen za ${(s-r).toFixed(0)}ms`),await d.json());if(!d.ok)throw new Error(`HTTP ${d.status}: `+(l.message||d.statusText));if("success"===l.status){var c=performance.now(),p=(logger.log(`‚è±Ô∏è SUCCESS block started: ${(c-a).toFixed(0)}ms od zaƒç√°tku`),performance.now()),m=(CURRENT_RECORD.termin=SELECTED_DATE,CURRENT_RECORD.cas_navstevy=SELECTED_TIME,CURRENT_RECORD.stav="DOMLUVEN√Å",performance.now()),u=(logger.log(`‚è±Ô∏è CURRENT_RECORD update: ${(m-p).toFixed(0)}ms`),performance.now()),g=WGS_DATA_CACHE.find(e=>e.id===CURRENT_RECORD.id),h=(g&&(g.termin=SELECTED_DATE,g.cas_navstevy=SELECTED_TIME,g.stav="DOMLUVEN√Å"),performance.now()),v=(logger.log(`‚è±Ô∏è Cache update: ${(h-u).toFixed(0)}ms`),performance.now()),f=(hideLoading(),performance.now()),y=(logger.log(`‚è±Ô∏è hideLoading(): ${(f-v).toFixed(0)}ms`),performance.now()),b=(logger.log(`‚è±Ô∏è TƒöSNƒö P≈òED ALERT: ${(y-a).toFixed(0)}ms od zaƒç√°tku`),wgsToast.success(t("appointment_saved_success").replace("{date}",SELECTED_DATE).replace("{time}",SELECTED_TIME)),performance.now()),w=(logger.log(`‚è±Ô∏è alert() dokonƒçen: ${(b-y).toFixed(0)}ms`),performance.now()),x=(sendAppointmentConfirmation(CURRENT_RECORD,SELECTED_DATE,SELECTED_TIME).catch(e=>logger.warn("‚ö† Email se nepoda≈ôilo odeslat:",e.message)),performance.now()),k=(logger.log(`‚è±Ô∏è sendAppointmentConfirmation() launch: ${(x-w).toFixed(0)}ms`),performance.now());logger.log("‚è±Ô∏è Aktualizuji detail...");let e=CURRENT_RECORD.id;var C=performance.now(),E=(closeDetail(),performance.now()),_=(logger.log(`‚è±Ô∏è closeDetail(): ${(E-C).toFixed(0)}ms`),performance.now()),T=(setTimeout(()=>showDetail(e),100),performance.now()),R=(logger.log(`‚è±Ô∏è setTimeout() scheduled: ${(T-_).toFixed(0)}ms`),performance.now()),z=(logger.log(`‚è±Ô∏è Detail aktualizov√°n za ${(R-k).toFixed(0)}ms`),performance.now());logger.log(`‚è±Ô∏è CELKOV√ù ƒåAS: ${(z-a).toFixed(0)}ms (${((z-a)/1e3).toFixed(1)}s)`)}else hideLoading(),wgsToast.error(t("error")+": "+(l.message||t("failed_to_save")))}catch(e){hideLoading(),logger.error("Chyba p≈ôi ukl√°d√°n√≠:",e),wgsToast.error(t("save_error")+": "+e.message);n=performance.now();logger.log(`‚è±Ô∏è ƒåas do chyby: ${(n-a).toFixed(0)}ms`)}}else wgsToast.warning(t("no_record_to_save"));else wgsToast.warning(t("select_date_and_time"))}function showContactMenu(e){var t=CURRENT_RECORD.telefon||"",a=Utils.getAddress(CURRENT_RECORD),e=`
    ${createCustomerHeader()}

    <div class="modal-body">
      <div class="detail-buttons">
        ${t?`<a href="tel:${t}" class="detail-btn detail-btn-primary" style="text-decoration: none;">Zavolat</a>`:""}
        <button class="detail-btn detail-btn-primary" data-action="openCalendarFromDetail" data-id="${e}">Term√≠n n√°v≈°tƒõvy</button>
        ${t?`<button class="detail-btn detail-btn-primary" data-action="sendContactAttemptEmail" data-id="${e}" data-phone="${t}">Odeslat SMS</button>`:""}
        ${a&&"‚Äî"!==a?`<a href="https://waze.com/ul?q=${encodeURIComponent(a)}&navigate=yes" class="detail-btn detail-btn-primary" style="text-decoration: none;" target="_blank">Navigovat (Waze)</a>`:""}
        ${a&&"‚Äî"!==a?`<a href="https://www.google.com/maps?q=${encodeURIComponent(a)}&layer=c" class="detail-btn detail-btn-primary" style="text-decoration: none;" target="_blank">Google Street View</a>`:""}
        <button class="detail-btn detail-btn-primary" data-action="showDetail">Zpƒõt</button>
      </div>
    </div>
  `;ModalManager.show(e)}function toggleMap(){var e=document.getElementById("mapContent"),t=document.getElementById("mapToggleIcon");e.classList.contains("active")?(e.classList.remove("active"),t.classList.remove("active")):(e.classList.add("active"),t.classList.add("active"),e.dataset.loaded||(e.dataset.loaded="true",loadMapAndRoute()))}async function loadMapAndRoute(){var a=document.getElementById("mapContainer");if(CURRENT_RECORD){var e=Utils.getAddress(CURRENT_RECORD);if(e&&"‚Äî"!==e){e=Utils.addCountryToAddress(e);try{var o=encodeURIComponent(WGS_ADDRESS),n=encodeURIComponent(e);a.innerHTML=`
      <div style="background: var(--c-bg); padding: 1rem; text-align: center; border: 1px solid var(--c-border);">
        <div style="font-size: 0.8rem; color: var(--c-grey); margin-bottom: 0.8rem; line-height: 1.4;">
          <strong>Z:</strong> WGS<br>
          <strong>Do:</strong> ${e}<br>
          <strong>Vzd√°lenost:</strong> <span id="mapDistance">Naƒç√≠t√°m...</span><br>
          <strong>ƒåas:</strong> <span id="mapDuration">‚Äî</span>
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: center;">
          <a href="https://www.google.com/maps/dir/?api=1&origin=${o}&destination=${n}&travelmode=driving"
             class="btn" target="_blank" style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.75rem;">
            Google Maps
          </a>
          <a href="https://waze.com/ul?q=${n}&navigate=yes"
             class="btn" target="_blank" style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.75rem;">
            Waze
          </a>
        </div>
      </div>
    `,document.getElementById("mapDistance").textContent="‚Äî",document.getElementById("mapDuration").textContent="‚Äî"}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ mapy:",e),a.innerHTML=`
      <div class="map-error">
        Nepoda≈ôilo se naƒç√≠st mapu<br>
        <small>${e.message}</small>
      </div>
    `}}else a.innerHTML=`<div class="map-error">${t("customer_address_not_available")}</div>`}}async function showCustomerDetail(e){var t=Utils.getCustomerName(CURRENT_RECORD),a=CURRENT_RECORD.telefon||"",o=CURRENT_RECORD.email||"",n=Utils.getAddress(CURRENT_RECORD),i=Utils.getProduct(CURRENT_RECORD),r=CURRENT_RECORD.popis_problemu||"",d=CURRENT_RECORD.cislo||"",s=CURRENT_RECORD.reklamace_id||"",l=CURRENT_RECORD.zadavatel_jmeno||CURRENT_RECORD.created_by_name||CURRENT_RECORD.prodejce||"",c=CURRENT_RECORD.datum_prodeje||"",p=CURRENT_RECORD.datum_reklamace||"",m=CURRENT_RECORD.provedeni||"",u=CURRENT_RECORD.barva||"",g=CURRENT_RECORD.doplnujici_info||"",h=CURRENT_RECORD.fakturace_firma||"CZ",v=await loadPhotosFromDB(s);let f=0<v.length?v:[];if(0===f.length){v=localStorage.getItem("photoSections_"+e);if(v)try{var y=JSON.parse(v);Object.values(y).forEach(e=>{e.photos&&Array.isArray(e.photos)&&(f=f.concat(e.photos))})}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ fotek:",e)}}v=`
    ${createCustomerHeader()}

    <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 1rem;">

      <!-- KOMPAKTN√ç INFO BLOK -->
      <div style="background: #1a1a1a; border: none; border-radius: 4px; padding: 0.75rem; margin-bottom: 1rem;">
        <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; font-size: 0.9rem;">
          <span style="color: #aaa; font-weight: 600;">ƒå√≠slo objedn√°vky:</span>
          <input type="text" style="border: 1px solid #333; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #fff; color: #000;" value="${Utils.escapeHtml(s)}" readonly>

          <span style="color: #aaa; font-weight: 600;">Zadavatel:</span>
          <input type="text" style="border: 1px solid #333; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #eee; color: #000;" value="${Utils.escapeHtml(l)}" readonly placeholder="Prodejce/U≈æivatel">

          <span style="color: #aaa; font-weight: 600;">ƒå√≠slo reklamace:</span>
          <input type="text" id="edit_cislo" style="border: 1px solid #333; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #fff; color: #000;" value="${Utils.escapeHtml(d)}">

          <span style="color: #aaa; font-weight: 600;">Fakturace:</span>
          <span style="color: #fff; font-weight: 600; padding: 0.25rem 0;">${"SK"===h.toUpperCase()?"Slovensko (SK)":"ƒåesk√° republika (CZ)"}</span>

          <span style="color: #aaa; font-weight: 600;">Datum prodeje:</span>
          <input type="text" id="edit_datum_prodeje" style="border: 1px solid #333; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #fff; color: #000;" value="${Utils.escapeHtml(c)}" placeholder="DD.MM.RRRR">

          <span style="color: #aaa; font-weight: 600;">Datum reklamace:</span>
          <input type="text" id="edit_datum_reklamace" style="border: 1px solid #333; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #fff; color: #000;" value="${Utils.escapeHtml(p)}" placeholder="DD.MM.RRRR">

          <span style="color: #aaa; font-weight: 600;">Jm√©no:</span>
          <input type="text" id="edit_jmeno" style="border: 1px solid #333; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #fff; color: #000;" value="${t}">

          <span style="color: #aaa; font-weight: 600;">Telefon:</span>
          <input type="tel" id="edit_telefon" style="border: 1px solid #333; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #fff; color: #000;" value="${a}">

          <span style="color: #aaa; font-weight: 600;">Email:</span>
          <input type="email" id="edit_email" style="border: 1px solid #333; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #fff; color: #000;" value="${o}">

          <span style="color: #aaa; font-weight: 600;">Adresa:</span>
          <input type="text" id="edit_adresa" style="border: 1px solid #333; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #fff; color: #000;" value="${n}">

          <span style="color: #aaa; font-weight: 600;">Model:</span>
          <input type="text" id="edit_model" style="border: 1px solid #333; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #fff; color: #000;" value="${i}">

          <span style="color: #aaa; font-weight: 600;">Proveden√≠:</span>
          <input type="text" id="edit_provedeni" style="border: 1px solid #333; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #fff; color: #000;" value="${Utils.escapeHtml(m)}" placeholder="L√°tka / K≈Ø≈æe">

          <span style="color: #aaa; font-weight: 600;">Barva:</span>
          <input type="text" id="edit_barva" style="border: 1px solid #333; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.9rem; background: #fff; color: #000;" value="${Utils.escapeHtml(u)}">
        </div>
      </div>

      <!-- DOPL≈áUJ√çC√ç INFORMACE OD PRODEJCE -->
      <div style="margin-bottom: 1rem;">
        <label style="display: block; color: #aaa; font-weight: 600; font-size: 0.8rem; margin-bottom: 0.25rem;">Dopl≈àuj√≠c√≠ informace od prodejce:</label>
        <textarea id="edit_doplnujici_info"
                  style="width: 100%; border: 1px solid #333; padding: 0.5rem; border-radius: 3px; font-size: 0.9rem; min-height: 40px; background: #fff; color: #000; resize: none; font-family: inherit; overflow: hidden;"
                  placeholder="Zadejte dopl≈àuj√≠c√≠ informace od prodejce"
                  oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'">${Utils.escapeHtml(g)}</textarea>
      </div>

      <!-- POPIS PROBL√âMU OD Z√ÅKAZN√çKA -->
      <div style="margin-bottom: 2rem;">
        <label style="display: block; color: #aaa; font-weight: 600; font-size: 0.8rem; margin-bottom: 0.25rem;">Popis probl√©mu od z√°kazn√≠ka:</label>
        <textarea id="edit_popis_problemu"
                  style="width: 100%; border: 1px solid #333; padding: 0.5rem; border-radius: 3px; font-size: 0.9rem; min-height: 40px; background: #fff; color: #000; resize: none; font-family: inherit; overflow: hidden;"
                  placeholder="Zadejte popis probl√©mu od z√°kazn√≠ka"
                  oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'">${Utils.escapeHtml(r)}</textarea>
      </div>

      <!-- FOTOT√âKA -->
      <div style="margin-bottom: 1rem; background: #1a1a1a; border-radius: 6px; padding: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <label style="color: #aaa; font-weight: 600; font-size: 0.85rem;" id="fototeka-nadpis">Fototeka (${f.length})</label>
          <button type="button"
                  data-action="otevritVyberFotek"
                  data-id="${s}"
                  style="background: #333; color: #fff; border: 1px solid #555; padding: 0.4rem 0.8rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
            Pridat fotky
          </button>
        </div>
        <input type="file"
               id="fototeka-input-${s}"
               accept="image/*"
               multiple
               style="display: none;"
               data-reklamace-id="${s}">
        <div id="fototeka-grid" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 60px;">
          ${0<f.length?f.map((e,t)=>{var a="object"==typeof e?e.photo_path:e,e="object"==typeof e?e.id:null,o=a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/'/g,"\\'");return`
              <div class="foto-wrapper" style="position: relative; width: 60px; height: 60px; flex-shrink: 0;">
                <img src='${a}'
                     style='width: 60px; height: 60px; object-fit: cover; border: 1px solid #444; cursor: pointer; border-radius: 4px;'
                     alt='Fotka ${t+1}'
                     data-action="showPhotoFullscreen"
                     data-url="${o}">
                ${e?`
                  <button class="foto-delete-btn"
                          data-action="smazatFotku"
                          data-photo-id="${e}"
                          data-url="${o}"
                          title="Smazat fotku">
                    x
                  </button>
                `:""}
              </div>
            `}).join(""):`
            <p style="color: #666; font-size: 0.85rem; margin: 0; padding: 0.5rem 0;">Zadne fotografie</p>
          `}
        </div>
        <div id="fototeka-nahravani" style="display: none; margin-top: 0.75rem; padding: 0.5rem; background: #222; border-radius: 4px;">
          <p style="color: #aaa; font-size: 0.8rem; margin: 0;">Nahravani fotek...</p>
          <div style="background: #333; height: 4px; border-radius: 2px; margin-top: 0.5rem; overflow: hidden;">
            <div id="fototeka-progress" style="background: #fff; height: 100%; width: 0%; transition: width 0.3s;"></div>
          </div>
        </div>
      </div>

      <!-- PDF DOKUMENTY - nyn√≠ jako knihovna s mo≈ænost√≠ nahr√°t intern√≠ PDF -->
      <div style="margin-bottom: 1rem;">
        <label style="display: block; color: #aaa; font-weight: 600; font-size: 0.8rem; margin-bottom: 0.5rem;">KNIHOVNA PDF:</label>
        <button class="btn customer-detail-btn"
                data-action="openKnihovnaPDF"
                data-id="${e}">
          KNIHOVNA PDF
        </button>
      </div>

      ${CURRENT_USER.is_admin?`
        <div style="border-top: 1px solid #333; padding-top: 1rem; margin-top: 1rem;">
          <button class="btn customer-detail-btn danger" data-action="deleteReklamace" data-id="${e}">
            Smazat reklamaci
          </button>
          <p style="font-size: 0.7rem; color: #666; margin-top: 0.25rem; text-align: center;">Sma≈æe v≈°e vƒçetnƒõ fotek a PDF</p>
        </div>
      `:""}

      <div class="detail-buttons">
        <button class="detail-btn detail-btn-primary" data-action="saveAllCustomerData" data-id="${e}">Ulo≈æit zmƒõny</button>
        <button class="detail-btn detail-btn-primary" data-action="showDetail" data-id="${e}">Zpƒõt</button>
      </div>

    </div>
  `;ModalManager.show(v),setTimeout(()=>{document.querySelectorAll("#edit_doplnujici_info, #edit_popis_problemu").forEach(e=>{e&&(e.style.height="auto",e.style.height=e.scrollHeight+"px")})},50)}function zobrazPDFModal(a,o,e="report"){let n="historie"===e?"Historie PDF":"KNIHOVNA PDF",t=document.createElement("div");t.id="pdfModalOverlay",t.style.cssText=`
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.95); z-index: 10003;
    display: flex; flex-direction: column;
  `;var e=document.createElement("div"),i=(e.style.cssText=`
    flex-shrink: 0; padding: 12px 16px;
    background: #222; color: white;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #444;
  `,e.innerHTML=`
    <div>
      <div style="font-weight: 600; font-size: 1rem;">${n}</div>
      <div style="font-size: 0.75rem; opacity: 0.7;">ID: ${o||"-"}</div>
    </div>
    <button id="pdfCloseBtn" style="
      background: #555; color: white; border: none;
      padding: 10px 20px; border-radius: 6px;
      font-weight: 600; font-size: 0.9rem; cursor: pointer;
    ">Zav≈ô√≠t</button>
  `,document.createElement("div")),r=(i.style.cssText="flex: 1; overflow: hidden; display: flex; align-items: center; justify-content: center; padding: 16px;",document.createElement("iframe")),r=(r.src=a,r.style.cssText="width: 100%; height: 100%; max-width: 900px; border: none; background: white; border-radius: 8px;",i.appendChild(r),document.createElement("div")),d=(r.style.cssText=`
    flex-shrink: 0; padding: 12px 16px;
    background: #222; border-top: 1px solid #444;
    display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;
  `,document.createElement("button"));d.textContent="St√°hnout",d.style.cssText="padding: 12px 24px; font-size: 0.9rem; font-weight: 600; background: #444; color: white; border: none; border-radius: 6px; cursor: pointer;",d.onclick=()=>{var e=document.createElement("a");e.href=a,e.download=`WGS_PDF_${o||"dokument"}.pdf`,e.click()};let s=document.createElement("button");s.textContent="Sd√≠let",s.style.cssText="padding: 12px 24px; font-size: 0.9rem; font-weight: 600; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer;",s.onclick=async()=>{if(navigator.share)try{s.textContent="Naƒç√≠t√°m...";var e=await(await fetch(a)).blob(),t=new File([e],`WGS_PDF_${o||"dokument"}.pdf`,{type:"application/pdf"});await navigator.share({files:[t],title:n})}catch(e){"AbortError"!==e.name&&wgsToast.error("Chyba: "+e.message)}finally{s.textContent="Sd√≠let"}else wgsToast.info("Sd√≠len√≠ nen√≠ podporov√°no. Pou≈æijte tlaƒç√≠tko St√°hnout.")};var l=document.createElement("button");l.textContent="Zav≈ô√≠t",l.style.cssText="padding: 12px 24px; font-size: 0.9rem; font-weight: 600; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;",l.onclick=()=>t.remove(),r.appendChild(d),r.appendChild(s),r.appendChild(l),t.appendChild(e),t.appendChild(i),t.appendChild(r),e.querySelector("#pdfCloseBtn").onclick=()=>t.remove();let c=e=>{"Escape"===e.key&&(t.remove(),document.removeEventListener("keydown",c))};document.addEventListener("keydown",c),document.body.appendChild(t)}async function zobrazKnihovnuPDF(u){if(u){let t=document.createElement("div");t.id="knihovnaPdfOverlay",t.style.cssText=`
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85); z-index: 10003;
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
  `;var e=document.createElement("div"),i=(e.style.cssText=`
    width: 100%; max-width: 600px; max-height: 90vh;
    background: #1a1a1a; border-radius: 12px;
    display: flex; flex-direction: column;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  `,document.createElement("div"));i.style.cssText=`
    flex-shrink: 0; padding: 12px 16px;
    background: #222; color: white;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #444;
    border-radius: 12px 12px 0 0;
  `,i.innerHTML=`
    <div>
      <div style="font-weight: 600; font-size: 1rem;">KNIHOVNA PDF</div>
      <div style="font-size: 0.75rem; opacity: 0.7;">ID: ${u}</div>
    </div>
    <button id="knihovnaCloseBtn" style="
      background: #555; color: white; border: none;
      padding: 10px 20px; border-radius: 6px;
      font-weight: 600; font-size: 0.9rem; cursor: pointer;
    ">Zavrit</button>
  `;let a=document.createElement("div");a.style.cssText=`
    flex: 1; overflow-y: auto; padding: 16px;
    display: flex; flex-direction: column; gap: 16px;
  `,a.innerHTML=`
    <div style="text-align: center; padding: 40px; color: #888;">
      Nacitam dokumenty...
    </div>
  `;var r=document.createElement("div");r.style.cssText=`
    flex-shrink: 0; padding: 12px 16px;
    background: #222; border-top: 1px solid #444;
    display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;
    border-radius: 0 0 12px 12px;
  `,r.innerHTML=`
    <button id="btnNahratPdf" style="
      padding: 12px 24px; font-size: 0.9rem; font-weight: 600;
      background: #333; color: white; border: 1px solid #555;
      border-radius: 6px; cursor: pointer;
    ">+ Nahrat interni PDF</button>
    <button id="btnZavritKnihovnu" style="
      padding: 12px 24px; font-size: 0.9rem; font-weight: 600;
      background: #666; color: white; border: none;
      border-radius: 6px; cursor: pointer;
    ">Zavrit</button>
  `,e.appendChild(i),e.appendChild(a),e.appendChild(r),t.appendChild(e);let o=()=>t.remove(),n=(i.querySelector("#knihovnaCloseBtn").onclick=o,t.onclick=e=>{e.target===t&&o()},r.querySelector("#btnZavritKnihovnu").onclick=o,e=>{"Escape"===e.key&&(o(),document.removeEventListener("keydown",n))});async function g(){try{var e=await(await fetch(`/api/documents_api.php?action=seznam&reklamace_id=${encodeURIComponent(u)}&_t=`+Date.now(),{cache:"no-store"})).json();if("success"!==e.status)throw new Error(e.message||"Chyba p≈ôi naƒç√≠t√°n√≠");var t=e.dokumenty||e.data?.dokumenty||[];0===t.length?a.innerHTML=`
          <div style="text-align: center; padding: 40px; color: #888;">
            <div style="font-size: 1.2rem; margin-bottom: 10px;">Zadne dokumenty</div>
            <div style="font-size: 0.85rem;">Kliknete na "Nahrat interni PDF" pro pridani dokumentu.</div>
          </div>
        `:(a.innerHTML=t.map(e=>{var t=e.nahrano?new Date(e.nahrano).toLocaleDateString("cs-CZ"):"-",a=e.velikost?Math.round(e.velikost/1024):0,o=e.interni;return`
          <div class="dokument-polozka" style="
            background: #1a1a1a; border: 1px solid #333; border-radius: 8px;
            padding: 12px 16px; display: flex; justify-content: space-between;
            align-items: center; gap: 12px;
          ">
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: #fff; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${escapeHtml(e.nazev)}
              </div>
              <div style="font-size: 0.75rem; color: #888; display: flex; gap: 12px; flex-wrap: wrap;">
                <span>${e.typ_popis}</span>
                <span>${t}</span>
                <span>${a} KB</span>
                ${o?'<span style="color: #ff9800;">Interni</span>':""}
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              ${o?`
                <button class="btn-dokument-akce" data-action="prejmenovat" data-id="${e.id}" data-nazev="${escapeHtml(e.nazev)}" style="
                  padding: 8px 12px; font-size: 0.8rem; font-weight: 600;
                  background: #555; color: white; border: none;
                  border-radius: 4px; cursor: pointer;
                ">Upravit</button>
              `:""}
              <button class="btn-dokument-akce" data-action="zobrazitPdf" data-cesta="${escapeHtml(e.cesta)}" style="
                padding: 8px 16px; font-size: 0.8rem; font-weight: 600;
                background: #333; color: white; border: 1px solid #555;
                border-radius: 4px; cursor: pointer;
              ">Zobrazit</button>
              ${CURRENT_USER.is_admin?`
                <button class="btn-dokument-akce" data-action="smazatPdf" data-id="${e.id}" data-nazev="${escapeHtml(e.nazev)}" style="
                  padding: 8px 12px; font-size: 0.8rem; font-weight: 600;
                  background: #dc3545; color: white; border: none;
                  border-radius: 4px; cursor: pointer;
                ">Smazat</button>
              `:""}
            </div>
          </div>
        `}).join(""),a.querySelectorAll(".btn-dokument-akce").forEach(m=>{m.onclick=async e=>{var t=m.getAttribute("data-action");if("zobrazitPdf"===t)zobrazPDFModal(m.getAttribute("data-cesta"),u,"report");else if("prejmenovat"===t){var a=m.getAttribute("data-id"),o=m.getAttribute("data-nazev"),n=g,i=await((l,c="",p)=>new Promise(t=>{var{titulek:e="Zadejte hodnotu",btnPotvrdit:a="Potvrdit",btnZrusit:o="Zru≈°it",placeholder:n=""}=p,i=document.getElementById("wgsPromptModal");i&&i.remove();let r=document.createElement("div"),d=(r.id="wgsPromptModal",r.setAttribute("role","dialog"),r.setAttribute("aria-modal","true"),r.style.cssText=`
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); display: flex;
        align-items: center; justify-content: center; z-index: 10001;
      `,r.innerHTML=`
        <div class="wgs-prompt-dialog" style="background: #1a1a1a; padding: 25px; border-radius: 12px;
                    max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                    border: 1px solid #333; text-align: center; font-family: 'Poppins', sans-serif;">
          <h3 style="margin: 0 0 15px 0; color: #fff; font-size: 1.1rem; font-weight: 600;">${escapeHtml(e)}</h3>
          <p style="margin: 0 0 15px 0; color: #ccc; font-size: 0.95rem; line-height: 1.5;">${escapeHtml(l)}</p>
          <input type="text" id="wgsPromptInput" value="${escapeHtml(c)}" placeholder="${escapeHtml(n)}"
                 style="width: 100%; padding: 12px; border: 1px solid #444; border-radius: 8px;
                        background: #222; color: #fff; font-size: 1rem; margin-bottom: 20px;
                        box-sizing: border-box; outline: none;"
                 onfocus="this.style.borderColor='#666'" onblur="this.style.borderColor='#444'">
          <div style="display: grid; gap: 10px;">
            <button type="button" class="wgs-prompt-btn-potvrdit" style="padding: 12px 24px; border: none;
                        background: #28a745; color: #fff; border-radius: 8px; cursor: pointer;
                        font-size: 0.9rem; font-weight: 500; transition: all 0.2s; width: 100%;">
              ${escapeHtml(a)}
            </button>
            <button type="button" class="wgs-prompt-btn-zrusit" style="padding: 12px 24px; border: 1px solid #555;
                        background: transparent; color: #ccc; border-radius: 8px; cursor: pointer;
                        font-size: 0.9rem; font-weight: 500; transition: all 0.2s; width: 100%;">
              ${escapeHtml(o)}
            </button>
          </div>
        </div>
      `,document.body.appendChild(r),document.getElementById("wgsPromptInput"));i=r.querySelector(".wgs-prompt-btn-potvrdit"),e=r.querySelector(".wgs-prompt-btn-zrusit");setTimeout(()=>{d.focus(),d.select()},50);let s=e=>{r.remove(),t(e)};i.onclick=()=>s(d.value),e.onclick=()=>s(null),d.addEventListener("keydown",e=>{"Enter"===e.key?(e.preventDefault(),s(d.value)):"Escape"===e.key&&(e.preventDefault(),s(null))}),r.addEventListener("click",e=>{e.target===r&&s(null)})}))("Zadejte nov√Ω n√°zev dokumentu:",o,{titulek:"Prejmenovat dokument",btnPotvrdit:"Ulo≈æit",btnZrusit:"Zru≈°it"});if(null!==i)if(""===i.trim())wgsToast.error("N√°zev nem≈Ø≈æe b√Ωt pr√°zdn√Ω");else if(i.trim()!==o)try{var r=await getCSRFToken(),d=new FormData;d.append("action","prejmenovat"),d.append("dokument_id",a),d.append("novy_nazev",i.trim()),d.append("csrf_token",r);var s=await(await fetch("/api/documents_api.php",{method:"POST",body:d})).json();if("success"!==s.status)throw new Error(s.message||"Chyba p≈ôi p≈ôejmenov√°n√≠");wgsToast.success("Dokument prejmenovan"),n&&n()}catch(e){logger.error("Chyba p≈ôi p≈ôejmenov√°n√≠ dokumentu:",e),wgsToast.error("Chyba: "+e.message)}}else if("smazatPdf"===t){o=m.getAttribute("data-id"),a=m.getAttribute("data-nazev");if(await wgsConfirm(`Opravdu chcete smazat dokument "${a}"?`,{titulek:"Smazat dokument",btnPotvrdit:"Smazat",nebezpecne:!0})){i=o;try{var l=await getCSRFToken(),c=new FormData;c.append("action","smazat"),c.append("dokument_id",i),c.append("csrf_token",l);var p=await(await fetch("/api/documents_api.php",{method:"POST",body:c})).json();if("success"!==p.status)throw new Error(p.message||"Chyba p≈ôi maz√°n√≠");wgsToast.success("Dokument smazan")}catch(e){logger.error("Chyba p≈ôi maz√°n√≠ dokumentu:",e),wgsToast.error("Chyba: "+e.message)}await 0,g()}}}}))}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ dokument≈Ø:",e),a.innerHTML=`
        <div style="text-align: center; padding: 40px; color: #dc3545;">
          Chyba: ${escapeHtml(e.message)}
        </div>
      `}}document.addEventListener("keydown",n),r.querySelector("#btnNahratPdf").onclick=()=>{zobrazFormularNahraniPdf(u,()=>g())},document.body.appendChild(t),g()}else wgsToast.error("Chyb√≠ ID zak√°zky")}function zobrazFormularNahraniPdf(r,d){let t=document.createElement("div"),s=(t.style.cssText=`
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8); z-index: 10005;
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
  `,document.createElement("div")),l=(s.style.cssText=`
    background: #1a1a1a; border: 1px solid #333; border-radius: 12px;
    padding: 24px; max-width: 400px; width: 100%;
  `,s.innerHTML=`
    <h3 style="margin: 0 0 20px 0; color: #fff; font-size: 1.1rem;">Nahrat interni PDF</h3>

    <div style="margin-bottom: 16px;">
      <label style="display: block; color: #aaa; font-size: 0.85rem; margin-bottom: 6px;">Nazev dokumentu</label>
      <input type="text" id="inputNazevDokumentu" placeholder="Napr. Faktura, Smlouva..." style="
        width: 100%; padding: 10px 12px; font-size: 0.95rem;
        background: #222; color: #fff; border: 1px solid #444;
        border-radius: 6px; box-sizing: border-box;
      ">
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; color: #aaa; font-size: 0.85rem; margin-bottom: 6px;">PDF soubor</label>
      <input type="file" id="inputPdfSoubor" accept="application/pdf,.pdf" style="
        width: 100%; padding: 10px 12px; font-size: 0.9rem;
        background: #222; color: #fff; border: 1px solid #444;
        border-radius: 6px; box-sizing: border-box;
      ">
      <div style="font-size: 0.75rem; color: #666; margin-top: 4px;">Max. velikost: 10 MB</div>
    </div>

    <div style="display: flex; gap: 12px; justify-content: flex-end;">
      <button id="btnZrusitUpload" style="
        padding: 10px 20px; font-size: 0.9rem; font-weight: 600;
        background: #333; color: #fff; border: 1px solid #555;
        border-radius: 6px; cursor: pointer;
      ">Zrusit</button>
      <button id="btnPotvrditUpload" style="
        padding: 10px 20px; font-size: 0.9rem; font-weight: 600;
        background: #28a745; color: #fff; border: none;
        border-radius: 6px; cursor: pointer;
      ">Nahrat</button>
    </div>
  `,t.appendChild(s),()=>t.remove());s.querySelector("#btnZrusitUpload").onclick=l,t.onclick=e=>{e.target===t&&l()},s.querySelector("#btnPotvrditUpload").onclick=async()=>{var e=s.querySelector("#inputNazevDokumentu").value.trim(),t=s.querySelector("#inputPdfSoubor").files[0];if(t)if("application/pdf"===t.type||t.name.toLowerCase().endsWith(".pdf"))if(10485760<t.size)wgsToast.error("Soubor je prilis velky (max 10 MB)");else try{var a=s.querySelector("#btnPotvrditUpload"),o=(a.textContent="Nahravam...",a.disabled=!0,await getCSRFToken()),n=new FormData;n.append("action","nahrat"),n.append("reklamace_id",r),n.append("nazev",e||"Interni dokument"),n.append("soubor",t),n.append("csrf_token",o);var i=await(await fetch("/api/documents_api.php",{method:"POST",body:n})).json();if("success"!==i.status)throw new Error(i.message||"Chyba p≈ôi nahr√°v√°n√≠");wgsToast.success("Dokument nahran"),l(),d&&d()}catch(e){logger.error("Chyba p≈ôi nahr√°v√°n√≠ dokumentu:",e),wgsToast.error("Chyba: "+e.message);a=s.querySelector("#btnPotvrditUpload");a.textContent="Nahrat",a.disabled=!1}else wgsToast.error("Povoleny jsou pouze PDF soubory");else wgsToast.error("Vyberte PDF soubor")},document.body.appendChild(t),setTimeout(()=>{s.querySelector("#inputNazevDokumentu").focus()},100)}function showPhotoFullscreen(e){let t=document.createElement("div");t.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10010; display: flex; align-items: center; justify-content: center; cursor: pointer;",t.onclick=()=>t.remove();var a=document.createElement("img");a.alt="Zvƒõt≈°en√° fotka reklamace",a.src=e,a.style.cssText="max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 4px;";let o=e=>{"Escape"===e.key&&(t.remove(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o),t.appendChild(a),document.body.appendChild(t)}function showTextOverlay(s){if(CURRENT_RECORD){var e="popis_problemu"===s?"Popis probl√©mu":"Dopl≈àuj√≠c√≠ informace",a=CURRENT_RECORD[s]||"";let r=document.createElement("div");r.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 2rem;";var o=document.createElement("div"),n=(o.style.cssText="background: white; padding: 1.5rem; border-radius: 6px; max-width: 700px; width: 100%; max-height: 85vh; display: flex; flex-direction: column;",o.onclick=e=>e.stopPropagation(),document.createElement("div")),e=(n.style.cssText="font-weight: 600; font-size: 1rem; color: #1a1a1a; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #dee2e6;",n.textContent=e,document.createElement("div"));e.style.cssText="flex: 1; overflow-y: auto; margin-bottom: 1rem;";let d=document.createElement("textarea");d.style.cssText="width: 100%; min-height: 300px; border: 1px solid #ddd; padding: 0.75rem; border-radius: 4px; font-size: 0.9rem; line-height: 1.6; font-family: inherit; resize: vertical;",d.value=a,d.placeholder="Zadejte text...",e.appendChild(d);var a=document.createElement("div"),i=(a.style.cssText="display: flex; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid #dee2e6;",document.createElement("button")),l=(i.style.cssText="flex: 1; padding: 0.5rem 1rem; background: #1a1a1a; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; font-weight: 600;",i.textContent=t("save_changes"),i.onclick=async()=>{var e=d.value;try{var a=await getCSRFToken(),o=new FormData;o.append("action","update"),o.append("id",CURRENT_RECORD.id),o.append(s,e),o.append("csrf_token",a);var n,i=await(await fetch("/app/controllers/save.php",{method:"POST",body:o})).json();"success"===i.status?(CURRENT_RECORD[s]=e,(n=WGS_DATA_CACHE.find(e=>e.id==CURRENT_RECORD.id))&&(n[s]=e),r.remove(),showCustomerDetail(CURRENT_RECORD.id),wgsToast.success(t("text_saved_successfully"))):wgsToast.error(t("save_error")+": "+i.message)}catch(e){wgsToast.error(t("save_error")+": "+e.message)}},document.createElement("button"));l.style.cssText="flex: 1; padding: 0.5rem 1rem; background: #666; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer;",l.textContent=t("cancel"),l.onclick=()=>r.remove(),a.appendChild(i),a.appendChild(l),o.appendChild(n),o.appendChild(e),o.appendChild(a),r.appendChild(o),document.body.appendChild(r),r.onclick=e=>{e.target===r&&r.remove()},setTimeout(()=>d.focus(),100)}}async function saveAllCustomerData(e){await saveData({action:"update",id:e,cislo:document.getElementById("edit_cislo").value,datum_prodeje:document.getElementById("edit_datum_prodeje").value,datum_reklamace:document.getElementById("edit_datum_reklamace").value,jmeno:document.getElementById("edit_jmeno").value,telefon:document.getElementById("edit_telefon").value,email:document.getElementById("edit_email").value,adresa:document.getElementById("edit_adresa").value,model:document.getElementById("edit_model").value,provedeni:document.getElementById("edit_provedeni").value,barva:document.getElementById("edit_barva").value,doplnujici_info:document.getElementById("edit_doplnujici_info").value,popis_problemu:document.getElementById("edit_popis_problemu").value},"V≈°echny √∫daje byly aktualizov√°ny")}async function sendAppointmentConfirmation(e,t,a){var o=Utils.getCustomerName(e),n=e.telefon||"",i=e.email||"",r=Utils.getOrderId(e),d=Utils.getAddress(e)||"",s=e.nazev_produktu||e.produkt||e.popis_produktu||"",l="undefined"!=typeof CURRENT_USER?CURRENT_USER:{},c=l.name||e.technik_jmeno||e.assigned_technician||"",p=l.email||e.technik_email||"",l=l.phone||e.technik_telefon||"",e=e.created_by_email||"";try{var m=await getCSRFToken(),u=await(await fetch("app/notification_sender.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({notification_id:"appointment_confirmed",csrf_token:m,data:{customer_name:o,customer_email:i,customer_phone:n,seller_email:e,date:t,time:a,order_id:r,address:d,product:s,technician_name:c,technician_email:p,technician_phone:l}})})).json();!0===u.success?(logger.log("Potvrzen√≠ term√≠nu odesl√°no z√°kazn√≠kovi"),u.sent&&logger.log("  Email odesl√°n na:",u.to||i),u.sms_sent&&logger.log("  SMS odesl√°na na:",n)):logger.error("‚ö† Chyba p≈ôi odes√≠l√°n√≠ potvrzen√≠:",u.error||u.message)}catch(e){logger.error("Chyba p≈ôi odes√≠l√°n√≠ potvrzen√≠:",e)}}async function autoAssignTechnician(t){try{var e,a=await getCSRFToken(),o=await(await fetch("api/auto_assign_technician.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:t,csrf_token:a})})).json();o.success&&o.assigned?(logger.log(`‚úì Technik ${o.technician_name} (${o.technician_email}) byl automaticky p≈ôi≈ôazen`),CURRENT_RECORD&&(CURRENT_RECORD.assigned_to=o.technician_id,CURRENT_RECORD.technik_jmeno=o.technician_name||"",CURRENT_RECORD.technik_email=o.technician_email||"",CURRENT_RECORD.technik_telefon=o.technician_phone||""),(e=WGS_DATA_CACHE.find(e=>e.reklamace_id==t||e.cislo==t||e.id==t))&&(e.assigned_to=o.technician_id,e.technik_jmeno=o.technician_name||"",e.technik_email=o.technician_email||"",e.technik_telefon=o.technician_phone||"")):o.success&&!o.assigned?logger.log("Auto-assign: "+(o.message||"≈Ω√°dn√© p≈ôi≈ôazen√≠")):logger.warn("Auto-assign selhalo:",o.error)}catch(e){logger.error("Chyba p≈ôi auto-assign technika:",e)}}async function getNotes(t){try{var e,a,o=WGS_DATA_CACHE.find(e=>e.id==t||e.reklamace_id==t);return o?(e=o.reklamace_id||o.id,("success"===(a=await(await fetch("api/notes_api.php?action=get&reklamace_id="+encodeURIComponent(e))).json()).status||!0===a.success)&&a.notes||[]):[]}catch(e){return logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ pozn√°mek:",e),[]}}async function addNote(t,e,a=null){try{var o=WGS_DATA_CACHE.find(e=>e.id==t||e.reklamace_id==t);if(!o)throw new Error("Reklamace nenalezena");var n=await getCSRFToken(),i=o.reklamace_id||o.id,r=new FormData;if(r.append("action","add"),r.append("reklamace_id",i),r.append("text",e.trim()),r.append("csrf_token",n),logger.log("[Audio] audioBlob status:",a?"existuje":"null",a?a.size+" bytes":""),a){let e="webm";a.type.includes("mp4")?e="m4a":a.type.includes("ogg")?e="ogg":a.type.includes("mp3")||a.type.includes("mpeg")?e="mp3":a.type.includes("wav")&&(e="wav"),r.append("audio",a,"nahravka."+e),logger.log("[Audio] Odesilam nahravku:",Math.round(a.size/1024),"KB, type:",a.type)}logger.log("[Notes] Odesilam poznamku na API...");var d=await fetch("api/notes_api.php",{method:"POST",body:r}),s=(logger.log("[Notes] API odpoved status:",d.status),await d.json());if(logger.log("[Notes] API odpoved data:",JSON.stringify(s)),"success"===s.status||!0===s.success)return{success:!0,note_id:s.note_id};throw new Error(s.error||s.message||"Chyba pri pridavani poznamky")}catch(e){throw logger.error("Chyba pri pridavani poznamky:",e),e}}async function deleteNote(e,t){if(console.log("[deleteNote] Zacinam mazat poznamku ID:",e),await wgsConfirm("Opravdu chcete smazat tuto pozn√°mku?","Smazat","Zru≈°it")){console.log("[deleteNote] Uzivatel potvrdil, pripravuji request...");try{var a,o,n=await getCSRFToken(),i=(console.log("[deleteNote] CSRF token:",n?"OK ("+n.substring(0,10)+"...)":"CHYBI!"),new URLSearchParams),r=(i.append("action","delete"),i.append("note_id",e),i.append("csrf_token",n),console.log("[deleteNote] Params pripraveny:",i.toString().substring(0,50)+"..."),console.log("[deleteNote] Odesilam POST na /api/notes_api.php..."),await fetch("/api/notes_api.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i})),d=(console.log("[deleteNote] Response status:",r.status,r.statusText),await r.json());"success"===d.status?((a=document.querySelector(`[data-note-id="${e}"]`))&&a.remove(),(o=document.querySelector(".notes-container"))&&0===o.querySelectorAll(".note-item").length&&(o.innerHTML='<div class="empty-notes">Zatim zadne poznamky</div>'),await loadAll()):wgsToast.error("Chyba: "+(d.error||d.message||"Neznama chyba"))}catch(e){logger.error("Chyba pri mazani poznamky:",e),wgsToast.error("Chyba pri mazani poznamky: "+e.message)}}else console.log("[deleteNote] Uzivatel zrusil")}async function markNotesAsRead(t){try{var e,a,o,n=WGS_DATA_CACHE.find(e=>e.id==t||e.reklamace_id==t);n&&(e=await getCSRFToken(),a=n.reklamace_id||n.id,(o=new FormData).append("action","mark_read"),o.append("reklamace_id",a),o.append("csrf_token",e),await fetch("api/notes_api.php",{method:"POST",body:o}))}catch(e){logger.error("Chyba p≈ôi oznaƒçov√°n√≠ pozn√°mek:",e)}}async function showNotes(a){let n;if("string"==typeof a||"number"==typeof a){if(!(n=WGS_DATA_CACHE.find(e=>e.id==a||e.reklamace_id==a)))return void wgsToast.error(t("record_not_found"))}else n=a;CURRENT_RECORD=n;var e=`
    ${createCustomerHeader()}
    <div class="modal-body" style="text-align: center; padding: 3rem;">
      <div class="loading">Naƒç√≠t√°n√≠ pozn√°mek...</div>
    </div>
  `,e=(ModalManager.show(e),await getNotes(n.id)),e=(e.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),`
    ${createCustomerHeader()}

    <div class="modal-body">
      <div class="notes-container">
        ${0<e.length?e.map(e=>{var t=CURRENT_USER&&(CURRENT_USER.is_admin||e.author===CURRENT_USER.email),a=e.has_audio&&e.audio_url,o="[Hlasov√° pozn√°mka]"===e.text||"[Hlasova poznamka]"===e.text;return`
              <div class="note-item ${e.read?"":"unread"} ${a?"has-audio":""}" data-note-id="${e.id}">
                <div class="note-header">
                  <span class="note-author">${e.author_name||e.author}</span>
                  <span class="note-time">${formatDateTime(e.timestamp)}</span>
                  ${t?`<button class="note-delete-btn" data-note-id="${e.id}" data-order-id="${n.id}" onclick="event.stopPropagation(); potvrditSmazaniPoznamky(this);" title="Smazat poznamku">x</button>`:""}
                </div>
                ${o?"":`<div class="note-text">${Utils.escapeHtml(e.text)}</div>`}
                ${a?`
                <div class="note-audio">
                  <audio controls preload="metadata" class="note-audio-player">
                    <source src="${e.audio_url}" type="audio/mp4">
                    <source src="${e.audio_url}" type="audio/webm">
                    <source src="${e.audio_url}" type="audio/mpeg">
                    Vas prohlizec nepodporuje prehravani audia.
                  </audio>
                </div>
                `:""}
              </div>
            `}).join(""):'<div class="empty-notes">Zatim zadne poznamky</div>'}
      </div>

      <div class="note-input-area">
        <textarea
          class="note-textarea"
          id="newNoteText"
          placeholder="Napiste poznamku..."
        ></textarea>
        <div class="note-input-controls">
          <button type="button" class="btn-record" id="btnStartRecord" data-action="startRecording" data-id="${n.id}" title="Nahrat hlasovou zpravu">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
              <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            </svg>
          </button>
          <div class="recording-indicator" id="recordingIndicator">
            <span class="recording-dot"></span>
            <span class="recording-time" id="recordingTime">0:00</span>
            <button type="button" class="btn-stop-record" id="btnStopRecord" data-action="stopRecording" data-id="${n.id}">Stop</button>
          </div>
          <div class="audio-preview hidden" id="audioPreview">
            <audio id="audioPreviewPlayer" controls></audio>
            <button type="button" class="btn-delete-audio" id="btnDeleteAudio" data-action="deleteAudioPreview" title="Smazat nahravku">x</button>
          </div>
        </div>
      </div>
    </div>

    <div class="detail-buttons">
      <button class="detail-btn detail-btn-primary" data-action="saveNewNote" data-id="${n.id}">Pridat poznamku</button>
      <button class="detail-btn detail-btn-secondary" data-action="closeNotesModal">Zavrit</button>
    </div>
  `);ModalManager.show(e),setTimeout(()=>{document.querySelectorAll(".note-audio-player").forEach(t=>{t.onerror=function(){logger.log("[Audio] Chyba pri nacitani ulozene nahravky");var e=t.closest(".note-audio");e&&(e.innerHTML='<span style="color: var(--c-grey); font-size: 0.75rem;">Audio nelze nacist</span>')}})},100),setTimeout(async()=>{await markNotesAsRead(n.id),await loadAll(),window.WGSNotifikace&&window.WGSNotifikace.aktualizovat()},1e3)}async function saveNewNote(e){var a=document.getElementById("newNoteText").value.trim(),o=window.wgsAudioRecorder?window.wgsAudioRecorder.audioBlob:null;if(a||o)try{await addNote(e,a,o),window.wgsAudioRecorder&&(window.wgsAudioRecorder.audioBlob=null,window.wgsAudioRecorder.audioChunks=[]),closeNotesModal(),await loadAll(),window.WGSNotifikace&&window.WGSNotifikace.aktualizovat()}catch(e){wgsToast.error(t("note_save_error")+": "+e.message)}else wgsToast.warning(t("write_note_text"))}function closeNotesModal(){window.wgsAudioRecorder&&window.wgsAudioRecorder.isRecording&&stopRecording(),"function"==typeof releaseMicrophone&&releaseMicrophone(),closeDetail(),renderOrders()}async function checkMicrophonePermission(){try{var e;if(navigator.permissions&&navigator.permissions.query)return e=await navigator.permissions.query({name:"microphone"}),logger.log("[Audio] Stav opravneni mikrofonu:",e.state),"granted"===e.state?(window.wgsAudioRecorder.permissionGranted=!0,"granted"):"denied"===e.state?"denied":"prompt"}catch(e){logger.log("[Audio] Permissions API neni podporovano, zkusim primo")}return"unknown"}async function startRecording(e){logger.log("[Audio] Spoustim nahravani...");try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Vas prohlizec nepodporuje nahravani zvuku");var t=await checkMicrophonePermission();if("denied"===t)throw new Error("Pristup k mikrofonu byl trvale odepren. Povolte ho v nastaveni prohlizece.");window.wgsAudioRecorder.permissionGranted||"granted"===t||localStorage.getItem("wgs_mic_explained")||(wgsToast.info("Pro nahravani hlasovych poznamek potrebujeme pristup k mikrofonu. Po kliknuti na OK vas prohlizec pozada o povoleni."),localStorage.setItem("wgs_mic_explained","1"));var o=await navigator.mediaDevices.getUserMedia({audio:!0}),n=(window.wgsAudioRecorder.stream=o,window.wgsAudioRecorder.permissionGranted=!0,/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||/iPad|iPhone|iPod/.test(navigator.userAgent));let e="audio/webm",a=(n?(MediaRecorder.isTypeSupported("audio/mp4")?e="audio/mp4":MediaRecorder.isTypeSupported("audio/aac")&&(e="audio/aac"),logger.log("[Audio] Safari detekovan, preferuji MP4")):MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?e="audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/webm")?e="audio/webm":MediaRecorder.isTypeSupported("audio/mp4")?e="audio/mp4":MediaRecorder.isTypeSupported("audio/ogg")&&(e="audio/ogg"),logger.log("[Audio] Pouzivam format:",e),window.wgsAudioRecorder);a.mimeType=e,a.mediaRecorder=new MediaRecorder(o,{mimeType:e}),a.audioChunks=[],a.isRecording=!0,a.recordingStartTime=Date.now(),a.mediaRecorder.ondataavailable=e=>{0<e.data.size&&(a.audioChunks.push(e.data),logger.log("[Audio] Data chunk:",e.data.size,"bytes"))},a.mediaRecorder.onstop=()=>{var e;logger.log("[Audio] Nahravani ukonceno, chunks:",a.audioChunks.length),0===a.audioChunks.length?(logger.error("[Audio] Zadna data nebyla nahrana"),wgsToast.warning("Nahravka je prazdna. Zkuste to prosim znovu."),document.getElementById("btnStartRecord").classList.remove("hidden"),document.getElementById("recordingIndicator").classList.remove("active")):(e=a.mimeType||"audio/webm",a.audioBlob=new Blob(a.audioChunks,{type:e}),a.isRecording=!1,logger.log("[Audio] Blob vytvoren:",a.audioBlob.size,"bytes, type:",e),releaseMicrophone(),showAudioPreview(a.audioBlob))},a.mediaRecorder.start(1e3),document.getElementById("btnStartRecord").classList.add("hidden"),document.getElementById("recordingIndicator").classList.add("active"),a.recordingTimer=setInterval(()=>{var e=Math.floor((Date.now()-a.recordingStartTime)/1e3),t=Math.floor(e/60),e=e%60;document.getElementById("recordingTime").textContent=t+":"+e.toString().padStart(2,"0")},1e3),logger.log("[Audio] Nahravani spusteno")}catch(e){logger.error("[Audio] Chyba pri nahravani:",e),releaseMicrophone(),"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?wgsToast.error("Pristup k mikrofonu byl odepren. Povolte pristup v nastaveni prohlizece."):wgsToast.error("Chyba pri nahravani: "+e.message)}}function stopRecording(){logger.log("[Audio] Zastavuji nahravani...");let t=window.wgsAudioRecorder;if(t.recordingTimer&&(clearInterval(t.recordingTimer),t.recordingTimer=null),t.mediaRecorder&&t.isRecording)if("recording"===t.mediaRecorder.state)try{t.mediaRecorder.requestData(),setTimeout(()=>{t.mediaRecorder&&"recording"===t.mediaRecorder.state&&(t.mediaRecorder.stop(),logger.log("[Audio] MediaRecorder zastaven po requestData zpozdeni"))},150)}catch(e){logger.log("[Audio] requestData neni podporovano:",e.message),t.mediaRecorder.stop()}else"inactive"!==t.mediaRecorder.state&&t.mediaRecorder.stop();var e=document.getElementById("recordingIndicator");e&&e.classList.remove("active")}function releaseMicrophone(){var e=window.wgsAudioRecorder;e.stream&&(e.stream.getTracks().forEach(e=>{e.stop(),logger.log("[Audio] Track zastaven:",e.kind)}),e.stream=null),e.mediaRecorder&&(e.mediaRecorder=null),e.isRecording=!1,e.audioChunks=[],logger.log("[Audio] Mikrofon a MediaRecorder uvolneny")}function showAudioPreview(e){var t=URL.createObjectURL(e);let a=document.getElementById("audioPreviewPlayer"),o=document.getElementById("audioPreview"),n=(a.onerror=null,a.oncanplay=null,!1);a.onerror=function(e){n||(n=!0,logger.log("[Audio] Chyba pri nacitani nahravky:",e),o.classList.add("hidden"),document.getElementById("btnStartRecord").classList.remove("hidden"),a.src&&(URL.revokeObjectURL(a.src),a.src=""),logger.error("[Audio] Nahravka se nepodarila nacist"))},a.src=t,o.classList.remove("hidden"),logger.log("[Audio] Nahled zobrazen, velikost:",Math.round(e.size/1024),"KB")}function deleteAudioPreview(){var e=window.wgsAudioRecorder,e=(e.audioBlob=null,e.audioChunks=[],document.getElementById("audioPreviewPlayer")),t=document.getElementById("audioPreview");e.src&&(URL.revokeObjectURL(e.src),e.src=""),t.classList.add("hidden"),document.getElementById("btnStartRecord").classList.remove("hidden"),logger.log("[Audio] Nahled smazan")}function formatDateTime(e){var e=new Date(e),t=new Date-e;return t<6e4?"Pr√°vƒõ teƒè":t<36e5?`P≈ôed ${Math.floor(t/6e4)} min`:t<864e5?`P≈ôed ${Math.floor(t/36e5)} h`:["ne","po","ut","st","ct","pa","so"][e.getDay()]+` ${e.getDate()}.${e.getMonth()+1}.${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:`+e.getMinutes().toString().padStart(2,"0")}function getStatus(e){return{"ƒåEK√Å":{class:"wait",text:"NOV√Å"},wait:{class:"wait",text:"NOV√Å"},"DOMLUVEN√Å":{class:"open",text:"DOMLUVEN√Å"},open:{class:"open",text:"DOMLUVEN√Å"},HOTOVO:{class:"done",text:"HOTOVO"},done:{class:"done",text:"HOTOVO"}}[e]||{class:"wait",text:"NOV√Å"}}function formatDate(e){var t;return e?(t=new Date(e),isNaN(t)?e:["ne","po","ut","st","ct","pa","so"][t.getDay()]+` ${t.getDate()}.${t.getMonth()+1}.`+t.getFullYear()):"‚Äî"}function formatAppointment(e,t){var a,o;return e&&t?3!==(o=e.split(".")).length?e+" "+t:(e=parseInt(o[0]),a=parseInt(o[1]),o=parseInt(o[2]),["ne","po","√∫t","st","ƒçt","p√°","so"][new Date(o,a-1,e).getDay()]+` ${e}.${a}.-`+t):""}function showDeleteConfirmModal(o){return new Promise(e=>{let t=document.createElement("div");t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10003;display:flex;align-items:center;justify-content:center;";var a=document.createElement("div");a.style.cssText="background:#1a1a1a;padding:25px;border-radius:12px;max-width:400px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);border:1px solid #333;",a.innerHTML=`
      <h3 style="margin:0 0 15px 0;color:#fff;font-size:1.1rem;font-weight:600;">Smazat reklamaci?</h3>
      <p style="margin:0 0 15px 0;color:#ccc;line-height:1.5;font-size:0.95rem;">
        Opravdu chcete <strong style="color:#fff;">TRVALE SMAZAT</strong> reklamaci<br>
        <strong style="color:#fff;font-size:1rem;">${o}</strong>?
      </p>
      <p style="margin:0 0 20px 0;color:#999;font-size:0.85rem;">
        Tato akce sma≈æe V≈†E vƒçetnƒõ fotek a PDF!<br>
        Tuto akci NELZE vr√°tit zpƒõt!
      </p>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="deleteConfirmNo" style="padding:10px 20px;background:transparent;color:#ccc;border:1px solid #444;border-radius:6px;cursor:pointer;font-size:0.9rem;">
          Zru≈°it
        </button>
        <button id="deleteConfirmYes" style="padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;font-weight:500;">
          Smazat
        </button>
      </div>
    `,t.appendChild(a),document.body.appendChild(t),document.getElementById("deleteConfirmNo").onclick=()=>{document.body.removeChild(t),e(!1)},document.getElementById("deleteConfirmYes").onclick=()=>{document.body.removeChild(t),e(!0)}})}function showDeleteInputModal(n){return new Promise(t=>{let a=document.createElement("div");a.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10003;display:flex;align-items:center;justify-content:center;";var e=document.createElement("div");e.style.cssText="background:#1a1a1a;padding:25px;border-radius:12px;max-width:400px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);border:1px solid #333;",e.innerHTML=`
      <h3 style="margin:0 0 15px 0;color:#fff;font-size:1.1rem;font-weight:600;">Posledn√≠ ovƒõ≈ôen√≠</h3>
      <p style="margin:0 0 15px 0;color:#ccc;line-height:1.5;font-size:0.95rem;">
        Pro potvrzen√≠ smaz√°n√≠ zadejte p≈ôesnƒõ ƒç√≠slo reklamace:
      </p>
      <p style="margin:0 0 15px 0;color:#fff;font-size:1rem;font-weight:600;">
        ${n}
      </p>
      <input type="text" id="deleteInputField"
             placeholder="Zadejte ƒç√≠slo reklamace"
             style="width:100%;padding:10px;background:#252525;border:1px solid #444;border-radius:6px;font-size:0.9rem;text-align:center;margin-bottom:20px;color:#fff;box-sizing:border-box;">
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="deleteInputCancel" style="padding:10px 20px;background:transparent;color:#ccc;border:1px solid #444;border-radius:6px;cursor:pointer;font-size:0.9rem;">
          Zru≈°it
        </button>
        <button id="deleteInputConfirm" style="padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;font-weight:500;">
          Smazat
        </button>
      </div>
    `,a.appendChild(e),document.body.appendChild(a);let o=document.getElementById("deleteInputField");o.focus(),document.getElementById("deleteInputCancel").onclick=()=>{document.body.removeChild(a),t("")},document.getElementById("deleteInputConfirm").onclick=()=>{var e=o.value.trim();document.body.removeChild(a),t(e)},o.addEventListener("keypress",e=>{"Enter"===e.key&&(e=o.value.trim(),document.body.removeChild(a),t(e))})})}async function deleteReklamace(e){logger.log("[deleteReklamace] Zobrazuji 1. confirmation modal");var a=CURRENT_RECORD.reklamace_id||CURRENT_RECORD.id||e,o=await showDeleteConfirmModal(a);if(o)if(await showDeleteInputModal(a)!==a)logger.log("Maz√°n√≠ zru≈°eno - ≈°patn√© ƒç√≠slo (2. krok)"),(o=document.createElement("div")).id="errorModal",o.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10003;display:flex;align-items:center;justify-content:center;",o.innerHTML=`
      <div style="background:#1a1a1a;padding:25px;border-radius:12px;max-width:400px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);border:1px solid #333;">
        <h3 style="margin:0 0 15px 0;color:#fff;font-size:1.1rem;font-weight:600;">Nespr√°vn√© ƒç√≠slo!</h3>
        <p style="margin:0 0 20px 0;color:#ccc;font-size:0.95rem;line-height:1.5;">Zadali jste nespr√°vn√© ƒç√≠slo reklamace.<br>Maz√°n√≠ bylo zru≈°eno.</p>
        <button onclick="document.getElementById('errorModal').remove();" style="padding:10px 20px;background:#fff;color:#000;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;font-weight:500;">
          OK
        </button>
      </div>
    `,document.body.appendChild(o);else{logger.log("üóëÔ∏è Maz√°n√≠ reklamace:",e);try{var n,i=await getCSRFToken(),r=await fetch("api/delete_reklamace.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:e,csrf_token:i})}),d=await r.json();if(!r.ok)throw new Error(`HTTP ${r.status}: `+(d.message||d.error||r.statusText));d.success||"success"===d.status?(logger.log("Smaz√°no!"),wgsToast.success(t("claim_deleted_successfully")),closeDetail(),setTimeout(()=>location.reload(),500)):(n=d.message||d.error||t("delete_failed"),logger.error("Chyba:",n),wgsToast.error(t("error")+": "+n))}catch(e){logger.error("Chyba p≈ôi maz√°n√≠:",e),wgsToast.error(t("delete_error")+": "+e.message)}}else logger.log("Maz√°n√≠ zru≈°eno (1. krok)")}async function smazatFotku(o,n){return logger.log("[smazatFotku] Vytv√°≈ô√≠m confirmation modal pro ID:",o),new Promise(e=>{let t=document.createElement("div");t.id="deleteFotoModal",t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10003;display:flex;align-items:center;justify-content:center;";var a=document.createElement("div");a.style.cssText="background:#1a1a1a;padding:25px;border-radius:12px;max-width:400px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);border:1px solid #333;",a.innerHTML=`
      <h3 style="margin:0 0 15px 0;color:#fff;font-size:1.1rem;font-weight:600;">Smazat fotku?</h3>
      <p style="margin:0 0 20px 0;color:#ccc;line-height:1.5;font-size:0.95rem;">
        Opravdu chcete smazat tuto fotografii?<br>
        <strong style="color:#999;">Tato akce je nevratn√°!</strong>
      </p>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="deleteFotoNo" style="padding:10px 20px;background:transparent;color:#ccc;border:1px solid #444;border-radius:6px;cursor:pointer;font-size:0.9rem;">
          Zru≈°it
        </button>
        <button id="deleteFotoYes" style="padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;font-weight:500;">
          Smazat
        </button>
      </div>
    `,t.appendChild(a),document.body.appendChild(t),document.getElementById("deleteFotoNo").onclick=()=>{logger.log("[smazatFotku] U≈æivatel zru≈°il"),document.body.removeChild(t),e(!1)},document.getElementById("deleteFotoYes").onclick=async()=>{logger.log("[smazatFotku] U≈æivatel potvrdil, maz√°m..."),document.body.removeChild(t),await pokracovatSmazaniFotky(o,n),e(!0)}})}async function pokracovatSmazaniFotky(e,a){logger.log("üóëÔ∏è Maz√°n√≠ fotky ID:",e);try{var o,n=await getCSRFToken(),i=new FormData,r=(i.append("photo_id",e),i.append("csrf_token",n),await fetch("api/delete_photo.php",{method:"POST",body:i})),d=await r.json();if(!r.ok)throw new Error(`HTTP ${r.status}: `+(d.message||d.error||r.statusText));if("success"===d.status){logger.log("Fotka smaz√°na!");for(o of document.querySelectorAll(".foto-wrapper img"))if(o.src.includes(a.replace(/\\/g,""))){o.closest(".foto-wrapper").remove();break}var s,l,c=document.querySelector('[style*="Fotografie"]');c&&(s=document.querySelectorAll(".foto-wrapper").length,c.textContent=`Fotografie (${s})`,0===s)&&(l=c.closest("div").querySelector('[style*="grid"]'))&&(l.innerHTML=`<p style="color: var(--c-grey); text-align: center; padding: 1rem; font-size: 0.9rem;">${t("no_photos")}</p>`),wgsToast.success(t("photo_deleted_successfully"))}else{var p=d.message||d.error||t("delete_failed");logger.error("Chyba:",p),wgsToast.error(t("error")+": "+p)}}catch(e){logger.error("Chyba p≈ôi maz√°n√≠ fotky:",e),wgsToast.error(t("photo_delete_error")+": "+e.message)}}async function loadPhotosFromDB(e){try{var t,a=await fetch("api/get_photos_api.php?reklamace_id="+e);return a.ok?(t=await a.json()).success&&t.photos?t.photos.map(e=>({id:e.id,photo_path:e.photo_path,section_name:e.section_name})):[]:[]}catch(e){return logger.error("Chyba naƒç√≠t√°n√≠ fotek:",e),[]}}function otevritVyberFotek(e){logger.log("[Fototeka] Otviram vyber fotek pro reklamaci:",e);e=document.getElementById("fototeka-input-"+e);e?e.click():logger.error("[Fototeka] Input element nenalezen")}async function zpracujVybraneFotky(a){var a=a.target,o=a.getAttribute("data-reklamace-id"),n=a.files;if(n&&0!==n.length){logger.log("[Fototeka] Vybrano souboru:",n.length,"pro reklamaci:",o);let e=document.getElementById("fototeka-nahravani"),t=document.getElementById("fototeka-progress");e&&(e.style.display="block"),t&&(t.style.width="0%");try{var i=[];for(let e=0;e<n.length;e++){var r,d,s,l=n[e];l.type.startsWith("image/")?15728640<l.size?wgsToast.error("Soubor "+l.name+" je prilis velky (max 15MB)"):(d=await souborNaBase64(r=await komprimujObrazek(l,1200,.3)),i.push({type:"image",data:d,size:r.size}),t&&(s=Math.round((e+1)/n.length*50),t.style.width=s+"%")):logger.warn("[Fototeka] Preskakuji neobrazovy soubor:",l.name)}if(0===i.length)throw new Error("Zadne platne fotky k nahrani");var c=await getCSRFToken(),p=await fetch("/app/save_photos.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:o,sections:{customer_detail:i},csrf_token:c})}),m=(t&&(t.style.width="80%"),await p.json());if(!p.ok||!m.success)throw new Error(m.error||"Chyba pri nahravani");t&&(t.style.width="100%"),logger.log("[Fototeka] Nahrano fotek:",m.count),wgsToast.success("Nahrano "+m.count+" fotek"),await aktualizujFototekaGrid(o),a.value=""}catch(e){logger.error("[Fototeka] Chyba pri nahravani:",e),wgsToast.error("Chyba: "+e.message)}finally{setTimeout(()=>{e&&(e.style.display="none"),t&&(t.style.width="0%")},1e3)}}else logger.log("[Fototeka] Zadne soubory vybrane")}function souborNaBase64(o){return new Promise((e,t)=>{let a=new FileReader;a.onload=()=>e(a.result),a.onerror=e=>t(e),a.readAsDataURL(o)})}function komprimujObrazek(d,s=1200,l=.3){return new Promise(r=>{var e=new FileReader;e.onload=e=>{let i=new Image;i.onload=async()=>{let t=document.createElement("canvas");var e=t.getContext("2d"),a=Math.min(1,s/Math.max(i.width,i.height));t.width=i.width*a,t.height=i.height*a,e.drawImage(i,0,0,t.width,t.height);let o=.7,n=await new Promise(e=>t.toBlob(e,"image/jpeg",o));for(;n.size>1024*l*1024&&.3<o;)o-=.05,n=await new Promise(e=>t.toBlob(e,"image/jpeg",o));a=Math.round(d.size/1024),e=Math.round(n.size/1024);logger.log(`[Fototeka] Komprese: ${a} KB -> ${e} KB (kvalita ${Math.round(100*o)}%)`),r(n)},i.onerror=()=>{logger.warn("[Fototeka] Nelze nacist obrazek pro kompresi, vracim original"),r(d)},i.src=e.target.result},e.onerror=()=>r(d),e.readAsDataURL(d)})}async function aktualizujFototekaGrid(e){try{var t=await loadPhotosFromDB(e),a=document.getElementById("fototeka-grid"),o=document.getElementById("fototeka-nadpis");a&&(o&&(o.textContent="Fototeka ("+t.length+")"),0<t.length?a.innerHTML=t.map((e,t)=>{var a="object"==typeof e?e.photo_path:e,e="object"==typeof e?e.id:null,o=a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/'/g,"\\'");return`
          <div class="foto-wrapper" style="position: relative; width: 60px; height: 60px; flex-shrink: 0;">
            <img src='${a}'
                 style='width: 60px; height: 60px; object-fit: cover; border: 1px solid #444; cursor: pointer; border-radius: 4px;'
                 alt='Fotka ${t+1}'
                 data-action="showPhotoFullscreen"
                 data-url="${o}">
            ${e?`
              <button class="foto-delete-btn"
                      data-action="smazatFotku"
                      data-photo-id="${e}"
                      data-url="${o}"
                      title="Smazat fotku">
                x
              </button>
            `:""}
          </div>
        `}).join(""):a.innerHTML='<p style="color: #666; font-size: 0.85rem; margin: 0; padding: 0.5rem 0;">Zadne fotografie</p>')}catch(e){logger.error("[Fototeka] Chyba pri aktualizaci gridu:",e)}}async function loadMoreOrders(){var e;!LOADING_MORE&&HAS_MORE_PAGES&&(LOADING_MORE=!0,(e=document.getElementById("loadMoreBtn"))&&(e.disabled=!0,e.textContent=t("loading")),await loadAll("all",!0))}function updateLoadMoreButton(){let e=document.getElementById("loadMoreBtn");var a;e||(a=document.getElementById("orderGrid"))&&a.parentElement&&((e=document.createElement("button")).id="loadMoreBtn",e.className="load-more-btn",e.textContent=t("load_more_orders"),e.onclick=loadMoreOrders,a.parentElement.appendChild(e)),e&&(e.classList.toggle("hidden",!HAS_MORE_PAGES),e.disabled=LOADING_MORE,e.textContent=LOADING_MORE?t("loading"):t("load_more_page").replace("{page}",CURRENT_PAGE+1))}async function sendContactAttemptEmail(t,a){try{if(WGS_DATA_CACHE.find(e=>e.id==t||e.reklamace_id==t)){showLoading("Odes√≠l√°m email z√°kazn√≠kovi... Pros√≠m ƒçekejte");var e=await getCSRFToken(),o=await(await fetch("/api/send_contact_attempt_email.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:t,csrf_token:e})})).json();if(hideLoading(),o.success){logger.log("Email o pokusu o kontakt odesl√°n z√°kazn√≠kovi"),closeDetail(),"undefined"!=typeof WGSToast?WGSToast.zobrazit("Email odesl√°n z√°kazn√≠kovi",{titulek:"WGS"}):showToast("Email odesl√°n z√°kazn√≠kovi","success");let t=o.sms_text||"Dobr√Ω den, pokusili jsme se V√°s kontaktovat. Zavolejte pros√≠m zpƒõt na +420 725 965 826. Dƒõkujeme, WGS Service";setTimeout(()=>{var e=encodeURIComponent(t);window.location.href=`sms:${a}?body=`+e},2e3)}else logger.error("‚ö† Chyba p≈ôi odes√≠l√°n√≠ emailu:",o.error||o.message),showToast(o.error||"Chyba p≈ôi odes√≠l√°n√≠ emailu","error")}else showToast("Z√°znam nenalezen","error")}catch(e){logger.error("Chyba p≈ôi odes√≠l√°n√≠ kontaktn√≠ho emailu:",e),showToast("Nepoda≈ôilo se odeslat email","error"),hideLoading()}}async function zobrazVideotekaArchiv(r){if(logger.log("[Videot√©ka] Otev√≠r√°m archiv pro zak√°zku ID: "+r),document.getElementById("videotekaOverlay"))logger.log("[Videot√©ka] Overlay u≈æ existuje, ignoruji");else{let t=document.createElement("div");t.id="videotekaOverlay",t.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10004; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem;";var e=document.createElement("div"),d=(e.style.cssText="width: 95%; max-width: 900px; height: 90%; background: #222; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;",window.innerWidth<600),s=document.createElement("div");s.style.cssText=d?"padding: 12px 16px; background: #333; color: white; font-weight: 600; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 2px; border-bottom: 2px solid #444;":"padding: 16px 20px; background: #333; color: white; font-weight: 600; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #444;",s.innerHTML="<span>Naƒç√≠t√°n√≠...</span>";let a=document.createElement("div"),o=(a.id="videotekaContent",a.style.cssText="flex: 1; overflow-y: auto; padding: 16px; background: #1a1a1a; display: flex; flex-direction: column; gap: 12px; align-content: start; position: relative; transition: background 0.2s ease;",document.createElement("div")),n=(o.id="videotekaDropOverlay",o.style.cssText="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(45, 80, 22, 0.3); border: 3px dashed #2D5016; display: none; align-items: center; justify-content: center; z-index: 10; pointer-events: none;",o.innerHTML='<div style="color: white; font-size: 1.2rem; font-weight: 600; text-align: center; padding: 2rem;">Pus≈•te video pro nahr√°n√≠</div>',0);a.addEventListener("dragenter",e=>{e.preventDefault(),e.stopPropagation(),n++,o.classList.remove("hidden"),a.style.background="#252525"}),a.addEventListener("dragleave",e=>{e.preventDefault(),e.stopPropagation(),0===--n&&(o.classList.add("hidden"),a.style.background="#1a1a1a")}),a.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation()}),a.addEventListener("drop",async e=>{e.preventDefault(),e.stopPropagation(),n=0,o.classList.add("hidden"),a.style.background="#1a1a1a";var e=e.dataTransfer.files;0<e.length&&((e=e[0]).type.startsWith("video/")?(logger.log(`[Videot√©ka] Drag & drop: ${e.name} (${(e.size/1024/1024).toFixed(2)} MB)`),await nahratVideoDragDrop(e,r,t)):showToast("Lze nahr√°t pouze video soubory","error"))});try{var l,c=await(await fetch("/api/video_api.php?action=list_videos&claim_id="+r)).json();"success"===c.status&&(p=c.customer_name||"Nezn√°m√Ω z√°kazn√≠k",m=c.reklamace_cislo||r,s.innerHTML=d?`
          <span style="font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">${p}</span>
          <span style="font-size: 0.75rem; opacity: 0.6;">${m}</span>
        `:`<span>${p}</span><span style="font-size: 0.85rem; opacity: 0.7;">${m}</span>`,c.videos&&0<c.videos.length?c.videos.forEach(e=>{e=vytvorVideoKartu(e,r);a.appendChild(e)}):(a.classList.add("flex-center"),(l=document.createElement("div")).style.cssText="text-align: center; padding: 3rem; color: #999;",l.innerHTML=`
          <div style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 1rem;">≈Ω√°dn√° videa v archivu</div>
          <div style="font-size: 1.05rem; font-weight: 500; margin-bottom: 0.5rem;">P≈ôet√°hnƒõte video sem</div>
          <div style="font-size: 0.85rem; opacity: 0.7;">nebo pou≈æijte tlaƒç√≠tko n√≠≈æe</div>
        `,a.appendChild(l)))}catch(e){logger.error("[Videot√©ka] Chyba p≈ôi naƒç√≠t√°n√≠ vide√≠:",e),s.innerHTML="<span>Chyba</span>",a.innerHTML=`
      <div style="text-align: center; padding: 3rem; color: #f44;">
        <div style="font-size: 1rem; margin-bottom: 0.5rem;">Chyba p≈ôi naƒç√≠t√°n√≠ vide√≠</div>
        <div style="font-size: 0.85rem; opacity: 0.7;">${e.message}</div>
      </div>
    `}var d=document.createElement("div"),p=(d.style.cssText="padding: 16px 20px; background: #333; border-top: 2px solid #444; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;",document.createElement("button")),m=(p.textContent="Nahr√°t video",p.style.cssText="padding: 12px 24px; font-size: 0.95rem; font-weight: 600; background: #2D5016; color: white; border: none; border-radius: 6px; cursor: pointer; min-width: 140px; touch-action: manipulation;",p.onclick=()=>otevritNahravaniVidea(r,t),document.createElement("button"));m.textContent="Zav≈ô√≠t",m.style.cssText="padding: 12px 24px; font-size: 0.95rem; font-weight: 600; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; min-width: 140px; touch-action: manipulation;",m.onclick=()=>t.remove(),d.appendChild(p),d.appendChild(m),a.appendChild(o),e.appendChild(s),e.appendChild(a),e.appendChild(d),t.appendChild(e),t.onclick=e=>{e.target===t&&t.remove()};let i=e=>{"Escape"===e.key&&(t.remove(),document.removeEventListener("keydown",i))};document.addEventListener("keydown",i),document.body.appendChild(t)}}function generujNahledVidea(e,s,l){return new Promise(i=>{let r=document.createElement("video"),d=(r.crossOrigin="anonymous",r.muted=!0,r.preload="metadata",setTimeout(()=>{r.src="",i(null)},5e3));r.onloadedmetadata=()=>{var e=Math.min(1,.1*r.duration);r.currentTime=e},r.onseeked=()=>{clearTimeout(d);try{var e=document.createElement("canvas"),t=r.videoWidth,a=r.videoHeight,o=Math.min(s/t,l/a,1);e.width=Math.round(t*o*2),e.height=Math.round(a*o*2);e.getContext("2d").drawImage(r,0,0,e.width,e.height);var n=e.toDataURL("image/jpeg",.7);r.src="",i(n)}catch(e){r.src="",i(null)}},r.onerror=()=>{clearTimeout(d),i(null)},r.src=e})}function vytvorVideoKartu(o,e){let n=window.innerWidth<600,i=document.createElement("div"),t=(i.style.cssText=`
    background: #2a2a2a;
    border-radius: 6px;
    padding: ${n?"8px":"12px"};
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    gap: ${n?"8px":"12px"};
    border: 1px solid #444;
    width: 100%;
    box-sizing: border-box;
  `,document.createElement("div"));var a=n?100:120,r=n?60:68,a=(t.style.cssText=`
    flex-shrink: 0;
    width: ${a}px;
    height: ${r}px;
    background: #1a1a1a;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #555;
    cursor: pointer;
    overflow: hidden;
    position: relative;
  `,t.innerHTML=`<span style="font-size: ${n?"1.5rem":"2rem"}; opacity: 0.5; color: #fff;">‚ñ∂</span>`,t.onclick=()=>prehratVideo(o.video_path,o.video_name),generujNahledVidea(o.video_path,a,r).then(e=>{e&&(t.innerHTML=`
        <img src="${e}" style="width: 100%; height: 100%; object-fit: cover;">
        <span style="position: absolute; font-size: ${n?"1.2rem":"1.5rem"}; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.8); opacity: 0.9;">‚ñ∂</span>
      `)}).catch(()=>{}),document.createElement("div")),d=(a.style.cssText="flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 2px; min-width: 0;",a.title=o.video_name,document.createElement("div")),s=(d.style.cssText=`font-weight: 500; font-size: ${n?"0.7rem":"0.9rem"}; color: ${n?"#aaa":"#fff"};`,o.uploader_email?(s=o.uploader_email.split("@")[0],d.textContent=s,d.title=o.uploader_email):(d.textContent="Admin",d.style.color="#888"),document.createElement("div")),l=(s.style.cssText=`display: flex; gap: ${n?"6px":"8px"}; flex-wrap: wrap; align-items: center;`,document.createElement("span")),c=(l.style.cssText=`font-size: ${n?"0.6rem":"0.7rem"}; color: #666;`,l.textContent=(o.file_size/1024/1024).toFixed(1)+" MB",document.createElement("span"));c.style.cssText=`font-size: ${n?"0.6rem":"0.7rem"}; color: #666;`;let p="‚Äî";o.uploaded_at&&(m=["ne","po","ut","st","ct","pa","so"][(g=new Date(o.uploaded_at)).getDay()],p=n?`${m} ${g.getDate()}.${g.getMonth()+1}.`:`${m} ${g.getDate()}.${g.getMonth()+1}.${g.getFullYear()} ${g.getHours().toString().padStart(2,"0")}:`+g.getMinutes().toString().padStart(2,"0")),c.textContent=p,s.appendChild(l),s.appendChild(c),a.appendChild(d),a.appendChild(s);var m=document.createElement("div");m.style.cssText=n?`display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; height: ${r}px; max-height: ${r}px; overflow: hidden; box-sizing: border-box;`:"display: flex; flex-direction: row; align-items: center; gap: 6px; flex-shrink: 0;";let u="height: 28px !important; min-height: 28px !important; max-height: 28px !important; width: 36px; padding: 0; margin: 0; border-radius: 3px; cursor: pointer; touch-action: manipulation; display: flex; align-items: center; justify-content: center; border: 1px solid #555; box-sizing: border-box;";var g=document.createElement("button");n?(g.innerHTML='<i class="fas fa-download"></i>',g.title="St√°hnout video",g.style.cssText=u+" background: #444; color: #ccc; font-size: 0.75rem;"):(g.textContent="St√°hnout",g.style.cssText="min-height: 36px; padding: 0.4rem 0.8rem; font-size: 0.8rem; border: 1px solid #555; border-radius: 4px; cursor: pointer; touch-action: manipulation; white-space: nowrap; background: #444; color: white;"),g.onclick=()=>{var e=document.createElement("a");e.href=o.video_path,e.download=o.video_name||"video.mp4",e.click()};let h=document.createElement("button"),v=n?u+" background: #442222; color: #c66; font-size: 0.85rem; font-weight: bold;":"min-height: 36px; width: 36px; padding: 0; font-size: 1.1rem; font-weight: bold; background: #553333; color: #c66; border: 1px solid #664444; border-radius: 4px; cursor: pointer; touch-action: manipulation; display: flex; align-items: center; justify-content: center;",f=(h.innerHTML="&#10005;",h.title="Smazat video",h.style.cssText=v,null);return h.onclick=async e=>{if(e.stopPropagation(),h.classList.contains("potvrzeni-video")){clearTimeout(f),h.innerHTML="...",h.disabled=!0;try{var t=new FormData;t.append("action","delete_video"),t.append("video_id",o.id),t.append("csrf_token",document.querySelector('input[name="csrf_token"]')?.value||"");var a=await(await fetch("/api/video_api.php",{method:"POST",body:t})).json();if("success"!==a.status)throw new Error(a.message||"Chyba p≈ôi maz√°n√≠");showToast("Video bylo smaz√°no","success"),i.remove()}catch(e){logger.error("[Videot√©ka] Chyba p≈ôi maz√°n√≠ videa:",e),showToast("Chyba p≈ôi maz√°n√≠ videa: "+e.message,"error"),h.classList.remove("potvrzeni-video"),h.innerHTML="&#10005;",h.style.cssText=v,h.disabled=!1}}else h.classList.add("potvrzeni-video"),h.innerHTML="Smazat?",h.style.cssText=n?u+" background: #662222; color: #fff; font-size: 0.7rem; font-weight: bold; min-width: 50px;":"min-height: 36px; padding: 0 8px; font-size: 0.75rem; font-weight: bold; background: #662222; color: #fff; border: 1px solid #884444; border-radius: 4px; cursor: pointer; touch-action: manipulation; white-space: nowrap;",f=setTimeout(()=>{h.classList.remove("potvrzeni-video"),h.innerHTML="&#10005;",h.style.cssText=v},3e3)},m.appendChild(g),m.appendChild(h),i.appendChild(t),i.appendChild(a),i.appendChild(m),i}function prehratVideo(e,t){let a=document.createElement("div"),o=(a.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10005; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem;",document.createElement("video"));o.src=e,o.controls=!0,o.autoplay=!0,o.style.cssText="max-width: 95%; max-height: 85vh; border-radius: 8px;";e=document.createElement("div"),e.style.cssText="color: white; font-size: 1rem; margin-top: 16px; text-align: center;",e.textContent=t||"Video",t=document.createElement("button");t.textContent="Zav≈ô√≠t",t.style.cssText="margin-top: 16px; padding: 10px 24px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;",t.onclick=()=>{o.pause(),a.remove()},a.appendChild(o),a.appendChild(e),a.appendChild(t),a.onclick=e=>{e.target===a&&(o.pause(),a.remove())};let n=e=>{"Escape"===e.key&&(o.pause(),a.remove(),document.removeEventListener("keydown",n))};document.addEventListener("keydown",n),document.body.appendChild(a)}function otevritNahravaniVidea(r,d){logger.log("[Videot√©ka] Otev√≠r√°m upload pro zak√°zku ID: "+r);let s=document.createElement("div");s.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10006; display: flex; align-items: center; justify-content: center; padding: 1rem;";var e=document.createElement("div"),t=(e.style.cssText="background: #2a2a2a; border-radius: 8px; padding: 24px; max-width: 500px; width: 100%; border: 2px solid #444;",document.createElement("h3"));t.style.cssText="color: white; margin: 0 0 20px 0; font-size: 1.1rem;",t.textContent="Nahr√°t video";let l=document.createElement("input");l.type="file",l.id="video",l.name="video",l.accept="video/*",l.style.cssText="display: block; width: 100%; padding: 12px; background: #1a1a1a; color: white; border: 1px solid #555; border-radius: 4px; margin-bottom: 16px; font-size: 0.9rem;";var a=document.createElement("div");a.style.cssText="background: #1a1a1a; padding: 12px; border-radius: 4px; margin-bottom: 16px; color: #999; font-size: 0.85rem; border: 1px solid #555;",a.innerHTML=`
    <div style="margin-bottom: 6px;">‚ÑπÔ∏è <strong>Informace o nahr√°v√°n√≠:</strong></div>
    <div style="margin-left: 24px;">
      <div>‚Ä¢ Maxim√°ln√≠ velikost: 500 MB</div>
      <div>‚Ä¢ Podporovan√© form√°ty: MP4, MOV, AVI, WebM</div>
      <div>‚Ä¢ Video nad 500 MB bude automaticky komprimov√°no</div>
    </div>
  `;let c=document.createElement("div");c.style.cssText="display: none; margin-bottom: 16px;";var o=document.createElement("div");o.style.cssText="width: 100%; height: 24px; background: #1a1a1a; border-radius: 4px; overflow: hidden; border: 1px solid #555;";let p=document.createElement("div"),m=(p.style.cssText="height: 100%; background: #2D5016; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;",o.appendChild(p),c.appendChild(o),document.createElement("div"));m.style.cssText="text-align: center; color: #999; font-size: 0.85rem; margin-top: 8px; display: none;",c.appendChild(m);o=document.createElement("div");o.style.cssText="display: flex; gap: 12px; justify-content: flex-end;";let u=document.createElement("button"),g=(u.textContent="Zru≈°it",u.style.cssText="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;",u.onclick=()=>s.remove(),document.createElement("button")),n=(g.textContent="Nahr√°t",g.style.cssText="padding: 10px 20px; background: #2D5016; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600;",g.onclick=async()=>{var a=l.files[0];if(a){var e=524288e3<a.size;g.disabled=!0,u.disabled=!0,c.classList.remove("hidden"),m.classList.remove("hidden");try{let t=a;if(e){m.textContent="Komprimuji video...",p.style.width="10%",p.textContent="10%";try{if("undefined"==typeof MediaRecorder)throw new Error("MediaRecorder nen√≠ podporov√°n");t=await komprimovatVideo(a,e=>{e=Math.round(10+40*e);p.style.width=e+"%",p.textContent=e+"%"}),logger.log(`[Videot√©ka] Video komprimov√°no: ${a.size} ‚Üí ${t.size} byt≈Ø`)}catch(e){if(logger.warn("[Videot√©ka] Komprese selhala, pou≈æ√≠v√°m origin√°l: "+e.message),t=a,m.textContent="Komprese nedostupn√°, nahr√°v√°m origin√°l...",524288e3<a.size)throw showToast("Video je p≈ô√≠li≈° velk√© (max 500 MB). Komprese selhala.","error"),new Error("Video p≈ô√≠li≈° velk√© a komprese nen√≠ dostupn√°")}}m.textContent="Nahr√°v√°m video...",p.style.width="50%",p.textContent="50%";var o=new FormData,n=(o.append("action","upload_video"),o.append("claim_id",r),o.append("video",t,t.name||a.name),o.append("csrf_token",document.querySelector('input[name="csrf_token"]')?.value||""),await fetch("/api/video_api.php",{method:"POST",body:o})),i=(p.style.width="90%",p.textContent="90%",await n.json());if("success"!==i.status)throw new Error(i.message||"Chyba p≈ôi nahr√°v√°n√≠");p.style.width="100%",p.textContent="100%",m.textContent="Hotovo!",p.style.background="#333","undefined"!=typeof WGSToast?WGSToast.zobrazit("Video bylo √∫spƒõ≈°nƒõ nahr√°no",{titulek:"WGS"}):showToast("Video bylo √∫spƒõ≈°nƒõ nahr√°no","success"),setTimeout(()=>{s.remove(),d.remove(),zobrazVideotekaArchiv(r)},1e3)}catch(e){logger.error("[Videot√©ka] Chyba p≈ôi uploadu:",e),p.style.background="#c33",m.textContent="Chyba: "+e.message,g.disabled=!1,u.disabled=!1,showToast("Chyba p≈ôi nahr√°v√°n√≠ videa: "+e.message,"error")}}else wgsToast.warning("Vyberte video soubor")},o.appendChild(u),o.appendChild(g),e.appendChild(t),e.appendChild(a),e.appendChild(l),e.appendChild(c),e.appendChild(o),s.appendChild(e),e=>{"Escape"!==e.key||g.disabled||(s.remove(),document.removeEventListener("keydown",n))});document.addEventListener("keydown",n),document.body.appendChild(s)}async function nahratVideoDragDrop(t,a,o){logger.log("[Videot√©ka] Zahajuji drag & drop upload: "+t.name);let n=document.createElement("div");n.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10007; display: flex; align-items: center; justify-content: center; padding: 1rem;";var e=document.createElement("div"),i=(e.style.cssText="background: #2a2a2a; border-radius: 8px; padding: 24px; max-width: 400px; width: 100%; border: 2px solid #444; text-align: center;",document.createElement("div")),r=(i.style.cssText="color: white; font-size: 1rem; font-weight: 600; margin-bottom: 16px;",i.textContent="Nahr√°v√°n√≠ videa...",document.createElement("div"));r.style.cssText="width: 100%; height: 24px; background: #1a1a1a; border-radius: 4px; overflow: hidden; border: 1px solid #555;";let d=document.createElement("div");d.style.cssText="height: 100%; background: #2D5016; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600;",d.textContent="0%";var s=document.createElement("div");s.style.cssText="color: #999; font-size: 0.85rem; margin-top: 12px;",s.textContent=t.name,r.appendChild(d),e.appendChild(i),e.appendChild(r),e.appendChild(s),n.appendChild(e),document.body.appendChild(n);try{let e=t;524288e3<t.size&&(s.textContent="Komprimuji video...",d.style.width="10%",d.textContent="10%",e=await komprimovatVideo(t,e=>{e=Math.round(10+40*e);d.style.width=e+"%",d.textContent=e+"%"}),logger.log(`[Videot√©ka] Video komprimov√°no: ${t.size} ‚Üí ${e.size} byt≈Ø`)),s.textContent="Odes√≠l√°m na server...",d.style.width="50%",d.textContent="50%";var l=new FormData,c=(l.append("action","upload_video"),l.append("claim_id",a),l.append("video",e,e.name||t.name),l.append("csrf_token",document.querySelector('input[name="csrf_token"]')?.value||""),await fetch("/api/video_api.php",{method:"POST",body:l})),p=(d.style.width="90%",d.textContent="90%",await c.json());if("success"!==p.status)throw new Error(p.message||"Chyba p≈ôi nahr√°v√°n√≠");d.style.width="100%",d.textContent="100%",s.textContent="Hotovo!",d.style.background="#333","undefined"!=typeof WGSToast?WGSToast.zobrazit("Video bylo √∫spƒõ≈°nƒõ nahr√°no",{titulek:"WGS"}):showToast("Video bylo √∫spƒõ≈°nƒõ nahr√°no","success"),setTimeout(()=>{n.remove(),o.remove(),zobrazVideotekaArchiv(a)},1e3)}catch(e){logger.error("[Videot√©ka] Chyba p≈ôi drag & drop uploadu:",e),d.style.background="#c33",d.style.width="100%",s.textContent="Chyba: "+e.message,showToast("Chyba p≈ôi nahr√°v√°n√≠ videa: "+e.message,"error"),setTimeout(()=>{n.remove()},3e3)}}async function komprimovatVideo(u,g){return new Promise((p,m)=>{try{let c=document.createElement("video");c.preload="metadata",c.muted=!0,c.playsInline=!0,c.onloadedmetadata=()=>{var e=c.videoWidth,n=c.videoHeight;let i=e,r=n;(1920<e||1080<n)&&(l=Math.min(1920/e,1080/n),i=Math.round(e*l),r=Math.round(n*l));e=document.createElement("canvas");e.width=i,e.height=r;let d=e.getContext("2d");var t,n=e.captureStream(30);let s="";for(t of["video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm","video/mp4"])if(MediaRecorder.isTypeSupported(t)){s=t;break}if(s){logger.log("[Videot√©ka] Pou≈æ√≠v√°m kodek: "+s);var l={mimeType:s,videoBitsPerSecond:25e5};let t;try{t=new MediaRecorder(n,l)}catch(e){t=new MediaRecorder(n,{mimeType:s})}let a=[],o=(t.ondataavailable=e=>{0<e.data.size&&a.push(e.data)},t.onstop=()=>{var e=new Blob(a,{type:s}),t=s.includes("mp4")?"mp4":"webm";e.name=u.name.replace(/\.[^.]+$/,"")+"_compressed."+t,p(e)},t.onerror=e=>{m(new Error("Chyba p≈ôi kompresi videa: "+(e.error?.message||"nezn√°m√°")))},t.start(1e3),c.play().catch(e=>{m(new Error("Nelze p≈ôehr√°t video pro kompresi: "+e.message))}),()=>{var e;c.paused||c.ended?setTimeout(()=>t.stop(),100):(d.drawImage(c,0,0,i,r),g&&(e=c.currentTime/c.duration,g(e)),requestAnimationFrame(o))});c.onplay=()=>{o()},c.onerror=()=>{m(new Error("Chyba p≈ôi naƒç√≠t√°n√≠ videa pro kompresi"))}}else m(new Error("≈Ω√°dn√Ω video kodek nen√≠ podporov√°n"))},c.onerror=()=>{m(new Error("Video soubor nelze naƒç√≠st"))},c.src=URL.createObjectURL(u)}catch(e){m(e)}})}window.wgsAudioRecorder={mediaRecorder:null,audioChunks:[],audioBlob:null,isRecording:!1,recordingStartTime:null,recordingTimer:null,permissionGranted:!1,stream:null},document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{var e=e.target.closest("[data-action]");e&&(e=e.getAttribute("data-action"),["openPDF","openKnihovnaPDF","startVisit","showCalendar","vytvorCenovouNabidku","showContactMenu","showCustomerDetail","closeDetail","deleteReklamace","showDetailById","showDetail","showNotes","closeNotesModal","deleteNote","saveNewNote","showHistoryPDF","showVideoteka","saveSelectedDate","previousMonth","nextMonth","showBookingDetail","showCalendarBack","openCalendarFromDetail","sendContactAttemptEmail","showPhotoFullscreen","smazatFotku","saveAllCustomerData","startRecording","stopRecording","deleteAudioPreview","closeErrorModal","filterUnreadNotes","otevritVyberFotek"].includes(e)||("reload"===e?location.reload():"function"==typeof window[e]&&window[e]()))}),document.addEventListener("click",e=>{e=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");e&&("function"==typeof navigateTo?navigateTo(e):location.href=e)}),document.addEventListener("change",e=>{var t,e=e.target.closest("[data-onchange]");e&&(t=e.getAttribute("data-onchange"),e=e.getAttribute("data-onchange-value")||e.value,"function"==typeof window[t])&&window[t](e)})}),window.otevritVyberFotek=otevritVyberFotek,window.zpracujVybraneFotky=zpracujVybraneFotky;