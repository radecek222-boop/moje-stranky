!async function(){try{const e=await fetch("/app/admin_session_check.php"),t=await e.json();if(!t.logged_in)throw logger.log("Nep≈ôihl√°≈°en - p≈ôesmƒõrov√°n√≠ na login"),window.location.href="login.php",new Error("Not authenticated");logger.log("P≈ôihl√°≈°en jako:",t.email)}catch(e){throw logger.error("Chyba kontroly session:",e),window.location.href="login.php",new Error("Auth check failed")}}();let currentCustomerData=null,currentSection="",sections={before:[],id:[],problem:[],damage_part:[],new_part:[],repair:[],after:[]};function loadCustomerData(){const e=localStorage.getItem("currentCustomer");if(!e)return showAlert("Chyb√≠ data z√°kazn√≠ka","error"),void setTimeout(()=>window.location.href="seznam.php",2e3);currentCustomerData=JSON.parse(e),logger.log("üì¶ Naƒçten√° data z√°kazn√≠ka:",currentCustomerData);const t=JSON.parse(localStorage.getItem("currentUser")||"{}");if("prodejce"===t.role&&currentCustomerData.zpracoval_id&&currentCustomerData.zpracoval_id!==t.id)return showAlert("Nem√°te opr√°vnƒõn√≠ k t√©to zak√°zce","error"),void setTimeout(()=>window.location.href="seznam.php",2e3);const o=currentCustomerData.jmeno||currentCustomerData.zakaznik||"N/A";let a="";if(currentCustomerData.adresa)a=currentCustomerData.adresa;else{const e=[];currentCustomerData.ulice&&e.push(currentCustomerData.ulice),currentCustomerData.mesto&&e.push(currentCustomerData.mesto),currentCustomerData.psc&&e.push(currentCustomerData.psc),a=e.join(", ")}const n=currentCustomerData.model||"-";let r="";r=currentCustomerData.telefon?currentCustomerData.telefon:currentCustomerData.email?currentCustomerData.email:"-",document.getElementById("customerName").textContent=o,document.getElementById("customerAddress").textContent=a||"Adresa neuvedena",document.getElementById("customerModel").textContent=n,document.getElementById("customerContact").textContent=r;const i=document.getElementById("customerInfoName");i&&(i.textContent=o),logger.log("Hlaviƒçka vyplnƒõna:",{"jm√©no":o,adresa:a,model:n,kontakt:r}),logger.log(`P≈ô√≠stup povolen: ${t.role} (${t.name})`)}async function loadExistingMedia(){if("true"===new URLSearchParams(window.location.search).get("new"))return await deleteFromServer(),sections={before:[],id:[],problem:[],damage_part:[],new_part:[],repair:[],after:[]},void logger.log("Zah√°jen√≠ nov√© n√°v≈°tƒõvy");const e=await loadFromServer();e?(sections=e,renderAllPreviews(),logger.log("Naƒçteny rozpracovan√© fotky")):sections={before:[],id:[],problem:[],damage_part:[],new_part:[],repair:[],after:[]}}function openMediaCapture(e){currentSection=e,document.getElementById("mediaInput").click()}async function handleMediaSelect(e){const t=Array.from(e.target.files);if(0===t.length)return;showWaitDialog(!0,`Zpracov√°v√°m ${t.length} soubor(≈Ø)...`);let o=0;for(const e of t){o++,showWaitDialog(!0,`Zpracov√°v√°m ${o}/${t.length}`);const a=e.type.startsWith("video/");try{if(a){const t=await compressVideo(e),o=await generateVideoThumbnail(e),a=await toBase64(t);sections[currentSection].push({type:"video",data:a,thumb:o,size:t.size})}else{const t=await compressImage(e),o=await toBase64(t);sections[currentSection].push({type:"image",data:o,size:t.size}),logger.log("[Photo] Fotka zpracov√°na - origin√°l v galerii, komprimovan√° verze v IndexedDB")}}catch(e){logger.error("Chyba zpracov√°n√≠:",e),showAlert("Chyba p≈ôi zpracov√°n√≠ souboru","error")}}await saveToServer(),renderAllPreviews(),updateProgress(),showWaitDialog(!1),"undefined"!=typeof WGSToast?WGSToast.zobrazit(`P≈ôid√°no ${t.length} soubor(≈Ø)`,{titulek:"WGS"}):showAlert(`P≈ôid√°no ${t.length} soubor(≈Ø)`,"success"),e.target.value=""}async function compressImage(e,t=800,o=.2){return new Promise(a=>{const n=new FileReader;n.onload=async e=>{const n=new Image;n.onload=async()=>{const e=document.createElement("canvas"),r=e.getContext("2d"),i=Math.min(1,t/Math.max(n.width,n.height));e.width=n.width*i,e.height=n.height*i,r.drawImage(n,0,0,e.width,e.height);let d=.6,s=await new Promise(t=>e.toBlob(t,"image/jpeg",d));for(;s.size>1024*o*1024&&d>.3;)d-=.05,s=await new Promise(t=>e.toBlob(t,"image/jpeg",d));logger.log(`[Photo] Fotka zkomprimov√°na: ${(s.size/1024).toFixed(0)} KB, kvalita: ${(100*d).toFixed(0)}%`),a(s)},n.src=e.target.result},n.readAsDataURL(e)})}async function compressVideo(e,t=1.5){const o=e.size/1048576;return o<=t?(logger.log(`[Video] Video ${o.toFixed(1)} MB je men≈°√≠ ne≈æ limit ${t} MB - bez komprese`),e):(logger.log(`[Video] Komprimuji video ${o.toFixed(1)} MB na cca ${t} MB...`),new Promise((t,a)=>{try{const a=document.createElement("video");a.preload="metadata",a.muted=!0,a.playsInline=!0,a.onloadedmetadata=()=>{const n=a.videoWidth,r=a.videoHeight;let i=n,d=r;if(n>1280||r>720){const e=Math.min(1280/n,720/r);i=Math.round(n*e),d=Math.round(r*e)}const s=document.createElement("canvas");s.width=i,s.height=d;const c=s.getContext("2d"),l=s.captureStream(24),u=["video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm","video/mp4"];let m="";for(const e of u)if(MediaRecorder.isTypeSupported(e)){m=e;break}if(!m)return logger.warn("[Video] ≈Ω√°dn√Ω video kodek nen√≠ podporov√°n, vrac√≠m origin√°l"),void t(e);logger.log(`[Video] Pou≈æ√≠v√°m kodek: ${m}`);const g={mimeType:m,videoBitsPerSecond:15e5};let p;try{p=new MediaRecorder(l,g)}catch(e){p=new MediaRecorder(l,{mimeType:m})}const h=[];p.ondataavailable=e=>{e.data.size>0&&h.push(e.data)},p.onstop=()=>{const e=new Blob(h,{type:m}),a=e.size/1048576;logger.log(`[Video] Komprese dokonƒçena: ${o.toFixed(1)} MB ‚Üí ${a.toFixed(1)} MB`),t(e)},p.onerror=o=>{logger.error("[Video] Chyba p≈ôi kompresi:",o),t(e)},p.start(1e3),a.play().catch(o=>{logger.error("[Video] Nelze p≈ôehr√°t video pro kompresi:",o),t(e)});const v=()=>{a.paused||a.ended?setTimeout(()=>p.stop(),100):(c.drawImage(a,0,0,i,d),requestAnimationFrame(v))};a.onplay=()=>{v()},a.onerror=()=>{logger.error("[Video] Chyba p≈ôi naƒç√≠t√°n√≠ videa pro kompresi"),t(e)}},a.onerror=()=>{logger.error("[Video] Video soubor nelze naƒç√≠st"),t(e)},a.src=URL.createObjectURL(e)}catch(o){logger.error("[Video] Chyba komprese:",o),t(e)}}))}async function generateVideoThumbnail(e){return new Promise(t=>{const o=document.createElement("video"),a=document.createElement("canvas"),n=a.getContext("2d");o.onloadedmetadata=()=>{o.currentTime=Math.min(1,o.duration/2)},o.onseeked=()=>{a.width=o.videoWidth,a.height=o.videoHeight,n.drawImage(o,0,0),a.toBlob(e=>{toBase64(e).then(t)},"image/jpeg",.6)},o.src=URL.createObjectURL(e)})}async function getImageOrientation(e){return new Promise(t=>{const o=new FileReader;o.onload=e=>{const o=new DataView(e.target.result);if(65496!==o.getUint16(0,!1))return void t(1);const a=o.byteLength;let n=2;for(;n<a;){if(o.getUint16(n+2,!1)<=8)return void t(1);const e=o.getUint16(n,!1);if(n+=2,65505===e){if(n+=2,1165519206!==o.getUint32(n,!1))return void t(1);const e=18761===o.getUint16(n+=6,!1);n+=o.getUint32(n+4,e);const a=o.getUint16(n,e);n+=2;for(let r=0;r<a;r++)if(274===o.getUint16(n+12*r,e)){const a=o.getUint16(n+12*r+8,e);return void t(a)}}else{if(65280&~e)break;n+=o.getUint16(n,!1)}}t(1)},o.onerror=()=>t(1),o.readAsArrayBuffer(e.slice(0,65536))})}function applyExifOrientation(e,t,o,a){switch(t){case 2:e.transform(-1,0,0,1,o,0);break;case 3:e.transform(-1,0,0,-1,o,a);break;case 4:e.transform(1,0,0,-1,0,a);break;case 5:e.transform(0,1,1,0,0,0);break;case 6:e.transform(0,1,-1,0,a,0);break;case 7:e.transform(0,-1,-1,0,a,o);break;case 8:e.transform(0,-1,1,0,0,o)}}function toBase64(e){return window.Utils&&window.Utils.toBase64?window.Utils.toBase64(e):new Promise(t=>{const o=new FileReader;o.onloadend=()=>t(o.result),o.readAsDataURL(e)})}function renderAllPreviews(){Object.keys(sections).forEach(e=>{renderPreview(e)})}function renderPreview(e){const t=document.getElementById("preview-"+e);t&&(t.innerHTML="",sections[e].forEach((o,a)=>{const n=document.createElement("div");n.className="media-thumb";const r=document.createElement("img");r.className="photo-thumb",r.alt="video"===o.type?"N√°hled videa":"N√°hled fotky",r.src="video"===o.type?o.thumb:o.data;const i=document.createElement("button");if(i.className="delete-thumb",i.innerHTML="√ó",i.onclick=t=>{t.stopPropagation(),deleteMedia(e,a)},n.appendChild(r),n.appendChild(i),"video"===o.type){const e=document.createElement("div");e.className="video-badge",e.textContent="Video",n.appendChild(e)}t.appendChild(n)}))}async function deleteMedia(e,t){sections[e].splice(t,1),await saveToServer(),renderPreview(e),updateProgress(),"undefined"!=typeof WGSToast?WGSToast.zobrazit("Soubor smaz√°n",{titulek:"WGS"}):showAlert("Soubor smaz√°n","success")}function updateProgress(){const e=Object.values(sections).reduce((e,t)=>e+t.length,0),t=Math.min(100,e/30*100);document.getElementById("progressBar").style.width=t+"%",document.getElementById("compressionInfo").textContent=`Celkem nahr√°no: ${e} soubor≈Ø (max 30 doporuƒçeno)`}async function saveToProtocol(){if(Object.values(sections).every(e=>0===e.length))showAlert("Nejd≈ô√≠ve nahrajte fotky nebo videa","error");else{showWaitDialog(!0,"Ukl√°d√°m fotografie...");try{const e=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");if(!e)throw new Error("CSRF token nebyl nalezen");const t=currentCustomerData.reklamace_id||currentCustomerData.cislo||currentCustomerData.id;if(!t)throw new Error("Chyb√≠ identifik√°tor reklamace");logger.log("üì§ Odes√≠l√°m fotky pro reklamaci:",t);const o=await fetch("/app/save_photos.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:t,sections:sections,csrf_token:e})}),a=await o.json();a.success?(await deleteFromServer(),showWaitDialog(!0,"P≈ôesmƒõrov√°n√≠ na protokol..."),localStorage.setItem("currentCustomer",JSON.stringify(currentCustomerData)),setTimeout(()=>{window.location.href=`protokol.php?id=${encodeURIComponent(t)}`},1500)):showAlert("Chyba p≈ôi ukl√°d√°n√≠: "+a.error,"error")}catch(e){logger.error("Chyba p≈ôi odes√≠l√°n√≠ fotek:",e),showAlert("Chyba p≈ôi odes√≠l√°n√≠: "+e.message,"error")}finally{showWaitDialog(!1)}}}async function downloadToGallery(e,t,o){try{const a=currentCustomerData?.reklamace_id||"unknown",n=(new Date).toISOString().slice(0,10).replace(/-/g,""),r={before:"PRED",id:"ID",detail:"DETAIL",damage_part:"POSKOZENY_DIL",new_part:"NOVY_DIL",repair:"OPRAVA",after:"PO",problem:"DETAIL_BUG"}[t]||t.toUpperCase(),i=`WGS_${a}_${r}_${o}_${n}.jpg`;logger.log(`[Gallery] üîΩ Startuji download: ${i}`),logger.log("[Gallery] üì± User Agent: "+(navigator.userAgent.includes("iPhone")?"iOS":navigator.userAgent.includes("Android")?"Android":"Desktop"));const d=document.createElement("a");return d.href=e,d.download=i,d.style.display="none",document.body.appendChild(d),await new Promise(e=>setTimeout(e,50)),d.click(),logger.log("[Gallery] üëÜ Klik na download link proveden"),await new Promise(e=>setTimeout(e,500)),document.body.removeChild(d),logger.log(`[Gallery] ‚úÖ Fotka automaticky sta≈æena: ${i}`),"undefined"!=typeof WGSToast&&WGSToast.zobrazit(`Fotka ulo≈æena do galerie: ${r}`,{titulek:"WGS",trvani:2e3}),!0}catch(e){return logger.error("[Gallery] ‚ùå Chyba p≈ôi stahov√°n√≠ do galerie:",e),logger.error("[Gallery] Stack:",e.stack),"undefined"!=typeof wgsToast&&wgsToast.error("Nepoda≈ôilo se ulo≈æit fotku do galerie. Fotka je st√°le ulo≈æena v aplikaci."),!1}}async function saveToServer(){if(void 0!==window.PhotoStorageDB&&currentCustomerData?.reklamace_id)try{return await window.PhotoStorageDB.save(currentCustomerData.reklamace_id,sections),logger.log("[IndexedDB] Fotky automaticky ulo≈æeny"),{success:!0}}catch(e){return logger.error("[IndexedDB] Chyba p≈ôi ukl√°d√°n√≠:",e),{success:!1,error:e.message}}return logger.log("[Save] PhotoStorageDB nen√≠ k dispozici"),{success:!0}}async function loadFromServer(){if(void 0!==window.PhotoStorageDB&&currentCustomerData?.reklamace_id)try{const e=await window.PhotoStorageDB.load(currentCustomerData.reklamace_id);if(e)return logger.log("üìÇ Fotky obnoveny z IndexedDB"),e}catch(e){logger.error("[IndexedDB] Chyba p≈ôi naƒç√≠t√°n√≠:",e)}return logger.log("üìÇ ≈Ω√°dn√© ulo≈æen√© fotky v IndexedDB"),null}async function deleteFromServer(){if(void 0!==window.PhotoStorageDB&&currentCustomerData?.reklamace_id)try{await window.PhotoStorageDB.delete(currentCustomerData.reklamace_id),logger.log("üóëÔ∏è Fotky smaz√°ny z IndexedDB")}catch(e){logger.error("[IndexedDB] Chyba p≈ôi maz√°n√≠:",e)}}function showWaitDialog(e,t="ƒåekejte..."){const o=document.getElementById("waitDialog"),a=document.getElementById("waitMsg");e?(a.textContent=t,o.classList.add("show")):o.classList.remove("show")}function showAlert(e,t="success"){const o=document.getElementById("alert");o.textContent=e,o.className="alert "+t,o.classList.add("show"),setTimeout(()=>{o.classList.remove("show")},3e3)}window.addEventListener("DOMContentLoaded",async()=>{logger.log("[Start] INICIALIZACE FOTODOKUMENTACE"),loadCustomerData(),await loadExistingMedia(),updateProgress(),document.getElementById("mediaInput").addEventListener("change",handleMediaSelect),document.getElementById("btnSaveToProtocol").addEventListener("click",saveToProtocol),await initVideoSection(),logger.log("Inicializace dokonƒçena")}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;const o=t.getAttribute("data-action");"reload"!==o?"function"==typeof window[o]&&window[o]():location.reload()}),document.addEventListener("click",e=>{const t=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");t&&("function"==typeof navigateTo?navigateTo(t):location.href=t)}),document.addEventListener("change",e=>{const t=e.target.closest("[data-onchange]");if(!t)return;const o=t.getAttribute("data-onchange"),a=t.getAttribute("data-onchange-value")||t.value;"function"==typeof window[o]&&window[o](a)}),document.querySelectorAll(".photo-section").forEach(e=>{const t=e.getAttribute("data-capture-type");t&&e.addEventListener("click",e=>{e.target.closest(".delete-thumb")||"function"==typeof openMediaCapture&&openMediaCapture(t)})})});let videotekaVideos=[];async function initVideoSection(){logger.log("[Video] Inicializace video sekce");const e=document.getElementById("btnNahratVideo");e&&e.addEventListener("click",()=>{document.getElementById("videoInput").click()});const t=document.getElementById("videoInput");t&&t.addEventListener("change",handleVideoSelect);const o=document.getElementById("btnCloseVideoModal");o&&o.addEventListener("click",zavritVideoModal);const a=document.getElementById("videoModalOverlay");a&&a.addEventListener("click",e=>{e.target===a&&zavritVideoModal()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&zavritVideoModal()}),await nactiVidea()}async function nactiVidea(){if(!currentCustomerData)return logger.warn("[Video] Nelze naƒç√≠st videa - currentCustomerData nen√≠ nastaveno"),void renderVideoPreview();if(!currentCustomerData.id)return logger.warn("[Video] Nelze naƒç√≠st videa - chyb√≠ ID zak√°zky v currentCustomerData:",currentCustomerData),void renderVideoPreview();const e=currentCustomerData.id;logger.log(`[Video] Naƒç√≠t√°m videa pro zak√°zku ID: ${e}, z√°kazn√≠k: ${currentCustomerData.jmeno||"N/A"}`);try{const t=await fetch(`/api/video_api.php?action=list_videos&claim_id=${e}`),o=await t.json();"success"===o.status&&o.videos?(videotekaVideos=o.videos,logger.log(`[Video] Naƒçteno ${videotekaVideos.length} vide√≠`)):videotekaVideos=[]}catch(e){logger.error("[Video] Chyba p≈ôi naƒç√≠t√°n√≠ vide√≠:",e),videotekaVideos=[]}renderVideoPreview()}function renderVideoPreview(){const e=document.getElementById("video-preview");e&&(e.innerHTML="",0!==videotekaVideos.length?videotekaVideos.forEach((t,o)=>{const a=vytvorVideoKartu(t,o);e.appendChild(a)}):e.innerHTML='<div class="video-preview-empty">Zat√≠m ≈æ√°dn√° videa</div>')}function vytvorVideoKartu(e,t){const o=document.createElement("div");o.className="video-card";const a=document.createElement("div");a.className="video-thumb-container",a.innerHTML='<span class="video-play-icon">‚ñ∂</span>',a.onclick=()=>prehratVideo(e.video_path,e.video_name),generujNahledVidea(e.video_path,100,60).then(e=>{if(e){const t=document.createElement("img");t.src=e,a.insertBefore(t,a.firstChild)}});const n=document.createElement("div");n.className="video-info";const r=document.createElement("div");r.className="video-info-name",r.textContent=e.video_name||`Video ${t+1}`,r.title=e.video_name;const i=document.createElement("div");i.className="video-info-meta";const d=(e.file_size/1024/1024).toFixed(1);let s="";if(e.uploaded_at){const t=new Date(e.uploaded_at);s=` | ${t.getDate()}.${t.getMonth()+1}.`}i.textContent=`${d} MB${s}`,n.appendChild(r),n.appendChild(i);const c=document.createElement("button");return c.className="video-delete-btn",c.innerHTML="√ó",c.onclick=t=>{t.stopPropagation(),smazatVideo(e.id)},o.appendChild(a),o.appendChild(n),o.appendChild(c),o}function generujNahledVidea(e,t,o){return new Promise(a=>{const n=document.createElement("video");n.crossOrigin="anonymous",n.muted=!0,n.preload="metadata";const r=setTimeout(()=>{n.src="",a(null)},5e3);n.onloadedmetadata=()=>{const e=Math.min(1,.1*n.duration);n.currentTime=e},n.onseeked=()=>{clearTimeout(r);try{const e=document.createElement("canvas"),r=n.videoWidth,i=n.videoHeight,d=Math.min(t/r,o/i,1);e.width=Math.round(r*d*2),e.height=Math.round(i*d*2);e.getContext("2d").drawImage(n,0,0,e.width,e.height);const s=e.toDataURL("image/jpeg",.7);n.src="",a(s)}catch(e){n.src="",a(null)}},n.onerror=()=>{clearTimeout(r),a(null)},n.src=e})}function prehratVideo(e,t){const o=document.getElementById("videoModalOverlay"),a=document.getElementById("videoPlayer"),n=document.getElementById("videoModalTitle");o&&a&&(n.textContent=t||"Video",a.src=e,o.classList.add("active"),a.play().catch(()=>{}))}function zavritVideoModal(){const e=document.getElementById("videoModalOverlay"),t=document.getElementById("videoPlayer");e&&e.classList.remove("active"),t&&(t.pause(),t.src="")}async function handleVideoSelect(e){const t=e.target.files[0];if(t)if(e.target.value="",t.type.startsWith("video/"))if(t.size>524288e3)showAlert("Video je p≈ô√≠li≈° velk√©. Maximum je 500 MB.","error");else if(currentCustomerData&&currentCustomerData.id){showWaitDialog(!0,"Nahr√°v√°m video...");try{const e=new FormData;e.append("action","upload_video"),e.append("claim_id",currentCustomerData.id),e.append("video",t,t.name);const o=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"";e.append("csrf_token",o);const a=await fetch("/api/video_api.php",{method:"POST",body:e,credentials:"include"}),n=await a.json();"success"===n.status?(showAlert("Video √∫spƒõ≈°nƒõ nahr√°no"),await nactiVidea()):showAlert(n.message||"Chyba p≈ôi nahr√°v√°n√≠ videa","error")}catch(e){logger.error("[Video] Chyba uploadu:",e),showAlert("Chyba p≈ôi nahr√°v√°n√≠ videa","error")}finally{showWaitDialog(!1)}}else showAlert("Chyb√≠ data z√°kazn√≠ka","error");else showAlert("Vyberte pros√≠m video soubor","error")}async function smazatVideo(e){if(confirm("Opravdu smazat toto video?")){showWaitDialog(!0,"Ma≈æu video...");try{const t=new FormData;t.append("action","delete_video"),t.append("video_id",e);const o=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"";t.append("csrf_token",o);const a=await fetch("/api/video_api.php",{method:"POST",body:t,credentials:"include"}),n=await a.json();"success"===n.status?(showAlert("Video smaz√°no"),await nactiVidea()):showAlert(n.message||"Chyba p≈ôi maz√°n√≠ videa","error")}catch(e){logger.error("[Video] Chyba maz√°n√≠:",e),showAlert("Chyba p≈ôi maz√°n√≠ videa","error")}finally{showWaitDialog(!1)}}}
//# sourceMappingURL=photocustomer.min.js.map