(async()=>{try{var e=await(await fetch("/app/admin_session_check.php")).json();if(!e.logged_in)throw logger.log("NepÅ™ihlÃ¡Å¡en - pÅ™esmÄ›rovÃ¡nÃ­ na login"),window.location.href="login.php",new Error("Not authenticated");logger.log("PÅ™ihlÃ¡Å¡en jako:",e.email)}catch(e){throw logger.error("Chyba kontroly session:",e),window.location.href="login.php",new Error("Auth check failed")}})();let currentCustomerData=null,currentSection="",sections={before:[],id:[],problem:[],damage_part:[],new_part:[],repair:[],after:[]};function loadCustomerData(){var o=localStorage.getItem("currentCustomer");if(o){currentCustomerData=JSON.parse(o),logger.log("ðŸ“¦ NaÄtenÃ¡ data zÃ¡kaznÃ­ka:",currentCustomerData);o=JSON.parse(localStorage.getItem("currentUser")||"{}");if("prodejce"===o.role&&currentCustomerData.zpracoval_id&&currentCustomerData.zpracoval_id!==o.id)showAlert("NemÃ¡te oprÃ¡vnÄ›nÃ­ k tÃ©to zakÃ¡zce","error"),setTimeout(()=>window.location.href="seznam.php",2e3);else{var a=currentCustomerData.jmeno||currentCustomerData.zakaznik||"N/A";let e="";e=currentCustomerData.adresa||(r=[],currentCustomerData.ulice&&r.push(currentCustomerData.ulice),currentCustomerData.mesto&&r.push(currentCustomerData.mesto),currentCustomerData.psc&&r.push(currentCustomerData.psc),r.join(", "));var r=currentCustomerData.model||"-";let t="";t=currentCustomerData.telefon||currentCustomerData.email||"-",document.getElementById("customerName").textContent=a,document.getElementById("customerAddress").textContent=e||"Adresa neuvedena",document.getElementById("customerModel").textContent=r,document.getElementById("customerContact").textContent=t;var n=document.getElementById("customerInfoName");n&&(n.textContent=a),logger.log("HlaviÄka vyplnÄ›na:",{"jmÃ©no":a,adresa:e,model:r,kontakt:t}),logger.log(`PÅ™Ã­stup povolen: ${o.role} (${o.name})`)}}else showAlert("ChybÃ­ data zÃ¡kaznÃ­ka","error"),setTimeout(()=>window.location.href="seznam.php",2e3)}async function loadExistingMedia(){var e;"true"===new URLSearchParams(window.location.search).get("new")?(await deleteFromServer(),sections={before:[],id:[],problem:[],damage_part:[],new_part:[],repair:[],after:[]},logger.log("ZahÃ¡jenÃ­ novÃ© nÃ¡vÅ¡tÄ›vy")):(e=await loadFromServer())?(sections=e,renderAllPreviews(),logger.log("NaÄteny rozpracovanÃ© fotky")):sections={before:[],id:[],problem:[],damage_part:[],new_part:[],repair:[],after:[]}}function openMediaCapture(e){currentSection=e,document.getElementById("mediaInput").click()}async function handleMediaSelect(t){var o=Array.from(t.target.files);if(0!==o.length){showWaitDialog(!0,`ZpracovÃ¡vÃ¡m ${o.length} soubor(Å¯)...`);let e=0;for(var a of o){showWaitDialog(!0,`ZpracovÃ¡vÃ¡m ${++e}/`+o.length);var r,n,i,s,l,c=a.type.startsWith("video/");try{c?(r=await compressVideo(a),n=await generateVideoThumbnail(a),i=await toBase64(r),sections[currentSection].push({type:"video",data:i,thumb:n,size:r.size})):(l=await toBase64(s=await compressImage(a)),sections[currentSection].push({type:"image",data:l,size:s.size}))}catch(e){logger.error("Chyba zpracovÃ¡nÃ­:",e),showAlert("Chyba pÅ™i zpracovÃ¡nÃ­ souboru","error")}}await saveToServer(),renderAllPreviews(),updateProgress(),showWaitDialog(!1),"undefined"!=typeof WGSToast?WGSToast.zobrazit(`PÅ™idÃ¡no ${o.length} soubor(Å¯)`,{titulek:"WGS"}):showAlert(`PÅ™idÃ¡no ${o.length} soubor(Å¯)`,"success"),t.target.value=""}}async function compressImage(t,s=800,l=.2){let c=await getImageOrientation(t);return new Promise(i=>{var e=new FileReader;e.onload=async e=>{let n=new Image;n.onload=async()=>{let t=document.createElement("canvas");var e=t.getContext("2d"),o=Math.min(1,s/Math.max(n.width,n.height));5<=c&&c<=8?(t.width=n.height*o,t.height=n.width*o):(t.width=n.width*o,t.height=n.height*o),applyExifOrientation(e,c,t.width,t.height),e.drawImage(n,0,0,t.width,t.height);let a=.6,r=await new Promise(e=>t.toBlob(e,"image/jpeg",a));for(;r.size>1024*l*1024&&.3<a;)a-=.05,r=await new Promise(e=>t.toBlob(e,"image/jpeg",a));logger.log(`[Photo] Fotka zkomprimovÃ¡na: ${(r.size/1024).toFixed(0)} KB, kvalita: ${(100*a).toFixed(0)}%`),i(r)},n.src=e.target.result},e.readAsDataURL(t)})}async function compressVideo(e,t=0){return e}async function generateVideoThumbnail(r){return new Promise(t=>{let e=document.createElement("video"),o=document.createElement("canvas"),a=o.getContext("2d");e.onloadedmetadata=()=>{e.currentTime=Math.min(1,e.duration/2)},e.onseeked=()=>{o.width=e.videoWidth,o.height=e.videoHeight,a.drawImage(e,0,0),o.toBlob(e=>{toBase64(e).then(t)},"image/jpeg",.6)},e.src=URL.createObjectURL(r)})}async function getImageOrientation(t){return new Promise(l=>{var e=new FileReader;e.onload=e=>{var o=new DataView(e.target.result);if(65496===o.getUint16(0,!1)){var a=o.byteLength;let t=2;for(;t<a;){if(o.getUint16(t+2,!1)<=8)return void l(1);var r=o.getUint16(t,!1);if(t+=2,65505===r){if(t+=2,1165519206!==o.getUint32(t,!1))return void l(1);var n,i=18761===o.getUint16(t+=6,!1),s=(t+=o.getUint32(t+4,i),o.getUint16(t,i));t+=2;for(let e=0;e<s;e++)if(274===o.getUint16(t+12*e,i))return n=o.getUint16(t+12*e+8,i),void l(n)}else{if(65280!=(65280&r))break;t+=o.getUint16(t,!1)}}}l(1)},e.onerror=()=>l(1),e.readAsArrayBuffer(t.slice(0,65536))})}function applyExifOrientation(e,t,o,a){switch(t){case 2:e.transform(-1,0,0,1,o,0);break;case 3:e.transform(-1,0,0,-1,o,a);break;case 4:e.transform(1,0,0,-1,0,a);break;case 5:e.transform(0,1,1,0,0,0);break;case 6:e.transform(0,1,-1,0,a,0);break;case 7:e.transform(0,-1,-1,0,a,o);break;case 8:e.transform(0,-1,1,0,0,o)}}function toBase64(o){return window.Utils&&window.Utils.toBase64?window.Utils.toBase64(o):new Promise(e=>{let t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(o)})}function renderAllPreviews(){Object.keys(sections).forEach(e=>{renderPreview(e)})}function renderPreview(n){let i=document.getElementById("preview-"+n);i&&(i.innerHTML="",sections[n].forEach((e,t)=>{var o=document.createElement("div"),a=(o.className="media-thumb",document.createElement("img")),r=(a.className="photo-thumb",a.alt="video"===e.type?"NÃ¡hled videa":"NÃ¡hled fotky",a.src="video"===e.type?e.thumb:e.data,document.createElement("button"));r.className="delete-thumb",r.innerHTML="Ã—",r.onclick=e=>{e.stopPropagation(),deleteMedia(n,t)},o.appendChild(a),o.appendChild(r),"video"===e.type&&((a=document.createElement("div")).className="video-badge",a.textContent="Video",o.appendChild(a)),i.appendChild(o)}))}async function deleteMedia(e,t){sections[e].splice(t,1),await saveToServer(),renderPreview(e),updateProgress(),"undefined"!=typeof WGSToast?WGSToast.zobrazit("Soubor smazÃ¡n",{titulek:"WGS"}):showAlert("Soubor smazÃ¡n","success")}function updateProgress(){var e=Object.values(sections).reduce((e,t)=>e+t.length,0),t=Math.min(100,e/30*100);document.getElementById("progressBar").style.width=t+"%",document.getElementById("compressionInfo").textContent=`Celkem nahrÃ¡no: ${e} souborÅ¯ (max 30 doporuÄeno)`}async function saveToProtocol(){if(Object.values(sections).every(e=>0===e.length))showAlert("NejdÅ™Ã­ve nahrajte fotky nebo videa","error");else{showWaitDialog(!0,"UklÃ¡dÃ¡m fotografie...");try{var t=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");if(!t)throw new Error("CSRF token nebyl nalezen");let e=currentCustomerData.reklamace_id||currentCustomerData.cislo||currentCustomerData.id;if(!e)throw new Error("ChybÃ­ identifikÃ¡tor reklamace");logger.log("ðŸ“¤ OdesÃ­lÃ¡m fotky pro reklamaci:",e);var o=await(await fetch("/app/save_photos.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:e,sections:sections,csrf_token:t})})).json();o.success?(showWaitDialog(!0,"PÅ™esmÄ›rovÃ¡nÃ­ na protokol..."),localStorage.setItem("currentCustomer",JSON.stringify(currentCustomerData)),setTimeout(()=>{window.location.href="protokol.php?id="+encodeURIComponent(e)},1500)):showAlert("Chyba pÅ™i uklÃ¡dÃ¡nÃ­: "+o.error,"error")}catch(e){logger.error("Chyba pÅ™i odesÃ­lÃ¡nÃ­ fotek:",e),showAlert("Chyba pÅ™i odesÃ­lÃ¡nÃ­: "+e.message,"error")}finally{showWaitDialog(!1)}}}async function saveToServer(){return logger.log("[Save] Fotky uloÅ¾eny lokÃ¡lnÄ› (server-side temp storage vypnut)"),{success:!0}}async function loadFromServer(){return logger.log("ðŸ“‚ LokÃ¡lnÃ­ ÃºloÅ¾iÅ¡tÄ› (server-side temp storage vypnut)"),null}async function deleteFromServer(){logger.log("ðŸ—‘ï¸ LokÃ¡lnÃ­ ÃºloÅ¾iÅ¡tÄ› vymazÃ¡no (server-side temp storage vypnut)")}function showWaitDialog(e,t="ÄŒekejte..."){var o=document.getElementById("waitDialog"),a=document.getElementById("waitMsg");e?(a.textContent=t,o.classList.add("show")):o.classList.remove("show")}function showAlert(e,t="success"){let o=document.getElementById("alert");o.textContent=e,o.className="alert "+t,o.classList.add("show"),setTimeout(()=>{o.classList.remove("show")},3e3)}window.addEventListener("DOMContentLoaded",async()=>{logger.log("[Start] INICIALIZACE FOTODOKUMENTACE"),loadCustomerData(),await loadExistingMedia(),updateProgress(),document.getElementById("mediaInput").addEventListener("change",handleMediaSelect),document.getElementById("btnSaveToProtocol").addEventListener("click",saveToProtocol),logger.log("Inicializace dokonÄena")}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{var e=e.target.closest("[data-action]");e&&("reload"===(e=e.getAttribute("data-action"))?location.reload():"function"==typeof window[e]&&window[e]())}),document.addEventListener("click",e=>{e=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");e&&("function"==typeof navigateTo?navigateTo(e):location.href=e)}),document.addEventListener("change",e=>{var t,e=e.target.closest("[data-onchange]");e&&(t=e.getAttribute("data-onchange"),e=e.getAttribute("data-onchange-value")||e.value,"function"==typeof window[t])&&window[t](e)}),document.querySelectorAll(".photo-section").forEach(e=>{let t=e.getAttribute("data-capture-type");t&&e.addEventListener("click",e=>{e.target.closest(".delete-thumb")||"function"==typeof openMediaCapture&&openMediaCapture(t)})})});