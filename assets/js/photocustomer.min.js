!async function(){try{const e=await fetch("/app/admin_session_check.php"),t=await e.json();if(!t.logged_in)throw logger.log("NepÅ™ihlÃ¡Å¡en - pÅ™esmÄ›rovÃ¡nÃ­ na login"),window.location.href="login.php",new Error("Not authenticated");logger.log("PÅ™ihlÃ¡Å¡en jako:",t.email)}catch(e){throw logger.error("Chyba kontroly session:",e),window.location.href="login.php",new Error("Auth check failed")}}();let currentCustomerData=null,currentSection="",sections={before:[],id:[],problem:[],repair:[],after:[]};function loadCustomerData(){const e=localStorage.getItem("currentCustomer");if(!e)return showAlert("ChybÃ­ data zÃ¡kaznÃ­ka","error"),void setTimeout(()=>window.location.href="seznam.php",2e3);currentCustomerData=JSON.parse(e),logger.log("ðŸ“¦ NaÄtenÃ¡ data zÃ¡kaznÃ­ka:",currentCustomerData);const t=JSON.parse(localStorage.getItem("currentUser")||"{}");if("prodejce"===t.role&&currentCustomerData.zpracoval_id&&currentCustomerData.zpracoval_id!==t.id)return showAlert("NemÃ¡te oprÃ¡vnÄ›nÃ­ k tÃ©to zakÃ¡zce","error"),void setTimeout(()=>window.location.href="seznam.php",2e3);const o=currentCustomerData.jmeno||currentCustomerData.zakaznik||"N/A";let n="";if(currentCustomerData.adresa)n=currentCustomerData.adresa;else{const e=[];currentCustomerData.ulice&&e.push(currentCustomerData.ulice),currentCustomerData.mesto&&e.push(currentCustomerData.mesto),currentCustomerData.psc&&e.push(currentCustomerData.psc),n=e.join(", ")}const a=currentCustomerData.model||"-";let r="";r=currentCustomerData.telefon?currentCustomerData.telefon:currentCustomerData.email?currentCustomerData.email:"-",document.getElementById("customerName").textContent=o,document.getElementById("customerAddress").textContent=n||"Adresa neuvedena",document.getElementById("customerModel").textContent=a,document.getElementById("customerContact").textContent=r;const s=document.getElementById("customerInfoName");s&&(s.textContent=o),logger.log("HlaviÄka vyplnÄ›na:",{"jmÃ©no":o,adresa:n,model:a,kontakt:r}),logger.log(`PÅ™Ã­stup povolen: ${t.role} (${t.name})`)}async function loadExistingMedia(){if("true"===new URLSearchParams(window.location.search).get("new"))return await deleteFromServer(),sections={before:[],id:[],problem:[],repair:[],after:[]},void logger.log("ZahÃ¡jenÃ­ novÃ© nÃ¡vÅ¡tÄ›vy");const e=await loadFromServer();e?(sections=e,renderAllPreviews(),logger.log("NaÄteny rozpracovanÃ© fotky")):sections={before:[],id:[],problem:[],repair:[],after:[]}}function openMediaCapture(e){currentSection=e,document.getElementById("mediaInput").click()}async function handleMediaSelect(e){const t=Array.from(e.target.files);if(0===t.length)return;showWaitDialog(!0,`ZpracovÃ¡vÃ¡m ${t.length} soubor(Å¯)...`);let o=0;for(const e of t){o++,showWaitDialog(!0,`ZpracovÃ¡vÃ¡m ${o}/${t.length}`);const n=e.type.startsWith("video/");try{if(n){const t=await compressVideo(e),o=await generateVideoThumbnail(e),n=await toBase64(t);sections[currentSection].push({type:"video",data:n,thumb:o,size:t.size})}else{const t=await compressImage(e),o=await toBase64(t);sections[currentSection].push({type:"image",data:o,size:t.size})}}catch(e){logger.error("Chyba zpracovÃ¡nÃ­:",e),showAlert("Chyba pÅ™i zpracovÃ¡nÃ­ souboru","error")}}await saveToServer(),renderAllPreviews(),updateProgress(),showWaitDialog(!1),showAlert(`PÅ™idÃ¡no ${t.length} soubor(Å¯)`,"success"),e.target.value=""}async function compressImage(e,t=800,o=.2){const n=await getImageOrientation(e);return new Promise(a=>{const r=new FileReader;r.onload=async e=>{const r=new Image;r.onload=async()=>{const e=document.createElement("canvas"),s=e.getContext("2d"),i=Math.min(1,t/Math.max(r.width,r.height));n>=5&&n<=8?(e.width=r.height*i,e.height=r.width*i):(e.width=r.width*i,e.height=r.height*i),applyExifOrientation(s,n,e.width,e.height),s.drawImage(r,0,0,e.width,e.height);let c=.6,l=await new Promise(t=>e.toBlob(t,"image/jpeg",c));for(;l.size>1024*o*1024&&c>.3;)c-=.05,l=await new Promise(t=>e.toBlob(t,"image/jpeg",c));logger.log(`[Photo] Fotka zkomprimovÃ¡na: ${(l.size/1024).toFixed(0)} KB, kvalita: ${(100*c).toFixed(0)}%`),a(l)},r.src=e.target.result},r.readAsDataURL(e)})}async function compressVideo(e,t=1.5){return e}async function generateVideoThumbnail(e){return new Promise(t=>{const o=document.createElement("video"),n=document.createElement("canvas"),a=n.getContext("2d");o.onloadedmetadata=()=>{o.currentTime=Math.min(1,o.duration/2)},o.onseeked=()=>{n.width=o.videoWidth,n.height=o.videoHeight,a.drawImage(o,0,0),n.toBlob(e=>{toBase64(e).then(t)},"image/jpeg",.6)},o.src=URL.createObjectURL(e)})}async function getImageOrientation(e){return new Promise(t=>{const o=new FileReader;o.onload=e=>{const o=new DataView(e.target.result);if(65496!==o.getUint16(0,!1))return void t(1);const n=o.byteLength;let a=2;for(;a<n;){if(o.getUint16(a+2,!1)<=8)return void t(1);const e=o.getUint16(a,!1);if(a+=2,65505===e){if(a+=2,1165519206!==o.getUint32(a,!1))return void t(1);const e=18761===o.getUint16(a+=6,!1);a+=o.getUint32(a+4,e);const n=o.getUint16(a,e);a+=2;for(let r=0;r<n;r++)if(274===o.getUint16(a+12*r,e)){const n=o.getUint16(a+12*r+8,e);return void t(n)}}else{if(65280&~e)break;a+=o.getUint16(a,!1)}}t(1)},o.onerror=()=>t(1),o.readAsArrayBuffer(e.slice(0,65536))})}function applyExifOrientation(e,t,o,n){switch(t){case 2:e.transform(-1,0,0,1,o,0);break;case 3:e.transform(-1,0,0,-1,o,n);break;case 4:e.transform(1,0,0,-1,0,n);break;case 5:e.transform(0,1,1,0,0,0);break;case 6:e.transform(0,1,-1,0,n,0);break;case 7:e.transform(0,-1,-1,0,n,o);break;case 8:e.transform(0,-1,1,0,0,o)}}function toBase64(e){return new Promise(t=>{const o=new FileReader;o.onloadend=()=>t(o.result),o.readAsDataURL(e)})}function renderAllPreviews(){Object.keys(sections).forEach(e=>{renderPreview(e)})}function renderPreview(e){const t=document.getElementById("preview-"+e);t&&(t.innerHTML="",sections[e].forEach((o,n)=>{const a=document.createElement("div");a.className="media-thumb";const r=document.createElement("img");r.className="photo-thumb",r.alt="video"===o.type?"NÃ¡hled videa":"NÃ¡hled fotky",r.src="video"===o.type?o.thumb:o.data;const s=document.createElement("button");if(s.className="delete-thumb",s.innerHTML="Ã—",s.onclick=t=>{t.stopPropagation(),deleteMedia(e,n)},a.appendChild(r),a.appendChild(s),"video"===o.type){const e=document.createElement("div");e.className="video-badge",e.textContent="Video",a.appendChild(e)}t.appendChild(a)}))}async function deleteMedia(e,t){sections[e].splice(t,1),await saveToServer(),renderPreview(e),updateProgress(),showAlert("Soubor smazÃ¡n","success")}function updateProgress(){const e=Object.values(sections).reduce((e,t)=>e+t.length,0),t=Math.min(100,e/30*100);document.getElementById("progressBar").style.width=t+"%",document.getElementById("compressionInfo").textContent=`Celkem nahrÃ¡no: ${e} souborÅ¯ (max 30 doporuÄeno)`}async function saveToProtocol(){if(Object.values(sections).every(e=>0===e.length))showAlert("NejdÅ™Ã­ve nahrajte fotky nebo videa","error");else{showWaitDialog(!0,"UklÃ¡dÃ¡m fotografie...");try{const e=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");if(!e)throw new Error("CSRF token nebyl nalezen");const t=currentCustomerData.reklamace_id||currentCustomerData.cislo||currentCustomerData.id;if(!t)throw new Error("ChybÃ­ identifikÃ¡tor reklamace");logger.log("ðŸ“¤ OdesÃ­lÃ¡m fotky pro reklamaci:",t);const o=await fetch("/app/save_photos.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:t,sections:sections,csrf_token:e})}),n=await o.json();n.success?(showWaitDialog(!0,"PÅ™esmÄ›rovÃ¡nÃ­ na protokol..."),localStorage.setItem("currentCustomer",JSON.stringify(currentCustomerData)),setTimeout(()=>{window.location.href=`protokol.php?id=${encodeURIComponent(t)}`},1500)):showAlert("Chyba pÅ™i uklÃ¡dÃ¡nÃ­: "+n.error,"error")}catch(e){logger.error("Chyba pÅ™i odesÃ­lÃ¡nÃ­ fotek:",e),showAlert("Chyba pÅ™i odesÃ­lÃ¡nÃ­: "+e.message,"error")}finally{showWaitDialog(!1)}}}async function saveToServer(){return logger.log("[Save] Fotky uloÅ¾eny lokÃ¡lnÄ› (server-side temp storage vypnut)"),{success:!0}}async function loadFromServer(){return logger.log("ðŸ“‚ LokÃ¡lnÃ­ ÃºloÅ¾iÅ¡tÄ› (server-side temp storage vypnut)"),null}async function deleteFromServer(){logger.log("ðŸ—‘ï¸ LokÃ¡lnÃ­ ÃºloÅ¾iÅ¡tÄ› vymazÃ¡no (server-side temp storage vypnut)")}function showWaitDialog(e,t="ÄŒekejte..."){const o=document.getElementById("waitDialog"),n=document.getElementById("waitMsg");e?(n.textContent=t,o.classList.add("show")):o.classList.remove("show")}function showAlert(e,t="success"){const o=document.getElementById("alert");o.textContent=e,o.className="alert "+t,o.classList.add("show"),setTimeout(()=>{o.classList.remove("show")},3e3)}window.addEventListener("DOMContentLoaded",async()=>{logger.log("[Start] INICIALIZACE FOTODOKUMENTACE"),loadCustomerData(),await loadExistingMedia(),updateProgress(),document.getElementById("mediaInput").addEventListener("change",handleMediaSelect),document.getElementById("btnSaveToProtocol").addEventListener("click",saveToProtocol),logger.log("Inicializace dokonÄena")}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;const o=t.getAttribute("data-action");"reload"!==o?"function"==typeof window[o]&&window[o]():location.reload()}),document.addEventListener("click",e=>{const t=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");t&&("function"==typeof navigateTo?navigateTo(t):location.href=t)}),document.addEventListener("change",e=>{const t=e.target.closest("[data-onchange]");if(!t)return;const o=t.getAttribute("data-onchange"),n=t.getAttribute("data-onchange-value")||t.value;"function"==typeof window[o]&&window[o](n)}),document.querySelectorAll(".photo-section").forEach(e=>{const t=e.getAttribute("data-capture-type");t&&e.addEventListener("click",e=>{e.target.closest(".delete-thumb")||"function"==typeof openMediaCapture&&openMediaCapture(t)})})});
//# sourceMappingURL=photocustomer.min.js.map