(async()=>{try{var e=await(await fetch("/app/admin_session_check.php")).json();if(!e.logged_in)throw logger.log("Nep≈ôihl√°≈°en - p≈ôesmƒõrov√°n√≠ na login"),window.location.href="login.php",new Error("Not authenticated");logger.log("P≈ôihl√°≈°en jako:",e.email)}catch(e){throw logger.error("Chyba kontroly session:",e),window.location.href="login.php",new Error("Auth check failed")}})();let currentCustomerData=null,currentSection="",sections={before:[],id:[],problem:[],damage_part:[],new_part:[],repair:[],after:[]};function loadCustomerData(){var a=localStorage.getItem("currentCustomer");if(a){currentCustomerData=JSON.parse(a),logger.log("üì¶ Naƒçten√° data z√°kazn√≠ka:",currentCustomerData);a=JSON.parse(localStorage.getItem("currentUser")||"{}");if("prodejce"===a.role&&currentCustomerData.zpracoval_id&&currentCustomerData.zpracoval_id!==a.id)showAlert("Nem√°te opr√°vnƒõn√≠ k t√©to zak√°zce","error"),setTimeout(()=>window.location.href="seznam.php",2e3);else{var o=currentCustomerData.jmeno||currentCustomerData.zakaznik||"N/A";let e="";e=currentCustomerData.adresa||(r=[],currentCustomerData.ulice&&r.push(currentCustomerData.ulice),currentCustomerData.mesto&&r.push(currentCustomerData.mesto),currentCustomerData.psc&&r.push(currentCustomerData.psc),r.join(", "));var r=currentCustomerData.model||"-";let t="";t=currentCustomerData.telefon||currentCustomerData.email||"-",document.getElementById("customerName").textContent=o,document.getElementById("customerAddress").textContent=e||"Adresa neuvedena",document.getElementById("customerModel").textContent=r,document.getElementById("customerContact").textContent=t;var n=document.getElementById("customerInfoName");n&&(n.textContent=o),logger.log("Hlaviƒçka vyplnƒõna:",{"jm√©no":o,adresa:e,model:r,kontakt:t}),logger.log(`P≈ô√≠stup povolen: ${a.role} (${a.name})`)}}else showAlert("Chyb√≠ data z√°kazn√≠ka","error"),setTimeout(()=>window.location.href="seznam.php",2e3)}async function loadExistingMedia(){var e;"true"===new URLSearchParams(window.location.search).get("new")?(await deleteFromServer(),sections={before:[],id:[],problem:[],damage_part:[],new_part:[],repair:[],after:[]},logger.log("Zah√°jen√≠ nov√© n√°v≈°tƒõvy")):(e=await loadFromServer())?(sections=e,renderAllPreviews(),logger.log("Naƒçteny rozpracovan√© fotky")):sections={before:[],id:[],problem:[],damage_part:[],new_part:[],repair:[],after:[]}}function openMediaCapture(e){currentSection=e,document.getElementById("mediaInput").click()}async function handleMediaSelect(t){var a=Array.from(t.target.files);if(0!==a.length){showWaitDialog(!0,`Zpracov√°v√°m ${a.length} soubor(≈Ø)...`);let e=0;for(var o of a){showWaitDialog(!0,`Zpracov√°v√°m ${++e}/`+a.length);var r,n,i,d,s,c=o.type.startsWith("video/");try{c?(r=await compressVideo(o),n=await generateVideoThumbnail(o),i=await toBase64(r),sections[currentSection].push({type:"video",data:i,thumb:n,size:r.size})):(s=await toBase64(d=await compressImage(o)),sections[currentSection].push({type:"image",data:s,size:d.size}))}catch(e){logger.error("Chyba zpracov√°n√≠:",e),showAlert("Chyba p≈ôi zpracov√°n√≠ souboru","error")}}await saveToServer(),renderAllPreviews(),updateProgress(),showWaitDialog(!1),"undefined"!=typeof WGSToast?WGSToast.zobrazit(`P≈ôid√°no ${a.length} soubor(≈Ø)`,{titulek:"WGS"}):showAlert(`P≈ôid√°no ${a.length} soubor(≈Ø)`,"success"),t.target.value=""}}async function compressImage(t,d=800,s=.2){let c=await getImageOrientation(t);return new Promise(i=>{var e=new FileReader;e.onload=async e=>{let n=new Image;n.onload=async()=>{let t=document.createElement("canvas");var e=t.getContext("2d"),a=Math.min(1,d/Math.max(n.width,n.height));5<=c&&c<=8?(t.width=n.height*a,t.height=n.width*a):(t.width=n.width*a,t.height=n.height*a),applyExifOrientation(e,c,t.width,t.height),e.drawImage(n,0,0,t.width,t.height);let o=.6,r=await new Promise(e=>t.toBlob(e,"image/jpeg",o));for(;r.size>1024*s*1024&&.3<o;)o-=.05,r=await new Promise(e=>t.toBlob(e,"image/jpeg",o));logger.log(`[Photo] Fotka zkomprimov√°na: ${(r.size/1024).toFixed(0)} KB, kvalita: ${(100*o).toFixed(0)}%`),i(r)},n.src=e.target.result},e.readAsDataURL(t)})}async function compressVideo(e,t=0){return e}async function generateVideoThumbnail(r){return new Promise(t=>{let e=document.createElement("video"),a=document.createElement("canvas"),o=a.getContext("2d");e.onloadedmetadata=()=>{e.currentTime=Math.min(1,e.duration/2)},e.onseeked=()=>{a.width=e.videoWidth,a.height=e.videoHeight,o.drawImage(e,0,0),a.toBlob(e=>{toBase64(e).then(t)},"image/jpeg",.6)},e.src=URL.createObjectURL(r)})}async function getImageOrientation(t){return new Promise(s=>{var e=new FileReader;e.onload=e=>{var a=new DataView(e.target.result);if(65496===a.getUint16(0,!1)){var o=a.byteLength;let t=2;for(;t<o;){if(a.getUint16(t+2,!1)<=8)return void s(1);var r=a.getUint16(t,!1);if(t+=2,65505===r){if(t+=2,1165519206!==a.getUint32(t,!1))return void s(1);var n,i=18761===a.getUint16(t+=6,!1),d=(t+=a.getUint32(t+4,i),a.getUint16(t,i));t+=2;for(let e=0;e<d;e++)if(274===a.getUint16(t+12*e,i))return n=a.getUint16(t+12*e+8,i),void s(n)}else{if(65280!=(65280&r))break;t+=a.getUint16(t,!1)}}}s(1)},e.onerror=()=>s(1),e.readAsArrayBuffer(t.slice(0,65536))})}function applyExifOrientation(e,t,a,o){switch(t){case 2:e.transform(-1,0,0,1,a,0);break;case 3:e.transform(-1,0,0,-1,a,o);break;case 4:e.transform(1,0,0,-1,0,o);break;case 5:e.transform(0,1,1,0,0,0);break;case 6:e.transform(0,1,-1,0,o,0);break;case 7:e.transform(0,-1,-1,0,o,a);break;case 8:e.transform(0,-1,1,0,0,a)}}function toBase64(a){return window.Utils&&window.Utils.toBase64?window.Utils.toBase64(a):new Promise(e=>{let t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(a)})}function renderAllPreviews(){Object.keys(sections).forEach(e=>{renderPreview(e)})}function renderPreview(n){let i=document.getElementById("preview-"+n);i&&(i.innerHTML="",sections[n].forEach((e,t)=>{var a=document.createElement("div"),o=(a.className="media-thumb",document.createElement("img")),r=(o.className="photo-thumb",o.alt="video"===e.type?"N√°hled videa":"N√°hled fotky",o.src="video"===e.type?e.thumb:e.data,document.createElement("button"));r.className="delete-thumb",r.innerHTML="√ó",r.onclick=e=>{e.stopPropagation(),deleteMedia(n,t)},a.appendChild(o),a.appendChild(r),"video"===e.type&&((o=document.createElement("div")).className="video-badge",o.textContent="Video",a.appendChild(o)),i.appendChild(a)}))}async function deleteMedia(e,t){sections[e].splice(t,1),await saveToServer(),renderPreview(e),updateProgress(),"undefined"!=typeof WGSToast?WGSToast.zobrazit("Soubor smaz√°n",{titulek:"WGS"}):showAlert("Soubor smaz√°n","success")}function updateProgress(){var e=Object.values(sections).reduce((e,t)=>e+t.length,0),t=Math.min(100,e/30*100);document.getElementById("progressBar").style.width=t+"%",document.getElementById("compressionInfo").textContent=`Celkem nahr√°no: ${e} soubor≈Ø (max 30 doporuƒçeno)`}async function saveToProtocol(){if(Object.values(sections).every(e=>0===e.length))showAlert("Nejd≈ô√≠ve nahrajte fotky nebo videa","error");else{showWaitDialog(!0,"Ukl√°d√°m fotografie...");try{var t=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");if(!t)throw new Error("CSRF token nebyl nalezen");let e=currentCustomerData.reklamace_id||currentCustomerData.cislo||currentCustomerData.id;if(!e)throw new Error("Chyb√≠ identifik√°tor reklamace");logger.log("üì§ Odes√≠l√°m fotky pro reklamaci:",e);var a=await(await fetch("/app/save_photos.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reklamace_id:e,sections:sections,csrf_token:t})})).json();a.success?(showWaitDialog(!0,"P≈ôesmƒõrov√°n√≠ na protokol..."),localStorage.setItem("currentCustomer",JSON.stringify(currentCustomerData)),setTimeout(()=>{window.location.href="protokol.php?id="+encodeURIComponent(e)},1500)):showAlert("Chyba p≈ôi ukl√°d√°n√≠: "+a.error,"error")}catch(e){logger.error("Chyba p≈ôi odes√≠l√°n√≠ fotek:",e),showAlert("Chyba p≈ôi odes√≠l√°n√≠: "+e.message,"error")}finally{showWaitDialog(!1)}}}async function saveToServer(){return logger.log("[Save] Fotky ulo≈æeny lok√°lnƒõ (server-side temp storage vypnut)"),{success:!0}}async function loadFromServer(){return logger.log("üìÇ Lok√°ln√≠ √∫lo≈æi≈°tƒõ (server-side temp storage vypnut)"),null}async function deleteFromServer(){logger.log("üóëÔ∏è Lok√°ln√≠ √∫lo≈æi≈°tƒõ vymaz√°no (server-side temp storage vypnut)")}function showWaitDialog(e,t="ƒåekejte..."){var a=document.getElementById("waitDialog"),o=document.getElementById("waitMsg");e?(o.textContent=t,a.classList.add("show")):a.classList.remove("show")}function showAlert(e,t="success"){let a=document.getElementById("alert");a.textContent=e,a.className="alert "+t,a.classList.add("show"),setTimeout(()=>{a.classList.remove("show")},3e3)}window.addEventListener("DOMContentLoaded",async()=>{logger.log("[Start] INICIALIZACE FOTODOKUMENTACE"),loadCustomerData(),await loadExistingMedia(),updateProgress(),document.getElementById("mediaInput").addEventListener("change",handleMediaSelect),document.getElementById("btnSaveToProtocol").addEventListener("click",saveToProtocol),logger.log("Inicializace dokonƒçena")}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{var e=e.target.closest("[data-action]");e&&("reload"===(e=e.getAttribute("data-action"))?location.reload():"function"==typeof window[e]&&window[e]())}),document.addEventListener("click",e=>{e=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");e&&("function"==typeof navigateTo?navigateTo(e):location.href=e)}),document.addEventListener("change",e=>{var t,e=e.target.closest("[data-onchange]");e&&(t=e.getAttribute("data-onchange"),e=e.getAttribute("data-onchange-value")||e.value,"function"==typeof window[t])&&window[t](e)}),document.querySelectorAll(".photo-section").forEach(e=>{let t=e.getAttribute("data-capture-type");t&&e.addEventListener("click",e=>{e.target.closest(".delete-thumb")||"function"==typeof openMediaCapture&&openMediaCapture(t)})}),initVideoSection()});let videotekaVideos=[];async function initVideoSection(){logger.log("[Video] Inicializace video sekce");var e=document.getElementById("btnNahratVideo"),e=(e&&e.addEventListener("click",()=>{document.getElementById("videoInput").click()}),document.getElementById("videoInput")),e=(e&&e.addEventListener("change",handleVideoSelect),document.getElementById("btnCloseVideoModal"));e&&e.addEventListener("click",zavritVideoModal);let t=document.getElementById("videoModalOverlay");t&&t.addEventListener("click",e=>{e.target===t&&zavritVideoModal()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&zavritVideoModal()}),await nactiVidea()}async function nactiVidea(){if(currentCustomerData&&currentCustomerData.id){var e=currentCustomerData.id;try{var t=await(await fetch("/api/video_api.php?action=list_videos&claim_id="+e)).json();"success"===t.status&&t.videos?(videotekaVideos=t.videos,logger.log(`[Video] Naƒçteno ${videotekaVideos.length} vide√≠`)):videotekaVideos=[]}catch(e){logger.error("[Video] Chyba p≈ôi naƒç√≠t√°n√≠ vide√≠:",e),videotekaVideos=[]}}else logger.log("[Video] Nelze naƒç√≠st videa - chyb√≠ customer data");renderVideoPreview()}function renderVideoPreview(){let a=document.getElementById("video-preview");a&&(a.innerHTML="",0===videotekaVideos.length?a.innerHTML='<div class="video-preview-empty">Zat√≠m ≈æ√°dn√° videa</div>':videotekaVideos.forEach((e,t)=>{e=vytvorVideoKartu(e,t);a.appendChild(e)}))}function vytvorVideoKartu(t,e){var a=document.createElement("div");a.className="video-card";let o=document.createElement("div");o.className="video-thumb-container",o.innerHTML='<span class="video-play-icon">‚ñ∂</span>',o.onclick=()=>prehratVideo(t.video_path,t.video_name),generujNahledVidea(t.video_path,100,60).then(e=>{var t;e&&((t=document.createElement("img")).src=e,o.insertBefore(t,o.firstChild))});var r=document.createElement("div"),n=(r.className="video-info",document.createElement("div")),e=(n.className="video-info-name",n.textContent=t.video_name||"Video "+(e+1),n.title=t.video_name,document.createElement("div")),i=(e.className="video-info-meta",(t.file_size/1024/1024).toFixed(1));let d="";t.uploaded_at&&(s=new Date(t.uploaded_at),d=` | ${s.getDate()}.${s.getMonth()+1}.`),e.textContent=i+" MB"+d,r.appendChild(n),r.appendChild(e);var s=document.createElement("button");return s.className="video-delete-btn",s.innerHTML="√ó",s.onclick=e=>{e.stopPropagation(),smazatVideo(t.id)},a.appendChild(o),a.appendChild(r),a.appendChild(s),a}function generujNahledVidea(e,s,c){return new Promise(n=>{let i=document.createElement("video"),d=(i.crossOrigin="anonymous",i.muted=!0,i.preload="metadata",setTimeout(()=>{i.src="",n(null)},5e3));i.onloadedmetadata=()=>{var e=Math.min(1,.1*i.duration);i.currentTime=e},i.onseeked=()=>{clearTimeout(d);try{var e=document.createElement("canvas"),t=i.videoWidth,a=i.videoHeight,o=Math.min(s/t,c/a,1);e.width=Math.round(t*o*2),e.height=Math.round(a*o*2);e.getContext("2d").drawImage(i,0,0,e.width,e.height);var r=e.toDataURL("image/jpeg",.7);i.src="",n(r)}catch(e){i.src="",n(null)}},i.onerror=()=>{clearTimeout(d),n(null)},i.src=e})}function prehratVideo(e,t){var a=document.getElementById("videoModalOverlay"),o=document.getElementById("videoPlayer"),r=document.getElementById("videoModalTitle");a&&o&&(r.textContent=t||"Video",o.src=e,a.classList.add("active"),o.play().catch(()=>{}))}function zavritVideoModal(){var e=document.getElementById("videoModalOverlay"),t=document.getElementById("videoPlayer");e&&e.classList.remove("active"),t&&(t.pause(),t.src="")}async function handleVideoSelect(e){var t=e.target.files[0];if(t)if(e.target.value="",t.type.startsWith("video/"))if(524288e3<t.size)showAlert("Video je p≈ô√≠li≈° velk√©. Maximum je 500 MB.","error");else if(currentCustomerData&&currentCustomerData.id){showWaitDialog(!0,"Nahr√°v√°m video...");try{var a=new FormData,o=(a.append("action","upload_video"),a.append("claim_id",currentCustomerData.id),a.append("video",t,t.name),document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"");a.append("csrf_token",o);var r=await(await fetch("/api/video_api.php",{method:"POST",body:a,credentials:"include"})).json();"success"===r.status?(showAlert("Video √∫spƒõ≈°nƒõ nahr√°no"),await nactiVidea()):showAlert(r.message||"Chyba p≈ôi nahr√°v√°n√≠ videa","error")}catch(e){logger.error("[Video] Chyba uploadu:",e),showAlert("Chyba p≈ôi nahr√°v√°n√≠ videa","error")}finally{showWaitDialog(!1)}}else showAlert("Chyb√≠ data z√°kazn√≠ka","error");else showAlert("Vyberte pros√≠m video soubor","error")}async function smazatVideo(e){if(confirm("Opravdu smazat toto video?")){showWaitDialog(!0,"Ma≈æu video...");try{var t=new FormData,a=(t.append("action","delete_video"),t.append("video_id",e),document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"");t.append("csrf_token",a);var o=await(await fetch("/api/video_api.php",{method:"POST",body:t,credentials:"include"})).json();"success"===o.status?(showAlert("Video smaz√°no"),await nactiVidea()):showAlert(o.message||"Chyba p≈ôi maz√°n√≠ videa","error")}catch(e){logger.error("[Video] Chyba maz√°n√≠:",e),showAlert("Chyba p≈ôi maz√°n√≠ videa","error")}finally{showWaitDialog(!1)}}}