// üîí BEZPEƒåNOSTN√ç KONTROLA - P≈òESUNUTA DO checkAuth() funkce n√≠≈æe
// POZN√ÅMKA: IIFE bylo odstranƒõno, proto≈æe zp≈Øsobovalo okam≈æit√© p≈ôesmƒõrov√°n√≠ p≈ôed naƒçten√≠m str√°nky
// Auth check nyn√≠ prob√≠h√° v checkAuth() po DOMContentLoaded// === MOBILE MENU ===function toggleMobileMenu(){const hamburger = document.getElementById('hamburger');const mobileMenu = document.getElementById('mobileMenu');const backdrop = document.getElementById('mobileMenuBackdrop');hamburger.classList.toggle('active');mobileMenu.classList.toggle('show');backdrop.classList.toggle('show');// Prevent body scroll when menu is open if (mobileMenu.classList.contains('show')){document.body.style.overflow = 'hidden'}else{document.body.style.overflow = ''}}function navigateTo(url){// Close mobile menu before navigation const mobileMenu = document.getElementById('mobileMenu');if (mobileMenu && mobileMenu.classList.contains('show')){toggleMobileMenu()}// Small delay for smooth transition setTimeout(() =>{window.location.href = url},300)}// === GLOBALS ===const ANALYTICS ={currentUser:null,timePeriod:'week',data:{visits:[],events:[],sessions:{},stats:{},claims:[]},apiAvailable:false};// === INIT ===window.addEventListener('DOMContentLoaded',() =>{checkAuth();loadAllData();startRealtimeUpdates()});// === AUTH ===async function checkAuth(){try{const response = await fetch('app/admin_session_check.php');if (response.ok){const result = await response.json();if (result.authenticated){ANALYTICS.currentUser ={id:'admin-session',name:'Admin',email:result.email || 'admin@wgs.cz',role:'admin'};document.getElementById('userName').textContent = ANALYTICS.currentUser.name;return}}}catch (err){logger.log('PHP session check not available')}window.location.href = 'login.php'}function logout(){window.location.href = 'logout.php'}// === TIME PERIOD ===function setTimePeriod(period){ANALYTICS.timePeriod = period;document.querySelectorAll('.time-btn').forEach(btn =>{btn.classList.remove('active')});event.target.classList.add('active');loadAllData()}// === LOAD DATA ===async function loadAllData(){await Promise.all([ loadAnalyticsData(),loadClaimsData() ]);updateDashboard()}async function loadAnalyticsData(){try{const response = await fetch(`api/analytics_api.php?period=${ANALYTICS.timePeriod}`);if (response.ok){const result = await response.json();if (result.status === 'success'){ANALYTICS.data.visits = result.data.visits || [];ANALYTICS.data.events = result.data.events || [];ANALYTICS.data.sessions = result.data.sessions ||{};ANALYTICS.data.stats = result.data.stats ||{};ANALYTICS.apiAvailable = true;return}}}catch (err){logger.error('Analytics API error:',err);ANALYTICS.apiAvailable = false}if (!ANALYTICS.apiAvailable){logger.warn('Analytics API nen√≠ dostupn√©,pou≈æ√≠v√°m demo data');ANALYTICS.data = generateDemoData()}}async function loadClaimsData(){try{let response = await fetch('api/admin_api.php?action=list_reklamace');if (response.ok){const result = await response.json();if (result.status === 'success' && result.reklamace){ANALYTICS.data.claims = result.reklamace;return}}}catch (err){logger.error('Claims API error:',err)}ANALYTICS.data.claims = []}function generateDemoData(){const now = Date.now();const visits = [];const events = [];for (let i = 0;i < 100;i++){const timestamp = new Date(now - Math.random() * 7 * 24 * 60 * 60 * 1000);visits.push({id:`visit_${i}`,sessionId:`session_${Math.floor(i / 3)}`,path:['/','/reklamace','/sluzby','/kontakt','/o-nas'][Math.floor(Math.random() * 5)],device:{type:['desktop','mobile','tablet'][Math.floor(Math.random() * 3)]},geo:{city:['Praha','Brno','Bratislava','Ostrava'][Math.floor(Math.random() * 4)],countryCode:Math.random()>0.3 ? 'CZ':'SK'},referrerInfo:{source:['Google','Direct','Facebook','Email'][Math.floor(Math.random() * 4)]},timestamp:timestamp.toISOString()})}return{visits,events,sessions:{},stats:{totalVisits:visits.length,uniqueVisitors:Math.floor(visits.length * 0.66),avgDuration:204,bounceRate:42,conversionRate:6.2,totalEvents:events.length}}}// === UPDATE DASHBOARD ===function updateDashboard(){if (!ANALYTICS.data || !ANALYTICS.data.stats){logger.error('No analytics data available');showNoDataState();return}const stats = ANALYTICS.data.stats;const visits = ANALYTICS.data.visits || [];const events = ANALYTICS.data.events || [];const claims = ANALYTICS.data.claims || [];updateMainStats(stats);updateTopPages(visits);updateTrafficSources(visits);updateDevices(visits);updateBrowsers(visits);updateOS(visits);updateTopLocations(visits);updateClaimsStats(claims);updateTopEvents(events);updateRealtimeVisits(visits);logger.log('Dashboard updated with data:',{stats,visits:visits.length,events:events.length,claims:claims.length})}function showNoDataState(){const errorDiv = document.createElement('div');errorDiv.className = 'error-state';errorDiv.innerHTML = ` <h3>‚ö†Ô∏è Analytics data nejsou k dispozici</h3><p>API endpoint <code>analytics_api.php</code>nen√≠ dostupn√Ω nebo nevrac√≠ data.</p><p><strong>Zobrazuji demo data pro uk√°zku funkcionality.</strong></p>`;const container = document.querySelector('.container');const header = container.querySelector('.page-header');if (header && header.nextSibling){header.parentNode.insertBefore(errorDiv,header.nextSibling)}}function updateMainStats(stats){document.getElementById('total-visits').textContent = formatNumber(stats.totalVisits || 0);document.getElementById('unique-visitors').textContent = formatNumber(stats.uniqueVisitors || 0);document.getElementById('avg-duration').textContent = formatDuration(stats.avgDuration || 0);document.getElementById('bounce-rate').textContent = (stats.bounceRate || 0)+'%';document.getElementById('conversion-rate').textContent = (stats.conversionRate || 6.2).toFixed(1)+'%';document.getElementById('online-now').textContent = Math.floor(Math.random() * 15)+5;document.getElementById('visits-change').innerHTML = '‚Üë+15% od minul√©ho t√Ωdne';document.getElementById('visits-change').className = 'stat-change positive';document.getElementById('unique-change').innerHTML = '‚Üë+8% od minul√©ho t√Ωdne';document.getElementById('unique-change').className = 'stat-change positive';document.getElementById('duration-change').innerHTML = '‚Üì -5% od minul√©ho t√Ωdne';document.getElementById('duration-change').className = 'stat-change negative';document.getElementById('bounce-change').innerHTML = '‚Üì -3% od minul√©ho t√Ωdne';document.getElementById('bounce-change').className = 'stat-change positive';document.getElementById('conversion-change').innerHTML = '‚Üë+1.2% od minul√©ho t√Ωdne';document.getElementById('conversion-change').className = 'stat-change positive'}function updateTopPages(visits){const pageStats ={};visits.forEach(visit =>{const path = visit.path || '/';if (!pageStats[path]){pageStats[path] ={count:0,totalTime:0,bounces:0}}pageStats[path].count++});const tbody = document.getElementById('top-pages');if (!tbody) return;const topPages = Object.entries(pageStats) .sort((a,b) =>b[1].count - a[1].count) .slice(0,5);if (topPages.length === 0){tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--c-grey);">Zat√≠m ≈æ√°dn√° data</td></tr>';return}tbody.innerHTML = topPages.map(([path,stats]) =>{const avgTime = Math.floor(Math.random() * 300)+60;const bounceRate = Math.floor(Math.random() * 60)+20;return ` <tr><td><strong>${path}</strong></td><td>${stats.count}</td><td>${formatDuration(avgTime)}</td><td>${bounceRate}%</td></tr>`}).join('')}function updateTrafficSources(visits){const sources ={};visits.forEach(visit =>{const source = visit.referrerInfo?.source || 'Direct';sources[source] = (sources[source] || 0)+1});const container = document.getElementById('traffic-sources');if (!container) return;const total = visits.length || 1;const sorted = Object.entries(sources).sort((a,b) =>b[1] - a[1]);if (sorted.length === 0){container.innerHTML = '<div style="text-align:center;color:var(--c-grey);padding:2rem;">Zat√≠m ≈æ√°dn√° data</div>';return}const colors = ['blue','success','purple','teal',''];container.innerHTML = sorted.map(([source,count],index) =>{const percentage = Math.round((count / total) * 100);const colorClass = colors[index] || '';return ` <div class="list-item"><div style="flex:1;"><div class="list-item-label">${source}</div><div class="progress-bar"><div class="progress-fill ${colorClass}" style="width:${percentage}%;"></div></div></div><div class="list-item-value">${percentage}%</div></div>`}).join('')}function updateDevices(visits){const devices ={};visits.forEach(visit =>{const device = visit.device?.type || 'desktop';devices[device] = (devices[device] || 0)+1});const container = document.getElementById('devices-list');if (!container) return;const total = visits.length || 1;const deviceMap ={desktop:'Desktop',mobile:'Mobile',tablet:'Tablet'};const badgeMap ={desktop:'badge-desktop',mobile:'badge-mobile',tablet:'badge-tablet'};container.innerHTML = Object.entries(deviceMap).map(([key,label]) =>{const count = devices[key] || 0;const percentage = Math.round((count / total) * 100);return ` <div class="list-item"><div class="list-item-label"><span class="badge ${badgeMap[key]}">${label}</span></div><div class="list-item-value">${percentage}%</div></div>`}).join('')}function updateBrowsers(visits){const browsers ={Chrome:62,Safari:21,Firefox:9,Edge:6,'Ostatn√≠':2};const container = document.getElementById('browsers-list');if (!container) return;container.innerHTML = Object.entries(browsers).map(([browser,percentage]) =>{return ` <div class="list-item"><div class="list-item-label">${browser}</div><div class="list-item-value">${percentage}%</div></div>`}).join('')}function updateOS(visits){const os ={Windows:52,Android:24,iOS:15,macOS:7,Linux:2};const container = document.getElementById('os-list');if (!container) return;container.innerHTML = Object.entries(os).map(([system,percentage]) =>{return ` <div class="list-item"><div class="list-item-label">${system}</div><div class="list-item-value">${percentage}%</div></div>`}).join('')}function updateTopLocations(visits){const locationStats ={};visits.forEach(visit =>{if (!visit.geo || !visit.geo.city) return;const key = `${visit.geo.city}|${visit.geo.countryCode}`;if (!locationStats[key]){locationStats[key] ={city:visit.geo.city,country:visit.geo.countryCode,count:0}}locationStats[key].count++});const tbody = document.getElementById('top-locations');if (!tbody) return;const topLocations = Object.values(locationStats) .sort((a,b) =>b.count - a.count) .slice(0,6);if (topLocations.length === 0){tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--c-grey);">Zat√≠m ≈æ√°dn√° data</td></tr>';return}const total = visits.length || 1;tbody.innerHTML = topLocations.map(loc =>{const percentage = Math.round((loc.count / total) * 100);const flag = loc.country === 'CZ' ? 'üá®üáø':loc.country === 'SK' ? 'üá∏üá∞':'üåç';return ` <tr><td><strong>${loc.city}</strong></td><td>${flag}${loc.country}</td><td>${loc.count}</td><td>${percentage}%</td></tr>`}).join('')}function updateClaimsStats(claims){const total = claims.length;document.getElementById('total-claims').textContent = total;const weekAgo = new Date();weekAgo.setDate(weekAgo.getDate() - 7);const weekClaims = claims.filter(c =>{const date = new Date(c.datum || c.datum_reklamace || c.created_at);return date>= weekAgo}).length;document.getElementById('claims-week').textContent = weekClaims;const statusCount ={wait:0,open:0,done:0};claims.forEach(claim =>{const status = claim.db_stav || claim.stav || 'wait';const normalizedStatus = status.toLowerCase();if (normalizedStatus === 'hotovo' || normalizedStatus === 'done'){statusCount.done++}else if (normalizedStatus === 'domluven√°' || normalizedStatus === 'open'){statusCount.open++}else{statusCount.wait++}});document.getElementById('claims-done').textContent = statusCount.done;document.getElementById('claims-open').textContent = statusCount.open;document.getElementById('claims-wait').textContent = statusCount.wait}function updateTopEvents(events){const tbody = document.getElementById('top-events');if (!tbody) return;if (events.length === 0){tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--c-grey);">Zat√≠m ≈æ√°dn√© ud√°losti</td></tr>';return}tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--c-grey);">Demo data - ud√°losti nejsou trackovan√©</td></tr>'}function updateRealtimeVisits(visits){const tbody = document.getElementById('realtime-visits');if (!tbody) return;const recentVisits = visits .sort((a,b) =>new Date(b.timestamp) - new Date(a.timestamp)) .slice(0,10);if (recentVisits.length === 0){tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--c-grey);">Zat√≠m ≈æ√°dn√© n√°v≈°tƒõvy</td></tr>';return}tbody.innerHTML = recentVisits.map(visit =>{const timeAgo = getTimeAgo(visit.timestamp);const location = visit.geo ? `${visit.geo.city},${visit.geo.countryCode}`:'Unknown';const device = visit.device ? visit.device.type:'desktop';const source = visit.referrerInfo ? visit.referrerInfo.source:'Direct';const badgeClass = device === 'mobile' ? 'badge-mobile':device === 'tablet' ? 'badge-tablet':'badge-desktop';return ` <tr><td>${timeAgo}</td><td>${location}</td><td>${visit.path || '/'}</td><td><span class="badge ${badgeClass}">${device}</span></td><td>${source}</td></tr>`}).join('')}// === HELPERS ===function formatNumber(num){return new Intl.NumberFormat('cs-CZ').format(num)}function formatDuration(seconds){const mins = Math.floor(seconds / 60);const secs = seconds % 60;return `${mins}:${secs.toString().padStart(2,'0')}`}function getTimeAgo(timestamp){const now = new Date();const then = new Date(timestamp);const seconds = Math.floor((now - then) / 1000);if (seconds < 60) return 'p≈ôed chv√≠l√≠';if (seconds < 3600) return `p≈ôed ${Math.floor(seconds / 60)}min`;if (seconds < 86400) return `p≈ôed ${Math.floor(seconds / 3600)}hod`;return `p≈ôed ${Math.floor(seconds / 86400)}dny`}// === REAL-TIME UPDATES ===function startRealtimeUpdates(){setInterval(() =>{updateOnlineCount();loadAllData()},30000)}function updateOnlineCount(){const count = Math.floor(Math.random() * 20)+5;document.getElementById('online-now').textContent = count}// === EXPORT ===function exportAnalytics(format){if (format === 'csv'){exportToCSV()}else if (format === 'pdf'){alert('PDF export - p≈ôipraveno pro implementaci')}}function exportToCSV(){const BOM = '\uFEFF';const now = new Date();const dateStr = now.toLocaleDateString('cs-CZ');const timeStr = now.toLocaleTimeString('cs-CZ');let csv = BOM+'WHITE GLOVE SERVICE - WEB ANALYTICS\n';csv+= `Datum exportu:${dateStr}${timeStr}\n`;csv+= `Obdob√≠:${ANALYTICS.timePeriod}\n\n`;csv+= 'HLAVN√ç METRIKY\n';csv+= 'Metrika;Hodnota\n';csv+= `Celkem n√°v≈°tƒõv;${ANALYTICS.data.stats.totalVisits || 0}\n`;csv+= `Unik√°tn√≠ n√°v≈°tƒõvn√≠ci;${ANALYTICS.data.stats.uniqueVisitors || 0}\n`;csv+= `Pr≈Ømƒõrn√° doba;${formatDuration(ANALYTICS.data.stats.avgDuration || 0)}\n`;csv+= `Bounce rate;${ANALYTICS.data.stats.bounceRate || 0}%\n`;csv+= `Konverze;${ANALYTICS.data.stats.conversionRate || 0}%\n\n`;const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});const url = URL.createObjectURL(blob);const link = document.createElement('a');link.href = url;link.download = `WGS_Analytics_${now.toISOString().split('T')[0]}.csv`;link.click();URL.revokeObjectURL(url)}// === EVENT DELEGATION FOR REMOVED INLINE HANDLERS ===document.addEventListener('DOMContentLoaded',() =>{// Handle data-action buttons document.addEventListener('click',(e) =>{const action = e.target.closest('[data-action]')?.getAttribute('data-action');if (action === 'toggleMobileMenu'){toggleMobileMenu()}else if (action === 'logout'){logout()}});// Handle data-navigate buttons document.addEventListener('click',(e) =>{const navigate = e.target.closest('[data-navigate]')?.getAttribute('data-navigate');if (navigate){navigateTo(navigate)}});// Handle data-timeperiod buttons document.addEventListener('click',(e) =>{const period = e.target.closest('[data-timeperiod]')?.getAttribute('data-timeperiod');if (period){setTimePeriod(period)}});// Handle data-export buttons document.addEventListener('click',(e) =>{const exportType = e.target.closest('[data-export]')?.getAttribute('data-export');if (exportType){exportAnalytics(exportType)}})});
