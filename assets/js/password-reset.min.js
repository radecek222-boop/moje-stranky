let currentUserData=null;async function getCsrfTokenFromForm(e){if(!e)return null;const t=e.querySelector('input[name="csrf_token"]');if(t&&t.value)return t.value;try{const e=await fetch("app/controllers/get_csrf_token.php",{credentials:"same-origin"}),o=await e.json();if(("success"===o.status||!0===o.success)&&o.token)return t&&(t.value=o.token),o.token}catch(e){logger.error("CSRF fetch failed:",e)}return null}const verifyForm=document.getElementById("verifyForm");verifyForm&&verifyForm.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("resetEmail").value.trim(),o=document.getElementById("resetKey").value.trim();if(t&&o)try{const e=await getCsrfTokenFromForm(verifyForm);if(!e)return void showNotification("Nepodařilo se získat bezpečnostní token. Obnovte stránku a zkuste to znovu.","error");const n=await fetch("app/controllers/password_reset_controller.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:`action=verify&email=${encodeURIComponent(t)}&registration_key=${encodeURIComponent(o)}&csrf_token=${encodeURIComponent(e)}`}),r=await n.json();"success"===r.status?(showNotification(r.message,"success"),currentUserData={email:t,registrationKey:o,user:r.user},document.getElementById("userNameDisplay").textContent=r.user.name,document.getElementById("step1-verify").classList.add("hidden"),document.getElementById("step2-change").classList.remove("hidden")):showNotification(r.message||"Ověření selhalo","error")}catch(e){logger.error("Verify error:",e),showNotification("Chyba při ověřování","error")}else showNotification("Vyplňte email a klíč","error")});const changePasswordForm=document.getElementById("changePasswordForm");function goBack(){document.getElementById("step1-verify").classList.remove("hidden"),document.getElementById("step2-change").classList.add("hidden"),document.getElementById("verifyForm").reset(),document.getElementById("changePasswordForm").reset(),currentUserData=null}function showNotification(e,t="info"){const o=document.getElementById("notification");o&&(o.textContent=e,o.className=`notification ${t}`,o.classList.remove("hidden"),"error"!==t&&setTimeout(()=>{o.classList.add("hidden")},3e3))}changePasswordForm&&changePasswordForm.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("newPassword").value.trim(),o=document.getElementById("newPasswordConfirm").value.trim();if(t&&o)if(t.length<8)showNotification("Heslo musí mít alespoň 8 znaků","error");else if(t===o)try{const e=await getCsrfTokenFromForm(changePasswordForm);if(!e)return void showNotification("Nepodařilo se získat bezpečnostní token. Obnovte stránku a zkuste to znovu.","error");const n=await fetch("app/controllers/password_reset_controller.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:`action=change_password&email=${encodeURIComponent(currentUserData.email)}&registration_key=${encodeURIComponent(currentUserData.registrationKey)}&new_password=${encodeURIComponent(t)}&new_password_confirm=${encodeURIComponent(o)}&csrf_token=${encodeURIComponent(e)}`}),r=await n.json();"success"===r.status?(showNotification("Heslo úspěšně změněno! Přesměrovávám na přihlášení...","success"),setTimeout(()=>{window.location.href="login.php"},2e3)):showNotification(r.message||"Změna hesla selhala","error")}catch(e){logger.error("Change password error:",e),showNotification("Chyba při změně hesla","error")}else showNotification("Hesla se neshodují","error");else showNotification("Vyplňte obě hesla","error")}),logger.log("Password reset system loaded");
//# sourceMappingURL=password-reset.min.js.map