let currentUserData=null;async function getCsrfTokenFromForm(e){if(!e)return null;const o=e.querySelector('input[name="csrf_token"]');if(o&&o.value)return o.value;try{const e=await fetch("app/controllers/get_csrf_token.php",{credentials:"same-origin"}),t=await e.json();if(("success"===t.status||!0===t.success)&&t.token)return o&&(o.value=t.token),t.token}catch(e){logger.error("CSRF fetch failed:",e)}return null}const verifyForm=document.getElementById("verifyForm");verifyForm&&verifyForm.addEventListener("submit",async e=>{e.preventDefault();const o=document.getElementById("resetEmail").value.trim(),t=document.getElementById("resetKey").value.trim();if(o&&t)try{const e=await getCsrfTokenFromForm(verifyForm);if(!e)return void showNotification("Nepodařilo se získat bezpečnostní token. Obnovte stránku a zkuste to znovu.","error");const n=await fetch("app/controllers/password_reset_controller.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:`action=verify&email=${encodeURIComponent(o)}&registration_key=${encodeURIComponent(t)}&csrf_token=${encodeURIComponent(e)}`}),r=await n.json();"success"===r.status?(showNotification(r.message,"success"),currentUserData={email:o,registrationKey:t,user:r.user},document.getElementById("userNameDisplay").textContent=r.user.name,document.getElementById("step1-verify").style.display="none",document.getElementById("step2-change").style.display="block"):showNotification(r.message||"Ověření selhalo","error")}catch(e){logger.error("Verify error:",e),showNotification("Chyba při ověřování","error")}else showNotification("Vyplňte email a klíč","error")});const changePasswordForm=document.getElementById("changePasswordForm");function goBack(){document.getElementById("step1-verify").style.display="block",document.getElementById("step2-change").style.display="none",document.getElementById("verifyForm").reset(),document.getElementById("changePasswordForm").reset(),currentUserData=null}function showNotification(e,o="info"){const t=document.getElementById("notification");t&&(t.textContent=e,t.className=`notification ${o}`,t.style.display="block","error"!==o&&setTimeout(()=>{t.style.display="none"},3e3))}changePasswordForm&&changePasswordForm.addEventListener("submit",async e=>{e.preventDefault();const o=document.getElementById("newPassword").value.trim(),t=document.getElementById("newPasswordConfirm").value.trim();if(o&&t)if(o.length<8)showNotification("Heslo musí mít alespoň 8 znaků","error");else if(o===t)try{const e=await getCsrfTokenFromForm(changePasswordForm);if(!e)return void showNotification("Nepodařilo se získat bezpečnostní token. Obnovte stránku a zkuste to znovu.","error");const n=await fetch("app/controllers/password_reset_controller.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:`action=change_password&email=${encodeURIComponent(currentUserData.email)}&registration_key=${encodeURIComponent(currentUserData.registrationKey)}&new_password=${encodeURIComponent(o)}&new_password_confirm=${encodeURIComponent(t)}&csrf_token=${encodeURIComponent(e)}`}),r=await n.json();"success"===r.status?(showNotification("Heslo úspěšně změněno! Přesměrovávám na přihlášení...","success"),setTimeout(()=>{window.location.href="login.php"},2e3)):showNotification(r.message||"Změna hesla selhala","error")}catch(e){logger.error("Change password error:",e),showNotification("Chyba při změně hesla","error")}else showNotification("Hesla se neshodují","error");else showNotification("Vyplňte obě hesla","error")}),logger.log("Password reset system loaded");