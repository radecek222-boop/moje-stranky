let isAdminCheckbox=document.getElementById("isAdmin"),userLoginFields=document.getElementById("userLoginFields"),adminLoginFields=document.getElementById("adminLoginFields"),loginForm=document.getElementById("loginForm");function detekujAutofill(){[document.getElementById("userEmail"),document.getElementById("userPassword"),document.getElementById("adminKey")].forEach(function(e){var o;e&&((e=>{if(e)try{return e.matches(":-webkit-autofill")||e.matches(":autofill")||"rgb(255, 255, 255)"!==getComputedStyle(e).backgroundColor}catch(e){}})(e)||(o=e)&&o.value&&0<o.value.length)&&(e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),logger.log("[Autofill] Detekov치n autofill pro:",e.id))})}async function getCsrfTokenFromForm(e,t=3){if(e){var n=e.querySelector('input[name="csrf_token"]');for(let o=1;o<=t;o++)try{logger.log(`[CSRF] Ziskavam CERSTVY token (pokus ${o}/${t})...`);var r=await fetch("app/controllers/get_csrf_token.php",{method:"GET",credentials:"same-origin",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache"}});if(!r.ok){if(logger.warn("[CSRF] API vratilo "+r.status),o<t){await new Promise(e=>setTimeout(e,1e3*o));continue}throw new Error("HTTP "+r.status)}var i=await r.json();if(("success"===i.status||!0===i.success)&&i.token)return logger.log("[CSRF] Cerstvy token uspesne ziskan"),n&&(n.value=i.token),i.token;logger.warn("[CSRF] API nevratilo platny token:",i)}catch(e){logger.error(`[CSRF] Fetch pokus ${o} selhal:`,e),o<t&&await new Promise(e=>setTimeout(e,1e3*o))}if(n&&n.value)return logger.warn("[CSRF] Pouzivam token z formulare jako fallback (API selhalo)"),n.value;logger.error("[CSRF] Nepodarilo se ziskat token po "+t+" pokusech")}return null}async function handleAdminLogin(){var e=document.getElementById("adminKey").value.trim();if(e){var o=await getCsrfTokenFromForm(loginForm);if(o){var t=parseInt(localStorage.getItem("admin_login_attempts")||0);t++,localStorage.setItem("admin_login_attempts",t),logger.log("[ADMIN] Login attempt "+t);try{var n,r=await(await fetch("app/controllers/login_controller.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:`admin_key=${encodeURIComponent(e)}&csrf_token=`+encodeURIComponent(o)})).json();logger.log("Response:",r),"success"===r.status?(localStorage.removeItem("admin_login_attempts"),showNotification("Admin p콏ihl치코en칤 칰sp캩코n칠!","success"),setTimeout(()=>{window.location.href="admin.php"},1500)):(n=r.message||"P콏ihl치코en칤 selhalo",showNotification(n+=` (pokus ${t}/3)`,"error"),3<=t&&(logger.log("[Login] Recovery mode activated!"),setTimeout(()=>{showNotification("Recovery m칩d aktivov치n!","warning"),showRecoveryModal(),localStorage.removeItem("admin_login_attempts")},1e3)))}catch(e){logger.error("Admin login error:",e),showNotification("Chyba p콏i p콏ihla코ov치n칤","error")}}else showNotification("Probl칠m se zabezpe캜en칤m. Zkontrolujte: Cookies jsou povoleny, Pou쮂셨치te HTTPS, Nejste v re쬴mu inkognito","error")}else showNotification("Vypl켿te admin kl칤캜","error")}async function handleUserLogin(){var e=document.getElementById("userEmail"),t=document.getElementById("userPassword");let n=e?e.value.trim():"",r=t?t.value.trim():"";n&&r||(await new Promise(e=>setTimeout(e,100)),n=e?e.value.trim():"",r=t?t.value.trim():"");e=document.getElementById("rememberMe")?.checked||!1;if(n&&r){t=await getCsrfTokenFromForm(loginForm);if(t)try{let o=await(await fetch("app/controllers/login_controller.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:`email=${encodeURIComponent(n)}&password=${encodeURIComponent(r)}&remember_me=${e?"1":"0"}&csrf_token=`+encodeURIComponent(t)})).json();"success"===o.status?"function"==typeof window.showWelcomeModal?showWelcomeModal(o.user.name,o.user.role):(logger.warn("showWelcomeModal nen칤 dostupn치, p콏esm캩ruji p콏칤mo"),showNotification("P콏ihl치코en칤 칰sp캩코n칠!","success"),setTimeout(()=>{var e=(o.user.role||"").toLowerCase().trim();window.location.href="technik"===e||"technician"===e?"seznam.php":"novareklamace.php"},1e3)):showNotification(o.message||"P콏ihl치코en칤 selhalo","error")}catch(e){logger.error("User login error:",e),showNotification("Chyba p콏i p콏ihla코ov치n칤","error")}else showNotification("Probl칠m se zabezpe캜en칤m. Zkontrolujte: Cookies jsou povoleny, Pou쮂셨치te HTTPS, Nejste v re쬴mu inkognito","error")}else showNotification("Vypl켿te email a heslo","error")}function showRecoveryModal(){document.body.insertAdjacentHTML("beforeend",`
    <style>
    .recovery-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .recovery-modal { background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%); padding: 2.5rem; border-radius: 12px; max-width: 450px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid #e0e0e0; }
    .recovery-modal h2 { margin: 0 0 0.5rem 0; color: #1a1a1a; font-size: 1.8rem; font-weight: 600; }
    .recovery-modal p { color: #666; margin: 0.5rem 0 1.5rem 0; font-size: 0.95rem; }
    .recovery-modal input { width: 100%; padding: 0.875rem 1rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; margin-bottom: 1.5rem; transition: all 0.3s; box-sizing: border-box; }
    .recovery-modal input:focus { outline: none; border-color: #333; box-shadow: 0 0 0 3px rgba(0,0,0,0.1); }
    .recovery-buttons { display: flex; gap: 1rem; }
    .recovery-btn { flex: 1; padding: 0.875rem 1.5rem; border: none; border-radius: 6px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s; }
    .recovery-btn-primary { background: linear-gradient(135deg, #333 0%, #555 100%); color: white; }
    .recovery-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .recovery-btn-secondary { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
    .recovery-btn-secondary:hover { background: #e8e8e8; }
  </style>
    <div class="recovery-overlay">
      <div class="recovery-modal">
        <h2>游댏 Recovery M칩d</h2>
        <p>Zadej high key pro obnoven칤 admin kl칤캜e</p>
        
        <input type="password" id="recoveryHighKey" placeholder="High Key" autocomplete="off">
        
        <div class="recovery-buttons">
          <button class="recovery-btn recovery-btn-primary" data-action="verifyHighKey">Ov캩콏it</button>
          <button class="recovery-btn recovery-btn-secondary" data-action="closeRecoveryModal">Zru코it</button>
        </div>
      </div>
    </div>
  `),document.getElementById("recoveryHighKey").focus()}function closeRecoveryModal(){var e=document.querySelector(".recovery-overlay");e&&e.remove()}async function verifyHighKey(){var e=document.getElementById("recoveryHighKey").value.trim();if(e)try{var o=await getCsrfTokenFromForm(loginForm);o?"success"===(await(await fetch("app/controllers/login_controller.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:`high_key=${encodeURIComponent(e)}&csrf_token=`+encodeURIComponent(o)})).json()).status?(showNotification("High key ov캩콏en!","success"),closeRecoveryModal(),setTimeout(()=>showCreateNewAdminKeyModal(),500)):showNotification("Neplatn칳 high key","error"):showNotification("Nepoda콏ilo se z칤skat bezpe캜nostn칤 token. Obnovte str치nku.","error")}catch(e){logger.error("High key error:",e)}else showNotification("Vypl켿te high key","error")}function showCreateNewAdminKeyModal(){document.body.insertAdjacentHTML("beforeend",`
    <style>
    .newkey-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .newkey-modal { background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%); padding: 2.5rem; border-radius: 12px; max-width: 450px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid #e0e0e0; }
    .newkey-modal h2 { margin: 0 0 1.5rem 0; color: #1a1a1a; font-size: 1.8rem; font-weight: 600; }
    .newkey-modal input { width: 100%; padding: 0.875rem 1rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; margin-bottom: 1rem; transition: all 0.3s; box-sizing: border-box; }
    .newkey-modal input:focus { outline: none; border-color: #28a745; box-shadow: 0 0 0 3px rgba(40,167,69,0.1); }
    .newkey-buttons { display: flex; gap: 1rem; }
    .newkey-btn { flex: 1; padding: 0.875rem 1.5rem; border: none; border-radius: 6px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s; }
    .newkey-btn-success { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white; }
    .newkey-btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(40,167,69,0.3); }
    .newkey-btn-cancel { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
    .newkey-btn-cancel:hover { background: #e8e8e8; }
    .newkey-hint { font-size: 0.85rem; color: #999; margin-top: 0.5rem; }
  </style>
    <div class="newkey-overlay">
      <div class="newkey-modal">
        <h2>Novy Admin Klic</h2>
        
        <input type="password" id="newAdminKey" placeholder="Nov칳 kl칤캜 (min. 12 znak콢)" minlength="12" autocomplete="off">
        <div class="newkey-hint">Minim치ln캩 12 znak콢</div>
        
        <input type="password" id="newAdminKeyConfirm" placeholder="Potvrzen칤 kl칤캜e" minlength="12" autocomplete="off" style="margin-top: 0.5rem;">
        
        <div class="newkey-buttons">
          <button class="newkey-btn newkey-btn-success" data-action="createNewAdminKey">Vytvo콏it Kl칤캜</button>
          <button class="newkey-btn newkey-btn-cancel" data-action="closeNewAdminKeyModal">Zru코it</button>
        </div>
      </div>
    </div>
  `),document.getElementById("newAdminKey").focus()}function closeNewAdminKeyModal(){var e=document.querySelector(".newkey-overlay");e&&e.remove()}async function createNewAdminKey(){var e=document.getElementById("newAdminKey").value.trim(),o=document.getElementById("newAdminKeyConfirm").value.trim();if(e&&o)if(e!==o)showNotification("Kl칤캜e se neshoduj칤","error");else if(e.length<12)showNotification("Kl칤캜 mus칤 m칤t alespo켿 12 znak콢","error");else try{var t,n=await getCsrfTokenFromForm(loginForm);n?"success"===(t=await(await fetch("app/controllers/login_controller.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:`action=create_new_admin_key&new_admin_key=${encodeURIComponent(e)}&new_admin_key_confirm=${encodeURIComponent(o)}&csrf_token=`+encodeURIComponent(n)})).json()).status?(showNotification("Kl칤캜 vytvo콏en! Restartuju...","success"),closeNewAdminKeyModal(),setTimeout(()=>location.reload(),2e3)):showNotification(""+(t.message||"Chyba"),"error"):showNotification("Nepoda콏ilo se z칤skat bezpe캜nostn칤 token. Obnovte str치nku.","error")}catch(e){logger.error("Create key error:",e)}else showNotification("Vypl켿te oba kl칤캜e","error")}function showNotification(e,o="info"){let t=document.getElementById("notification");t&&(t.textContent=e,t.className=`notification ${o} active`,"error"!==o)&&setTimeout(()=>{t.classList.remove("active")},3e3)}document.addEventListener("DOMContentLoaded",()=>{var e;setTimeout(detekujAutofill,100),setTimeout(detekujAutofill,500),setTimeout(detekujAutofill,1e3),!window.matchMedia("(display-mode: standalone)").matches&&!0!==window.navigator.standalone||!(e=document.getElementById("rememberMe"))||e.checked||(e.checked=!0,logger.log("[PWA] Remember Me automaticky zapnut"))}),document.addEventListener("animationstart",e=>{"onAutoFillStart"!==e.animationName&&!e.animationName.includes("autofill")||detekujAutofill()},!0),["userEmail","userPassword","adminKey"].forEach(e=>{let o=document.getElementById(e);o&&o.addEventListener("focus",()=>{setTimeout(()=>{o.value&&0<o.value.length&&o.dispatchEvent(new Event("input",{bubbles:!0}))},50)})}),isAdminCheckbox&&isAdminCheckbox.addEventListener("change",e=>{var o=document.getElementById("userEmail"),t=document.getElementById("userPassword"),n=document.getElementById("adminKey");e.target.checked?(userLoginFields&&(userLoginFields.classList.add("hidden"),userLoginFields.style.display="none"),adminLoginFields&&(adminLoginFields.classList.remove("hidden"),adminLoginFields.style.display="block"),o&&o.removeAttribute("required"),t&&t.removeAttribute("required"),n&&(n.setAttribute("required","required"),n.focus())):(userLoginFields&&(userLoginFields.classList.remove("hidden"),userLoginFields.style.display="block"),adminLoginFields&&(adminLoginFields.classList.add("hidden"),adminLoginFields.style.display="none"),o&&o.setAttribute("required","required"),t&&t.setAttribute("required","required"),n&&n.removeAttribute("required"))}),loginForm&&loginForm.addEventListener("submit",async e=>{e.preventDefault(),isAdminCheckbox.checked?await handleAdminLogin():await handleUserLogin()}),logger.log("Login system loaded"),"undefined"!=typeof Utils&&Utils.registerAction&&(Utils.registerAction("verifyHighKey",()=>{"function"==typeof verifyHighKey&&verifyHighKey()}),Utils.registerAction("closeRecoveryModal",()=>{"function"==typeof closeRecoveryModal&&closeRecoveryModal()}),Utils.registerAction("createNewAdminKey",()=>{"function"==typeof createNewAdminKey&&createNewAdminKey()}),Utils.registerAction("closeNewAdminKeyModal",()=>{"function"==typeof closeNewAdminKeyModal&&closeNewAdminKeyModal()}));