const isAdminCheckbox=document.getElementById("isAdmin"),userLoginFields=document.getElementById("userLoginFields"),adminLoginFields=document.getElementById("adminLoginFields"),loginForm=document.getElementById("loginForm");function detekujAutofill(){[document.getElementById("userEmail"),document.getElementById("userPassword"),document.getElementById("adminKey")].forEach(function(e){e&&(function(e){if(!e)return!1;try{return e.matches(":-webkit-autofill")||e.matches(":autofill")||"rgb(255, 255, 255)"!==getComputedStyle(e).backgroundColor}catch(e){return!1}}(e)||function(e){return!!e&&e.value&&e.value.length>0}(e))&&(e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),logger.log("[Autofill] Detekov치n autofill pro:",e.id))})}async function getCsrfTokenFromForm(e,o=3){if(!e)return null;const n=e.querySelector('input[name="csrf_token"]');for(let e=1;e<=o;e++)try{logger.log(`[CSRF] Ziskavam CERSTVY token (pokus ${e}/${o})...`);const t=await fetch("app/controllers/get_csrf_token.php",{method:"GET",credentials:"same-origin",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache"}});if(!t.ok){if(logger.warn(`[CSRF] API vratilo ${t.status}`),e<o){await new Promise(o=>setTimeout(o,1e3*e));continue}throw new Error(`HTTP ${t.status}`)}const r=await t.json();if(("success"===r.status||!0===r.success)&&r.token)return logger.log("[CSRF] Cerstvy token uspesne ziskan"),n&&(n.value=r.token),r.token;logger.warn("[CSRF] API nevratilo platny token:",r)}catch(n){logger.error(`[CSRF] Fetch pokus ${e} selhal:`,n),e<o&&await new Promise(o=>setTimeout(o,1e3*e))}return n&&n.value?(logger.warn("[CSRF] Pouzivam token z formulare jako fallback (API selhalo)"),n.value):(logger.error("[CSRF] Nepodarilo se ziskat token po "+o+" pokusech"),null)}async function handleAdminLogin(){const e=document.getElementById("adminKey").value.trim();if(!e)return void showNotification("Vypl켿te admin kl칤캜","error");const o=await getCsrfTokenFromForm(loginForm);if(!o)return void showNotification("Probl칠m se zabezpe캜en칤m. Zkontrolujte: Cookies jsou povoleny, Pou쮂셨치te HTTPS, Nejste v re쬴mu inkognito","error");let n=parseInt(localStorage.getItem("admin_login_attempts")||0);n++,localStorage.setItem("admin_login_attempts",n),logger.log("[ADMIN] Login attempt "+n);try{const t=await fetch("app/controllers/login_controller.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:`admin_key=${encodeURIComponent(e)}&csrf_token=${encodeURIComponent(o)}`}),r=await t.json();if(logger.log("Response:",r),"success"===r.status)localStorage.removeItem("admin_login_attempts"),showNotification("Admin p콏ihl치코en칤 칰sp캩코n칠!","success"),setTimeout(()=>{window.location.href="admin.php"},1500);else{let e=r.message||"P콏ihl치코en칤 selhalo";e+=` (pokus ${n}/3)`,showNotification(e,"error"),n>=3&&(logger.log("[Login] Recovery mode activated!"),setTimeout(()=>{showNotification("Recovery m칩d aktivov치n!","warning"),showRecoveryModal(),localStorage.removeItem("admin_login_attempts")},1e3))}}catch(e){logger.error("Admin login error:",e),showNotification("Chyba p콏i p콏ihla코ov치n칤","error")}}async function handleUserLogin(){const e=document.getElementById("userEmail"),o=document.getElementById("userPassword");let n=e?e.value.trim():"",t=o?o.value.trim():"";n&&t||(await new Promise(e=>setTimeout(e,100)),n=e?e.value.trim():"",t=o?o.value.trim():"");const r=document.getElementById("rememberMe")?.checked||!1;if(!n||!t)return void showNotification("Vypl켿te email a heslo","error");const i=await getCsrfTokenFromForm(loginForm);if(i)try{const e=await fetch("app/controllers/login_controller.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:`email=${encodeURIComponent(n)}&password=${encodeURIComponent(t)}&remember_me=${r?"1":"0"}&csrf_token=${encodeURIComponent(i)}`}),o=await e.json();"success"===o.status?"function"==typeof window.showWelcomeModal?showWelcomeModal(o.user.name,o.user.role):(logger.warn("showWelcomeModal nen칤 dostupn치, p콏esm캩ruji p콏칤mo"),showNotification("P콏ihl치코en칤 칰sp캩코n칠!","success"),setTimeout(()=>{const e=(o.user.role||"").toLowerCase().trim();window.location.href="technik"===e||"technician"===e?"seznam.php":"novareklamace.php"},1e3)):showNotification(o.message||"P콏ihl치코en칤 selhalo","error")}catch(e){logger.error("User login error:",e),showNotification("Chyba p콏i p콏ihla코ov치n칤","error")}else showNotification("Probl칠m se zabezpe캜en칤m. Zkontrolujte: Cookies jsou povoleny, Pou쮂셨치te HTTPS, Nejste v re쬴mu inkognito","error")}function showRecoveryModal(){document.body.insertAdjacentHTML("beforeend",'\n    <style>\n    .recovery-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }\n    .recovery-modal { background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%); padding: 2.5rem; border-radius: 12px; max-width: 450px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid #e0e0e0; }\n    .recovery-modal h2 { margin: 0 0 0.5rem 0; color: #1a1a1a; font-size: 1.8rem; font-weight: 600; }\n    .recovery-modal p { color: #666; margin: 0.5rem 0 1.5rem 0; font-size: 0.95rem; }\n    .recovery-modal input { width: 100%; padding: 0.875rem 1rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; margin-bottom: 1.5rem; transition: all 0.3s; box-sizing: border-box; }\n    .recovery-modal input:focus { outline: none; border-color: #333; box-shadow: 0 0 0 3px rgba(0,0,0,0.1); }\n    .recovery-buttons { display: flex; gap: 1rem; }\n    .recovery-btn { flex: 1; padding: 0.875rem 1.5rem; border: none; border-radius: 6px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s; }\n    .recovery-btn-primary { background: linear-gradient(135deg, #333 0%, #555 100%); color: white; }\n    .recovery-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }\n    .recovery-btn-secondary { background: #f0f0f0; color: #333; border: 1px solid #ddd; }\n    .recovery-btn-secondary:hover { background: #e8e8e8; }\n  </style>\n    <div class="recovery-overlay">\n      <div class="recovery-modal">\n        <h2>游댏 Recovery M칩d</h2>\n        <p>Zadej high key pro obnoven칤 admin kl칤캜e</p>\n        \n        <input type="password" id="recoveryHighKey" placeholder="High Key" autocomplete="off">\n        \n        <div class="recovery-buttons">\n          <button class="recovery-btn recovery-btn-primary" data-action="verifyHighKey">Ov캩콏it</button>\n          <button class="recovery-btn recovery-btn-secondary" data-action="closeRecoveryModal">Zru코it</button>\n        </div>\n      </div>\n    </div>\n  '),document.getElementById("recoveryHighKey").focus()}function closeRecoveryModal(){const e=document.querySelector(".recovery-overlay");e&&e.remove()}async function verifyHighKey(){const e=document.getElementById("recoveryHighKey").value.trim();if(e)try{const o=await getCsrfTokenFromForm(loginForm);if(!o)return void showNotification("Nepoda콏ilo se z칤skat bezpe캜nostn칤 token. Obnovte str치nku.","error");const n=await fetch("app/controllers/login_controller.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:`high_key=${encodeURIComponent(e)}&csrf_token=${encodeURIComponent(o)}`});"success"===(await n.json()).status?(showNotification("High key ov캩콏en!","success"),closeRecoveryModal(),setTimeout(()=>showCreateNewAdminKeyModal(),500)):showNotification("Neplatn칳 high key","error")}catch(e){logger.error("High key error:",e)}else showNotification("Vypl켿te high key","error")}function showCreateNewAdminKeyModal(){document.body.insertAdjacentHTML("beforeend",'\n    <style>\n    .newkey-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }\n    .newkey-modal { background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%); padding: 2.5rem; border-radius: 12px; max-width: 450px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid #e0e0e0; }\n    .newkey-modal h2 { margin: 0 0 1.5rem 0; color: #1a1a1a; font-size: 1.8rem; font-weight: 600; }\n    .newkey-modal input { width: 100%; padding: 0.875rem 1rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; margin-bottom: 1rem; transition: all 0.3s; box-sizing: border-box; }\n    .newkey-modal input:focus { outline: none; border-color: #28a745; box-shadow: 0 0 0 3px rgba(40,167,69,0.1); }\n    .newkey-buttons { display: flex; gap: 1rem; }\n    .newkey-btn { flex: 1; padding: 0.875rem 1.5rem; border: none; border-radius: 6px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s; }\n    .newkey-btn-success { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white; }\n    .newkey-btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(40,167,69,0.3); }\n    .newkey-btn-cancel { background: #f0f0f0; color: #333; border: 1px solid #ddd; }\n    .newkey-btn-cancel:hover { background: #e8e8e8; }\n    .newkey-hint { font-size: 0.85rem; color: #999; margin-top: 0.5rem; }\n  </style>\n    <div class="newkey-overlay">\n      <div class="newkey-modal">\n        <h2>Novy Admin Klic</h2>\n        \n        <input type="password" id="newAdminKey" placeholder="Nov칳 kl칤캜 (min. 12 znak콢)" minlength="12" autocomplete="off">\n        <div class="newkey-hint">Minim치ln캩 12 znak콢</div>\n        \n        <input type="password" id="newAdminKeyConfirm" placeholder="Potvrzen칤 kl칤캜e" minlength="12" autocomplete="off" style="margin-top: 0.5rem;">\n        \n        <div class="newkey-buttons">\n          <button class="newkey-btn newkey-btn-success" data-action="createNewAdminKey">Vytvo콏it Kl칤캜</button>\n          <button class="newkey-btn newkey-btn-cancel" data-action="closeNewAdminKeyModal">Zru코it</button>\n        </div>\n      </div>\n    </div>\n  '),document.getElementById("newAdminKey").focus()}function closeNewAdminKeyModal(){const e=document.querySelector(".newkey-overlay");e&&e.remove()}async function createNewAdminKey(){const e=document.getElementById("newAdminKey").value.trim(),o=document.getElementById("newAdminKeyConfirm").value.trim();if(e&&o)if(e===o)if(e.length<12)showNotification("Kl칤캜 mus칤 m칤t alespo켿 12 znak콢","error");else try{const n=await getCsrfTokenFromForm(loginForm);if(!n)return void showNotification("Nepoda콏ilo se z칤skat bezpe캜nostn칤 token. Obnovte str치nku.","error");const t=await fetch("app/controllers/login_controller.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",body:`action=create_new_admin_key&new_admin_key=${encodeURIComponent(e)}&new_admin_key_confirm=${encodeURIComponent(o)}&csrf_token=${encodeURIComponent(n)}`}),r=await t.json();"success"===r.status?(showNotification("Kl칤캜 vytvo콏en! Restartuju...","success"),closeNewAdminKeyModal(),setTimeout(()=>location.reload(),2e3)):showNotification(""+(r.message||"Chyba"),"error")}catch(e){logger.error("Create key error:",e)}else showNotification("Kl칤캜e se neshoduj칤","error");else showNotification("Vypl켿te oba kl칤캜e","error")}function showNotification(e,o="info"){const n=document.getElementById("notification");n&&(n.textContent=e,n.className=`notification ${o} active`,"error"!==o&&setTimeout(()=>{n.classList.remove("active")},3e3))}document.addEventListener("DOMContentLoaded",()=>{setTimeout(detekujAutofill,100),setTimeout(detekujAutofill,500),setTimeout(detekujAutofill,1e3)}),document.addEventListener("animationstart",e=>{("onAutoFillStart"===e.animationName||e.animationName.includes("autofill"))&&detekujAutofill()},!0),["userEmail","userPassword","adminKey"].forEach(e=>{const o=document.getElementById(e);o&&o.addEventListener("focus",()=>{setTimeout(()=>{o.value&&o.value.length>0&&o.dispatchEvent(new Event("input",{bubbles:!0}))},50)})}),isAdminCheckbox&&isAdminCheckbox.addEventListener("change",e=>{const o=document.getElementById("userEmail"),n=document.getElementById("userPassword"),t=document.getElementById("adminKey");e.target.checked?(userLoginFields.classList.add("hidden"),adminLoginFields.classList.remove("hidden"),o&&o.removeAttribute("required"),n&&n.removeAttribute("required"),t&&t.setAttribute("required","required")):(userLoginFields.classList.remove("hidden"),adminLoginFields.classList.add("hidden"),o&&o.setAttribute("required","required"),n&&n.setAttribute("required","required"),t&&t.removeAttribute("required"))}),loginForm&&loginForm.addEventListener("submit",async e=>{e.preventDefault();isAdminCheckbox.checked?await handleAdminLogin():await handleUserLogin()}),logger.log("Login system loaded"),"undefined"!=typeof Utils&&Utils.registerAction&&(Utils.registerAction("verifyHighKey",()=>{"function"==typeof verifyHighKey&&verifyHighKey()}),Utils.registerAction("closeRecoveryModal",()=>{"function"==typeof closeRecoveryModal&&closeRecoveryModal()}),Utils.registerAction("createNewAdminKey",()=>{"function"==typeof createNewAdminKey&&createNewAdminKey()}),Utils.registerAction("closeNewAdminKeyModal",()=>{"function"==typeof closeNewAdminKeyModal&&closeNewAdminKeyModal()}));