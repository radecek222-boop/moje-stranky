const safeLogger={log:(...e)=>"undefined"!=typeof logger?logger.log(...e):console.log(...e),error:(...e)=>"undefined"!=typeof logger?logger.error(...e):console.error(...e),warn:(...e)=>"undefined"!=typeof logger?logger.warn(...e):console.warn(...e)},SESSION_EXPIRED_MESSAGE=()=>t("session_expired");function wgsConfirm(e,t={}){return new Promise(n=>{const{titulek:o="Potvrzení",btnPotvrdit:a="Potvrdit",btnZrusit:i="Zrušit",nebezpecne:r=!1}=t,s=document.getElementById("wgsConfirmModal");s&&s.remove();const d=document.createElement("div");d.id="wgsConfirmModal",d.style.cssText="\n      position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n      background: rgba(0,0,0,0.7); display: flex;\n      align-items: center; justify-content: center; z-index: 10001;\n    ";const l=r?"background: #dc3545; color: #fff;":"background: #fff; color: #000;";d.innerHTML=`\n      <div style="background: #1a1a1a; padding: 25px; border-radius: 12px;\n                  max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);\n                  border: 1px solid #333;">\n        <h3 style="margin: 0 0 15px 0; color: #fff; font-size: 1.1rem;">${o}</h3>\n        <p style="margin: 0 0 20px 0; color: #ccc; font-size: 0.95rem; line-height: 1.5;">${e}</p>\n        <div style="display: flex; gap: 10px; justify-content: flex-end;">\n          <button id="wgsConfirmBtnZrusit" style="padding: 10px 20px; border: 1px solid #444;\n                  border-radius: 6px; background: transparent; color: #ccc; cursor: pointer;\n                  font-size: 0.9rem;">${i}</button>\n          <button id="wgsConfirmBtnPotvrdit" style="padding: 10px 20px; border: none;\n                  border-radius: 6px; ${l} cursor: pointer;\n                  font-size: 0.9rem; font-weight: 500;">${a}</button>\n        </div>\n      </div>\n    `,document.body.appendChild(d);const c=e=>{d.remove(),document.removeEventListener("keydown",m),n(e)};document.getElementById("wgsConfirmBtnZrusit")?.addEventListener("click",()=>c(!1)),document.getElementById("wgsConfirmBtnPotvrdit")?.addEventListener("click",()=>c(!0)),d.addEventListener("click",e=>{e.target===d&&c(!1)});const m=e=>{"Escape"===e.key&&c(!1)};document.addEventListener("keydown",m),document.getElementById("wgsConfirmBtnZrusit")?.focus()})}function isUnauthorizedStatus(e){return 401===e||403===e}function redirectToLogin(e=""){const t=e?`?redirect=${encodeURIComponent(e)}`:"";window.location.href=`login.php${t}`}function initAdminPanel(){setupNavigation(),initUserManagement()}function setupNavigation(){document.querySelectorAll("[data-navigate]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=e.getAttribute("data-navigate");n&&(window.location.href=n)})})}async function loadDashboard(){try{const e=document.getElementById("stat-claims"),t=document.getElementById("stat-users"),n=document.getElementById("stat-online"),o=document.getElementById("stat-keys");if(!(e&&t&&n&&o))return;const a=await fetch("api/admin_stats_api.php",{credentials:"same-origin"});if(!a.ok){if(isUnauthorizedStatus(a.status))return["stat-claims","stat-users","stat-online","stat-keys"].forEach(e=>{const t=document.getElementById(e);t&&(t.textContent="—")}),void setTimeout(()=>redirectToLogin("admin.php"),800);throw new Error(`HTTP ${a.status}`)}const i=await a.json();"success"!==i.status&&!0!==i.success||(e&&(e.textContent=i.stats.claims||0),t&&(t.textContent=i.stats.users||0),n&&(n.textContent=i.stats.online||0),o&&(o.textContent=i.stats.keys||0))}catch(e){logger.error("Dashboard load error:",e),logClientError(e,"loadDashboard")}}async function loadUsers(){const e=document.getElementById("users-table");if(e)try{e.innerHTML='<tr><td colspan="7" class="loading">Načítání...</td></tr>';const t=await fetch("/api/admin_users_api.php?action=list",{credentials:"same-origin"});if(!t.ok){if(isUnauthorizedStatus(t.status))return e.innerHTML=`<tr><td colspan="7" class="error-message">${SESSION_EXPIRED_MESSAGE}</td></tr>`,void setTimeout(()=>redirectToLogin("admin.php?tab=users"),800);throw new Error(`HTTP ${t.status}`)}const n=await t.json();if("success"===n.status||!0===n.success){const t=n.data||n.users||[];if(0===t.length)return void(e.innerHTML='<tr><td colspan="7" style="text-align:center;color:#999;">Žádní uživatelé</td></tr>');let o="";t.forEach(e=>{const t="active"===e.status?"badge-active":"badge-inactive",n="active"===e.status?"Aktivní":"Neaktivní",a=new Date(e.created_at).toLocaleDateString("cs-CZ");o+='<tr style="cursor: pointer;" data-action="zobrazDetailUzivatele" data-id="'+e.id+'" title="Klikněte pro zobrazení detailu">',o+="<td>#"+e.id+"</td>",o+="<td>"+escapeHtml(e.name||e.full_name)+"</td>",o+="<td>"+escapeHtml(e.email)+"</td>",o+="<td>"+escapeHtml(e.role.toUpperCase())+"</td>",o+='<td><span class="badge '+t+'">'+n.toUpperCase()+"</span></td>",o+="<td>"+a+"</td>",o+='<td data-action="stopPropagation">',o+='<button class="cc-btn cc-btn-sm cc-btn-danger" data-action="deleteUser" data-id="'+e.id+'">Smazat</button>',o+="</td>",o+="</tr>"}),e.innerHTML=o}else e.innerHTML=`<tr><td colspan="7" class="error-message">${n.message||"Nepodařilo se načíst uživatele."}</td></tr>`}catch(t){e.innerHTML='<tr><td colspan="7" class="error-message">Chyba načítání</td></tr>',logger.error("Users load error:",t),logClientError(t,"loadUsers")}}async function loadZakaznici(){const e=document.getElementById("zakaznici-table");if(e)try{e.innerHTML='<tr><td colspan="6" class="loading">Načítání...</td></tr>';const t=document.getElementById("search-zakaznici"),n=t?t.value.trim():"",o=n?`/api/zakaznici_api.php?action=list_zakaznici&search=${encodeURIComponent(n)}`:"/api/zakaznici_api.php?action=list_zakaznici",a=await fetch(o,{credentials:"same-origin"});if(!a.ok){if(isUnauthorizedStatus(a.status))return e.innerHTML=`<tr><td colspan="6" class="error-message">${SESSION_EXPIRED_MESSAGE()}</td></tr>`,void setTimeout(()=>redirectToLogin("admin.php?tab=zakaznici"),800);throw new Error(`HTTP ${a.status}`)}const i=await a.json();if("success"===i.status){const t=i.zakaznici||[];if(0===t.length)return void(e.innerHTML='<tr><td colspan="6" style="text-align:center;color:#999;">Žádní zákazníci</td></tr>');let n="";t.forEach(e=>{const t=e.jmeno||"—",o=e.adresa||"—",a=e.telefon||"—",i=e.email||"—",r=e.pocet_zakazek||0;n+=`<tr style="cursor: pointer;" data-action="otevritZakazkyZakaznika" data-jmeno="${escapeHtml(t)}" data-email="${escapeHtml(i)}" title="Klikněte pro zobrazení zakázek">`,n+=`<td><strong>${escapeHtml(t)}</strong></td>`,n+=`<td>${escapeHtml(o)}</td>`,n+=`<td>${escapeHtml(a)}</td>`,n+=`<td>${escapeHtml(i)}</td>`,n+=`<td><span class="badge badge-active">${r}</span></td>`,n+=`<td><button class="btn btn-sm" data-action="otevritZakazkyZakaznika" data-jmeno="${escapeHtml(t)}" data-email="${escapeHtml(i)}">Zobrazit zakázky</button></td>`,n+="</tr>"}),e.innerHTML=n}else e.innerHTML=`<tr><td colspan="6" class="error-message">${i.message||"Nepodařilo se načíst zákazníky."}</td></tr>`}catch(t){e.innerHTML='<tr><td colspan="6" class="error-message">Chyba načítání</td></tr>',logger.error("Zakaznici load error:",t),logClientError(t,"loadZakaznici")}}function otevritZakazkyZakaznika(e,t){const n=e&&"—"!==e?e:t;window.location.href=`seznam.php?search=${encodeURIComponent(n)}`}async function addUser(){const e=document.getElementById("addUserModal"),t=document.getElementById("modal-error");t.classList.add("hidden");const n=document.getElementById("add-name").value.trim(),o=document.getElementById("add-email").value.trim(),a=document.getElementById("add-phone").value.trim(),i=document.getElementById("add-address").value.trim(),r=document.getElementById("add-role").value,s=document.getElementById("add-password").value;if(!n||!o||!s)return t.textContent="Jméno, email a heslo jsou povinné",void t.classList.remove("hidden");if(s.length<8)return t.textContent="Heslo musí mít alespoň 8 znaků",void t.classList.remove("hidden");try{const d=await getCSRFToken();if(!d)throw new Error("CSRF token not available");const l=await fetch("/api/admin_users_api.php?action=add",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,email:o,phone:a,address:i,role:r,password:s,csrf_token:d})});if(!l.ok){if(isUnauthorizedStatus(l.status))return t.textContent=SESSION_EXPIRED_MESSAGE,t.classList.remove("hidden"),void setTimeout(()=>redirectToLogin("admin.php?tab=users"),800);const e=await l.text();throw new Error(e||"Nepodařilo se vytvořit uživatele")}const c=await l.json();"success"===c.status||!0===c.success?(e.classList.add("hidden"),document.getElementById("add-name").value="",document.getElementById("add-email").value="",document.getElementById("add-phone").value="",document.getElementById("add-address").value="",document.getElementById("add-password").value="",loadUsers()):(t.textContent=c.message||"Chyba při vytváření uživatele",t.classList.remove("hidden"))}catch(e){t.textContent="Chyba při vytváření uživatele",t.classList.remove("hidden"),logger.error("Add user error:",e),logClientError(e,"addUser")}}async function deleteUser(e){if(await wgsConfirm("Opravdu chcete smazat tohoto uživatele?",{titulek:"Smazat uživatele",btnPotvrdit:"Smazat",nebezpecne:!0}))try{const n=await getCSRFToken();if(!n)throw new Error("CSRF token not available");const o=await fetch("/api/admin_users_api.php?action=delete",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:e,csrf_token:n})});if(!o.ok){if(isUnauthorizedStatus(o.status))return alert(SESSION_EXPIRED_MESSAGE()),void redirectToLogin("admin.php?tab=users");const e=await o.text();throw new Error(e||"Chyba při mazání uživatele")}const a=await o.json();"success"===a.status||!0===a.success?loadUsers():alert(a.message||t("delete_error"))}catch(e){alert(t("delete_user_error")),logger.error("Delete user error:",e),logClientError(e,"deleteUser")}}async function loadOnline(){const e=document.getElementById("online-table");if(e)try{e.innerHTML='<tr><td colspan="5" class="loading">Načítání...</td></tr>';const t=await fetch("/api/admin_users_api.php?action=online",{credentials:"same-origin"});if(!t.ok){if(isUnauthorizedStatus(t.status))return e.innerHTML=`<tr><td colspan="5" class="error-message">${SESSION_EXPIRED_MESSAGE}</td></tr>`,void setTimeout(()=>redirectToLogin("admin.php?tab=online"),800);throw new Error(`HTTP ${t.status}`)}const n=await t.json();if("success"===n.status||!0===n.success){if(0===n.users.length)return void(e.innerHTML='<tr><td colspan="5" style="text-align:center;color:#999;">Nikdo online</td></tr>');let t="";n.users.forEach(e=>{const n=new Date(e.last_activity),o=Math.floor((Date.now()-n.getTime())/6e4),a=0===o?"Nyní":o+" min";t+="<tr>",t+='<td><span class="badge badge-active">Online</span></td>',t+="<td>"+escapeHtml(e.name)+"</td>",t+="<td>"+escapeHtml(e.role)+"</td>",t+="<td>"+escapeHtml(e.email)+"</td>",t+="<td>"+a+"</td>",t+="</tr>"}),e.innerHTML=t}else e.innerHTML=`<tr><td colspan="5" class="error-message">${n.message||"Nepodařilo se načíst online uživatele."}</td></tr>`}catch(t){e.innerHTML='<tr><td colspan="5" class="error-message">Chyba načítání</td></tr>',logger.error("Online load error:",t),logClientError(t,"loadOnlineUsers")}}function initUserManagement(){const e=document.getElementById("addUserBtn"),t=document.getElementById("refreshUsersBtn"),n=document.getElementById("submitUserBtn"),o=document.getElementById("closeModalBtn"),a=document.getElementById("cancelModalBtn"),i=document.getElementById("refreshOnlineBtn"),r=document.getElementById("refreshZakazniciBtn"),s=document.getElementById("search-zakaznici");if(e&&e.addEventListener("click",()=>{document.getElementById("addUserModal").classList.remove("hidden")}),o&&o.addEventListener("click",()=>{document.getElementById("addUserModal").classList.add("hidden")}),a&&a.addEventListener("click",()=>{document.getElementById("addUserModal").classList.add("hidden")}),n&&n.addEventListener("click",addUser),t&&t.addEventListener("click",loadUsers),i&&i.addEventListener("click",loadOnline),r&&r.addEventListener("click",loadZakaznici),s){let e;s.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(()=>{loadZakaznici()},500)})}const d=new URLSearchParams(window.location.search).get("tab"),l=document.getElementById("tab-dashboard"),c=document.getElementById("tab-users"),m=document.getElementById("tab-online"),u=document.getElementById("tab-zakaznici");d&&"dashboard"!==d||!l?"users"===d&&c?loadUsers():"online"===d&&m?loadOnline():"zakaznici"===d&&u&&loadZakaznici():loadDashboard()}function isSuccess(e){return e&&(!0===e.success||"success"===e.status)}function getCSRFToken(){let e=document.querySelector('meta[name="csrf-token"]');if(!e&&window.parent&&window.parent!==window)try{e=window.parent.document.querySelector('meta[name="csrf-token"]')}catch(e){console.error("Cannot access parent CSRF token:",e)}if(!e)return console.error("CSRF token meta tag not found in document or parent"),null;const t=e.getAttribute("content"),n=t?String(t).trim():null;return n||console.error("CSRF token is empty"),n}async function logClientError(e,t=""){try{const n={message:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:"",url:window.location.href,line:e.lineno||0,column:e.colno||0,context:t,timestamp:(new Date).toISOString()},o=getCSRFToken();if(!o)return void console.error("Cannot log error: CSRF token not found");const a=await fetch("/api/admin.php?action=log_client_error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...n,csrf_token:o}),credentials:"same-origin"});a.ok||console.error("Failed to log client error:",a.status)}catch(e){console.error("Error logging failed:",e)}}function openCCModal(e){const t=document.getElementById("adminModalBody");if(t){if(t.innerHTML='<div class="cc-modal-loading"><div class="cc-modal-spinner"></div><div style="margin-top: 1rem;">Načítání...</div></div>',window.adminModal&&window.adminModal.open)window.adminModal.open();else{const e=document.getElementById("adminOverlay"),t=document.getElementById("adminModal");e&&e.classList.add("active"),t&&t.classList.add("active"),window.scrollLock&&window.scrollLock.enable("admin-modal")}switch(e){case"statistics":loadStatisticsModal();break;case"analytics":loadAnalyticsModal();break;case"keys":loadKeysModal();break;case"users":loadUsersModal();break;case"notifications":loadNotificationsModal();break;case"claims":loadClaimsModal();break;case"actions":loadActionsModal();break;case"diagnostics":loadDiagnosticsModal();break;case"console":loadConsoleModal();break;case"testing":loadTestingModal();break;case"appearance":loadAppearanceModal();break;case"content":loadContentModal();break;case"config":loadConfigModal()}}else console.error("Modal body nenalezen")}function closeCCModal(){if(window.adminModal&&window.adminModal.close)window.adminModal.close();else{const e=document.getElementById("adminOverlay"),t=document.getElementById("adminModal");e&&e.classList.remove("active"),t&&t.classList.remove("active"),window.scrollLock&&window.scrollLock.disable("admin-modal")}}function openSQLPage(){const e=window.open("vsechny_tabulky.php","_blank");e&&!e.closed&&void 0!==e.closed||(console.warn("Pop-up blokován, použiji location.href"),window.location.href="vsechny_tabulky.php")}async function resolveCSRFToken(){const e=e=>{if(!e)return null;const t=e.querySelector('meta[name="csrf-token"]');return t?.content?.trim()||null},t=e(document);if(t)return t;if(window.parent&&window.parent!==window)try{const t=e(window.parent.document);if(t)return t}catch(e){console.warn("[getEmbedUrlWithCSRF] Cannot access parent document for CSRF token:",e)}if("function"==typeof getCSRFToken)try{const e=await getCSRFToken();if(e)return e}catch(e){console.warn("[getEmbedUrlWithCSRF] Async CSRF fetch failed:",e)}return null}async function getEmbedUrlWithCSRF(e){const t=await resolveCSRFToken();if(!t)return console.warn("[getEmbedUrlWithCSRF] CSRF token unavailable, falling back to base URL"),e;const n=e.includes("?")?"&":"?";return`${e}${n}csrf=${encodeURIComponent(t)}`}async function loadStatisticsModal(){const e=document.getElementById("adminModalBody");if(e)try{const t=await getEmbedUrlWithCSRF("statistiky.php?embed=1");e.innerHTML=`<div class="cc-iframe-container"><iframe src="${t}" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals" title="Statistiky reklamací"></iframe></div>`}catch(t){console.error("[loadStatisticsModal] Failed to load iframe URL:",t),e.innerHTML='<div class="cc-modal-loading">Nepodařilo se načíst statistiky.</div>'}else console.error("[loadStatisticsModal] adminModalBody element nenalezen")}async function loadAnalyticsModal(){const e=document.getElementById("adminModalBody");if(e)try{const t=await getEmbedUrlWithCSRF("analytics.php?embed=1");e.innerHTML=`<div class="cc-iframe-container"><iframe src="${t}" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals" title="Web Analytics"></iframe></div>`}catch(t){console.error("[loadAnalyticsModal] Failed to load iframe URL:",t),e.innerHTML='<div class="cc-modal-loading">Nepodařilo se načíst analytics.</div>'}else console.error("adminModalBody element nenalezen")}function loadKeysModal(){const e=document.getElementById("adminModalBody");e?e.innerHTML='\n        <iframe\n            src="/includes/admin_security.php?embed=1"\n            style="width: 100%; height: 80vh; border: none; border-radius: 4px;"\n        ></iframe>\n    ':console.error("adminModalBody element nenalezen")}function loadUsersModal(){const e=document.getElementById("adminModalBody");e?(e.innerHTML='\n        <div class="cc-actions">\n            <input type="text" class="search-box" id="adminSearchUsers" placeholder="Hledat uživatele..." style="flex: 1; max-width: 300px;">\n            <button class="btn btn-sm btn-success" data-action="navigateToAddUser">+ Přidat uživatele</button>\n            <button class="btn btn-sm" data-action="loadUsersModal">Obnovit</button>\n        </div>\n        <div id="usersTableContainer">Načítání uživatelů...</div>\n    ',fetch("api/admin_api.php?action=list_users").then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}).then(e=>{const t=document.getElementById("usersTableContainer"),n=e.data||e.users||[];if(isSuccess(e)&&n.length>0){let e='<table class="cc-table"><thead><tr>';e+="<th>ID</th><th>Jméno</th><th>Email</th><th>Role</th><th>Status</th><th>Vytvořen</th></tr></thead><tbody>",n.forEach(t=>{const n="function"==typeof escapeHTML?escapeHTML(t.name||t.full_name||""):t.name||t.full_name||"",o="function"==typeof escapeHTML?escapeHTML(t.email||""):t.email||"",a="function"==typeof escapeHTML?escapeHTML(t.role||""):t.role||"";e+="<tr>",e+=`<td>#${parseInt(t.id)||0}</td>`,e+=`<td>${n}</td>`,e+=`<td>${o}</td>`,e+=`<td><span class="badge badge-${a}">${a}</span></td>`,e+=`<td><span class="badge badge-${t.is_active?"active":"inactive"}">${t.is_active?"Aktivní":"Neaktivní"}</span></td>`,e+=`<td>${t.created_at?new Date(t.created_at).toLocaleDateString("cs-CZ"):"—"}</td>`,e+="</tr>"}),e+="</tbody></table>",t.innerHTML=e}else isSuccess(e)?t.innerHTML='<p style="color: var(--c-grey); text-align: center; padding: 2rem;">Žádní uživatelé</p>':t.innerHTML='<p style="color: var(--c-error); text-align: center; padding: 2rem;">Chyba načítání</p>'}).catch(e=>{console.error("[Control Center] Users load error:",e),document.getElementById("usersTableContainer").innerHTML='<p style="color: var(--c-error); text-align: center; padding: 2rem;">Chyba načítání</p>'})):console.error("adminModalBody element nenalezen")}async function loadNotificationsModal(){const e=document.getElementById("adminModalBody");if(!e)return void console.error("adminModalBody element nenalezen");const t=await getEmbedUrlWithCSRF("admin.php?tab=notifications&embed=1");e.innerHTML=`<div class="cc-iframe-container"><iframe src="${t}" sandbox="allow-scripts allow-same-origin allow-forms" title="Email & SMS notifikace"></iframe></div>`}function loadClaimsModal(){const e=document.getElementById("adminModalBody");if(!e)return void console.error("adminModalBody element nenalezen");const t=(new Date).getTime();e.innerHTML=`\n        <iframe\n            src="/includes/admin_reklamace_management.php?embed=1&filter=all&_t=${t}"\n            style="width: 100%; height: 80vh; border: none; border-radius: 4px;"\n            id="claimsIframe"\n        ></iframe>\n    `}async function loadActionsModal(){const e=document.getElementById("adminModalBody");if(!e)return void console.error("adminModalBody element nenalezen");const t=await getEmbedUrlWithCSRF("admin.php?tab=admin_actions&embed=1");e.innerHTML=`<div class="cc-iframe-container"><iframe src="${t}" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals" title="Akce & Úkoly"></iframe></div>`}async function loadDiagnosticsModal(){const e=document.getElementById("adminModalBody");if(e)try{const t=await getEmbedUrlWithCSRF("admin.php?tab=tools&embed=1");e.innerHTML=`<div class="cc-iframe-container"><iframe src="${t}" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals" title="Diagnostika systému"></iframe></div>`}catch(t){console.error("[loadDiagnosticsModal] Failed to load iframe URL:",t),e.innerHTML='<div class="cc-modal-loading">Nepodařilo se načíst diagnostiku.</div>'}else console.error("adminModalBody element nenalezen")}async function loadConsoleModal(){const e=document.getElementById("adminModalBody");if(!e)return void console.error("adminModalBody element nenalezen");const t=await getEmbedUrlWithCSRF("admin.php?tab=admin_console&embed=1");e.innerHTML=`<div class="cc-iframe-container"><iframe src="${t}" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals" title="Konzole - Developer Tools"></iframe></div>`}async function loadTestingModal(){const e=document.getElementById("adminModalBody");if(!e)return void console.error("adminModalBody element nenalezen");const t=await getEmbedUrlWithCSRF("admin.php?tab=admin_testing_interactive&embed=1");e.innerHTML=`<div class="cc-iframe-container"><iframe src="${t}" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals" title="Testovací prostředí"></iframe></div>`}async function loadAppearanceModal(){const e=document.getElementById("adminModalBody");if(!e)return void console.error("adminModalBody element nenalezen");const t=await getEmbedUrlWithCSRF("admin.php?tab=admin_appearance&embed=1");e.innerHTML=`<div class="cc-iframe-container"><iframe src="${t}" sandbox="allow-scripts allow-same-origin allow-forms" title="Vzhled & Design"></iframe></div>`}async function loadContentModal(){const e=document.getElementById("adminModalBody");if(!e)return void console.error("adminModalBody element nenalezen");const t=await getEmbedUrlWithCSRF("admin.php?tab=admin_content&embed=1");e.innerHTML=`<div class="cc-iframe-container"><iframe src="${t}" sandbox="allow-scripts allow-same-origin allow-forms" title="Obsah & Texty"></iframe></div>`}async function loadConfigModal(){const e=document.getElementById("adminModalBody");if(!e)return void console.error("adminModalBody element nenalezen");const t=await getEmbedUrlWithCSRF("admin.php?tab=admin_configuration&embed=1");e.innerHTML=`<div class="cc-iframe-container"><iframe src="${t}" sandbox="allow-scripts allow-same-origin allow-forms" title="Konfigurace systému"></iframe></div>`}async function deleteKey(e){if(!await wgsConfirm("Opravdu chcete smazat tento klíč?",{titulek:"Smazat klíč",btnPotvrdit:"Smazat",nebezpecne:!0}))return;const n=await getCSRFToken();n?fetch("api/admin_api.php?action=delete_key",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key_code:e,csrf_token:n})}).then(e=>e.json()).then(e=>{isSuccess(e)?loadKeysModal():alert(t("error")+": "+(e.error||e.message||t("unknown_error")))}).catch(e=>{alert("Chyba: "+e.message)}):alert(t("csrf_token_not_found"))}function createKey(){const e=document.getElementById("createKeyModal");e&&e.remove();const t=document.createElement("div");t.id="createKeyModal",t.style.cssText="\n        position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n        background: rgba(0,0,0,0.6); display: flex;\n        align-items: center; justify-content: center; z-index: 10000;\n    ",t.innerHTML='\n        <style>\n            .key-type-label {\n                display: flex; align-items: center; padding: 15px;\n                background: #252525; border-radius: 8px; cursor: pointer;\n                border: 2px solid transparent; transition: all 0.2s;\n            }\n            .key-type-label:hover { border-color: #555; }\n            .key-type-label.selected { border-color: #fff; }\n            .key-type-label:first-child { margin-bottom: 10px; }\n        </style>\n        <div style="background: #1a1a1a; padding: 30px; border-radius: 12px;\n                    max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);\n                    border: 1px solid #333;">\n            <h3 style="margin: 0 0 20px 0; color: #fff; font-size: 1.3rem;">\n                Vytvořit nový registrační klíč\n            </h3>\n\n            <div style="margin-bottom: 20px;">\n                <label class="key-type-label">\n                    <input type="radio" name="keyType" value="technik"\n                           style="width: 20px; height: 20px; margin-right: 15px; accent-color: #fff;">\n                    <div>\n                        <div style="color: #fff; font-weight: 600; font-size: 1.1rem;">TECHNIK</div>\n                        <div style="color: #888; font-size: 0.85rem;">Pro servisní techniky</div>\n                    </div>\n                </label>\n\n                <label class="key-type-label">\n                    <input type="radio" name="keyType" value="prodejce"\n                           style="width: 20px; height: 20px; margin-right: 15px; accent-color: #fff;">\n                    <div>\n                        <div style="color: #fff; font-weight: 600; font-size: 1.1rem;">PRODEJCE</div>\n                        <div style="color: #888; font-size: 0.85rem;">Pro prodejce a obchodníky</div>\n                    </div>\n                </label>\n            </div>\n\n            <div style="margin-bottom: 20px;">\n                <label style="display: block; color: #aaa; font-size: 0.85rem; margin-bottom: 8px;">\n                    Prirazeny email (volitelne)\n                </label>\n                <input type="email" id="createKeyEmail" placeholder="jan@example.com"\n                       style="width: 100%; padding: 10px; background: #252525; border: 1px solid #444;\n                       border-radius: 6px; color: #fff; font-size: 0.9rem; box-sizing: border-box;">\n                <div style="color: #666; font-size: 0.75rem; margin-top: 5px;">\n                    Email se ulozi ke klici, ale pozvanka se NEODESLE. Pro odeslani pouzijte "Pozvat".\n                </div>\n            </div>\n\n            <div style="display: flex; gap: 10px;">\n                <button data-action="vytvorKlicZModalu" style="flex: 1; padding: 12px;\n                        background: #fff; color: #000; border: none; border-radius: 6px;\n                        font-weight: 600; cursor: pointer; font-size: 1rem;">\n                    Vytvořit klíč\n                </button>\n                <button data-action="zavritCreateKeyModal"\n                        style="flex: 1; padding: 12px; background: #333; color: #fff;\n                        border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">\n                    Zrušit\n                </button>\n            </div>\n        </div>\n    ',document.body.appendChild(t),t.querySelectorAll('input[name="keyType"]').forEach(e=>{e.addEventListener("change",()=>{t.querySelectorAll(".key-type-label").forEach(t=>{t.classList.toggle("selected",t.contains(e)&&e.checked)})})}),t.addEventListener("click",e=>{e.target===t&&t.remove()})}function vytvorKlicZModalu(){const e=document.querySelector('input[name="keyType"]:checked');if(!e)return void alert("Vyberte typ klíče");const n=e.value,o=document.getElementById("createKeyEmail"),a=o?o.value.trim():"",i=getCSRFToken();if(!i)return void alert(t("csrf_token_not_found"));const r={key_type:n,csrf_token:i};""!==a&&(r.email=a),fetch("api/admin_api.php?action=create_key",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}).then(e=>e.json()).then(e=>{if(document.getElementById("createKeyModal")?.remove(),isSuccess(e)){let n=t("key_created").replace("{key}",e.key_code);e.email&&(n+="\nPrirazeny email: "+e.email),alert(n),loadKeysModal()}else alert(t("error")+": "+(e.error||e.message||t("unknown_error")))}).catch(e=>{alert("Chyba: "+e.message)})}async function executeAction(e){const t=event.target,n=t.textContent,o=await getCSRFToken();if(!o||"string"!=typeof o||0===o.length)return void alert("Chyba: CSRF token nebyl nalezen nebo je neplatný. Obnovte stránku.");if(!await wgsConfirm("Spustit tuto akci? Bude provedena automaticky.",{titulek:"Spustit akci",btnPotvrdit:"Spustit"}))return;t.disabled=!0,t.textContent="Provádění...";const a={action_id:e,csrf_token:o};fetch("api/admin.php?action=execute_action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(async e=>{let t;try{t=await e.json()}catch(e){t=null}if(!e.ok){let n=`HTTP ${e.status}`;throw t&&(n=t.message||"Neznámá chyba",t.debug&&(n+="\n\n"+Object.entries(t.debug).map(([e,t])=>`${e}: ${"object"==typeof t?JSON.stringify(t,null,2):t}`).join("\n"))),new Error(n)}return t}).then(e=>{if(isSuccess(e)){const t=e.execution_time||"neznámý čas";alert(`Akce dokončena!\n\n${e.message}\n\nČas provedení: ${t}`),loadActionsModal()}else alert("Chyba: "+(e.error||e.message||"Neznámá chyba")),t.disabled=!1,t.textContent=n}).catch(e=>{alert("Chyba při provádění akce: "+e.message),t.disabled=!1,t.textContent=n})}function completeAction(e){const n=getCSRFToken();n?fetch("api/admin.php?action=complete_action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action_id:e,csrf_token:n})}).then(e=>e.json()).then(e=>{isSuccess(e)?(loadActionsModal(),location.reload()):alert(t("error")+": "+(e.error||e.message||t("unknown_error")))}).catch(e=>{alert("Chyba: "+e.message)}):alert(t("csrf_token_not_found"))}function dismissAction(e){const n=getCSRFToken();n?fetch("api/admin.php?action=dismiss_action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action_id:e,csrf_token:n})}).then(e=>e.json()).then(e=>{isSuccess(e)?(loadActionsModal(),location.reload()):alert(t("error")+": "+(e.error||e.message||t("unknown_error")))}).catch(e=>{alert("Chyba: "+e.message)}):alert(t("csrf_token_not_found"))}async function clearCacheAndReload(){if(await wgsConfirm("Vymazat lokální cache a načíst nejnovější verzi? Stránka se znovu načte.",{titulek:"Vymazat cache",btnPotvrdit:"Vymazat",nebezpecne:!0}))try{if(window.localStorage){const e={};["theme","user_preferences"].forEach(t=>{const n=localStorage.getItem(t);null!==n&&(e[t]=n)}),localStorage.clear(),Object.keys(e).forEach(t=>{localStorage.setItem(t,e[t])})}if(window.sessionStorage&&sessionStorage.clear(),"caches"in window){const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e)))}const e=(new Date).getTime(),t=new URL(window.location.href);t.searchParams.set("_cachebust",e),window.location.href=t.toString(),setTimeout(()=>{window.location.reload(!0)},100)}catch(e){console.error("Chyba při mazání cache:",e),alert("Chyba při mazání cache. Zkuste manuální refresh (Ctrl+Shift+R).")}}function initCardLoadingStates(){document.querySelectorAll(".admin-card").forEach(e=>{if(!e.querySelector(".admin-card-loader")){const t=document.createElement("div");t.className="cc-card-loader",t.innerHTML='<div class="cc-card-loader-spinner"></div>',e.appendChild(t)}const t=e.onclick;e.onclick=function(n){activateCardLoading(e),t&&t.call(this,n),setTimeout(()=>deactivateCardLoading(e),500)}})}function activateCardLoading(e){e.classList.add("loading");const t=e.querySelector(".admin-card-loader");t&&t.classList.add("active")}function deactivateCardLoading(e){e.classList.remove("loading");const t=e.querySelector(".admin-card-loader");t&&t.classList.remove("active")}function deactivateAllCardLoading(){document.querySelectorAll(".admin-card.loading").forEach(e=>{deactivateCardLoading(e)})}window.wgsConfirm=wgsConfirm,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initAdminPanel):initAdminPanel(),window.addEventListener("error",e=>{if(e.filename&&!e.filename.includes(window.location.origin))return;logClientError({message:e.message,lineno:e.lineno,colno:e.colno,stack:e.error?e.error.stack:""},"global-error-handler")}),window.addEventListener("unhandledrejection",e=>{logClientError({message:e.reason instanceof Error?e.reason.message:String(e.reason),stack:e.reason instanceof Error?e.reason.stack:""},"unhandled-promise-rejection")}),document.addEventListener("keydown",e=>{"Escape"===e.key&&closeCCModal()}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initCardLoadingStates):initCardLoadingStates();const originalOpenCCModal=window.openCCModal;async function zobrazDetailUzivatele(e){try{const t=await fetch(`/api/admin_users_api.php?action=get&user_id=${e}`,{credentials:"same-origin"});if(!t.ok)throw new Error(`HTTP ${t.status}`);const n=await t.json();if("success"!==n.status||!n.user)throw new Error(n.message||"Nepodařilo se načíst detail uživatele");const o=n.user,a=`\n      <div class="user-detail-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;">\n        <div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">\n          \x3c!-- Header --\x3e\n          <div style="background: #333333; color: white; padding: 1.5rem; border-radius: 12px 12px 0 0; position: relative;">\n            <h2 style="margin: 0; font-size: 1.3rem; font-weight: 600;">Detail uživatele #${o.id}</h2>\n            <button data-action="zavritDetailUzivatele" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: white; font-size: 2rem; cursor: pointer; line-height: 1; padding: 0; width: 32px; height: 32px;">&times;</button>\n          </div>\n\n          \x3c!-- Body --\x3e\n          <div style="padding: 2rem;">\n            \x3c!-- Základní informace --\x3e\n            <div style="margin-bottom: 2rem;">\n              <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #333333; border-bottom: 2px solid #333333; padding-bottom: 0.5rem;">Základní údaje</h3>\n\n              <div style="margin-bottom: 1rem;">\n                <label style="display: block; font-weight: 500; margin-bottom: 0.3rem; font-size: 0.9rem;">Jméno a příjmení</label>\n                <input type="text" id="edit-user-name" value="${escapeHtml(o.name)}" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">\n              </div>\n\n              <div style="margin-bottom: 1rem;">\n                <label style="display: block; font-weight: 500; margin-bottom: 0.3rem; font-size: 0.9rem;">Email</label>\n                <input type="email" id="edit-user-email" value="${escapeHtml(o.email)}" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">\n              </div>\n\n              <div style="margin-bottom: 1rem;">\n                <label style="display: block; font-weight: 500; margin-bottom: 0.3rem; font-size: 0.9rem;">Telefon</label>\n                <input type="tel" id="edit-user-phone" value="${escapeHtml(o.phone||"")}" placeholder="+420123456789" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">\n              </div>\n\n              <div style="margin-bottom: 1rem;">\n                <label style="display: block; font-weight: 500; margin-bottom: 0.3rem; font-size: 0.9rem;">Adresa</label>\n                <input type="text" id="edit-user-address" value="${escapeHtml(o.address||"")}" placeholder="Ulice 123, Město" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">\n              </div>\n\n              <div style="margin-bottom: 1rem;">\n                <label style="display: block; font-weight: 500; margin-bottom: 0.3rem; font-size: 0.9rem;">Role</label>\n                <select id="edit-user-role" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">\n                  <option value="prodejce" ${"prodejce"===o.role?"selected":""}>Prodejce</option>\n                  <option value="technik" ${"technik"===o.role?"selected":""}>Technik</option>\n                  <option value="admin" ${"admin"===o.role?"selected":""}>Administrátor</option>\n                </select>\n              </div>\n\n              <button data-action="ulozitZmenyUzivatele" data-id="${o.id}" style="width: 100%; padding: 0.8rem; background: #333333; color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: background 0.2s;">\n                [Save] Uložit změny\n              </button>\n            </div>\n\n            \x3c!-- Změna hesla --\x3e\n            <div style="margin-bottom: 2rem; padding: 1rem; background: #f9f9f9; border-radius: 8px;">\n              <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #d97706;">[Lock] Změna hesla</h3>\n\n              <div style="margin-bottom: 1rem;">\n                <label style="display: block; font-weight: 500; margin-bottom: 0.3rem; font-size: 0.9rem;">Nové heslo (min. 8 znaků)</label>\n                <input type="password" id="edit-user-password" placeholder="••••••••" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">\n              </div>\n\n              <button data-action="zmenitHesloUzivatele" data-id="${o.id}" style="width: 100%; padding: 0.8rem; background: #d97706; color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: background 0.2s;">\n                Změnit heslo\n              </button>\n            </div>\n\n            \x3c!-- Status a akce --\x3e\n            <div style="padding: 1rem; background: ${"active"===o.status?"#d1fae5":"#fee2e2"}; border-radius: 8px;">\n              <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Stav účtu</h3>\n\n              <div style="margin-bottom: 1rem;">\n                <strong>Aktuální stav:</strong>\n                <span style="font-weight: bold; color: ${"active"===o.status?"#059669":"#dc2626"};">\n                  ${"active"===o.status?"AKTIVNÍ":"NEAKTIVNÍ"}\n                </span>\n              </div>\n\n              ${o.created_at?`\n                <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #666;">\n                  <strong>Vytvořen:</strong> ${new Date(o.created_at).toLocaleString("cs-CZ")}\n                </div>\n              `:""}\n\n              ${o.last_login?`\n                <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #666;">\n                  <strong>Poslední přihlášení:</strong> ${new Date(o.last_login).toLocaleString("cs-CZ")}\n                </div>\n              `:""}\n\n              <button data-action="prepnoutStatusUzivatele" data-id="${o.id}" data-status="${"active"===o.status?"inactive":"active"}" style="width: 100%; padding: 0.8rem; background: ${"active"===o.status?"#dc2626":"#059669"}; color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 1rem; cursor: pointer;">\n                ${"active"===o.status?"Deaktivovat uživatele":"Aktivovat uživatele"}\n              </button>\n            </div>\n\n            \x3c!-- Supervizor sekce --\x3e\n            <div style="margin-top: 2rem; padding: 1rem; background: #f0f4ff; border-radius: 8px; border: 2px solid #6366f1;">\n              <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #4f46e5;">Supervizor</h3>\n              <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">\n                Jako supervizor tento uživatel uvidí zakázky vybraných prodejců.\n              </p>\n              <div id="supervisorAssignmentsPreview" style="margin-bottom: 1rem; font-size: 0.9rem; color: #333;">\n                Načítám přiřazení...\n              </div>\n              <button data-action="otevritSpravuSupervize" data-id="${o.id}" style="width: 100%; padding: 0.8rem; background: #4f46e5; color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: background 0.2s;">\n                Spravovat přiřazení\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;setTimeout(()=>nactiSupervizorPrirazeni(o.id),100);const i=document.createElement("div");i.id="userDetailModal",i.innerHTML=a,document.body.appendChild(i)}catch(e){logger.error("Chyba při načítání detailu uživatele:",e),alert("Chyba při načítání detailu: "+e.message)}}function zavritDetailUzivatele(){const e=document.getElementById("userDetailModal");e&&e.remove()}async function ulozitZmenyUzivatele(e){try{const t=document.getElementById("edit-user-name").value.trim(),n=document.getElementById("edit-user-email").value.trim(),o=document.getElementById("edit-user-phone").value.trim(),a=document.getElementById("edit-user-address").value.trim(),i=document.getElementById("edit-user-role").value;if(!t||!n)return void alert("Jméno a email jsou povinné");const r=await getCSRFToken();if(!r)throw new Error("CSRF token není k dispozici");const s=await fetch("/api/admin_users_api.php?action=update",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:e,name:t,email:n,phone:o,address:a,role:i,csrf_token:r})});if(!s.ok)throw new Error(`HTTP ${s.status}`);const d=await s.json();"success"===d.status?(alert("Změny byly uloženy!"),zavritDetailUzivatele(),loadUsers()):alert("Chyba: "+(d.message||"Nepodařilo se uložit změny"))}catch(e){logger.error("Chyba při ukládání změn:",e),alert("Chyba při ukládání: "+e.message)}}async function zmenitHesloUzivatele(e){try{const t=document.getElementById("edit-user-password").value;if(!t)return void alert("Zadejte nové heslo");if(t.length<8)return void alert("Heslo musí mít alespoň 8 znaků");if(!await wgsConfirm("Opravdu chcete změnit heslo tohoto uživatele?",{titulek:"Změna hesla",btnPotvrdit:"Změnit heslo",nebezpecne:!0}))return;const n=await getCSRFToken();if(!n)throw new Error("CSRF token není k dispozici");const o=await fetch("/api/admin_users_api.php?action=update_password",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:e,new_password:t,csrf_token:n})});if(!o.ok)throw new Error(`HTTP ${o.status}`);const a=await o.json();"success"===a.status?(alert("Heslo bylo změněno!"),document.getElementById("edit-user-password").value=""):alert("Chyba: "+(a.message||"Nepodařilo se změnit heslo"))}catch(e){logger.error("Chyba při změně hesla:",e),alert("Chyba při změně hesla: "+e.message)}}async function prepnoutStatusUzivatele(e,t){try{const n="active"===t?"aktivovat":"deaktivovat";if(!await wgsConfirm(`Opravdu chcete ${n} tohoto uživatele?`,{titulek:"active"===t?"Aktivovat uživatele":"Deaktivovat uživatele",btnPotvrdit:"active"===t?"Aktivovat":"Deaktivovat",nebezpecne:"active"!==t}))return;const o=await getCSRFToken();if(!o)throw new Error("CSRF token není k dispozici");const a=await fetch("/api/admin_users_api.php?action=update_status",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:e,status:t,csrf_token:o})});if(!a.ok)throw new Error(`HTTP ${a.status}`);const i=await a.json();"success"===i.status?(alert(`Uživatel byl ${"active"===t?"aktivován":"deaktivován"}!`),zavritDetailUzivatele(),loadUsers()):alert("Chyba: "+(i.message||"Nepodařilo se změnit status"))}catch(e){logger.error("Chyba při změně statusu:",e),alert("Chyba při změně statusu: "+e.message)}}async function nactiSupervizorPrirazeni(e){try{const t=document.getElementById("supervisorAssignmentsPreview");if(!t)return;const n=await fetch(`/api/supervisor_api.php?action=getAssignments&user_id=${e}`,{credentials:"same-origin"}),o=await n.json();if("success"===o.status){const e=o.data.assignments||[];if(0===e.length)t.innerHTML='<span style="color: #999;">Žádní přiřazení prodejci</span>';else{const n=e.map(e=>escapeHtml(e.jmeno||e.email)).join(", ");t.innerHTML=`<strong>Přiřazení prodejci (${e.length}):</strong><br>${n}`}}else t.innerHTML='<span style="color: #dc2626;">Chyba načítání</span>'}catch(e){logger.error("Chyba při načítání supervizor přiřazení:",e);const t=document.getElementById("supervisorAssignmentsPreview");t&&(t.innerHTML='<span style="color: #dc2626;">Chyba: '+escapeHtml(e.message)+"</span>")}}async function otevritSpravuSupervize(e){try{const[t,n]=await Promise.all([fetch(`/api/supervisor_api.php?action=getSalespersons&exclude_user_id=${e}`,{credentials:"same-origin"}),fetch(`/api/supervisor_api.php?action=getAssignments&user_id=${e}`,{credentials:"same-origin"})]),o=await t.json(),a=await n.json();if("success"!==o.status)throw new Error(o.message||"Chyba načítání prodejců");const i=o.data.salespersons||[],r=(a.data?.assignments||[]).map(e=>parseInt(e.salesperson_user_id)),s=`\n      <div id="supervisorOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center;">\n        <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.4);">\n          <div style="background: #4f46e5; color: white; padding: 1.5rem; position: relative;">\n            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600;">Správa supervize</h3>\n            <p style="margin: 0.5rem 0 0; font-size: 0.85rem; opacity: 0.9;">Vyberte prodejce, jejichž zakázky bude supervizor vidět</p>\n            <button data-action="zavritSupervizorOverlay" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: white; font-size: 1.8rem; cursor: pointer; line-height: 1;">&times;</button>\n          </div>\n          <div style="padding: 1.5rem; max-height: 50vh; overflow-y: auto;">\n            ${0===i.length?'<p style="color: #999; text-align: center;">Žádní další uživatelé v systému</p>':""}\n            ${i.map(e=>`\n              <label style="display: flex; align-items: center; padding: 0.8rem; margin-bottom: 0.5rem; background: #f9f9f9; border-radius: 8px; cursor: pointer; transition: background 0.2s;">\n                <input type="checkbox" class="supervisor-checkbox" value="${e.numeric_id}" ${r.includes(parseInt(e.numeric_id))?"checked":""} style="width: 20px; height: 20px; margin-right: 1rem; accent-color: #4f46e5;">\n                <div style="flex: 1;">\n                  <div style="font-weight: 600; color: #333;">${escapeHtml(e.jmeno||"Bez jména")}</div>\n                  <div style="font-size: 0.85rem; color: #666;">${escapeHtml(e.email)} - ${escapeHtml(e.role||"prodejce")}</div>\n                </div>\n              </label>\n            `).join("")}\n          </div>\n          <div style="padding: 1rem 1.5rem; border-top: 1px solid #eee; display: flex; gap: 1rem;">\n            <button data-action="zavritSupervizorOverlay" style="flex: 1; padding: 0.8rem; background: #e5e7eb; color: #333; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">\n              Zrušit\n            </button>\n            <button data-action="ulozitSupervizorPrirazeni" data-id="${e}" style="flex: 1; padding: 0.8rem; background: #4f46e5; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">\n              Uložit\n            </button>\n          </div>\n        </div>\n      </div>\n    `,d=document.createElement("div");d.innerHTML=s,document.body.appendChild(d.firstElementChild)}catch(e){logger.error("Chyba při otevírání správy supervize:",e),alert("Chyba: "+e.message)}}function zavritSupervizorOverlay(){const e=document.getElementById("supervisorOverlay");e&&e.remove()}async function ulozitSupervizorPrirazeni(e){try{const t=document.querySelectorAll(".supervisor-checkbox:checked"),n=Array.from(t).map(e=>parseInt(e.value)),o=await getCSRFToken();if(!o)throw new Error("CSRF token není k dispozici");const a=new FormData;a.append("action","saveAssignments"),a.append("supervisor_id",e),a.append("salesperson_ids",JSON.stringify(n)),a.append("csrf_token",o);const i=await fetch("/api/supervisor_api.php",{method:"POST",credentials:"same-origin",body:a}),r=await i.json();"success"===r.status?(alert(r.message||"Přiřazení uloženo!"),zavritSupervizorOverlay(),nactiSupervizorPrirazeni(e)):alert("Chyba: "+(r.message||"Nepodařilo se uložit"))}catch(e){logger.error("Chyba při ukládání supervizor přiřazení:",e),alert("Chyba: "+e.message)}}function switchEmailSection(e){document.querySelectorAll(".cc-tab").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll(".cc-section").forEach(e=>{e.classList.remove("active")});const t=document.querySelector(`.cc-tab[data-section="${e}"]`);t&&t.classList.add("active");const n=document.getElementById(`section-${e}`);n&&n.classList.add("active")}window.openCCModal=function(...e){if(deactivateAllCardLoading(),originalOpenCCModal)return originalOpenCCModal.apply(this,e)},window.zobrazDetailUzivatele=zobrazDetailUzivatele,window.zavritDetailUzivatele=zavritDetailUzivatele,window.ulozitZmenyUzivatele=ulozitZmenyUzivatele,window.zmenitHesloUzivatele=zmenitHesloUzivatele,window.prepnoutStatusUzivatele=prepnoutStatusUzivatele,window.nactiSupervizorPrirazeni=nactiSupervizorPrirazeni,window.otevritSpravuSupervize=otevritSpravuSupervize,window.zavritSupervizorOverlay=zavritSupervizorOverlay,window.ulozitSupervizorPrirazeni=ulozitSupervizorPrirazeni,window.addEventListener("message",function(e){if(e.origin!==window.location.origin)return;const t=e.data;if("switchTab"===t.action&&t.tab){let e="/admin.php?tab="+t.tab;t.highlightId&&(e+="#"+t.highlightId),window.location.href=e}}),"undefined"!=typeof Utils&&Utils.registerAction&&(Utils.registerAction("openSQLPage",()=>openSQLPage()),Utils.registerAction("openNotifModal",(e,t)=>{t.modal&&"function"==typeof openNotifModal&&openNotifModal(t.modal)}),Utils.registerAction("clearCacheAndReload",()=>{"function"==typeof clearCacheAndReload&&clearCacheAndReload()}),Utils.registerAction("closeCCModal",()=>{"function"==typeof closeCCModal&&closeCCModal()}),Utils.registerAction("closeEditNotificationModal",()=>{"function"==typeof closeEditNotificationModal&&closeEditNotificationModal()}),Utils.registerAction("addCCEmail",()=>{"function"==typeof addCCEmail&&addCCEmail()}),Utils.registerAction("addBCCEmail",()=>{"function"==typeof addBCCEmail&&addBCCEmail()}),Utils.registerAction("saveNotificationTemplate",()=>{"function"==typeof saveNotificationTemplate&&saveNotificationTemplate()}),Utils.registerAction("openSection",(e,t)=>{t.section&&"function"==typeof openSection&&openSection(t.section)}),Utils.registerAction("openNewWindow",(e,t)=>{t.url&&window.open(t.url,"_blank")}),Utils.registerAction("zobrazDetailUzivatele",(e,t)=>{t.id&&"function"==typeof zobrazDetailUzivatele&&zobrazDetailUzivatele(t.id)}),Utils.registerAction("deleteUser",(e,t)=>{t.id&&"function"==typeof deleteUser&&(e.closest('[data-action="stopPropagation"]')?.dispatchEvent(new Event("click",{bubbles:!1})),deleteUser(t.id))}),Utils.registerAction("otevritZakazkyZakaznika",(e,t)=>{t.jmeno&&t.email&&"function"==typeof otevritZakazkyZakaznika&&otevritZakazkyZakaznika(t.jmeno,t.email)}),Utils.registerAction("navigateToAddUser",()=>{window.location.href="admin.php?tab=users"}),Utils.registerAction("loadUsersModal",()=>{"function"==typeof loadUsersModal&&loadUsersModal()}),Utils.registerAction("vytvorKlicZModalu",()=>{"function"==typeof vytvorKlicZModalu&&vytvorKlicZModalu()}),Utils.registerAction("zavritCreateKeyModal",()=>{const e=document.getElementById("createKeyModal");e&&e.remove()}),Utils.registerAction("zavritDetailUzivatele",()=>{"function"==typeof zavritDetailUzivatele&&zavritDetailUzivatele()}),Utils.registerAction("ulozitZmenyUzivatele",(e,t)=>{t.id&&"function"==typeof ulozitZmenyUzivatele&&ulozitZmenyUzivatele(t.id)}),Utils.registerAction("zmenitHesloUzivatele",(e,t)=>{t.id&&"function"==typeof zmenitHesloUzivatele&&zmenitHesloUzivatele(t.id)}),Utils.registerAction("prepnoutStatusUzivatele",(e,t)=>{t.id&&t.status&&"function"==typeof prepnoutStatusUzivatele&&prepnoutStatusUzivatele(t.id,t.status)}),Utils.registerAction("otevritSpravuSupervize",(e,t)=>{t.id&&"function"==typeof otevritSpravuSupervize&&otevritSpravuSupervize(t.id)}),Utils.registerAction("zavritSupervizorOverlay",()=>{"function"==typeof zavritSupervizorOverlay&&zavritSupervizorOverlay()}),Utils.registerAction("ulozitSupervizorPrirazeni",(e,t)=>{t.id&&"function"==typeof ulozitSupervizorPrirazeni&&ulozitSupervizorPrirazeni(t.id)}),Utils.registerAction("onChangeConfig",(e,t)=>{t.id&&t.key&&"function"==typeof saveConfig&&saveConfig(t.id,t.key)}),Utils.registerAction("toggleSelectAllEmails",()=>{"function"==typeof toggleSelectAllEmails&&toggleSelectAllEmails()}),Utils.registerAction("updateSelectedEmailCount",()=>{"function"==typeof updateSelectedEmailCount&&updateSelectedEmailCount()}),Utils.registerAction("zmenitStavReklamace",(e,t)=>{t.id&&"function"==typeof zmenitStavReklamace&&zmenitStavReklamace(t.id,e.value)}),Utils.registerAction("aktualizovatVyber",()=>{"function"==typeof aktualizovatVyber&&aktualizovatVyber()}),Utils.registerAction("switchEmailSection",(e,t)=>{t.section&&"function"==typeof switchEmailSection&&switchEmailSection(t.section)}),Utils.registerAction("upravitEmailKlice",(e,t)=>{const n=t.code,o=t.email||"",a=document.getElementById("modalUpravitEmail");a&&a.remove();const i=document.createElement("div");i.id="modalUpravitEmail",i.style.cssText="\n      position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n      background: rgba(0,0,0,0.7); display: flex;\n      align-items: center; justify-content: center; z-index: 10000;\n    ";const r=e=>String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]));i.innerHTML=`\n      <div style="background: #1a1a1a; padding: 25px; border-radius: 12px;\n                  max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);\n                  border: 1px solid #333;">\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">\n          <h3 style="margin: 0; color: #fff; font-size: 1.1rem;">Upravit email</h3>\n          <button id="btnZavritEmailModal" style="background: none; border: none; color: #888;\n                  font-size: 1.5rem; cursor: pointer; line-height: 1;">&times;</button>\n        </div>\n        <div style="margin-bottom: 15px;">\n          <label style="display: block; color: #999; font-size: 0.85rem; margin-bottom: 8px;">\n            Email pro klíč <code style="background: #333; padding: 2px 6px; border-radius: 3px; color: #fff;">${r(n)}</code>\n          </label>\n          <input type="email" id="inputNovyEmail" value="${r(o)}"\n                 placeholder="email@example.com"\n                 style="width: 100%; padding: 12px; border: 1px solid #444; border-radius: 8px;\n                        background: #252525; color: #fff; font-size: 1rem; box-sizing: border-box;">\n        </div>\n        <div style="display: flex; gap: 10px; justify-content: flex-end;">\n          <button id="btnZrusitEmail" style="padding: 10px 20px; border: 1px solid #444;\n                  border-radius: 6px; background: transparent; color: #ccc; cursor: pointer;\n                  font-size: 0.9rem;">Zrušit</button>\n          <button id="btnUlozitEmail" style="padding: 10px 20px; border: none;\n                  border-radius: 6px; background: #fff; color: #000; cursor: pointer;\n                  font-size: 0.9rem; font-weight: 500;">Uložit</button>\n        </div>\n      </div>\n    `,document.body.appendChild(i);const s=document.getElementById("inputNovyEmail");s?.focus(),s?.select();const d=()=>i.remove();document.getElementById("btnZavritEmailModal")?.addEventListener("click",d),document.getElementById("btnZrusitEmail")?.addEventListener("click",d),i.addEventListener("click",e=>{e.target===i&&d()});const l=e=>{"Escape"===e.key&&(d(),document.removeEventListener("keydown",l))};document.addEventListener("keydown",l),document.getElementById("btnUlozitEmail")?.addEventListener("click",async()=>{const e=s?.value?.trim()||"",t=document.getElementById("btnUlozitEmail");t&&(t.textContent="Ukládám...",t.disabled=!0);try{const t=await getCSRFToken(),o=await fetch("/api/admin_api.php?action=update_key_email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key_code:n,email:e,csrf_token:t})}),a=await o.json();if("success"!==a.status)throw new Error(a.message||"Chyba při ukládání");d(),wgsToast.success(a.message||"Email uložen"),"function"==typeof nactiKlice?nactiKlice():location.reload()}catch(e){console.error("Chyba:",e),wgsToast.error(e.message||"Chyba při komunikaci se serverem"),t&&(t.textContent="Uložit",t.disabled=!1)}}),s?.addEventListener("keydown",e=>{"Enter"===e.key&&document.getElementById("btnUlozitEmail")?.click()})}));