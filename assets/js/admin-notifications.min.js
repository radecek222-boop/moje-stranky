let notificationState={notifications:[],currentEditing:null,ccEmails:[],bccEmails:[]};const ADMIN_SESSION_EXPIRED_MESSAGE="Vaše administrátorská relace vypršela. Přihlaste se prosím znovu.";function escapeHtml(t){if(null==t)return"";const i=document.createElement("div");return i.textContent=String(t),i.innerHTML}function redirectToAdminLogin(t=""){const i=t?`admin.php?tab=${t}`:"admin.php";window.location.href=`login.php?redirect=${encodeURIComponent(i)}`}function handleNotificationsUnauthorized(t,i,e="notifications"){return!(!t||401!==t.status&&403!==t.status)&&(i?i.innerHTML=`<div class="error-message">${ADMIN_SESSION_EXPIRED_MESSAGE}</div>`:alert(ADMIN_SESSION_EXPIRED_MESSAGE),setTimeout(()=>redirectToAdminLogin(e),800),!0)}async function loadNotifications(){const t=document.getElementById("notifications-container");if(t)try{const i=await fetch("/api/notification_list_direct.php",{credentials:"same-origin"});let e;if(!i.ok){if(handleNotificationsUnauthorized(i,t))return;try{e=await i.json()}catch(t){e=null}const n=e?.message?`: ${e.message}`:"";throw new Error(`HTTP ${i.status}${n}`)}e=await i.json(),"success"===e.status?(notificationState.notifications=e.data||[],renderNotifications()):t.innerHTML=`<div class="error-message">${e.message||"Chyba při načítání notifikací"}</div>`}catch(i){console.error("Load notifications failed:",i);const e=i&&i.message?i.message:"Chyba při načítání notifikací";t.innerHTML=`<div class="error-message">${e}</div>`}}function renderNotifications(){const t=document.getElementById("notifications-container");notificationState.notifications&&0!==notificationState.notifications.length?t.innerHTML=notificationState.notifications.map(t=>{const i={customer:"Zákazník",admin:"Admin",technician:"Technik",seller:"Prodejce"}[t.recipient_type]||t.recipient_type,e="both"===t.type?"Email + SMS":"email"===t.type?"Email":"SMS",n=escapeHtml(t.name),a=escapeHtml(t.description||"Bez popisu"),o=escapeHtml(t.trigger_event||""),c=escapeHtml(t.subject||""),s=escapeHtml(t.template||"").replace(/\n/g,"<br>");return`\n      <div class="notification-card">\n        <div class="notification-header" onclick="toggleNotificationBody('${t.id}')">\n          <div class="notification-title">\n            <span class="badge badge-${t.active?"active":"inactive"}">${t.active?"Aktivní":"Neaktivní"}</span>\n            <span>${n}</span>\n          </div>\n          <div class="notification-toggle">\n            <div class="toggle-switch ${t.active?"active":""}"\n                 onclick="event.stopPropagation(); toggleNotification('${t.id}')"></div>\n          </div>\n        </div>\n        <div class="notification-body" id="notification-body-${t.id}">\n          <div class="notification-info">\n            <div class="notification-info-label">Popis</div>\n            <div class="notification-info-value">${a}</div>\n\n            <div class="notification-info-label">Spouštěč</div>\n            <div class="notification-info-value">${o}</div>\n\n            <div class="notification-info-label">Příjemce</div>\n            <div class="notification-info-value">${i}</div>\n\n            <div class="notification-info-label">Typ</div>\n            <div class="notification-info-value">${e}</div>\n          </div>\n\n          ${t.subject?`\n            <div style="margin: 1rem 0;">\n              <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; text-transform: uppercase;">Předmět emailu:</div>\n              <div style="background: #f5f5f5; padding: 0.8rem; border: 1px solid #ddd;">${c}</div>\n            </div>\n          `:""}\n\n          <div style="margin: 1rem 0;">\n            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; text-transform: uppercase;">Šablona zprávy:</div>\n            <div class="template-preview">${s}</div>\n          </div>\n\n          <button class="btn btn-sm" onclick="openEditNotificationModal('${t.id}')">Editovat šablonu</button>\n        </div>\n      </div>\n    `}).join(""):t.innerHTML='<div class="loading">Žádné notifikace k zobrazení</div>'}function toggleNotificationBody(t){openEditNotificationModal(t)}async function toggleNotification(t){const i=notificationState.notifications.find(i=>i.id==t);if(!i)return;const e=!i.active;try{const n="function"==typeof getCSRFToken?await getCSRFToken():null;if(!n)throw new Error("CSRF token not available");const a=await fetch("/api/notification_api.php?action=toggle",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({notification_id:t,active:e,csrf_token:n})});if(!a.ok){if(handleNotificationsUnauthorized(a,null,"notifications"))return;const t=await a.text();throw new Error(t||"Chyba při změně stavu notifikace")}"success"===(await a.json()).status&&(i.active=e,renderNotifications())}catch(t){console.error("Toggle failed:",t),alert("Chyba při změně stavu notifikace")}}function initNotifications(){const t=new URLSearchParams(window.location.search),i=document.getElementById("notifications-container"),e=t.get("tab");i&&"notifications"===e&&loadNotifications()}function openEditNotificationModal(t){const i=notificationState.notifications.find(i=>i.id==t);if(!i)return;notificationState.currentEditing=i,document.getElementById("editNotificationTitle").textContent=`Editovat: ${i.name}`,document.getElementById("edit-recipient").value=i.recipient_type,document.getElementById("edit-subject").value=i.subject||"",document.getElementById("edit-template").value=i.template;const e=document.getElementById("available-variables");e&&i.variables&&(e.innerHTML=i.variables.map(t=>`<span class="variable-tag" onclick="insertVariable('${t}')">${t}</span>`).join("")),notificationState.ccEmails=i.cc_emails||[],notificationState.bccEmails=i.bcc_emails||[],renderCCEmails(),renderBCCEmails(),updateTemplatePreview();const n=document.getElementById("editNotificationModal");n.style.display="flex",n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100vw",n.style.height="100vh",n.style.alignItems="center",n.style.justifyContent="center",n.style.zIndex="9999"}function closeEditNotificationModal(){document.getElementById("editNotificationModal").style.display="none",notificationState.currentEditing=null,document.getElementById("edit-notification-error").style.display="none",document.getElementById("edit-notification-success").style.display="none"}function insertVariable(t){const i=document.getElementById("edit-template"),e=i.selectionStart,n=i.selectionEnd,a=i.value;i.value=a.substring(0,e)+t+a.substring(n),i.focus(),i.setSelectionRange(e+t.length,e+t.length),updateTemplatePreview()}function updateTemplatePreview(){const t=document.getElementById("edit-template").value,i=document.getElementById("template-preview");if(!i)return;if(!t)return void(i.textContent="Začněte psát...");let e=t.replace(/\{\{customer_name\}\}/g,"Jan Novák").replace(/\{\{date\}\}/g,"5.11.2025").replace(/\{\{time\}\}/g,"14:00").replace(/\{\{order_id\}\}/g,"WGS-12345").replace(/\{\{customer_phone\}\}/g,"+420 123 456 789").replace(/\{\{address\}\}/g,"Hlavní 123, Praha").replace(/\{\{product\}\}/g,"Pračka XYZ").replace(/\{\{description\}\}/g,"Nefunguje odstřeďování").replace(/\{\{technician_name\}\}/g,"Petr Technik").replace(/\{\{seller_name\}\}/g,"Marie Prodejce").replace(/\{\{created_at\}\}/g,"5.11.2025 14:30");i.textContent=e}function attachTemplateListener(){const t=document.getElementById("edit-template");t&&t.addEventListener("input",updateTemplatePreview)}async function saveNotificationTemplate(){const t=document.getElementById("edit-notification-error"),i=document.getElementById("edit-notification-success");if(t.style.display="none",i.style.display="none",!notificationState.currentEditing)return;const e={recipient:document.getElementById("edit-recipient").value,subject:document.getElementById("edit-subject").value,template:document.getElementById("edit-template").value,cc_emails:notificationState.ccEmails,bcc_emails:notificationState.bccEmails};if(!e.template.trim())return t.textContent="Text zprávy nesmí být prázdný",void(t.style.display="block");try{const n="function"==typeof getCSRFToken?await getCSRFToken():null;if(!n)throw new Error("CSRF token not available");const a=await fetch("/api/notification_api.php?action=update",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:notificationState.currentEditing.id,...e,csrf_token:n})});if(!a.ok){if(handleNotificationsUnauthorized(a,null,"notifications"))return;const t=await a.text();throw new Error(t||"Chyba při ukládání šablony")}const o=await a.json();"success"===o.status?(i.textContent="Šablona byla úspěšně uložena!",i.style.display="block",notificationState.notifications=notificationState.notifications.map(t=>t.id===notificationState.currentEditing.id?{...t,...e,recipient_type:e.recipient}:t),renderNotifications(),setTimeout(()=>{closeEditNotificationModal()},1500)):(t.textContent=o.message||"Chyba při ukládání šablony",t.style.display="block")}catch(i){t.textContent="Chyba při ukládání šablony",t.style.display="block",console.error(i)}}function addCCEmail(){const t=document.getElementById("new-cc-email"),i=t.value.trim();i&&(i.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)?notificationState.ccEmails.includes(i)?alert("Tento email už je přidán"):(notificationState.ccEmails.push(i),t.value="",renderCCEmails()):alert("Neplatný formát emailu"))}function removeCCEmail(t){notificationState.ccEmails=notificationState.ccEmails.filter(i=>i!==t),renderCCEmails()}function renderCCEmails(){const t=document.getElementById("cc-emails-list");t&&(t.innerHTML=notificationState.ccEmails.map(t=>`\n    <div class="email-tag">\n      ${t}\n      <span class="email-tag-remove" onclick="removeCCEmail('${t}')">×</span>\n    </div>\n  `).join(""))}function addBCCEmail(){const t=document.getElementById("new-bcc-email"),i=t.value.trim();i&&(i.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)?notificationState.bccEmails.includes(i)?alert("Tento email už je přidán"):(notificationState.bccEmails.push(i),t.value="",renderBCCEmails()):alert("Neplatný formát emailu"))}function removeBCCEmail(t){notificationState.bccEmails=notificationState.bccEmails.filter(i=>i!==t),renderBCCEmails()}function renderBCCEmails(){const t=document.getElementById("bcc-emails-list");t&&(t.innerHTML=notificationState.bccEmails.map(t=>`\n    <div class="email-tag">\n      ${t}\n      <span class="email-tag-remove" onclick="removeBCCEmail('${t}')">×</span>\n    </div>\n  `).join(""))}function addModalStyles(){const t=document.createElement("style");t.textContent='\n    #editNotificationModal {\n      display: none !important;\n    }\n    #editNotificationModal[style*="display: flex"] {\n      display: flex !important;\n      position: fixed !important;\n      top: 0 !important;\n      left: 0 !important;\n      width: 100vw !important;\n      height: 100vh !important;\n      align-items: center !important;\n      justify-content: center !important;\n    }\n    #editNotificationModal .modal-content {\n      width: 90vw !important;\n      height: 80vh !important;\n      max-width: 90vw !important;\n      max-height: 80vh !important;\n    }\n  ',document.head.appendChild(t)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initNotifications):initNotifications(),console.log("admin-notifications.js loaded"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",attachTemplateListener):attachTemplateListener(),console.log("Modal functions loaded"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",addModalStyles):addModalStyles();