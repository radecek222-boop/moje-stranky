let aktualniStranka=1,vybraneProdejci=[],vybraneTechnici=[],vybraneZeme=["cz","sk"];function inicializujMultiselect(){document.getElementById("prodejci-trigger").addEventListener("click",e=>{e.stopPropagation(),toggleDropdown("prodejci")}),document.getElementById("technici-trigger").addEventListener("click",e=>{e.stopPropagation(),toggleDropdown("technici")}),document.getElementById("zeme-trigger").addEventListener("click",e=>{e.stopPropagation(),toggleDropdown("zeme")}),document.addEventListener("click",e=>{e.target.closest(".filter-multiselect")||document.querySelectorAll(".multiselect-dropdown").forEach(e=>{e.classList.remove("active")})}),document.querySelectorAll('#zeme-dropdown input[type="checkbox"]').forEach(e=>{e.addEventListener("change",()=>{updateVyberZeme()})})}function toggleDropdown(e){const t=document.getElementById(`${e}-dropdown`);document.querySelectorAll(".multiselect-dropdown").forEach(e=>{e!==t&&e.classList.remove("active")}),t.classList.toggle("active")}async function nactiProdejce(){try{const e=await fetch("/api/statistiky_api.php?action=load_prodejci"),t=await e.json();if("success"===t.status){const e=document.getElementById("prodejci-dropdown");e.innerHTML="",t.data.forEach(t=>{const n=document.createElement("div");n.className="multiselect-option",n.innerHTML=`\n                    <input type="checkbox" id="prodejce-${t.id}" value="${t.id}">\n                    <label for="prodejce-${t.id}">${t.name}</label>\n                `,n.querySelector("input").addEventListener("change",()=>{updateVyberProdejci()}),e.appendChild(n)})}}catch(e){console.error("Chyba načítání prodejců:",e)}}async function nactiTechniky(){try{const e=await fetch("/api/statistiky_api.php?action=load_technici"),t=await e.json();if("success"===t.status){const e=document.getElementById("technici-dropdown");e.innerHTML="",t.data.forEach(t=>{const n=document.createElement("div");n.className="multiselect-option",n.innerHTML=`\n                    <input type="checkbox" id="technik-${t.id}" value="${t.id}">\n                    <label for="technik-${t.id}">${t.name}</label>\n                `,n.querySelector("input").addEventListener("change",()=>{updateVyberTechnici()}),e.appendChild(n)})}}catch(e){console.error("Chyba načítání techniků:",e)}}function updateVyberProdejci(){const e=document.querySelectorAll('#prodejci-dropdown input[type="checkbox"]:checked');vybraneProdejci=Array.from(e).map(e=>e.value);const t=document.getElementById("prodejci-label");if(0===vybraneProdejci.length)t.textContent="Všichni";else if(1===vybraneProdejci.length){const e=document.querySelector(`#prodejci-dropdown input[value="${vybraneProdejci[0]}"]`).nextElementSibling;t.textContent=e.textContent}else t.textContent=`Vybráno (${vybraneProdejci.length})`}function updateVyberTechnici(){const e=document.querySelectorAll('#technici-dropdown input[type="checkbox"]:checked');vybraneTechnici=Array.from(e).map(e=>e.value);const t=document.getElementById("technici-label");if(0===vybraneTechnici.length)t.textContent="Všichni";else if(1===vybraneTechnici.length){const e=document.querySelector(`#technici-dropdown input[value="${vybraneTechnici[0]}"]`).nextElementSibling;t.textContent=e.textContent}else t.textContent=`Vybráno (${vybraneTechnici.length})`}function updateVyberZeme(){const e=document.querySelectorAll('#zeme-dropdown input[type="checkbox"]:checked');vybraneZeme=Array.from(e).map(e=>e.value);const t=document.getElementById("zeme-label");if(0===vybraneZeme.length)t.textContent="Žádná";else if(2===vybraneZeme.length)t.textContent="Všechny";else{const e=document.querySelector(`#zeme-dropdown input[value="${vybraneZeme[0]}"]`).nextElementSibling;t.textContent=e.textContent}}function getFilterParams(){const e=new URLSearchParams,t=document.getElementById("filter-year").value,n=document.getElementById("filter-month").value;return t&&e.append("rok",t),n&&e.append("mesic",n),vybraneProdejci.forEach(t=>e.append("prodejci[]",t)),vybraneTechnici.forEach(t=>e.append("technici[]",t)),vybraneZeme.forEach(t=>e.append("zeme[]",t)),e.toString()}async function nactiSummary(){try{const e=getFilterParams(),t=await fetch(`/api/statistiky_api.php?action=summary&${e}`),n=await t.json();"success"===n.status&&(document.getElementById("total-all").textContent=n.data.total_all,document.getElementById("total-month").textContent=n.data.total_month,document.getElementById("revenue-all").textContent=n.data.revenue_all.toFixed(2)+" €",document.getElementById("revenue-month").textContent=n.data.revenue_month.toFixed(2)+" €")}catch(e){console.error("Chyba načítání summary:",e)}}async function nactiZakazky(){try{const e=document.getElementById("table-container");e.innerHTML='<div class="loading">Načítání zakázek...</div>';const t=getFilterParams(),n=await fetch(`/api/statistiky_api.php?action=get_zakazky&${t}&stranka=${aktualniStranka}`),a=await n.json();"success"===a.status?(renderTabulka(a.data),updateStrankovani(a.data)):e.innerHTML='<div class="empty-state">Chyba načítání dat</div>'}catch(e){console.error("Chyba načítání zakázek:",e),document.getElementById("table-container").innerHTML='<div class="empty-state">Chyba načítání dat</div>'}}function renderTabulka(e){const t=document.getElementById("table-container"),n=document.getElementById("table-count");if(!e.zakazky||0===e.zakazky.length)return t.innerHTML='<div class="empty-state"><div class="empty-state-icon"></div>Žádné zakázky podle filtrů</div>',void(n.textContent="0 zakázek");n.textContent=`${e.total_count} zakázek`;let a="";e.zakazky.forEach(e=>{a+=`\n            <tr>\n                <td>${e.cislo_reklamace||"-"}</td>\n                <td>${e.adresa||"-"}</td>\n                <td>${e.model||"-"}</td>\n                <td>${e.technik}</td>\n                <td>${e.prodejce}</td>\n                <td>${parseFloat(e.castka_celkem).toFixed(2)} €</td>\n                <td>${parseFloat(e.vydelek_technika).toFixed(2)} €</td>\n                <td>${e.zeme}</td>\n                <td>${e.datum}</td>\n            </tr>\n        `}),t.innerHTML=`\n        <table class="stats-table">\n            <thead>\n                <tr>\n                    <th>Reklamace ID</th>\n                    <th>Adresa</th>\n                    <th>Model</th>\n                    <th>Technik</th>\n                    <th>Prodejce</th>\n                    <th>Částka celkem</th>\n                    <th>Výdělek technika (33%)</th>\n                    <th>Země</th>\n                    <th>Datum</th>\n                </tr>\n            </thead>\n            <tbody>\n                ${a}\n            </tbody>\n        </table>\n    `}function updateStrankovani(e){const t=document.getElementById("pagination"),n=document.getElementById("page-info"),a=document.getElementById("prev-page"),i=document.getElementById("next-page");e.celkem_stranek<=1?t.style.display="none":(t.style.display="flex",n.textContent=`Strana ${e.stranka} z ${e.celkem_stranek}`,a.disabled=1===e.stranka,i.disabled=e.stranka>=e.celkem_stranek)}function predchoziStranka(){aktualniStranka>1&&(aktualniStranka--,nactiZakazky())}function dalsiStranka(){aktualniStranka++,nactiZakazky()}async function nactiCharty(){try{const e=getFilterParams(),t=await fetch(`/api/statistiky_api.php?action=get_charts&${e}`),n=await t.json();"success"===n.status&&renderCharty(n.data)}catch(e){console.error("Chyba načítání grafů:",e)}}function renderCharty(e){const t=document.getElementById("chart-models");if(e.modely&&e.modely.length>0){let n="";e.modely.forEach(e=>{n+=`\n                <div class="chart-item">\n                    <div class="chart-item-label">${e.model}</div>\n                    <div class="chart-item-value">${e.pocet} ks</div>\n                </div>\n            `}),t.innerHTML=n}else t.innerHTML='<div class="empty-state">Žádná data</div>';const n=document.getElementById("chart-cities");if(e.mesta&&e.mesta.length>0){let t="";e.mesta.forEach(e=>{t+=`\n                <div class="chart-item">\n                    <div class="chart-item-label">${e.mesto}</div>\n                    <div class="chart-item-value">${e.pocet} ks</div>\n                </div>\n            `}),n.innerHTML=t}else n.innerHTML='<div class="empty-state">Žádná data</div>';const a=document.getElementById("chart-salespersons");if(e.prodejci&&e.prodejci.length>0){let t="";e.prodejci.forEach(e=>{t+=`\n                <div class="chart-item">\n                    <div class="chart-item-label">${e.prodejce} (${e.pocet} ks)</div>\n                    <div class="chart-item-value">${parseFloat(e.celkem).toFixed(2)} €</div>\n                </div>\n            `}),a.innerHTML=t}else a.innerHTML='<div class="empty-state">Žádná data</div>';const i=document.getElementById("chart-technicians");if(e.technici&&e.technici.length>0){let t="";e.technici.forEach(e=>{t+=`\n                <div class="chart-item">\n                    <div class="chart-item-label">${e.technik} (${e.pocet} ks)</div>\n                    <div class="chart-item-value">${parseFloat(e.vydelek).toFixed(2)} €</div>\n                </div>\n            `}),i.innerHTML=t}else i.innerHTML='<div class="empty-state">Žádná data</div>'}function aplikovatFiltry(){console.log("Aplikuji filtry..."),aktualniStranka=1,nactiSummary(),nactiZakazky(),nactiCharty()}function resetovitFiltry(){console.log("Resetuji filtry..."),document.getElementById("filter-year").value="2025",document.getElementById("filter-month").value="11",document.querySelectorAll('#prodejci-dropdown input[type="checkbox"]').forEach(e=>{e.checked=!1}),vybraneProdejci=[],document.getElementById("prodejci-label").textContent="Všichni",document.querySelectorAll('#technici-dropdown input[type="checkbox"]').forEach(e=>{e.checked=!1}),vybraneTechnici=[],document.getElementById("technici-label").textContent="Všichni",document.querySelectorAll('#zeme-dropdown input[type="checkbox"]').forEach(e=>{e.checked=!0}),vybraneZeme=["cz","sk"],document.getElementById("zeme-label").textContent="Všechny",aktualniStranka=1,aplikovatFiltry()}async function exportovatPDF(){try{console.log("[Doc] Exportuji PDF...");const e=getFilterParams(),t=await fetch(`/api/statistiky_api.php?action=get_zakazky&${e}&pro_export=1`),n=await t.json();if("success"!==n.status||!n.data.zakazky)return void alert("Chyba při načítání dat pro export");const a=n.data.zakazky;if(0===a.length)return void alert("Žádná data k exportu podle filtrů");const i=document.getElementById("filter-year").value||"Všechny",o=document.getElementById("filter-month").value,d=o?["","Leden","Únor","Březen","Duben","Květen","Červen","Červenec","Srpen","Září","Říjen","Listopad","Prosinec"][parseInt(o)]:"Všechny",c=(new Date).toLocaleDateString("cs-CZ"),l=document.getElementById("zobrazitOdmenu").checked,r=a.reduce((e,t)=>e+parseFloat(t.castka_celkem),0),s=a.reduce((e,t)=>e+parseFloat(t.vydelek_technika),0),p=Math.max(1,Math.ceil(a.length/25)),h=1===p?"stránky":"stránek",m=document.createElement("div");m.style.cssText="position: absolute; left: -9999px; width: 1200px; height: 800px; background: white; padding: 30px; font-family: Poppins, Arial, sans-serif;",m.innerHTML=`\n            <div style="margin-bottom: 15px;">\n                <h1 style="color: #333; font-size: 18px; margin: 0 0 8px 0; font-weight: 700;">Statistiky a reporty - WGS</h1>\n                <p style="color: #666; font-size: 11px; margin: 0;">Rok: ${i} | Měsíc: ${d} | Celkem: ${a.length} zakázek</p>\n            </div>\n            <table style="width: 100%; border-collapse: collapse; font-size: 9px;">\n                <thead>\n                    <tr style="background: #f0f0f0; color: #333;">\n                        <th style="padding: 5px; text-align: left; border: 1px solid #999;">Reklamace ID</th>\n                        <th style="padding: 5px; text-align: left; border: 1px solid #999;">Adresa</th>\n                        <th style="padding: 5px; text-align: left; border: 1px solid #999;">Model</th>\n                        <th style="padding: 5px; text-align: left; border: 1px solid #999;">Technik</th>\n                        <th style="padding: 5px; text-align: left; border: 1px solid #999;">Prodejce</th>\n                        <th style="padding: 5px; text-align: right; border: 1px solid #999;">Částka</th>\n                        ${l?'<th style="padding: 5px; text-align: right; border: 1px solid #999;">Výdělek (33%)</th>':""}\n                        <th style="padding: 5px; text-align: center; border: 1px solid #999;">Země</th>\n                        <th style="padding: 5px; text-align: center; border: 1px solid #999;">Datum</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${a.map((e,t)=>`\n                        <tr style="background: ${t%2==0?"#fff":"#f5f5f5"};">\n                            <td style="padding: 4px; border: 1px solid #ddd;">${e.cislo_reklamace||"-"}</td>\n                            <td style="padding: 4px; border: 1px solid #ddd;">${e.adresa||"-"}</td>\n                            <td style="padding: 4px; border: 1px solid #ddd;">${e.model||"-"}</td>\n                            <td style="padding: 4px; border: 1px solid #ddd;">${e.technik||"-"}</td>\n                            <td style="padding: 4px; border: 1px solid #ddd;">${e.prodejce||"-"}</td>\n                            <td style="padding: 4px; border: 1px solid #ddd; text-align: right;">${parseFloat(e.castka_celkem).toFixed(2)} €</td>\n                            ${l?`<td style="padding: 4px; border: 1px solid #ddd; text-align: right;">${parseFloat(e.vydelek_technika).toFixed(2)} €</td>`:""}\n                            <td style="padding: 4px; border: 1px solid #ddd; text-align: center;">${e.zeme||"-"}</td>\n                            <td style="padding: 4px; border: 1px solid #ddd; text-align: center;">${e.datum||"-"}</td>\n                        </tr>\n                    `).join("")}\n                </tbody>\n            </table>\n            <div style="position: absolute; bottom: 100px; left: 30px;">\n                <div style="font-size: 10px; color: #333;">\n                    Výpis se skládá z ${p} ${h}\n                </div>\n            </div>\n            <div style="position: absolute; bottom: 100px; right: 30px; text-align: right;">\n                <div style="background: #f0f0f0; border: 1px solid #999; padding: 8px 16px; margin-bottom: 8px; font-size: 18px; display: inline-block;">\n                    Počet zakázek celkem: <span style="color: #333; font-weight: bold;">${a.length} ks</span>\n                </div><br>\n                <div style="background: #f0f0f0; border: 1px solid #999; padding: 8px 16px; margin-bottom: 8px; font-size: 18px; display: inline-block;">\n                    Celkem za zakázky k fakturaci: <span style="color: #333; font-weight: bold;">${r.toFixed(2)} €</span>\n                </div><br>\n                ${l?`\n                    <div style="background: #f0f0f0; border: 1px solid #999; padding: 8px 16px; font-size: 18px; display: inline-block;">\n                        Výdělek celkem technik: <span style="color: #333; font-weight: bold;">${s.toFixed(2)} €</span>\n                    </div><br>\n                `:""}\n            </div>\n            <div style="position: absolute; bottom: 30px; left: 30px; right: 30px; padding-top: 15px; border-top: 1px solid #ddd;">\n                <div style="font-size: 10px; color: #999; margin-bottom: 5px;">\n                    Vygenerováno: ${c}\n                </div>\n                <div style="font-size: 9px; color: #aaa; font-style: italic;">\n                    Report byl vytvořen pomocí systému WGS (White Glove Service) – Nástroj pro správu servisních zakázek Natuzzi\n                </div>\n            </div>\n        `,document.body.appendChild(m),console.log("[Photo] Renderuji HTML pomocí html2canvas...");const y=await html2canvas(m,{scale:2,backgroundColor:"#fff",useCORS:!0,logging:!1});document.body.removeChild(m);const{jsPDF:u}=window.jspdf,g=new u("l","mm","a4"),k=y.toDataURL("image/jpeg",.95),v=g.internal.pageSize.width,x=g.internal.pageSize.height,b=10,f=v-2*b,z=x-2*b,E=y.height/y.width;let $=f,w=$*E;const j=y.width*(z/$),S=Math.ceil(y.height/j);if(w<=z)g.addImage(k,"JPEG",b,b,$,w),g.setFontSize(9),g.setTextColor(100,100,100),g.text("1/1",b,8);else{let e=0,t=1;for(;e<y.height;){e>0&&g.addPage();const n=document.createElement("canvas");n.width=y.width,n.height=Math.min(j,y.height-e);n.getContext("2d").drawImage(y,0,e,y.width,n.height,0,0,y.width,n.height);const a=n.toDataURL("image/jpeg",.95),i=n.height/y.width*$;g.addImage(a,"JPEG",b,b,$,i),g.setFontSize(9),g.setTextColor(100,100,100),g.text(`${t}/${S}`,b,8),t++,e+=j}}const C=`statistiky_${i}_${o||"vsechny"}_${(new Date).toISOString().split("T")[0]}.pdf`;g.save(C),console.log("PDF exportováno:",C)}catch(e){console.error("Chyba exportu PDF:",e),alert("Chyba při exportu PDF: "+e.message)}}console.log("[Statistiky] 2.0 - načítání..."),document.addEventListener("DOMContentLoaded",()=>{console.log("[Statistiky] 2.0 - inicializace"),inicializujMultiselect(),nactiProdejce(),nactiTechniky(),nactiSummary(),nactiZakazky(),nactiCharty(),document.getElementById("filter-year").addEventListener("change",()=>{aktualniStranka=1,aplikovatFiltry()}),document.getElementById("filter-month").addEventListener("change",()=>{aktualniStranka=1,aplikovatFiltry()}),console.log("[Statistiky] 2.0 - inicializace dokončena")});