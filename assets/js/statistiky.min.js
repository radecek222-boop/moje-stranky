let aktualniStranka=1,vybraneProdejci=[],vybraneTechnici=[],vybraneZeme=["cz","sk"];function inicializujMultiselect(){const e=document.getElementById("prodejci-trigger");e&&e.addEventListener("click",e=>{e.stopPropagation(),toggleDropdown("prodejci")});const t=document.getElementById("technici-trigger");t&&t.addEventListener("click",e=>{e.stopPropagation(),toggleDropdown("technici")});const n=document.getElementById("zeme-trigger");n&&n.addEventListener("click",e=>{e.stopPropagation(),toggleDropdown("zeme")}),document.addEventListener("click",e=>{e.target.closest(".filter-multiselect")||document.querySelectorAll(".multiselect-dropdown").forEach(e=>{e.classList.remove("active")})});const a=document.getElementById("zobrazitMimozarucni");a&&a.addEventListener("change",()=>{aktualniStranka=1,aplikovatFiltry()});const i=document.getElementById("zobrazitPouzeDokoncene");i&&i.addEventListener("change",()=>{aktualniStranka=1,aplikovatFiltry()}),document.querySelectorAll('#zeme-dropdown input[type="checkbox"]').forEach(e=>{e.addEventListener("change",()=>{updateVyberZeme()})})}function toggleDropdown(e){const t=document.getElementById(`${e}-dropdown`),n=document.getElementById(`${e}-trigger`),a=document.querySelectorAll(".multiselect-dropdown"),i=document.querySelectorAll(".multiselect-trigger");a.forEach((e,n)=>{e!==t&&e.classList.remove("active")}),i.forEach(e=>{e!==n&&e.setAttribute("aria-expanded","false")});const o=t.classList.toggle("active");n.setAttribute("aria-expanded",o?"true":"false")}async function nactiProdejce(){try{const e=await fetch("/api/statistiky_api.php?action=load_prodejci"),t=await e.json();if("success"===t.status){const e=document.getElementById("prodejci-dropdown");e.innerHTML="",t.data.forEach(t=>{const n=document.createElement("div");n.className="multiselect-option",n.innerHTML=`\n                    <input type="checkbox" id="prodejce-${t.id}" value="${t.id}">\n                    <label for="prodejce-${t.id}">${t.name}</label>\n                `,n.querySelector("input").addEventListener("change",()=>{updateVyberProdejci()}),e.appendChild(n)})}}catch(e){console.error("Chyba načítání prodejců:",e)}}async function nactiTechniky(){try{const e=await fetch("/api/statistiky_api.php?action=load_technici"),t=await e.json();if("success"===t.status){const e=document.getElementById("technici-dropdown");e.innerHTML="",t.data.forEach(t=>{const n=document.createElement("div");n.className="multiselect-option",n.innerHTML=`\n                    <input type="checkbox" id="technik-${t.id}" value="${t.id}">\n                    <label for="technik-${t.id}">${t.name}</label>\n                `,n.querySelector("input").addEventListener("change",()=>{updateVyberTechnici()}),e.appendChild(n)})}}catch(e){console.error("Chyba načítání techniků:",e)}}function updateVyberProdejci(){const e=document.querySelectorAll('#prodejci-dropdown input[type="checkbox"]:checked');vybraneProdejci=Array.from(e).map(e=>e.value);const t=document.getElementById("prodejci-label");if(0===vybraneProdejci.length)t.textContent="Všichni";else if(1===vybraneProdejci.length){const e=document.querySelector(`#prodejci-dropdown input[value="${vybraneProdejci[0]}"]`).nextElementSibling;t.textContent=e.textContent}else t.textContent=`Vybráno (${vybraneProdejci.length})`;aktualniStranka=1,aplikovatFiltry()}function updateVyberTechnici(){const e=document.querySelectorAll('#technici-dropdown input[type="checkbox"]:checked');vybraneTechnici=Array.from(e).map(e=>e.value);const t=document.getElementById("technici-label");if(0===vybraneTechnici.length)t.textContent="Všichni";else if(1===vybraneTechnici.length){const e=document.querySelector(`#technici-dropdown input[value="${vybraneTechnici[0]}"]`).nextElementSibling;t.textContent=e.textContent}else t.textContent=`Vybráno (${vybraneTechnici.length})`;aktualniStranka=1,aplikovatFiltry()}function updateVyberZeme(){const e=document.querySelectorAll('#zeme-dropdown input[type="checkbox"]:checked');vybraneZeme=Array.from(e).map(e=>e.value);const t=document.getElementById("zeme-label");if(0===vybraneZeme.length)t.textContent="Žádná";else if(2===vybraneZeme.length)t.textContent="Všechny";else{const e=document.querySelector(`#zeme-dropdown input[value="${vybraneZeme[0]}"]`).nextElementSibling;t.textContent=e.textContent}aktualniStranka=1,aplikovatFiltry()}function getFilterParams(){const e=new URLSearchParams,t=document.getElementById("filter-year").value,n=document.getElementById("filter-month").value;t&&e.append("rok",t),n&&e.append("mesic",n),vybraneProdejci.forEach(t=>e.append("prodejci[]",t)),vybraneTechnici.forEach(t=>e.append("technici[]",t)),vybraneZeme.forEach(t=>e.append("zeme[]",t));const a=document.getElementById("zobrazitMimozarucni");a&&a.checked&&e.append("zobrazit_mimozarucni","1");const i=document.getElementById("zobrazitPouzeDokoncene");return i&&i.checked&&e.append("pouze_dokoncene","1"),e.toString()}async function nactiSummary(){try{const e=getFilterParams(),t=await fetch(`/api/statistiky_api.php?action=summary&${e}`),n=await t.json();"success"===n.status&&(document.getElementById("total-all").textContent=n.data.total_all,document.getElementById("total-month").textContent=n.data.total_month,document.getElementById("revenue-all").textContent=n.data.revenue_all.toFixed(2)+" €",document.getElementById("revenue-month").textContent=n.data.revenue_month.toFixed(2)+" €")}catch(e){console.error("Chyba načítání summary:",e)}}async function nactiZakazky(){try{const e=document.getElementById("table-container");e.innerHTML='<div class="loading">Načítání zakázek...</div>';const t=getFilterParams(),n=await fetch(`/api/statistiky_api.php?action=get_zakazky&${t}&stranka=${aktualniStranka}`),a=await n.json();"success"===a.status?(renderTabulka(a.data),updateStrankovani(a.data)):e.innerHTML='<div class="empty-state">Chyba načítání dat</div>'}catch(e){console.error("Chyba načítání zakázek:",e),document.getElementById("table-container").innerHTML='<div class="empty-state">Chyba načítání dat</div>'}}function renderTabulka(e){const t=document.getElementById("table-container"),n=document.getElementById("table-count");if(!e.zakazky||0===e.zakazky.length)return t.innerHTML='<div class="empty-state"><div class="empty-state-icon"></div>Žádné zakázky podle filtrů</div>',void(n.textContent="0 zakázek");n.textContent=`${e.total_count} zakázek`;let a="";e.zakazky.forEach(e=>{a+=`\n            <tr>\n                <td>${e.cislo_reklamace||"-"}</td>\n                <td>${e.jmeno_zakaznika||"-"}</td>\n                <td>${e.adresa||"-"}</td>\n                <td>${e.model||"-"}</td>\n                <td>${e.technik}</td>\n                <td>${e.prodejce}</td>\n                <td>${parseFloat(e.castka_celkem).toFixed(2)} €</td>\n                <td>${parseFloat(e.vydelek_technika).toFixed(2)} €</td>\n                <td>${e.zeme}</td>\n                <td>${e.datum}</td>\n            </tr>\n        `}),t.innerHTML=`\n        <table class="stats-table">\n            <thead>\n                <tr>\n                    <th>ID</th>\n                    <th>Jméno</th>\n                    <th>Adresa</th>\n                    <th>Model</th>\n                    <th>Technik</th>\n                    <th>Prodejce</th>\n                    <th>Částka</th>\n                    <th>Výdělek</th>\n                    <th>Země</th>\n                    <th>Datum</th>\n                </tr>\n            </thead>\n            <tbody>\n                ${a}\n            </tbody>\n        </table>\n    `}function updateStrankovani(e){const t=document.getElementById("pagination"),n=document.getElementById("page-info"),a=document.getElementById("prev-page"),i=document.getElementById("next-page");e.celkem_stranek<=1?t.classList.add("hidden"):(t.classList.remove("hidden"),n.textContent=`Strana ${e.stranka} z ${e.celkem_stranek}`,a.disabled=1===e.stranka,i.disabled=e.stranka>=e.celkem_stranek)}function predchoziStranka(){aktualniStranka>1&&(aktualniStranka--,nactiZakazky())}function dalsiStranka(){aktualniStranka++,nactiZakazky()}async function nactiCharty(){try{const e=getFilterParams(),t=await fetch(`/api/statistiky_api.php?action=get_charts&${e}`),n=await t.json();"success"===n.status&&renderCharty(n.data)}catch(e){console.error("Chyba načítání grafů:",e)}}function renderCharty(e){const t=document.getElementById("chart-models");if(e.modely&&e.modely.length>0){let n="";e.modely.forEach(e=>{n+=`\n                <div class="chart-item">\n                    <div class="chart-item-label">${e.model}</div>\n                    <div class="chart-item-value">${e.pocet} ks</div>\n                </div>\n            `}),t.innerHTML=n}else t.innerHTML='<div class="empty-state">Žádná data</div>';const n=document.getElementById("chart-cities");if(e.mesta&&e.mesta.length>0){let t="";e.mesta.forEach(e=>{t+=`\n                <div class="chart-item">\n                    <div class="chart-item-label">${e.mesto}</div>\n                    <div class="chart-item-value">${e.pocet} ks</div>\n                </div>\n            `}),n.innerHTML=t}else n.innerHTML='<div class="empty-state">Žádná data</div>';const a=document.getElementById("chart-salespersons");if(e.prodejci&&e.prodejci.length>0){let t="";e.prodejci.forEach(e=>{t+=`\n                <div class="chart-item">\n                    <div class="chart-item-label">${e.prodejce} (${e.pocet} ks)</div>\n                    <div class="chart-item-value">${parseFloat(e.celkem).toFixed(2)} €</div>\n                </div>\n            `}),a.innerHTML=t}else a.innerHTML='<div class="empty-state">Žádná data</div>';const i=document.getElementById("chart-technicians");if(e.technici&&e.technici.length>0){let t="";e.technici.forEach(e=>{t+=`\n                <div class="chart-item">\n                    <div class="chart-item-label">${e.technik} (${e.pocet} ks)</div>\n                    <div class="chart-item-value">${parseFloat(e.vydelek).toFixed(2)} €</div>\n                </div>\n            `}),i.innerHTML=t}else i.innerHTML='<div class="empty-state">Žádná data</div>'}function aplikovatFiltry(){aktualniStranka=1,nactiSummary(),nactiZakazky(),nactiCharty()}function resetovitFiltry(){document.getElementById("filter-year").value="",document.getElementById("filter-month").value="",document.querySelectorAll('#prodejci-dropdown input[type="checkbox"]').forEach(e=>{e.checked=!1}),vybraneProdejci=[],document.getElementById("prodejci-label").textContent="Všichni",document.querySelectorAll('#technici-dropdown input[type="checkbox"]').forEach(e=>{e.checked=!1}),vybraneTechnici=[],document.getElementById("technici-label").textContent="Všichni",document.querySelectorAll('#zeme-dropdown input[type="checkbox"]').forEach(e=>{e.checked=!0}),vybraneZeme=["cz","sk"],document.getElementById("zeme-label").textContent="Všechny";const e=document.getElementById("zobrazitMimozarucni");e&&(e.checked=!0),aktualniStranka=1,aplikovatFiltry()}async function exportovatPDF(){try{const e=getFilterParams(),t=await fetch(`/api/statistiky_api.php?action=get_zakazky&${e}&pro_export=1`),n=await t.json();if("success"!==n.status||!n.data.zakazky)return void wgsToast.error("Chyba při načítání dat pro export");const a=n.data.zakazky;if(0===a.length)return void wgsToast.warning("Žádná data k exportu podle filtrů");const i=document.getElementById("filter-year").value||"Všechny",o=document.getElementById("filter-month").value,d=o?["","Leden","Únor","Březen","Duben","Květen","Červen","Červenec","Srpen","Září","Říjen","Listopad","Prosinec"][parseInt(o)]:"Všechny",r=(new Date).toLocaleDateString("cs-CZ"),c=document.getElementById("zobrazitOdmenu").checked,l=a.reduce((e,t)=>e+parseFloat(t.castka_celkem),0),s=a.reduce((e,t)=>e+parseFloat(t.vydelek_technika),0),p=document.createElement("div");p.style.cssText="position: absolute; left: -9999px; width: 1200px; background: white; padding: 30px; font-family: Poppins, Arial, sans-serif;",p.innerHTML=`\n            <div style="margin-bottom: 15px;">\n                <h1 style="color: #333; font-size: 18px; margin: 0 0 8px 0; font-weight: 700;">Statistiky a reporty - WGS</h1>\n                <p style="color: #666; font-size: 11px; margin: 0;">Rok: ${i} | Měsíc: ${d} | Celkem: ${a.length} zakázek</p>\n            </div>\n            <table style="width: 100%; border-collapse: collapse; font-size: 8px;">\n                <thead>\n                    <tr style="background: #f0f0f0; color: #333;">\n                        <th style="padding: 4px; text-align: left; border: 1px solid #999; font-size: 7px;">ID</th>\n                        <th style="padding: 4px; text-align: left; border: 1px solid #999; font-size: 7px;">Jméno</th>\n                        <th style="padding: 4px; text-align: left; border: 1px solid #999; font-size: 7px;">Adresa</th>\n                        <th style="padding: 4px; text-align: left; border: 1px solid #999; font-size: 7px;">Model</th>\n                        <th style="padding: 4px; text-align: left; border: 1px solid #999; font-size: 7px;">Technik</th>\n                        <th style="padding: 4px; text-align: left; border: 1px solid #999; font-size: 7px;">Prodejce</th>\n                        <th style="padding: 4px; text-align: right; border: 1px solid #999; font-size: 7px;">Částka</th>\n                        ${c?'<th style="padding: 4px; text-align: right; border: 1px solid #999; font-size: 7px;">Výdělek</th>':""}\n                        <th style="padding: 4px; text-align: center; border: 1px solid #999; font-size: 7px;">Země</th>\n                        <th style="padding: 4px; text-align: center; border: 1px solid #999; font-size: 7px;">Datum</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${a.map((e,t)=>`\n                        <tr style="background: ${t%2==0?"#fff":"#f5f5f5"};">\n                            <td style="padding: 3px; border: 1px solid #ddd; font-size: 8px;">${e.cislo_reklamace||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; font-size: 8px;">${e.jmeno_zakaznika||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; font-size: 8px;">${e.adresa||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; font-size: 8px;">${e.model||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; font-size: 8px;">${e.technik||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; font-size: 8px;">${e.prodejce||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; text-align: right; font-size: 8px;">${parseFloat(e.castka_celkem).toFixed(2)} €</td>\n                            ${c?`<td style="padding: 3px; border: 1px solid #ddd; text-align: right; font-size: 8px;">${parseFloat(e.vydelek_technika).toFixed(2)} €</td>`:""}\n                            <td style="padding: 3px; border: 1px solid #ddd; text-align: center; font-size: 8px;">${e.zeme||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; text-align: center; font-size: 8px;">${e.datum||"-"}</td>\n                        </tr>\n                    `).join("")}\n                </tbody>\n            </table>\n\n            \x3c!-- SOUHRN - vždy za tabulkou s mezerou, nikdy se nepřepíše --\x3e\n            <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #333; text-align: right;">\n                <div style="background: #f0f0f0; border: 1px solid #999; padding: 8px 16px; margin-bottom: 8px; font-size: 14px; display: inline-block;">\n                    Počet zakázek celkem: <span style="color: #333; font-weight: bold;">${a.length} ks</span>\n                </div><br>\n                <div style="background: #f0f0f0; border: 1px solid #999; padding: 8px 16px; margin-bottom: 8px; font-size: 14px; display: inline-block;">\n                    Celkem za zakázky k fakturaci: <span style="color: #333; font-weight: bold;">${l.toFixed(2)} €</span>\n                </div><br>\n                ${c?`\n                    <div style="background: #f0f0f0; border: 1px solid #999; padding: 8px 16px; font-size: 14px; display: inline-block;">\n                        Výdělek celkem technik: <span style="color: #333; font-weight: bold;">${s.toFixed(2)} €</span>\n                    </div>\n                `:""}\n            </div>\n\n            \x3c!-- PATIČKA - vždy na úplném konci --\x3e\n            <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd;">\n                <div style="font-size: 10px; color: #999; margin-bottom: 5px;">\n                    Vygenerováno: ${r}\n                </div>\n                <div style="font-size: 9px; color: #aaa; font-style: italic;">\n                    Report byl vytvořen pomocí systému WGS (White Glove Service) – Nástroj pro správu servisních zakázek Natuzzi\n                </div>\n            </div>\n        `,document.body.appendChild(p);const m=await html2canvas(p,{scale:2,backgroundColor:"#fff",useCORS:!0,logging:!1});document.body.removeChild(p);const{jsPDF:h}=window.jspdf,y=new h("l","mm","a4"),u=m.toDataURL("image/jpeg",.95),k=y.internal.pageSize.width,g=y.internal.pageSize.height,v=10,x=k-2*v,f=g-2*v,b=m.height/m.width;let z=x,E=z*b;const w=m.width*(f/z),S=Math.ceil(m.height/w);if(E<=f)y.addImage(u,"JPEG",v,v,z,E),y.setFontSize(9),y.setTextColor(100,100,100),y.text("1/1",v,8);else{let e=0,t=1;for(;e<m.height;){e>0&&y.addPage();const n=document.createElement("canvas");n.width=m.width,n.height=Math.min(w,m.height-e);n.getContext("2d").drawImage(m,0,e,m.width,n.height,0,0,m.width,n.height);const a=n.toDataURL("image/jpeg",.95),i=n.height/m.width*z;y.addImage(a,"JPEG",v,v,z,i),y.setFontSize(9),y.setTextColor(100,100,100),y.text(`${t}/${S}`,v,8),t++,e+=w}}const $=`statistiky_${i}_${o||"vsechny"}_${(new Date).toISOString().split("T")[0]}.pdf`;y.save($)}catch(e){console.error("Chyba exportu PDF:",e),wgsToast.error("Chyba při exportu PDF: "+e.message)}}document.addEventListener("DOMContentLoaded",()=>{inicializujMultiselect(),nactiProdejce(),nactiTechniky(),nactiSummary(),nactiZakazky(),nactiCharty();const e=document.getElementById("filter-year"),t=document.getElementById("filter-month");e&&e.addEventListener("change",()=>{aktualniStranka=1,aplikovatFiltry()}),t&&t.addEventListener("change",()=>{aktualniStranka=1,aplikovatFiltry()});const n=document.querySelector('[data-action="resetovitFiltry"]'),a=document.querySelector('[data-action="exportovatPDF"]'),i=document.querySelector('[data-action="predchoziStranka"]'),o=document.querySelector('[data-action="dalsiStranka"]');n&&n.addEventListener("click",e=>{e.preventDefault(),resetovitFiltry()}),a&&a.addEventListener("click",e=>{e.preventDefault(),exportovatPDF()}),i&&i.addEventListener("click",e=>{e.preventDefault(),predchoziStranka()}),o&&o.addEventListener("click",e=>{e.preventDefault(),dalsiStranka()})}),window.aplikovatFiltry=aplikovatFiltry,window.resetovitFiltry=resetovitFiltry,window.exportovatPDF=exportovatPDF,window.predchoziStranka=predchoziStranka,window.dalsiStranka=dalsiStranka,void 0!==window.Utils&&window.Utils.registerAction&&(window.Utils.registerAction("aplikovatFiltry",()=>{aplikovatFiltry()}),window.Utils.registerAction("resetovitFiltry",()=>{resetovitFiltry()}),window.Utils.registerAction("exportovatPDF",()=>{exportovatPDF()}),window.Utils.registerAction("predchoziStranka",()=>{predchoziStranka()}),window.Utils.registerAction("dalsiStranka",()=>{dalsiStranka()}));