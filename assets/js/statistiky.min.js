// üîí BEZPEƒåNOSTN√ç KONTROLA - P≈òESUNUTA DO checkAuth() funkce n√≠≈æe
// POZN√ÅMKA: IIFE bylo odstranƒõno, proto≈æe zp≈Øsobovalo okam≈æit√© p≈ôesmƒõrov√°n√≠ p≈ôed naƒçten√≠m str√°nky
// Auth check nyn√≠ prob√≠h√° v checkAuth() po DOMContentLoaded// === MOBILE MENU ===function toggleMobileMenu(){const hamburger = document.getElementById('hamburger');const mobileMenu = document.getElementById('mobileMenu');const backdrop = document.getElementById('mobileMenuBackdrop');hamburger.classList.toggle('active');mobileMenu.classList.toggle('show');backdrop.classList.toggle('show');// Prevent body scroll when menu is open if (mobileMenu.classList.contains('show')){document.body.style.overflow = 'hidden'}else{document.body.style.overflow = ''}}function navigateTo(url){// Close mobile menu before navigation toggleMobileMenu();// Small delay for smooth transition setTimeout(() =>{window.location.href = url},300)}// === GLOBALS ===const WGS ={currentUser:null,users:[],claims:[],filters:{country:[],status:[],salesperson:[],technician:[],dateFrom:'',dateTo:''},filteredOrders:[],calendars:{},multiSelect:{country:{selected:[],items:[{id:'CZ',name:'ƒåesk√° republika'},{id:'SK',name:'Slovensko'}]},status:{selected:[],items:[{id:'ƒåEK√Å',name:'Nov√°'},{id:'DOMLUVEN√Å',name:'Domluven√°'},{id:'HOTOVO',name:'Hotovo'}]},salesperson:{selected:[],items:[]},technician:{selected:[],items:[]}}};const API_URL = 'api/admin_api_statistics.php';// === INIT ===window.addEventListener('DOMContentLoaded',() =>{checkAuth();initCalendars();loadUsers().then(() =>{initMultiSelect();loadClaims().then(() =>{loadStatistics()})})});// === AUTH ===async function checkAuth(){try{const response = await fetch('app/admin_session_check.php');if (response.ok){const result = await response.json();if (result.authenticated){WGS.currentUser ={id:'admin-session',name:'Admin',email:result.email || 'admin@wgs.cz',role:'admin'};document.getElementById('userName').textContent = WGS.currentUser.name;return}else{localStorage.removeItem('wgsCurrent');localStorage.removeItem('wgsAdminAuthenticated');window.location.href = 'login.php?redirect=statistiky.php';return}}}catch (err){logger.log('PHP session check not available, trying localStorage fallback')}const userId = localStorage.getItem('wgsCurrent');const authenticated = localStorage.getItem('wgsAdminAuthenticated');if (!userId || authenticated !== 'true'){window.location.href = 'login.php?redirect=statistiky.php';return}const users = JSON.parse(localStorage.getItem('wgsUsers') || '[]');WGS.currentUser = users.find(u =>u.id === userId);if (!WGS.currentUser || WGS.currentUser.role !== 'admin'){localStorage.removeItem('wgsCurrent');localStorage.removeItem('wgsAdminAuthenticated');window.location.href = 'login.php?redirect=statistiky.php';return}document.getElementById('userName').textContent = WGS.currentUser.name}function logout(){localStorage.removeItem('wgsCurrent');localStorage.removeItem('wgsAdminAuthenticated');window.location.href = 'login.php'}// === LOAD DATA ===async function loadUsers(){try{const response = await fetch('api/admin_api.php?action=list_users');if (response.ok){const result = await response.json();if (result.status === 'success'){WGS.users = result.data;return}}}catch (err){logger.log('API not available,using localStorage')}WGS.users = JSON.parse(localStorage.getItem('wgsUsers') || '[]')}async function loadClaims(){try{const response = await fetch(`${API_URL}?action=list_reklamace`);if (response.ok){const result = await response.json();if (result.status === 'success'){WGS.claims = result.data;return}}}catch (err){logger.log('Claims API not available')}try{const response = await fetch('app/load.php');if (response.ok){const json = await response.json();WGS.claims = (json.status === 'success' && json.data) ? json.data:(Array.isArray(json) ? json:[])}}catch (err){logger.log('Load.php not available');WGS.claims = []}}// === MULTI-SELECT ===function initMultiSelect(){WGS.multiSelect.salesperson.items = WGS.users .filter(u =>u.role === 'prodejce') .map(u =>({id:u.id || u.user_id,name:u.name}));WGS.multiSelect.technician.items = WGS.users .filter(u =>u.role === 'technik') .map(u =>({id:u.id || u.user_id,name:u.name}));updateMultiSelectDisplay('country');updateMultiSelectDisplay('status');updateMultiSelectDisplay('salesperson');updateMultiSelectDisplay('technician')}function openMultiSelect(type){const modal = document.getElementById(`modal-${type}`);if (!modal) return;renderMultiSelectList(type);modal.classList.add('show');setTimeout(() =>{const searchInput = document.getElementById(`search-${type}`);if (searchInput) searchInput.focus()},100)}function closeMultiSelect(type){const modal = document.getElementById(`modal-${type}`);if (modal) modal.classList.remove('show');updateMultiSelectDisplay(type)}function renderMultiSelectList(type){const listEl = document.getElementById(`list-${type}`);const searchInput = document.getElementById(`search-${type}`);if (!listEl) return;const searchTerm = searchInput ? searchInput.value.toLowerCase():'';const items = WGS.multiSelect[type].items.filter(item =>item.name.toLowerCase().includes(searchTerm) );if (items.length === 0){listEl.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--c-grey);">≈Ω√°dn√© v√Ωsledky</div>';return}listEl.innerHTML = items.map(item =>{const isSelected = WGS.multiSelect[type].selected.includes(item.id);return ` <div class="multi-select-item ${isSelected ? 'selected':''}" onclick="toggleMultiSelectItem('${type}','${item.id}')"><div class="multi-select-checkbox"></div><div class="multi-select-label">${item.name}</div></div>`}).join('');updateMultiSelectCount(type)}function toggleMultiSelectItem(type,itemId){const selected = WGS.multiSelect[type].selected;const index = selected.indexOf(itemId);if (index>-1){selected.splice(index,1)}else{selected.push(itemId)}renderMultiSelectList(type)}function clearMultiSelect(type){WGS.multiSelect[type].selected = [];renderMultiSelectList(type);updateMultiSelectDisplay(type)}function updateMultiSelectCount(type){const countEl = document.getElementById(`count-${type}`);if (countEl){const count = WGS.multiSelect[type].selected.length;countEl.textContent = `Vybr√°no:${count}`}}function updateMultiSelectDisplay(type){const displayEl = document.getElementById(`display-${type}`);if (!displayEl) return;const selected = WGS.multiSelect[type].selected;const items = WGS.multiSelect[type].items;const placeholders ={country:'Vyberte zemƒõ...',status:'Vyberte stavy...',salesperson:'Vyberte prodejce...',technician:'Vyberte techniky...'};if (selected.length === 0){displayEl.className = 'multi-select-display empty';displayEl.innerHTML = placeholders[type] || 'Vyberte...'}else{displayEl.className = 'multi-select-display';const tags = selected.map(id =>{const item = items.find(i =>i.id === id);if (!item) return '';return ` <span class="multi-select-tag">${item.name}<span class="multi-select-tag-remove" onclick="event.stopPropagation();removeMultiSelectTag('${type}','${id}')">√ó</span></span>`}).join('');displayEl.innerHTML = `<div class="multi-select-tags">${tags}</div>`}}function removeMultiSelectTag(type,itemId){const selected = WGS.multiSelect[type].selected;const index = selected.indexOf(itemId);if (index>-1){selected.splice(index,1)}updateMultiSelectDisplay(type)}function filterMultiSelect(type){renderMultiSelectList(type)}document.addEventListener('click',(e) =>{if (e.target.classList.contains('multi-select-modal')){e.target.classList.remove('show')}});// === CALENDARS ===function initCalendars(){WGS.calendars ={'filter-date-from':{currentDate:new Date(),selectedDate:null},'filter-date-to':{currentDate:new Date(),selectedDate:null}};const dateInputs = ['filter-date-from','filter-date-to'];dateInputs.forEach(inputId =>{const inputEl = document.getElementById(inputId);const calendarId = 'calendar-'+inputId.replace('filter-','');const calendarEl = document.getElementById(calendarId);if (!inputEl || !calendarEl) return;inputEl.addEventListener('click',(e) =>{e.stopPropagation();toggleCalendar(inputId,calendarId)});document.addEventListener('click',(e) =>{if (!inputEl.contains(e.target) && !calendarEl.contains(e.target)){calendarEl.classList.remove('show')}});renderCalendar(inputId,calendarId)})}function toggleCalendar(inputId,calendarId){const calendarEl = document.getElementById(calendarId);const isOpen = calendarEl.classList.contains('show');document.querySelectorAll('.custom-calendar').forEach(cal =>{cal.classList.remove('show')});if (!isOpen){calendarEl.classList.add('show');renderCalendar(inputId,calendarId)}}function renderCalendar(inputId,calendarId){const cal = WGS.calendars[inputId];if (!cal) return;const year = cal.currentDate.getFullYear();const month = cal.currentDate.getMonth();const monthNames = ['Leden','√önor','B≈ôezen','Duben','Kvƒõten','ƒåerven','ƒåervenec','Srpen','Z√°≈ô√≠','≈ò√≠jen','Listopad','Prosinec'];const weekDays = ['Po','√öt','St','ƒåt','P√°','So','Ne'];const header = ` <div class="calendar-header"><button type="button" onclick="event.stopPropagation();prevMonth('${inputId}','${calendarId}')">‚Äπ</button><div class="calendar-month-year">${monthNames[month]}${year}</div><button type="button" onclick="event.stopPropagation();nextMonth('${inputId}','${calendarId}')">‚Ä∫</button></div>`;const weekdaysHtml = weekDays.map(day =>`<div class="calendar-weekday">${day}</div>` ).join('');const firstDay = new Date(year,month,1);const lastDay = new Date(year,month+1,0);const prevLastDay = new Date(year,month,0);let firstDayOfWeek = firstDay.getDay();firstDayOfWeek = firstDayOfWeek === 0 ? 7:firstDayOfWeek;let daysHtml = '';for (let i = firstDayOfWeek - 1;i>0;i--){const day = prevLastDay.getDate() - i+1;daysHtml+= `<div class="calendar-day other-month">${day}</div>`}const today = new Date();for (let day = 1;day <= lastDay.getDate();day++){const date = new Date(year,month,day);const isToday = date.toDateString() === today.toDateString();const isSelected = cal.selectedDate && date.toDateString() === cal.selectedDate.toDateString();const classes = ['calendar-day'];if (isToday) classes.push('today');if (isSelected) classes.push('selected');daysHtml+= `<div class="${classes.join(' ')}" onclick="selectDate('${inputId}','${calendarId}',${year},${month},${day})">${day}</div>`}const remainingDays = 42 - (firstDayOfWeek - 1+lastDay.getDate());for (let day = 1;day <= remainingDays;day++){daysHtml+= `<div class="calendar-day other-month">${day}</div>`}const calendarEl = document.getElementById(calendarId);if (calendarEl){calendarEl.innerHTML = ` ${header}<div class="calendar-weekdays">${weekdaysHtml}</div><div class="calendar-days">${daysHtml}</div>`}}function prevMonth(inputId,calendarId){const cal = WGS.calendars[inputId];if (!cal) return;cal.currentDate.setMonth(cal.currentDate.getMonth() - 1);renderCalendar(inputId,calendarId)}function nextMonth(inputId,calendarId){const cal = WGS.calendars[inputId];if (!cal) return;cal.currentDate.setMonth(cal.currentDate.getMonth()+1);renderCalendar(inputId,calendarId)}function selectDate(inputId,calendarId,year,month,day){const cal = WGS.calendars[inputId];if (!cal) return;cal.selectedDate = new Date(year,month,day);const formatted = `${String(day).padStart(2,'0')}.${String(month+1).padStart(2,'0')}.${year}`;const inputEl = document.getElementById(inputId);if (inputEl){inputEl.value = formatted}const calendarEl = document.getElementById(calendarId);if (calendarEl){calendarEl.classList.remove('show')}renderCalendar(inputId,calendarId)}// === FILTERS ===function resetFilters(){document.getElementById('filter-date-from').value = '';document.getElementById('filter-date-to').value = '';WGS.multiSelect.country.selected = [];WGS.multiSelect.status.selected = [];WGS.multiSelect.salesperson.selected = [];WGS.multiSelect.technician.selected = [];updateMultiSelectDisplay('country');updateMultiSelectDisplay('status');updateMultiSelectDisplay('salesperson');updateMultiSelectDisplay('technician');if (WGS.calendars){Object.keys(WGS.calendars).forEach(key =>{WGS.calendars[key].selectedDate = null})}WGS.filters ={country:[],status:[],salesperson:[],technician:[],dateFrom:'',dateTo:''};loadStatistics()}function applyFilters(){const convertCzDateToISO = (czDate) =>{if (!czDate) return '';const parts = czDate.split('.');if (parts.length !== 3) return '';return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`};const selectedSalesNames = WGS.multiSelect.salesperson.selected.map(id =>{const item = WGS.multiSelect.salesperson.items.find(i =>i.id === id);return item ? item.name:null}).filter(n =>n);const selectedTechNames = WGS.multiSelect.technician.selected.map(id =>{const item = WGS.multiSelect.technician.items.find(i =>i.id === id);return item ? item.name:null}).filter(n =>n);WGS.filters ={country:WGS.multiSelect.country.selected,status:WGS.multiSelect.status.selected,salesperson:selectedSalesNames,technician:selectedTechNames,dateFrom:convertCzDateToISO(document.getElementById('filter-date-from').value),dateTo:convertCzDateToISO(document.getElementById('filter-date-to').value)};loadStatistics()}// === STATISTICS ===function loadStatistics(){WGS.filteredOrders = WGS.claims.filter(order =>{if (WGS.filters.country.length>0 && !WGS.filters.country.includes(order.zeme)) return false;if (WGS.filters.status.length>0 && !WGS.filters.status.includes(order.stav)) return false;if (WGS.filters.salesperson.length>0 && !WGS.filters.salesperson.includes(order.prodejce)) return false;if (WGS.filters.technician.length>0 && !WGS.filters.technician.includes(order.technik)) return false;if (WGS.filters.dateFrom){const orderDate = order.datum || order.datum_reklamace || '';let orderDateISO = orderDate;if (orderDate.includes('.')){const parts = orderDate.split('.');if (parts.length === 3){orderDateISO = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`}}if (orderDateISO < WGS.filters.dateFrom) return false}if (WGS.filters.dateTo){const orderDate = order.datum || order.datum_reklamace || '';let orderDateISO = orderDate;if (orderDate.includes('.')){const parts = orderDate.split('.');if (parts.length === 3){orderDateISO = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`}}if (orderDateISO>WGS.filters.dateTo) return false}return true});updateSummaryStats();calculateSalesStats();calculateTechStats();calculateModelsStats();renderFilteredOrders();renderCharts()}function updateSummaryStats(){const totalOrders = WGS.filteredOrders.length;const totalRevenue = WGS.filteredOrders.reduce((sum,order) =>{const amount = parseFloat(order.castka || order.cena || 0);return sum+amount},0);const avgOrder = totalOrders>0 ? Math.round(totalRevenue / totalOrders):0;// Poƒç√≠tat techniky co maj√≠ zak√°zky s provizemi const uniqueTechs = new Set();WGS.filteredOrders.forEach(order =>{if (order.technik_milan_kolin>0) uniqueTechs.add("Milan Kol√≠n");if (order.technik_radek_zikmund>0) uniqueTechs.add("Radek Zikmund")});const activeTechs = uniqueTechs.size;document.getElementById('total-orders').textContent = totalOrders;document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);document.getElementById('avg-order').textContent = formatCurrency(avgOrder);document.getElementById('active-techs').textContent = activeTechs}function calculateSalesStats(){const salesStats ={};let totalCount = 0;let totalAmount = 0;WGS.filteredOrders.forEach(order =>{const salesperson = order.prodejce || 'Nezn√°m√Ω';const amount = parseFloat(order.castka || order.cena || 0);const country = order.zeme || 'N/A';const isDone = order.stav === 'HOTOVO';if (!salesStats[salesperson]){salesStats[salesperson] ={count:0,totalAmount:0,czCount:0,skCount:0,doneCount:0}}salesStats[salesperson].count++;salesStats[salesperson].totalAmount+= amount;if (country === 'CZ') salesStats[salesperson].czCount++;if (country === 'SK') salesStats[salesperson].skCount++;if (isDone) salesStats[salesperson].doneCount++;totalCount++;totalAmount+= amount});const tbody = document.getElementById('sales-stats-table');const tfoot = document.getElementById('sales-stats-footer');if (Object.keys(salesStats).length === 0){tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--c-grey);">≈Ω√°dn√° data</td></tr>';tfoot.innerHTML = '';return}tbody.innerHTML = Object.entries(salesStats) .sort((a,b) =>b[1].totalAmount - a[1].totalAmount) .map(([name,stats]) =>{const avgAmount = stats.count>0 ? Math.round(stats.totalAmount / stats.count):0;const donePercent = stats.count>0 ? Math.round((stats.doneCount / stats.count) * 100):0;return ` <tr><td><strong>${name}</strong></td><td>${stats.count}</td><td><strong>${formatCurrency(stats.totalAmount)}</strong></td><td>${formatCurrency(avgAmount)}</td><td>${stats.czCount}/ ${stats.skCount}</td><td>${donePercent}%</td></tr>`}).join('');const avgTotal = totalCount>0 ? Math.round(totalAmount / totalCount):0;tfoot.innerHTML = ` <tr><td><strong>CELKEM</strong></td><td>${totalCount}</td><td><strong>${formatCurrency(totalAmount)}</strong></td><td>${formatCurrency(avgTotal)}</td><td>-</td><td>100%</td></tr>`}function calculateTechStats(){const techStats ={};WGS.filteredOrders.forEach(order =>{const milanAmount = parseFloat(order.technik_milan_kolin || 0);const radekAmount = parseFloat(order.technik_radek_zikmund || 0);// Milan Kol√≠n if (milanAmount>0){if (!techStats["Milan Kol√≠n"]){techStats["Milan Kol√≠n"] ={count:0,amount:0,cz:0,sk:0,done:0}}techStats["Milan Kol√≠n"].count++;techStats["Milan Kol√≠n"].amount+= milanAmount;if (order.zeme === "CZ") techStats["Milan Kol√≠n"].cz++;if (order.zeme === "SK") techStats["Milan Kol√≠n"].sk++;if (order.stav === "HOTOVO") techStats["Milan Kol√≠n"].done++}// Radek Zikmund if (radekAmount>0){if (!techStats["Radek Zikmund"]){techStats["Radek Zikmund"] ={count:0,amount:0,cz:0,sk:0,done:0}}techStats["Radek Zikmund"].count++;techStats["Radek Zikmund"].amount+= radekAmount;if (order.zeme === "CZ") techStats["Radek Zikmund"].cz++;if (order.zeme === "SK") techStats["Radek Zikmund"].sk++;if (order.stav === "HOTOVO") techStats["Radek Zikmund"].done++}});WGS.techStats = Object.entries(techStats) .sort((a,b) =>b[1].amount - a[1].amount) .map(([name,stats]) =>({name,...stats}));renderTechStats()}function renderTechStats(){const tbody = document.querySelector("#tech-stats-table");if (!tbody) return;tbody.innerHTML = "";if (WGS.techStats.length === 0){tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;">≈Ω√°dn√° data</td></tr>`;return}let totalCount = 0;let totalAmount = 0;WGS.techStats.forEach(tech =>{totalCount+= tech.count;totalAmount+= tech.amount;const successRate = tech.count>0 ? Math.round((tech.done / tech.count) * 100):0;tbody.innerHTML+= ` <tr><td>${tech.name}</td><td>${tech.count}</td><td>${formatCurrency(tech.amount)}</td><td>${formatCurrency(tech.amount / tech.count)}</td><td>${tech.cz}/ ${tech.sk}</td><td>${successRate}%</td></tr>`});tbody.innerHTML+= ` <tr style="font-weight:bold;background:#f5f5f5;"><td>CELKEM</td><td>${totalCount}</td><td>${formatCurrency(totalAmount)}</td><td>${formatCurrency(totalAmount / totalCount)}</td><td>-</td><td>100%</td></tr>`}function calculateModelsStats(){const modelStats ={};let totalCount = 0;let totalAmount = 0;WGS.filteredOrders.forEach(order =>{const model = order.model || order.vyrobek || 'Nezn√°m√Ω';const amount = parseFloat(order.castka || order.cena || 0);if (!modelStats[model]){modelStats[model] ={count:0,totalAmount:0}}modelStats[model].count++;modelStats[model].totalAmount+= amount;totalCount++;totalAmount+= amount});const tbody = document.getElementById('models-stats-table');const tfoot = document.getElementById('models-stats-footer');if (Object.keys(modelStats).length === 0){tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--c-grey);">≈Ω√°dn√° data</td></tr>';tfoot.innerHTML = '';return}tbody.innerHTML = Object.entries(modelStats) .sort((a,b) =>b[1].count - a[1].count) .slice(0,20) .map(([name,stats]) =>{const percentage = totalCount>0 ? Math.round((stats.count / totalCount) * 100):0;const avgAmount = stats.count>0 ? Math.round(stats.totalAmount / stats.count):0;return ` <tr><td><strong>${name}</strong></td><td>${stats.count}</td><td>${percentage}%</td><td>${formatCurrency(avgAmount)}</td><td><strong>${formatCurrency(stats.totalAmount)}</strong></td></tr>`}).join('');const avgTotal = totalCount>0 ? Math.round(totalAmount / totalCount):0;tfoot.innerHTML = ` <tr><td><strong>CELKEM</strong></td><td>${totalCount}</td><td>100%</td><td>${formatCurrency(avgTotal)}</td><td><strong>${formatCurrency(totalAmount)}</strong></td></tr>`}function renderFilteredOrders(){const tbody = document.getElementById('filtered-orders-table');const tfoot = document.getElementById('filtered-orders-footer');if (WGS.filteredOrders.length === 0){tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--c-grey);">≈Ω√°dn√© zak√°zky</td></tr>';tfoot.innerHTML = '';return}let totalAmount = 0;tbody.innerHTML = WGS.filteredOrders .slice(0,50) .map(order =>{const amount = parseFloat(order.castka || order.cena || 0);totalAmount+= amount;return ` <tr><td style="font-family:'Courier New',monospace;">${order.reklamacniCislo || order.id}</td><td>${order.jmenoZakaznika || '-'}</td><td>${order.prodejce || '-'}</td><td>${order.technik || '-'}</td><td><strong>${formatCurrency(amount)}</strong></td><td><span class="badge badge-${getStatusClass(order.stav)}">${order.stav || 'N/A'}</span></td><td>${order.zeme || 'N/A'}</td><td style="font-size:0.85rem;color:var(--c-grey);">${formatDate(order.datum)}</td></tr>`}).join('');if (WGS.filteredOrders.length>50){tbody.innerHTML+= `<tr><td colspan="8" style="text-align:center;color:var(--c-grey);font-style:italic;">Zobrazeno 50 z ${WGS.filteredOrders.length}zak√°zek</td></tr>`}const fullTotalAmount = WGS.filteredOrders.reduce((sum,o) =>sum+parseFloat(o.castka || o.cena || 0),0);tfoot.innerHTML = ` <tr><td colspan="4"><strong>CELKEM</strong></td><td><strong>${formatCurrency(fullTotalAmount)}</strong></td><td colspan="3">${WGS.filteredOrders.length}zak√°zek</td></tr>`}function getStatusClass(status){const map ={'ƒåEK√Å':'prodejce','DOMLUVEN√Å':'technik','HOTOVO':'admin'};return map[status] || 'prodejce'}// === CHARTS ===function renderCharts(){renderCitiesChart();renderCountriesChart();renderModelsChart()}function renderCitiesChart(){const container = document.getElementById('chart-cities');if (!container) return;const cityStats ={};WGS.filteredOrders.forEach(order =>{let city = 'Nezn√°m√©';if (order.mesto){city = order.mesto}else if (order.adresa){const parts = order.adresa.split(',');if (parts.length>= 2){city = parts[1].trim()}}if (!cityStats[city]){cityStats[city] ={count:0,amount:0}}cityStats[city].count++;cityStats[city].amount+= parseFloat(order.castka || order.cena || 0)});const sortedCities = Object.entries(cityStats) .sort((a,b) =>b[1].count - a[1].count) .slice(0,10);if (sortedCities.length === 0){container.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--c-grey);">≈Ω√°dn√° data</div>';return}const total = WGS.filteredOrders.length;const maxCount = sortedCities[0][1].count;container.innerHTML = sortedCities.map(([city,stats]) =>{const percentage = Math.round((stats.count / total) * 100);const barWidth = (stats.count / maxCount) * 100;return ` <div class="chart-bar"><div class="chart-bar-label"><span class="chart-bar-name">${city}</span><span class="chart-bar-value">${stats.count}zak√°zek</span></div><div class="chart-bar-fill-container"><div class="chart-bar-fill" style="width:${barWidth}%"><span class="chart-bar-percentage">${percentage}%</span></div></div></div>`}).join('')}function renderCountriesChart(){const container = document.getElementById('chart-countries');if (!container) return;const countryStats ={};WGS.filteredOrders.forEach(order =>{const country = order.zeme || 'Nezn√°m√°';if (!countryStats[country]){countryStats[country] ={count:0,amount:0}}countryStats[country].count++;countryStats[country].amount+= parseFloat(order.castka || order.cena || 0)});const sortedCountries = Object.entries(countryStats) .sort((a,b) =>b[1].count - a[1].count);if (sortedCountries.length === 0){container.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--c-grey);">≈Ω√°dn√° data</div>';return}const total = WGS.filteredOrders.length;const totalAmount = sortedCountries.reduce((sum,[,stats]) =>sum+stats.amount,0);const maxCount = sortedCountries[0][1].count;const barsHtml = sortedCountries.map(([country,stats]) =>{const percentage = Math.round((stats.count / total) * 100);const barWidth = (stats.count / maxCount) * 100;const countryName = country === 'CZ' ? 'ƒåesk√° republika':country === 'SK' ? 'Slovensko':country;return ` <div class="chart-bar"><div class="chart-bar-label"><span class="chart-bar-name">${countryName}</span><span class="chart-bar-value">${stats.count}zak√°zek</span></div><div class="chart-bar-fill-container"><div class="chart-bar-fill" style="width:${barWidth}%"><span class="chart-bar-percentage">${percentage}%</span></div></div></div>`}).join('');const legendHtml = sortedCountries.map(([country,stats]) =>{const countryName = country === 'CZ' ? 'ƒåesk√° republika':country === 'SK' ? 'Slovensko':country;const amountPercentage = Math.round((stats.amount / totalAmount) * 100);return ` <div class="chart-legend-item"><span class="chart-legend-name">${countryName}</span><span class="chart-legend-value">${formatCurrency(stats.amount)}(${amountPercentage}%)</span></div>`}).join('');container.innerHTML = ` ${barsHtml}<div class="chart-legend">${legendHtml}</div>`}function renderModelsChart(){const container = document.getElementById('chart-models');if (!container) return;const modelStats ={};WGS.filteredOrders.forEach(order =>{const model = order.model || order.vyrobek || 'Nezn√°m√Ω';if (!modelStats[model]){modelStats[model] ={count:0,amount:0}}modelStats[model].count++;modelStats[model].amount+= parseFloat(order.castka || order.cena || 0)});const sortedModels = Object.entries(modelStats) .sort((a,b) =>b[1].count - a[1].count) .slice(0,10);if (sortedModels.length === 0){container.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--c-grey);">≈Ω√°dn√° data</div>';return}const total = WGS.filteredOrders.length;const maxCount = sortedModels[0][1].count;container.innerHTML = sortedModels.map(([model,stats]) =>{const percentage = Math.round((stats.count / total) * 100);const barWidth = (stats.count / maxCount) * 100;const shortName = model.length>30 ? model.substring(0,27)+'...':model;return ` <div class="chart-bar"><div class="chart-bar-label"><span class="chart-bar-name">${shortName}</span><span class="chart-bar-value">${stats.count}reklamac√≠</span></div><div class="chart-bar-fill-container"><div class="chart-bar-fill" style="width:${barWidth}%"><span class="chart-bar-percentage">${percentage}%</span></div></div></div>`}).join('')}// === EXPORTS ===function getFilterSummary(){const filters = [];if (WGS.filters.country.length>0){const countries = WGS.filters.country.map(id =>{const item = WGS.multiSelect.country.items.find(i =>i.id === id);return item ? item.name:id}).join(',');filters.push(`Zemƒõ:${countries}`)}if (WGS.filters.status.length>0){const statuses = WGS.filters.status.join(',');filters.push(`Stav:${statuses}`)}if (WGS.filters.salesperson.length>0){filters.push(`Prodejce:${WGS.filters.salesperson.join(',')}`)}if (WGS.filters.technician.length>0){filters.push(`Technik:${WGS.filters.technician.join(',')}`)}if (WGS.filters.dateFrom){const date = WGS.filters.dateFrom.split('-').reverse().join('.');filters.push(`Od data:${date}`)}if (WGS.filters.dateTo){const date = WGS.filters.dateTo.split('-').reverse().join('.');filters.push(`Do data:${date}`)}return filters.length>0 ? filters.join(' | '):'V≈°echny zak√°zky'}function getExportHeader(){const now = new Date();const dateStr = now.toLocaleDateString('cs-CZ');const timeStr = now.toLocaleTimeString('cs-CZ');return [ 'WHITE GLOVE SERVICE - STATISTIKY',`Datum exportu:${dateStr}${timeStr}`,`Filtry:${getFilterSummary()}`,`Celkem zak√°zek:${WGS.filteredOrders.length}`,'' ]}function exportSalesStatsExcel(){const csv = generateSalesStatsCSV();const timestamp = new Date().toISOString().split('T')[0];downloadCSV(csv,`WGS_Statistiky-prodejcu_${timestamp}.csv`)}function exportSalesStatsPDF(){generatePDF('Statistiky prodejc≈Ø',generateSalesStatsHTML())}function exportTechStatsExcel(){const csv = generateTechStatsCSV();const timestamp = new Date().toISOString().split('T')[0];downloadCSV(csv,`WGS_Statistiky-techniku_${timestamp}.csv`)}function exportTechStatsPDF(){generatePDF('Statistiky technik≈Ø',generateTechStatsHTML())}function exportModelsStatsExcel(){const csv = generateModelsStatsCSV();const timestamp = new Date().toISOString().split('T')[0];downloadCSV(csv,`WGS_Nejporuchovejsi-modely_${timestamp}.csv`)}function exportModelsStatsPDF(){generatePDF('Nejporuchovƒõj≈°√≠ modely',generateModelsStatsHTML())}function exportFilteredOrdersExcel(){const csv = generateFilteredOrdersCSV();const timestamp = new Date().toISOString().split('T')[0];downloadCSV(csv,`WGS_Filtrovane-zakazky_${timestamp}.csv`)}function exportFilteredOrdersPDF(){generatePDF('Filtrovan√© zak√°zky',generateFilteredOrdersHTML())}function exportChartsExcel(){const csv = generateChartsCSV();const timestamp = new Date().toISOString().split('T')[0];downloadCSV(csv,`WGS_Grafy-vizualizace_${timestamp}.csv`)}function exportChartsPDF(){generatePDF('Grafy a vizualizace',generateChartsHTML())}function generateSalesStatsCSV(){const BOM = '\uFEFF';const header = getExportHeader();const lines = [ ...header,'Prodejce;Poƒçet zak√°zek;Celkov√° ƒç√°stka (‚Ç¨);Pr≈Ømƒõr na zak√°zku (‚Ç¨);CZ;SK;Hotov√© %' ];const salesStats ={};let totalCount = 0;let totalAmount = 0;WGS.filteredOrders.forEach(order =>{const salesperson = order.prodejce || 'Nezn√°m√Ω';const amount = parseFloat(order.castka || order.cena || 0);const country = order.zeme || 'N/A';const isDone = order.stav === 'HOTOVO';if (!salesStats[salesperson]){salesStats[salesperson] ={count:0,totalAmount:0,czCount:0,skCount:0,doneCount:0}}salesStats[salesperson].count++;salesStats[salesperson].totalAmount+= amount;if (country === 'CZ') salesStats[salesperson].czCount++;if (country === 'SK') salesStats[salesperson].skCount++;if (isDone) salesStats[salesperson].doneCount++;totalCount++;totalAmount+= amount});Object.entries(salesStats) .sort((a,b) =>b[1].totalAmount - a[1].totalAmount) .forEach(([name,stats]) =>{const avgAmount = stats.count>0 ? (stats.totalAmount / stats.count).toFixed(2):0;const donePercent = stats.count>0 ? Math.round((stats.doneCount / stats.count) * 100):0;lines.push(`${name};${stats.count};${stats.totalAmount.toFixed(2)};${avgAmount};${stats.czCount};${stats.skCount};${donePercent}%`)});const avgTotal = totalCount>0 ? (totalAmount / totalCount).toFixed(2):0;lines.push('');lines.push(`CELKEM;${totalCount};${totalAmount.toFixed(2)};${avgTotal};-;-;100%`);return BOM+lines.join('\n')}function generateTechStatsCSV(){const BOM = '\uFEFF';const header = getExportHeader();const lines = [ ...header,'Technik;Zak√°zky;V√Ωdƒõlek 33% (‚Ç¨);Pr≈Ømƒõr/zak√°zka (‚Ç¨);CZ;SK;√öspƒõ≈°nost %' ];const techStats ={};let totalCount = 0;let totalEarnings = 0;WGS.filteredOrders.forEach(order =>{const technician = order.technik || 'Nep≈ôi≈ôazeno';const amount = parseFloat(order.castka || order.cena || 0);const earnings = amount * 0.33;const country = order.zeme || 'N/A';const isDone = order.stav === 'HOTOVO';if (!techStats[technician]){techStats[technician] ={count:0,totalEarnings:0,czCount:0,skCount:0,doneCount:0}}techStats[technician].count++;techStats[technician].totalEarnings+= earnings;if (country === 'CZ') techStats[technician].czCount++;if (country === 'SK') techStats[technician].skCount++;if (isDone) techStats[technician].doneCount++;totalCount++;totalEarnings+= earnings});Object.entries(techStats) .sort((a,b) =>b[1].totalEarnings - a[1].totalEarnings) .forEach(([name,stats]) =>{const avgEarnings = stats.count>0 ? (stats.totalEarnings / stats.count).toFixed(2):0;const successRate = stats.count>0 ? Math.round((stats.doneCount / stats.count) * 100):0;lines.push(`${name};${stats.count};${stats.totalEarnings.toFixed(2)};${avgEarnings};${stats.czCount};${stats.skCount};${successRate}%`)});const avgTotal = totalCount>0 ? (totalEarnings / totalCount).toFixed(2):0;lines.push('');lines.push(`CELKEM;${totalCount};${totalEarnings.toFixed(2)};${avgTotal};-;-;100%`);return BOM+lines.join('\n')}function generateModelsStatsCSV(){const BOM = '\uFEFF';const header = getExportHeader();const lines = [ ...header,'Model / V√Ωrobek;Poƒçet reklamac√≠;Pod√≠l %;Pr≈Ømƒõrn√° ƒç√°stka (‚Ç¨);Celkov√° ƒç√°stka (‚Ç¨)' ];const modelStats ={};let totalCount = 0;let totalAmount = 0;WGS.filteredOrders.forEach(order =>{const model = order.model || order.vyrobek || 'Nezn√°m√Ω';const amount = parseFloat(order.castka || order.cena || 0);if (!modelStats[model]){modelStats[model] ={count:0,totalAmount:0}}modelStats[model].count++;modelStats[model].totalAmount+= amount;totalCount++;totalAmount+= amount});Object.entries(modelStats) .sort((a,b) =>b[1].count - a[1].count) .slice(0,20) .forEach(([name,stats]) =>{const percentage = totalCount>0 ? Math.round((stats.count / totalCount) * 100):0;const avgAmount = stats.count>0 ? (stats.totalAmount / stats.count).toFixed(2):0;lines.push(`${name};${stats.count};${percentage}%;${avgAmount};${stats.totalAmount.toFixed(2)}`)});const avgTotal = totalCount>0 ? (totalAmount / totalCount).toFixed(2):0;lines.push('');lines.push(`CELKEM;${totalCount};100%;${avgTotal};${totalAmount.toFixed(2)}`);return BOM+lines.join('\n')}function generateFilteredOrdersCSV(){const BOM = '\uFEFF';const header = getExportHeader();const lines = [ ...header,'ƒå√≠slo;Z√°kazn√≠k;Prodejce;Technik;ƒå√°stka (‚Ç¨);Stav;Zemƒõ;Datum' ];WGS.filteredOrders.forEach(order =>{lines.push([ order.reklamacniCislo || order.id,order.jmenoZakaznika || '-',order.prodejce || '-',order.technik || '-',(order.castka || order.cena || 0),order.stav || '-',order.zeme || '-',order.datum || '-' ].join(';'))});const totalAmount = WGS.filteredOrders.reduce((sum,o) =>sum+parseFloat(o.castka || o.cena || 0),0);lines.push('');lines.push(`CELKEM;;;Zak√°zek:${WGS.filteredOrders.length};${totalAmount.toFixed(2)}‚Ç¨;;;`);return BOM+lines.join('\n')}function generateChartsCSV(){const BOM = '\uFEFF';const header = getExportHeader();let lines = [...header,'','=== ROZDƒöLEN√ç PODLE MƒöST ===',''];const cityStats ={};WGS.filteredOrders.forEach(order =>{let city = 'Nezn√°m√©';if (order.mesto){city = order.mesto}else if (order.adresa){const parts = order.adresa.split(',');if (parts.length>= 2){city = parts[1].trim()}}if (!cityStats[city]){cityStats[city] ={count:0,amount:0}}cityStats[city].count++;cityStats[city].amount+= parseFloat(order.castka || order.cena || 0)});lines.push('Mƒõsto;Poƒçet zak√°zek;Celkov√° ƒç√°stka (‚Ç¨);Pod√≠l %');const totalOrders = WGS.filteredOrders.length;Object.entries(cityStats) .sort((a,b) =>b[1].count - a[1].count) .slice(0,10) .forEach(([city,stats]) =>{const percentage = Math.round((stats.count / totalOrders) * 100);lines.push(`${city};${stats.count};${stats.amount.toFixed(2)};${percentage}%`)});lines.push('','=== ROZDƒöLEN√ç PODLE ZEM√ç ===','');const countryStats ={};WGS.filteredOrders.forEach(order =>{const country = order.zeme || 'Nezn√°m√°';if (!countryStats[country]){countryStats[country] ={count:0,amount:0}}countryStats[country].count++;countryStats[country].amount+= parseFloat(order.castka || order.cena || 0)});lines.push('Zemƒõ;Poƒçet zak√°zek;Celkov√° ƒç√°stka (‚Ç¨);Pod√≠l %');Object.entries(countryStats) .sort((a,b) =>b[1].count - a[1].count) .forEach(([country,stats]) =>{const countryName = country === 'CZ' ? 'ƒåesk√° republika':country === 'SK' ? 'Slovensko':country;const percentage = Math.round((stats.count / totalOrders) * 100);lines.push(`${countryName};${stats.count};${stats.amount.toFixed(2)};${percentage}%`)});lines.push('','=== NEJPORUCHOVƒöJ≈†√ç MODELY ===','');const modelStats ={};WGS.filteredOrders.forEach(order =>{const model = order.model || order.vyrobek || 'Nezn√°m√Ω';if (!modelStats[model]){modelStats[model] ={count:0,amount:0}}modelStats[model].count++;modelStats[model].amount+= parseFloat(order.castka || order.cena || 0)});lines.push('Model;Poƒçet reklamac√≠;Celkov√° ƒç√°stka (‚Ç¨);Pod√≠l %');Object.entries(modelStats) .sort((a,b) =>b[1].count - a[1].count) .slice(0,10) .forEach(([model,stats]) =>{const percentage = Math.round((stats.count / totalOrders) * 100);lines.push(`${model};${stats.count};${stats.amount.toFixed(2)};${percentage}%`)});return BOM+lines.join('\n')}function downloadCSV(content,filename){const blob = new Blob([content],{type:'text/csv;charset=utf-8;'});const url = URL.createObjectURL(blob);const link = document.createElement('a');link.href = url;link.download = filename;link.click();URL.revokeObjectURL(url)}// === PDF GENERATION ===function generatePDF(title,contentHTML){const now = new Date();const dateStr = now.toLocaleDateString('cs-CZ');const timeStr = now.toLocaleTimeString('cs-CZ');const printWindow = window.open('','_blank');printWindow.document.write(` <!DOCTYPE html><html><head><meta charset="UTF-8"><title>WGS - ${title}</title><style>@page{margin:2cm;size:A4}body{font-family:'Arial',sans-serif;font-size:10pt;line-height:1.4;color:#1a1a1a;margin:0;padding:0}.header{border-bottom:3px solid #1a1a1a;padding-bottom:15px;margin-bottom:20px}.logo{font-size:24pt;font-weight:bold;letter-spacing:0.2em;color:#1a1a1a;margin-bottom:5px}.subtitle{font-size:9pt;color:#666;letter-spacing:0.15em;text-transform:uppercase}.report-title{font-size:18pt;font-weight:bold;margin:20px 0 10px 0;text-transform:uppercase;letter-spacing:0.05em}.meta-info{background:#f5f5f5;padding:10px 15px;margin-bottom:20px;border-left:3px solid #1a1a1a}.meta-info p{margin:3px 0;font-size:9pt;color:#666}.meta-info strong{color:#1a1a1a}table{width:100%;border-collapse:collapse;margin:15px 0;font-size:9pt}th{background:#1a1a1a;color:white;padding:8px;text-align:left;font-weight:bold;text-transform:uppercase;font-size:8pt;letter-spacing:0.05em}td{padding:6px 8px;border-bottom:1px solid #e0e0e0}tr:hover td{background:#f9f9f9}tfoot td{background:#f0f0f0;font-weight:bold;border-top:2px solid #1a1a1a;padding:10px 8px}.footer{margin-top:30px;padding-top:15px;border-top:1px solid #e0e0e0;font-size:8pt;color:#999;text-align:center}.chart-section{margin:20px 0;page-break-inside:avoid}.chart-title{font-size:12pt;font-weight:bold;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.05em}@media print{body{print-color-adjust:exact;-webkit-print-color-adjust:exact}.page-break{page-break-before:always}}</style></head><body><div class="header"><div class="logo">WGS</div><div class="subtitle">WHITE GLOVE SERVICE</div></div><div class="report-title">${title}</div><div class="meta-info"><p><strong>Datum exportu:</strong>${dateStr}${timeStr}</p><p><strong>Filtry:</strong>${getFilterSummary()}</p><p><strong>Celkem zak√°zek:</strong>${WGS.filteredOrders.length}</p></div>${contentHTML}<div class="footer"><p>White Glove Service - Administraƒçn√≠ syst√©m ¬© ${now.getFullYear()}</p><p>Generov√°no:${dateStr}v ${timeStr}</p></div></body></html>`);printWindow.document.close();printWindow.focus();setTimeout(() =>{printWindow.print()},500)}function generateSalesStatsHTML(){const salesStats ={};let totalCount = 0;let totalAmount = 0;WGS.filteredOrders.forEach(order =>{const salesperson = order.prodejce || 'Nezn√°m√Ω';const amount = parseFloat(order.castka || order.cena || 0);const country = order.zeme || 'N/A';const isDone = order.stav === 'HOTOVO';if (!salesStats[salesperson]){salesStats[salesperson] ={count:0,totalAmount:0,czCount:0,skCount:0,doneCount:0}}salesStats[salesperson].count++;salesStats[salesperson].totalAmount+= amount;if (country === 'CZ') salesStats[salesperson].czCount++;if (country === 'SK') salesStats[salesperson].skCount++;if (isDone) salesStats[salesperson].doneCount++;totalCount++;totalAmount+= amount});let html = '<table><thead><tr><th>Prodejce</th><th>Poƒçet</th><th>Celkem</th><th>Pr≈Ømƒõr</th><th>CZ / SK</th><th>Hotov√© %</th></tr></thead><tbody>';Object.entries(salesStats) .sort((a,b) =>b[1].totalAmount - a[1].totalAmount) .forEach(([name,stats]) =>{const avgAmount = stats.count>0 ? Math.round(stats.totalAmount / stats.count):0;const donePercent = stats.count>0 ? Math.round((stats.doneCount / stats.count) * 100):0;html+= `<tr><td><strong>${name}</strong></td><td>${stats.count}</td><td><strong>${formatCurrency(stats.totalAmount)}</strong></td><td>${formatCurrency(avgAmount)}</td><td>${stats.czCount}/ ${stats.skCount}</td><td>${donePercent}%</td></tr>`});const avgTotal = totalCount>0 ? Math.round(totalAmount / totalCount):0;html+= `</tbody><tfoot><tr><td><strong>CELKEM</strong></td><td>${totalCount}</td><td><strong>${formatCurrency(totalAmount)}</strong></td><td>${formatCurrency(avgTotal)}</td><td>-</td><td>100%</td></tr></tfoot></table>`;return html}function generateTechStatsHTML(){const techStats ={};let totalCount = 0;let totalEarnings = 0;WGS.filteredOrders.forEach(order =>{const technician = order.technik || 'Nep≈ôi≈ôazeno';const amount = parseFloat(order.castka || order.cena || 0);const earnings = amount * 0.33;const country = order.zeme || 'N/A';const isDone = order.stav === 'HOTOVO';if (!techStats[technician]){techStats[technician] ={count:0,totalEarnings:0,czCount:0,skCount:0,doneCount:0}}techStats[technician].count++;techStats[technician].totalEarnings+= earnings;if (country === 'CZ') techStats[technician].czCount++;if (country === 'SK') techStats[technician].skCount++;if (isDone) techStats[technician].doneCount++;totalCount++;totalEarnings+= earnings});let html = '<table><thead><tr><th>Technik</th><th>Zak√°zky</th><th>V√Ωdƒõlek (33%)</th><th>Pr≈Ømƒõr</th><th>CZ / SK</th><th>√öspƒõ≈°nost</th></tr></thead><tbody>';Object.entries(techStats) .sort((a,b) =>b[1].totalEarnings - a[1].totalEarnings) .forEach(([name,stats]) =>{const avgEarnings = stats.count>0 ? Math.round(stats.totalEarnings / stats.count):0;const successRate = stats.count>0 ? Math.round((stats.doneCount / stats.count) * 100):0;html+= `<tr><td><strong>${name}</strong></td><td>${stats.count}</td><td><strong>${formatCurrency(stats.totalEarnings)}</strong></td><td>${formatCurrency(avgEarnings)}</td><td>${stats.czCount}/ ${stats.skCount}</td><td>${successRate}%</td></tr>`});const avgTotal = totalCount>0 ? Math.round(totalEarnings / totalCount):0;html+= `</tbody><tfoot><tr><td><strong>CELKEM</strong></td><td>${totalCount}</td><td><strong>${formatCurrency(totalEarnings)}</strong></td><td>${formatCurrency(avgTotal)}</td><td>-</td><td>100%</td></tr></tfoot></table>`;return html}function generateModelsStatsHTML(){const modelStats ={};let totalCount = 0;let totalAmount = 0;WGS.filteredOrders.forEach(order =>{const model = order.model || order.vyrobek || 'Nezn√°m√Ω';const amount = parseFloat(order.castka || order.cena || 0);if (!modelStats[model]){modelStats[model] ={count:0,totalAmount:0}}modelStats[model].count++;modelStats[model].totalAmount+= amount;totalCount++;totalAmount+= amount});let html = '<table><thead><tr><th>Model / V√Ωrobek</th><th>Poƒçet</th><th>Pod√≠l %</th><th>Pr≈Ømƒõr</th><th>Celkem</th></tr></thead><tbody>';Object.entries(modelStats) .sort((a,b) =>b[1].count - a[1].count) .slice(0,20) .forEach(([name,stats]) =>{const percentage = totalCount>0 ? Math.round((stats.count / totalCount) * 100):0;const avgAmount = stats.count>0 ? Math.round(stats.totalAmount / stats.count):0;html+= `<tr><td><strong>${name}</strong></td><td>${stats.count}</td><td>${percentage}%</td><td>${formatCurrency(avgAmount)}</td><td><strong>${formatCurrency(stats.totalAmount)}</strong></td></tr>`});const avgTotal = totalCount>0 ? Math.round(totalAmount / totalCount):0;html+= `</tbody><tfoot><tr><td><strong>CELKEM</strong></td><td>${totalCount}</td><td>100%</td><td>${formatCurrency(avgTotal)}</td><td><strong>${formatCurrency(totalAmount)}</strong></td></tr></tfoot></table>`;return html}function generateFilteredOrdersHTML(){let html = '<table><thead><tr><th>ƒå√≠slo</th><th>Z√°kazn√≠k</th><th>Prodejce</th><th>Technik</th><th>ƒå√°stka</th><th>Stav</th><th>Zemƒõ</th><th>Datum</th></tr></thead><tbody>';let totalAmount = 0;WGS.filteredOrders.slice(0,100).forEach(order =>{const amount = parseFloat(order.castka || order.cena || 0);totalAmount+= amount;html+= `<tr><td style="font-family:'Courier New',monospace;">${order.reklamacniCislo || order.id}</td><td>${order.jmenoZakaznika || '-'}</td><td>${order.prodejce || '-'}</td><td>${order.technik || '-'}</td><td><strong>${formatCurrency(amount)}</strong></td><td>${order.stav || 'N/A'}</td><td>${order.zeme || 'N/A'}</td><td style="font-size:0.85em;">${formatDate(order.datum)}</td></tr>`});const fullTotalAmount = WGS.filteredOrders.reduce((sum,o) =>sum+parseFloat(o.castka || o.cena || 0),0);html+= `</tbody><tfoot><tr><td colspan="4"><strong>CELKEM</strong></td><td><strong>${formatCurrency(fullTotalAmount)}</strong></td><td colspan="3">${WGS.filteredOrders.length}zak√°zek${WGS.filteredOrders.length>100 ? ' (zobrazeno prvn√≠ch 100)':''}</td></tr></tfoot></table>`;return html}function generateChartsHTML(){let html = '';html+= '<div class="chart-section"><div class="chart-title">Rozdƒõlen√≠ podle mƒõst (Top 10)</div><table><thead><tr><th>Mƒõsto</th><th>Poƒçet</th><th>ƒå√°stka</th><th>Pod√≠l %</th></tr></thead><tbody>';const cityStats ={};WGS.filteredOrders.forEach(order =>{let city = 'Nezn√°m√©';if (order.mesto){city = order.mesto}else if (order.adresa){const parts = order.adresa.split(',');if (parts.length>= 2){city = parts[1].trim()}}if (!cityStats[city]){cityStats[city] ={count:0,amount:0}}cityStats[city].count++;cityStats[city].amount+= parseFloat(order.castka || order.cena || 0)});const totalOrders = WGS.filteredOrders.length;Object.entries(cityStats) .sort((a,b) =>b[1].count - a[1].count) .slice(0,10) .forEach(([city,stats]) =>{const percentage = Math.round((stats.count / totalOrders) * 100);html+= `<tr><td>${city}</td><td>${stats.count}</td><td>${formatCurrency(stats.amount)}</td><td>${percentage}%</td></tr>`});html+= '</tbody></table></div>';html+= '<div class="page-break"></div><div class="chart-section"><div class="chart-title">Rozdƒõlen√≠ podle zem√≠</div><table><thead><tr><th>Zemƒõ</th><th>Poƒçet</th><th>ƒå√°stka</th><th>Pod√≠l %</th></tr></thead><tbody>';const countryStats ={};WGS.filteredOrders.forEach(order =>{const country = order.zeme || 'Nezn√°m√°';if (!countryStats[country]){countryStats[country] ={count:0,amount:0}}countryStats[country].count++;countryStats[country].amount+= parseFloat(order.castka || order.cena || 0)});Object.entries(countryStats) .sort((a,b) =>b[1].count - a[1].count) .forEach(([country,stats]) =>{const countryName = country === 'CZ' ? 'ƒåesk√° republika':country === 'SK' ? 'Slovensko':country;const percentage = Math.round((stats.count / totalOrders) * 100);html+= `<tr><td>${countryName}</td><td>${stats.count}</td><td>${formatCurrency(stats.amount)}</td><td>${percentage}%</td></tr>`});html+= '</tbody></table></div>';html+= '<div class="page-break"></div><div class="chart-section"><div class="chart-title">Nejporuchovƒõj≈°√≠ modely (Top 10)</div><table><thead><tr><th>Model</th><th>Poƒçet</th><th>ƒå√°stka</th><th>Pod√≠l %</th></tr></thead><tbody>';const modelStats ={};WGS.filteredOrders.forEach(order =>{const model = order.model || order.vyrobek || 'Nezn√°m√Ω';if (!modelStats[model]){modelStats[model] ={count:0,amount:0}}modelStats[model].count++;modelStats[model].amount+= parseFloat(order.castka || order.cena || 0)});Object.entries(modelStats) .sort((a,b) =>b[1].count - a[1].count) .slice(0,10) .forEach(([model,stats]) =>{const percentage = Math.round((stats.count / totalOrders) * 100);html+= `<tr><td>${model}</td><td>${stats.count}</td><td>${formatCurrency(stats.amount)}</td><td>${percentage}%</td></tr>`});html+= '</tbody></table></div>';return html}// === UTILS ===function toggleSection(headerElement){const container = headerElement.parentElement;container.classList.toggle('collapsed')}function formatDate(dateString){if (!dateString || dateString === 'N/A') return 'N/A';const date = new Date(dateString);if (isNaN(date)) return dateString;return date.toLocaleDateString('cs-CZ')}function formatCurrency(amount){return new Intl.NumberFormat('cs-CZ',{style:'decimal',minimumFractionDigits:2,maximumFractionDigits:2}).format(amount)+' ‚Ç¨'}// === EVENT DELEGATION FOR REMOVED INLINE HANDLERS ===document.addEventListener('DOMContentLoaded',() =>{// Handle data-action buttons (simple functions without arguments) document.addEventListener('click',(e) =>{const action = e.target.closest('[data-action]')?.getAttribute('data-action');if (action === 'toggleMobileMenu'){toggleMobileMenu()}else if (action === 'logout'){logout()}else if (action === 'resetFilters'){resetFilters()}else if (action === 'applyFilters'){applyFilters()}else if (action === 'toggleSection'){toggleSection(e.target.closest('[data-action]'))}else if (action === 'stopPropagation'){e.stopPropagation()}else if (action === 'exportSalesStatsExcel'){exportSalesStatsExcel()}else if (action === 'exportSalesStatsPDF'){exportSalesStatsPDF()}else if (action === 'exportServiceStatsPDF'){exportServiceStatsPDF()}else if (action === 'exportTechStatsExcel'){exportTechStatsExcel()}else if (action === 'exportTechStatsPDF'){exportTechStatsPDF()}else if (action === 'exportModelsStatsExcel'){exportModelsStatsExcel()}else if (action === 'exportModelsStatsPDF'){exportModelsStatsPDF()}else if (action === 'exportFilteredOrdersExcel'){exportFilteredOrdersExcel()}else if (action === 'exportFilteredOrdersPDF'){exportFilteredOrdersPDF()}else if (action === 'exportChartsExcel'){exportChartsExcel()}else if (action === 'exportChartsPDF'){exportChartsPDF()}});// Handle data-navigate buttons document.addEventListener('click',(e) =>{const navigate = e.target.closest('[data-navigate]')?.getAttribute('data-navigate');if (navigate){navigateTo(navigate)}});// Handle data-multiselect buttons document.addEventListener('click',(e) =>{const multiselect = e.target.closest('[data-multiselect]')?.getAttribute('data-multiselect');if (multiselect){openMultiSelect(multiselect)}});// Handle data-multiselect-clear buttons document.addEventListener('click',(e) =>{const clearSelect = e.target.closest('[data-multiselect-clear]')?.getAttribute('data-multiselect-clear');if (clearSelect){clearMultiSelect(clearSelect)}});// Handle data-multiselect-close buttons document.addEventListener('click',(e) =>{const closeSelect = e.target.closest('[data-multiselect-close]')?.getAttribute('data-multiselect-close');if (closeSelect){closeMultiSelect(closeSelect)}})});
