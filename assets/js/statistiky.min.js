let aktualniStranka=1,vybraneProdejci=[],vybraneTechnici=[],vybraneZeme=["cz","sk"];function inicializujMultiselect(){const t=document.getElementById("prodejci-trigger");t&&t.addEventListener("click",t=>{t.stopPropagation(),toggleDropdown("prodejci")});const e=document.getElementById("technici-trigger");e&&e.addEventListener("click",t=>{t.stopPropagation(),toggleDropdown("technici")});const n=document.getElementById("zeme-trigger");n&&n.addEventListener("click",t=>{t.stopPropagation(),toggleDropdown("zeme")}),document.addEventListener("click",t=>{t.target.closest(".filter-multiselect")||document.querySelectorAll(".multiselect-dropdown").forEach(t=>{t.classList.remove("active")})});const a=document.getElementById("zobrazitMimozarucni");a&&a.addEventListener("change",()=>{aktualniStranka=1,aplikovatFiltry()}),document.querySelectorAll('#zeme-dropdown input[type="checkbox"]').forEach(t=>{t.addEventListener("change",()=>{updateVyberZeme()})})}function toggleDropdown(t){const e=document.getElementById(`${t}-dropdown`),n=document.getElementById(`${t}-trigger`),a=document.querySelectorAll(".multiselect-dropdown"),i=document.querySelectorAll(".multiselect-trigger");a.forEach((t,n)=>{t!==e&&t.classList.remove("active")}),i.forEach(t=>{t!==n&&t.setAttribute("aria-expanded","false")});const o=e.classList.toggle("active");n.setAttribute("aria-expanded",o?"true":"false")}async function nactiProdejce(){try{const t=await fetch("/api/statistiky_api.php?action=load_prodejci"),e=await t.json();if("success"===e.status){const t=document.getElementById("prodejci-dropdown");t.innerHTML="",e.data.forEach(e=>{const n=document.createElement("div");n.className="multiselect-option",n.innerHTML=`\n                    <input type="checkbox" id="prodejce-${e.id}" value="${e.id}">\n                    <label for="prodejce-${e.id}">${e.name}</label>\n                `,n.querySelector("input").addEventListener("change",()=>{updateVyberProdejci()}),t.appendChild(n)})}}catch(t){console.error("Chyba načítání prodejců:",t)}}async function nactiTechniky(){try{const t=await fetch("/api/statistiky_api.php?action=load_technici"),e=await t.json();if("success"===e.status){const t=document.getElementById("technici-dropdown");t.innerHTML="",e.data.forEach(e=>{const n=document.createElement("div");n.className="multiselect-option",n.innerHTML=`\n                    <input type="checkbox" id="technik-${e.id}" value="${e.id}">\n                    <label for="technik-${e.id}">${e.name}</label>\n                `,n.querySelector("input").addEventListener("change",()=>{updateVyberTechnici()}),t.appendChild(n)})}}catch(t){console.error("Chyba načítání techniků:",t)}}function updateVyberProdejci(){const t=document.querySelectorAll('#prodejci-dropdown input[type="checkbox"]:checked');vybraneProdejci=Array.from(t).map(t=>t.value);const e=document.getElementById("prodejci-label");if(0===vybraneProdejci.length)e.textContent="Všichni";else if(1===vybraneProdejci.length){const t=document.querySelector(`#prodejci-dropdown input[value="${vybraneProdejci[0]}"]`).nextElementSibling;e.textContent=t.textContent}else e.textContent=`Vybráno (${vybraneProdejci.length})`;aktualniStranka=1,aplikovatFiltry()}function updateVyberTechnici(){const t=document.querySelectorAll('#technici-dropdown input[type="checkbox"]:checked');vybraneTechnici=Array.from(t).map(t=>t.value);const e=document.getElementById("technici-label");if(0===vybraneTechnici.length)e.textContent="Všichni";else if(1===vybraneTechnici.length){const t=document.querySelector(`#technici-dropdown input[value="${vybraneTechnici[0]}"]`).nextElementSibling;e.textContent=t.textContent}else e.textContent=`Vybráno (${vybraneTechnici.length})`;aktualniStranka=1,aplikovatFiltry()}function updateVyberZeme(){const t=document.querySelectorAll('#zeme-dropdown input[type="checkbox"]:checked');vybraneZeme=Array.from(t).map(t=>t.value);const e=document.getElementById("zeme-label");if(0===vybraneZeme.length)e.textContent="Žádná";else if(2===vybraneZeme.length)e.textContent="Všechny";else{const t=document.querySelector(`#zeme-dropdown input[value="${vybraneZeme[0]}"]`).nextElementSibling;e.textContent=t.textContent}aktualniStranka=1,aplikovatFiltry()}function getFilterParams(){const t=new URLSearchParams,e=document.getElementById("filter-year").value,n=document.getElementById("filter-month").value;e&&t.append("rok",e),n&&t.append("mesic",n),vybraneProdejci.forEach(e=>t.append("prodejci[]",e)),vybraneTechnici.forEach(e=>t.append("technici[]",e)),vybraneZeme.forEach(e=>t.append("zeme[]",e));const a=document.getElementById("zobrazitMimozarucni");return a&&a.checked&&t.append("zobrazit_mimozarucni","1"),t.toString()}async function nactiSummary(){try{const t=getFilterParams(),e=await fetch(`/api/statistiky_api.php?action=summary&${t}`),n=await e.json();"success"===n.status&&(document.getElementById("total-all").textContent=n.data.total_all,document.getElementById("total-month").textContent=n.data.total_month,document.getElementById("revenue-all").textContent=n.data.revenue_all.toFixed(2)+" €",document.getElementById("revenue-month").textContent=n.data.revenue_month.toFixed(2)+" €")}catch(t){console.error("Chyba načítání summary:",t)}}async function nactiZakazky(){try{const t=document.getElementById("table-container");t.innerHTML='<div class="loading">Načítání zakázek...</div>';const e=getFilterParams(),n=await fetch(`/api/statistiky_api.php?action=get_zakazky&${e}&stranka=${aktualniStranka}`),a=await n.json();"success"===a.status?(renderTabulka(a.data),updateStrankovani(a.data)):t.innerHTML='<div class="empty-state">Chyba načítání dat</div>'}catch(t){console.error("Chyba načítání zakázek:",t),document.getElementById("table-container").innerHTML='<div class="empty-state">Chyba načítání dat</div>'}}function renderTabulka(t){const e=document.getElementById("table-container"),n=document.getElementById("table-count");if(!t.zakazky||0===t.zakazky.length)return e.innerHTML='<div class="empty-state"><div class="empty-state-icon"></div>Žádné zakázky podle filtrů</div>',void(n.textContent="0 zakázek");n.textContent=`${t.total_count} zakázek`;let a="";t.zakazky.forEach(t=>{a+=`\n            <tr>\n                <td>${t.cislo_reklamace||"-"}</td>\n                <td>${t.jmeno_zakaznika||"-"}</td>\n                <td>${t.adresa||"-"}</td>\n                <td>${t.model||"-"}</td>\n                <td>${t.technik}</td>\n                <td>${t.prodejce}</td>\n                <td>${parseFloat(t.castka_celkem).toFixed(2)} €</td>\n                <td>${parseFloat(t.vydelek_technika).toFixed(2)} €</td>\n                <td>${t.zeme}</td>\n                <td>${t.datum}</td>\n            </tr>\n        `}),e.innerHTML=`\n        <table class="stats-table">\n            <thead>\n                <tr>\n                    <th>ID</th>\n                    <th>Jméno</th>\n                    <th>Adresa</th>\n                    <th>Model</th>\n                    <th>Technik</th>\n                    <th>Prodejce</th>\n                    <th>Částka</th>\n                    <th>Výdělek</th>\n                    <th>Země</th>\n                    <th>Datum</th>\n                </tr>\n            </thead>\n            <tbody>\n                ${a}\n            </tbody>\n        </table>\n    `}function updateStrankovani(t){const e=document.getElementById("pagination"),n=document.getElementById("page-info"),a=document.getElementById("prev-page"),i=document.getElementById("next-page");t.celkem_stranek<=1?e.classList.add("hidden"):(e.classList.remove("hidden"),n.textContent=`Strana ${t.stranka} z ${t.celkem_stranek}`,a.disabled=1===t.stranka,i.disabled=t.stranka>=t.celkem_stranek)}function predchoziStranka(){aktualniStranka>1&&(aktualniStranka--,nactiZakazky())}function dalsiStranka(){aktualniStranka++,nactiZakazky()}async function nactiCharty(){try{const t=getFilterParams(),e=await fetch(`/api/statistiky_api.php?action=get_charts&${t}`),n=await e.json();"success"===n.status&&renderCharty(n.data)}catch(t){console.error("Chyba načítání grafů:",t)}}function renderCharty(t){const e=document.getElementById("chart-models");if(t.modely&&t.modely.length>0){let n="";t.modely.forEach(t=>{n+=`\n                <div class="chart-item">\n                    <div class="chart-item-label">${t.model}</div>\n                    <div class="chart-item-value">${t.pocet} ks</div>\n                </div>\n            `}),e.innerHTML=n}else e.innerHTML='<div class="empty-state">Žádná data</div>';const n=document.getElementById("chart-cities");if(t.mesta&&t.mesta.length>0){let e="";t.mesta.forEach(t=>{e+=`\n                <div class="chart-item">\n                    <div class="chart-item-label">${t.mesto}</div>\n                    <div class="chart-item-value">${t.pocet} ks</div>\n                </div>\n            `}),n.innerHTML=e}else n.innerHTML='<div class="empty-state">Žádná data</div>';const a=document.getElementById("chart-salespersons");if(t.prodejci&&t.prodejci.length>0){let e="";t.prodejci.forEach(t=>{e+=`\n                <div class="chart-item">\n                    <div class="chart-item-label">${t.prodejce} (${t.pocet} ks)</div>\n                    <div class="chart-item-value">${parseFloat(t.celkem).toFixed(2)} €</div>\n                </div>\n            `}),a.innerHTML=e}else a.innerHTML='<div class="empty-state">Žádná data</div>';const i=document.getElementById("chart-technicians");if(t.technici&&t.technici.length>0){let e="";t.technici.forEach(t=>{e+=`\n                <div class="chart-item">\n                    <div class="chart-item-label">${t.technik} (${t.pocet} ks)</div>\n                    <div class="chart-item-value">${parseFloat(t.vydelek).toFixed(2)} €</div>\n                </div>\n            `}),i.innerHTML=e}else i.innerHTML='<div class="empty-state">Žádná data</div>'}function aplikovatFiltry(){aktualniStranka=1,nactiSummary(),nactiZakazky(),nactiCharty()}function resetovitFiltry(){document.getElementById("filter-year").value="",document.getElementById("filter-month").value="",document.querySelectorAll('#prodejci-dropdown input[type="checkbox"]').forEach(t=>{t.checked=!1}),vybraneProdejci=[],document.getElementById("prodejci-label").textContent="Všichni",document.querySelectorAll('#technici-dropdown input[type="checkbox"]').forEach(t=>{t.checked=!1}),vybraneTechnici=[],document.getElementById("technici-label").textContent="Všichni",document.querySelectorAll('#zeme-dropdown input[type="checkbox"]').forEach(t=>{t.checked=!0}),vybraneZeme=["cz","sk"],document.getElementById("zeme-label").textContent="Všechny";const t=document.getElementById("zobrazitMimozarucni");t&&(t.checked=!0),aktualniStranka=1,aplikovatFiltry()}async function exportovatPDF(){try{const t=getFilterParams(),e=await fetch(`/api/statistiky_api.php?action=get_zakazky&${t}&pro_export=1`),n=await e.json();if("success"!==n.status||!n.data.zakazky)return void wgsToast.error("Chyba při načítání dat pro export");const a=n.data.zakazky;if(0===a.length)return void wgsToast.warning("Žádná data k exportu podle filtrů");const i=document.getElementById("filter-year").value||"Všechny",o=document.getElementById("filter-month").value,d=o?["","Leden","Únor","Březen","Duben","Květen","Červen","Červenec","Srpen","Září","Říjen","Listopad","Prosinec"][parseInt(o)]:"Všechny",r=(new Date).toLocaleDateString("cs-CZ"),c=document.getElementById("zobrazitOdmenu").checked,l=a.reduce((t,e)=>t+parseFloat(e.castka_celkem),0),s=a.reduce((t,e)=>t+parseFloat(e.vydelek_technika),0),p=document.createElement("div");p.style.cssText="position: absolute; left: -9999px; width: 1200px; background: white; padding: 30px; font-family: Poppins, Arial, sans-serif;",p.innerHTML=`\n            <div style="margin-bottom: 15px;">\n                <h1 style="color: #333; font-size: 18px; margin: 0 0 8px 0; font-weight: 700;">Statistiky a reporty - WGS</h1>\n                <p style="color: #666; font-size: 11px; margin: 0;">Rok: ${i} | Měsíc: ${d} | Celkem: ${a.length} zakázek</p>\n            </div>\n            <table style="width: 100%; border-collapse: collapse; font-size: 8px;">\n                <thead>\n                    <tr style="background: #f0f0f0; color: #333;">\n                        <th style="padding: 4px; text-align: left; border: 1px solid #999; font-size: 7px;">ID</th>\n                        <th style="padding: 4px; text-align: left; border: 1px solid #999; font-size: 7px;">Jméno</th>\n                        <th style="padding: 4px; text-align: left; border: 1px solid #999; font-size: 7px;">Adresa</th>\n                        <th style="padding: 4px; text-align: left; border: 1px solid #999; font-size: 7px;">Model</th>\n                        <th style="padding: 4px; text-align: left; border: 1px solid #999; font-size: 7px;">Technik</th>\n                        <th style="padding: 4px; text-align: left; border: 1px solid #999; font-size: 7px;">Prodejce</th>\n                        <th style="padding: 4px; text-align: right; border: 1px solid #999; font-size: 7px;">Částka</th>\n                        ${c?'<th style="padding: 4px; text-align: right; border: 1px solid #999; font-size: 7px;">Výdělek</th>':""}\n                        <th style="padding: 4px; text-align: center; border: 1px solid #999; font-size: 7px;">Země</th>\n                        <th style="padding: 4px; text-align: center; border: 1px solid #999; font-size: 7px;">Datum</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    ${a.map((t,e)=>`\n                        <tr style="background: ${e%2==0?"#fff":"#f5f5f5"};">\n                            <td style="padding: 3px; border: 1px solid #ddd; font-size: 8px;">${t.cislo_reklamace||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; font-size: 8px;">${t.jmeno_zakaznika||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; font-size: 8px;">${t.adresa||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; font-size: 8px;">${t.model||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; font-size: 8px;">${t.technik||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; font-size: 8px;">${t.prodejce||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; text-align: right; font-size: 8px;">${parseFloat(t.castka_celkem).toFixed(2)} €</td>\n                            ${c?`<td style="padding: 3px; border: 1px solid #ddd; text-align: right; font-size: 8px;">${parseFloat(t.vydelek_technika).toFixed(2)} €</td>`:""}\n                            <td style="padding: 3px; border: 1px solid #ddd; text-align: center; font-size: 8px;">${t.zeme||"-"}</td>\n                            <td style="padding: 3px; border: 1px solid #ddd; text-align: center; font-size: 8px;">${t.datum||"-"}</td>\n                        </tr>\n                    `).join("")}\n                </tbody>\n            </table>\n\n            \x3c!-- SOUHRN - vždy za tabulkou s mezerou, nikdy se nepřepíše --\x3e\n            <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #333; text-align: right;">\n                <div style="background: #f0f0f0; border: 1px solid #999; padding: 8px 16px; margin-bottom: 8px; font-size: 14px; display: inline-block;">\n                    Počet zakázek celkem: <span style="color: #333; font-weight: bold;">${a.length} ks</span>\n                </div><br>\n                <div style="background: #f0f0f0; border: 1px solid #999; padding: 8px 16px; margin-bottom: 8px; font-size: 14px; display: inline-block;">\n                    Celkem za zakázky k fakturaci: <span style="color: #333; font-weight: bold;">${l.toFixed(2)} €</span>\n                </div><br>\n                ${c?`\n                    <div style="background: #f0f0f0; border: 1px solid #999; padding: 8px 16px; font-size: 14px; display: inline-block;">\n                        Výdělek celkem technik: <span style="color: #333; font-weight: bold;">${s.toFixed(2)} €</span>\n                    </div>\n                `:""}\n            </div>\n\n            \x3c!-- PATIČKA - vždy na úplném konci --\x3e\n            <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd;">\n                <div style="font-size: 10px; color: #999; margin-bottom: 5px;">\n                    Vygenerováno: ${r}\n                </div>\n                <div style="font-size: 9px; color: #aaa; font-style: italic;">\n                    Report byl vytvořen pomocí systému WGS (White Glove Service) – Nástroj pro správu servisních zakázek Natuzzi\n                </div>\n            </div>\n        `,document.body.appendChild(p);const m=await html2canvas(p,{scale:2,backgroundColor:"#fff",useCORS:!0,logging:!1});document.body.removeChild(p);const{jsPDF:h}=window.jspdf,y=new h("l","mm","a4"),u=m.toDataURL("image/jpeg",.95),g=y.internal.pageSize.width,k=y.internal.pageSize.height,v=10,x=g-2*v,f=k-2*v,b=m.height/m.width;let z=x,w=z*b;const E=m.width*(f/z),S=Math.ceil(m.height/E);if(w<=f)y.addImage(u,"JPEG",v,v,z,w),y.setFontSize(9),y.setTextColor(100,100,100),y.text("1/1",v,8);else{let t=0,e=1;for(;t<m.height;){t>0&&y.addPage();const n=document.createElement("canvas");n.width=m.width,n.height=Math.min(E,m.height-t);n.getContext("2d").drawImage(m,0,t,m.width,n.height,0,0,m.width,n.height);const a=n.toDataURL("image/jpeg",.95),i=n.height/m.width*z;y.addImage(a,"JPEG",v,v,z,i),y.setFontSize(9),y.setTextColor(100,100,100),y.text(`${e}/${S}`,v,8),e++,t+=E}}const $=`statistiky_${i}_${o||"vsechny"}_${(new Date).toISOString().split("T")[0]}.pdf`;y.save($)}catch(t){console.error("Chyba exportu PDF:",t),wgsToast.error("Chyba při exportu PDF: "+t.message)}}document.addEventListener("DOMContentLoaded",()=>{inicializujMultiselect(),nactiProdejce(),nactiTechniky(),nactiSummary(),nactiZakazky(),nactiCharty();const t=document.getElementById("filter-year"),e=document.getElementById("filter-month");t&&t.addEventListener("change",()=>{aktualniStranka=1,aplikovatFiltry()}),e&&e.addEventListener("change",()=>{aktualniStranka=1,aplikovatFiltry()});const n=document.querySelector('[data-action="resetovitFiltry"]'),a=document.querySelector('[data-action="exportovatPDF"]'),i=document.querySelector('[data-action="predchoziStranka"]'),o=document.querySelector('[data-action="dalsiStranka"]');n&&n.addEventListener("click",t=>{t.preventDefault(),resetovitFiltry()}),a&&a.addEventListener("click",t=>{t.preventDefault(),exportovatPDF()}),i&&i.addEventListener("click",t=>{t.preventDefault(),predchoziStranka()}),o&&o.addEventListener("click",t=>{t.preventDefault(),dalsiStranka()})}),window.aplikovatFiltry=aplikovatFiltry,window.resetovitFiltry=resetovitFiltry,window.exportovatPDF=exportovatPDF,window.predchoziStranka=predchoziStranka,window.dalsiStranka=dalsiStranka,void 0!==window.Utils&&window.Utils.registerAction&&(window.Utils.registerAction("aplikovatFiltry",()=>{aplikovatFiltry()}),window.Utils.registerAction("resetovitFiltry",()=>{resetovitFiltry()}),window.Utils.registerAction("exportovatPDF",()=>{exportovatPDF()}),window.Utils.registerAction("predchoziStranka",()=>{predchoziStranka()}),window.Utils.registerAction("dalsiStranka",()=>{dalsiStranka()}));