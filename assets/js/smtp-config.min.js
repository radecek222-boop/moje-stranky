let smtpConfigData={};function showNotification(t,e){console.log(`[${t.toUpperCase()}] ${e}`);const o=document.createElement("div");o.style.cssText="\n        position: fixed; top: 20px; right: 20px; padding: 15px 20px;\n        border-radius: 4px; color: white; font-family: sans-serif;\n        font-size: 14px; z-index: 10000; max-width: 350px;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n    ";const n={success:"#28a745",error:"#dc3545",warning:"#ffc107",info:"#17a2b8"};o.style.backgroundColor=n[t]||n.info,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.style.opacity="0",o.style.transition="opacity 0.3s",setTimeout(()=>o.remove(),300)},4e3)}async function loadSmtpConfig(){try{const t=await fetch("api/admin.php?action=get_smtp_config",{credentials:"same-origin"});if(!t.ok)throw new Error(`HTTP ${t.status}`);const e=await t.json();"success"===e.status?(smtpConfigData=e.data,document.getElementById("smtp_host").value=smtpConfigData.smtp_host||"",document.getElementById("smtp_port").value=smtpConfigData.smtp_port||"587",document.getElementById("smtp_username").value=smtpConfigData.smtp_username||"",document.getElementById("smtp_password").value=smtpConfigData.smtp_password||"",document.getElementById("smtp_encryption").value=smtpConfigData.smtp_encryption||"tls",document.getElementById("smtp_from").value=smtpConfigData.smtp_from||"reklamace@wgs-service.cz",document.getElementById("smtp_from_name").value=smtpConfigData.smtp_from_name||"White Glove Service"):(console.error("Chyba při načítání SMTP konfigurace:",e.message),showNotification("error","Chyba při načítání SMTP konfigurace: "+e.message))}catch(t){console.error("Load SMTP config error:",t),showNotification("error","Chyba při načítání SMTP konfigurace")}}async function saveSmtpConfig(){const t=await getCSRFToken(),e={smtp_host:document.getElementById("smtp_host").value.trim(),smtp_port:document.getElementById("smtp_port").value.trim(),smtp_username:document.getElementById("smtp_username").value.trim(),smtp_password:document.getElementById("smtp_password").value,smtp_encryption:document.getElementById("smtp_encryption").value,smtp_from:document.getElementById("smtp_from").value.trim(),smtp_from_name:document.getElementById("smtp_from_name").value.trim(),csrf_token:t};if(!e.smtp_host)return void showNotification("warning","Vyplňte SMTP server");if(!e.smtp_username)return void showNotification("warning","Vyplňte uživatelské jméno");const o=document.getElementById("saveSmtpBtn"),n=o.textContent;o.disabled=!0,o.textContent="Ukládání...";try{const t=await fetch("api/admin.php?action=save_smtp_config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),credentials:"same-origin"});if(!t.ok)throw new Error(`HTTP ${t.status}`);const o=await t.json();"success"===o.status?showNotification("success","SMTP konfigurace byla uložena"):showNotification("error","Chyba: "+o.message)}catch(t){console.error("Save SMTP config error:",t),showNotification("error","Chyba při ukládání SMTP konfigurace")}finally{o.disabled=!1,o.textContent=n}}async function testSmtpConnection(){const t=document.getElementById("testSmtpBtn"),e=t.textContent;t.disabled=!0,t.textContent="Testování...";try{const t=await getCSRFToken();if(!t)throw showNotification("error","CSRF token nebyl nalezen - session problém v Safari iframe"),new Error("CSRF token nebyl nalezen");const e=await fetch("api/admin.php?action=test_smtp_connection",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({csrf_token:t}),credentials:"same-origin"});if(403===e.status){const t=await e.json();throw console.error("403 Error details:",t),showNotification("error",`CSRF validace selhala: ${JSON.stringify(t.debug||{})}`),new Error(`HTTP 403 - ${t.message||"CSRF validation failed"}`)}if(!e.ok)throw new Error(`HTTP ${e.status}`);const o=await e.text();let n;try{n=JSON.parse(o)}catch(t){throw console.error("JSON parse failed:",t),console.error("Full response:",o),showNotification("error","Server vrátil neplatnou odpověď (ne JSON). Zkontrolujte konzoli pro detaily."),new Error(`Invalid JSON response: ${t.message}`)}"success"===n.status?showNotification("success",n.message):showNotification("error","Test selhal: "+n.message)}catch(t){console.error("Test SMTP error:",t),showNotification("error","Chyba při testování SMTP připojení")}finally{t.disabled=!1,t.textContent=e}}async function getCSRFToken(){let t=document.querySelector('meta[name="csrf-token"]');if(!t&&window.parent&&window.parent!==window)try{t=window.parent.document.querySelector('meta[name="csrf-token"]')}catch(t){console.warn("Cannot access parent document for CSRF token:",t)}if(!t)return console.warn("No CSRF meta tag found"),null;const e=t.getAttribute("content");return e&&"string"==typeof e&&e.length>0?String(e):null}