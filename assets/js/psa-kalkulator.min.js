let employees=[],salaryRate=150,invoiceRate=250,currentPeriod={month:11,year:2025};const API_URL="app/psa_data.php",CSRF_TOKEN=window.PSA_CSRF_TOKEN||"";function initializePeriod(){const e=new Date;currentPeriod.month=e.getMonth()+1,currentPeriod.year=e.getFullYear(),updatePeriodDisplay()}function updatePeriodDisplay(){const e=`${["","Leden","Únor","Březen","Duben","Květen","Červen","Červenec","Srpen","Září","Říjen","Listopad","Prosinec"][currentPeriod.month]} ${currentPeriod.year}`,t=document.getElementById("periodDisplayText");t&&(t.textContent=e)}function togglePeriodOverlay(){const e=document.getElementById("periodOverlay"),t=document.getElementById("periodDisplay");e.classList.contains("active")?closePeriodOverlay():(e.classList.add("active"),t.classList.add("active"),naplnitPeriodOverlay())}function closePeriodOverlay(){const e=document.getElementById("periodOverlay"),t=document.getElementById("periodDisplay");e.classList.remove("active"),t.classList.remove("active")}async function naplnitPeriodOverlay(){const e=document.getElementById("periodOverlayContent");if(e){e.innerHTML='<div class="period-loading">Načítám období...</div>';try{const t=await fetch(API_URL,{credentials:"same-origin"});if(!t.ok)throw new Error("Nepodařilo se načíst data");const a=await t.json();if("success"!==a.status||!a.data)throw new Error("Neplatná odpověď serveru");const n=a.data.periods||{},o=["","Leden","Únor","Březen","Duben","Květen","Červen","Červenec","Srpen","Září","Říjen","Listopad","Prosinec"],r=Object.keys(n).sort().reverse();if(0===r.length)return void(e.innerHTML='<div class="period-no-data">Žádná uložená období</div>');const s=`${currentPeriod.year}-${String(currentPeriod.month).padStart(2,"0")}`,i=r.map(e=>{const[t,a]=e.split("-"),r=parseInt(a),i=`${o[r]} ${t}`,d=n[e],l=d.totalHours||0,c=d.totalSalary?Math.round(d.totalSalary).toLocaleString("cs-CZ"):"0";return`\n        <div class="period-item${e===s?" current":""}" data-action="selectPeriod" data-period="${e}">\n          <div class="period-item-checkbox"></div>\n          <div class="period-item-info">\n            <div class="period-item-name">${i}</div>\n            <div class="period-item-stats">${l} hodin / ${c} Kč</div>\n          </div>\n        </div>\n      `}).join("");e.innerHTML=i}catch(t){logger.error("Chyba při načítání období pro overlay:",t),e.innerHTML='<div class="period-no-data">Chyba při načítání období</div>'}}}async function selectPeriod(e){const[t,a]=e.split("-");currentPeriod.year=parseInt(t),currentPeriod.month=parseInt(a),updatePeriodDisplay(),closePeriodOverlay(),await loadPeriod()}async function loadPeriod(){const e=`${currentPeriod.year}-${String(currentPeriod.month).padStart(2,"0")}`,t=["","Leden","Únor","Březen","Duben","Květen","Červen","Červenec","Srpen","Září","Říjen","Listopad","Prosinec"];try{const a=await fetch(API_URL,{credentials:"same-origin"});if(!a.ok)throw new Error("Nepodařilo se načíst data");const n=await a.json();if("success"!==n.status||!n.data)throw new Error("Neplatná odpověď serveru");const o=n.data;if(!o.periods||!o.periods[e])return showError(`Období ${t[currentPeriod.month]} ${currentPeriod.year} nebylo nalezeno. Nejprve uložte data pro toto období.`),employees.forEach(e=>e.hours=0),renderTable(),void updateStats();const r=o.periods[e];employees=o.employees.map(e=>{const t=r.employees.find(t=>t.id===e.id);return{...e,bank:formatBankCode(e.bank),hours:t&&t.hours||0,bonusAmount:t?t.bonusAmount||0:e.bonusAmount||0}}),renderTable(),updateStats(),showSuccess(`Načteno období: ${t[currentPeriod.month]} ${currentPeriod.year} (${r.totalHours||0} hodin)`),logger.log(`Loaded period ${e}:`,r)}catch(e){logger.error("Chyba při načítání období:",e),showError("Chyba při načítání období: "+e.message)}}function clearHours(){employees.forEach(e=>{e.hours=0,"bonus_girls"===e.type&&(e.bonusAmount=0)}),renderTable(),updateStats(),showSuccess("Hodiny vynulovány - připraveno pro nové období")}async function loadData(e=null){try{logger.log("Loading data from JSON...",e?`for period ${e}`:"");const t=await fetch(API_URL,{credentials:"same-origin"});if(!t.ok)throw new Error(`Server responded with ${t.status}`);const a=await t.json();if("success"!==a.status||!a.data)throw new Error(a.message||"Neplatná odpověď serveru");const n=a.data;if(n.config&&(salaryRate=n.config.salaryRate||150,invoiceRate=n.config.invoiceRate||250,document.getElementById("salaryRate").value=salaryRate,document.getElementById("invoiceRate").value=invoiceRate),e&&n.periods&&n.periods[e]){const t=n.periods[e];employees=n.employees.map(e=>{const a=t.employees.find(t=>t.id===e.id);return{...e,bank:formatBankCode(e.bank),hours:a&&a.hours||0,bonusAmount:e.bonusAmount||0}}),logger.log(`Loaded period ${e} with ${employees.length} employees`)}else n.employees&&(employees=n.employees.map(e=>({...e,bank:formatBankCode(e.bank),hours:e.hours||0,bonusAmount:e.bonusAmount||0}))),logger.log(`Loaded ${employees.length} employees`);renderTable(),updateStats()}catch(e){logger.error("Error loading data:",e),loadFromLocalStorage()}}async function saveData(){try{logger.log("Saving data to server..."),saveToLocalStorage(),await saveToServer(),showSuccess("Data byla úspěšně uložena")}catch(e){logger.error("Error saving data:",e),showError("Chyba při ukládání dat: "+e.message)}}async function saveToServer(){let e={};try{const t=await fetch(API_URL,{credentials:"same-origin"});if(t.ok){const a=await t.json();"success"===a.status&&a.data&&(e=a.data)}}catch(e){logger.warn("Nelze načíst existující data, vytvářím nová:",e)}const t=`${currentPeriod.year}-${String(currentPeriod.month).padStart(2,"0")}`,a=calculateStats(),n=employees.filter(e=>!1!==e.active&&e.hours>0).map(e=>({id:e.id,name:e.name,hours:e.hours||0,type:e.type||"standard",bonusAmount:e.bonusAmount||0})),o=e.periods||{};o[t]={employees:n,totalHours:a.totalHours,totalSalary:a.totalSalary,totalInvoice:a.totalInvoice,profit:a.profit,marekBonus:a.marekBonus||0,radekBonus:a.radekBonus||0,girlsBonus:a.girlsBonus||0,radekTotal:a.radekTotal||0,lastModified:(new Date).toISOString()};const r={config:{salaryRate:salaryRate,invoiceRate:invoiceRate,company:"White Glove Service",currency:"CZK"},employees:employees,periods:o,metadata:e.metadata||{version:"1.1",lastModified:(new Date).toISOString(),createdBy:"PSA Kalkulátor"}};r.metadata.lastModified=(new Date).toISOString();try{const e=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8","X-CSRF-Token":CSRF_TOKEN},credentials:"same-origin",body:JSON.stringify(r)}),a=await e.json();if(!e.ok||"success"!==a.status)throw new Error(a.message||"Nepodařilo se uložit data na server");return logger.log(`Data pro období ${t} úspěšně uložena`,a),a}catch(e){throw logger.error("Server save failed:",e),e}}function calculateStats(){let e=0,t=0,a=0,n=0;employees.forEach(o=>{if(!1===o.active)return;const r=parseFloat(o.hours)||0;"standard"===o.type||"swift"===o.type?(e+=r,t+=r*salaryRate,a+=r*invoiceRate,[12,13,14,15,16,17].includes(o.id)&&(n+=r)):"pausalni"===o.type&&o.pausalni?t+=o.pausalni.tax||0:"bonus_girls"===o.type&&(t+=parseFloat(o.bonusAmount)||0)});const o=20*e,r=n*salaryRate*.15,s=20*e,i=s+r;return t+=o+i,{totalHours:e,totalSalary:t,totalInvoice:a,profit:a-t,marekBonus:o,radekBonus:s,girlsBonus:r,radekTotal:i}}function saveToLocalStorage(){const e={employees:employees,salaryRate:salaryRate,invoiceRate:invoiceRate,period:currentPeriod,lastModified:(new Date).toISOString()};localStorage.setItem("psaData",JSON.stringify(e)),logger.log("Data saved to localStorage (backup)")}function loadFromLocalStorage(){const e=localStorage.getItem("psaData");if(e)try{const t=JSON.parse(e);employees=t.employees||[],salaryRate=t.salaryRate||150,invoiceRate=t.invoiceRate||250,t.period&&(currentPeriod=t.period,updatePeriodDisplay()),document.getElementById("salaryRate").value=salaryRate,document.getElementById("invoiceRate").value=invoiceRate,renderTable(),updateStats(),logger.log("Data loaded from localStorage")}catch(e){logger.error("Error loading from localStorage:",e)}}async function addEmployee(){const e=prompt("Zadejte jméno nového zaměstnance:");if(!e||""===e.trim())return;const t=employees.length>0?Math.max(...employees.map(e=>e.id||0))+1:1;employees.push({id:t,name:e.trim(),hours:0,bonusAmount:0,account:"",bank:"",type:"standard",active:!0}),renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Employee added and saved")}catch(e){logger.error("Failed to save after adding employee:",e)}}async function updateEmployee(e,t,a,n=!1){if("name"===t&&n){const t=employees[e].name;if(t!==a&&!await wgsConfirm(`Opravdu chcete změnit jméno z "${t}" na "${a}"?`,"Změnit","Zrušit"))return void renderTable()}employees[e][t]="hours"===t||"bonusAmount"===t?parseInt(a)||0:"bank"===t?formatBankCode(a):a,renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Employee updated and saved")}catch(e){logger.error("Failed to save after updating employee:",e)}}async function removeEmployee(e){if(await wgsConfirm(`Opravdu chcete odstranit zaměstnance ${employees[e].name}?`,"Odstranit","Zrušit")){employees.splice(e,1),renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Employee removed and saved")}catch(e){logger.error("Failed to save after removing employee:",e)}}}function renderTable(){const e=document.getElementById("employeeTableBody");if(0===employees.length)return void(e.innerHTML='<tr><td colspan="7" class="text-center" style="padding: 2rem; color: var(--c-grey);">Žádní zaměstnanci - použijte tlačítko "Přidat"</td></tr>');let t=0;employees.forEach(e=>{"special"!==e.type&&"special2"!==e.type&&(t+=e.hours||0)}),e.innerHTML=employees.map((e,a)=>{let n,o,r="",s="Lenka"===e.name||e.name.includes("Lenka");if(s)n=8716,o=0,r='<span class="employee-type-badge" style="background: var(--c-info);">Paušál 8716 Kč</span>';else if("bonus_girls"===e.type)n=e.bonusAmount||0,o=0,r='<span class="employee-type-badge" style="background: var(--c-warning);">Manuální bonus</span>';else if("pausalni"===e.type&&e.pausalni){const t=e.pausalni.rate/12,a=e.pausalni.tax;n=e.hours*salaryRate,o=Math.min(e.hours*invoiceRate,t-a),r='<span class="employee-type-badge">Paušál</span>'}else"special"===e.type||"special2"===e.type?(n=20*t,o=0,r='<span class="employee-type-badge">Pouze bonus</span>'):(n=e.hours*salaryRate,o=e.hours*invoiceRate,"swift"===e.type&&(r='<span class="employee-type-badge">SWIFT</span>'));const i="swift"===e.type&&e.swiftData?e.swiftData.iban.substr(0,10)+"...":e.account||"",d="swift"===e.type&&e.swiftData?e.swiftData.swift:formatBankCode(e.bank)||"";return`\n      <tr>\n        <td>\n          <input type="text"\n                 value="${e.name}"\n                 class="table-input"\n                 style="font-weight: 600; min-width: 150px;"\n                 data-action="updateEmployeeField"\n                 data-index="${a}"\n                 data-field="name"\n                 data-recalculate="true">\n          ${r}\n        </td>\n        <td class="text-center">\n          ${"special"===e.type||"special2"===e.type||s?'<span style="color: var(--c-grey);">–</span>':"bonus_girls"===e.type?`<input type="number"\n                     value="${e.bonusAmount||0}"\n                     min="0"\n                     step="100"\n                     class="table-input"\n                     style="width: 100px; text-align: center; font-weight: 600; background: #fff3cd;"\n                     placeholder="Částka (Kč)"\n                     data-action="updateEmployeeField"\n                     data-index="${a}"\n                     data-field="bonusAmount">`:`<input type="number"\n                     value="${e.hours}"\n                     min="0"\n                     class="table-input"\n                     style="width: 80px; text-align: center; font-weight: 600;"\n                     data-action="updateEmployeeField"\n                     data-index="${a}"\n                     data-field="hours">`}\n        </td>\n        <td class="text-right" style="font-weight: 600; color: var(--c-success);">\n          ${formatCurrency(n)}\n          ${"special"===e.type||"special2"===e.type?'<br><span style="font-size: 0.75rem; color: var(--c-grey);">'+t+"h × 20 Kč</span>":""}\n        </td>\n        <td class="text-right" style="font-weight: 600; color: var(--c-info);">\n          ${formatCurrency(o)}\n        </td>\n        <td>\n          <input type="text"\n                 value="${i}"\n                 placeholder="Číslo účtu"\n                 class="table-input"\n                 ${"swift"===e.type?"readonly":""}\n                 data-action="updateEmployeeField"\n                 data-index="${a}"\n                 data-field="account">\n        </td>\n        <td>\n          <input type="text"\n                 value="${d}"\n                 placeholder="Kód"\n                 class="table-input"\n                 style="width: 100px; text-align: center;"\n                 ${"swift"===e.type?"readonly":""}\n                 data-action="updateEmployeeField"\n                 data-index="${a}"\n                 data-field="bank">\n        </td>\n        <td class="text-center">\n          <button class="btn btn-sm" style="background: var(--c-info); color: white; margin-right: 0.25rem;" data-action="generateSingleEmployeeQR" data-index="${a}" title="Generovat QR platbu">QR</button>\n          <button class="btn btn-danger btn-sm" data-action="removeEmployee" data-index="${a}">×</button>\n        </td>\n      </tr>\n    `}).join("")}function updateStats(){let e=0,t=0,a=0,n=0;employees.forEach(t=>{"special"!==t.type&&"special2"!==t.type&&"bonus_girls"!==t.type&&(n+=t.hours||0,e+=t.hours||0)});const o=20*n;let r=0;employees.forEach(e=>{if("Lenka"===e.name||e.name.includes("Lenka"))t+=8716,a+=0;else if("bonus_girls"===e.type)t+=e.bonusAmount||0;else if(("special"===e.type||"special2"===e.type)&&o>0)t+=o;else if(e.hours>0){if("pausalni"===e.type&&e.pausalni){const n=e.pausalni.rate/12,o=e.pausalni.tax;t+=e.hours*salaryRate,a+=Math.min(e.hours*invoiceRate,n-o)}else t+=e.hours*salaryRate,a+=e.hours*invoiceRate;r++}});const s=a-t,i=a>0?s/a*100:0;document.getElementById("totalHours").textContent=formatNumber(e),document.getElementById("totalSalary").textContent=formatCurrency(t),document.getElementById("totalInvoice").textContent=formatCurrency(a),document.getElementById("employeeCount").textContent=r,document.getElementById("totalProfit").textContent=formatCurrency(s),document.getElementById("profitMargin").textContent=`Marže: ${i.toFixed(1)}%`;const d=employees.filter(e=>{const t="Lenka"===e.name||e.name.includes("Lenka");return"special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&!t&&e.hours>0}).length,l=d>0?e/d:0,c=r>0?t/r:0;document.getElementById("avgHoursPerEmployee").textContent=l.toFixed(1)+"h",document.getElementById("avgSalaryPerEmployee").textContent=formatCurrency(c),document.getElementById("salaryRateInfo").textContent=`${salaryRate} Kč/hodina`,document.getElementById("invoiceRateInfo").textContent=`${invoiceRate} Kč/hodina`,document.getElementById("footerTotalHours").textContent=formatNumber(e),document.getElementById("footerTotalSalary").textContent=formatCurrency(t),document.getElementById("footerTotalInvoice").textContent=formatCurrency(a)}async function updateRates(){salaryRate=parseInt(document.getElementById("salaryRate").value)||150,invoiceRate=parseInt(document.getElementById("invoiceRate").value)||250,renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Rates updated and saved")}catch(e){logger.error("Failed to save after updating rates:",e)}}function formatCurrency(e){return new Intl.NumberFormat("cs-CZ",{style:"currency",currency:"CZK",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function formatNumber(e){return window.Utils&&window.Utils.formatNumber?window.Utils.formatNumber(e):new Intl.NumberFormat("cs-CZ").format(e)}function formatBankCode(e){if(!e)return"";const t=e.toString().replace(/\D/g,"");return t?t.padStart(4,"0").slice(-4):""}function normalizeAccount(e){if(!e)return"";const t=e.toString().replace(/\D/g,"");if(!t)return"";const a=t.slice(-10),n=t.length>10?t.slice(0,-10):"";return n?`${parseInt(n,10)}-${a}`:a}function sanitizeMessage(e){return e?e.toString().replace(/[\r\n]+/g," ").replace(/\*/g," ").trim().slice(0,60):""}window.addEventListener("DOMContentLoaded",()=>{logger.log("PSA Kalkulátor initialized"),initializePeriod(),loadData()}),document.addEventListener("click",e=>{const t=document.getElementById("periodOverlay"),a=document.getElementById("periodDisplay");t&&t.classList.contains("active")&&(t.contains(e.target)||a.contains(e.target)||closePeriodOverlay())});let qrLibraryPromise=null;function ensureQrLibraryLoaded(){return window.QRCode&&"function"==typeof window.QRCode?Promise.resolve(window.QRCode):(qrLibraryPromise||(qrLibraryPromise=new Promise((e,t)=>{const a=document.querySelector("script[data-qr-lib]");if(a)return window.QRCode&&"function"==typeof window.QRCode?void e(window.QRCode):(a.addEventListener("load",()=>e(window.QRCode)),void a.addEventListener("error",()=>t(new Error("Nepodařilo se načíst knihovnu QR kódů"))));const n=document.createElement("script");n.src="assets/js/qrcode.min.js",n.defer=!0,n.dataset.qrLib="1",n.onload=()=>{window.QRCode&&"function"==typeof window.QRCode?e(window.QRCode):t(new Error("Knihovna QR kódu se načetla, ale neobsahuje očekávané API"))},n.onerror=()=>t(new Error("Nepodařilo se načíst knihovnu QR kódů")),document.head.appendChild(n)}).catch(e=>{throw qrLibraryPromise=null,e})),qrLibraryPromise)}function buildSpaydPayload(e){const t=normalizeAccount(e.account),a=formatBankCode(e.bank),n=Number(e.amount);if(!t||!a)throw new Error("Chybí číslo účtu nebo kód banky");if(!Number.isFinite(n)||n<=0)throw new Error("Neplatná částka");const o=e.vs?String(e.vs).replace(/\D/g,"").slice(0,10):"",r=sanitizeMessage(e.message||""),s=["SPD","1.0",`ACC:${t}/${a}`,`AM:${n.toFixed(2)}`,"CC:CZK"];return o&&s.push(`X-VS:${o}`),r&&s.push(`MSG:${r}`),s.join("*")}async function renderQrCode(e,t,a,n=""){if(await ensureQrLibraryLoaded(),!window.QRCode||"function"!=typeof window.QRCode)throw new Error("Knihovna pro QR kódy není načtena");return new Promise((o,r)=>{try{e.innerHTML="",new QRCode(e,{text:t,width:a,height:a,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}),logger.log("QR code generated"+(n?" for "+n:"")),o()}catch(t){logger.error(`Failed to generate QR code${n?" for "+n:""}:`,t),e.innerHTML='<div style="color: red; padding: 20px;">Chyba generování QR kódu</div>',r(t)}})}function showSuccess(e){wgsToast.success(e)}function showError(e){wgsToast.error(e)}function exportToExcel(){let e="\ufeff";const t=document.getElementById("periodDisplay").textContent;e+=`PSA KALKULÁTOR - ${t}\n\n`,e+="Jméno;Hodiny;Výplata (Kč);Faktura (Kč);Číslo účtu;Kód banky;Typ\n";let a=0;employees.forEach(e=>{"special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&(a+=e.hours||0)}),employees.forEach(t=>{let n,o;"Lenka"===t.name||t.name.includes("Lenka")?(n=8716,o=0):"bonus_girls"===t.type?(n=t.bonusAmount||0,o=0):"pausalni"===t.type&&t.pausalni?(n=t.hours*salaryRate,o=Math.min(t.hours*invoiceRate,t.pausalni.rate/12-t.pausalni.tax)):"special"===t.type||"special2"===t.type?(n=20*a,o=0):(n=t.hours*salaryRate,o=t.hours*invoiceRate);const r="bonus_girls"===t.type?`${t.bonusAmount||0} Kč`:t.hours||0;e+=`${t.name};${r};${n};${o};${t.account||""};${t.bank||""};${t.type||"standard"}\n`});const n=employees.reduce((e,t)=>"special"===t.type||"special2"===t.type||"bonus_girls"===t.type?e:e+(t.hours||0),0),o=employees.reduce((e,t)=>"Lenka"===t.name||t.name.includes("Lenka")?e+8716:"bonus_girls"===t.type?e+(t.bonusAmount||0):"special"===t.type||"special2"===t.type?e+20*a:e+t.hours*salaryRate,0),r=employees.reduce((e,t)=>{if("special"===t.type||"special2"===t.type||"bonus_girls"===t.type)return e;return"Lenka"===t.name||t.name.includes("Lenka")?e:e+t.hours*invoiceRate},0);e+=`\nCELKEM;${n};${o};${r};;;`,e+=`\n\nSazba výplaty: ${salaryRate} Kč/hodina`,e+=`\nSazba fakturace: ${invoiceRate} Kč/hodina`,e+=`\nZisk: ${r-o} Kč`;const s=new Blob([e],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(s),d=document.createElement("a");d.href=i,d.download=`PSA_${currentPeriod.year}_${String(currentPeriod.month).padStart(2,"0")}.csv`,d.click(),URL.revokeObjectURL(i)}function printReport(){window.print()}async function clearAll(){if(await wgsConfirm("Opravdu chcete vymazat všechna data?","Vymazat vše","Zrušit")){employees=[],renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("All data cleared and saved")}catch(e){logger.error("Failed to save after clearing data:",e)}}}function synchronizovatVstupy(){document.querySelectorAll('[data-action="updateEmployeeField"]').forEach(e=>{const t=parseInt(e.getAttribute("data-index")),a=e.getAttribute("data-field");!isNaN(t)&&a&&employees[t]&&(employees[t][a]="hours"===a||"bonusAmount"===a?parseInt(e.value)||0:"bank"===a?formatBankCode(e.value):e.value)}),updateStats()}function generatePaymentQR(){synchronizovatVstupy();const e=document.getElementById("qrModal"),t=document.getElementById("qrCodesContainer"),a=document.getElementById("paymentSummary");t.innerHTML="",a.innerHTML="";let n=0,o=0,r=0,s=[],i=[],d=0;employees.forEach(e=>{"special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&(d+=e.hours||0)});const l=20*d;employees.forEach(e=>{const t="Lenka"===e.name||e.name.includes("Lenka");if(t||"bonus_girls"===e.type||"special"===e.type||"special2"===e.type||e.hours>0){let a=0;a=t?8716:"bonus_girls"===e.type?e.bonusAmount||0:"pausalni"===e.type&&e.pausalni?e.hours*salaryRate:"special"===e.type||"special2"===e.type?l:e.hours*salaryRate;const d=["Stana","Anastasia","Maryna","Ivana","Olha","Piven Tetiana","Vitalina","Tetiana","Kataryna","Ruslana"];if(!t&&e.hours>0&&d.some(t=>e.name.includes(t))){const t=e.hours*salaryRate*.1;o+=t}"swift"===e.type&&e.swiftData?i.push({name:e.name,amount:a,swiftData:e.swiftData}):"Radek"===e.name?r=a:e.account&&e.bank&&s.push({name:e.name,amount:a,account:e.account,bank:formatBankCode(e.bank)}),n+=a}});const c=employees.find(e=>"Radek"===e.name);if(c&&c.account&&c.bank){const e=r+o;s.push({name:"Radek",amount:e,displayAmount:r,realAmount:e,account:c.account,bank:formatBankCode(c.bank),isSpecial:!0})}if(a.innerHTML=`\n    <div class="summary-row">\n      <span>Počet domácích plateb:</span>\n      <span>${s.length}</span>\n    </div>\n    <div class="summary-row">\n      <span>Počet SWIFT plateb:</span>\n      <span>${i.length}</span>\n    </div>\n    <div class="summary-row">\n      <span>Základní výplaty:</span>\n      <span>${formatCurrency(n)}</span>\n    </div>\n    ${o>0?`\n    <div class="summary-row" style="color: var(--c-grey); font-size: 0.85rem;">\n      <span>Skryté prémie (→ Radek):</span>\n      <span>${formatCurrency(o)}</span>\n    </div>`:""}\n    <div class="summary-row">\n      <span>CELKEM K VÝPLATĚ:</span>\n      <span>${formatCurrency(n+o)}</span>\n    </div>\n  `,i.length>0){const e=document.createElement("div");e.innerHTML='<h3 style="margin: 2rem 0 1rem; padding-top: 1rem; border-top: 1px solid var(--c-border);">SWIFT platby (poplatky: OUR)</h3>',t.appendChild(e),i.forEach((e,a)=>{const n=document.createElement("div");n.className="qr-item",n.style.background="rgba(0,0,0,0.02)",n.innerHTML=`\n        <div class="qr-employee-name">${e.name}</div>\n        <div class="qr-amount">${formatCurrency(e.amount)}</div>\n        <div style="font-size: 0.75rem; color: var(--c-grey); margin: 0.5rem 0;">Mezinárodní SWIFT platba</div>\n        <div style="text-align: left; font-size: 0.8rem; padding: 1rem; background: white; border: 1px solid var(--c-border); margin: 1rem 0;">\n          <div><strong>IBAN:</strong> ${e.swiftData.iban}</div>\n          <div><strong>SWIFT/BIC:</strong> ${e.swiftData.swift}</div>\n          <div><strong>Banka:</strong> ${e.swiftData.bankName}</div>\n          <div><strong>Adresa banky:</strong> ${e.swiftData.bankAddress}</div>\n          <div><strong>Příjemce:</strong> ${e.swiftData.beneficiary}</div>\n          <div style="color: var(--c-error); margin-top: 0.5rem;">\n            <strong>Poplatky: OUR</strong> (všechny poplatky hradí odesílatel)\n          </div>\n        </div>\n        <button class="btn btn-sm" data-action="copySWIFTDetails" data-name="${e.name}" data-iban="${e.swiftData.iban}" data-swift="${e.swiftData.swift}" data-amount="${e.amount}">\n          Kopírovat údaje\n        </button>\n      `,t.appendChild(n)})}if(s.length>0){const e=document.createElement("div");e.innerHTML='\n      <h3 style="margin: 2rem 0 1rem; padding-top: 1rem; border-top: 1px solid var(--c-border);">Domácí platby (QR kódy)</h3>\n      <div class="qr-grid" id="domesticPaymentsGrid"></div>\n    ',t.appendChild(e);const a=e.querySelector("#domesticPaymentsGrid");s.forEach((e,t)=>{const n=document.createElement("div");n.className="qr-item";const o=e.displayAmount||e.amount,r=e.realAmount||e.amount;n.innerHTML=`\n        <div class="qr-employee-name">${e.name}</div>\n        <div class="qr-amount">${formatCurrency(o)}</div>\n        ${e.isSpecial?'<div style="font-size: 0.75rem; color: var(--c-success);">Včetně prémií</div>':""}\n        <div class="qr-account">${e.account}/${e.bank}</div>\n        <div class="qr-code-wrapper" id="qr-${t}"></div>\n        <button class="btn btn-sm" style="margin-top: 1rem;" data-action="downloadQR" data-qrid="qr-${t}" data-name="${e.name}">\n          Stáhnout QR\n        </button>\n      `,a.appendChild(n),setTimeout(async()=>{const a=document.getElementById(`qr-${t}`);if(!a)return void logger.error(`QR element not found: qr-${t}`);let n;a.innerHTML="";try{n=generateCzechPaymentString({account:e.account,bank:e.bank,amount:r,vs:100*currentPeriod.year+currentPeriod.month,message:`Výplata ${e.name} ${currentPeriod.month}/${currentPeriod.year}`})}catch(e){return void(a.innerHTML=`<div style="color: red; padding: 20px;">${e.message}</div>`)}logger.log(`Generating QR for ${e.name}:`,n);try{await renderQrCode(a,n,180,e.name)}catch(t){logger.error(`Failed to generate QR code for ${e.name}:`,t),a.innerHTML='<div style="color: red; padding: 20px;">Chyba generování QR kódu</div>'}},100*t)})}e.classList.remove("hidden")}function generateCzechPaymentString(e){return buildSpaydPayload(e)}function copySWIFTDetails(e,t,a,n){const o=`SWIFT platba - ${e}\nIBAN: ${t}\nSWIFT/BIC: ${a}\nČástka: ${formatCurrency(n)}\nPoplatky: OUR (hradí odesílatel)\nZpráva: Výplata ${e} ${currentPeriod.month}/${currentPeriod.year}`;navigator.clipboard.writeText(o).then(()=>{wgsToast.success("SWIFT údaje byly zkopírovány do schránky")}).catch(e=>{logger.error("Chyba při kopírování:",e),wgsToast.error("Nepodařilo se zkopírovat údaje")})}function downloadQR(e,t){const a=document.querySelector(`#${e} img`),n=document.querySelector(`#${e} canvas`),o=document.createElement("a");o.download=`QR_platba_${t}_${currentPeriod.month}_${currentPeriod.year}.png`,a&&a.src?(o.href=a.src,o.click()):n?(o.href=n.toDataURL(),o.click()):wgsToast.error("QR kód nenalezen")}function closeQRModal(){document.getElementById("qrModal").classList.add("hidden")}function generateSingleEmployeeQR(e){synchronizovatVstupy();const t=employees[e];if(!t)return void wgsToast.error("Zaměstnanec nenalezen");const a=document.getElementById("qrModal"),n=document.getElementById("qrCodesContainer"),o=document.getElementById("paymentSummary");n.innerHTML="",o.innerHTML="";let r=0;employees.forEach(e=>{"special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&(r+=e.hours||0)});let s=0,i="Lenka"===t.name||t.name.includes("Lenka");if(s=i?8716:"bonus_girls"===t.type?t.bonusAmount||0:"pausalni"===t.type&&t.pausalni?t.hours*salaryRate:"special"===t.type||"special2"===t.type?20*r:t.hours*salaryRate,s<=0)return void wgsToast.warning("Částka k výplatě je 0 Kč. Zadejte prosím hodiny nebo nastavte mzdu.");if("swift"===t.type&&t.swiftData){o.innerHTML=`\n      <h3>SWIFT platba</h3>\n      <div class="summary-row">\n        <span>Zaměstnanec:</span>\n        <span>${t.name}</span>\n      </div>\n      <div class="summary-row">\n        <span>Částka:</span>\n        <span>${formatCurrency(s)}</span>\n      </div>\n    `;const e=document.createElement("div");return e.className="qr-item",e.style.background="rgba(0,0,0,0.02)",e.innerHTML=`\n      <div class="qr-employee-name">${t.name}</div>\n      <div class="qr-amount">${formatCurrency(s)}</div>\n      <div style="font-size: 0.75rem; color: var(--c-grey); margin: 0.5rem 0;">Mezinárodní SWIFT platba</div>\n      <div style="text-align: left; font-size: 0.8rem; padding: 1rem; background: white; border: 1px solid var(--c-border); margin: 1rem 0;">\n        <div><strong>IBAN:</strong> ${t.swiftData.iban}</div>\n        <div><strong>SWIFT/BIC:</strong> ${t.swiftData.swift}</div>\n        <div><strong>Banka:</strong> ${t.swiftData.bankName}</div>\n        <div><strong>Adresa banky:</strong> ${t.swiftData.bankAddress}</div>\n        <div><strong>Příjemce:</strong> ${t.swiftData.beneficiary}</div>\n        <div style="color: var(--c-error); margin-top: 0.5rem;">\n          <strong>Poplatky: OUR</strong> (všechny poplatky hradí odesílatel)\n        </div>\n      </div>\n      <button class="btn btn-sm" data-action="copySWIFTDetails" data-name="${t.name}" data-iban="${t.swiftData.iban}" data-swift="${t.swiftData.swift}" data-amount="${s}">\n        Kopírovat údaje\n      </button>\n    `,n.appendChild(e),void a.classList.remove("hidden")}if(!t.account||!t.bank)return void wgsToast.warning("Prosím zadejte číslo účtu a kód banky pro "+t.name);o.innerHTML=`\n    <h3>Platba pro zaměstnance</h3>\n    <div class="summary-row">\n      <span>Zaměstnanec:</span>\n      <span>${t.name}</span>\n    </div>\n    <div class="summary-row">\n      <span>Částka k výplatě:</span>\n      <span>${formatCurrency(s)}</span>\n    </div>\n    ${i?'<div class="summary-row" style="color: var(--c-info); font-size: 0.85rem;"><span>Paušální mzda</span><span>8716 Kč/měsíc</span></div>':""}\n  `;const d=document.createElement("div");d.className="qr-item",d.innerHTML=`\n    <div class="qr-employee-name">${t.name}</div>\n    <div class="qr-amount">${formatCurrency(s)}</div>\n    ${i?'<div style="font-size: 0.75rem; color: var(--c-info);">Paušální mzda</div>':""}\n    <div class="qr-account">${t.account}/${formatBankCode(t.bank)}</div>\n    <div class="qr-code-wrapper" id="qr-single"></div>\n    <button class="btn btn-sm" style="margin-top: 1rem;" data-action="downloadQR" data-qrid="qr-single" data-name="${t.name}">\n      Stáhnout QR\n    </button>\n  `,n.appendChild(d),setTimeout(async()=>{const e=document.getElementById("qr-single");if(!e)return void logger.error("QR element not found: qr-single");let a;e.innerHTML="";try{a=generateCzechPaymentString({account:t.account,bank:formatBankCode(t.bank),amount:s,vs:100*currentPeriod.year+currentPeriod.month,message:`Výplata ${t.name} ${currentPeriod.month}/${currentPeriod.year}`})}catch(t){return void(e.innerHTML=`<div style="color: red; padding: 20px;">${t.message}</div>`)}logger.log(`Generating single QR for ${t.name}:`,a);try{await renderQrCode(e,a,220,t.name)}catch(a){logger.error(`Failed to generate QR code for ${t.name}:`,a),e.innerHTML='<div style="color: red; padding: 20px;">Chyba generování QR kódu</div>'}},100),a.classList.remove("hidden")}window.onclick=function(e){const t=document.getElementById("qrModal");e.target==t&&t.classList.add("hidden")},document.addEventListener("DOMContentLoaded",()=>{function e(e){const t=e.getAttribute("data-action");if("reload"!==t){switch(t){case"generateSingleEmployeeQR":const t=e.getAttribute("data-index");return void(null!==t&&"function"==typeof generateSingleEmployeeQR&&generateSingleEmployeeQR(parseInt(t)));case"removeEmployee":const a=e.getAttribute("data-index");return void(null!==a&&"function"==typeof removeEmployee&&removeEmployee(parseInt(a)));case"copySWIFTDetails":const n=e.getAttribute("data-name"),o=e.getAttribute("data-iban"),r=e.getAttribute("data-swift"),s=parseFloat(e.getAttribute("data-amount"));return void(n&&o&&r&&"function"==typeof copySWIFTDetails&&copySWIFTDetails(n,o,r,s));case"downloadQR":const i=e.getAttribute("data-qrid"),d=e.getAttribute("data-name");return void(i&&d&&"function"==typeof downloadQR&&downloadQR(i,d));case"updateEmployeeField":const l=parseInt(e.getAttribute("data-index")),c=e.getAttribute("data-field"),u="true"===e.getAttribute("data-recalculate");return void(!isNaN(l)&&c&&"function"==typeof updateEmployee&&updateEmployee(l,c,e.value,u));case"saveData":return void("function"==typeof saveData&&saveData());case"addEmployee":return void("function"==typeof addEmployee&&addEmployee());case"exportToExcel":return void("function"==typeof exportToExcel&&exportToExcel());case"printReport":return void("function"==typeof printReport&&printReport());case"clearAll":return void("function"==typeof clearAll&&clearAll());case"generatePaymentQR":return void("function"==typeof generatePaymentQR&&generatePaymentQR());case"closeQRModal":return void("function"==typeof closeQRModal&&closeQRModal());case"updatePeriod":return void("function"==typeof updatePeriod&&updatePeriod());case"updateRates":return void("function"==typeof updateRates&&updateRates());case"togglePeriodOverlay":return void("function"==typeof togglePeriodOverlay&&togglePeriodOverlay());case"closePeriodOverlay":return void("function"==typeof closePeriodOverlay&&closePeriodOverlay());case"selectPeriod":const p=e.getAttribute("data-period");return void(p&&"function"==typeof selectPeriod&&selectPeriod(p));case"loadPeriod":return void("function"==typeof loadPeriod&&loadPeriod());case"clearHours":return void("function"==typeof clearHours&&clearHours())}"function"==typeof window[t]&&window[t]()}else location.reload()}document.addEventListener("click",t=>{const a=t.target.closest("[data-action]");a&&"INPUT"!==a.tagName&&"TEXTAREA"!==a.tagName&&e(a)}),document.addEventListener("change",t=>{const a=t.target.closest("[data-action]");a&&e(a)}),document.addEventListener("keydown",t=>{if("Enter"!==t.key&&" "!==t.key)return;const a=t.target.closest("[data-action]");a&&"BUTTON"!==a.tagName&&"button"===a.getAttribute("role")&&(t.preventDefault(),e(a))}),document.addEventListener("click",e=>{const t=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");t&&("function"==typeof navigateTo?navigateTo(t):location.href=t)}),document.addEventListener("change",e=>{const t=e.target.closest("[data-onchange]");if(!t)return;const a=t.getAttribute("data-onchange"),n=t.getAttribute("data-onchange-value")||t.value;"function"==typeof window[a]&&window[a](n)})});