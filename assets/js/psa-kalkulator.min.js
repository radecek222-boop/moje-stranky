let employees=[],salaryRate=150,invoiceRate=250,currentPeriod={month:11,year:2025};const API_URL="app/psa_data.php",CSRF_TOKEN=window.PSA_CSRF_TOKEN||"";function initializePeriod(){const e=new Date;currentPeriod.month=e.getMonth()+1,currentPeriod.year=e.getFullYear();const t=document.getElementById("monthSelect"),n=document.getElementById("yearSelect");t&&(t.value=currentPeriod.month),n&&(n.value=currentPeriod.year),updatePeriodDisplay()}function updatePeriod(){currentPeriod.month=parseInt(document.getElementById("monthSelect").value),currentPeriod.year=parseInt(document.getElementById("yearSelect").value),updatePeriodDisplay();loadData(`${currentPeriod.year}-${String(currentPeriod.month).padStart(2,"0")}`)}function updatePeriodDisplay(){const e=`${["","Leden","Únor","Březen","Duben","Květen","Červen","Červenec","Srpen","Září","Říjen","Listopad","Prosinec"][currentPeriod.month]} ${currentPeriod.year}`;document.getElementById("periodDisplay").textContent=e}async function loadData(e=null){try{logger.log("Loading data from JSON...",e?`for period ${e}`:"");const t=await fetch(API_URL,{credentials:"same-origin"});if(!t.ok)throw new Error(`Server responded with ${t.status}`);const n=await t.json();if("success"!==n.status||!n.data)throw new Error(n.message||"Neplatná odpověď serveru");const a=n.data;if(a.config&&(salaryRate=a.config.salaryRate||150,invoiceRate=a.config.invoiceRate||250,document.getElementById("salaryRate").value=salaryRate,document.getElementById("invoiceRate").value=invoiceRate),e&&a.periods&&a.periods[e]){const t=a.periods[e];employees=a.employees.map(e=>{const n=t.employees.find(t=>t.id===e.id);return{...e,bank:formatBankCode(e.bank),hours:n&&n.hours||0,bonusAmount:e.bonusAmount||0}}),logger.log(`Loaded period ${e} with ${employees.length} employees`)}else a.employees&&(employees=a.employees.map(e=>({...e,bank:formatBankCode(e.bank),hours:e.hours||0,bonusAmount:e.bonusAmount||0}))),logger.log(`Loaded ${employees.length} employees`);renderTable(),updateStats()}catch(e){logger.error("Error loading data:",e),loadFromLocalStorage()}}async function saveData(){try{logger.log("Saving data to server..."),saveToLocalStorage(),await saveToServer(),showSuccess("Data byla úspěšně uložena")}catch(e){logger.error("Error saving data:",e),showError("Chyba při ukládání dat: "+e.message)}}async function saveToServer(){const e={config:{salaryRate:salaryRate,invoiceRate:invoiceRate,company:"White Glove Service",currency:"CZK"},employees:employees};try{const t=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8","X-CSRF-Token":CSRF_TOKEN},credentials:"same-origin",body:JSON.stringify(e)}),n=await t.json();if(!t.ok||"success"!==n.status)throw new Error(n.message||"Nepodařilo se uložit data na server");return logger.log("Data saved to server successfully",n),n}catch(e){throw logger.error("Server save failed:",e),e}}function saveToLocalStorage(){const e={employees:employees,salaryRate:salaryRate,invoiceRate:invoiceRate,period:currentPeriod,lastModified:(new Date).toISOString()};localStorage.setItem("psaData",JSON.stringify(e)),logger.log("Data saved to localStorage (backup)")}function loadFromLocalStorage(){const e=localStorage.getItem("psaData");if(e)try{const t=JSON.parse(e);employees=t.employees||[],salaryRate=t.salaryRate||150,invoiceRate=t.invoiceRate||250,t.period&&(currentPeriod=t.period,document.getElementById("monthSelect").value=currentPeriod.month,document.getElementById("yearSelect").value=currentPeriod.year,updatePeriodDisplay()),document.getElementById("salaryRate").value=salaryRate,document.getElementById("invoiceRate").value=invoiceRate,renderTable(),updateStats(),logger.log("Data loaded from localStorage")}catch(e){logger.error("Error loading from localStorage:",e)}}async function addEmployee(){const e=prompt("Zadejte jméno nového zaměstnance:");if(!e||""===e.trim())return;const t=employees.length>0?Math.max(...employees.map(e=>e.id||0))+1:1;employees.push({id:t,name:e.trim(),hours:0,bonusAmount:0,account:"",bank:"",type:"standard",active:!0}),renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Employee added and saved")}catch(e){logger.error("Failed to save after adding employee:",e)}}async function updateEmployee(e,t,n,a=!1){if("name"===t&&a){const t=employees[e].name;if(t!==n&&!confirm(`Opravdu chcete změnit jméno z "${t}" na "${n}"?`))return void renderTable()}employees[e][t]="hours"===t||"bonusAmount"===t?parseInt(n)||0:"bank"===t?formatBankCode(n):n,renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Employee updated and saved")}catch(e){logger.error("Failed to save after updating employee:",e)}}async function removeEmployee(e){if(confirm(`Opravdu chcete odstranit zaměstnance ${employees[e].name}?`)){employees.splice(e,1),renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Employee removed and saved")}catch(e){logger.error("Failed to save after removing employee:",e)}}}function renderTable(){const e=document.getElementById("employeeTableBody");if(0===employees.length)return void(e.innerHTML='<tr><td colspan="7" class="text-center" style="padding: 2rem; color: var(--c-grey);">Žádní zaměstnanci - použijte tlačítko "Přidat"</td></tr>');let t=0;employees.forEach(e=>{"special"!==e.type&&"special2"!==e.type&&(t+=e.hours||0)}),e.innerHTML=employees.map((e,n)=>{let a,o,r="",s="Lenka"===e.name||e.name.includes("Lenka");if(s)a=8716,o=0,r='<span class="employee-type-badge" style="background: var(--c-info);">Paušál 8716 Kč</span>';else if("bonus_girls"===e.type)a=e.bonusAmount||0,o=0,r='<span class="employee-type-badge" style="background: var(--c-warning);">Manuální bonus</span>';else if("pausalni"===e.type&&e.pausalni){const t=e.pausalni.rate/12,n=e.pausalni.tax;a=e.hours*salaryRate,o=Math.min(e.hours*invoiceRate,t-n),r='<span class="employee-type-badge">Paušál</span>'}else"special"===e.type||"special2"===e.type?(a=20*t,o=0,r='<span class="employee-type-badge">Pouze bonus</span>'):(a=e.hours*salaryRate,o=e.hours*invoiceRate,"swift"===e.type&&(r='<span class="employee-type-badge">SWIFT</span>'));const i="swift"===e.type&&e.swiftData?e.swiftData.iban.substr(0,10)+"...":e.account||"",l="swift"===e.type&&e.swiftData?e.swiftData.swift:formatBankCode(e.bank)||"";return`\n      <tr>\n        <td>\n          <input type="text"\n                 value="${e.name}"\n                 class="table-input"\n                 style="font-weight: 600; min-width: 150px;"\n                 onchange="updateEmployee(${n}, 'name', this.value, true)">\n          ${r}\n        </td>\n        <td class="text-center">\n          ${"special"===e.type||"special2"===e.type||s?'<span style="color: var(--c-grey);">–</span>':"bonus_girls"===e.type?`<input type="number"\n                     value="${e.bonusAmount||0}"\n                     min="0"\n                     step="100"\n                     class="table-input"\n                     style="width: 100px; text-align: center; font-weight: 600; background: #fff3cd;"\n                     placeholder="Částka (Kč)"\n                     onchange="updateEmployee(${n}, 'bonusAmount', this.value)">`:`<input type="number"\n                     value="${e.hours}"\n                     min="0"\n                     class="table-input"\n                     style="width: 80px; text-align: center; font-weight: 600;"\n                     onchange="updateEmployee(${n}, 'hours', this.value)">`}\n        </td>\n        <td class="text-right" style="font-weight: 600; color: var(--c-success);">\n          ${formatCurrency(a)}\n          ${"special"===e.type||"special2"===e.type?'<br><span style="font-size: 0.75rem; color: var(--c-grey);">'+t+"h × 20 Kč</span>":""}\n        </td>\n        <td class="text-right" style="font-weight: 600; color: var(--c-info);">\n          ${formatCurrency(o)}\n        </td>\n        <td>\n          <input type="text"\n                 value="${i}"\n                 placeholder="Číslo účtu"\n                 class="table-input"\n                 ${"swift"===e.type?"readonly":""}\n                 onchange="updateEmployee(${n}, 'account', this.value)">\n        </td>\n        <td>\n          <input type="text"\n                 value="${l}"\n                 placeholder="Kód"\n                 class="table-input"\n                 style="width: 100px; text-align: center;"\n                 ${"swift"===e.type?"readonly":""}\n                 onchange="updateEmployee(${n}, 'bank', this.value)">\n        </td>\n        <td class="text-center">\n          <button class="btn btn-sm" style="background: var(--c-info); color: white; margin-right: 0.25rem;" data-action="generateSingleEmployeeQR" data-index="${n}" title="Generovat QR platbu">QR</button>\n          <button class="btn btn-danger btn-sm" data-action="removeEmployee" data-index="${n}">×</button>\n        </td>\n      </tr>\n    `}).join("")}function updateStats(){let e=0,t=0,n=0,a=0;employees.forEach(t=>{"special"!==t.type&&"special2"!==t.type&&"bonus_girls"!==t.type&&(a+=t.hours||0,e+=t.hours||0)});const o=20*a;let r=0;employees.forEach(e=>{if("Lenka"===e.name||e.name.includes("Lenka"))t+=8716,n+=0;else if("bonus_girls"===e.type)t+=e.bonusAmount||0;else if(("special"===e.type||"special2"===e.type)&&o>0)t+=o;else if(e.hours>0){if("pausalni"===e.type&&e.pausalni){const a=e.pausalni.rate/12,o=e.pausalni.tax;t+=e.hours*salaryRate,n+=Math.min(e.hours*invoiceRate,a-o)}else t+=e.hours*salaryRate,n+=e.hours*invoiceRate;r++}});const s=n-t,i=n>0?s/n*100:0;document.getElementById("totalHours").textContent=formatNumber(e),document.getElementById("totalSalary").textContent=formatCurrency(t),document.getElementById("totalInvoice").textContent=formatCurrency(n),document.getElementById("employeeCount").textContent=r,document.getElementById("totalProfit").textContent=formatCurrency(s),document.getElementById("profitMargin").textContent=`Marže: ${i.toFixed(1)}%`;const l=employees.filter(e=>{const t="Lenka"===e.name||e.name.includes("Lenka");return"special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&!t&&e.hours>0}).length,d=l>0?e/l:0,c=r>0?t/r:0;document.getElementById("avgHoursPerEmployee").textContent=d.toFixed(1)+"h",document.getElementById("avgSalaryPerEmployee").textContent=formatCurrency(c),document.getElementById("salaryRateInfo").textContent=`${salaryRate} Kč/hodina`,document.getElementById("invoiceRateInfo").textContent=`${invoiceRate} Kč/hodina`,document.getElementById("footerTotalHours").textContent=formatNumber(e),document.getElementById("footerTotalSalary").textContent=formatCurrency(t),document.getElementById("footerTotalInvoice").textContent=formatCurrency(n)}async function updateRates(){salaryRate=parseInt(document.getElementById("salaryRate").value)||150,invoiceRate=parseInt(document.getElementById("invoiceRate").value)||250,renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Rates updated and saved")}catch(e){logger.error("Failed to save after updating rates:",e)}}function setQuickRate(e){if(!e)return;const[t,n]=e.split("-").map(Number);document.getElementById("salaryRate").value=t,document.getElementById("invoiceRate").value=n,updateRates()}function formatCurrency(e){return new Intl.NumberFormat("cs-CZ",{style:"currency",currency:"CZK",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function formatNumber(e){return new Intl.NumberFormat("cs-CZ").format(e)}function formatBankCode(e){if(!e)return"";const t=e.toString().replace(/\D/g,"");return t?t.padStart(4,"0").slice(-4):""}function normalizeAccount(e){if(!e)return"";const t=e.toString().replace(/\D/g,"");if(!t)return"";const n=t.slice(-10),a=t.length>10?t.slice(0,-10):"";return a?`${parseInt(a,10)}-${n}`:n}function sanitizeMessage(e){return e?e.toString().replace(/[\r\n]+/g," ").replace(/\*/g," ").trim().slice(0,60):""}window.addEventListener("DOMContentLoaded",()=>{logger.log("PSA Kalkulátor initialized"),initializePeriod(),loadData()});let qrLibraryPromise=null;function ensureQrLibraryLoaded(){return window.QRCode&&"function"==typeof QRCode.toCanvas?Promise.resolve(window.QRCode):(qrLibraryPromise||(qrLibraryPromise=new Promise((e,t)=>{const n=document.querySelector("script[data-qr-lib]");if(n)return window.QRCode&&"function"==typeof QRCode.toCanvas?void e(window.QRCode):(n.addEventListener("load",()=>e(window.QRCode)),void n.addEventListener("error",()=>t(new Error("Nepodařilo se načíst knihovnu QR kódů"))));const a=document.createElement("script");a.src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js",a.defer=!0,a.dataset.qrLib="1",a.onload=()=>{window.QRCode&&"function"==typeof QRCode.toCanvas?e(window.QRCode):t(new Error("Knihovna QR kódu se načetla, ale neobsahuje očekávané API"))},a.onerror=()=>t(new Error("Nepodařilo se načíst knihovnu QR kódů")),document.head.appendChild(a)}).catch(e=>{throw qrLibraryPromise=null,e})),qrLibraryPromise)}function buildSpaydPayload(e){const t=normalizeAccount(e.account),n=formatBankCode(e.bank),a=Number(e.amount);if(!t||!n)throw new Error("Chybí číslo účtu nebo kód banky");if(!Number.isFinite(a)||a<=0)throw new Error("Neplatná částka");const o=e.vs?String(e.vs).replace(/\D/g,"").slice(0,10):"",r=sanitizeMessage(e.message||""),s=["SPD","1.0",`ACC:${t}/${n}`,`AM:${a.toFixed(2)}`,"CC:CZK"];return o&&s.push(`X-VS:${o}`),r&&s.push(`MSG:${r}`),s.join("*")}async function renderQrCode(e,t,n,a=""){if(await ensureQrLibraryLoaded(),!window.QRCode||"function"!=typeof QRCode.toCanvas)throw new Error("Knihovna pro QR kódy není načtena");const o=r=>new Promise((s,i)=>{const l=document.createElement("canvas");QRCode.toCanvas(l,t,{width:n,height:n,margin:1,errorCorrectionLevel:r},t=>{if(t){const n=/overflow/i.test(t.message||"");return"M"===r&&n?(logger.warn(`QR payload příliš dlouhý${a?" ("+a+")":""}, zkouším nižší úroveň korekce (L)`),o("L").then(s).catch(i)):(logger.error(`Failed to generate QR code${a?" for "+a:""}:`,t),e.innerHTML='<div style="color: red; padding: 20px;">Chyba generování QR kódu</div>',void i(t))}e.innerHTML="",e.appendChild(l),s()})});await o("M")}function showSuccess(e){alert(e)}function showError(e){alert(e)}function exportToExcel(){let e="\ufeff";const t=document.getElementById("periodDisplay").textContent;e+=`PSA KALKULÁTOR - ${t}\n\n`,e+="Jméno;Hodiny;Výplata (Kč);Faktura (Kč);Číslo účtu;Kód banky;Typ\n";let n=0;employees.forEach(e=>{"special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&(n+=e.hours||0)}),employees.forEach(t=>{let a,o;"Lenka"===t.name||t.name.includes("Lenka")?(a=8716,o=0):"bonus_girls"===t.type?(a=t.bonusAmount||0,o=0):"pausalni"===t.type&&t.pausalni?(a=t.hours*salaryRate,o=Math.min(t.hours*invoiceRate,t.pausalni.rate/12-t.pausalni.tax)):"special"===t.type||"special2"===t.type?(a=20*n,o=0):(a=t.hours*salaryRate,o=t.hours*invoiceRate);const r="bonus_girls"===t.type?`${t.bonusAmount||0} Kč`:t.hours||0;e+=`${t.name};${r};${a};${o};${t.account||""};${t.bank||""};${t.type||"standard"}\n`});const a=employees.reduce((e,t)=>"special"===t.type||"special2"===t.type||"bonus_girls"===t.type?e:e+(t.hours||0),0),o=employees.reduce((e,t)=>"Lenka"===t.name||t.name.includes("Lenka")?e+8716:"bonus_girls"===t.type?e+(t.bonusAmount||0):"special"===t.type||"special2"===t.type?e+20*n:e+t.hours*salaryRate,0),r=employees.reduce((e,t)=>{if("special"===t.type||"special2"===t.type||"bonus_girls"===t.type)return e;return"Lenka"===t.name||t.name.includes("Lenka")?e:e+t.hours*invoiceRate},0);e+=`\nCELKEM;${a};${o};${r};;;`,e+=`\n\nSazba výplaty: ${salaryRate} Kč/hodina`,e+=`\nSazba fakturace: ${invoiceRate} Kč/hodina`,e+=`\nZisk: ${r-o} Kč`;const s=new Blob([e],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(s),l=document.createElement("a");l.href=i,l.download=`PSA_${currentPeriod.year}_${String(currentPeriod.month).padStart(2,"0")}.csv`,l.click(),URL.revokeObjectURL(i)}function printReport(){window.print()}async function clearAll(){if(confirm("Opravdu chcete vymazat všechna data?")){employees=[],renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("All data cleared and saved")}catch(e){logger.error("Failed to save after clearing data:",e)}}}function generatePaymentQR(){const e=document.getElementById("qrModal"),t=document.getElementById("qrCodesContainer"),n=document.getElementById("paymentSummary");t.innerHTML="",n.innerHTML="";let a=0,o=0,r=0,s=[],i=[],l=0;employees.forEach(e=>{"special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&(l+=e.hours||0)});const d=20*l;employees.forEach(e=>{const t="Lenka"===e.name||e.name.includes("Lenka");if(t||"bonus_girls"===e.type||"special"===e.type||"special2"===e.type||e.hours>0){let n=0;n=t?8716:"bonus_girls"===e.type?e.bonusAmount||0:"pausalni"===e.type&&e.pausalni?e.hours*salaryRate:"special"===e.type||"special2"===e.type?d:e.hours*salaryRate;const l=["Stana","Anastasia","Maryna","Ivana","Olha","Piven Tetiana","Vitalina","Tetiana","Kataryna","Ruslana"];if(!t&&e.hours>0&&l.some(t=>e.name.includes(t))){const t=e.hours*salaryRate*.1;o+=t}"swift"===e.type&&e.swiftData?i.push({name:e.name,amount:n,swiftData:e.swiftData}):"Radek"===e.name?r=n:e.account&&e.bank&&s.push({name:e.name,amount:n,account:e.account,bank:formatBankCode(e.bank)}),a+=n}});const c=employees.find(e=>"Radek"===e.name);if(c&&c.account&&c.bank){const e=r+o;s.push({name:"Radek",amount:e,displayAmount:r,realAmount:e,account:c.account,bank:formatBankCode(c.bank),isSpecial:!0})}if(n.innerHTML=`\n    <div class="summary-row">\n      <span>Počet domácích plateb:</span>\n      <span>${s.length}</span>\n    </div>\n    <div class="summary-row">\n      <span>Počet SWIFT plateb:</span>\n      <span>${i.length}</span>\n    </div>\n    <div class="summary-row">\n      <span>Základní výplaty:</span>\n      <span>${formatCurrency(a)}</span>\n    </div>\n    ${o>0?`\n    <div class="summary-row" style="color: var(--c-grey); font-size: 0.85rem;">\n      <span>Skryté prémie (→ Radek):</span>\n      <span>${formatCurrency(o)}</span>\n    </div>`:""}\n    <div class="summary-row">\n      <span>CELKEM K VÝPLATĚ:</span>\n      <span>${formatCurrency(a+o)}</span>\n    </div>\n  `,i.length>0){const e=document.createElement("div");e.innerHTML='<h3 style="margin: 2rem 0 1rem; padding-top: 1rem; border-top: 1px solid var(--c-border);">SWIFT platby (poplatky: OUR)</h3>',t.appendChild(e),i.forEach((e,n)=>{const a=document.createElement("div");a.className="qr-item",a.style.background="rgba(0,0,0,0.02)",a.innerHTML=`\n        <div class="qr-employee-name">${e.name}</div>\n        <div class="qr-amount">${formatCurrency(e.amount)}</div>\n        <div style="font-size: 0.75rem; color: var(--c-grey); margin: 0.5rem 0;">Mezinárodní SWIFT platba</div>\n        <div style="text-align: left; font-size: 0.8rem; padding: 1rem; background: white; border: 1px solid var(--c-border); margin: 1rem 0;">\n          <div><strong>IBAN:</strong> ${e.swiftData.iban}</div>\n          <div><strong>SWIFT/BIC:</strong> ${e.swiftData.swift}</div>\n          <div><strong>Banka:</strong> ${e.swiftData.bankName}</div>\n          <div><strong>Adresa banky:</strong> ${e.swiftData.bankAddress}</div>\n          <div><strong>Příjemce:</strong> ${e.swiftData.beneficiary}</div>\n          <div style="color: var(--c-error); margin-top: 0.5rem;">\n            <strong>Poplatky: OUR</strong> (všechny poplatky hradí odesílatel)\n          </div>\n        </div>\n        <button class="btn btn-sm" data-action="copySWIFTDetails" data-name="${e.name}" data-iban="${e.swiftData.iban}" data-swift="${e.swiftData.swift}" data-amount="${e.amount}">\n          Kopírovat údaje\n        </button>\n      `,t.appendChild(a)})}if(s.length>0){const e=document.createElement("div");e.innerHTML='\n      <h3 style="margin: 2rem 0 1rem; padding-top: 1rem; border-top: 1px solid var(--c-border);">Domácí platby (QR kódy)</h3>\n      <div class="qr-grid" id="domesticPaymentsGrid"></div>\n    ',t.appendChild(e);const n=e.querySelector("#domesticPaymentsGrid");s.forEach((e,t)=>{const a=document.createElement("div");a.className="qr-item";const o=e.displayAmount||e.amount,r=e.realAmount||e.amount;a.innerHTML=`\n        <div class="qr-employee-name">${e.name}</div>\n        <div class="qr-amount">${formatCurrency(o)}</div>\n        ${e.isSpecial?'<div style="font-size: 0.75rem; color: var(--c-success);">Včetně prémií</div>':""}\n        <div class="qr-account">${e.account}/${e.bank}</div>\n        <div class="qr-code-wrapper" id="qr-${t}"></div>\n        <button class="btn btn-sm" style="margin-top: 1rem;" data-action="downloadQR" data-qrid="qr-${t}" data-name="${e.name}">\n          Stáhnout QR\n        </button>\n      `,n.appendChild(a),setTimeout(async()=>{const n=document.getElementById(`qr-${t}`);if(!n)return void logger.error(`QR element not found: qr-${t}`);let a;n.innerHTML="";try{a=generateCzechPaymentString({account:e.account,bank:e.bank,amount:r,vs:100*currentPeriod.year+currentPeriod.month,message:`Výplata ${e.name} ${currentPeriod.month}/${currentPeriod.year}`})}catch(e){return void(n.innerHTML=`<div style="color: red; padding: 20px;">${e.message}</div>`)}logger.log(`Generating QR for ${e.name}:`,a);try{await renderQrCode(n,a,180,e.name)}catch(t){logger.error(`Failed to generate QR code for ${e.name}:`,t),n.innerHTML='<div style="color: red; padding: 20px;">Chyba generování QR kódu</div>'}},100*t)})}e.style.display="block"}function generateCzechPaymentString(e){return buildSpaydPayload(e)}function copySWIFTDetails(e,t,n,a){const o=`SWIFT platba - ${e}\nIBAN: ${t}\nSWIFT/BIC: ${n}\nČástka: ${formatCurrency(a)}\nPoplatky: OUR (hradí odesílatel)\nZpráva: Výplata ${e} ${currentPeriod.month}/${currentPeriod.year}`;navigator.clipboard.writeText(o).then(()=>{alert("SWIFT údaje byly zkopírovány do schránky")}).catch(e=>{logger.error("Chyba při kopírování:",e),alert("Nepodařilo se zkopírovat údaje")})}function downloadQR(e,t){const n=document.querySelector(`#${e} canvas`);if(n){const e=document.createElement("a");e.download=`QR_platba_${t}_${currentPeriod.month}_${currentPeriod.year}.png`,e.href=n.toDataURL(),e.click()}}function closeQRModal(){document.getElementById("qrModal").style.display="none"}function generateSingleEmployeeQR(e){const t=employees[e];if(!t)return void alert("Zaměstnanec nenalezen");const n=document.getElementById("qrModal"),a=document.getElementById("qrCodesContainer"),o=document.getElementById("paymentSummary");a.innerHTML="",o.innerHTML="";let r=0;employees.forEach(e=>{"special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&(r+=e.hours||0)});let s=0,i="Lenka"===t.name||t.name.includes("Lenka");if(s=i?8716:"bonus_girls"===t.type?t.bonusAmount||0:"pausalni"===t.type&&t.pausalni?t.hours*salaryRate:"special"===t.type||"special2"===t.type?20*r:t.hours*salaryRate,s<=0)return void alert("Částka k výplatě je 0 Kč. Zadejte prosím hodiny nebo nastavte mzdu.");if("swift"===t.type&&t.swiftData){o.innerHTML=`\n      <h3>SWIFT platba</h3>\n      <div class="summary-row">\n        <span>Zaměstnanec:</span>\n        <span>${t.name}</span>\n      </div>\n      <div class="summary-row">\n        <span>Částka:</span>\n        <span>${formatCurrency(s)}</span>\n      </div>\n    `;const e=document.createElement("div");return e.className="qr-item",e.style.background="rgba(0,0,0,0.02)",e.innerHTML=`\n      <div class="qr-employee-name">${t.name}</div>\n      <div class="qr-amount">${formatCurrency(s)}</div>\n      <div style="font-size: 0.75rem; color: var(--c-grey); margin: 0.5rem 0;">Mezinárodní SWIFT platba</div>\n      <div style="text-align: left; font-size: 0.8rem; padding: 1rem; background: white; border: 1px solid var(--c-border); margin: 1rem 0;">\n        <div><strong>IBAN:</strong> ${t.swiftData.iban}</div>\n        <div><strong>SWIFT/BIC:</strong> ${t.swiftData.swift}</div>\n        <div><strong>Banka:</strong> ${t.swiftData.bankName}</div>\n        <div><strong>Adresa banky:</strong> ${t.swiftData.bankAddress}</div>\n        <div><strong>Příjemce:</strong> ${t.swiftData.beneficiary}</div>\n        <div style="color: var(--c-error); margin-top: 0.5rem;">\n          <strong>Poplatky: OUR</strong> (všechny poplatky hradí odesílatel)\n        </div>\n      </div>\n      <button class="btn btn-sm" data-action="copySWIFTDetails" data-name="${t.name}" data-iban="${t.swiftData.iban}" data-swift="${t.swiftData.swift}" data-amount="${s}">\n        Kopírovat údaje\n      </button>\n    `,a.appendChild(e),void(n.style.display="block")}if(!t.account||!t.bank)return void alert("Prosím zadejte číslo účtu a kód banky pro "+t.name);o.innerHTML=`\n    <h3>Platba pro zaměstnance</h3>\n    <div class="summary-row">\n      <span>Zaměstnanec:</span>\n      <span>${t.name}</span>\n    </div>\n    <div class="summary-row">\n      <span>Částka k výplatě:</span>\n      <span>${formatCurrency(s)}</span>\n    </div>\n    ${i?'<div class="summary-row" style="color: var(--c-info); font-size: 0.85rem;"><span>Paušální mzda</span><span>8716 Kč/měsíc</span></div>':""}\n  `;const l=document.createElement("div");l.className="qr-item",l.innerHTML=`\n    <div class="qr-employee-name">${t.name}</div>\n    <div class="qr-amount">${formatCurrency(s)}</div>\n    ${i?'<div style="font-size: 0.75rem; color: var(--c-info);">Paušální mzda</div>':""}\n    <div class="qr-account">${t.account}/${formatBankCode(t.bank)}</div>\n    <div class="qr-code-wrapper" id="qr-single"></div>\n    <button class="btn btn-sm" style="margin-top: 1rem;" data-action="downloadQR" data-qrid="qr-single" data-name="${t.name}">\n      Stáhnout QR\n    </button>\n  `,a.appendChild(l),setTimeout(async()=>{const e=document.getElementById("qr-single");if(!e)return void logger.error("QR element not found: qr-single");let n;e.innerHTML="";try{n=generateCzechPaymentString({account:t.account,bank:formatBankCode(t.bank),amount:s,vs:100*currentPeriod.year+currentPeriod.month,message:`Výplata ${t.name} ${currentPeriod.month}/${currentPeriod.year}`})}catch(t){return void(e.innerHTML=`<div style="color: red; padding: 20px;">${t.message}</div>`)}logger.log(`Generating single QR for ${t.name}:`,n);try{await renderQrCode(e,n,220,t.name)}catch(n){logger.error(`Failed to generate QR code for ${t.name}:`,n),e.innerHTML='<div style="color: red; padding: 20px;">Chyba generování QR kódu</div>'}},100),n.style.display="block"}window.onclick=function(e){const t=document.getElementById("qrModal");e.target==t&&(t.style.display="none")},document.addEventListener("DOMContentLoaded",()=>{function e(e){const t=e.getAttribute("data-action");if("reload"!==t){switch(t){case"generateSingleEmployeeQR":const t=e.getAttribute("data-index");return void(null!==t&&"function"==typeof generateSingleEmployeeQR&&generateSingleEmployeeQR(parseInt(t)));case"removeEmployee":const n=e.getAttribute("data-index");return void(null!==n&&"function"==typeof removeEmployee&&removeEmployee(parseInt(n)));case"copySWIFTDetails":const a=e.getAttribute("data-name"),o=e.getAttribute("data-iban"),r=e.getAttribute("data-swift"),s=parseFloat(e.getAttribute("data-amount"));return void(a&&o&&r&&"function"==typeof copySWIFTDetails&&copySWIFTDetails(a,o,r,s));case"downloadQR":const i=e.getAttribute("data-qrid"),l=e.getAttribute("data-name");return void(i&&l&&"function"==typeof downloadQR&&downloadQR(i,l))}"function"==typeof window[t]&&window[t]()}else location.reload()}document.addEventListener("click",t=>{const n=t.target.closest("[data-action]");n&&e(n)}),document.addEventListener("keydown",t=>{if("Enter"!==t.key&&" "!==t.key)return;const n=t.target.closest("[data-action]");n&&"BUTTON"!==n.tagName&&"button"===n.getAttribute("role")&&(t.preventDefault(),e(n))}),document.addEventListener("click",e=>{const t=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");t&&("function"==typeof navigateTo?navigateTo(t):location.href=t)}),document.addEventListener("change",e=>{const t=e.target.closest("[data-onchange]");if(!t)return;const n=t.getAttribute("data-onchange"),a=t.getAttribute("data-onchange-value")||t.value;"function"==typeof window[n]&&window[n](a)})});