console.log("PSA Kalkulátor script loading...");let employees=[],allEmployeesDatabase=[],salaryRate=150,invoiceRate=250,currentPeriod={month:11,year:2025};const API_URL="/app/psa_data.php",CSRF_TOKEN=window.PSA_CSRF_TOKEN||"",PERMANENT_EMPLOYEE_IDS=[19,20,21,22];window.addEventListener("DOMContentLoaded",()=>{console.log("DOMContentLoaded fired");try{logger.log("PSA Kalkulátor initialized"),initializePeriod(),loadData()}catch(e){console.error("Init error:",e)}});const MONTHS_CZ=["","Leden","Únor","Březen","Duben","Květen","Červen","Červenec","Srpen","Září","Říjen","Listopad","Prosinec"],MONTHS_CZ_UPPER=["","LEDEN","ÚNOR","BŘEZEN","DUBEN","KVĚTEN","ČERVEN","ČERVENEC","SRPEN","ZÁŘÍ","ŘÍJEN","LISTOPAD","PROSINEC"];function initializePeriod(){const e=new Date;e.setMonth(e.getMonth()-1),currentPeriod.month=e.getMonth()+1,currentPeriod.year=e.getFullYear(),updatePeriodDisplay(),updateNewAttendanceMonth()}function updatePeriodDisplay(){const e=`${MONTHS_CZ[currentPeriod.month]} ${currentPeriod.year}`,t=document.getElementById("periodDisplayText");t&&(t.textContent=e),updateFooterMonth()}function updateNewAttendanceMonth(){const e=(new Date).getMonth()+1,t=document.getElementById("newAttendanceMonth");t&&(t.textContent=MONTHS_CZ_UPPER[e]||"NOVÝ")}function updateFooterMonth(){const e=document.getElementById("footerMonthLabel");e&&(e.textContent=`CELKEM za ${MONTHS_CZ[currentPeriod.month]}`)}async function newAttendance(){const e=new Date,t=e.getMonth()+1,a=e.getFullYear();currentPeriod.month!==t||currentPeriod.year!==a?(currentPeriod.month=t,currentPeriod.year=a,updatePeriodDisplay(),await loadData(),showSuccess(`Nová docházka za ${MONTHS_CZ[t]} ${a}`),logger.log(`Switched to new attendance period: ${t}/${a}`)):wgsToast.info(`Už jste v období ${MONTHS_CZ[t]} ${a}`)}function togglePeriodOverlay(){const e=document.getElementById("periodOverlay"),t=document.getElementById("periodDisplay");e.classList.contains("active")?closePeriodOverlay():(e.classList.add("active"),t.classList.add("active"),naplnitPeriodOverlay())}function closePeriodOverlay(){const e=document.getElementById("periodOverlay"),t=document.getElementById("periodDisplay");e.classList.remove("active"),t.classList.remove("active")}function showNewPeriodSelector(){closePeriodOverlay();const e=new Date,t=e.getMonth()+1,a=e.getFullYear(),o=document.createElement("div");o.className="new-period-modal active",o.id="newPeriodModal";const n=MONTHS_CZ.map((e,a)=>{if(0===a)return"";return`<option value="${a}" ${a===t?"selected":""}>${e}</option>`}).join(""),r=[];for(let e=a-3;e<=a+2;e++){const t=e===a?"selected":"";r.push(`<option value="${e}" ${t}>${e}</option>`)}o.innerHTML=`\n    <div class="new-period-dialog">\n      <div class="new-period-header">\n        <span>Přidat nové období</span>\n        <button class="new-period-close" data-action="closeNewPeriodSelector" title="Zavřít">&times;</button>\n      </div>\n      <div class="new-period-body">\n        <div class="new-period-row">\n          <div class="new-period-field">\n            <label for="newPeriodMonth">Měsíc</label>\n            <select id="newPeriodMonth">\n              ${n}\n            </select>\n          </div>\n          <div class="new-period-field">\n            <label for="newPeriodYear">Rok</label>\n            <select id="newPeriodYear">\n              ${r.join("")}\n            </select>\n          </div>\n        </div>\n        <div class="new-period-info">\n          Nové období bude obsahovat pouze permanentní zaměstnance (Marek, Lenka, Radek, Prémie). Další zaměstnance můžete přidat ručně.\n        </div>\n      </div>\n      <div class="new-period-footer">\n        <button class="btn btn-secondary" data-action="closeNewPeriodSelector">Zrušit</button>\n        <button class="btn" data-action="confirmNewPeriod">Vytvořit období</button>\n      </div>\n    </div>\n  `,document.body.appendChild(o),o.addEventListener("click",e=>{e.target===o&&closeNewPeriodSelector()});const s=e=>{"Escape"===e.key&&(closeNewPeriodSelector(),document.removeEventListener("keydown",s))};document.addEventListener("keydown",s)}function closeNewPeriodSelector(){const e=document.getElementById("newPeriodModal");e&&e.remove()}async function confirmNewPeriod(){const e=document.getElementById("newPeriodMonth"),t=document.getElementById("newPeriodYear");if(!e||!t)return void wgsToast.error("Chyba při načítání hodnot");const a=parseInt(e.value),o=parseInt(t.value);if(!a||!o)return void wgsToast.error("Vyberte měsíc a rok");const n=`${o}-${String(a).padStart(2,"0")}`;try{const e=await fetch(API_URL,{credentials:"same-origin"}),t=await e.json();if("success"===t.status&&t.data&&t.data.periods&&t.data.periods[n])return void(await wgsConfirm(`Období ${MONTHS_CZ[a]} ${o} již existuje. Chcete se na něj přepnout?`,{titulek:"Období existuje",btnPotvrdit:"Přepnout"})&&(closeNewPeriodSelector(),currentPeriod.month=a,currentPeriod.year=o,updatePeriodDisplay(),await loadPeriod(),showSuccess(`Přepnuto na ${MONTHS_CZ[a]} ${o}`)))}catch(e){logger.error("Chyba při kontrole období:",e)}closeNewPeriodSelector(),currentPeriod.month=a,currentPeriod.year=o,updatePeriodDisplay(),employees=allEmployeesDatabase.filter(e=>PERMANENT_EMPLOYEE_IDS.includes(e.id)).map(e=>({...e,bank:formatBankCode(e.bank),hours:0,bonusAmount:0,premieCastka:0})),renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),showSuccess(`Vytvořeno nové období: ${MONTHS_CZ[a]} ${o}`),logger.log(`Created new period ${n} with permanent employees only`)}catch(e){logger.error("Chyba při ukládání nového období:",e),wgsToast.error("Chyba při ukládání období")}}async function naplnitPeriodOverlay(){const e=document.getElementById("periodOverlayContent");if(e){e.innerHTML='<div class="period-loading">Načítám období...</div>';try{const t=await fetch(API_URL,{credentials:"same-origin"});if(!t.ok)throw new Error("Nepodařilo se načíst data");const a=await t.json();if("success"!==a.status||!a.data)throw new Error("Neplatná odpověď serveru");const o=a.data.periods||{},n=Object.keys(o).sort().reverse();if(0===n.length)return void(e.innerHTML='<div class="period-no-data">Žádná uložená období</div>');const r=`${currentPeriod.year}-${String(currentPeriod.month).padStart(2,"0")}`,s=n.map(e=>{const[t,a]=e.split("-"),n=parseInt(a),s=`${MONTHS_CZ[n]} ${t}`,i=o[e],l=i.totalHours||0,d=i.totalSalary?Math.round(i.totalSalary).toLocaleString("cs-CZ"):"0";return`\n        <div class="period-item${e===r?" current":""}" data-action="selectPeriod" data-period="${e}">\n          <div class="period-item-checkbox"></div>\n          <div class="period-item-info">\n            <div class="period-item-name">${s}</div>\n            <div class="period-item-stats">${l} hodin / ${d} Kč</div>\n          </div>\n        </div>\n      `}).join("");e.innerHTML=s}catch(t){logger.error("Chyba při načítání období pro overlay:",t),e.innerHTML='<div class="period-no-data">Chyba při načítání období</div>'}}}async function selectPeriod(e){const[t,a]=e.split("-");currentPeriod.year=parseInt(t),currentPeriod.month=parseInt(a),updatePeriodDisplay(),closePeriodOverlay(),await loadPeriod()}async function loadPeriod(){const e=`${currentPeriod.year}-${String(currentPeriod.month).padStart(2,"0")}`;try{const t=await fetch(API_URL,{credentials:"same-origin"});if(!t.ok)throw new Error("Nepodařilo se načíst data");const a=await t.json();if("success"!==a.status||!a.data)throw new Error("Neplatná odpověď serveru");const o=a.data;if(!o.periods||!o.periods[e])return showError(`Období ${MONTHS_CZ[currentPeriod.month]} ${currentPeriod.year} nebylo nalezeno. Nejprve uložte data pro toto období.`),employees.forEach(e=>e.hours=0),renderTable(),void updateStats();const n=o.periods[e];allEmployeesDatabase=o.employees.map(e=>({...e,bank:formatBankCode(e.bank)})),employees=o.employees.filter(e=>{const t=n.employees.find(t=>t.id===e.id);return!!PERMANENT_EMPLOYEE_IDS.includes(e.id)||t&&t.hours>0}).map(e=>{const t=n.employees.find(t=>t.id===e.id);return{...e,account:t&&t.account?t.account:e.account||"",bank:formatBankCode(t&&t.bank?t.bank:e.bank||""),hours:t&&t.hours||0,bonusAmount:t?t.bonusAmount||0:e.bonusAmount||0,premieCastka:t&&t.premieCastka||0}}),renderTable(),updateStats(),showSuccess(`Načteno období: ${MONTHS_CZ[currentPeriod.month]} ${currentPeriod.year} (${n.totalHours||0} hodin)`),logger.log(`Loaded period ${e}:`,n)}catch(e){logger.error("Chyba při načítání období:",e),showError("Chyba při načítání období: "+e.message)}}function clearHours(){employees.forEach(e=>{e.hours=0,"bonus_girls"===e.type&&(e.bonusAmount=0)}),renderTable(),updateStats(),showSuccess("Hodiny vynulovány - připraveno pro nové období")}async function loadData(e=null){try{logger.log("Loading data from JSON...",e?`for period ${e}`:"");const t=await fetch(API_URL,{credentials:"same-origin"});if(!t.ok)throw new Error(`Server responded with ${t.status}`);const a=await t.json();if("success"!==a.status||!a.data)throw new Error(a.message||"Neplatná odpověď serveru");const o=a.data;if(o.employees&&o.employees.length>0)allEmployeesDatabase=o.employees.map(e=>({...e,bank:formatBankCode(e.bank)})),logger.log("loadData: allEmployeesDatabase loaded with",allEmployeesDatabase.length,"employees");else if(logger.warn("loadData: data.employees is empty, trying fallback from periods..."),o.periods){const e=Object.keys(o.periods).sort().reverse();if(e.length>0){const t=o.periods[e[0]];t&&t.employees&&t.employees.length>0&&(allEmployeesDatabase=t.employees.map(e=>({...e,bank:formatBankCode(e.bank||"")})),logger.log("loadData: FALLBACK - loaded",allEmployeesDatabase.length,"employees from period",e[0]))}}o.config&&(salaryRate=o.config.salaryRate||150,invoiceRate=o.config.invoiceRate||250,document.getElementById("salaryRate").value=salaryRate,document.getElementById("invoiceRate").value=invoiceRate);const n=e||`${currentPeriod.year}-${String(currentPeriod.month).padStart(2,"0")}`;if(o.periods&&o.periods[n]){const e=o.periods[n];employees=o.employees.filter(t=>{const a=e.employees.find(e=>e.id===t.id);return!!PERMANENT_EMPLOYEE_IDS.includes(t.id)||a&&a.hours>0}).map(t=>{const a=e.employees.find(e=>e.id===t.id);return{...t,account:a&&a.account?a.account:t.account||"",bank:formatBankCode(a&&a.bank?a.bank:t.bank||""),hours:a&&a.hours||0,bonusAmount:a?a.bonusAmount||0:t.bonusAmount||0,premieCastka:a&&a.premieCastka||0}}),logger.log(`Loaded period ${n} with ${employees.length} employees`)}else employees=o.employees.filter(e=>PERMANENT_EMPLOYEE_IDS.includes(e.id)).map(e=>({...e,bank:formatBankCode(e.bank),hours:0,bonusAmount:0,premieCastka:0})),logger.log(`New period ${n} - showing only permanent employees`);renderTable(),updateStats()}catch(e){logger.error("Error loading data:",e),loadFromLocalStorage()}}async function saveData(){try{logger.log("Saving data to server..."),saveToLocalStorage(),await saveToServer(),showSuccess("Data byla úspěšně uložena")}catch(e){logger.error("Error saving data:",e),showError("Chyba při ukládání dat: "+e.message)}}async function saveToServer(){const e=calculateStats(),t=employees.filter(e=>!1!==e.active).map(e=>({id:e.id,name:e.name,hours:e.hours||0,type:e.type||"standard",bonusAmount:e.bonusAmount||0,premieCastka:e.premieCastka||0,account:e.account||"",bank:e.bank||""})),a=allEmployeesDatabase.length>0?allEmployeesDatabase:employees,o={config:{salaryRate:salaryRate,invoiceRate:invoiceRate},employees:a,periodData:{year:currentPeriod.year,month:currentPeriod.month,employees:t,totalHours:e.totalHours,totalSalary:e.totalSalary,totalInvoice:e.totalInvoice,profit:e.profit,marekBonus:e.marekBonus||0,radekBonus:e.radekBonus||0,girlsBonus:e.girlsBonus||0,radekTotal:e.radekTotal||0,premieCelkem:e.premieCelkem||0}};try{const e=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8","X-CSRF-Token":CSRF_TOKEN},credentials:"same-origin",body:JSON.stringify(o)}),t=await e.json();if(!e.ok||"success"!==t.status)throw new Error(t.message||"Nepodařilo se uložit data na server");const a=`${currentPeriod.year}-${String(currentPeriod.month).padStart(2,"0")}`;return logger.log(`Data pro období ${a} úspěšně uložena do SQL`,t),t}catch(e){throw logger.error("Server save failed:",e),e}}function calculateStats(){let e=0,t=0,a=0,o=0;employees.forEach(e=>{if(!1!==e.active&&"special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&"premie_polozka"!==e.type){"Lenka"===e.name||e.name.includes("Lenka")||(o+=parseFloat(e.hours)||0)}}),employees.forEach(n=>{if(!1===n.active)return;const r="Lenka"===n.name||n.name.includes("Lenka");let s=0,i=0;if(r)s=void 0!==n.bonusAmount?parseFloat(n.bonusAmount)||0:8716,i=0;else if("bonus_girls"===n.type)s=parseFloat(n.bonusAmount)||0,i=0;else if("special"===n.type||"special2"===n.type)s=20*o,i=0;else if("premie_polozka"===n.type)s=parseFloat(n.premieCastka)||0,i=0;else if("pausalni"===n.type&&n.pausalni){const e=parseFloat(n.hours)||0,t=n.pausalni.rate/12,a=n.pausalni.tax;s=e*salaryRate,i=Math.min(e*invoiceRate,t-a)}else{const e=parseFloat(n.hours)||0;s=e*salaryRate,i=e*invoiceRate}t+=s,a+=i,"special"===n.type||"special2"===n.type||"bonus_girls"===n.type||"premie_polozka"===n.type||r||(e+=parseFloat(n.hours)||0)});const n=20*o,r=20*o,s=employees.filter(e=>"premie_polozka"===e.type).reduce((e,t)=>e+(parseFloat(t.premieCastka)||0),0);return{totalHours:e,totalSalary:t,totalInvoice:a,profit:a-t,marekBonus:n,radekBonus:r,girlsBonus:0,radekTotal:r,premieCelkem:s}}function saveToLocalStorage(){const e={employees:employees,salaryRate:salaryRate,invoiceRate:invoiceRate,period:currentPeriod,lastModified:(new Date).toISOString()};localStorage.setItem("psaData",JSON.stringify(e)),logger.log("Data saved to localStorage (backup)")}function loadFromLocalStorage(){const e=localStorage.getItem("psaData");if(e)try{const t=JSON.parse(e);employees=t.employees||[],salaryRate=t.salaryRate||150,invoiceRate=t.invoiceRate||250,t.period&&(currentPeriod=t.period,updatePeriodDisplay()),document.getElementById("salaryRate").value=salaryRate,document.getElementById("invoiceRate").value=invoiceRate,renderTable(),updateStats(),logger.log("Data loaded from localStorage")}catch(e){logger.error("Error loading from localStorage:",e)}}function addEmployee(){showEmployeeSelector()}async function showEmployeeSelector(){if(logger.log("showEmployeeSelector started, allEmployeesDatabase.length =",allEmployeesDatabase.length),0===allEmployeesDatabase.length){logger.log("allEmployeesDatabase is empty, trying to reload data...");try{await loadData(),logger.log("After loadData, allEmployeesDatabase.length =",allEmployeesDatabase.length)}catch(e){logger.error("Failed to reload data:",e)}}const e=employees.map(e=>e.id),t=["special","special2","pausalni","premie_polozka"],a=allEmployeesDatabase.filter(e=>!PERMANENT_EMPLOYEE_IDS.includes(e.id)&&!t.includes(e.type));if(logger.log("Employee selector - allEmployeesDatabase:",allEmployeesDatabase.length,"allAvailable:",a.length),0===a.length)return void wgsToast.info("Žádní zaměstnanci v databázi - zkontrolujte přihlášení");const o=document.createElement("div");o.className="modal",o.id="employeeSelectorModal",o.innerHTML=`\n    <div class="modal-content" style="max-width: 500px; background: #1a1a1a; border: 1px solid #333; color: #ccc;">\n      <div style="background: #333; padding: 1rem 1.5rem; display: flex; justify-content: center; align-items: center; position: relative; border-bottom: 1px solid #444;">\n        <h2 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: #fff;">Vybrat zaměstnance</h2>\n        <span class="close-modal" data-action="closeEmployeeSelector" style="position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%); font-size: 2rem; cursor: pointer; color: #fff; opacity: 0.7;">&times;</span>\n      </div>\n      <div style="padding: 1rem 1.5rem; border-bottom: 1px solid #444; display: flex; gap: 1rem;">\n        <button class="btn btn-sm" data-action="selectAllEmployees" style="background: #333; color: #ccc; border: 1px solid #444;">Vybrat vše</button>\n        <button class="btn btn-sm" data-action="deselectAllEmployees" style="background: transparent; color: #ccc; border: 1px solid #444;">Zrušit výběr</button>\n      </div>\n      <div style="padding: 1rem 1.5rem; max-height: 400px; overflow-y: auto;">\n        ${a.map(t=>{const a=e.includes(t.id);return`\n            <label style="display: flex; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; border: 1px solid #444; border-radius: 4px; cursor: pointer; background: ${a?"#2a2a2a":"#222"}; ${a?"opacity: 0.5;":""}" ${a?'title="Už je v seznamu"':""}>\n              <input type="checkbox"\n                     name="selectedEmployee"\n                     value="${t.id}"\n                     ${a?"disabled checked":""}\n                     style="width: 18px; height: 18px; margin-right: 0.75rem; accent-color: #fff;">\n              <div style="flex: 1;">\n                <div style="font-weight: 600; color: #fff;">${t.name}</div>\n                <div style="font-size: 0.8rem; color: #888;">\n                  ${t.account?t.account+"/"+t.bank:"Bez účtu"}\n                  ${"swift"===t.type?" (SWIFT)":""}\n                </div>\n              </div>\n              ${a?'<span style="font-size: 0.75rem; color: #666;">v seznamu</span>':""}\n            </label>\n          `}).join("")}\n      </div>\n      <div style="padding: 1rem 1.5rem; border-top: 1px solid #444; display: flex; justify-content: space-between; align-items: center; background: #222;">\n        <span style="font-size: 0.85rem; color: #888;">Vybráno: <strong id="selectedCount" style="color: #fff;">0</strong></span>\n        <div>\n          <button class="btn" data-action="closeEmployeeSelector" style="background: transparent; color: #ccc; border: 1px solid #444;">Zrušit</button>\n          <button class="btn" data-action="confirmEmployeeSelection" style="margin-left: 0.5rem; background: #333; color: #fff; border: 1px solid #444;">Přidat vybrané</button>\n        </div>\n      </div>\n    </div>\n  `,document.body.appendChild(o),o.style.display="block",updateSelectedCount(),o.querySelectorAll('input[name="selectedEmployee"]').forEach(e=>{e.addEventListener("change",updateSelectedCount)})}function updateSelectedCount(){const e=document.getElementById("employeeSelectorModal");if(!e)return;const t=e.querySelectorAll('input[name="selectedEmployee"]:checked:not(:disabled)').length,a=e.querySelector("#selectedCount");a&&(a.textContent=t)}function selectAllEmployees(){const e=document.getElementById("employeeSelectorModal");e&&(e.querySelectorAll('input[name="selectedEmployee"]:not(:disabled)').forEach(e=>{e.checked=!0}),updateSelectedCount())}function deselectAllEmployees(){const e=document.getElementById("employeeSelectorModal");e&&(e.querySelectorAll('input[name="selectedEmployee"]:not(:disabled)').forEach(e=>{e.checked=!1}),updateSelectedCount())}function closeEmployeeSelector(){const e=document.getElementById("employeeSelectorModal");e&&e.remove()}async function confirmEmployeeSelection(){const e=document.getElementById("employeeSelectorModal");if(!e)return;const t=Array.from(e.querySelectorAll('input[name="selectedEmployee"]:checked:not(:disabled)')).map(e=>parseInt(e.value));if(0!==t.length){t.forEach(e=>{const t=allEmployeesDatabase.find(t=>t.id===e);t&&!employees.find(t=>t.id===e)&&employees.push({...t,hours:0,bonusAmount:0,premieCastka:0})}),closeEmployeeSelector(),renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),showSuccess(`Přidáno ${t.length} zaměstnanců`)}catch(e){logger.error("Failed to save after adding employees:",e)}}else wgsToast.warning("Nevybrali jste žádné zaměstnance")}function addNewBlankEmployee(){const e=document.getElementById("addEmployeeModal");e&&e.remove();const t=-Date.now();employees.push({id:t,name:"",hours:0,account:"",bank:"",type:"standard",active:!0,isNew:!0}),renderTable(),updateStats(),setTimeout(()=>{const e=document.querySelector(`[data-index="${employees.length-1}"][data-field="name"]`);e&&e.focus()},100),showSuccess("Vyplňte údaje nového zaměstnance a uložte do databáze")}async function saveEmployeeToDatabase(e){const t=employees[e];if(!t.name||""===t.name.trim())return void wgsToast.error("Zadejte jméno zaměstnance");const a=Math.max(...allEmployeesDatabase.map(e=>e.id||0),0)+1;t.id=a,t.isNew=!1,t.name=t.name.trim(),allEmployeesDatabase.push({id:a,name:t.name,account:t.account||"",bank:t.bank||"",type:"standard",active:!0}),renderTable();try{await saveToServer(),showSuccess(`Zaměstnanec ${t.name} uložen do databáze`),logger.log("New employee saved to database:",t.name)}catch(e){logger.error("Failed to save new employee:",e),wgsToast.error("Chyba při ukládání do databáze")}}async function saveEmployeeChanges(e){const t=document.querySelectorAll(`[data-action="updateEmployeeField"][data-index="${e}"]`);t.length>0&&employees[e]&&t.forEach(t=>{const a=t.getAttribute("data-field");a&&(employees[e][a]="hours"===a||"bonusAmount"===a||"premieCastka"===a?parseInt(t.value)||0:"bank"===a?formatBankCode(t.value):t.value,logger.log(`Synced field ${a} = "${employees[e][a]}" for employee ${employees[e].name}`))});const a=employees[e];if(!a)return void wgsToast.error("Zaměstnanec nenalezen");logger.log("Saving employee changes:",a.name,"account:",a.account,"bank:",a.bank);const o=allEmployeesDatabase.findIndex(e=>e.id===a.id);-1!==o?(allEmployeesDatabase[o].name=a.name,allEmployeesDatabase[o].account=a.account||"",allEmployeesDatabase[o].bank=a.bank||"",allEmployeesDatabase[o].type=a.type||"standard",logger.log("Updated allEmployeesDatabase at index",o)):(logger.warn("Employee not found in allEmployeesDatabase, adding:",a.name,a.id),allEmployeesDatabase.push({id:a.id,name:a.name,account:a.account||"",bank:a.bank||"",type:a.type||"standard",active:!0}));try{saveToLocalStorage(),await saveToServer(),showSuccess(`Změny u ${a.name} uloženy`),logger.log("Employee changes saved:",a.name)}catch(e){logger.error("Failed to save employee changes:",e),wgsToast.error("Chyba při ukládání změn")}}async function confirmAddEmployee(){const e=document.getElementById("selectEmployeeToAdd"),t=parseInt(e.value);if(!t)return void wgsToast.error("Vyberte zaměstnance");const a=allEmployeesDatabase.find(e=>e.id===t);if(a){employees.push({...a,hours:0,bonusAmount:0,premieCastka:0}),document.getElementById("addEmployeeModal").remove(),renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Employee added and saved:",a.name),showSuccess(`Zaměstnanec ${a.name} přidán`)}catch(e){logger.error("Failed to save after adding employee:",e)}}else wgsToast.error("Zaměstnanec nenalezen")}async function updateEmployee(e,t,a,o=!1){if("name"===t&&o){const t=employees[e].name;if(t!==a&&!await wgsConfirm(`Opravdu chcete změnit jméno z "${t}" na "${a}"?`,{titulek:"Změnit jméno",btnPotvrdit:"Změnit"}))return void renderTable()}employees[e][t]="hours"===t||"bonusAmount"===t||"premieCastka"===t?parseInt(a)||0:"bank"===t?formatBankCode(a):a,renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Employee updated and saved")}catch(e){logger.error("Failed to save after updating employee:",e)}}async function removeEmployee(e){const t=employees[e];if(PERMANENT_EMPLOYEE_IDS.includes(t.id))wgsToast.error("Tento zaměstnanec je permanentní a nelze ho odebrat");else if(await wgsConfirm(`Opravdu chcete odebrat zaměstnance ${t.name} z tohoto období?`,{titulek:"Odebrat zaměstnance",btnPotvrdit:"Odebrat",nebezpecne:!0})){employees.splice(e,1),renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Employee removed from period:",t.name),showSuccess(`${t.name} odebrán z období`)}catch(e){logger.error("Failed to save after removing employee:",e)}}}function renderTable(){const e=document.getElementById("employeeTableBody");if(0===employees.length)return void(e.innerHTML='\n      <tr>\n        <td colspan="7" class="text-center" style="padding: 3rem;">\n          <div data-action="showEmployeeSelector"\n               style="cursor: pointer; display: inline-block; padding: 1.5rem 2.5rem; border: 2px dashed var(--c-grey); border-radius: 8px; transition: all 0.2s ease;"\n               onmouseover="this.style.borderColor=\'var(--c-black)\'; this.style.background=\'rgba(0,0,0,0.02)\'"\n               onmouseout="this.style.borderColor=\'var(--c-grey)\'; this.style.background=\'transparent\'">\n            <div style="font-size: 2.5rem; font-weight: 300; color: var(--c-grey); line-height: 1;">+</div>\n            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--c-grey);">Přidat zaměstnance</div>\n          </div>\n        </td>\n      </tr>\n    ');let t=0;employees.forEach(e=>{"special"!==e.type&&"special2"!==e.type&&(t+=e.hours||0)}),e.innerHTML=employees.map((e,a)=>{let o,n,r="",s="Lenka"===e.name||e.name.includes("Lenka");if(s)o=void 0!==e.bonusAmount?e.bonusAmount||0:8716,n=0,r='<span class="employee-type-badge" style="background: var(--c-info);">Paušální odměna</span>';else if("bonus_girls"===e.type)o=e.bonusAmount||0,n=0,r='<span class="employee-type-badge" style="background: var(--c-warning);">Manuální bonus</span>';else if("pausalni"===e.type&&e.pausalni){const t=e.pausalni.rate/12,a=e.pausalni.tax;o=e.hours*salaryRate,n=Math.min(e.hours*invoiceRate,t-a),r='<span class="employee-type-badge">Paušál</span>'}else"special"===e.type||"special2"===e.type?(o=20*t,n=0,r='<span class="employee-type-badge">Pouze bonus</span>'):"premie_polozka"===e.type?(o=e.premieCastka||0,n=0,r='<span class="employee-type-badge" style="background: var(--c-black); color: var(--c-white);">Prémie</span>'):(o=e.hours*salaryRate,n=e.hours*invoiceRate,"swift"===e.type&&(r='<span class="employee-type-badge">SWIFT</span>'));const i="swift"===e.type&&e.swiftData?e.swiftData.iban.substr(0,10)+"...":e.account||"",l="swift"===e.type&&e.swiftData?e.swiftData.swift:formatBankCode(e.bank)||"";return`\n      <tr>\n        <td>\n          <input type="text"\n                 value="${e.name}"\n                 class="table-input"\n                 style="font-weight: 600; min-width: 100px;"\n                 data-action="updateEmployeeField"\n                 data-index="${a}"\n                 data-field="name"\n                 data-recalculate="true">\n          ${r}\n        </td>\n        <td class="text-center">\n          ${"special"===e.type||"special2"===e.type?'<span style="color: var(--c-grey);">–</span>':s?`<input type="number"\n                     value="${void 0!==e.bonusAmount?e.bonusAmount:8716}"\n                     min="0"\n                     step="100"\n                     class="table-input"\n                     style="width: 100px; text-align: center; font-weight: 600; background: #d1ecf1;"\n                     placeholder="Částka (Kč)"\n                     data-action="updateEmployeeField"\n                     data-index="${a}"\n                     data-field="bonusAmount">`:"premie_polozka"===e.type?`<input type="number"\n                     value="${e.premieCastka||0}"\n                     min="0"\n                     step="100"\n                     class="table-input"\n                     style="width: 100px; text-align: center; font-weight: 600;"\n                     placeholder="Částka (Kč)"\n                     data-action="updateEmployeeField"\n                     data-index="${a}"\n                     data-field="premieCastka">`:"bonus_girls"===e.type?`<input type="number"\n                     value="${e.bonusAmount||0}"\n                     min="0"\n                     step="100"\n                     class="table-input"\n                     style="width: 100px; text-align: center; font-weight: 600; background: #fff3cd;"\n                     placeholder="Částka (Kč)"\n                     data-action="updateEmployeeField"\n                     data-index="${a}"\n                     data-field="bonusAmount">`:`<input type="number"\n                     value="${e.hours}"\n                     min="0"\n                     class="table-input"\n                     style="width: 80px; text-align: center; font-weight: 600;"\n                     data-action="updateEmployeeField"\n                     data-index="${a}"\n                     data-field="hours">`}\n        </td>\n        <td class="text-right" style="font-weight: 600; color: var(--c-success);">\n          ${formatCurrency(o)}\n          ${"special"===e.type||"special2"===e.type?'<br><span style="font-size: 0.75rem; color: var(--c-grey);">'+t+"h × 20</span>":""}\n        </td>\n        <td class="text-right" style="font-weight: 600; color: var(--c-info);">\n          ${formatCurrency(n)}\n        </td>\n        <td>\n          <input type="text"\n                 value="${i}"\n                 placeholder="Číslo účtu"\n                 class="table-input"\n                 ${"swift"===e.type?"readonly":""}\n                 data-action="updateEmployeeField"\n                 data-index="${a}"\n                 data-field="account">\n        </td>\n        <td>\n          <input type="text"\n                 value="${l}"\n                 placeholder="Kód"\n                 class="table-input"\n                 style="width: 100px; text-align: center;"\n                 ${"swift"===e.type?"readonly":""}\n                 data-action="updateEmployeeField"\n                 data-index="${a}"\n                 data-field="bank">\n        </td>\n        <td class="text-center" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem; min-width: 120px; align-items: center; vertical-align: middle;">\n          <button class="btn btn-sm" onclick="saveEmployeeChanges(${a})" title="Uložit změny">Uložit</button>\n          ${e.isNew?`<button class="btn btn-sm" style="background: var(--c-success); color: white;" onclick="saveEmployeeToDatabase(${a})" title="Uložit do databáze">DB</button>`:`<button class="btn btn-sm qr-btn" style="background: var(--c-info); color: white;" onclick="generateSingleEmployeeQR(${a})" title="Generovat QR platbu">QR</button>`}\n          ${PERMANENT_EMPLOYEE_IDS.includes(e.id)?"<span></span>":`<button class="btn btn-danger btn-sm" onclick="removeEmployee(${a})" title="Odebrat z období">×</button>`}\n        </td>\n      </tr>\n    `}).join("")}function updateStats(){let e=0,t=0,a=0,o=0;employees.forEach(e=>{if("special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&"premie_polozka"!==e.type){"Lenka"===e.name||e.name.includes("Lenka")||(o+=e.hours||0)}});let n=0;employees.forEach(r=>{const s="Lenka"===r.name||r.name.includes("Lenka");let i=0,l=0;if(s)i=void 0!==r.bonusAmount?r.bonusAmount||0:8716,l=0;else if("bonus_girls"===r.type)i=r.bonusAmount||0,l=0;else if("special"===r.type||"special2"===r.type)i=20*o,l=0;else if("premie_polozka"===r.type)i=r.premieCastka||0,l=0;else if("pausalni"===r.type&&r.pausalni){const e=r.pausalni.rate/12,t=r.pausalni.tax;i=r.hours*salaryRate,l=Math.min(r.hours*invoiceRate,e-t),r.hours>0&&n++}else i=(r.hours||0)*salaryRate,l=(r.hours||0)*invoiceRate,r.hours>0&&n++;t+=i,a+=l,"special"===r.type||"special2"===r.type||"bonus_girls"===r.type||"premie_polozka"===r.type||s||(e+=r.hours||0)});const r=a-t,s=a>0?r/a*100:0;document.getElementById("totalHours").textContent=formatNumber(e),document.getElementById("totalSalary").textContent=formatCurrency(t),document.getElementById("totalInvoice").textContent=formatCurrency(a),document.getElementById("employeeCount").textContent=n,document.getElementById("totalProfit").textContent=formatCurrency(r),document.getElementById("profitMargin").textContent=`Marže: ${s.toFixed(1)}%`;const i=n>0?e/n:0,l=n>0?t/n:0;document.getElementById("avgHoursPerEmployee").textContent=i.toFixed(1)+"h",document.getElementById("avgSalaryPerEmployee").textContent=formatCurrency(l),document.getElementById("salaryRateInfo").textContent=`${salaryRate} Kč/hodina`,document.getElementById("invoiceRateInfo").textContent=`${invoiceRate} Kč/hodina`,document.getElementById("footerTotalHours").textContent=formatNumber(e),document.getElementById("footerTotalSalary").textContent=formatCurrency(t),document.getElementById("footerTotalInvoice").textContent=formatCurrency(a)}async function updateRates(){salaryRate=parseInt(document.getElementById("salaryRate").value)||150,invoiceRate=parseInt(document.getElementById("invoiceRate").value)||250,renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Rates updated and saved")}catch(e){logger.error("Failed to save after updating rates:",e)}}function formatCurrency(e){return new Intl.NumberFormat("cs-CZ",{style:"currency",currency:"CZK",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function formatNumber(e){return window.Utils&&window.Utils.formatNumber?window.Utils.formatNumber(e):new Intl.NumberFormat("cs-CZ").format(e)}function formatBankCode(e){if(!e)return"";const t=e.toString().replace(/\D/g,"");return t?t.padStart(4,"0").slice(-4):""}function normalizeAccount(e){if(!e)return"";const t=e.toString().replace(/\D/g,"");if(!t)return"";const a=t.slice(-10),o=t.length>10?t.slice(0,-10):"";return o?`${parseInt(o,10)}-${a}`:a}function convertToIBAN(e,t){let a=(e||"").toString().replace(/\s/g,"");t=(t||"").toString().replace(/\D/g,"").padStart(4,"0");let o="",n="";if(a.includes("-")){const e=a.split("-");o=(e[0]||"").replace(/\D/g,""),n=(e[1]||"").replace(/\D/g,"")}else{const e=a.replace(/\D/g,"");e.length>10?(o=e.slice(0,-10),n=e.slice(-10)):(o="",n=e)}o=o.padStart(6,"0"),n=n.padStart(10,"0");const r=t+o+n;if(20!==r.length)throw new Error(`Neplatná délka BBAN: ${r.length} (očekáváno 20)`);let s=BigInt(r+"123500")%97n;const i="CZ"+String(98n-s).padStart(2,"0")+r;if(24!==i.length)throw new Error(`Neplatná délka IBAN: ${i.length} (očekáváno 24)`);return i}function sanitizeMessage(e){return e?e.toString().replace(/[\r\n]+/g," ").replace(/\*/g," ").trim().slice(0,60):""}document.addEventListener("click",e=>{const t=document.getElementById("periodOverlay"),a=document.getElementById("periodDisplay");t&&t.classList.contains("active")&&(t.contains(e.target)||a.contains(e.target)||closePeriodOverlay())});let qrLibraryPromise=null;function ensureQrLibraryLoaded(){return window.QRCode&&"function"==typeof window.QRCode?Promise.resolve(window.QRCode):qrLibraryPromise||(qrLibraryPromise=new Promise((e,t)=>{const a="assets/js/qrcode.min.js",o=document.querySelector("script[data-qr-lib]")||Array.from(document.scripts).find(e=>(e.src||"").includes(a)),n=e=>t(new Error(e)),r=()=>!(!window.QRCode||"function"!=typeof window.QRCode)&&(e(window.QRCode),!0),s=setTimeout(()=>{r()||n("Timeout načítání knihovny QR kódů (8s)")},8e3),i=()=>clearTimeout(s),l=e=>{queueMicrotask(()=>{r()?i():"1"===e.dataset.qrLoaded&&(i(),n("QR script načten, ale QRCode API chybí"))}),e.addEventListener("load",()=>{e.dataset.qrLoaded="1",r()?i():(i(),n("Knihovna QR kódu se načetla, ale neobsahuje očekávané API"))},{once:!0}),e.addEventListener("error",()=>{i(),n("Nepodařilo se načíst knihovnu QR kódů")},{once:!0})};if(o)return r()?void i():"1"===o.dataset.qrLoaded?(i(),void n("QR script načten, ale QRCode API chybí")):void l(o);const d=document.createElement("script");d.src=a,d.defer=!0,d.dataset.qrLib="1",l(d),document.head.appendChild(d)}).catch(e=>{throw qrLibraryPromise=null,e}),qrLibraryPromise)}function buildSpaydPayload(e){const t=normalizeAccount(e.account),a=formatBankCode(e.bank),o=Number(e.amount);if(!t||!a)throw new Error("Chybí číslo účtu nebo kód banky");if(!Number.isFinite(o)||o<=0)throw new Error("Neplatná částka");return`SPD*1.0*ACC:${convertToIBAN(t,a)}*AM:${o.toFixed(2)}*CC:CZK`}const QR_MAX_LENGTH={L:800,M:600,Q:450,H:350};async function renderQrCode(e,t,a,o=""){if(await ensureQrLibraryLoaded(),!window.QRCode||"function"!=typeof window.QRCode)throw new Error("Knihovna pro QR kódy není načtena");const n=QR_MAX_LENGTH.L;if(!t||"string"!=typeof t)throw new Error("QR text je prázdný nebo neplatný");if(t.length>n)throw console.error(`QR text příliš dlouhý: ${t.length} > ${n}`,t),new Error(`QR data příliš dlouhá (${t.length} znaků, max ${n})`);return new Promise((n,r)=>{try{e.innerHTML="",new QRCode(e,{text:t,width:a,height:a,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.L}),n()}catch(t){console.error(`Failed to generate QR code${o?" for "+o:""}:`,t),e.innerHTML=`<div style="color: #dc3545; padding: 20px;">${t?.message||"Chyba QR"}</div>`,r(t)}})}function showSuccess(e){wgsToast.success(e)}function showError(e){wgsToast.error(e)}function exportToExcel(){let e="\ufeff";const t=document.getElementById("periodDisplay").textContent;e+=`PSA KALKULÁTOR - ${t}\n\n`,e+="Jméno;Hodiny;Výplata (Kč);Faktura (Kč);Číslo účtu;Kód banky;Typ\n";let a=0;employees.forEach(e=>{"special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&(a+=e.hours||0)}),employees.forEach(t=>{let o,n;"Lenka"===t.name||t.name.includes("Lenka")?(o=8716,n=0):"bonus_girls"===t.type?(o=t.bonusAmount||0,n=0):"pausalni"===t.type&&t.pausalni?(o=t.hours*salaryRate,n=Math.min(t.hours*invoiceRate,t.pausalni.rate/12-t.pausalni.tax)):"special"===t.type||"special2"===t.type?(o=20*a,n=0):(o=t.hours*salaryRate,n=t.hours*invoiceRate);const r="bonus_girls"===t.type?`${t.bonusAmount||0} Kč`:t.hours||0;e+=`${t.name};${r};${o};${n};${t.account||""};${t.bank||""};${t.type||"standard"}\n`});const o=employees.reduce((e,t)=>"special"===t.type||"special2"===t.type||"bonus_girls"===t.type?e:e+(t.hours||0),0),n=employees.reduce((e,t)=>"Lenka"===t.name||t.name.includes("Lenka")?e+8716:"bonus_girls"===t.type?e+(t.bonusAmount||0):"special"===t.type||"special2"===t.type?e+20*a:e+t.hours*salaryRate,0),r=employees.reduce((e,t)=>{if("special"===t.type||"special2"===t.type||"bonus_girls"===t.type)return e;return"Lenka"===t.name||t.name.includes("Lenka")?e:e+t.hours*invoiceRate},0);e+=`\nCELKEM;${o};${n};${r};;;`,e+=`\n\nSazba výplaty: ${salaryRate} Kč/hodina`,e+=`\nSazba fakturace: ${invoiceRate} Kč/hodina`,e+=`\nZisk: ${r-n} Kč`;const s=new Blob([e],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(s),l=document.createElement("a");l.href=i,l.download=`PSA_${currentPeriod.year}_${String(currentPeriod.month).padStart(2,"0")}.csv`,l.click(),URL.revokeObjectURL(i)}function printReport(){window.print()}async function clearAll(){if(await wgsConfirm("Opravdu chcete vynulovat hodiny pro toto období?",{titulek:"Vynulovat hodiny",btnPotvrdit:"Vynulovat",nebezpecne:!0})){employees.forEach(e=>{e.hours=0,"bonus_girls"===e.type&&(e.bonusAmount=0),"premie_polozka"===e.type&&(e.premieCastka=0)}),renderTable(),updateStats();try{saveToLocalStorage(),await saveToServer(),logger.log("Hours cleared for current period"),showSuccess("Hodiny vynulovány pro aktuální období")}catch(e){logger.error("Failed to save after clearing hours:",e)}}}function synchronizovatVstupy(){document.querySelectorAll('[data-action="updateEmployeeField"]').forEach(e=>{const t=parseInt(e.getAttribute("data-index")),a=e.getAttribute("data-field");!isNaN(t)&&a&&employees[t]&&(employees[t][a]="hours"===a||"bonusAmount"===a||"premieCastka"===a?parseInt(e.value)||0:"bank"===a?formatBankCode(e.value):e.value)}),updateStats()}function generatePaymentQR(){synchronizovatVstupy();const e=document.getElementById("qrModal"),t=document.getElementById("qrCodesContainer"),a=document.getElementById("paymentSummary");t.innerHTML="",a.innerHTML="";const o=a.closest(".payment-summary");o&&(o.style.display=""),e.classList.remove("single-qr-mode");let n=0,r=[],s=[],i=0;employees.forEach(e=>{"special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&(i+=e.hours||0)});const l=20*i;employees.forEach(e=>{let t=0;t="Lenka"===e.name||e.name.includes("Lenka")?8716:"bonus_girls"===e.type?e.bonusAmount||0:"special"===e.type||"special2"===e.type?l:"premie_polozka"===e.type?e.premieCastka||0:(e.hours||0)*salaryRate,t<=0||("swift"===e.type&&e.swiftData?s.push({name:e.name,amount:t,swiftData:e.swiftData}):r.push({name:e.name,amount:t,account:e.account||"",bank:e.bank?formatBankCode(e.bank):"",missingAccount:!e.account||!e.bank}),n+=t)});let d="",c=0;r.forEach(e=>{c+=e.amount,d+=`<div class="summary-row"><span>${e.name}</span><span>${formatCurrency(e.amount)}</span></div>`}),s.forEach(e=>{c+=e.amount,d+=`<div class="summary-row"><span>${e.name} (SWIFT)</span><span>${formatCurrency(e.amount)}</span></div>`}),a.innerHTML=`\n    ${d}\n    <div class="summary-row summary-total">\n      <span>CELKEM:</span>\n      <span>${formatCurrency(c)}</span>\n    </div>\n  `;const u=document.createElement("div");u.className="qr-grid",t.appendChild(u),r.forEach((e,t)=>{const a=document.createElement("div");a.className="qr-item";const o=!e.missingAccount,n=o?`${e.account}/${e.bank}`:"Chybí účet";a.innerHTML=`\n      <div class="qr-employee-name">${e.name}</div>\n      <div class="qr-amount">${formatCurrency(e.amount)}</div>\n      <div class="qr-account">${n}</div>\n      <div class="qr-code-wrapper" id="qr-${t}"></div>\n      ${o?`\n        <div class="qr-item-buttons">\n          <button class="btn btn-sm" data-action="downloadQR" data-qrid="qr-${t}" data-name="${e.name}">Stáhnout</button>\n          <button class="btn btn-sm btn-secondary" data-action="shareQR" data-qrid="qr-${t}" data-name="${e.name}" data-amount="${e.amount}">Sdílet</button>\n        </div>\n      `:""}\n    `,u.appendChild(a),setTimeout(async()=>{const a=document.getElementById(`qr-${t}`);if(!a)return void logger.error(`QR element not found: qr-${t}`);if(!o)return void(a.innerHTML='<div style="width: 160px; height: 160px; background: white; border: 1px solid #ddd; margin: 0 auto;"></div>');let n;a.innerHTML="";try{n=generateCzechPaymentString({account:e.account,bank:e.bank,amount:e.amount,vs:100*currentPeriod.year+currentPeriod.month,message:`Výplata ${e.name} ${currentPeriod.month}/${currentPeriod.year}`})}catch(e){return void(a.innerHTML=`<div style="color: #999; font-size: 0.8rem;">${e.message}</div>`)}logger.log(`Generating QR for ${e.name}:`,n);try{await renderQrCode(a,n,160,e.name)}catch(t){logger.error(`Failed to generate QR code for ${e.name}:`,t),a.innerHTML='<div style="color: #999; font-size: 0.8rem;">Chyba QR</div>'}},100*t)}),s.forEach((e,t)=>{const a=document.createElement("div");a.className="qr-item swift-item",a.innerHTML=`\n      <div class="qr-employee-name">${e.name}</div>\n      <div class="qr-amount">${formatCurrency(e.amount)}</div>\n      <div class="swift-label">SWIFT</div>\n      <div class="swift-details">\n        <div><strong>IBAN:</strong> ${e.swiftData.iban}</div>\n        <div><strong>SWIFT:</strong> ${e.swiftData.swift}</div>\n        <div class="swift-our">Poplatky: OUR</div>\n      </div>\n      <div class="qr-item-buttons">\n        <button class="btn btn-sm" data-action="copySWIFTDetails" data-name="${e.name}" data-iban="${e.swiftData.iban}" data-swift="${e.swiftData.swift}" data-amount="${e.amount}">Kopírovat</button>\n      </div>\n    `,u.appendChild(a)}),e.classList.remove("hidden")}function generateCzechPaymentString(e){return buildSpaydPayload(e)}function copySWIFTDetails(e,t,a,o){const n=`SWIFT platba - ${e}\nIBAN: ${t}\nSWIFT/BIC: ${a}\nČástka: ${formatCurrency(o)}\nPoplatky: OUR (hradí odesílatel)\nZpráva: Výplata ${e} ${currentPeriod.month}/${currentPeriod.year}`;navigator.clipboard.writeText(n).then(()=>{wgsToast.success("SWIFT údaje byly zkopírovány do schránky")}).catch(e=>{logger.error("Chyba při kopírování:",e),wgsToast.error("Nepodařilo se zkopírovat údaje")})}function downloadQR(e,t){const a=document.querySelector(`#${e} img`),o=document.querySelector(`#${e} canvas`),n=document.createElement("a");n.download=`QR_platba_${t}_${currentPeriod.month}_${currentPeriod.year}.png`,a&&a.src?(n.href=a.src,n.click()):o?(n.href=o.toDataURL(),n.click()):wgsToast.error("QR kód nenalezen")}async function shareQRCode(e,t,a){const o=document.querySelector(`#${e} img`),n=document.querySelector(`#${e} canvas`);let r;if(o&&o.src)r=o.src;else{if(!n)return void wgsToast.error("QR kód nenalezen");r=n.toDataURL("image/png")}const s=await fetch(r),i=await s.blob(),l={title:`QR platba - ${t}`,text:`Platba pro ${t}: ${a} Kč (${currentPeriod.month}/${currentPeriod.year})`,files:[new File([i],`QR_platba_${t}.png`,{type:"image/png"})]};if(navigator.canShare&&navigator.canShare(l))try{await navigator.share(l),wgsToast.success("QR kód byl sdílen")}catch(e){"AbortError"!==e.name&&(console.error("Chyba při sdílení:",e),fallbackCopyQR(r,t,a))}else fallbackCopyQR(r,t,a)}async function fallbackCopyQR(e,t,a){try{const t=await fetch(e),a=await t.blob();await navigator.clipboard.write([new ClipboardItem({"image/png":a})]),wgsToast.success("QR kód byl zkopírován do schránky")}catch(a){console.warn("Nelze zkopírovat do schránky, stahuji soubor:",a),downloadQR(e.split("#")[0].split("?")[0],t)}}function closeQRModal(){document.getElementById("qrModal").classList.add("hidden")}function generateSingleEmployeeQR(e){synchronizovatVstupy();const t=employees[e];if(!t)return void wgsToast.error("Zaměstnanec nenalezen");const a=document.getElementById("qrModal"),o=document.getElementById("qrCodesContainer"),n=document.getElementById("paymentSummary");if(!a||!o||!n)return console.error("QR Modal: chybí elementy",{modal:a,container:o,summaryDiv:n}),void wgsToast.error("Chybí QR modal v HTML (qrModal/qrCodesContainer/paymentSummary)");o.innerHTML="",n.innerHTML="";const r=n.closest(".payment-summary");r&&(r.style.display="none"),a.classList.add("single-qr-mode");let s=0;employees.forEach(e=>{"special"!==e.type&&"special2"!==e.type&&"bonus_girls"!==e.type&&(s+=e.hours||0)});let i=0,l="Lenka"===t.name||t.name.includes("Lenka");if(i=l?8716:"bonus_girls"===t.type?t.bonusAmount||0:"pausalni"===t.type&&t.pausalni?t.hours*salaryRate:"special"===t.type||"special2"===t.type?20*s:"premie_polozka"===t.type?t.premieCastka||0:t.hours*salaryRate,i<=0)return void wgsToast.warning("Částka k výplatě je 0 Kč. Zadejte prosím hodiny nebo nastavte mzdu.");if("swift"===t.type&&t.swiftData){const e=document.createElement("div");return e.className="qr-item swift-item",e.innerHTML=`\n      <div class="qr-employee-name">${t.name}</div>\n      <div class="qr-amount">${formatCurrency(i)}</div>\n      <div class="swift-label">SWIFT</div>\n      <div class="swift-details">\n        <div><strong>IBAN:</strong> ${t.swiftData.iban}</div>\n        <div><strong>SWIFT:</strong> ${t.swiftData.swift}</div>\n        <div class="swift-our">Poplatky: OUR</div>\n      </div>\n      <div class="qr-item-buttons">\n        <button class="btn btn-sm" data-action="copySWIFTDetails" data-name="${t.name}" data-iban="${t.swiftData.iban}" data-swift="${t.swiftData.swift}" data-amount="${i}">Kopírovat</button>\n      </div>\n    `,o.appendChild(e),void a.classList.remove("hidden")}if(!t.account||!t.bank)return void wgsToast.warning("Prosím zadejte číslo účtu a kód banky pro "+t.name);const d=`qr-single-${Date.now()}-${e}`,c=document.createElement("div");c.className="qr-item",c.innerHTML=`\n    <div class="qr-employee-name">${t.name}</div>\n    <div class="qr-amount">${formatCurrency(i)}</div>\n    ${l?'<div style="font-size: 0.75rem; color: var(--c-info);">Paušální mzda</div>':""}\n    <div class="qr-account">${t.account}/${formatBankCode(t.bank)}</div>\n    <div class="qr-code-wrapper" id="${d}"></div>\n    <div class="qr-item-buttons">\n      <button class="btn btn-sm" data-action="downloadQR" data-qrid="${d}" data-name="${t.name}">\n        Stáhnout\n      </button>\n      <button class="btn btn-sm btn-secondary" data-action="shareQR" data-qrid="${d}" data-name="${t.name}" data-amount="${i}">\n        Sdílet\n      </button>\n    </div>\n  `,o.appendChild(c),setTimeout(async()=>{const e=document.getElementById(d);if(!e)return console.error("QR element not found:",d),void wgsToast.error("QR element nenalezen v DOM");let a;e.innerHTML="";try{a=generateCzechPaymentString({account:t.account,bank:formatBankCode(t.bank),amount:i,vs:100*currentPeriod.year+currentPeriod.month,message:`Výplata ${t.name} ${currentPeriod.month}/${currentPeriod.year}`})}catch(t){return console.error("QR generateCzechPaymentString failed:",t),void(e.innerHTML=`<div style="color: #dc3545; padding: 20px;">${t.message}</div>`)}try{await renderQrCode(e,a,220,t.name)}catch(a){console.error(`QR render failed for ${t.name}:`,a),e.innerHTML=`<div style="color: #dc3545; padding: 20px;">${a?.message||"Chyba QR"}</div>`}},100),a.classList.remove("hidden")}window.onclick=function(e){const t=document.getElementById("qrModal");e.target==t&&t.classList.add("hidden")},document.addEventListener("DOMContentLoaded",()=>{function e(e){const t=e.getAttribute("data-action");if("reload"!==t){switch(t){case"generateSingleEmployeeQR":{const t=e.getAttribute("data-index"),a=Number.parseInt(t,10);return!Number.isInteger(a)||a<0?(console.warn("QR: invalid data-index",t,e),void wgsToast.error("Neplatný index zaměstnance")):"function"!=typeof generateSingleEmployeeQR?(console.error("generateSingleEmployeeQR is not a function"),void wgsToast.error("QR modul není načten")):void generateSingleEmployeeQR(a)}case"saveEmployeeToDatabase":{const t=e.getAttribute("data-index");return void(null!==t&&"function"==typeof saveEmployeeToDatabase&&saveEmployeeToDatabase(parseInt(t,10)))}case"saveEmployeeChanges":{const t=parseInt(e.getAttribute("data-index"),10);return void(isNaN(t)||"function"!=typeof saveEmployeeChanges||saveEmployeeChanges(t))}case"removeEmployee":{const t=e.getAttribute("data-index");return void(null!==t&&"function"==typeof removeEmployee&&removeEmployee(parseInt(t,10)))}case"copySWIFTDetails":{const t=e.getAttribute("data-name"),a=e.getAttribute("data-iban"),o=e.getAttribute("data-swift"),n=parseFloat(e.getAttribute("data-amount"));return void(t&&a&&o&&"function"==typeof copySWIFTDetails&&copySWIFTDetails(t,a,o,n))}case"downloadQR":{const t=e.getAttribute("data-qrid"),a=e.getAttribute("data-name");return void(t&&a&&"function"==typeof downloadQR&&downloadQR(t,a))}case"shareQR":{const t=e.getAttribute("data-qrid"),a=e.getAttribute("data-name"),o=e.getAttribute("data-amount");return void(t&&a&&"function"==typeof shareQRCode&&shareQRCode(t,a,o))}case"updateEmployeeField":{const t=parseInt(e.getAttribute("data-index"),10),a=e.getAttribute("data-field"),o="true"===e.getAttribute("data-recalculate");return void(!isNaN(t)&&a&&"function"==typeof updateEmployee&&updateEmployee(t,a,e.value,o))}case"saveData":return void("function"==typeof saveData&&saveData());case"addEmployee":return void("function"==typeof addEmployee&&addEmployee());case"exportToExcel":return void("function"==typeof exportToExcel&&exportToExcel());case"printReport":return void("function"==typeof printReport&&printReport());case"clearAll":return void("function"==typeof clearAll&&clearAll());case"generatePaymentQR":return void("function"==typeof generatePaymentQR&&generatePaymentQR());case"closeQRModal":return void("function"==typeof closeQRModal&&closeQRModal());case"updatePeriod":return void("function"==typeof updatePeriod&&updatePeriod());case"updateRates":return void("function"==typeof updateRates&&updateRates());case"togglePeriodOverlay":return void("function"==typeof togglePeriodOverlay&&togglePeriodOverlay());case"closePeriodOverlay":return void("function"==typeof closePeriodOverlay&&closePeriodOverlay());case"showNewPeriodSelector":return void("function"==typeof showNewPeriodSelector&&showNewPeriodSelector());case"closeNewPeriodSelector":return void("function"==typeof closeNewPeriodSelector&&closeNewPeriodSelector());case"confirmNewPeriod":return void("function"==typeof confirmNewPeriod&&confirmNewPeriod());case"selectPeriod":{const t=e.getAttribute("data-period");return void(t&&"function"==typeof selectPeriod&&selectPeriod(t))}case"loadPeriod":return void("function"==typeof loadPeriod&&loadPeriod());case"clearHours":return void("function"==typeof clearHours&&clearHours());case"newAttendance":return void("function"==typeof newAttendance&&newAttendance());case"showEmployeeSelector":return void("function"==typeof showEmployeeSelector&&showEmployeeSelector());case"closeEmployeeSelector":return void("function"==typeof closeEmployeeSelector&&closeEmployeeSelector());case"selectAllEmployees":return void("function"==typeof selectAllEmployees&&selectAllEmployees());case"deselectAllEmployees":return void("function"==typeof deselectAllEmployees&&deselectAllEmployees());case"confirmEmployeeSelection":return void("function"==typeof confirmEmployeeSelection&&confirmEmployeeSelection())}"function"==typeof window[t]&&window[t]()}else location.reload()}document.addEventListener("click",t=>{const a=t.target.closest("[data-action]");a&&"INPUT"!==a.tagName&&"TEXTAREA"!==a.tagName&&e(a)}),document.addEventListener("change",t=>{const a=t.target.closest("[data-action]");a&&e(a)}),document.addEventListener("keydown",t=>{if("Enter"!==t.key&&" "!==t.key)return;const a=t.target.closest("[data-action]");a&&"BUTTON"!==a.tagName&&"button"===a.getAttribute("role")&&(t.preventDefault(),e(a))}),document.addEventListener("click",e=>{const t=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");t&&("function"==typeof navigateTo?navigateTo(t):location.href=t)}),document.addEventListener("change",e=>{const t=e.target.closest("[data-onchange]");if(!t)return;const a=t.getAttribute("data-onchange"),o=t.getAttribute("data-onchange-value")||t.value;"function"==typeof window[a]&&window[a](o)})});
//# sourceMappingURL=psa-kalkulator.min.js.map