function toggleMenu(){const e=document.getElementById("navMenu"),t=document.querySelector(".hamburger");e.classList.contains("active")?(e.classList.remove("active"),t.classList.remove("active"),document.body.style.position="",document.body.style.top="",document.body.style.width="",document.body.style.left="",document.body.style.right="",window.scrollTo(0,window.menuScrollPosition)):(window.menuScrollPosition=window.pageYOffset,document.body.style.position="fixed",document.body.style.top=`-${window.menuScrollPosition}px`,document.body.style.width="100%",document.body.style.left="0",document.body.style.right="0",e.classList.add("active"),t.classList.add("active"))}function showNotification(e,t="info"){const o=document.getElementById("notif");if(!o)return console.warn("Notification element not found, falling back to console"),void console.log(`[${t.toUpperCase()}] ${e}`);o.textContent=e,o.className=`notif ${t}`,o.style.display="block",o.style.opacity="1";const a=()=>{o.style.opacity="0",setTimeout(()=>{o.style.display="none"},300)};o.onclick=a,"error"!==t?setTimeout(a,3e3):setTimeout(a,5e3)}let signaturePad;!async function(){try{const e=await fetch("app/admin_session_check.php"),o=await e.json();if(!o.logged_in)return alert(t("please_log_in")),void(window.location.href="login.php");"prodejce"===o.role&&(alert(t("page_for_techs_admins_only")),window.location.href="seznam.php")}catch(e){logger.error("Chyba kontroly p≈ô√≠stupu:",e)}}(),document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".nav a").forEach(e=>{e.addEventListener("click",()=>{const e=document.getElementById("navMenu"),t=document.querySelector(".hamburger");e.classList.remove("active"),t.classList.remove("active"),document.body.style.position="",document.body.style.top="",document.body.style.width="",document.body.style.left="",document.body.style.right="",void 0!==window.menuScrollPosition&&window.scrollTo(0,window.menuScrollPosition)})})});let attachedPhotos=[],currentReklamaceId=null,currentReklamace=null,pdfPreviewContext=null,cachedPdfDoc=null,cachedPdfBase64=null;async function fetchCsrfToken(){if("function"==typeof getCSRFToken)try{const e=await getCSRFToken();if(e)return e}catch(e){logger?.warn?.("CSRF token z getCSRFToken selhal:",e)}if("function"==typeof getCSRFTokenFromMeta){const e=getCSRFTokenFromMeta();if(e)return e}const e=document.querySelector('meta[name="csrf-token"]');if(e){const t=e.getAttribute("content");if(t)return window.csrfTokenCache=t,t}throw new Error("CSRF token nen√≠ k dispozici. Obnovte str√°nku a zkuste to znovu.")}function setupAutoTranslate(){["description","problem","repair"].forEach(e=>{const t=document.getElementById(e+"-cz");let o;t.addEventListener("input",()=>{clearTimeout(o),o=setTimeout(()=>{t.value.trim().length>5&&translateField(e,!0)},2500)})})}function initSignaturePad(){const e=document.getElementById("signature-pad"),t=()=>{const t=Math.max(window.devicePixelRatio||1,1),o=e.getBoundingClientRect(),a=o.width,n=o.height;e.width=a*t,e.height=n*t,e.getContext("2d").scale(t,t)};window.addEventListener("resize",t,{passive:!0}),t(),signaturePad=new SignaturePad(e,{minWidth:1,maxWidth:2.5,penColor:"black",backgroundColor:"white",throttle:8,velocityFilterWeight:.5,minDistance:2})}async function loadPhotosFromDatabase(e){try{if(!e)return void logger.warn("ID z√°kazn√≠ka nenalezeno");logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),logger.log("üñºÔ∏è NAƒå√çT√ÅM FOTKY Z DATAB√ÅZE"),logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),logger.log("üîë customerId:",e);const t=await fetch(`api/get_photos_api.php?reklamace_id=${e}`),o=await t.json();if(!o.success||0===o.total_photos)return logger.log("‚ùå Fotky nenalezeny v datab√°zi"),showNotif("warning","Nebyly nalezeny fotky"),void logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");logger.log("‚úÖ Fotky naƒçteny z datab√°ze!");const a=o.sections;logger.log("üì¶ Sekce:",Object.keys(a));const n={before:"BEFORE",id:"ID",problem:"DETAIL BUG",repair:"REPAIR",after:"AFTER"};let r=0,l=0;if(["before","id","problem","repair","after"].forEach(e=>{const t=a[e];Array.isArray(t)&&0!==t.length&&(logger.log(`üìÅ Sekce "${e}": ${t.length} polo≈æek`),t.forEach(t=>{"video"===t.type?l++:"image"!==t.type&&t.type||t.data&&(attachedPhotos.push({data:t.data,label:n[e]||e.toUpperCase(),section:e}),r++)}))}),logger.log(`üìä CELKEM: ${r} fotek, ${l} vide√≠`),attachedPhotos.length>0){renderPhotoPreview(attachedPhotos.map(e=>"string"==typeof e?e:e.data)),showNotif("success",`‚úì Naƒçteno ${r} fotek`),logger.log("‚úÖ Fotky √∫spƒõ≈°nƒõ naƒçteny s popisky")}else logger.log("‚ö†Ô∏è ≈Ω√°dn√© fotky k zobrazen√≠"),showNotif("info","≈Ω√°dn√© fotky");logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")}catch(e){logger.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ fotek:",e),showNotif("error","Chyba naƒç√≠t√°n√≠ fotek")}}async function loadReklamace(e){showLoading(!0);try{logger.log("üîç Naƒç√≠t√°m data z√°kazn√≠ka..."),logger.log("üìã ID z URL:",e);const t=localStorage.getItem("currentCustomer");if(t){logger.log("‚úÖ Data nalezena v localStorage");const e=JSON.parse(t);logger.log("üì¶ Data z√°kazn√≠ka:",e);const o=JSON.parse(localStorage.getItem("currentUser")||"{}");if(logger.log("üë§ Aktu√°ln√≠ u≈æivatel:",o.name,"| Role:",o.role),"prodejce"===o.role&&e.zpracoval_id&&e.zpracoval_id!==o.id)return showNotif("error","Nem√°te opr√°vnƒõn√≠ k t√©to zak√°zce"),setTimeout(()=>window.location.href="seznam.php",2e3),void showLoading(!1);logger.log("‚úÖ Opr√°vnƒõn√≠ potvrzeno");const a=e.jmeno||e.zakaznik||"";let n="",r="",l="";if(e.adresa){const t=e.adresa.split(",").map(e=>e.trim());n=t[0]||"",r=t[1]||"",l=t[2]||"",logger.log("üìç Adresa (nov√Ω form√°t):",{ulice:n,mesto:r,psc:l})}else n=e.ulice||"",r=e.mesto||"",l=e.psc||"",logger.log("üìç Adresa (star√Ω form√°t):",{ulice:n,mesto:r,psc:l});return logger.log("üìù Vypl≈àuji formul√°≈ô..."),document.getElementById("order-number").value=e.reklamace_id||"",document.getElementById("claim-number").value=e.cislo||"",document.getElementById("customer").value=a,document.getElementById("address").value=e.adresa||`${n}, ${r}, ${l}`,document.getElementById("phone").value=e.telefon||"",document.getElementById("email").value=e.email||"",document.getElementById("brand").value=e.created_by_name||e.prodejce||"",document.getElementById("model").value=e.model||"",document.getElementById("description-cz").value=e.popis_problemu||"",currentReklamace=e,currentReklamaceId=e.reklamace_id||e.cislo||e.id,logger.log("‚úÖ Data z√°kazn√≠ka √∫spƒõ≈°nƒõ naƒçtena a vyplnƒõna"),showNotif("success","‚úì Data naƒçtena"),void showLoading(!1)}if(logger.warn("‚ö†Ô∏è Data v localStorage nenalezena"),!e)return showNotif("error","Chyb√≠ ID reklamace"),void showLoading(!1);const o=await fetchCsrfToken(),a=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({action:"load_reklamace",id:e,csrf_token:o})});if(!a.ok){const e=await a.text();logger.error("‚ùå Load reklamace error:",a.status,e);try{const t=JSON.parse(e);throw logger.error("‚ùå Load error detail:",t),new Error(t.error||t.message||`Server error ${a.status}`)}catch(t){throw new Error(`Server error ${a.status}: ${e.substring(0,200)}`)}}const n=await a.json();if("success"===n.status){logger.log("‚úÖ Data naƒçtena z API"),currentReklamace=n.reklamace;const e=currentReklamace.jmeno||currentReklamace.zakaznik||"";let t="",o="",a="";if(currentReklamace.adresa){const e=currentReklamace.adresa.split(",").map(e=>e.trim());t=e[0]||"",o=e[1]||"",a=e[2]||""}else t=currentReklamace.ulice||"",o=currentReklamace.mesto||"",a=currentReklamace.psc||"";document.getElementById("order-number").value=currentReklamace.reklamace_id||"",document.getElementById("claim-number").value=currentReklamace.cislo||"",document.getElementById("customer").value=e,document.getElementById("address").value=currentReklamace.adresa||`${t}, ${o}, ${a}`,document.getElementById("phone").value=currentReklamace.telefon||"",document.getElementById("email").value=currentReklamace.email||"",document.getElementById("brand").value=currentReklamace.created_by_name||currentReklamace.prodejce||"",document.getElementById("model").value=currentReklamace.model||"",document.getElementById("description-cz").value=currentReklamace.popis_problemu||"",showNotif("success","Reklamace naƒçtena")}else showNotif("error",n.message||"Reklamace nenalezena")}catch(e){logger.error("‚ùå Chyba naƒç√≠t√°n√≠:",e),showNotif("error","Chyba naƒç√≠t√°n√≠")}finally{showLoading(!1)}}function showLoading(e){document.getElementById("loadingOverlay").classList.toggle("show",e)}function showLoadingWithMessage(e,t="Naƒç√≠t√°n√≠..."){const o=document.getElementById("loadingOverlay"),a=document.getElementById("loadingText");o.classList.toggle("show",e),a&&e&&(a.textContent=t)}function showNotif(e,t){const o=document.getElementById("notif");o.className=`notif ${e}`,o.textContent=t,o.classList.add("show"),setTimeout(()=>o.classList.remove("show"),3e3)}async function attachPhotos(){const e=document.createElement("input");e.type="file",e.accept="image/*",e.multiple=!0,e.capture="environment",e.style.display="none",document.body.appendChild(e),e.onchange=async t=>{const o=Array.from(t.target.files||[]);if(o.length){showNotif("success","Zpracov√°v√°m fotky...");for(const e of o){const t=await compressImage(e,.6),o=await toBase64(t);attachedPhotos.push(o)}renderPhotoPreview(attachedPhotos),showNotif("success",`${o.length} fotek p≈ôid√°no`),e.remove()}},e.click()}async function compressImage(e,t=.6){const o=await loadImage(URL.createObjectURL(e)),a=document.createElement("canvas"),n=a.getContext("2d"),r=Math.min(1,1200/o.width);a.width=o.width*r,a.height=o.height*r,n.drawImage(o,0,0,a.width,a.height);let l=.85,c=await new Promise(e=>a.toBlob(e,"image/jpeg",l));for(;c.size>1024*t*1024&&l>.4;)l-=.05,c=await new Promise(e=>a.toBlob(e,"image/jpeg",l));return c}function loadImage(e){return new Promise((t,o)=>{const a=new Image;a.onload=()=>t(a),a.onerror=o,a.src=e})}function toBase64(e){return new Promise((t,o)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=o,a.readAsDataURL(e)})}function renderPhotoPreview(e){let o=document.getElementById("photoPreviewContainer");o||(o=document.createElement("div"),o.id="photoPreviewContainer",document.querySelector(".wrapper").appendChild(o)),o.innerHTML=`<h3>${t("attached_photos_count").replace("{count}",e.length)}</h3><div id="photoGrid"></div>`;const a=o.querySelector("#photoGrid");e.forEach(e=>{const t="string"==typeof e?e:e.data,o=document.createElement("div");o.className="photo-thumb-wrapper";const n=document.createElement("img");n.src=t,o.addEventListener("click",()=>{window.open(t,"_blank")}),o.appendChild(n),a.appendChild(o)})}async function generateProtocolPDF(){const{jsPDF:e}=window.jspdf,t=new e("p","mm","a4"),o=document.querySelector(".wrapper");logger.log("üìÑ Vytv√°≈ô√≠m desktop clone pro PDF generov√°n√≠...");const a=o.cloneNode(!0);a.classList.add("pdf-clone-desktop"),a.id="pdf-clone-wrapper-temp",document.body.appendChild(a);const n=a.querySelector(".signature-actions");n&&(n.remove(),logger.log('‚úÖ Signature actions (tlaƒç√≠tko "Vymazat podpis" + label) odstranƒõny z PDF'));const r=a.querySelector(".btns");r&&(r.remove(),logger.log("‚úÖ Doln√≠ tlaƒç√≠tka odstranƒõna z PDF"));const l=a.querySelector("#photoPreviewContainer");l&&(l.remove(),logger.log("‚úÖ Photo preview odstranƒõn z PDF (fotky jsou v samostatn√© sekci)"));const c=a.querySelector(".customer-info-arrow");c&&(c.remove(),logger.log("‚úÖ ≈†ipka u z√°kaznick√© hlaviƒçky odstranƒõna z PDF"));const s=a.querySelector(".customer-info-content");s&&(s.style.display="block",s.style.maxHeight="none",s.style.overflow="visible",logger.log("‚úÖ Z√°kaznick√Ω obsah nastaven jako viditeln√Ω v PDF"));const i=o.querySelector("#signature-pad"),d=a.querySelector("#signature-pad");if(i&&d)try{d.getContext("2d").drawImage(i,0,0),logger.log("‚úÖ Signature pad zkop√≠rov√°n do clone")}catch(e){logger.warn("‚ö†Ô∏è Nepoda≈ôilo se zkop√≠rovat signature pad:",e)}await new Promise(e=>setTimeout(e,150)),logger.log("üì∏ Renderuji clone pomoc√≠ html2canvas...");const g=await html2canvas(a,{scale:3,backgroundColor:"#fff",useCORS:!0,logging:!1,imageTimeout:0,allowTaint:!0,letterRendering:!0}),m=g.toDataURL("image/jpeg",.98),u=g.height/g.width;let h=190,p=h*u;p>277&&(p=277,h=p/u);const f=(210-h)/2;return t.addImage(m,"JPEG",f,10,h,p),document.body.removeChild(a),logger.log("‚úÖ Clone odstranƒõn, PDF vygenerov√°no"),t}async function generatePhotosPDF(){if(!attachedPhotos.length)return null;const{jsPDF:e}=window.jspdf,t=new e("p","mm","a4"),o=(t.internal.pageSize.getWidth()-20-5)/2,a=(t.internal.pageSize.getHeight()-20-5)/2;logger.log(`üìÑ Vytv√°≈ô√≠m PDF: ${attachedPhotos.length} fotek, ${Math.ceil(attachedPhotos.length/4)} str√°nek`);for(let e=0;e<attachedPhotos.length;e++){const n=attachedPhotos[e],r="string"==typeof n?n:n.data,l="object"==typeof n?n.label:"";e>0&&e%4==0&&(t.addPage(),logger.log(`üìÑ P≈ôid√°na nov√° str√°nka (fotka ${e+1})`));const c=e%4,s=10+c%2*(o+5),i=10+Math.floor(c/2)*(a+5);l&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(0,0,0),t.text(l,s+1,i+3));const d=i+5,g=o,m=a-5;try{const o=new Image;o.src=r,await new Promise(e=>{o.onload=e,setTimeout(e,100)});let a=o.width||1e3,n=o.height||1e3;const c=a/n;let i,u;c>g/m?(i=g,u=g/c):(u=m,i=m*c);const h=(g-i)/2,p=(m-u)/2;t.addImage(r,"JPEG",s+h,d+p,i,u,void 0,"MEDIUM"),logger.log(`  üì∏ Fotka ${e+1}/${attachedPhotos.length} - ${l||"bez popisku"} (${a}x${n} ‚Üí ${Math.round(i)}x${Math.round(u)}mm)`)}catch(o){logger.warn(`‚ö†Ô∏è Nelze detekovat velikost fotky ${e+1}, pou≈æ√≠v√°m celou bu≈àku`),t.addImage(r,"JPEG",s,d,g,m,void 0,"MEDIUM")}}return logger.log(`‚úÖ PDF s fotkami vytvo≈ôeno (${attachedPhotos.length} fotek s popisky)`),t}async function exportBothPDFs(){try{showLoading(!0),logger.log("üìã Generuji kompletn√≠ PDF (protokol + fotodokumentace)...");const e=await generateProtocolPDF();if(attachedPhotos.length>0){logger.log("üì∏ P≈ôid√°v√°m fotodokumentaci...");const t=e.internal.pageSize.getWidth(),o=e.internal.pageSize.getHeight(),a=10;e.addPage(),e.setFontSize(16),e.setFont("helvetica","bold"),e.text("FOTODOKUMENTACE",t/2,20,{align:"center"});let n=35;e.setFontSize(10),e.setFont("helvetica","normal");[`Cislo reklamace: ${document.getElementById("claim-number")?.value||"N/A"}`,`Datum: ${document.getElementById("sign-date")?.value||(new Date).toLocaleDateString("cs-CZ")}`].forEach(t=>{e.text(t,a,n),n+=6}),n+=5,e.setLineWidth(.5),e.line(a,n,t-a,n),n+=10,e.setFontSize(12),e.setFont("helvetica","bold"),e.text("INDEX PHOTO",a,n),n+=8,e.setFontSize(8),e.setFont("helvetica","normal");const r=25,l=5,c=Math.floor((t-2*a)/(r+l));for(let t=0;t<attachedPhotos.length;t++){const s=attachedPhotos[t],i="string"==typeof s?s:s.data,d="object"==typeof s?s.label:`Fotka ${t+1}`,g=t%c,m=Math.floor(t/c),u=a+g*(r+l),h=n+m*(r+l+4);if(h+r>o-a)e.addPage(),n=20;else try{e.addImage(i,"JPEG",u,h,r,r,void 0,"FAST"),e.setFontSize(7),e.text(`${t+1}. ${d}`,u,h+r+3,{maxWidth:r})}catch(e){logger.warn(`‚ö†Ô∏è Nelze p≈ôidat miniaturu ${t+1}`)}}logger.log(`‚úÖ Index ${attachedPhotos.length} fotek vytvo≈ôen`),e.addPage();const s=5,i=5,d=4,g=2,m=(t-2*a-s)/g,u=(o-2*a-s)/2;for(let t=0;t<attachedPhotos.length;t++){const o=attachedPhotos[t],n="string"==typeof o?o:o.data,r="object"==typeof o?o.label:"";t>0&&t%d===0&&e.addPage();const l=t%d,c=l%g,h=Math.floor(l/g),p=a+c*(m+s),f=a+h*(u+s);r&&(e.setFontSize(8),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text(r,p+1,f+3));const y=f+i,v=m,k=u-i;try{const o=new Image;o.src=n,await new Promise(e=>{o.onload=e,setTimeout(e,100)});const a=(o.width||1e3)/(o.height||1e3);let l,c;a>v/k?(l=v,c=v/a):(c=k,l=k*a);const s=(v-l)/2,i=(k-c)/2;e.addImage(n,"JPEG",p+s,y+i,l,c,void 0,"MEDIUM"),logger.log(`  üì∏ Fotka ${t+1}/${attachedPhotos.length} - ${r}`)}catch(o){logger.warn(`‚ö†Ô∏è Chyba fotky ${t+1}`),e.addImage(n,"JPEG",p,y,v,k,void 0,"MEDIUM")}}logger.log(`‚úÖ Fotodokumentace p≈ôid√°na (${attachedPhotos.length} fotek)`),showNotif("success",`‚úì PDF vytvo≈ôeno (protokol + ${attachedPhotos.length} fotek)`)}else showNotif("success","‚úì Protokol vytvo≈ôen (bez fotek)");logger.log("üíæ Ukl√°d√°m PDF do datab√°ze...");try{const t=await fetchCsrfToken(),o=e.output("datauristring").split(",")[1],a=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"save_pdf_only",reklamace_id:currentReklamaceId,complete_pdf:o,csrf_token:t})});if(a.ok){const e=await a.json();"success"===e.status?logger.log("‚úÖ PDF √∫spƒõ≈°nƒõ ulo≈æen do datab√°ze"):logger.warn("‚ö†Ô∏è PDF se nepoda≈ôilo ulo≈æit:",e.message)}}catch(e){logger.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠ PDF:",e)}const t=e.output("blob"),o=`WGS_Protokol_${(document.getElementById("claim-number")?.value||"protokol").replace(/\s+/g,"_")}.pdf`;pdfPreviewContext="export",cachedPdfDoc=e,cachedPdfBase64=null,"function"==typeof otevritPdfPreview?otevritPdfPreview(t,o):window.open(URL.createObjectURL(t),"_blank"),await saveProtokolToDB(),logger.log("üìã Oznaƒçuji reklamaci jako hotovou...");try{const e=await fetchCsrfToken(),t=await fetch("app/controllers/save.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"update",id:currentReklamaceId,mark_as_completed:"1",csrf_token:e})});"success"===(await t.json()).status&&logger.log("‚úÖ Reklamace oznaƒçena jako hotov√°")}catch(e){logger.error("‚ùå Chyba p≈ôi oznaƒçov√°n√≠:",e)}}catch(e){logger.error("‚ùå Chyba p≈ôi generov√°n√≠ PDF:",e),showNotif("error","Chyba p≈ôi vytv√°≈ôen√≠ PDF")}finally{showLoading(!1)}}async function sendToCustomer(){try{showLoadingWithMessage(!0,"Generuji protokol... Pros√≠m ƒçekejte"),logger.log("üìã Generuji kompletn√≠ PDF pro n√°hled p≈ôed odesl√°n√≠m...");const e=await generateProtocolPDF();if(attachedPhotos.length>0){showLoadingWithMessage(!0,`P≈ôid√°v√°m ${attachedPhotos.length} fotografi√≠... Pros√≠m ƒçekejte`),logger.log("üì∏ P≈ôid√°v√°m fotodokumentaci...");const t=e.internal.pageSize.getWidth(),o=e.internal.pageSize.getHeight(),a=10;e.addPage(),e.setFontSize(16),e.setFont("helvetica","bold"),e.text("FOTODOKUMENTACE",t/2,20,{align:"center"});let n=35;e.setFontSize(10),e.setFont("helvetica","normal");[`Cislo reklamace: ${document.getElementById("claim-number")?.value||"N/A"}`,`Datum: ${document.getElementById("sign-date")?.value||(new Date).toLocaleDateString("cs-CZ")}`].forEach(t=>{e.text(t,a,n),n+=6}),n+=5,e.setLineWidth(.5),e.line(a,n,t-a,n),n+=10,e.setFontSize(12),e.setFont("helvetica","bold"),e.text("INDEX PHOTO",a,n),n+=8,e.setFontSize(8),e.setFont("helvetica","normal");const r=25,l=5,c=Math.floor((t-2*a)/(r+l));for(let t=0;t<attachedPhotos.length;t++){const s=attachedPhotos[t],i="string"==typeof s?s:s.data,d="object"==typeof s?s.label:`Fotka ${t+1}`,g=t%c,m=Math.floor(t/c),u=a+g*(r+l),h=n+m*(r+l+4);if(h+r>o-a)e.addPage(),n=20;else try{e.addImage(i,"JPEG",u,h,r,r,void 0,"FAST"),e.setFontSize(7),e.text(`${t+1}. ${d}`,u,h+r+3,{maxWidth:r})}catch(e){logger.warn(`‚ö†Ô∏è Nelze p≈ôidat miniaturu ${t+1}`)}}logger.log(`‚úÖ Index ${attachedPhotos.length} fotek vytvo≈ôen`),e.addPage();const s=5,i=5,d=4,g=2,m=(t-2*a-s)/g,u=(o-2*a-s)/2;for(let t=0;t<attachedPhotos.length;t++){const o=attachedPhotos[t],n="string"==typeof o?o:o.data,r="object"==typeof o?o.label:"";t>0&&t%d===0&&e.addPage();const l=t%d,c=l%g,h=Math.floor(l/g),p=a+c*(m+s),f=a+h*(u+s);r&&(e.setFontSize(8),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text(r,p+1,f+3));const y=f+i,v=m,k=u-i;try{const o=new Image;o.src=n,await new Promise(e=>{o.onload=e,setTimeout(e,100)});const a=(o.width||1e3)/(o.height||1e3);let l,c;a>v/k?(l=v,c=v/a):(c=k,l=k*a);const s=(v-l)/2,i=(k-c)/2;e.addImage(n,"JPEG",p+s,y+i,l,c,void 0,"MEDIUM"),logger.log(`  üì∏ Fotka ${t+1}/${attachedPhotos.length} - ${r}`)}catch(o){logger.warn(`‚ö†Ô∏è Chyba fotky ${t+1}`),e.addImage(n,"JPEG",p,y,v,k,void 0,"MEDIUM")}}logger.log(`‚úÖ Fotodokumentace p≈ôid√°na (${attachedPhotos.length} fotek)`)}const t=e.output("datauristring").split(",")[1];cachedPdfDoc=e,cachedPdfBase64=t,pdfPreviewContext="send",logger.log("üìß Odes√≠l√°m email p≈ô√≠mo bez n√°hledu..."),await potvrditAOdeslat()}catch(e){logger.error("‚ùå Chyba p≈ôi generov√°n√≠ PDF:",e),showNotif("error","Chyba p≈ôi vytv√°≈ôen√≠ PDF"),showLoadingWithMessage(!1)}}async function potvrditAOdeslat(){if(cachedPdfBase64)try{showLoadingWithMessage(!0,"Odes√≠l√°m email z√°kazn√≠kovi... Pros√≠m ƒçekejte"),logger.log("üìß Odes√≠l√°m PDF z√°kazn√≠kovi...");const e=await fetchCsrfToken(),t=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"send_email",reklamace_id:currentReklamaceId,complete_pdf:cachedPdfBase64,csrf_token:e})});if(!t.ok){const e=await t.text();logger.error("‚ùå Server error:",t.status,e);try{const o=JSON.parse(e);throw logger.error("‚ùå Error detail:",o),new Error(o.error||o.message||`Server error ${t.status}`)}catch(o){throw new Error(`Server error ${t.status}: ${e.substring(0,200)}`)}}const o=await t.json();if("success"===o.status){showNotif("success","‚úì Email odesl√°n z√°kazn√≠kovi"),await saveProtokolToDB(),logger.log("üìã Oznaƒçuji reklamaci jako hotovou...");const t=await fetch("app/controllers/save.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"update",id:currentReklamaceId,mark_as_completed:"1",csrf_token:e})}),o=await t.json();if("success"===o.status?logger.log("‚úÖ Reklamace oznaƒçena jako hotov√°"):logger.warn("‚ö†Ô∏è Nepoda≈ôilo se oznaƒçit jako hotovou:",o.message),currentReklamaceId){const e="photoSections_"+currentReklamaceId,t="photosPDF_"+currentReklamaceId;localStorage.removeItem(e),localStorage.removeItem(t),localStorage.removeItem("photosReadyForProtocol"),localStorage.removeItem("photosCustomerId"),logger.log("‚úÖ Fotky a PDF vymaz√°ny z localStorage")}setTimeout(()=>{window.location.href="seznam.php"},2e3)}else showNotif("error",o.message||"Chyba odes√≠l√°n√≠")}catch(e){logger.error(e),showNotif("error","Chyba odes√≠l√°n√≠: "+e.message)}finally{showLoadingWithMessage(!1)}else showNotif("error","PDF nen√≠ dostupn√©")}async function saveProtokolToDB(){try{const e=await fetchCsrfToken(),t=parseFloat(document.getElementById("price-total").value)||0,o=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"save_protokol",reklamace_id:currentReklamaceId,problem_description:document.getElementById("problem-cz").value,repair_proposal:document.getElementById("repair-cz").value,solved:document.getElementById("solved").value,technician:document.getElementById("technician").value,cena_celkem:t,csrf_token:e})});"success"===(await o.json()).status&&logger.log("Protokol ulo≈æen do DB (vƒçetnƒõ cenov√Ωch √∫daj≈Ø)")}catch(e){logger.error("Chyba ukl√°d√°n√≠:",e)}}function debounce(e,t){let o;return function(...a){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),e(...a)},t)}}async function translateTextApi(e,t="cs",o="en"){if(!e||""===e.trim())return"";try{const a=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${t}&tl=${o}&dt=t&q=`+encodeURIComponent(e),n=await fetch(a),r=await n.json();return r&&r[0]&&r[0][0]&&r[0][0][0]?r[0][0][0]:""}catch(e){return logger.error("Chyba p≈ôekladu:",e),""}}async function translateText(e,t){const o=document.getElementById(e),a=document.getElementById(t);if(!o||!a)return void logger.error("Pole pro p≈ôeklad nenalezeno:",e,t);const n=o.value.trim();if(!n)return void showNotification("Nejd≈ô√≠ve napi≈°te text pro p≈ôeklad","error");const r=o.parentElement.querySelector(".translate-btn");r&&(r.classList.add("loading"),r.disabled=!0);try{logger.log("üîÑ P≈ôekl√°d√°m:",n.substring(0,50)+"...");const e=await translateTextApi(n,"cs","en");e?(a.value=e,logger.log("‚úÖ P≈ôelo≈æeno:",e.substring(0,50)+"..."),showNotification("‚úÖ Text p≈ôelo≈æen","success")):showNotification("P≈ôeklad selhal","error")}catch(e){logger.error("Chyba p≈ôi p≈ôekladu:",e),showNotification("Chyba p≈ôi p≈ôekladu","error")}finally{r&&(r.classList.remove("loading"),r.disabled=!1)}}async function autoTranslateField(e){const t=document.getElementById(e);if(!t)return;const o=t.value.trim();if(!o)return;logger.log("üîÑ P≈ôekl√°d√°m pole:",e);let a=t.parentElement.querySelector(".en-label");if(!a){const e=t.closest(".input-group, .form-group, div");e&&(a=e.querySelector(".en-label"))}if(!a)return void logger.warn("En-label pro",e,"nenalezen");const n=await translateTextApi(o,"cs","en");n&&(a.textContent=n,logger.log("‚úÖ P≈ôelo≈æeno:",e,"->",n.substring(0,50)+"..."))}function initAutoTranslation(){[{source:"description-cz",target:"description-en"},{source:"problem-cz",target:"problem-en"},{source:"repair-cz",target:"repair-en"}].forEach(({source:e,target:t})=>{const o=document.getElementById(e);if(!o)return void logger.warn("Auto-p≈ôeklad: Pole nenalezeno:",e);const a=debounce(()=>{translateText(e,t)},1500);o.addEventListener("input",a),o.addEventListener("blur",()=>{translateText(e,t)}),logger.log("‚úÖ Auto-p≈ôeklad aktivov√°n pro:",e,"‚Üí",t)})}async function translateField(e,t=!1){const o=document.getElementById(e+"-cz"),a=document.getElementById(e+"-en");if(!o||!a)return;const n=o.value.trim();if(n&&!(n.length<5))try{a.value="Prekladam...";const t=await fetch("api/translate_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n,engine:"mymemory"})}),o=await t.json();"success"===o.status?(a.value=o.translated,logger.log("OK:",e)):a.value=""}catch(e){logger.error("Err:",e),a.value=""}}window.addEventListener("DOMContentLoaded",async()=>{logger.log("üöÄ Inicializace protokolu..."),initSignaturePad();const e=new URLSearchParams(window.location.search);currentReklamaceId=e.get("id"),logger.log("üìã ID z URL:",currentReklamaceId),currentReklamaceId?(logger.log("‚úÖ ID nalezeno v URL"),await loadReklamace(currentReklamaceId),loadPhotosFromDatabase(currentReklamaceId)):(logger.warn("‚ö†Ô∏è Chyb√≠ ID v URL - zkus√≠m naƒç√≠st z localStorage"),await loadReklamace(null),currentReklamace&&currentReklamace.id?(logger.log("‚úÖ ID nalezeno v naƒçten√Ωch datech:",currentReklamace.id),currentReklamaceId=currentReklamace.id,loadPhotosFromDatabase(currentReklamaceId)):logger.error("‚ùå ID se nepoda≈ôilo naj√≠t!"));const t=(new Date).toISOString().split("T")[0];document.getElementById("sign-date").value=t,setupAutoTranslate();const o=document.getElementById("solved"),a=document.getElementById("dealer");o&&a&&o.addEventListener("change",()=>{"ANO"===o.value?a.value="NE":"NE"===o.value&&(a.value="ANO")})}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initAutoTranslation):initAutoTranslation(),logger.log("üåê Automatick√Ω p≈ôeklad aktivov√°n"),window.addEventListener("load",()=>{["description","problem","repair"].forEach(e=>{const t=document.getElementById(e+"-cz");if(!t)return;let o;t.addEventListener("input",()=>{clearTimeout(o),o=setTimeout(()=>{t.value.trim().length>10&&translateField(e,!0)},2e3)})}),logger.log("Translate ready")}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;const o=t.getAttribute("data-action");"reload"!==o?"function"==typeof window[o]&&window[o]():location.reload()}),document.addEventListener("click",e=>{const t=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");t&&("function"==typeof navigateTo?navigateTo(t):location.href=t)}),document.addEventListener("change",e=>{const t=e.target.closest("[data-onchange]");if(!t)return;const o=t.getAttribute("data-onchange"),a=t.getAttribute("data-onchange-value")||t.value;"function"==typeof window[o]&&window[o](a)})});