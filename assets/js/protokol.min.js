async function zkontrolujPdfKnihovny(){let e=0;for(;(!window.jspdf||!window.jspdf.jsPDF)&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;if(!window.jspdf||!window.jspdf.jsPDF)throw new Error("jsPDF knihovna se nepoda≈ôila naƒç√≠st. Zkuste obnovit str√°nku (F5).");for(e=0;"undefined"==typeof html2canvas&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;if("undefined"==typeof html2canvas)throw new Error("html2canvas knihovna se nepoda≈ôila naƒç√≠st. Zkuste obnovit str√°nku (F5).");return!0}function showNotification(e,t="info"){const o=document.getElementById("notif");if(!o)return;o.textContent=e,o.className=`notif ${t}`,o.classList.remove("hidden"),o.style.opacity="1";const a=()=>{o.style.opacity="0",setTimeout(()=>{o.classList.add("hidden")},300)};o.onclick=a,"error"!==t?setTimeout(a,3e3):setTimeout(a,5e3)}let signaturePad;!async function(){try{const e=await fetch("app/admin_session_check.php"),o=await e.json();if(!o.logged_in)return wgsToast.error(t("please_log_in")),void(window.location.href="login.php");"prodejce"===o.role&&(wgsToast.error(t("page_for_techs_admins_only")),window.location.href="seznam.php")}catch(e){logger.error("Chyba kontroly p≈ô√≠stupu:",e)}}(),"undefined"==typeof debounce&&(window.debounce=function(e,t){let o;return function(...a){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),e(...a)},t)}});let attachedPhotos=[],currentReklamaceId=null,currentReklamace=null;window.kalkulaceData=null;let pdfPreviewContext=null,cachedPdfDoc=null,cachedPdfBase64=null;function setupAutoTranslate(){["description","problem","repair"].forEach(e=>{const t=document.getElementById(e+"-cz");let o;t.addEventListener("input",()=>{clearTimeout(o),o=setTimeout(()=>{t.value.trim().length>5&&translateField(e,!0)},2500)})})}function setupTextareaAutoResize(){const e=document.querySelectorAll(".split-section textarea");function t(e){const t=parseInt(window.getComputedStyle(e).minHeight)||60;e.style.height="auto";const o=Math.max(e.scrollHeight,t);e.style.height=o+"px"}e.forEach(e=>{e.addEventListener("input",()=>t(e)),e.addEventListener("change",()=>t(e)),e.value.trim().length>0&&setTimeout(()=>t(e),100)}),window.addEventListener("orientationchange",()=>{setTimeout(()=>{e.forEach(e=>t(e))},200)}),window.addEventListener("resize",()=>{e.forEach(e=>t(e))}),logger.log("[AutoResize] Textarea auto-resize aktivovan pro",e.length,"poli"),window.triggerTextareaResize=function(){e.forEach(e=>{e.value.trim().length>0&&t(e)})}}function initSignaturePad(){const e=document.getElementById("signature-pad"),t=()=>{const t=Math.max(window.devicePixelRatio||1,1),o=e.getBoundingClientRect(),a=o.width,n=o.height;e.width=a*t,e.height=n*t,e.getContext("2d").scale(t,t)};window.addEventListener("resize",t,{passive:!0}),t(),signaturePad=new SignaturePad(e,{minWidth:1,maxWidth:2.5,penColor:"black",backgroundColor:"white",throttle:8,velocityFilterWeight:.5,minDistance:2}),window.signaturePad=signaturePad}async function loadPhotosFromDatabase(e){try{if(!e)return void logger.warn("ID z√°kazn√≠ka nenalezeno");logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),logger.log("üñºÔ∏è NAƒå√çT√ÅM FOTKY Z DATAB√ÅZE"),logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),logger.log("customerId:",e);const t=await fetch(`api/get_photos_api.php?reklamace_id=${e}`),o=await t.json();if(!o.success||0===o.total_photos)return logger.log("Fotky nenalezeny v datab√°zi"),showNotif("warning","Nebyly nalezeny fotky"),void logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");logger.log("Fotky naƒçteny z datab√°ze!");const a=o.sections;logger.log("üì¶ Sekce:",Object.keys(a));const n={before:"BEFORE",id:"ID",problem:"DETAIL BUG",damage_part:"DAMAGE PART",new_part:"NEW PART",repair:"REPAIR",after:"AFTER"};let l=0,r=0;if(["before","id","problem","damage_part","new_part","repair","after"].forEach(e=>{const t=a[e];Array.isArray(t)&&0!==t.length&&(logger.log(`üìÅ Sekce "${e}": ${t.length} polo≈æek`),t.forEach(t=>{"video"===t.type?r++:"image"!==t.type&&t.type||t.data&&(attachedPhotos.push({data:t.data,label:n[e]||e.toUpperCase(),section:e}),l++)}))}),logger.log(`[Stats] CELKEM: ${l} fotek, ${r} vide√≠`),attachedPhotos.length>0){renderPhotoPreview(attachedPhotos.map(e=>"string"==typeof e?e:e.data)),showNotif("success",`Naƒçteno ${l} fotek`),logger.log("Fotky √∫spƒõ≈°nƒõ naƒçteny s popisky")}else logger.log("≈Ω√°dn√© fotky k zobrazen√≠"),showNotif("info","≈Ω√°dn√© fotky");logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ fotek:",e),showNotif("error","Chyba naƒç√≠t√°n√≠ fotek")}}async function loadKalkulaceFromDatabase(e){try{if(!e)return void logger.warn("ID z√°kazn√≠ka nenalezeno - kalkulace nebude naƒçtena");logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),logger.log("üí∂ NAƒå√çT√ÅM KALKULACI Z DATAB√ÅZE"),logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),logger.log("customerId:",e);const t=await fetch(`api/get_kalkulace_api.php?reklamace_id=${e}`),o=await t.json();if(!o.success)return logger.log("Kalkulace nenalezena v datab√°zi:",o.error),void logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");if(!o.has_kalkulace)return logger.log("‚ÑπÔ∏è Kalkulace nebyla vytvo≈ôena pro tuto reklamaci"),void logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");logger.log("Kalkulace naƒçtena z datab√°ze!"),kalkulaceData=o.kalkulace,logger.log("üì¶ Kalkulace data:",kalkulaceData),logger.log("üí∞ Celkov√° cena:",kalkulaceData.celkovaCena,"‚Ç¨"),logger.log("[Loc] Adresa:",kalkulaceData.adresa),logger.log("üìè Vzd√°lenost:",kalkulaceData.vzdalenost,"km"),logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),showNotif("success",`Kalkulace naƒçtena (${kalkulaceData.celkovaCena.toFixed(2)} ‚Ç¨)`)}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ kalkulace:",e),showNotif("error","Chyba naƒç√≠t√°n√≠ kalkulace")}}async function loadReklamace(e){showLoading(!0);try{logger.log("Naƒç√≠t√°m data z√°kazn√≠ka..."),logger.log("[List] ID z URL:",e);const t=localStorage.getItem("currentCustomer");if(t){logger.log("Data nalezena v localStorage");const e=JSON.parse(t);logger.log("üì¶ Data z√°kazn√≠ka:",e);const o=JSON.parse(localStorage.getItem("currentUser")||"{}");if(logger.log("[User] Aktu√°ln√≠ u≈æivatel:",o.name,"| Role:",o.role),"prodejce"===o.role&&e.zpracoval_id&&e.zpracoval_id!==o.id)return showNotif("error","Nem√°te opr√°vnƒõn√≠ k t√©to zak√°zce"),setTimeout(()=>window.location.href="seznam.php",2e3),void showLoading(!1);logger.log("Opr√°vnƒõn√≠ potvrzeno");const a=e.jmeno||e.zakaznik||"";let n="",l="",r="";if(e.adresa){const t=e.adresa.split(",").map(e=>e.trim());n=t[0]||"",l=t[1]||"",r=t[2]||"",logger.log("[Loc] Adresa (nov√Ω form√°t):",{ulice:n,mesto:l,psc:r})}else n=e.ulice||"",l=e.mesto||"",r=e.psc||"",logger.log("[Loc] Adresa (star√Ω form√°t):",{ulice:n,mesto:l,psc:r});logger.log("[Edit] Vypl≈àuji formul√°≈ô..."),document.getElementById("order-number").value=e.reklamace_id||"",document.getElementById("claim-number").value=e.cislo||"",document.getElementById("customer").value=a,document.getElementById("address").value=e.adresa||`${n}, ${l}, ${r}`,document.getElementById("phone").value=e.telefon||"",document.getElementById("email").value=e.email||"",document.getElementById("brand").value=e.zadavatel_jmeno||e.created_by_name||"",document.getElementById("model").value=e.model||"",document.getElementById("description-cz").value=e.popis_problemu||"";const i=e.technik||e.prihlaseny_technik||"";return i&&(document.getElementById("technician").value=i),currentReklamace=e,currentReklamaceId=e.reklamace_id||e.cislo||e.id,logger.log("Data z√°kazn√≠ka √∫spƒõ≈°nƒõ naƒçtena a vyplnƒõna"),showNotif("success","Data naƒçtena"),void showLoading(!1)}if(logger.warn("Data v localStorage nenalezena"),!e)return showNotif("error","Chyb√≠ ID reklamace"),void showLoading(!1);const o=await fetchCsrfToken(),a=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({action:"load_reklamace",id:e,csrf_token:o})});if(!a.ok){const e=await a.text();logger.error("Load reklamace error:",a.status,e);try{const t=JSON.parse(e);throw logger.error("Load error detail:",t),new Error(t.error||t.message||`Server error ${a.status}`)}catch(t){throw new Error(`Server error ${a.status}: ${e.substring(0,200)}`)}}const n=await a.json();if("success"===n.status){logger.log("Data naƒçtena z API"),currentReklamace=n.reklamace;const e=currentReklamace.jmeno||currentReklamace.zakaznik||"";let t="",o="",a="";if(currentReklamace.adresa){const e=currentReklamace.adresa.split(",").map(e=>e.trim());t=e[0]||"",o=e[1]||"",a=e[2]||""}else t=currentReklamace.ulice||"",o=currentReklamace.mesto||"",a=currentReklamace.psc||"";document.getElementById("order-number").value=currentReklamace.reklamace_id||"",document.getElementById("claim-number").value=currentReklamace.cislo||"",document.getElementById("customer").value=e,document.getElementById("address").value=currentReklamace.adresa||`${t}, ${o}, ${a}`,document.getElementById("phone").value=currentReklamace.telefon||"",document.getElementById("email").value=currentReklamace.email||"",document.getElementById("brand").value=currentReklamace.zadavatel_jmeno||currentReklamace.created_by_name||"",document.getElementById("model").value=currentReklamace.model||"",document.getElementById("description-cz").value=currentReklamace.popis_problemu||"";const l=currentReklamace.technik||currentReklamace.prihlaseny_technik||"";l&&(document.getElementById("technician").value=l),showNotif("success","Reklamace naƒçtena")}else showNotif("error",n.message||"Reklamace nenalezena")}catch(e){logger.error("Chyba naƒç√≠t√°n√≠:",e),showNotif("error","Chyba naƒç√≠t√°n√≠")}finally{showLoading(!1)}}function showLoading(e){document.getElementById("loadingOverlay").classList.toggle("show",e)}function showLoadingWithMessage(e,t="Naƒç√≠t√°n√≠..."){const o=document.getElementById("loadingOverlay"),a=document.getElementById("loadingText");e?(o.style.display="",o.classList.add("show"),a&&(a.textContent=t)):o.classList.remove("show")}function showNotif(e,t){const o=document.getElementById("notif");o.className=`notif ${e}`,o.textContent=t,o.classList.add("show"),setTimeout(()=>o.classList.remove("show"),3e3)}async function attachPhotos(){const e=document.createElement("input");e.type="file",e.accept="image/*",e.multiple=!0,e.capture="environment",e.classList.add("hidden"),document.body.appendChild(e),e.onchange=async t=>{const o=Array.from(t.target.files||[]);if(o.length){showNotif("success","Zpracov√°v√°m fotky...");for(const e of o){const t=await compressImage(e,.6),o=await toBase64(t);attachedPhotos.push(o)}renderPhotoPreview(attachedPhotos),showNotif("success",`${o.length} fotek p≈ôid√°no`),e.remove()}},e.click()}async function compressImage(e,t=.6){const o=await loadImage(URL.createObjectURL(e)),a=document.createElement("canvas"),n=a.getContext("2d"),l=Math.min(1,1200/o.width);a.width=o.width*l,a.height=o.height*l,n.drawImage(o,0,0,a.width,a.height);let r=.85,i=await new Promise(e=>a.toBlob(e,"image/jpeg",r));for(;i.size>1024*t*1024&&r>.4;)r-=.05,i=await new Promise(e=>a.toBlob(e,"image/jpeg",r));return i}function loadImage(e){return new Promise((t,o)=>{const a=new Image;a.onload=()=>t(a),a.onerror=o,a.src=e})}function toBase64(e){return window.Utils&&window.Utils.toBase64?window.Utils.toBase64(e):new Promise((t,o)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=o,a.readAsDataURL(e)})}function renderPhotoPreview(e){let o=document.getElementById("photoPreviewContainer");o||(o=document.createElement("div"),o.id="photoPreviewContainer",document.querySelector(".wrapper").appendChild(o)),o.innerHTML=`<h3>${t("attached_photos_count").replace("{count}",e.length)}</h3><div id="photoGrid"></div>`;const a=o.querySelector("#photoGrid");e.forEach(e=>{const t="string"==typeof e?e:e.data,o=document.createElement("div");o.className="photo-thumb-wrapper";const n=document.createElement("img");n.src=t,o.addEventListener("click",()=>{window.open(t,"_blank")}),o.appendChild(n),a.appendChild(o)})}async function generateProtocolPDF(){await zkontrolujPdfKnihovny();const{jsPDF:e}=window.jspdf,t=new e("p","mm","a4"),o=document.querySelector(".wrapper");logger.log("[Doc] Vytv√°≈ô√≠m desktop clone pro PDF generov√°n√≠...");const a=o.cloneNode(!0);a.classList.add("pdf-clone-desktop"),a.id="pdf-clone-wrapper-temp",document.body.appendChild(a);const n=a.querySelector(".signature-actions");n&&(n.remove(),logger.log('Signature actions (tlaƒç√≠tko "Vymazat podpis" + label) odstranƒõny z PDF'));const l=a.querySelector(".btn-podepsat-protokol");l&&(l.remove(),logger.log('Tlacitko "Podepsat protokol" odstraneno z PDF'));const r=a.querySelector(".btns");r&&(r.remove(),logger.log("Doln√≠ tlaƒç√≠tka odstranƒõna z PDF"));const i=a.querySelector("#photoPreviewContainer");i&&(i.remove(),logger.log("Photo preview odstranƒõn z PDF (fotky jsou v samostatn√© sekci)"));const c=a.querySelector(".customer-info-arrow");c&&(c.remove(),logger.log("≈†ipka u z√°kaznick√© hlaviƒçky odstranƒõna z PDF"));const s=a.querySelector(".customer-info-content");s&&(s.classList.remove("hidden"),s.style.maxHeight="none",s.style.overflow="visible",logger.log("Z√°kaznick√Ω obsah nastaven jako viditeln√Ω v PDF"));const d=o.querySelectorAll("textarea"),g=a.querySelectorAll("textarea");d.forEach((e,t)=>{g[t]&&(g[t].value=e.value,e.style.height&&(g[t].style.height=e.style.height),g[t].style.minHeight=e.scrollHeight+"px")}),logger.log("Textarea hodnoty a vysky zkopirovany do clone");const u=o.querySelectorAll("input, select"),m=a.querySelectorAll("input, select");u.forEach((e,t)=>{m[t]&&(m[t].value=e.value)});const h=o.querySelector("#signature-pad"),k=a.querySelector("#signature-pad");if(h&&k)try{k.getContext("2d").drawImage(h,0,0),logger.log("Signature pad zkop√≠rov√°n do clone")}catch(e){logger.warn("Nepoda≈ôilo se zkop√≠rovat signature pad:",e)}await new Promise(e=>setTimeout(e,150)),logger.log("[Photo] Renderuji clone pomoc√≠ html2canvas...");const p=await html2canvas(a,{scale:3,backgroundColor:"#fff",useCORS:!0,logging:!1,imageTimeout:0,allowTaint:!0,letterRendering:!0}),v=p.toDataURL("image/jpeg",.98),y=p.height/p.width;let f=190,w=f*y;w>277&&(w=277,f=w/y);const z=(210-f)/2;return t.addImage(v,"JPEG",z,10,f,w),document.body.removeChild(a),logger.log("Clone odstranƒõn, PDF vygenerov√°no"),t}async function generatePhotosPDF(){if(!attachedPhotos.length)return null;await zkontrolujPdfKnihovny();const{jsPDF:e}=window.jspdf,t=new e("p","mm","a4"),o=(t.internal.pageSize.getWidth()-20-5)/2,a=(t.internal.pageSize.getHeight()-20-5)/2;logger.log(`[Doc] Vytv√°≈ô√≠m PDF: ${attachedPhotos.length} fotek, ${Math.ceil(attachedPhotos.length/4)} str√°nek`);for(let e=0;e<attachedPhotos.length;e++){const n=attachedPhotos[e],l="string"==typeof n?n:n.data,r="object"==typeof n?n.label:"";e>0&&e%4==0&&(t.addPage(),logger.log(`[Doc] P≈ôid√°na nov√° str√°nka (fotka ${e+1})`));const i=e%4,c=10+i%2*(o+5),s=10+Math.floor(i/2)*(a+5)+5,d=o,g=a-5;try{const o=new Image;o.src=l,await new Promise(e=>{o.onload=e,setTimeout(e,100)});let a=o.width||1e3,n=o.height||1e3;const i=a/n;let u,m;i>d/g?(u=d,m=d/i):(m=g,u=g*i);const h=(d-u)/2,k=(g-m)/2;r&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(0,0,0),t.text(r,c+h,s+k-2)),t.addImage(l,"JPEG",c+h,s+k,u,m,void 0,"MEDIUM"),logger.log(`  [Photo] Fotka ${e+1}/${attachedPhotos.length} - ${r||"bez popisku"} (${a}x${n} ‚Üí ${Math.round(u)}x${Math.round(m)}mm)`)}catch(o){logger.warn(`Nelze detekovat velikost fotky ${e+1}, pou≈æ√≠v√°m celou bu≈àku`),r&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(0,0,0),t.text(r,c,s-2)),t.addImage(l,"JPEG",c,s,d,g,void 0,"MEDIUM")}}return logger.log(`PDF s fotkami vytvo≈ôeno (${attachedPhotos.length} fotek s popisky)`),t}async function generatePricelistPDF(){if(!kalkulaceData)return logger.log("Kalkulace neexistuje - PRICELIST PDF nebude vygenerovano"),null;logger.log("Generuji PDF PRICELIST..."),await zkontrolujPdfKnihovny();const{jsPDF:e}=window.jspdf,t=new e("p","mm","a4"),o=t.internal.pageSize.getWidth(),a=(t.internal.pageSize.getHeight(),15);let n=a;t.setFontSize(20),t.setFont("helvetica","bold"),t.setTextColor(0,0,0),t.text("PRICELIST",o/2,n,{align:"center"}),n+=15;const l=document.getElementById("customer")?.value||"N/A",r=kalkulaceData.adresa||document.getElementById("address")?.value||"N/A",i=document.getElementById("phone")?.value||"",c=document.getElementById("email")?.value||"",s=document.getElementById("claim-number")?.value||"";if(t.setFontSize(10),t.setFont("helvetica","normal"),t.setTextColor(0,0,0),s&&(t.text(`Cislo reklamace: ${s}`,a,n),n+=6),t.setFont("helvetica","bold"),t.text(`Zakaznik: ${l}`,a,n),n+=6,t.setFont("helvetica","normal"),t.text(`Adresa: ${r}`,a,n),n+=6,i&&(t.text(`Telefon: ${i}`,a,n),n+=6),c&&(t.text(`Email: ${c}`,a,n),n+=6),n+=5,t.setLineWidth(.5),t.setDrawColor(0,0,0),t.line(a,n,o-a,n),n+=10,t.setFontSize(14),t.setFont("helvetica","bold"),t.text("Rozpis cen",a,n),n+=10,t.setFontSize(10),t.setFont("helvetica","normal"),kalkulaceData.reklamaceBezDopravy)t.text("Dopravne (reklamace)",a,n),t.text("0.00 EUR",o-a-30,n),n+=7;else{const e=`Dopravne (${kalkulaceData.vzdalenost} km)`,l=kalkulaceData.dopravne.toFixed(2);t.text(e,a,n),t.text(`${l} EUR`,o-a-30,n),n+=7}if(kalkulaceData.sluzby&&kalkulaceData.sluzby.length>0&&(n+=3,t.setFont("helvetica","bold"),t.text("Sluzby:",a,n),n+=7,t.setFont("helvetica","normal"),kalkulaceData.sluzby.forEach(e=>{const l=`  ${e.nazev}`,r=e.cena.toFixed(2);t.text(l,a,n),t.text(`${r} EUR`,o-a-30,n),n+=6}),n+=3),kalkulaceData.dilyPrace&&kalkulaceData.dilyPrace.length>0&&(n+=3,t.setFont("helvetica","bold"),t.text("Dily a prace:",a,n),n+=7,t.setFont("helvetica","normal"),kalkulaceData.dilyPrace.forEach(e=>{const l=`  ${e.nazev} (${e.pocet}x)`,r=e.cena.toFixed(2);t.text(l,a,n),t.text(`${r} EUR`,o-a-30,n),n+=6}),n+=3),kalkulaceData.tezkyNabytek&&(t.text("Priplatek: Tezky nabytek (nad 50 kg)",a,n),t.text("80.00 EUR",o-a-30,n),n+=7),kalkulaceData.druhaOsoba&&(t.text("Priplatek: Druha osoba",a,n),t.text("80.00 EUR",o-a-30,n),n+=7),n+=5,t.setLineWidth(.3),t.line(a,n,o-a,n),n+=8,t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(0,0,0),t.text("CELKEM:",a,n),t.text(`${kalkulaceData.celkovaCena.toFixed(2)} EUR`,o-a-40,n),n+=10,kalkulaceData.poznamka){n+=5,t.setFontSize(10),t.setFont("helvetica","italic"),t.setTextColor(100,100,100),t.text("Poznamka:",a,n),n+=6,t.setFont("helvetica","normal");t.splitTextToSize(kalkulaceData.poznamka,o-30).forEach(e=>{t.text(e,a,n),n+=5})}return logger.log(`PDF PRICELIST vytvo≈ôen (${kalkulaceData.celkovaCena.toFixed(2)} ‚Ç¨)`),t}async function exportBothPDFs(){try{showLoading(!0),logger.log("[List] Generuji kompletn√≠ PDF (protokol + PRICELIST + fotodokumentace)..."),logger.log("üí∞ Kontrola kalkulace - kalkulaceData:",kalkulaceData);const e=await generateProtocolPDF();if(kalkulaceData){logger.log("Kalkulace nalezena - p≈ôid√°v√°m PRICELIST..."),logger.log("[Stats] Kalkulace data:",kalkulaceData),e.addPage();const t=e.internal.pageSize.getWidth(),o=(e.internal.pageSize.getHeight(),15);let a=o;e.setFontSize(20),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text("PRICELIST",t/2,a,{align:"center"}),a+=15;const n=document.getElementById("customer")?.value||"N/A",l=kalkulaceData.adresa||document.getElementById("address")?.value||"N/A",r=document.getElementById("phone")?.value||"",i=document.getElementById("email")?.value||"",c=document.getElementById("claim-number")?.value||"";if(e.setFontSize(10),e.setFont("helvetica","normal"),e.setTextColor(0,0,0),c&&(e.text(`Cislo reklamace: ${c}`,o,a),a+=6),e.setFont("helvetica","bold"),e.text(`Zakaznik: ${n}`,o,a),a+=6,e.setFont("helvetica","normal"),e.text(`Adresa: ${l}`,o,a),a+=6,r&&(e.text(`Telefon: ${r}`,o,a),a+=6),i&&(e.text(`Email: ${i}`,o,a),a+=6),a+=5,e.setLineWidth(.5),e.setDrawColor(0,0,0),e.line(o,a,t-o,a),a+=10,e.setFontSize(14),e.setFont("helvetica","bold"),e.text("Rozpis cen",o,a),a+=10,e.setFontSize(10),e.setFont("helvetica","normal"),kalkulaceData.reklamaceBezDopravy)e.text("Dopravne (reklamace)",o,a),e.text("0.00 EUR",t-o-30,a),a+=7;else{const n=`Dopravne (${kalkulaceData.vzdalenost} km)`,l=kalkulaceData.dopravne.toFixed(2);e.text(n,o,a),e.text(`${l} EUR`,t-o-30,a),a+=7}kalkulaceData.dilyPrace&&kalkulaceData.dilyPrace.length>0&&(a+=3,e.setFont("helvetica","bold"),e.text("Dily a prace:",o,a),a+=7,e.setFont("helvetica","normal"),kalkulaceData.dilyPrace.forEach(n=>{const l=`  ${n.nazev} (${n.pocet}x)`,r=n.cena.toFixed(2);e.text(l,o,a),e.text(`${r} EUR`,t-o-30,a),a+=6}),a+=3),kalkulaceData.tezkyNabytek&&(e.text("Priplatek: Tezky nabytek (nad 50 kg)",o,a),e.text("80.00 EUR",t-o-30,a),a+=7),kalkulaceData.druhaOsoba&&(e.text("Priplatek: Druha osoba",o,a),e.text("80.00 EUR",t-o-30,a),a+=7),a+=5,e.setLineWidth(.3),e.line(o,a,t-o,a),a+=8,e.setFontSize(14),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text("CELKEM:",o,a),e.text(`${kalkulaceData.celkovaCena.toFixed(2)} EUR`,t-o-40,a),logger.log(`PRICELIST p≈ôid√°n (${kalkulaceData.celkovaCena.toFixed(2)} ‚Ç¨)`)}else logger.warn("Kalkulace nenalezena - PRICELIST nebude v PDF"),logger.warn("   Mo≈æn√© p≈ô√≠ƒçiny:"),logger.warn("   1. Kalkulace nebyla vytvo≈ôena"),logger.warn("   2. Kalkulace nebyla ulo≈æena do datab√°ze"),logger.warn("   3. Chyba p≈ôi naƒç√≠t√°n√≠ z datab√°ze");if(attachedPhotos.length>0){logger.log("[Photo] P≈ôid√°v√°m fotodokumentaci...");const t=e.internal.pageSize.getWidth(),o=e.internal.pageSize.getHeight(),a=10;e.addPage(),e.setFontSize(16),e.setFont("helvetica","bold"),e.text("FOTODOKUMENTACE",t/2,20,{align:"center"});let n=35;e.setFontSize(10),e.setFont("helvetica","normal");[`Cislo reklamace: ${document.getElementById("claim-number")?.value||"N/A"}`,`Datum: ${document.getElementById("sign-date")?.value||(new Date).toLocaleDateString("cs-CZ")}`].forEach(t=>{e.text(t,a,n),n+=6}),n+=5,e.setLineWidth(.5),e.line(a,n,t-a,n),n+=10,e.setFontSize(12),e.setFont("helvetica","bold"),e.text("INDEX PHOTO",a,n),n+=8,e.setFontSize(8),e.setFont("helvetica","normal");const l=25,r=5,i=Math.floor((t-2*a)/(l+r));for(let t=0;t<attachedPhotos.length;t++){const c=attachedPhotos[t],s="string"==typeof c?c:c.data,d="object"==typeof c?c.label:`Fotka ${t+1}`,g=t%i,u=Math.floor(t/i),m=a+g*(l+r),h=n+u*(l+r+4);if(h+l>o-a)e.addPage(),n=20;else try{e.addImage(s,"JPEG",m,h,l,l,void 0,"FAST"),e.setFontSize(7),e.text(`${t+1}. ${d}`,m,h+l+3,{maxWidth:l})}catch(e){logger.warn(`Nelze p≈ôidat miniaturu ${t+1}`)}}logger.log(`Index ${attachedPhotos.length} fotek vytvo≈ôen`),e.addPage();const c=5,s=5,d=4,g=2,u=(t-2*a-c)/g,m=(o-2*a-c)/2;for(let t=0;t<attachedPhotos.length;t++){const o=attachedPhotos[t],n="string"==typeof o?o:o.data,l="object"==typeof o?o.label:"";t>0&&t%d===0&&e.addPage();const r=t%d,i=r%g,h=Math.floor(r/g),k=a+i*(u+c),p=a+h*(m+c)+s,v=u,y=m-s;try{const o=new Image;o.src=n,await new Promise(e=>{o.onload=e,setTimeout(e,100)});const a=(o.width||1e3)/(o.height||1e3);let r,i;a>v/y?(r=v,i=v/a):(i=y,r=y*a);const c=(v-r)/2,s=(y-i)/2;l&&(e.setFontSize(8),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text(l,k+c,p+s-2)),e.addImage(n,"JPEG",k+c,p+s,r,i,void 0,"MEDIUM"),logger.log(`  [Photo] Fotka ${t+1}/${attachedPhotos.length} - ${l}`)}catch(o){logger.warn(`Chyba fotky ${t+1}`),l&&(e.setFontSize(8),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text(l,k,p-2)),e.addImage(n,"JPEG",k,p,v,y,void 0,"MEDIUM")}}logger.log(`Fotodokumentace p≈ôid√°na (${attachedPhotos.length} fotek)`),"undefined"!=typeof WGSToast?WGSToast.zobrazit(`PDF vytvo≈ôeno (protokol + ${attachedPhotos.length} fotek)`,{titulek:"WGS"}):showNotif("success",`PDF vytvo≈ôeno (protokol + ${attachedPhotos.length} fotek)`)}else"undefined"!=typeof WGSToast?WGSToast.zobrazit("Protokol vytvo≈ôen",{titulek:"WGS"}):showNotif("success","Protokol vytvo≈ôen (bez fotek)");logger.log("[Save] Ukl√°d√°m PDF do datab√°ze...");try{const t=await fetchCsrfToken(),o=e.output("datauristring").split(",")[1],a=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"save_pdf_only",reklamace_id:currentReklamaceId,complete_pdf:o,csrf_token:t})});if(a.ok){const e=await a.json();"success"===e.status?logger.log("PDF √∫spƒõ≈°nƒõ ulo≈æen do datab√°ze"):logger.warn("PDF se nepoda≈ôilo ulo≈æit:",e.message)}}catch(e){logger.error("Chyba p≈ôi ukl√°d√°n√≠ PDF:",e)}const t=e.output("blob"),o=`WGS_Protokol_${(document.getElementById("claim-number")?.value||"protokol").replace(/\s+/g,"_")}.pdf`;pdfPreviewContext="export",cachedPdfDoc=e,cachedPdfBase64=null,"function"==typeof otevritPdfPreview?otevritPdfPreview(t,o):window.open(URL.createObjectURL(t),"_blank"),await saveProtokolToDB(),logger.log("[List] Oznaƒçuji reklamaci jako hotovou...");try{const e=await fetchCsrfToken(),t=await fetch("app/controllers/save.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"update",id:currentReklamaceId,mark_as_completed:"1",csrf_token:e})});"success"===(await t.json()).status&&logger.log("Reklamace oznaƒçena jako hotov√°")}catch(e){logger.error("Chyba p≈ôi oznaƒçov√°n√≠:",e)}}catch(e){logger.error("Chyba p≈ôi generov√°n√≠ PDF:",e),showNotif("error","Chyba p≈ôi vytv√°≈ôen√≠ PDF")}finally{showLoading(!1)}}async function sendToCustomer(){try{showLoadingWithMessage(!0,"Generuji protokol... Pros√≠m ƒçekejte"),logger.log("[List] Generuji kompletn√≠ PDF pro n√°hled p≈ôed odesl√°n√≠m..."),logger.log("üí∞ Kontrola kalkulace - kalkulaceData:",kalkulaceData);const e=await generateProtocolPDF();if(kalkulaceData){showLoadingWithMessage(!0,`P≈ôid√°v√°m PRICELIST (${kalkulaceData.celkovaCena.toFixed(2)} ‚Ç¨)... Pros√≠m ƒçekejte`),logger.log("Kalkulace nalezena - p≈ôid√°v√°m PRICELIST..."),logger.log("[Stats] Kalkulace data:",kalkulaceData),e.addPage();const t=e.internal.pageSize.getWidth(),o=(e.internal.pageSize.getHeight(),15);let a=o;e.setFontSize(20),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text("PRICELIST",t/2,a,{align:"center"}),a+=15;const n=document.getElementById("customer")?.value||"N/A",l=kalkulaceData.adresa||document.getElementById("address")?.value||"N/A",r=document.getElementById("phone")?.value||"",i=document.getElementById("email")?.value||"",c=document.getElementById("claim-number")?.value||"";if(e.setFontSize(10),e.setFont("helvetica","normal"),e.setTextColor(0,0,0),c&&(e.text(`Cislo reklamace: ${c}`,o,a),a+=6),e.setFont("helvetica","bold"),e.text(`Zakaznik: ${n}`,o,a),a+=6,e.setFont("helvetica","normal"),e.text(`Adresa: ${l}`,o,a),a+=6,r&&(e.text(`Telefon: ${r}`,o,a),a+=6),i&&(e.text(`Email: ${i}`,o,a),a+=6),a+=5,e.setLineWidth(.5),e.setDrawColor(0,0,0),e.line(o,a,t-o,a),a+=10,e.setFontSize(14),e.setFont("helvetica","bold"),e.text("Rozpis cen",o,a),a+=10,e.setFontSize(10),e.setFont("helvetica","normal"),kalkulaceData.reklamaceBezDopravy)e.text("Dopravne (reklamace)",o,a),e.text("0.00 EUR",t-o-30,a),a+=7;else{const n=`Dopravne (${kalkulaceData.vzdalenost} km)`,l=kalkulaceData.dopravne.toFixed(2);e.text(n,o,a),e.text(`${l} EUR`,t-o-30,a),a+=7}kalkulaceData.dilyPrace&&kalkulaceData.dilyPrace.length>0&&(a+=3,e.setFont("helvetica","bold"),e.text("Dily a prace:",o,a),a+=7,e.setFont("helvetica","normal"),kalkulaceData.dilyPrace.forEach(n=>{const l=`  ${n.nazev} (${n.pocet}x)`,r=n.cena.toFixed(2);e.text(l,o,a),e.text(`${r} EUR`,t-o-30,a),a+=6}),a+=3),kalkulaceData.tezkyNabytek&&(e.text("Priplatek: Tezky nabytek (nad 50 kg)",o,a),e.text("80.00 EUR",t-o-30,a),a+=7),kalkulaceData.druhaOsoba&&(e.text("Priplatek: Druha osoba",o,a),e.text("80.00 EUR",t-o-30,a),a+=7),a+=5,e.setLineWidth(.3),e.line(o,a,t-o,a),a+=8,e.setFontSize(14),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text("CELKEM:",o,a),e.text(`${kalkulaceData.celkovaCena.toFixed(2)} EUR`,t-o-40,a),logger.log(`PRICELIST p≈ôid√°n (${kalkulaceData.celkovaCena.toFixed(2)} ‚Ç¨)`)}else logger.warn("Kalkulace nenalezena - PRICELIST nebude v emailu"),logger.warn("   Zkontrolujte, zda byla kalkulace vytvo≈ôena a ulo≈æena");if(attachedPhotos.length>0){showLoadingWithMessage(!0,`P≈ôid√°v√°m ${attachedPhotos.length} fotografi√≠... Pros√≠m ƒçekejte`),logger.log("[Photo] P≈ôid√°v√°m fotodokumentaci...");const t=e.internal.pageSize.getWidth(),o=e.internal.pageSize.getHeight(),a=10;e.addPage(),e.setFontSize(16),e.setFont("helvetica","bold"),e.text("FOTODOKUMENTACE",t/2,20,{align:"center"});let n=35;e.setFontSize(10),e.setFont("helvetica","normal");[`Cislo reklamace: ${document.getElementById("claim-number")?.value||"N/A"}`,`Datum: ${document.getElementById("sign-date")?.value||(new Date).toLocaleDateString("cs-CZ")}`].forEach(t=>{e.text(t,a,n),n+=6}),n+=5,e.setLineWidth(.5),e.line(a,n,t-a,n),n+=10,e.setFontSize(12),e.setFont("helvetica","bold"),e.text("INDEX PHOTO",a,n),n+=8,e.setFontSize(8),e.setFont("helvetica","normal");const l=25,r=5,i=Math.floor((t-2*a)/(l+r));for(let t=0;t<attachedPhotos.length;t++){const c=attachedPhotos[t],s="string"==typeof c?c:c.data,d="object"==typeof c?c.label:`Fotka ${t+1}`,g=t%i,u=Math.floor(t/i),m=a+g*(l+r),h=n+u*(l+r+4);if(h+l>o-a)e.addPage(),n=20;else try{e.addImage(s,"JPEG",m,h,l,l,void 0,"FAST"),e.setFontSize(7),e.text(`${t+1}. ${d}`,m,h+l+3,{maxWidth:l})}catch(e){logger.warn(`Nelze p≈ôidat miniaturu ${t+1}`)}}logger.log(`Index ${attachedPhotos.length} fotek vytvo≈ôen`),e.addPage();const c=5,s=5,d=4,g=2,u=(t-2*a-c)/g,m=(o-2*a-c)/2;for(let t=0;t<attachedPhotos.length;t++){const o=attachedPhotos[t],n="string"==typeof o?o:o.data,l="object"==typeof o?o.label:"";t>0&&t%d===0&&e.addPage();const r=t%d,i=r%g,h=Math.floor(r/g),k=a+i*(u+c),p=a+h*(m+c)+s,v=u,y=m-s;try{const o=new Image;o.src=n,await new Promise(e=>{o.onload=e,setTimeout(e,100)});const a=(o.width||1e3)/(o.height||1e3);let r,i;a>v/y?(r=v,i=v/a):(i=y,r=y*a);const c=(v-r)/2,s=(y-i)/2;l&&(e.setFontSize(8),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text(l,k+c,p+s-2)),e.addImage(n,"JPEG",k+c,p+s,r,i,void 0,"MEDIUM"),logger.log(`  [Photo] Fotka ${t+1}/${attachedPhotos.length} - ${l}`)}catch(o){logger.warn(`Chyba fotky ${t+1}`),l&&(e.setFontSize(8),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text(l,k,p-2)),e.addImage(n,"JPEG",k,p,v,y,void 0,"MEDIUM")}}logger.log(`Fotodokumentace p≈ôid√°na (${attachedPhotos.length} fotek)`)}const t=e.output("datauristring").split(",")[1];cachedPdfDoc=e,cachedPdfBase64=t,pdfPreviewContext="send",logger.log("üìß Odes√≠l√°m email p≈ô√≠mo bez n√°hledu..."),await potvrditAOdeslat()}catch(e){logger.error("Chyba p≈ôi generov√°n√≠ PDF:",e),showNotif("error","Chyba p≈ôi vytv√°≈ôen√≠ PDF"),showLoadingWithMessage(!1)}}async function potvrditAOdeslat(){if(cachedPdfBase64)try{showLoadingWithMessage(!0,"Odes√≠l√°m email z√°kazn√≠kovi... Pros√≠m ƒçekejte"),logger.log("üìß Odes√≠l√°m PDF z√°kazn√≠kovi...");const e=await fetchCsrfToken(),t=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"send_email",reklamace_id:currentReklamaceId,complete_pdf:cachedPdfBase64,csrf_token:e})});if(!t.ok){const e=await t.text();logger.error("Server error:",t.status,e);try{const o=JSON.parse(e);throw logger.error("Error detail:",o),new Error(o.error||o.message||`Server error ${t.status}`)}catch(o){throw new Error(`Server error ${t.status}: ${e.substring(0,200)}`)}}const o=await t.json();if("success"===o.status){"undefined"!=typeof WGSToast?WGSToast.zobrazit("Email odesl√°n z√°kazn√≠kovi",{titulek:"WGS"}):showNotif("success","Email odesl√°n z√°kazn√≠kovi"),await saveProtokolToDB(),logger.log("[List] Oznaƒçuji reklamaci jako hotovou...");const t=await fetch("app/controllers/save.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"update",id:currentReklamaceId,mark_as_completed:"1",csrf_token:e})}),o=await t.json();if("success"===o.status?logger.log("Reklamace oznaƒçena jako hotov√°"):logger.warn("Nepoda≈ôilo se oznaƒçit jako hotovou:",o.message),currentReklamaceId){const e="photoSections_"+currentReklamaceId,t="photosPDF_"+currentReklamaceId;localStorage.removeItem(e),localStorage.removeItem(t),localStorage.removeItem("photosReadyForProtocol"),localStorage.removeItem("photosCustomerId"),logger.log("Fotky a PDF vymaz√°ny z localStorage")}setTimeout(()=>{window.location.href="seznam.php"},2e3)}else showNotif("error",o.message||"Chyba odes√≠l√°n√≠")}catch(e){logger.error(e),showNotif("error","Chyba odes√≠l√°n√≠: "+e.message)}finally{showLoadingWithMessage(!1)}else showNotif("error","PDF nen√≠ dostupn√©")}async function saveProtokolToDB(){try{const e=await fetchCsrfToken(),t=parseFloat(document.getElementById("price-total").value)||0,o=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"save_protokol",reklamace_id:currentReklamaceId,problem_description:document.getElementById("problem-cz").value,repair_proposal:document.getElementById("repair-cz").value,solved:document.getElementById("solved").value,dealer:document.getElementById("dealer")?.value||"NE",technician:document.getElementById("technician").value,cena_celkem:t,csrf_token:e})});"success"===(await o.json()).status&&logger.log("Protokol ulo≈æen do DB (vƒçetnƒõ cenov√Ωch √∫daj≈Ø)")}catch(e){logger.error("Chyba ukl√°d√°n√≠:",e)}}async function translateTextApi(e,t="cs",o="en"){if(!e||""===e.trim())return"";try{const a=await fetch("api/translate_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,source:t,target:o})}),n=await a.json();return n.status==="success"&&n.translated?n.translated:(logger.warn("P≈ôeklad selhal:",n.message||"Nezn√°m√° chyba"),"")}catch(e){return logger.error("Chyba p≈ôekladu:",e),""}}async function translateText(e,t){const o=document.getElementById(e),a=document.getElementById(t);if(!o||!a)return void logger.error("Pole pro p≈ôeklad nenalezeno:",e,t);const n=o.value.trim();if(!n)return void showNotification("Nejd≈ô√≠ve napi≈°te text pro p≈ôeklad","error");const l=o.parentElement.querySelector(".translate-btn");l&&(l.classList.add("loading"),l.disabled=!0);try{logger.log("[Sync] P≈ôekl√°d√°m:",n.substring(0,50)+"...");const e=await translateTextApi(n,"cs","en");e?(a.value=e,logger.log("P≈ôelo≈æeno:",e.substring(0,50)+"..."),showNotification("Text p≈ôelo≈æen","success")):showNotification("P≈ôeklad selhal","error")}catch(e){logger.error("Chyba p≈ôi p≈ôekladu:",e),showNotification("Chyba p≈ôi p≈ôekladu","error")}finally{l&&(l.classList.remove("loading"),l.disabled=!1)}}async function autoTranslateField(e){const t=document.getElementById(e);if(!t)return;const o=t.value.trim();if(!o)return;logger.log("[Sync] P≈ôekl√°d√°m pole:",e);let a=t.parentElement.querySelector(".en-label");if(!a){const e=t.closest(".input-group, .form-group, div");e&&(a=e.querySelector(".en-label"))}if(!a)return void logger.warn("En-label pro",e,"nenalezen");const n=await translateTextApi(o,"cs","en");n&&(a.textContent=n,logger.log("P≈ôelo≈æeno:",e,"->",n.substring(0,50)+"..."))}function initAutoTranslation(){[{source:"description-cz",target:"description-en"},{source:"problem-cz",target:"problem-en"},{source:"repair-cz",target:"repair-en"}].forEach(({source:e,target:t})=>{const o=document.getElementById(e);if(!o)return void logger.warn("Auto-p≈ôeklad: Pole nenalezeno:",e);const a=debounce(()=>{translateText(e,t)},1500);o.addEventListener("input",a),o.addEventListener("blur",()=>{translateText(e,t)}),logger.log("Auto-p≈ôeklad aktivov√°n pro:",e,"‚Üí",t)})}async function translateField(e,t=!1){const o=document.getElementById(e+"-cz"),a=document.getElementById(e+"-en");if(!o||!a)return;const n=o.value.trim();if(n&&!(n.length<5))try{a.value="Prekladam...";const t=await fetch("api/translate_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n,engine:"mymemory"})}),o=await t.json();"success"===o.status?(a.value=o.translated,logger.log("OK:",e)):a.value=""}catch(e){logger.error("Err:",e),a.value=""}}window.addEventListener("DOMContentLoaded",async()=>{logger.log("[Start] Inicializace protokolu..."),initSignaturePad();const e=new URLSearchParams(window.location.search);currentReklamaceId=e.get("id"),logger.log("[List] ID z URL:",currentReklamaceId),currentReklamaceId?(logger.log("ID nalezeno v URL"),await loadReklamace(currentReklamaceId),loadPhotosFromDatabase(currentReklamaceId),loadKalkulaceFromDatabase(currentReklamaceId)):(logger.warn("Chyb√≠ ID v URL - zkus√≠m naƒç√≠st z localStorage"),await loadReklamace(null),currentReklamace&&currentReklamace.id?(logger.log("ID nalezeno v naƒçten√Ωch datech:",currentReklamace.id),currentReklamaceId=currentReklamace.id,loadPhotosFromDatabase(currentReklamaceId),loadKalkulaceFromDatabase(currentReklamaceId)):logger.error("ID se nepoda≈ôilo naj√≠t!"));const t=(new Date).toISOString().split("T")[0];document.getElementById("sign-date").value=t,setupAutoTranslate(),setupTextareaAutoResize(),setTimeout(()=>{window.triggerTextareaResize&&window.triggerTextareaResize()},300);const o=document.getElementById("solved"),a=document.getElementById("dealer");o&&a&&o.addEventListener("change",()=>{"ANO"===o.value?a.value="NE":"NE"===o.value&&(a.value="ANO")})}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initAutoTranslation):initAutoTranslation(),logger.log("Automatick√Ω p≈ôeklad aktivov√°n"),window.addEventListener("load",()=>{["description","problem","repair"].forEach(e=>{const t=document.getElementById(e+"-cz");if(!t)return;let o;t.addEventListener("input",()=>{clearTimeout(o),o=setTimeout(()=>{t.value.trim().length>10&&translateField(e,!0)},2e3)})}),logger.log("Translate ready")}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;const o=t.getAttribute("data-action");"reload"!==o?"function"==typeof window[o]&&window[o]():location.reload()}),document.addEventListener("click",e=>{const t=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");t&&("function"==typeof navigateTo?navigateTo(t):location.href=t)}),document.addEventListener("change",e=>{const t=e.target.closest("[data-onchange]");if(!t)return;const o=t.getAttribute("data-onchange"),a=t.getAttribute("data-onchange-value")||t.value;"function"==typeof window[o]&&window[o](a)})}),function(){let e=null;document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("btnPodepsatProtokol"),o=document.getElementById("zakaznikSchvaleniOverlay"),a=document.getElementById("zakaznikSchvaleniPouzit"),n=document.getElementById("zakaznikVymazatPodpis"),l=document.getElementById("zakaznikSchvaleniPad");if(!t||!o||!l)return;t.addEventListener("click",async()=>{t.disabled=!0,t.textContent="Pripravuji...";try{await async function(){const t=document.getElementById("zakaznikSchvaleniPad");logger.log("[Podpis] Spoustim pojistku prekladu pred podpisem...");const o=["description","problem","repair"];for(const e of o){const t=document.getElementById(e+"-cz"),o=document.getElementById(e+"-en");if(t&&o&&t.value.trim().length>5&&(!o.value||"Prekladam..."===o.value||""===o.value.trim())){logger.log("[Podpis] Prekladam pole:",e);try{await translateField(e,!0)}catch(t){logger.warn("[Podpis] Preklad selhal pro:",e,t)}}}logger.log("[Podpis] Pojistka prekladu dokoncena"),function(){const e=document.getElementById("repair-cz")?.value||"",t=document.getElementById("zakaznikSchvaleniText");t&&(t.textContent=e||"(Nen√≠ vyplnƒõno)");const o=document.getElementById("payment")?.value||"-";document.getElementById("souhrn-plati-zakaznik").textContent=o;const a=document.getElementById("sign-date")?.value||"-";let n="-";if(a&&"-"!==a){const e=new Date(a);n=isNaN(e.getTime())?a:e.toLocaleDateString("cs-CZ")}document.getElementById("souhrn-datum-podpisu").textContent=n;const l=document.getElementById("solved")?.value||"-";document.getElementById("souhrn-vyreseno").textContent=l;const r=document.getElementById("dealer")?.value||"-";document.getElementById("souhrn-prodejce").textContent=r;const i=document.getElementById("damage")?.value||"-";document.getElementById("souhrn-poskozeni").textContent=i}();const a=document.getElementById("typ-zakaznika")?.value||"",n=document.querySelector(".tabulka-checkbox-row"),l=document.getElementById("checkboxProdlouzeniLhuty"),r=document.getElementById("prodlouzeniLhutyText");if(n){a.toLowerCase().includes("fyzick√°")||a.toLowerCase().includes("fyzicka")||"Fyzick√° osoba"===a?(n.style.display="",logger.log("[ZakaznikSchvaleni] Checkbox prodlou≈æen√≠ lh≈Øty zobrazen (fyzick√° osoba)")):(n.style.display="none",l&&(l.checked=!1),r&&(r.style.display="none"),logger.log("[ZakaznikSchvaleni] Checkbox prodlou≈æen√≠ lh≈Øty skryt (IƒåO:",a,")"))}if(window.zakaznikSchvaleniModal&&window.zakaznikSchvaleniModal.open)window.zakaznikSchvaleniModal.open();else{const e=document.getElementById("zakaznikSchvaleniOverlay");e&&e.classList.remove("hidden"),window.scrollLock&&window.scrollLock.enable("zakaznik-schvaleni-overlay")}setTimeout(()=>{!function(t){if(!t)return;if(e&&e.canvas===t)return void e.clear();const o=t.getBoundingClientRect();t.width=o.width,t.height=o.height;const a=t.getContext("2d");a.fillStyle="white",a.fillRect(0,0,t.width,t.height),e={canvas:t,ctx:a,isDrawing:!1,lastX:0,lastY:0,clear:function(){this.ctx.fillStyle="white",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},isEmpty:function(){const e=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height).data;for(let t=3;t<e.length;t+=4)if(e[t]>0)return!1;return!0},toDataURL:function(){return this.canvas.toDataURL("image/png")}},a.strokeStyle="#000000",a.lineWidth=2,a.lineCap="round",a.lineJoin="round";const n=e=>{const o=t.getBoundingClientRect();return e.touches&&e.touches.length>0?{x:e.touches[0].clientX-o.left,y:e.touches[0].clientY-o.top}:{x:e.clientX-o.left,y:e.clientY-o.top}},l=t=>{t.preventDefault(),e.isDrawing=!0;const o=n(t);e.lastX=o.x,e.lastY=o.y},r=t=>{if(!e.isDrawing)return;t.preventDefault();const o=n(t);a.beginPath(),a.moveTo(e.lastX,e.lastY),a.lineTo(o.x,o.y),a.stroke(),e.lastX=o.x,e.lastY=o.y},i=()=>{e.isDrawing=!1};t.addEventListener("mousedown",l),t.addEventListener("mousemove",r),t.addEventListener("mouseup",i),t.addEventListener("mouseout",i),t.addEventListener("touchstart",l,{passive:!1}),t.addEventListener("touchmove",r,{passive:!1}),t.addEventListener("touchend",i),t.addEventListener("touchcancel",i)}(t)},100)}()}finally{t.disabled=!1,t.textContent="Podepsat protokol"}}),n?.addEventListener("click",()=>{e&&e.clear()}),a?.addEventListener("click",()=>{!function(){if(!e||e.isEmpty())return void("function"==typeof showNotif?showNotif("error","Pros√≠m podepi≈°te se p≈ôed potvrzen√≠m"):wgsToast.warning("Pros√≠m podepi≈°te se p≈ôed potvrzen√≠m"));const t=document.getElementById("signature-pad");if(!t)return console.error("[ZakaznikSchvaleni] Hlavn√≠ canvas nenalezen"),void("function"==typeof showNotif&&showNotif("error","Chyba p≈ôi p≈ôenosu podpisu"));const o=e.toDataURL(),a=new Image;a.onload=()=>{const e=t.getContext("2d");e.setTransform(1,0,0,1,0,0),e.fillStyle="white",e.fillRect(0,0,t.width,t.height);const o=t.width,n=t.height,l=a.width/a.height;let r,i,c,s;l>o/n?(r=.9*o,i=r/l):(i=.9*n,r=i*l),c=(o-r)/2,s=(n-i)/2,e.drawImage(a,c,s,r,i),"undefined"!=typeof WGSToast?WGSToast.zobrazit("Podpis byl p≈ôenesen do protokolu",{titulek:"WGS"}):"function"==typeof showNotif&&showNotif("success","Podpis byl p≈ôenesen do protokolu")},a.onerror=()=>{console.error("[ZakaznikSchvaleni] Chyba naƒçten√≠ podpisu"),"function"==typeof showNotif&&showNotif("error","Chyba p≈ôi p≈ôenosu podpisu")},a.src=o;const n=document.getElementById("checkboxProdlouzeniLhuty"),l=document.getElementById("prodlouzeniLhutyHlavni");n&&l&&(n.checked?(l.style.display="block",logger.log("[ZakaznikSchvaleni] Text prodlou≈æen√≠ lh≈Øty zobrazen v hlavn√≠m formul√°≈ôi")):l.style.display="none");(function(){if(window.zakaznikSchvaleniModal&&window.zakaznikSchvaleniModal.close)window.zakaznikSchvaleniModal.close();else{const e=document.getElementById("zakaznikSchvaleniOverlay");e&&e.classList.add("hidden"),window.scrollLock&&window.scrollLock.disable("zakaznik-schvaleni-overlay")}e&&e.clear()})(),[{source:"description-cz",target:"description-en"},{source:"problem-cz",target:"problem-en"},{source:"repair-cz",target:"repair-en"}].forEach(({source:e,target:t})=>{const o=document.getElementById(e);o&&o.value.trim()&&"function"==typeof translateText&&translateText(e,t)})}()});const r=document.getElementById("checkboxProdlouzeniLhuty"),i=document.getElementById("prodlouzeniLhutyText");r&&i&&r.addEventListener("change",()=>{r.checked?i.style.display="block":i.style.display="none"})})}();
//# sourceMappingURL=protokol.min.js.map