async function zkontrolujPdfKnihovny(){let e=0;for(;(!window.jspdf||!window.jspdf.jsPDF)&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;if(!window.jspdf||!window.jspdf.jsPDF)throw new Error("jsPDF knihovna se nepoda≈ôila naƒç√≠st. Zkuste obnovit str√°nku (F5).");for(e=0;"undefined"==typeof html2canvas&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;if("undefined"==typeof html2canvas)throw new Error("html2canvas knihovna se nepoda≈ôila naƒç√≠st. Zkuste obnovit str√°nku (F5).");return!0}function showNotification(e,t="info"){let a=document.getElementById("notif");a&&(a.textContent=e,a.className="notif "+t,a.classList.remove("hidden"),a.style.opacity="1",e=()=>{a.style.opacity="0",setTimeout(()=>{a.classList.add("hidden")},300)},a.onclick=e,"error"!==t?setTimeout(e,3e3):setTimeout(e,5e3))}(async()=>{try{var e=await(await fetch("app/admin_session_check.php")).json();e.logged_in?"prodejce"===e.role&&(wgsToast.error(t("page_for_techs_admins_only")),window.location.href="seznam.php"):(wgsToast.error(t("please_log_in")),window.location.href="login.php")}catch(e){logger.error("Chyba kontroly p≈ô√≠stupu:",e)}})(),"undefined"==typeof debounce&&(window.debounce=function(t,a){let o;return function(...e){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),t(...e)},a)}});let signaturePad,attachedPhotos=[],currentReklamaceId=null,currentReklamace=null,pdfPreviewContext=window.kalkulaceData=null,cachedPdfDoc=null,cachedPdfBase64=null;function setupAutoTranslate(){["description","problem","repair"].forEach(e=>{let t=document.getElementById(e+"-cz"),a;t.addEventListener("input",()=>{clearTimeout(a),a=setTimeout(()=>{5<t.value.trim().length&&translateField(e,!0)},2500)})})}function setupTextareaAutoResize(){let e=document.querySelectorAll(".split-section textarea");function t(e){var t=parseInt(window.getComputedStyle(e).minHeight)||60,t=(e.style.height="auto",Math.max(e.scrollHeight,t));e.style.height=t+"px"}e.forEach(e=>{e.addEventListener("input",()=>t(e)),e.addEventListener("change",()=>t(e)),0<e.value.trim().length&&setTimeout(()=>t(e),100)}),window.addEventListener("orientationchange",()=>{setTimeout(()=>{e.forEach(e=>t(e))},200)}),window.addEventListener("resize",()=>{e.forEach(e=>t(e))}),logger.log("[AutoResize] Textarea auto-resize aktivovan pro",e.length,"poli"),window.triggerTextareaResize=function(){e.forEach(e=>{0<e.value.trim().length&&t(e)})}}function initSignaturePad(){let o=document.getElementById("signature-pad");var e=()=>{var e=Math.max(window.devicePixelRatio||1,1),t=o.getBoundingClientRect(),a=t.width,t=t.height;o.width=a*e,o.height=t*e,o.getContext("2d").scale(e,e)};window.addEventListener("resize",e,{passive:!0}),e(),signaturePad=new SignaturePad(o,{minWidth:1,maxWidth:2.5,penColor:"black",backgroundColor:"white",throttle:8,velocityFilterWeight:.5,minDistance:2}),window.signaturePad=signaturePad}async function loadPhotosFromDatabase(e){try{if(e){logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),logger.log("üñºÔ∏è NAƒå√çT√ÅM FOTKY Z DATAB√ÅZE"),logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),logger.log("customerId:",e);var t=await(await fetch("api/get_photos_api.php?reklamace_id="+e)).json();if(t.success&&0!==t.total_photos){logger.log("Fotky naƒçteny z datab√°ze!");let a=t.sections,o=(logger.log("üì¶ Sekce:",Object.keys(a)),{before:"BEFORE",id:"ID",problem:"DETAIL BUG",damage_part:"DAMAGE PART",new_part:"NEW PART",repair:"REPAIR",after:"AFTER"}),n=0,l=0;["before","id","problem","damage_part","new_part","repair","after"].forEach(t=>{var e=a[t];Array.isArray(e)&&0!==e.length&&(logger.log(`üìÅ Sekce "${t}": ${e.length} polo≈æek`),e.forEach(e=>{"video"===e.type?l++:"image"!==e.type&&e.type||e.data&&(attachedPhotos.push({data:e.data,label:o[t]||t.toUpperCase(),section:t}),n++)}))}),logger.log(`[Stats] CELKEM: ${n} fotek, ${l} vide√≠`),0<attachedPhotos.length?(renderPhotoPreview(attachedPhotos.map(e=>"string"==typeof e?e:e.data)),showNotif("success",`Naƒçteno ${n} fotek`),logger.log("Fotky √∫spƒõ≈°nƒõ naƒçteny s popisky")):(logger.log("≈Ω√°dn√© fotky k zobrazen√≠"),showNotif("info","≈Ω√°dn√© fotky"))}else logger.log("Fotky nenalezeny v datab√°zi"),showNotif("warning","Nebyly nalezeny fotky");logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")}else logger.warn("ID z√°kazn√≠ka nenalezeno")}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ fotek:",e),showNotif("error","Chyba naƒç√≠t√°n√≠ fotek")}}async function loadKalkulaceFromDatabase(e){try{var t;e?(logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),logger.log("üí∂ NAƒå√çT√ÅM KALKULACI Z DATAB√ÅZE"),logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),logger.log("customerId:",e),(t=await(await fetch("api/get_kalkulace_api.php?reklamace_id="+e)).json()).success?t.has_kalkulace?(logger.log("Kalkulace naƒçtena z datab√°ze!"),kalkulaceData=t.kalkulace,logger.log("üì¶ Kalkulace data:",kalkulaceData),logger.log("üí∞ Celkov√° cena:",kalkulaceData.celkovaCena,"‚Ç¨"),logger.log("[Loc] Adresa:",kalkulaceData.adresa),logger.log("üìè Vzd√°lenost:",kalkulaceData.vzdalenost,"km"),logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),showNotif("success",`Kalkulace naƒçtena (${kalkulaceData.celkovaCena.toFixed(2)} ‚Ç¨)`)):(logger.log("‚ÑπÔ∏è Kalkulace nebyla vytvo≈ôena pro tuto reklamaci"),logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")):(logger.log("Kalkulace nenalezena v datab√°zi:",t.error),logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"))):logger.warn("ID z√°kazn√≠ka nenalezeno - kalkulace nebude naƒçtena")}catch(e){logger.error("Chyba p≈ôi naƒç√≠t√°n√≠ kalkulace:",e),showNotif("error","Chyba naƒç√≠t√°n√≠ kalkulace")}}async function loadReklamace(e){showLoading(!0);try{logger.log("Naƒç√≠t√°m data z√°kazn√≠ka..."),logger.log("[List] ID z URL:",e);var t=localStorage.getItem("currentCustomer");if(t){logger.log("Data nalezena v localStorage");var o=JSON.parse(t),a=(logger.log("üì¶ Data z√°kazn√≠ka:",o),JSON.parse(localStorage.getItem("currentUser")||"{}"));if(logger.log("[User] Aktu√°ln√≠ u≈æivatel:",a.name,"| Role:",a.role),"prodejce"===a.role&&o.zpracoval_id&&o.zpracoval_id!==a.id)showNotif("error","Nem√°te opr√°vnƒõn√≠ k t√©to zak√°zce"),setTimeout(()=>window.location.href="seznam.php",2e3);else{logger.log("Opr√°vnƒõn√≠ potvrzeno");var n,l=o.jmeno||o.zakaznik||"";let e="",t="",a="";o.adresa?(n=o.adresa.split(",").map(e=>e.trim()),e=n[0]||"",t=n[1]||"",a=n[2]||"",logger.log("[Loc] Adresa (nov√Ω form√°t):",{ulice:e,mesto:t,psc:a})):(e=o.ulice||"",t=o.mesto||"",a=o.psc||"",logger.log("[Loc] Adresa (star√Ω form√°t):",{ulice:e,mesto:t,psc:a})),logger.log("[Edit] Vypl≈àuji formul√°≈ô..."),document.getElementById("order-number").value=o.reklamace_id||"",document.getElementById("claim-number").value=o.cislo||"",document.getElementById("customer").value=l,document.getElementById("address").value=o.adresa||`${e}, ${t}, `+a,document.getElementById("phone").value=o.telefon||"",document.getElementById("email").value=o.email||"",document.getElementById("brand").value=o.zadavatel_jmeno||o.created_by_name||"",document.getElementById("model").value=o.model||"",document.getElementById("description-cz").value=o.popis_problemu||"";var r=o.technik||o.prihlaseny_technik||"";r&&(document.getElementById("technician").value=r),currentReklamace=o,currentReklamaceId=o.reklamace_id||o.cislo||o.id,logger.log("Data z√°kazn√≠ka √∫spƒõ≈°nƒõ naƒçtena a vyplnƒõna"),showNotif("success","Data naƒçtena")}showLoading(!1)}else if(logger.warn("Data v localStorage nenalezena"),e){var i=await fetchCsrfToken(),d=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({action:"load_reklamace",id:e,csrf_token:i})});if(!d.ok){var c=await d.text();logger.error("Load reklamace error:",d.status,c);try{var s=JSON.parse(c);throw logger.error("Load error detail:",s),new Error(s.error||s.message||"Server error "+d.status)}catch(e){throw new Error(`Server error ${d.status}: `+c.substring(0,200))}}var g=await d.json();if("success"===g.status){logger.log("Data naƒçtena z API");var u,m=(currentReklamace=g.reklamace).jmeno||currentReklamace.zakaznik||"";let e="",t="",a="";a=currentReklamace.adresa?(u=currentReklamace.adresa.split(",").map(e=>e.trim()),e=u[0]||"",t=u[1]||"",u[2]||""):(e=currentReklamace.ulice||"",t=currentReklamace.mesto||"",currentReklamace.psc||""),document.getElementById("order-number").value=currentReklamace.reklamace_id||"",document.getElementById("claim-number").value=currentReklamace.cislo||"",document.getElementById("customer").value=m,document.getElementById("address").value=currentReklamace.adresa||`${e}, ${t}, `+a,document.getElementById("phone").value=currentReklamace.telefon||"",document.getElementById("email").value=currentReklamace.email||"",document.getElementById("brand").value=currentReklamace.zadavatel_jmeno||currentReklamace.created_by_name||"",document.getElementById("model").value=currentReklamace.model||"",document.getElementById("description-cz").value=currentReklamace.popis_problemu||"";var h=currentReklamace.technik||currentReklamace.prihlaseny_technik||"";h&&(document.getElementById("technician").value=h),showNotif("success","Reklamace naƒçtena")}else showNotif("error",g.message||"Reklamace nenalezena")}else showNotif("error","Chyb√≠ ID reklamace"),showLoading(!1)}catch(e){logger.error("Chyba naƒç√≠t√°n√≠:",e),showNotif("error","Chyba naƒç√≠t√°n√≠")}finally{showLoading(!1)}}function showLoading(e){document.getElementById("loadingOverlay").classList.toggle("show",e)}function showLoadingWithMessage(e,t="Naƒç√≠t√°n√≠..."){var a=document.getElementById("loadingOverlay"),o=document.getElementById("loadingText");e?(a.style.display="",a.classList.add("show"),o&&(o.textContent=t)):a.classList.remove("show")}function showNotif(e,t){let a=document.getElementById("notif");a.className="notif "+e,a.textContent=t,a.classList.add("show"),setTimeout(()=>a.classList.remove("show"),3e3)}async function attachPhotos(){let a=document.createElement("input");a.type="file",a.accept="image/*",a.multiple=!0,a.capture="environment",a.classList.add("hidden"),document.body.appendChild(a),a.onchange=async e=>{e=Array.from(e.target.files||[]);if(e.length){showNotif("success","Zpracov√°v√°m fotky...");for(var t of e){t=await toBase64(await compressImage(t,.6));attachedPhotos.push(t)}renderPhotoPreview(attachedPhotos),showNotif("success",e.length+" fotek p≈ôid√°no"),a.remove()}},a.click()}async function compressImage(e,t=.6){e=await loadImage(URL.createObjectURL(e));let a=document.createElement("canvas");var o=a.getContext("2d"),n=Math.min(1,1200/e.width);a.width=e.width*n,a.height=e.height*n,o.drawImage(e,0,0,a.width,a.height);let l=.85,r=await new Promise(e=>a.toBlob(e,"image/jpeg",l));for(;r.size>1024*t*1024&&.4<l;)l-=.05,r=await new Promise(e=>a.toBlob(e,"image/jpeg",l));return r}function loadImage(o){return new Promise((e,t)=>{let a=new Image;a.onload=()=>e(a),a.onerror=t,a.src=o})}function toBase64(o){return window.Utils&&window.Utils.toBase64?window.Utils.toBase64(o):new Promise((e,t)=>{let a=new FileReader;a.onload=()=>e(a.result),a.onerror=t,a.readAsDataURL(o)})}function renderPhotoPreview(e){let a=document.getElementById("photoPreviewContainer"),o=(a||((a=document.createElement("div")).id="photoPreviewContainer",document.querySelector(".wrapper").appendChild(a)),a.innerHTML=`<h3>${t("attached_photos_count").replace("{count}",e.length)}</h3><div id="photoGrid"></div>`,a.querySelector("#photoGrid"));e.forEach(e=>{let t="string"==typeof e?e:e.data;var e=document.createElement("div"),a=(e.className="photo-thumb-wrapper",document.createElement("img"));a.src=t,e.addEventListener("click",()=>{window.open(t,"_blank")}),e.appendChild(a),o.appendChild(e)})}async function generateProtocolPDF(){await zkontrolujPdfKnihovny();var e=window.jspdf.jsPDF,e=new e("p","mm","a4"),t=document.querySelector(".wrapper"),a=(logger.log("[Doc] Vytv√°≈ô√≠m desktop clone pro PDF generov√°n√≠..."),t.cloneNode(!0)),o=(a.classList.add("pdf-clone-desktop"),a.id="pdf-clone-wrapper-temp",document.body.appendChild(a),a.querySelector(".signature-actions")),o=(o&&(o.remove(),logger.log('Signature actions (tlaƒç√≠tko "Vymazat podpis" + label) odstranƒõny z PDF')),a.querySelector(".btn-podepsat-protokol")),o=(o&&(o.remove(),logger.log('Tlacitko "Podepsat protokol" odstraneno z PDF')),a.querySelector(".btns")),o=(o&&(o.remove(),logger.log("Doln√≠ tlaƒç√≠tka odstranƒõna z PDF")),a.querySelector("#photoPreviewContainer")),o=(o&&(o.remove(),logger.log("Photo preview odstranƒõn z PDF (fotky jsou v samostatn√© sekci)")),a.querySelector(".customer-info-arrow")),o=(o&&(o.remove(),logger.log("≈†ipka u z√°kaznick√© hlaviƒçky odstranƒõna z PDF")),a.querySelector(".customer-info-content")),o=(o&&(o.classList.remove("hidden"),o.style.maxHeight="none",o.style.overflow="visible",logger.log("Z√°kaznick√Ω obsah nastaven jako viditeln√Ω v PDF")),t.querySelector("#signature-pad")),n=a.querySelector("#signature-pad");if(o&&n)try{n.getContext("2d").drawImage(o,0,0),logger.log("Signature pad zkop√≠rov√°n do clone")}catch(e){logger.warn("Nepoda≈ôilo se zkop√≠rovat signature pad:",e)}await new Promise(e=>setTimeout(e,150));n=t.querySelectorAll("textarea");let l=a.querySelectorAll("textarea");n.forEach((e,t)=>{var a,o,t=l[t];t&&(a=document.createElement("div"),o=window.getComputedStyle(t),a.style.cssText=`
        width: ${o.width};
        min-height: ${o.minHeight||"80px"};
        padding: ${o.padding};
        border: ${o.border};
        background: ${o.background};
        font-family: ${o.fontFamily};
        font-size: ${o.fontSize};
        line-height: ${o.lineHeight||"1.4"};
        color: ${o.color};
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        box-sizing: border-box;
        overflow: hidden;
      `,a.textContent=e.value,t.parentNode.replaceChild(a,t))}),logger.log("Textarea nahrazeny DIV elementy pro PDF");o=t.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input:not([type])');let r=a.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input:not([type])');o.forEach((e,t)=>{var a,o,t=r[t];t&&(a=document.createElement("span"),o=window.getComputedStyle(t),a.style.cssText=`
        display: block;
        width: ${o.width};
        padding: ${o.padding};
        border: ${o.border};
        background: ${o.background};
        font-family: ${o.fontFamily};
        font-size: ${o.fontSize};
        line-height: ${o.lineHeight||"1.4"};
        color: ${o.color};
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        box-sizing: border-box;
        min-height: ${o.height||"auto"};
      `,a.textContent=e.value,t.parentNode.replaceChild(a,t))}),logger.log("Input pole nahrazeny SPAN elementy pro PDF");n=t.querySelectorAll("select");let i=a.querySelectorAll("select");n.forEach((e,t)=>{var a,o,t=i[t];t&&(a=document.createElement("span"),o=window.getComputedStyle(t),a.style.cssText=`
        display: block;
        width: ${o.width};
        padding: ${o.padding};
        border: ${o.border};
        background: ${o.background};
        font-family: ${o.fontFamily};
        font-size: ${o.fontSize};
        line-height: ${o.lineHeight||"1.4"};
        color: ${o.color};
        box-sizing: border-box;
        min-height: ${o.height||"auto"};
      `,o=e.options[e.selectedIndex],a.textContent=o?o.text:"",t.parentNode.replaceChild(a,t))}),logger.log("Select elementy nahrazeny SPAN elementy pro PDF"),logger.log("[Photo] Renderuji clone pomoc√≠ html2canvas...");o=await html2canvas(a,{scale:3,backgroundColor:"#fff",useCORS:!0,logging:!1,imageTimeout:0,allowTaint:!0,letterRendering:!0}),t=o.toDataURL("image/jpeg",.98),n=o.height/o.width;let d=190,c=d*n;277<c&&(c=277,d=c/n);o=(210-d)/2;return e.addImage(t,"JPEG",o,10,d,c),document.body.removeChild(a),logger.log("Clone odstranƒõn, PDF vygenerov√°no"),e}async function generatePhotosPDF(){if(!attachedPhotos.length)return null;await zkontrolujPdfKnihovny();var e=window.jspdf.jsPDF,n=new e("p","mm","a4"),t=(n.internal.pageSize.getWidth()-20-5)/2,a=(n.internal.pageSize.getHeight()-20-5)/2;logger.log(`[Doc] Vytv√°≈ô√≠m PDF: ${attachedPhotos.length} fotek, ${Math.ceil(attachedPhotos.length/4)} str√°nek`);for(let o=0;o<attachedPhotos.length;o++){var l=attachedPhotos[o],r="string"==typeof l?l:l.data,l="object"==typeof l?l.label:"",i=(0<o&&o%4==0&&(n.addPage(),logger.log(`[Doc] P≈ôid√°na nov√° str√°nka (fotka ${o+1})`)),o%4),d=10+i%2*(5+t),i=5+(10+Math.floor(i/2)*(5+a)),c=t,s=a-5;try{let t=new Image;t.src=r,await new Promise(e=>{t.onload=e,setTimeout(e,100)});var g=t.width||1e3,u=t.height||1e3,m=g/u;let e,a;c/s<m?(e=c,a=c/m):(a=s,e=s*m);var h=(c-e)/2,p=(s-a)/2;l&&(n.setFontSize(8),n.setFont("helvetica","bold"),n.setTextColor(0,0,0),n.text(l,d+h,i+p-2)),n.addImage(r,"JPEG",d+h,i+p,e,a,void 0,"MEDIUM"),logger.log(`  [Photo] Fotka ${o+1}/${attachedPhotos.length} - ${l||"bez popisku"} (${g}x${u} ‚Üí ${Math.round(e)}x${Math.round(a)}mm)`)}catch(e){logger.warn(`Nelze detekovat velikost fotky ${o+1}, pou≈æ√≠v√°m celou bu≈àku`),l&&(n.setFontSize(8),n.setFont("helvetica","bold"),n.setTextColor(0,0,0),n.text(l,d,i-2)),n.addImage(r,"JPEG",d,i,c,s,void 0,"MEDIUM")}}return logger.log(`PDF s fotkami vytvo≈ôeno (${attachedPhotos.length} fotek s popisky)`),n}async function generatePricelistPDF(){if(!kalkulaceData)return logger.log("Kalkulace neexistuje - PRICELIST PDF nebude vygenerovano"),null;logger.log("Generuji PDF PRICELIST..."),await zkontrolujPdfKnihovny();var e=window.jspdf.jsPDF;let a=new e("p","mm","a4"),o=a.internal.pageSize.getWidth();a.internal.pageSize.getHeight();let n=15;a.setFontSize(20),a.setFont("helvetica","bold"),a.setTextColor(0,0,0),a.text("PRICELIST",o/2,n,{align:"center"}),n+=15;var e=document.getElementById("customer")?.value||"N/A",t=kalkulaceData.adresa||document.getElementById("address")?.value||"N/A",l=document.getElementById("phone")?.value||"",r=document.getElementById("email")?.value||"",i=document.getElementById("claim-number")?.value||"";return a.setFontSize(10),a.setFont("helvetica","normal"),a.setTextColor(0,0,0),i&&(a.text("Cislo reklamace: "+i,15,n),n+=6),a.setFont("helvetica","bold"),a.text("Zakaznik: "+e,15,n),n+=6,a.setFont("helvetica","normal"),a.text("Adresa: "+t,15,n),n+=6,l&&(a.text("Telefon: "+l,15,n),n+=6),r&&(a.text("Email: "+r,15,n),n+=6),n+=5,a.setLineWidth(.5),a.setDrawColor(0,0,0),a.line(15,n,o-15,n),n+=10,a.setFontSize(14),a.setFont("helvetica","bold"),a.text("Rozpis cen",15,n),n+=10,a.setFontSize(10),a.setFont("helvetica","normal"),kalkulaceData.reklamaceBezDopravy?(a.text("Dopravne (reklamace)",15,n),a.text("0.00 EUR",o-15-30,n)):(i=`Dopravne (${kalkulaceData.vzdalenost} km)`,e=kalkulaceData.dopravne.toFixed(2),a.text(i,15,n),a.text(e+" EUR",o-15-30,n)),n+=7,kalkulaceData.sluzby&&0<kalkulaceData.sluzby.length&&(n+=3,a.setFont("helvetica","bold"),a.text("Sluzby:",15,n),n+=7,a.setFont("helvetica","normal"),kalkulaceData.sluzby.forEach(e=>{var t="  "+e.nazev,e=e.cena.toFixed(2);a.text(t,15,n),a.text(e+" EUR",o-15-30,n),n+=6}),n+=3),kalkulaceData.dilyPrace&&0<kalkulaceData.dilyPrace.length&&(n+=3,a.setFont("helvetica","bold"),a.text("Dily a prace:",15,n),n+=7,a.setFont("helvetica","normal"),kalkulaceData.dilyPrace.forEach(e=>{var t=`  ${e.nazev} (${e.pocet}x)`,e=e.cena.toFixed(2);a.text(t,15,n),a.text(e+" EUR",o-15-30,n),n+=6}),n+=3),kalkulaceData.tezkyNabytek&&(a.text("Priplatek: Tezky nabytek (nad 50 kg)",15,n),a.text("80.00 EUR",o-15-30,n),n+=7),kalkulaceData.druhaOsoba&&(a.text("Priplatek: Druha osoba",15,n),a.text("80.00 EUR",o-15-30,n),n+=7),n+=5,a.setLineWidth(.3),a.line(15,n,o-15,n),n+=8,a.setFontSize(14),a.setFont("helvetica","bold"),a.setTextColor(0,0,0),a.text("CELKEM:",15,n),a.text(kalkulaceData.celkovaCena.toFixed(2)+" EUR",o-15-40,n),n+=10,kalkulaceData.poznamka&&(n+=5,a.setFontSize(10),a.setFont("helvetica","italic"),a.setTextColor(100,100,100),a.text("Poznamka:",15,n),n+=6,a.setFont("helvetica","normal"),a.splitTextToSize(kalkulaceData.poznamka,o-30).forEach(e=>{a.text(e,15,n),n+=5})),logger.log(`PDF PRICELIST vytvo≈ôen (${kalkulaceData.celkovaCena.toFixed(2)} ‚Ç¨)`),a}async function exportBothPDFs(){try{showLoading(!0),logger.log("[List] Generuji kompletn√≠ PDF (protokol + PRICELIST + fotodokumentace)..."),logger.log("üí∞ Kontrola kalkulace - kalkulaceData:",kalkulaceData);let n=await generateProtocolPDF();if(kalkulaceData){logger.log("Kalkulace nalezena - p≈ôid√°v√°m PRICELIST..."),logger.log("[Stats] Kalkulace data:",kalkulaceData),n.addPage();let a=n.internal.pageSize.getWidth();n.internal.pageSize.getHeight();let o=15;n.setFontSize(20),n.setFont("helvetica","bold"),n.setTextColor(0,0,0),n.text("PRICELIST",a/2,o,{align:"center"}),o+=15;var e,t,l=document.getElementById("customer")?.value||"N/A",r=kalkulaceData.adresa||document.getElementById("address")?.value||"N/A",i=document.getElementById("phone")?.value||"",d=document.getElementById("email")?.value||"",c=document.getElementById("claim-number")?.value||"";n.setFontSize(10),n.setFont("helvetica","normal"),n.setTextColor(0,0,0),c&&(n.text("Cislo reklamace: "+c,15,o),o+=6),n.setFont("helvetica","bold"),n.text("Zakaznik: "+l,15,o),o+=6,n.setFont("helvetica","normal"),n.text("Adresa: "+r,15,o),o+=6,i&&(n.text("Telefon: "+i,15,o),o+=6),d&&(n.text("Email: "+d,15,o),o+=6),o+=5,n.setLineWidth(.5),n.setDrawColor(0,0,0),n.line(15,o,a-15,o),o+=10,n.setFontSize(14),n.setFont("helvetica","bold"),n.text("Rozpis cen",15,o),o+=10,n.setFontSize(10),n.setFont("helvetica","normal"),kalkulaceData.reklamaceBezDopravy?(n.text("Dopravne (reklamace)",15,o),n.text("0.00 EUR",a-15-30,o)):(e=`Dopravne (${kalkulaceData.vzdalenost} km)`,t=kalkulaceData.dopravne.toFixed(2),n.text(e,15,o),n.text(t+" EUR",a-15-30,o)),o+=7,kalkulaceData.dilyPrace&&0<kalkulaceData.dilyPrace.length&&(o+=3,n.setFont("helvetica","bold"),n.text("Dily a prace:",15,o),o+=7,n.setFont("helvetica","normal"),kalkulaceData.dilyPrace.forEach(e=>{var t=`  ${e.nazev} (${e.pocet}x)`,e=e.cena.toFixed(2);n.text(t,15,o),n.text(e+" EUR",a-15-30,o),o+=6}),o+=3),kalkulaceData.tezkyNabytek&&(n.text("Priplatek: Tezky nabytek (nad 50 kg)",15,o),n.text("80.00 EUR",a-15-30,o),o+=7),kalkulaceData.druhaOsoba&&(n.text("Priplatek: Druha osoba",15,o),n.text("80.00 EUR",a-15-30,o),o+=7),o+=5,n.setLineWidth(.3),n.line(15,o,a-15,o),o+=8,n.setFontSize(14),n.setFont("helvetica","bold"),n.setTextColor(0,0,0),n.text("CELKEM:",15,o),n.text(kalkulaceData.celkovaCena.toFixed(2)+" EUR",a-15-40,o),logger.log(`PRICELIST p≈ôid√°n (${kalkulaceData.celkovaCena.toFixed(2)} ‚Ç¨)`)}else logger.warn("Kalkulace nenalezena - PRICELIST nebude v PDF"),logger.warn("   Mo≈æn√© p≈ô√≠ƒçiny:"),logger.warn("   1. Kalkulace nebyla vytvo≈ôena"),logger.warn("   2. Kalkulace nebyla ulo≈æena do datab√°ze"),logger.warn("   3. Chyba p≈ôi naƒç√≠t√°n√≠ z datab√°ze");if(0<attachedPhotos.length){logger.log("[Photo] P≈ôid√°v√°m fotodokumentaci...");var o=n.internal.pageSize.getWidth(),s=n.internal.pageSize.getHeight();n.addPage(),n.setFontSize(16),n.setFont("helvetica","bold"),n.text("FOTODOKUMENTACE",o/2,20,{align:"center"});let a=35;n.setFontSize(10),n.setFont("helvetica","normal");["Cislo reklamace: "+(document.getElementById("claim-number")?.value||"N/A"),"Datum: "+(document.getElementById("sign-date")?.value||(new Date).toLocaleDateString("cs-CZ"))].forEach(e=>{n.text(e,10,a),a+=6}),a+=5,n.setLineWidth(.5),n.line(10,a,o-10,a),a+=10,n.setFontSize(12),n.setFont("helvetica","bold"),n.text("INDEX PHOTO",10,a),a+=8,n.setFontSize(8),n.setFont("helvetica","normal");var g=Math.floor((o-20)/30);for(let t=0;t<attachedPhotos.length;t++){var u=attachedPhotos[t],m="string"==typeof u?u:u.data,h="object"==typeof u?u.label:"Fotka "+(t+1),p=t%g,k=Math.floor(t/g),v=10+30*p,y=a+34*k;if(s-10<y+25)n.addPage(),a=20;else try{n.addImage(m,"JPEG",v,y,25,25,void 0,"FAST"),n.setFontSize(7),n.text(t+1+". "+h,v,y+25+3,{maxWidth:25})}catch(e){logger.warn("Nelze p≈ôidat miniaturu "+(t+1))}}logger.log(`Index ${attachedPhotos.length} fotek vytvo≈ôen`),n.addPage();var w=(o-20-5)/2,f=(s-20-5)/2;for(let o=0;o<attachedPhotos.length;o++){var z=attachedPhotos[o],P="string"==typeof z?z:z.data,E="object"==typeof z?z.label:"",b=(0<o&&o%4==0&&n.addPage(),o%4),x=b%2,I=Math.floor(b/2),D=10+x*(5+w),S=5+(10+I*(5+f)),F=w,C=f-5;try{let t=new Image;t.src=P,await new Promise(e=>{t.onload=e,setTimeout(e,100)});var T=(t.width||1e3)/(t.height||1e3);let e,a;F/C<T?(e=F,a=F/T):(a=C,e=C*T);var L=(F-e)/2,R=(C-a)/2;E&&(n.setFontSize(8),n.setFont("helvetica","bold"),n.setTextColor(0,0,0),n.text(E,D+L,S+R-2)),n.addImage(P,"JPEG",D+L,S+R,e,a,void 0,"MEDIUM"),logger.log(`  [Photo] Fotka ${o+1}/${attachedPhotos.length} - `+E)}catch(e){logger.warn("Chyba fotky "+(o+1)),E&&(n.setFontSize(8),n.setFont("helvetica","bold"),n.setTextColor(0,0,0),n.text(E,D,S-2)),n.addImage(P,"JPEG",D,S,F,C,void 0,"MEDIUM")}}logger.log(`Fotodokumentace p≈ôid√°na (${attachedPhotos.length} fotek)`),"undefined"!=typeof WGSToast?WGSToast.zobrazit(`PDF vytvo≈ôeno (protokol + ${attachedPhotos.length} fotek)`,{titulek:"WGS"}):showNotif("success",`PDF vytvo≈ôeno (protokol + ${attachedPhotos.length} fotek)`)}else"undefined"!=typeof WGSToast?WGSToast.zobrazit("Protokol vytvo≈ôen",{titulek:"WGS"}):showNotif("success","Protokol vytvo≈ôen (bez fotek)");logger.log("[Save] Ukl√°d√°m PDF do datab√°ze...");try{var a,B=await fetchCsrfToken(),$=n.output("datauristring").split(",")[1],N=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"save_pdf_only",reklamace_id:currentReklamaceId,complete_pdf:$,csrf_token:B})});N.ok&&("success"===(a=await N.json()).status?logger.log("PDF √∫spƒõ≈°nƒõ ulo≈æen do datab√°ze"):logger.warn("PDF se nepoda≈ôilo ulo≈æit:",a.message))}catch(e){logger.error("Chyba p≈ôi ukl√°d√°n√≠ PDF:",e)}var j=n.output("blob"),_=`WGS_Protokol_${(document.getElementById("claim-number")?.value||"protokol").replace(/\s+/g,"_")}.pdf`;pdfPreviewContext="export",cachedPdfDoc=n,cachedPdfBase64=null,"function"==typeof otevritPdfPreview?otevritPdfPreview(j,_):window.open(URL.createObjectURL(j),"_blank"),await saveProtokolToDB(),logger.log("[List] Oznaƒçuji reklamaci jako hotovou...");try{var A=await fetchCsrfToken();"success"===(await(await fetch("app/controllers/save.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"update",id:currentReklamaceId,mark_as_completed:"1",csrf_token:A})})).json()).status&&logger.log("Reklamace oznaƒçena jako hotov√°")}catch(e){logger.error("Chyba p≈ôi oznaƒçov√°n√≠:",e)}}catch(e){logger.error("Chyba p≈ôi generov√°n√≠ PDF:",e),showNotif("error","Chyba p≈ôi vytv√°≈ôen√≠ PDF")}finally{showLoading(!1)}}async function sendToCustomer(){try{showLoadingWithMessage(!0,"Generuji protokol... Pros√≠m ƒçekejte"),logger.log("[List] Generuji kompletn√≠ PDF pro n√°hled p≈ôed odesl√°n√≠m..."),logger.log("üí∞ Kontrola kalkulace - kalkulaceData:",kalkulaceData);let n=await generateProtocolPDF();if(kalkulaceData){showLoadingWithMessage(!0,`P≈ôid√°v√°m PRICELIST (${kalkulaceData.celkovaCena.toFixed(2)} ‚Ç¨)... Pros√≠m ƒçekejte`),logger.log("Kalkulace nalezena - p≈ôid√°v√°m PRICELIST..."),logger.log("[Stats] Kalkulace data:",kalkulaceData),n.addPage();let a=n.internal.pageSize.getWidth();n.internal.pageSize.getHeight();let o=15;n.setFontSize(20),n.setFont("helvetica","bold"),n.setTextColor(0,0,0),n.text("PRICELIST",a/2,o,{align:"center"}),o+=15;var e,t,l=document.getElementById("customer")?.value||"N/A",r=kalkulaceData.adresa||document.getElementById("address")?.value||"N/A",i=document.getElementById("phone")?.value||"",d=document.getElementById("email")?.value||"",c=document.getElementById("claim-number")?.value||"";n.setFontSize(10),n.setFont("helvetica","normal"),n.setTextColor(0,0,0),c&&(n.text("Cislo reklamace: "+c,15,o),o+=6),n.setFont("helvetica","bold"),n.text("Zakaznik: "+l,15,o),o+=6,n.setFont("helvetica","normal"),n.text("Adresa: "+r,15,o),o+=6,i&&(n.text("Telefon: "+i,15,o),o+=6),d&&(n.text("Email: "+d,15,o),o+=6),o+=5,n.setLineWidth(.5),n.setDrawColor(0,0,0),n.line(15,o,a-15,o),o+=10,n.setFontSize(14),n.setFont("helvetica","bold"),n.text("Rozpis cen",15,o),o+=10,n.setFontSize(10),n.setFont("helvetica","normal"),kalkulaceData.reklamaceBezDopravy?(n.text("Dopravne (reklamace)",15,o),n.text("0.00 EUR",a-15-30,o)):(e=`Dopravne (${kalkulaceData.vzdalenost} km)`,t=kalkulaceData.dopravne.toFixed(2),n.text(e,15,o),n.text(t+" EUR",a-15-30,o)),o+=7,kalkulaceData.dilyPrace&&0<kalkulaceData.dilyPrace.length&&(o+=3,n.setFont("helvetica","bold"),n.text("Dily a prace:",15,o),o+=7,n.setFont("helvetica","normal"),kalkulaceData.dilyPrace.forEach(e=>{var t=`  ${e.nazev} (${e.pocet}x)`,e=e.cena.toFixed(2);n.text(t,15,o),n.text(e+" EUR",a-15-30,o),o+=6}),o+=3),kalkulaceData.tezkyNabytek&&(n.text("Priplatek: Tezky nabytek (nad 50 kg)",15,o),n.text("80.00 EUR",a-15-30,o),o+=7),kalkulaceData.druhaOsoba&&(n.text("Priplatek: Druha osoba",15,o),n.text("80.00 EUR",a-15-30,o),o+=7),o+=5,n.setLineWidth(.3),n.line(15,o,a-15,o),o+=8,n.setFontSize(14),n.setFont("helvetica","bold"),n.setTextColor(0,0,0),n.text("CELKEM:",15,o),n.text(kalkulaceData.celkovaCena.toFixed(2)+" EUR",a-15-40,o),logger.log(`PRICELIST p≈ôid√°n (${kalkulaceData.celkovaCena.toFixed(2)} ‚Ç¨)`)}else logger.warn("Kalkulace nenalezena - PRICELIST nebude v emailu"),logger.warn("   Zkontrolujte, zda byla kalkulace vytvo≈ôena a ulo≈æena");if(0<attachedPhotos.length){showLoadingWithMessage(!0,`P≈ôid√°v√°m ${attachedPhotos.length} fotografi√≠... Pros√≠m ƒçekejte`),logger.log("[Photo] P≈ôid√°v√°m fotodokumentaci...");var o=n.internal.pageSize.getWidth(),s=n.internal.pageSize.getHeight();n.addPage(),n.setFontSize(16),n.setFont("helvetica","bold"),n.text("FOTODOKUMENTACE",o/2,20,{align:"center"});let a=35;n.setFontSize(10),n.setFont("helvetica","normal");["Cislo reklamace: "+(document.getElementById("claim-number")?.value||"N/A"),"Datum: "+(document.getElementById("sign-date")?.value||(new Date).toLocaleDateString("cs-CZ"))].forEach(e=>{n.text(e,10,a),a+=6}),a+=5,n.setLineWidth(.5),n.line(10,a,o-10,a),a+=10,n.setFontSize(12),n.setFont("helvetica","bold"),n.text("INDEX PHOTO",10,a),a+=8,n.setFontSize(8),n.setFont("helvetica","normal");var g=Math.floor((o-20)/30);for(let t=0;t<attachedPhotos.length;t++){var u=attachedPhotos[t],m="string"==typeof u?u:u.data,h="object"==typeof u?u.label:"Fotka "+(t+1),p=t%g,k=Math.floor(t/g),v=10+30*p,y=a+34*k;if(s-10<y+25)n.addPage(),a=20;else try{n.addImage(m,"JPEG",v,y,25,25,void 0,"FAST"),n.setFontSize(7),n.text(t+1+". "+h,v,y+25+3,{maxWidth:25})}catch(e){logger.warn("Nelze p≈ôidat miniaturu "+(t+1))}}logger.log(`Index ${attachedPhotos.length} fotek vytvo≈ôen`),n.addPage();var w=(o-20-5)/2,f=(s-20-5)/2;for(let o=0;o<attachedPhotos.length;o++){var z=attachedPhotos[o],P="string"==typeof z?z:z.data,E="object"==typeof z?z.label:"",b=(0<o&&o%4==0&&n.addPage(),o%4),x=b%2,I=Math.floor(b/2),D=10+x*(5+w),S=5+(10+I*(5+f)),F=w,C=f-5;try{let t=new Image;t.src=P,await new Promise(e=>{t.onload=e,setTimeout(e,100)});var T=(t.width||1e3)/(t.height||1e3);let e,a;F/C<T?(e=F,a=F/T):(a=C,e=C*T);var L=(F-e)/2,R=(C-a)/2;E&&(n.setFontSize(8),n.setFont("helvetica","bold"),n.setTextColor(0,0,0),n.text(E,D+L,S+R-2)),n.addImage(P,"JPEG",D+L,S+R,e,a,void 0,"MEDIUM"),logger.log(`  [Photo] Fotka ${o+1}/${attachedPhotos.length} - `+E)}catch(e){logger.warn("Chyba fotky "+(o+1)),E&&(n.setFontSize(8),n.setFont("helvetica","bold"),n.setTextColor(0,0,0),n.text(E,D,S-2)),n.addImage(P,"JPEG",D,S,F,C,void 0,"MEDIUM")}}logger.log(`Fotodokumentace p≈ôid√°na (${attachedPhotos.length} fotek)`)}var a=n.output("datauristring").split(",")[1];cachedPdfDoc=n,cachedPdfBase64=a,pdfPreviewContext="send",logger.log("üìß Odes√≠l√°m email p≈ô√≠mo bez n√°hledu..."),await potvrditAOdeslat()}catch(e){logger.error("Chyba p≈ôi generov√°n√≠ PDF:",e),showNotif("error","Chyba p≈ôi vytv√°≈ôen√≠ PDF"),showLoadingWithMessage(!1)}}async function potvrditAOdeslat(){if(cachedPdfBase64)try{showLoadingWithMessage(!0,"Odes√≠l√°m email z√°kazn√≠kovi... Pros√≠m ƒçekejte"),logger.log("üìß Odes√≠l√°m PDF z√°kazn√≠kovi...");var e=await fetchCsrfToken(),t=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"send_email",reklamace_id:currentReklamaceId,complete_pdf:cachedPdfBase64,csrf_token:e})});if(!t.ok){var a=await t.text();logger.error("Server error:",t.status,a);try{var o=JSON.parse(a);throw logger.error("Error detail:",o),new Error(o.error||o.message||"Server error "+t.status)}catch(e){throw new Error(`Server error ${t.status}: `+a.substring(0,200))}}var n,l,r,i=await t.json();"success"===i.status?("undefined"!=typeof WGSToast?WGSToast.zobrazit("Email odesl√°n z√°kazn√≠kovi",{titulek:"WGS"}):showNotif("success","Email odesl√°n z√°kazn√≠kovi"),await saveProtokolToDB(),logger.log("[List] Oznaƒçuji reklamaci jako hotovou..."),"success"===(n=await(await fetch("app/controllers/save.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"update",id:currentReklamaceId,mark_as_completed:"1",csrf_token:e})})).json()).status?logger.log("Reklamace oznaƒçena jako hotov√°"):logger.warn("Nepoda≈ôilo se oznaƒçit jako hotovou:",n.message),currentReklamaceId&&(l="photoSections_"+currentReklamaceId,r="photosPDF_"+currentReklamaceId,localStorage.removeItem(l),localStorage.removeItem(r),localStorage.removeItem("photosReadyForProtocol"),localStorage.removeItem("photosCustomerId"),logger.log("Fotky a PDF vymaz√°ny z localStorage")),setTimeout(()=>{window.location.href="seznam.php"},2e3)):showNotif("error",i.message||"Chyba odes√≠l√°n√≠")}catch(e){logger.error(e),showNotif("error","Chyba odes√≠l√°n√≠: "+e.message)}finally{showLoadingWithMessage(!1)}else showNotif("error","PDF nen√≠ dostupn√©")}async function saveProtokolToDB(){try{var e=await fetchCsrfToken(),t=parseFloat(document.getElementById("price-total").value)||0;"success"===(await(await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"save_protokol",reklamace_id:currentReklamaceId,problem_description:document.getElementById("problem-cz").value,repair_proposal:document.getElementById("repair-cz").value,solved:document.getElementById("solved").value,dealer:document.getElementById("dealer")?.value||"NE",technician:document.getElementById("technician").value,cena_celkem:t,csrf_token:e})})).json()).status&&logger.log("Protokol ulo≈æen do DB (vƒçetnƒõ cenov√Ωch √∫daj≈Ø)")}catch(e){logger.error("Chyba ukl√°d√°n√≠:",e)}}async function translateTextApi(e,t="cs",a="en"){if(!e||""===e.trim())return"";try{var o=await(await fetch("api/translate_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,source:t,target:a})})).json();return"success"===o.status&&o.translated?o.translated:(logger.warn("P≈ôeklad selhal:",o.message||"Nezn√°m√° chyba"),"")}catch(e){return logger.error("Chyba p≈ôekladu:",e),""}}async function translateText(e,t){var a=document.getElementById(e),o=document.getElementById(t);if(a&&o){var n=a.value.trim();if(n){a=a.parentElement.querySelector(".translate-btn");a&&(a.classList.add("loading"),a.disabled=!0);try{logger.log("[Sync] P≈ôekl√°d√°m:",n.substring(0,50)+"...");var l=await translateTextApi(n,"cs","en");l?(o.value=l,logger.log("P≈ôelo≈æeno:",l.substring(0,50)+"..."),showNotification("Text p≈ôelo≈æen","success")):showNotification("P≈ôeklad selhal","error")}catch(e){logger.error("Chyba p≈ôi p≈ôekladu:",e),showNotification("Chyba p≈ôi p≈ôekladu","error")}finally{a&&(a.classList.remove("loading"),a.disabled=!1)}}else showNotification("Nejd≈ô√≠ve napi≈°te text pro p≈ôeklad","error")}else logger.error("Pole pro p≈ôeklad nenalezeno:",e,t)}async function autoTranslateField(t){var a=document.getElementById(t);if(a){var o=a.value.trim();if(o){logger.log("[Sync] P≈ôekl√°d√°m pole:",t);let e=a.parentElement.querySelector(".en-label");e||(a=a.closest(".input-group, .form-group, div"))&&(e=a.querySelector(".en-label")),e?(a=await translateTextApi(o,"cs","en"))&&(e.textContent=a,logger.log("P≈ôelo≈æeno:",t,"->",a.substring(0,50)+"...")):logger.warn("En-label pro",t,"nenalezen")}}}function initAutoTranslation(){[{source:"description-cz",target:"description-en"},{source:"problem-cz",target:"problem-en"},{source:"repair-cz",target:"repair-en"}].forEach(({source:e,target:t})=>{var a,o=document.getElementById(e);o?(a=debounce(()=>{translateText(e,t)},1500),o.addEventListener("input",a),o.addEventListener("blur",()=>{translateText(e,t)}),logger.log("Auto-p≈ôeklad aktivov√°n pro:",e,"‚Üí",t)):logger.warn("Auto-p≈ôeklad: Pole nenalezeno:",e)})}async function translateField(e,t=0){var a=document.getElementById(e+"-cz"),o=document.getElementById(e+"-en");if(a&&o){a=a.value.trim();if(a&&!(a.length<5))try{o.value="Prekladam...";var n=await(await fetch("api/translate_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:a,engine:"mymemory"})})).json();"success"===n.status?(o.value=n.translated,logger.log("OK:",e)):o.value=""}catch(e){logger.error("Err:",e),o.value=""}}}window.addEventListener("DOMContentLoaded",async()=>{logger.log("[Start] Inicializace protokolu..."),initSignaturePad();var e=new URLSearchParams(window.location.search),e=(currentReklamaceId=e.get("id"),logger.log("[List] ID z URL:",currentReklamaceId),currentReklamaceId?(logger.log("ID nalezeno v URL"),await loadReklamace(currentReklamaceId),loadPhotosFromDatabase(currentReklamaceId),loadKalkulaceFromDatabase(currentReklamaceId)):(logger.warn("Chyb√≠ ID v URL - zkus√≠m naƒç√≠st z localStorage"),await loadReklamace(null),currentReklamace&&currentReklamace.id?(logger.log("ID nalezeno v naƒçten√Ωch datech:",currentReklamace.id),loadPhotosFromDatabase(currentReklamaceId=currentReklamace.id),loadKalkulaceFromDatabase(currentReklamaceId)):logger.error("ID se nepoda≈ôilo naj√≠t!")),(new Date).toISOString().split("T")[0]);document.getElementById("sign-date").value=e,setupAutoTranslate(),setupTextareaAutoResize(),setTimeout(()=>{window.triggerTextareaResize&&window.triggerTextareaResize()},300);let t=document.getElementById("solved"),a=document.getElementById("dealer");t&&a&&t.addEventListener("change",()=>{"ANO"===t.value?a.value="NE":"NE"===t.value&&(a.value="ANO")})}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initAutoTranslation):initAutoTranslation(),logger.log("Automatick√Ω p≈ôeklad aktivov√°n"),window.addEventListener("load",()=>{["description","problem","repair"].forEach(t=>{let a=document.getElementById(t+"-cz");if(a){let e;a.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(()=>{10<a.value.trim().length&&translateField(t,!0)},2e3)})}}),logger.log("Translate ready")}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{var e=e.target.closest("[data-action]");e&&("reload"===(e=e.getAttribute("data-action"))?location.reload():void 0!==window.Utils&&window.Utils.ActionRegistry&&window.Utils.ActionRegistry.handlers&&window.Utils.ActionRegistry.handlers[e]||"function"==typeof window[e]&&window[e]())}),document.addEventListener("click",e=>{e=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");e&&("function"==typeof navigateTo?navigateTo(e):location.href=e)}),document.addEventListener("change",e=>{var t,e=e.target.closest("[data-onchange]");e&&(t=e.getAttribute("data-onchange"),e=e.getAttribute("data-onchange-value")||e.value,"function"==typeof window[t])&&window[t](e)})}),(()=>{let g=null;document.addEventListener("DOMContentLoaded",()=>{let s=document.getElementById("btnPodepsatProtokol");var e=document.getElementById("zakaznikSchvaleniOverlay"),a=document.getElementById("zakaznikSchvaleniPouzit"),o=document.getElementById("zakaznikVymazatPodpis"),t=document.getElementById("zakaznikSchvaleniPad");if(s&&e&&t){s.addEventListener("click",async()=>{s.disabled=!0,s.textContent="Pripravuji...";try{{let t=document.getElementById("zakaznikSchvaleniPad");logger.log("[Podpis] Spoustim pojistku prekladu pred podpisem...");for(var a of["description","problem","repair"]){var e=document.getElementById(a+"-cz"),o=document.getElementById(a+"-en");if(e&&o&&5<e.value.trim().length&&(!o.value||"Prekladam..."===o.value||""===o.value.trim())){logger.log("[Podpis] Prekladam pole:",a);try{await translateField(a,!0)}catch(e){logger.warn("[Podpis] Preklad selhal pro:",a,e)}}}logger.log("[Podpis] Pojistka prekladu dokoncena");{var n=document.getElementById("repair-cz")?.value||"",l=document.getElementById("zakaznikSchvaleniText");l&&(l.textContent=n||"(Nen√≠ vyplnƒõno)");let e=document.getElementById("payment")?.value||"-",t=(document.getElementById("souhrn-plati-zakaznik").textContent=e,document.getElementById("sign-date")?.value||"-"),a="-";t&&"-"!==t&&(l=new Date(t),a=isNaN(l.getTime())?t:l.toLocaleDateString("cs-CZ")),document.getElementById("souhrn-datum-podpisu").textContent=a,n=document.getElementById("solved")?.value||"-",document.getElementById("souhrn-vyreseno").textContent=n,l=document.getElementById("dealer")?.value||"-",document.getElementById("souhrn-prodejce").textContent=l,n=document.getElementById("damage")?.value||"-",document.getElementById("souhrn-poskozeni").textContent=n}var r=document.getElementById("typ-zakaznika")?.value||"",i=document.querySelector(".tabulka-checkbox-row"),d=document.getElementById("checkboxProdlouzeniLhuty"),c=document.getElementById("prodlouzeniLhutyText");i&&(r.toLowerCase().includes("fyzick√°")||r.toLowerCase().includes("fyzicka")||"Fyzick√° osoba"===r?(i.style.display="",logger.log("[ZakaznikSchvaleni] Checkbox prodlou≈æen√≠ lh≈Øty zobrazen (fyzick√° osoba)")):(i.style.display="none",d&&(d.checked=!1),c&&(c.style.display="none"),logger.log("[ZakaznikSchvaleni] Checkbox prodlou≈æen√≠ lh≈Øty skryt (IƒåO:",r,")"))),window.zakaznikSchvaleniModal&&window.zakaznikSchvaleniModal.open?window.zakaznikSchvaleniModal.open():((i=document.getElementById("zakaznikSchvaleniOverlay"))&&i.classList.remove("hidden"),window.scrollLock&&window.scrollLock.enable("zakaznik-schvaleni-overlay")),setTimeout(()=>{var o=t;if(o)if(g&&g.canvas===o)g.clear();else{var e=o.getBoundingClientRect();o.width=e.width,o.height=e.height;let t=o.getContext("2d"),a=(t.fillStyle="white",t.fillRect(0,0,o.width,o.height),g={canvas:o,ctx:t,isDrawing:!1,lastX:0,lastY:0,clear:function(){this.ctx.fillStyle="white",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},isEmpty:function(){var t=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height).data;for(let e=3;e<t.length;e+=4)if(0<t[e])return!1;return!0},toDataURL:function(){return this.canvas.toDataURL("image/png")}},t.strokeStyle="#000000",t.lineWidth=2,t.lineCap="round",t.lineJoin="round",e=>{var t=o.getBoundingClientRect();return e.touches&&0<e.touches.length?{x:e.touches[0].clientX-t.left,y:e.touches[0].clientY-t.top}:{x:e.clientX-t.left,y:e.clientY-t.top}});var e=e=>{e.preventDefault(),g.isDrawing=!0;e=a(e);g.lastX=e.x,g.lastY=e.y},n=e=>{g.isDrawing&&(e.preventDefault(),e=a(e),t.beginPath(),t.moveTo(g.lastX,g.lastY),t.lineTo(e.x,e.y),t.stroke(),g.lastX=e.x,g.lastY=e.y)},l=()=>{g.isDrawing=!1};o.addEventListener("mousedown",e),o.addEventListener("mousemove",n),o.addEventListener("mouseup",l),o.addEventListener("mouseout",l),o.addEventListener("touchstart",e,{passive:!1}),o.addEventListener("touchmove",n,{passive:!1}),o.addEventListener("touchend",l),o.addEventListener("touchcancel",l)}},100);return void await void 0}}finally{s.disabled=!1,s.textContent="Podepsat protokol"}}),o?.addEventListener("click",()=>{g&&g.clear()}),a?.addEventListener("click",()=>{if(!g||g.isEmpty())"function"==typeof showNotif?showNotif("error","Pros√≠m podepi≈°te se p≈ôed potvrzen√≠m"):wgsToast.warning("Pros√≠m podepi≈°te se p≈ôed potvrzen√≠m");else{let c=document.getElementById("signature-pad");if(c){var e=g.toDataURL();let d=new Image;d.onload=()=>{var e=c.getContext("2d"),t=(e.setTransform(1,0,0,1,0,0),e.fillStyle="white",e.fillRect(0,0,c.width,c.height),c.width),a=c.height,o=d.width/d.height;let n,l,r,i;t/a<o?(n=.9*t,l=n/o):(l=.9*a,n=l*o),r=(t-n)/2,i=(a-l)/2,e.drawImage(d,r,i,n,l),"undefined"!=typeof WGSToast?WGSToast.zobrazit("Podpis byl p≈ôenesen do protokolu",{titulek:"WGS"}):"function"==typeof showNotif&&showNotif("success","Podpis byl p≈ôenesen do protokolu")},d.onerror=()=>{console.error("[ZakaznikSchvaleni] Chyba naƒçten√≠ podpisu"),"function"==typeof showNotif&&showNotif("error","Chyba p≈ôi p≈ôenosu podpisu")},d.src=e;var e=document.getElementById("checkboxProdlouzeniLhuty"),t=document.getElementById("prodlouzeniLhutyHlavni");e&&t&&(e.checked?(t.style.display="block",logger.log("[ZakaznikSchvaleni] Text prodlou≈æen√≠ lh≈Øty zobrazen v hlavn√≠m formul√°≈ôi")):t.style.display="none"),(()=>{var e;window.zakaznikSchvaleniModal&&window.zakaznikSchvaleniModal.close?window.zakaznikSchvaleniModal.close():((e=document.getElementById("zakaznikSchvaleniOverlay"))&&e.classList.add("hidden"),window.scrollLock&&window.scrollLock.disable("zakaznik-schvaleni-overlay")),g&&g.clear()})(),[{source:"description-cz",target:"description-en"},{source:"problem-cz",target:"problem-en"},{source:"repair-cz",target:"repair-en"}].forEach(({source:e,target:t})=>{var a=document.getElementById(e);a&&a.value.trim()&&"function"==typeof translateText&&translateText(e,t)})}else console.error("[ZakaznikSchvaleni] Hlavn√≠ canvas nenalezen"),"function"==typeof showNotif&&showNotif("error","Chyba p≈ôi p≈ôenosu podpisu")}});let e=document.getElementById("checkboxProdlouzeniLhuty"),t=document.getElementById("prodlouzeniLhutyText");e&&t&&e.addEventListener("change",()=>{e.checked?t.style.display="block":t.style.display="none"})}})})();
//# sourceMappingURL=protokol.min.js.map