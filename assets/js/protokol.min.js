async function zkontrolujPdfKnihovny(){let e=0;for(;(!window.jspdf||!window.jspdf.jsPDF)&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;if(!window.jspdf||!window.jspdf.jsPDF)throw new Error("jsPDF knihovna se nepodaÅ™ila naÄÃ­st. Zkuste obnovit strÃ¡nku (F5).");for(e=0;"undefined"==typeof html2canvas&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;if("undefined"==typeof html2canvas)throw new Error("html2canvas knihovna se nepodaÅ™ila naÄÃ­st. Zkuste obnovit strÃ¡nku (F5).");return!0}function showNotification(e,t="info"){const o=document.getElementById("notif");if(!o)return;o.textContent=e,o.className=`notif ${t}`,o.classList.remove("hidden"),o.style.opacity="1";const a=()=>{o.style.opacity="0",setTimeout(()=>{o.classList.add("hidden")},300)};o.onclick=a,"error"!==t?setTimeout(a,3e3):setTimeout(a,5e3)}let signaturePad;!async function(){try{const e=await fetch("app/admin_session_check.php"),o=await e.json();if(!o.logged_in)return wgsToast.error(t("please_log_in")),void(window.location.href="login.php");"prodejce"===o.role&&(wgsToast.error(t("page_for_techs_admins_only")),window.location.href="seznam.php")}catch(e){logger.error("Chyba kontroly pÅ™Ã­stupu:",e)}}(),"undefined"==typeof debounce&&(window.debounce=function(e,t){let o;return function(...a){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),e(...a)},t)}});let attachedPhotos=[],currentReklamaceId=null,currentReklamace=null;window.kalkulaceData=null;let pdfPreviewContext=null,cachedPdfDoc=null,cachedPdfBase64=null;function setupAutoTranslate(){["description","problem","repair"].forEach(e=>{const t=document.getElementById(e+"-cz");let o;t.addEventListener("input",()=>{clearTimeout(o),o=setTimeout(()=>{t.value.trim().length>5&&translateField(e,!0)},2500)})})}function setupTextareaAutoResize(){const e=document.querySelectorAll(".split-section textarea");function t(e){const t=parseInt(window.getComputedStyle(e).minHeight)||60;e.style.height="auto";const o=Math.max(e.scrollHeight,t);e.style.height=o+"px"}e.forEach(e=>{e.addEventListener("input",()=>t(e)),e.addEventListener("change",()=>t(e)),e.value.trim().length>0&&setTimeout(()=>t(e),100)}),window.addEventListener("orientationchange",()=>{setTimeout(()=>{e.forEach(e=>t(e))},200)}),window.addEventListener("resize",()=>{e.forEach(e=>t(e))}),logger.log("[AutoResize] Textarea auto-resize aktivovan pro",e.length,"poli"),window.triggerTextareaResize=function(){e.forEach(e=>{e.value.trim().length>0&&t(e)})}}function initSignaturePad(){const e=document.getElementById("signature-pad");let t=null;const o=()=>{const o=Math.max(window.devicePixelRatio||1,1),a=e.getBoundingClientRect(),n=a.width,l=a.height,r=e.getContext("2d");if(!t){const o=r.getImageData(0,0,e.width||1,e.height||1).data;let a=!1;for(let e=0;e<o.length;e+=4)if(255!==o[e]||255!==o[e+1]||255!==o[e+2]){a=!0;break}a&&(t=e.toDataURL("image/png"))}if(e.width=n*o,e.height=l*o,r.scale(o,o),t){const e=new Image;e.onload=()=>{r.fillStyle="white",r.fillRect(0,0,n,l);const t=e.width/e.height;let o,a,i,s;t>n/l?(o=.95*n,a=o/t):(a=.95*l,o=a*t),i=(n-o)/2,s=(l-a)/2,r.drawImage(e,i,s,o,a)},e.src=t}};window.addEventListener("resize",o,{passive:!0}),o(),signaturePad=new SignaturePad(e,{minWidth:1,maxWidth:2.5,penColor:"black",backgroundColor:"white",throttle:8,velocityFilterWeight:.5,minDistance:2}),window.signaturePad=signaturePad,window.ulozitPodpisData=function(e){t=e},inicializovatFullscreenPodpis()}window.addEventListener("DOMContentLoaded",async()=>{logger.log("[Start] Inicializace protokolu..."),initSignaturePad();const e=new URLSearchParams(window.location.search);currentReklamaceId=e.get("id"),logger.log("[List] ID z URL:",currentReklamaceId),currentReklamaceId?(logger.log("ID nalezeno v URL"),await loadReklamace(currentReklamaceId),await loadPhotosFromDatabase(currentReklamaceId),await loadKalkulaceFromDatabase(currentReklamaceId)):(logger.warn("ChybÃ­ ID v URL - zkusÃ­m naÄÃ­st z localStorage"),await loadReklamace(null),currentReklamace&&currentReklamace.id?(logger.log("ID nalezeno v naÄtenÃ½ch datech:",currentReklamace.id),currentReklamaceId=currentReklamace.id,await loadPhotosFromDatabase(currentReklamaceId),await loadKalkulaceFromDatabase(currentReklamaceId)):logger.error("ID se nepodaÅ™ilo najÃ­t!"));const t=(new Date).toISOString().split("T")[0];document.getElementById("sign-date").value=t,setupAutoTranslate(),setupTextareaAutoResize(),setTimeout(()=>{window.triggerTextareaResize&&window.triggerTextareaResize()},300);const o=document.getElementById("solved"),a=document.getElementById("dealer");o&&a&&o.addEventListener("change",()=>{"ANO"===o.value?a.value="NE":"NE"===o.value&&(a.value="ANO")})});let fullscreenSignaturePad=null;function inicializovatFullscreenPodpis(){const e=document.getElementById("btnPodepsatFullscreen"),t=document.getElementById("fullscreenPodpisOverlay"),o=document.getElementById("fullscreen-signature-pad"),a=document.getElementById("btnSmazatFullscreen"),n=document.getElementById("btnPotvrdirFullscreen");e&&t&&o?(e.addEventListener("click",()=>{otevritFullscreenPodpis()}),a?.addEventListener("click",()=>{fullscreenSignaturePad&&fullscreenSignaturePad.clear()}),n?.addEventListener("click",()=>{potvrdirFullscreenPodpis()}),logger.log("[FullscreenPodpis] Inicializace dokoncena"),inicializovatPotrebaDilButton()):logger.warn("[FullscreenPodpis] Elementy nenalezeny")}function inicializovatPotrebaDilButton(){const e=document.getElementById("btnPotrebaDil"),t=document.getElementById("potrebaDilContainer"),o=document.getElementById("btnSouhlasim"),a=document.getElementById("btnNesouhlasim"),n=document.getElementById("souhlasDilOverlay");if(!e||!t)return void logger.warn("[PotrebaDil] TlaÄÃ­tko nenalezeno");const l=document.getElementById("typ-zakaznika")?.value||"";!(l.toLowerCase().includes("iÄo")||l.toLowerCase().includes("ico")||l.toLowerCase().includes("firma")||l.toLowerCase().includes("company"))?(t.style.display="block",logger.log("[PotrebaDil] TlaÄÃ­tko zobrazeno (fyzickÃ¡ osoba)")):(t.style.display="none",logger.log("[PotrebaDil] TlaÄÃ­tko skryto (firma/IÄŒO)")),window.textProdlouzeniLhutyGlobal="",e.addEventListener("click",()=>{logger.log("[PotrebaDil] Zobrazuji modal se souhlasem"),n&&(n.style.display="flex")}),o&&o.addEventListener("click",()=>{window.textProdlouzeniLhutyGlobal="ZÃ¡kaznÃ­k souhlasÃ­ s prodlouÅ¾enÃ­m lhÅ¯ty pro vyÅ™Ã­zenÃ­ reklamace za ÃºÄelem objednÃ¡nÃ­ nÃ¡hradnÃ­ch dÃ­lÅ¯ od vÃ½robce. DodacÃ­ lhÅ¯ta dÃ­lÅ¯ je mimo kontrolu servisu a mÅ¯Å¾e se prodlouÅ¾it (orientaÄnÄ› 3â€“4 tÃ½dny, v krajnÃ­m pÅ™Ã­padÄ› i dÃ©le). Servis se zavazuje provÃ©st opravu bez zbyteÄnÃ©ho odkladu po doruÄenÃ­ dÃ­lÅ¯.",logger.log("[PotrebaDil] ZÃ¡kaznÃ­k souhlasÃ­ - text uloÅ¾en");const e=document.getElementById("prodlouzeniLhutyHlavni");e&&(e.style.display="block"),n&&(n.style.display="none"),setTimeout(()=>{otevritFullscreenPodpis()},300)}),a&&a.addEventListener("click",()=>{const e="ZÃ¡kaznÃ­k nesouhlasÃ­ s prodlouÅ¾enÃ­m lhÅ¯ty za ÃºÄelem objednÃ¡nÃ­ dÃ­lu. Tento postoj je povaÅ¾ovÃ¡n za nespoluprÃ¡ci se servisem.";window.textProdlouzeniLhutyGlobal=e,logger.log("[PotrebaDil] ZÃ¡kaznÃ­k NEsouhlasÃ­ - text uloÅ¾en");const t=document.getElementById("prodlouzeniLhutyHlavni");t&&(t.innerHTML=e,t.style.display="block"),n&&(n.style.display="none"),setTimeout(()=>{otevritFullscreenPodpis()},300)}),logger.log("[PotrebaDil] Inicializace dokonÄena")}function otevritFullscreenPodpis(){const e=document.getElementById("fullscreenPodpisOverlay"),t=document.getElementById("fullscreen-signature-pad");e&&t&&(e.classList.add("aktivni"),document.body.style.overflow="hidden",setTimeout(()=>{inicializovatFullscreenCanvas(t)},50),logger.log("[FullscreenPodpis] Otevren"))}function zavritFullscreenPodpis(){const e=document.getElementById("fullscreenPodpisOverlay");e&&(e.classList.remove("aktivni"),document.body.style.overflow="",fullscreenSignaturePad&&fullscreenSignaturePad.clear(),logger.log("[FullscreenPodpis] Zavren"))}function inicializovatFullscreenCanvas(e){if(!e)return;const t=e.parentElement,o=(t.getBoundingClientRect(),t.querySelector(".fullscreen-podpis-header")),a=t.querySelector(".fullscreen-podpis-footer"),n=o?o.offsetHeight:0,l=a?a.offsetHeight:0,r=t.offsetHeight-n-l,i=t.offsetWidth;e.width=i,e.height=r,e.style.width=i+"px",e.style.height=r+"px";const s=e.getContext("2d");s.fillStyle="white",s.fillRect(0,0,e.width,e.height),fullscreenSignaturePad={canvas:e,ctx:s,isDrawing:!1,lastX:0,lastY:0,clear:function(){this.ctx.fillStyle="white",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},isEmpty:function(){const e=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height).data;for(let t=0;t<e.length;t+=4)if(255!==e[t]||255!==e[t+1]||255!==e[t+2])return!1;return!0},toDataURL:function(){return this.canvas.toDataURL("image/png")}},s.strokeStyle="#000000",s.lineWidth=3,s.lineCap="round",s.lineJoin="round";const c=t=>{const o=e.getBoundingClientRect(),a=document.getElementById("fullscreenPodpisOverlay").classList.contains("aktivni")&&window.innerHeight>window.innerWidth&&window.innerWidth<=768;let n,l;if(t.touches&&t.touches.length>0?(n=t.touches[0].clientX,l=t.touches[0].clientY):(n=t.clientX,l=t.clientY),a){const e=window.innerWidth/2,t=l-window.innerHeight/2,a=-(n-e);return{x:o.width/2+t,y:o.height/2+a}}return{x:n-o.left,y:l-o.top}},d=e=>{e.preventDefault(),fullscreenSignaturePad.isDrawing=!0;const t=c(e);fullscreenSignaturePad.lastX=t.x,fullscreenSignaturePad.lastY=t.y},g=e=>{if(!fullscreenSignaturePad.isDrawing)return;e.preventDefault();const t=c(e);s.beginPath(),s.moveTo(fullscreenSignaturePad.lastX,fullscreenSignaturePad.lastY),s.lineTo(t.x,t.y),s.stroke(),fullscreenSignaturePad.lastX=t.x,fullscreenSignaturePad.lastY=t.y},u=()=>{fullscreenSignaturePad.isDrawing=!1};e.onmousedown=null,e.onmousemove=null,e.onmouseup=null,e.onmouseout=null,e.ontouchstart=null,e.ontouchmove=null,e.ontouchend=null,e.addEventListener("mousedown",d),e.addEventListener("mousemove",g),e.addEventListener("mouseup",u),e.addEventListener("mouseout",u),e.addEventListener("touchstart",d,{passive:!1}),e.addEventListener("touchmove",g,{passive:!1}),e.addEventListener("touchend",u),e.addEventListener("touchcancel",u),logger.log("[FullscreenPodpis] Canvas inicializovan:",i,"x",r)}function potvrdirFullscreenPodpis(){if(!fullscreenSignaturePad||fullscreenSignaturePad.isEmpty())return void("undefined"!=typeof wgsToast?wgsToast.warning("Prosim podepiste se pred potvrzenim"):alert("Prosim podepiste se pred potvrzenim"));const e=document.getElementById("signature-pad");if(!e)return void logger.error("[FullscreenPodpis] Hlavni canvas nenalezen");const t=fullscreenSignaturePad.toDataURL(),o=new Image;o.onload=()=>{const a=e.getContext("2d");a.setTransform(1,0,0,1,0,0),a.fillStyle="white",a.fillRect(0,0,e.width,e.height);const n=e.width,l=e.height,r=o.width/o.height;let i,s,c,d;r>n/l?(i=.9*n,s=i/r):(s=.9*l,i=s*r),c=(n-i)/2,d=(l-s)/2,a.drawImage(o,c,d,i,s),"function"==typeof window.ulozitPodpisData&&(window.ulozitPodpisData(t),logger.log("[FullscreenPodpis] Podpis ulozen pro resize"));const g=document.getElementById("podpisKontejner");g&&g.classList.add("ma-podpis"),"undefined"!=typeof WGSToast?WGSToast.zobrazit("Podpis byl pridan do protokolu",{titulek:"WGS"}):"undefined"!=typeof wgsToast&&wgsToast.success("Podpis byl pridan do protokolu"),zavritFullscreenPodpis(),logger.log("[FullscreenPodpis] Podpis prenesen do hlavniho canvasu")},o.onerror=()=>{logger.error("[FullscreenPodpis] Chyba nacteni podpisu"),zavritFullscreenPodpis()},o.src=t}async function loadPhotosFromDatabase(e){try{if(!e)return void logger.warn("ID zÃ¡kaznÃ­ka nenalezeno");logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),logger.log("ğŸ–¼ï¸ NAÄŒÃTÃM FOTKY Z DATABÃZE"),logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),logger.log("customerId:",e);const t=await fetch(`api/get_photos_api.php?reklamace_id=${e}`),o=await t.json();if(!o.success||0===o.total_photos)return logger.log("Fotky nenalezeny v databÃ¡zi"),showNotif("warning","Nebyly nalezeny fotky"),void logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");logger.log("Fotky naÄteny z databÃ¡ze!");const a=o.sections;logger.log("ğŸ“¦ Sekce:",Object.keys(a));const n={before:"BEFORE",id:"ID",problem:"DETAIL BUG",damage_part:"DAMAGE PART",new_part:"NEW PART",repair:"REPAIR",after:"AFTER",photocustomer:"CUSTOMER PHOTO",pricelist:"PRICELIST"};let l=0,r=0;if(["before","id","problem","damage_part","new_part","repair","after","photocustomer","pricelist"].forEach(e=>{const t=a[e];Array.isArray(t)&&0!==t.length&&(logger.log(`ğŸ“ Sekce "${e}": ${t.length} poloÅ¾ek`),t.forEach(t=>{"video"===t.type?r++:"image"!==t.type&&t.type||t.data&&(attachedPhotos.push({data:t.data,label:n[e]||e.toUpperCase(),section:e}),l++)}))}),logger.log(`[Stats] CELKEM: ${l} fotek, ${r} videÃ­`),attachedPhotos.length>0){renderPhotoPreview(attachedPhotos.map(e=>"string"==typeof e?e:e.data)),showNotif("success",`NaÄteno ${l} fotek`),logger.log("Fotky ÃºspÄ›Å¡nÄ› naÄteny s popisky")}else logger.log("Å½Ã¡dnÃ© fotky k zobrazenÃ­"),showNotif("info","Å½Ã¡dnÃ© fotky");logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")}catch(e){logger.error("Chyba pÅ™i naÄÃ­tÃ¡nÃ­ fotek:",e),showNotif("error","Chyba naÄÃ­tÃ¡nÃ­ fotek")}}async function loadKalkulaceFromDatabase(e){try{if(!e)return void logger.warn("ID zÃ¡kaznÃ­ka nenalezeno - kalkulace nebude naÄtena");logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),logger.log("ğŸ’¶ NAÄŒÃTÃM KALKULACI Z DATABÃZE"),logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),logger.log("customerId:",e);const t=await fetch(`api/get_kalkulace_api.php?reklamace_id=${e}`),o=await t.json();if(!o.success)return logger.log("Kalkulace nenalezena v databÃ¡zi:",o.error),void logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");if(!o.has_kalkulace)return logger.log("â„¹ï¸ Kalkulace nebyla vytvoÅ™ena pro tuto reklamaci"),void logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");logger.log("Kalkulace naÄtena z databÃ¡ze!"),kalkulaceData=o.kalkulace,logger.log("ğŸ“¦ Kalkulace data:",kalkulaceData),logger.log("ğŸ’° CelkovÃ¡ cena:",kalkulaceData.celkovaCena,"â‚¬"),logger.log("[Loc] Adresa:",kalkulaceData.adresa),logger.log("ğŸ“ VzdÃ¡lenost:",kalkulaceData.vzdalenost,"km"),logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),showNotif("success",`Kalkulace naÄtena (${kalkulaceData.celkovaCena.toFixed(2)} â‚¬)`)}catch(e){logger.error("Chyba pÅ™i naÄÃ­tÃ¡nÃ­ kalkulace:",e),showNotif("error","Chyba naÄÃ­tÃ¡nÃ­ kalkulace")}}async function loadReklamace(e){showLoading(!0);try{logger.log("NaÄÃ­tÃ¡m data zÃ¡kaznÃ­ka..."),logger.log("[List] ID z URL:",e);const t=localStorage.getItem("currentCustomer");if(t){logger.log("Data nalezena v localStorage");const e=JSON.parse(t);logger.log("ğŸ“¦ Data zÃ¡kaznÃ­ka:",e);const o=JSON.parse(localStorage.getItem("currentUser")||"{}");if(logger.log("[User] AktuÃ¡lnÃ­ uÅ¾ivatel:",o.name,"| Role:",o.role),"prodejce"===o.role&&e.zpracoval_id&&e.zpracoval_id!==o.id)return showNotif("error","NemÃ¡te oprÃ¡vnÄ›nÃ­ k tÃ©to zakÃ¡zce"),setTimeout(()=>window.location.href="seznam.php",2e3),void showLoading(!1);logger.log("OprÃ¡vnÄ›nÃ­ potvrzeno");const a=e.jmeno||e.zakaznik||"";let n="",l="",r="";if(e.adresa){const t=e.adresa.split(",").map(e=>e.trim());n=t[0]||"",l=t[1]||"",r=t[2]||"",logger.log("[Loc] Adresa (novÃ½ formÃ¡t):",{ulice:n,mesto:l,psc:r})}else n=e.ulice||"",l=e.mesto||"",r=e.psc||"",logger.log("[Loc] Adresa (starÃ½ formÃ¡t):",{ulice:n,mesto:l,psc:r});logger.log("[Edit] VyplÅˆuji formulÃ¡Å™..."),document.getElementById("order-number").value=e.reklamace_id||"",document.getElementById("claim-number").value=e.cislo||"",document.getElementById("customer").value=a,document.getElementById("address").value=e.adresa||`${n}, ${l}, ${r}`,document.getElementById("phone").value=e.telefon||"",document.getElementById("email").value=e.email||"",document.getElementById("brand").value=e.zadavatel_jmeno||e.created_by_name||"",document.getElementById("model").value=e.model||"",document.getElementById("description-cz").value=e.popis_problemu||"";const i=e.technik||e.prihlaseny_technik||"";return i&&(document.getElementById("technician").value=i),currentReklamace=e,currentReklamaceId=e.reklamace_id||e.cislo||e.id,logger.log("Data zÃ¡kaznÃ­ka ÃºspÄ›Å¡nÄ› naÄtena a vyplnÄ›na"),showNotif("success","Data naÄtena"),void showLoading(!1)}if(logger.warn("Data v localStorage nenalezena"),!e)return showNotif("error","ChybÃ­ ID reklamace"),void showLoading(!1);const o=await fetchCsrfToken(),a=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({action:"load_reklamace",id:e,csrf_token:o})});if(!a.ok){const e=await a.text();logger.error("Load reklamace error:",a.status,e);try{const t=JSON.parse(e);throw logger.error("Load error detail:",t),new Error(t.error||t.message||`Server error ${a.status}`)}catch(t){throw new Error(`Server error ${a.status}: ${e.substring(0,200)}`)}}const n=await a.json();if("success"===n.status){logger.log("Data naÄtena z API"),currentReklamace=n.reklamace;const e=currentReklamace.jmeno||currentReklamace.zakaznik||"";let t="",o="",a="";if(currentReklamace.adresa){const e=currentReklamace.adresa.split(",").map(e=>e.trim());t=e[0]||"",o=e[1]||"",a=e[2]||""}else t=currentReklamace.ulice||"",o=currentReklamace.mesto||"",a=currentReklamace.psc||"";document.getElementById("order-number").value=currentReklamace.reklamace_id||"",document.getElementById("claim-number").value=currentReklamace.cislo||"",document.getElementById("customer").value=e,document.getElementById("address").value=currentReklamace.adresa||`${t}, ${o}, ${a}`,document.getElementById("phone").value=currentReklamace.telefon||"",document.getElementById("email").value=currentReklamace.email||"",document.getElementById("brand").value=currentReklamace.zadavatel_jmeno||currentReklamace.created_by_name||"",document.getElementById("model").value=currentReklamace.model||"",document.getElementById("description-cz").value=currentReklamace.popis_problemu||"";const l=currentReklamace.technik||currentReklamace.prihlaseny_technik||"";l&&(document.getElementById("technician").value=l),showNotif("success","Reklamace naÄtena")}else showNotif("error",n.message||"Reklamace nenalezena")}catch(e){logger.error("Chyba naÄÃ­tÃ¡nÃ­:",e),showNotif("error","Chyba naÄÃ­tÃ¡nÃ­")}finally{showLoading(!1)}}function showLoading(e){document.getElementById("loadingOverlay").classList.toggle("show",e)}function showLoadingWithMessage(e,t="NaÄÃ­tÃ¡nÃ­...",o=""){const a=document.getElementById("loadingOverlay"),n=document.getElementById("loadingText"),l=document.getElementById("loadingSubtext");e?(a.style.display="",a.classList.add("show"),n&&(n.textContent=t),l&&(o?(l.textContent=o,l.style.display="block"):l.style.display="none")):a.classList.remove("show")}function showNotif(e,t){const o=document.getElementById("notif");o.className=`notif ${e}`,o.textContent=t,o.classList.add("show"),setTimeout(()=>o.classList.remove("show"),3e3)}async function attachPhotos(){const e=document.createElement("input");e.type="file",e.accept="image/*",e.multiple=!0,e.capture="environment",e.classList.add("hidden"),document.body.appendChild(e),e.onchange=async t=>{const o=Array.from(t.target.files||[]);if(o.length){showNotif("success","ZpracovÃ¡vÃ¡m fotky...");for(const e of o){const t=await compressImage(e,.6),o=await toBase64(t);attachedPhotos.push(o)}renderPhotoPreview(attachedPhotos),showNotif("success",`${o.length} fotek pÅ™idÃ¡no`),e.remove()}},e.click()}async function compressImage(e,t=.6){const o=await loadImage(URL.createObjectURL(e)),a=document.createElement("canvas"),n=a.getContext("2d"),l=Math.min(1,1200/o.width);a.width=o.width*l,a.height=o.height*l,n.drawImage(o,0,0,a.width,a.height);let r=.85,i=await new Promise(e=>a.toBlob(e,"image/jpeg",r));for(;i.size>1024*t*1024&&r>.4;)r-=.05,i=await new Promise(e=>a.toBlob(e,"image/jpeg",r));return i}function loadImage(e){return new Promise((t,o)=>{const a=new Image;a.onload=()=>t(a),a.onerror=o,a.src=e})}function toBase64(e){return window.Utils&&window.Utils.toBase64?window.Utils.toBase64(e):new Promise((t,o)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=o,a.readAsDataURL(e)})}function renderPhotoPreview(e){let o=document.getElementById("photoPreviewContainer");o||(o=document.createElement("div"),o.id="photoPreviewContainer",document.querySelector(".wrapper").appendChild(o)),o.innerHTML=`<h3>${t("attached_photos_count").replace("{count}",e.length)}</h3><div id="photoGrid"></div>`;const a=o.querySelector("#photoGrid");e.forEach(e=>{const t="string"==typeof e?e:e.data,o=document.createElement("div");o.className="photo-thumb-wrapper";const n=document.createElement("img");n.src=t,o.addEventListener("click",()=>{window.open(t,"_blank")}),o.appendChild(n),a.appendChild(o)})}async function generateProtocolPDF(){await zkontrolujPdfKnihovny();const{jsPDF:e}=window.jspdf,t=new e("p","mm","a4"),o=document.querySelector(".wrapper");logger.log("[Doc] VytvÃ¡Å™Ã­m desktop clone pro PDF generovÃ¡nÃ­...");const a=o.cloneNode(!0);a.classList.add("pdf-clone-desktop"),a.id="pdf-clone-wrapper-temp",document.body.appendChild(a);const n=a.querySelector(".signature-actions");n&&(n.remove(),logger.log('Signature actions (tlaÄÃ­tko "Vymazat podpis" + label) odstranÄ›ny z PDF'));const l=a.querySelector(".btn-podepsat-protokol");l&&(l.remove(),logger.log('Tlacitko "Podepsat protokol" odstraneno z PDF'));const r=a.querySelector(".podpis-overlay");r&&(r.remove(),logger.log("Podpis overlay (tlacitko PODEPSAT) odstranen z PDF"));const i=a.querySelector(".podpis-kontejner");i&&(i.style.border="none",i.style.background="transparent");const s=a.querySelector("#signature-pad");s&&(s.style.border="none");const c=a.querySelector(".btns");c&&(c.remove(),logger.log("DolnÃ­ tlaÄÃ­tka odstranÄ›na z PDF"));const d=a.querySelector("#photoPreviewContainer");d&&(d.remove(),logger.log("Photo preview odstranÄ›n z PDF (fotky jsou v samostatnÃ© sekci)"));const g=a.querySelector(".customer-info-arrow");g&&(g.remove(),logger.log("Å ipka u zÃ¡kaznickÃ© hlaviÄky odstranÄ›na z PDF"));const u=a.querySelector(".customer-info-content");u&&(u.classList.remove("hidden"),u.style.maxHeight="none",u.style.overflow="visible",logger.log("ZÃ¡kaznickÃ½ obsah nastaven jako viditelnÃ½ v PDF"));const m=o.querySelector("#signature-pad"),h=a.querySelector("#signature-pad");if(logger.log("[PDF] Original canvas:",m?"nalezen":"NENALEZEN"),logger.log("[PDF] Clone canvas:",h?"nalezen":"NENALEZEN"),m&&h)try{const e=m.width,t=m.height;logger.log("[PDF] Original canvas rozmery:",e,"x",t);const o=800,a=160;h.width=o,h.height=a,h.style.width="100%",h.style.height="180px";const n=h.getContext("2d");n.fillStyle="white",n.fillRect(0,0,o,a),n.drawImage(m,0,0,e,t,0,0,o,a),logger.log("[PDF] Signature pad zkopirovan do clone:",o,"x",a)}catch(e){logger.warn("[PDF] Nepodarilo se zkopirovat signature pad:",e)}else logger.error("[PDF] Canvas pro podpis nenalezen!");await new Promise(e=>setTimeout(e,150));const p=o.querySelectorAll("textarea"),k=a.querySelectorAll("textarea");p.forEach((e,t)=>{const o=k[t];if(o){const t=document.createElement("div");t.style.cssText="\n        min-height: 60px;\n        padding: 4px 8px;\n        border: 1px solid #999;\n        background: #fff;\n        font-family: 'Poppins', sans-serif;\n        font-size: 12px;\n        line-height: 1.4;\n        color: #1a1a1a;\n        white-space: pre-wrap;\n        word-wrap: break-word;\n        overflow-wrap: break-word;\n        word-break: break-word;\n        box-sizing: border-box;\n        overflow: visible;\n      ",t.textContent=e.value,o.parentNode.replaceChild(t,o)}}),logger.log("Textarea nahrazeny DIV elementy pro PDF");const y=o.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input:not([type])'),v=a.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input:not([type])');y.forEach((e,t)=>{const o=v[t];if(o){const t=document.createElement("div");t.style.cssText="\n        display: block;\n        padding: 4px 8px;\n        border: 1px solid #999;\n        background: #fff;\n        font-family: 'Poppins', sans-serif;\n        font-size: 12px;\n        line-height: 1.4;\n        color: #1a1a1a;\n        white-space: pre-wrap;\n        word-wrap: break-word;\n        overflow-wrap: break-word;\n        word-break: break-word;\n        box-sizing: border-box;\n        min-height: 24px;\n        overflow: visible;\n      ",t.textContent=e.value,o.parentNode.replaceChild(t,o)}}),logger.log("Input pole nahrazeny DIV elementy pro PDF");const f=o.querySelectorAll("select"),w=a.querySelectorAll("select");f.forEach((e,t)=>{const o=w[t];if(o){const t=document.createElement("div");t.style.cssText="\n        display: block;\n        padding: 4px 8px;\n        border: 1px solid #999;\n        background: #fff;\n        font-family: 'Poppins', sans-serif;\n        font-size: 12px;\n        line-height: 1.4;\n        color: #1a1a1a;\n        box-sizing: border-box;\n        min-height: 24px;\n      ";const a=e.options[e.selectedIndex];t.textContent=a?a.text:"",o.parentNode.replaceChild(t,o)}}),logger.log("Select elementy nahrazeny DIV elementy pro PDF");const P=a.getBoundingClientRect(),z=a.querySelectorAll(".section-title"),E=[0];z.forEach(e=>{const t=e.getBoundingClientRect().top-P.top;t>0&&E.push(t)}),logger.log("[PDF] Nalezeno break points:",E.length),logger.log("[Photo] Renderuji clone pomocÃ­ html2canvas...");const b=await html2canvas(a,{scale:3,backgroundColor:"#fff",useCORS:!0,logging:!1,imageTimeout:0,allowTaint:!0,letterRendering:!0,windowWidth:900,windowHeight:a.scrollHeight}),I=b.toDataURL("image/jpeg",.98),D=190,x=b.height*D/b.width,S=b.height/P.height,F=E.map(e=>Math.round(e*S));if(F.push(b.height),logger.log("[PDF] Canvas break points:",F),x>277){const e=277/x,o=D*e,a=277,n=(210-o)/2;t.addImage(I,"JPEG",n,10,o,a),logger.log(`[Doc] Obsah zmenÅ¡en proporcionÃ¡lnÄ› na 1 strÃ¡nku A4: ${x.toFixed(0)}mm â†’ ${a.toFixed(0)}mm (scale: ${(100*e).toFixed(1)}%)`)}else{const e=10;t.addImage(I,"JPEG",e,10,D,x),logger.log("[Doc] PDF mÃ¡ 1 strÃ¡nku (obsah se vejde bez zmenÅ¡enÃ­)")}return document.body.removeChild(a),logger.log("Clone odstranÄ›n, PDF vygenerovÃ¡no"),t}async function generatePhotosPDF(){if(!attachedPhotos.length)return null;await zkontrolujPdfKnihovny();const{jsPDF:e}=window.jspdf,t=new e("p","mm","a4"),o=(t.internal.pageSize.getWidth()-20-5)/2,a=(t.internal.pageSize.getHeight()-20-5)/2;logger.log(`[Doc] VytvÃ¡Å™Ã­m PDF: ${attachedPhotos.length} fotek, ${Math.ceil(attachedPhotos.length/4)} strÃ¡nek`);for(let e=0;e<attachedPhotos.length;e++){const n=attachedPhotos[e],l="string"==typeof n?n:n.data,r="object"==typeof n?n.label:"";e>0&&e%4==0&&(t.addPage(),logger.log(`[Doc] PÅ™idÃ¡na novÃ¡ strÃ¡nka (fotka ${e+1})`));const i=e%4,s=10+i%2*(o+5),c=10+Math.floor(i/2)*(a+5)+5,d=o,g=a-5;try{const o=new Image;o.src=l,await new Promise(e=>{o.onload=e,setTimeout(e,100)});let a=o.width||1e3,n=o.height||1e3;const i=a/n;let u,m;i>d/g?(u=d,m=d/i):(m=g,u=g*i);const h=(d-u)/2,p=(g-m)/2;r&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(0,0,0),t.text(r,s+h,c+p-2)),t.addImage(l,"JPEG",s+h,c+p,u,m,void 0,"MEDIUM"),logger.log(`  [Photo] Fotka ${e+1}/${attachedPhotos.length} - ${r||"bez popisku"} (${a}x${n} â†’ ${Math.round(u)}x${Math.round(m)}mm)`)}catch(o){logger.warn(`Nelze detekovat velikost fotky ${e+1}, pouÅ¾Ã­vÃ¡m celou buÅˆku`),r&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(0,0,0),t.text(r,s,c-2)),t.addImage(l,"JPEG",s,c,d,g,void 0,"MEDIUM")}}return logger.log(`PDF s fotkami vytvoÅ™eno (${attachedPhotos.length} fotek s popisky)`),t}async function generatePricelistPDF(){if(!kalkulaceData)return logger.log("Kalkulace neexistuje - PRICELIST PDF nebude vygenerovano"),null;logger.log("Generuji PDF PRICELIST..."),await zkontrolujPdfKnihovny();const{jsPDF:e}=window.jspdf,t=new e("p","mm","a4"),o=t.internal.pageSize.getWidth(),a=(t.internal.pageSize.getHeight(),15);let n=a;t.setFontSize(20),t.setFont("helvetica","bold"),t.setTextColor(0,0,0),t.text("PRICELIST",o/2,n,{align:"center"}),n+=15;const l=document.getElementById("customer")?.value||"N/A",r=kalkulaceData.adresa||document.getElementById("address")?.value||"N/A",i=document.getElementById("phone")?.value||"",s=document.getElementById("email")?.value||"",c=document.getElementById("claim-number")?.value||"";if(t.setFontSize(10),t.setFont("helvetica","normal"),t.setTextColor(0,0,0),c&&(t.text(`Cislo reklamace: ${c}`,a,n),n+=6),t.setFont("helvetica","bold"),t.text(`Zakaznik: ${l}`,a,n),n+=6,t.setFont("helvetica","normal"),t.text(`Adresa: ${r}`,a,n),n+=6,i&&(t.text(`Telefon: ${i}`,a,n),n+=6),s&&(t.text(`Email: ${s}`,a,n),n+=6),n+=5,t.setLineWidth(.5),t.setDrawColor(0,0,0),t.line(a,n,o-a,n),n+=10,t.setFontSize(14),t.setFont("helvetica","bold"),t.text("Rozpis cen",a,n),n+=10,t.setFontSize(10),t.setFont("helvetica","normal"),kalkulaceData.reklamaceBezDopravy)t.text("Dopravne (reklamace)",a,n),t.text("0.00 EUR",o-a-30,n),n+=7;else{const e=`Dopravne (${kalkulaceData.vzdalenost} km)`,l=kalkulaceData.dopravne.toFixed(2);t.text(e,a,n),t.text(`${l} EUR`,o-a-30,n),n+=7}if(kalkulaceData.sluzby&&kalkulaceData.sluzby.length>0&&(n+=3,t.setFont("helvetica","bold"),t.text("Sluzby:",a,n),n+=7,t.setFont("helvetica","normal"),kalkulaceData.sluzby.forEach(e=>{const l=`  ${e.nazev}`,r=e.cena.toFixed(2);t.text(l,a,n),t.text(`${r} EUR`,o-a-30,n),n+=6}),n+=3),kalkulaceData.dilyPrace&&kalkulaceData.dilyPrace.length>0&&(n+=3,t.setFont("helvetica","bold"),t.text("Dily a prace:",a,n),n+=7,t.setFont("helvetica","normal"),kalkulaceData.dilyPrace.forEach(e=>{const l=`  ${e.nazev} (${e.pocet}x)`,r=e.cena.toFixed(2);t.text(l,a,n),t.text(`${r} EUR`,o-a-30,n),n+=6}),n+=3),kalkulaceData.tezkyNabytek&&(t.text("Priplatek: Tezky nabytek (nad 50 kg)",a,n),t.text("80.00 EUR",o-a-30,n),n+=7),kalkulaceData.druhaOsoba&&(t.text("Priplatek: Druha osoba",a,n),t.text("80.00 EUR",o-a-30,n),n+=7),n+=5,t.setLineWidth(.3),t.line(a,n,o-a,n),n+=8,t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(0,0,0),t.text("CELKEM:",a,n),t.text(`${kalkulaceData.celkovaCena.toFixed(2)} EUR`,o-a-40,n),n+=10,kalkulaceData.poznamka){n+=5,t.setFontSize(10),t.setFont("helvetica","italic"),t.setTextColor(100,100,100),t.text("Poznamka:",a,n),n+=6,t.setFont("helvetica","normal");t.splitTextToSize(kalkulaceData.poznamka,o-30).forEach(e=>{t.text(e,a,n),n+=5})}return logger.log(`PDF PRICELIST vytvoÅ™en (${kalkulaceData.celkovaCena.toFixed(2)} â‚¬)`),t}async function exportBothPDFs(){try{showLoadingWithMessage(!0,"PÅ™ipravuji protokol...","ProsÃ­m Äekejte"),logger.log("[List] Generuji kompletnÃ­ PDF (protokol + PRICELIST + fotodokumentace)..."),logger.log("ğŸ’° Kontrola kalkulace - kalkulaceData:",kalkulaceData);const e=await generateProtocolPDF();if(kalkulaceData){showLoadingWithMessage(!0,"PÅ™idÃ¡vÃ¡m pricelist...",`CelkovÃ¡ cena: ${kalkulaceData.celkovaCena.toFixed(2)} â‚¬`),logger.log("Kalkulace nalezena - pÅ™idÃ¡vÃ¡m PRICELIST..."),logger.log("[Stats] Kalkulace data:",kalkulaceData),e.addPage();const t=e.internal.pageSize.getWidth(),o=(e.internal.pageSize.getHeight(),15);let a=o;e.setFontSize(20),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text("PRICELIST",t/2,a,{align:"center"}),a+=15;const n=document.getElementById("customer")?.value||"N/A",l=kalkulaceData.adresa||document.getElementById("address")?.value||"N/A",r=document.getElementById("phone")?.value||"",i=document.getElementById("email")?.value||"",s=document.getElementById("claim-number")?.value||"";if(e.setFontSize(10),e.setFont("helvetica","normal"),e.setTextColor(0,0,0),s&&(e.text(`Cislo reklamace: ${s}`,o,a),a+=6),e.setFont("helvetica","bold"),e.text(`Zakaznik: ${n}`,o,a),a+=6,e.setFont("helvetica","normal"),e.text(`Adresa: ${l}`,o,a),a+=6,r&&(e.text(`Telefon: ${r}`,o,a),a+=6),i&&(e.text(`Email: ${i}`,o,a),a+=6),a+=5,e.setLineWidth(.5),e.setDrawColor(0,0,0),e.line(o,a,t-o,a),a+=10,e.setFontSize(14),e.setFont("helvetica","bold"),e.text("Rozpis cen",o,a),a+=10,e.setFontSize(10),e.setFont("helvetica","normal"),kalkulaceData.reklamaceBezDopravy)e.text("Dopravne (reklamace)",o,a),e.text("0.00 EUR",t-o-30,a),a+=7;else{const n=`Dopravne (${kalkulaceData.vzdalenost} km)`,l=kalkulaceData.dopravne.toFixed(2);e.text(n,o,a),e.text(`${l} EUR`,t-o-30,a),a+=7}kalkulaceData.dilyPrace&&kalkulaceData.dilyPrace.length>0&&(a+=3,e.setFont("helvetica","bold"),e.text("Dily a prace:",o,a),a+=7,e.setFont("helvetica","normal"),kalkulaceData.dilyPrace.forEach(n=>{const l=`  ${n.nazev} (${n.pocet}x)`,r=n.cena.toFixed(2);e.text(l,o,a),e.text(`${r} EUR`,t-o-30,a),a+=6}),a+=3),kalkulaceData.tezkyNabytek&&(e.text("Priplatek: Tezky nabytek (nad 50 kg)",o,a),e.text("80.00 EUR",t-o-30,a),a+=7),kalkulaceData.druhaOsoba&&(e.text("Priplatek: Druha osoba",o,a),e.text("80.00 EUR",t-o-30,a),a+=7),a+=5,e.setLineWidth(.3),e.line(o,a,t-o,a),a+=8,e.setFontSize(14),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text("CELKEM:",o,a),e.text(`${kalkulaceData.celkovaCena.toFixed(2)} EUR`,t-o-40,a),logger.log(`PRICELIST pÅ™idÃ¡n (${kalkulaceData.celkovaCena.toFixed(2)} â‚¬)`)}else logger.warn("Kalkulace nenalezena - PRICELIST nebude v PDF"),logger.warn("   MoÅ¾nÃ© pÅ™Ã­Äiny:"),logger.warn("   1. Kalkulace nebyla vytvoÅ™ena"),logger.warn("   2. Kalkulace nebyla uloÅ¾ena do databÃ¡ze"),logger.warn("   3. Chyba pÅ™i naÄÃ­tÃ¡nÃ­ z databÃ¡ze");if(attachedPhotos.length>0){showLoadingWithMessage(!0,"PÅ™idÃ¡vÃ¡m fotografie...",`${attachedPhotos.length} fotografiÃ­`),logger.log("[Photo] PÅ™idÃ¡vÃ¡m fotodokumentaci...");const t=e.internal.pageSize.getWidth(),o=e.internal.pageSize.getHeight(),a=10;e.addPage(),e.setFontSize(16),e.setFont("helvetica","bold"),e.text("FOTODOKUMENTACE",t/2,20,{align:"center"});let n=35;e.setFontSize(10),e.setFont("helvetica","normal");[`Cislo reklamace: ${document.getElementById("claim-number")?.value||"N/A"}`,`Datum: ${document.getElementById("sign-date")?.value||(new Date).toLocaleDateString("cs-CZ")}`].forEach(t=>{e.text(t,a,n),n+=6}),n+=5,e.setLineWidth(.5),e.line(a,n,t-a,n),n+=10,e.setFontSize(12),e.setFont("helvetica","bold"),e.text("INDEX PHOTO",a,n),n+=8,e.setFontSize(8),e.setFont("helvetica","normal");const l=25,r=5,i=Math.floor((t-2*a)/(l+r));for(let t=0;t<attachedPhotos.length;t++){const s=attachedPhotos[t],c="string"==typeof s?s:s.data,d="object"==typeof s?s.label:`Fotka ${t+1}`,g=t%i,u=Math.floor(t/i),m=a+g*(l+r),h=n+u*(l+r+4);if(h+l>o-a)e.addPage(),n=20;else try{e.addImage(c,"JPEG",m,h,l,l,void 0,"FAST"),e.setFontSize(7),e.text(`${t+1}. ${d}`,m,h+l+3,{maxWidth:l})}catch(e){logger.warn(`Nelze pÅ™idat miniaturu ${t+1}`)}}logger.log(`Index ${attachedPhotos.length} fotek vytvoÅ™en`),e.addPage();const s=5,c=5,d=4,g=2,u=(t-2*a-s)/g,m=(o-2*a-s)/2;for(let t=0;t<attachedPhotos.length;t++){const o=attachedPhotos[t],n="string"==typeof o?o:o.data,l="object"==typeof o?o.label:"";t>0&&t%d===0&&e.addPage();const r=t%d,i=r%g,h=Math.floor(r/g),p=a+i*(u+s),k=a+h*(m+s)+c,y=u,v=m-c;try{const o=new Image;o.src=n,await new Promise(e=>{o.onload=e,setTimeout(e,100)});const a=(o.width||1e3)/(o.height||1e3);let r,i;a>y/v?(r=y,i=y/a):(i=v,r=v*a);const s=(y-r)/2,c=(v-i)/2;l&&(e.setFontSize(8),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text(l,p+s,k+c-2)),e.addImage(n,"JPEG",p+s,k+c,r,i,void 0,"MEDIUM"),logger.log(`  [Photo] Fotka ${t+1}/${attachedPhotos.length} - ${l}`)}catch(o){logger.warn(`Chyba fotky ${t+1}`),l&&(e.setFontSize(8),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text(l,p,k-2)),e.addImage(n,"JPEG",p,k,y,v,void 0,"MEDIUM")}}logger.log(`Fotodokumentace pÅ™idÃ¡na (${attachedPhotos.length} fotek)`),"undefined"!=typeof WGSToast?WGSToast.zobrazit(`PDF vytvoÅ™eno (protokol + ${attachedPhotos.length} fotek)`,{titulek:"WGS"}):showNotif("success",`PDF vytvoÅ™eno (protokol + ${attachedPhotos.length} fotek)`)}else"undefined"!=typeof WGSToast?WGSToast.zobrazit("Protokol vytvoÅ™en",{titulek:"WGS"}):showNotif("success","Protokol vytvoÅ™en (bez fotek)");showLoadingWithMessage(!0,"UklÃ¡dÃ¡m do knihovny...","PDF bude dostupnÃ© v knihovnÄ›"),logger.log("[Save] UklÃ¡dÃ¡m PDF do databÃ¡ze...");try{const t=await fetchCsrfToken(),o=e.output("datauristring").split(",")[1],a=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"save_pdf_only",reklamace_id:currentReklamaceId,complete_pdf:o,csrf_token:t})});if(a.ok){const e=await a.json();"success"===e.status?logger.log("PDF ÃºspÄ›Å¡nÄ› uloÅ¾en do databÃ¡ze"):logger.warn("PDF se nepodaÅ™ilo uloÅ¾it:",e.message)}}catch(e){logger.error("Chyba pÅ™i uklÃ¡dÃ¡nÃ­ PDF:",e)}const t=e.output("blob"),o=`${(document.getElementById("claim-number")?.value||"protokol").replace(/[\/\s]+/g,"_")}.pdf`;pdfPreviewContext="export",cachedPdfDoc=e,cachedPdfBase64=null,"function"==typeof otevritPdfPreview?otevritPdfPreview(t,o):window.open(URL.createObjectURL(t),"_blank"),await saveProtokolToDB(),logger.log("[List] OznaÄuji reklamaci jako hotovou...");try{const e=await fetchCsrfToken(),t=await fetch("app/controllers/save.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"update",id:currentReklamaceId,mark_as_completed:"1",csrf_token:e})});"success"===(await t.json()).status&&logger.log("Reklamace oznaÄena jako hotovÃ¡")}catch(e){logger.error("Chyba pÅ™i oznaÄovÃ¡nÃ­:",e)}}catch(e){logger.error("Chyba pÅ™i generovÃ¡nÃ­ PDF:",e),showNotif("error","Chyba pÅ™i vytvÃ¡Å™enÃ­ PDF")}finally{showLoading(!1)}}async function sendToCustomer(){logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),logger.log("ğŸš€ sendToCustomer() SPUÅ TÄšNA"),logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),logger.log("currentReklamaceId:",currentReklamaceId),logger.log("attachedPhotos.length:",attachedPhotos.length),logger.log("kalkulaceData:",kalkulaceData);try{showLoadingWithMessage(!0,"PÅ™ipravuji protokol...","ProsÃ­m Äekejte"),logger.log("[List] Generuji kompletnÃ­ PDF pro nÃ¡hled pÅ™ed odeslÃ¡nÃ­m..."),logger.log("ğŸ’° Kontrola kalkulace - kalkulaceData:",kalkulaceData);const e=await generateProtocolPDF();if(kalkulaceData){showLoadingWithMessage(!0,"PÅ™idÃ¡vÃ¡m pricelist...",`CelkovÃ¡ cena: ${kalkulaceData.celkovaCena.toFixed(2)} â‚¬`),logger.log("Kalkulace nalezena - pÅ™idÃ¡vÃ¡m PRICELIST..."),logger.log("[Stats] Kalkulace data:",kalkulaceData),e.addPage();const t=e.internal.pageSize.getWidth(),o=(e.internal.pageSize.getHeight(),15);let a=o;e.setFontSize(20),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text("PRICELIST",t/2,a,{align:"center"}),a+=15;const n=document.getElementById("customer")?.value||"N/A",l=kalkulaceData.adresa||document.getElementById("address")?.value||"N/A",r=document.getElementById("phone")?.value||"",i=document.getElementById("email")?.value||"",s=document.getElementById("claim-number")?.value||"";if(e.setFontSize(10),e.setFont("helvetica","normal"),e.setTextColor(0,0,0),s&&(e.text(`Cislo reklamace: ${s}`,o,a),a+=6),e.setFont("helvetica","bold"),e.text(`Zakaznik: ${n}`,o,a),a+=6,e.setFont("helvetica","normal"),e.text(`Adresa: ${l}`,o,a),a+=6,r&&(e.text(`Telefon: ${r}`,o,a),a+=6),i&&(e.text(`Email: ${i}`,o,a),a+=6),a+=5,e.setLineWidth(.5),e.setDrawColor(0,0,0),e.line(o,a,t-o,a),a+=10,e.setFontSize(14),e.setFont("helvetica","bold"),e.text("Rozpis cen",o,a),a+=10,e.setFontSize(10),e.setFont("helvetica","normal"),kalkulaceData.reklamaceBezDopravy)e.text("Dopravne (reklamace)",o,a),e.text("0.00 EUR",t-o-30,a),a+=7;else{const n=`Dopravne (${kalkulaceData.vzdalenost} km)`,l=kalkulaceData.dopravne.toFixed(2);e.text(n,o,a),e.text(`${l} EUR`,t-o-30,a),a+=7}kalkulaceData.dilyPrace&&kalkulaceData.dilyPrace.length>0&&(a+=3,e.setFont("helvetica","bold"),e.text("Dily a prace:",o,a),a+=7,e.setFont("helvetica","normal"),kalkulaceData.dilyPrace.forEach(n=>{const l=`  ${n.nazev} (${n.pocet}x)`,r=n.cena.toFixed(2);e.text(l,o,a),e.text(`${r} EUR`,t-o-30,a),a+=6}),a+=3),kalkulaceData.tezkyNabytek&&(e.text("Priplatek: Tezky nabytek (nad 50 kg)",o,a),e.text("80.00 EUR",t-o-30,a),a+=7),kalkulaceData.druhaOsoba&&(e.text("Priplatek: Druha osoba",o,a),e.text("80.00 EUR",t-o-30,a),a+=7),a+=5,e.setLineWidth(.3),e.line(o,a,t-o,a),a+=8,e.setFontSize(14),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text("CELKEM:",o,a),e.text(`${kalkulaceData.celkovaCena.toFixed(2)} EUR`,t-o-40,a),logger.log(`PRICELIST pÅ™idÃ¡n (${kalkulaceData.celkovaCena.toFixed(2)} â‚¬)`)}else logger.warn("Kalkulace nenalezena - PRICELIST nebude v emailu"),logger.warn("   Zkontrolujte, zda byla kalkulace vytvoÅ™ena a uloÅ¾ena");if(attachedPhotos.length>0){showLoadingWithMessage(!0,"PÅ™idÃ¡vÃ¡m fotografie...",`${attachedPhotos.length} fotografiÃ­`),logger.log("[Photo] PÅ™idÃ¡vÃ¡m fotodokumentaci...");const t=e.internal.pageSize.getWidth(),o=e.internal.pageSize.getHeight(),a=10;e.addPage(),e.setFontSize(16),e.setFont("helvetica","bold"),e.text("FOTODOKUMENTACE",t/2,20,{align:"center"});let n=35;e.setFontSize(10),e.setFont("helvetica","normal");[`Cislo reklamace: ${document.getElementById("claim-number")?.value||"N/A"}`,`Datum: ${document.getElementById("sign-date")?.value||(new Date).toLocaleDateString("cs-CZ")}`].forEach(t=>{e.text(t,a,n),n+=6}),n+=5,e.setLineWidth(.5),e.line(a,n,t-a,n),n+=10,e.setFontSize(12),e.setFont("helvetica","bold"),e.text("INDEX PHOTO",a,n),n+=8,e.setFontSize(8),e.setFont("helvetica","normal");const l=25,r=5,i=Math.floor((t-2*a)/(l+r));for(let t=0;t<attachedPhotos.length;t++){const s=attachedPhotos[t],c="string"==typeof s?s:s.data,d="object"==typeof s?s.label:`Fotka ${t+1}`,g=t%i,u=Math.floor(t/i),m=a+g*(l+r),h=n+u*(l+r+4);if(h+l>o-a)e.addPage(),n=20;else try{e.addImage(c,"JPEG",m,h,l,l,void 0,"FAST"),e.setFontSize(7),e.text(`${t+1}. ${d}`,m,h+l+3,{maxWidth:l})}catch(e){logger.warn(`Nelze pÅ™idat miniaturu ${t+1}`)}}logger.log(`Index ${attachedPhotos.length} fotek vytvoÅ™en`),e.addPage();const s=5,c=5,d=4,g=2,u=(t-2*a-s)/g,m=(o-2*a-s)/2;for(let t=0;t<attachedPhotos.length;t++){const o=attachedPhotos[t],n="string"==typeof o?o:o.data,l="object"==typeof o?o.label:"";t>0&&t%d===0&&e.addPage();const r=t%d,i=r%g,h=Math.floor(r/g),p=a+i*(u+s),k=a+h*(m+s)+c,y=u,v=m-c;try{const o=new Image;o.src=n,await new Promise(e=>{o.onload=e,setTimeout(e,100)});const a=(o.width||1e3)/(o.height||1e3);let r,i;a>y/v?(r=y,i=y/a):(i=v,r=v*a);const s=(y-r)/2,c=(v-i)/2;l&&(e.setFontSize(8),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text(l,p+s,k+c-2)),e.addImage(n,"JPEG",p+s,k+c,r,i,void 0,"MEDIUM"),logger.log(`  [Photo] Fotka ${t+1}/${attachedPhotos.length} - ${l}`)}catch(o){logger.warn(`Chyba fotky ${t+1}`),l&&(e.setFontSize(8),e.setFont("helvetica","bold"),e.setTextColor(0,0,0),e.text(l,p,k-2)),e.addImage(n,"JPEG",p,k,y,v,void 0,"MEDIUM")}}logger.log(`Fotodokumentace pÅ™idÃ¡na (${attachedPhotos.length} fotek)`)}const t=e.output("datauristring").split(",")[1];cachedPdfDoc=e,cachedPdfBase64=t,pdfPreviewContext="send",logger.log("ğŸ“§ OdesÃ­lÃ¡m email pÅ™Ã­mo bez nÃ¡hledu..."),await potvrditAOdeslat()}catch(e){logger.error("KRITICKÃ CHYBA v sendToCustomer():",e),logger.error("Stack trace:",e.stack),showNotif("error","Chyba pÅ™i vytvÃ¡Å™enÃ­ PDF: "+e.message),showLoadingWithMessage(!1),"function"==typeof wgsConfirm&&await wgsConfirm(`Chyba pÅ™i odesÃ­lÃ¡nÃ­:\n\n${e.message}\n\nKonzole obsahuje detailnÃ­ informace.`,{titulek:"Chyba odesÃ­lÃ¡nÃ­",btnPotvrdit:"OK",btnZrusit:null})}}async function potvrditAOdeslat(){if(logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),logger.log("ğŸ“§ potvrditAOdeslat() SPUÅ TÄšNA"),logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),logger.log("cachedPdfBase64 exists:",!!cachedPdfBase64),logger.log("cachedPdfBase64 length:",cachedPdfBase64?cachedPdfBase64.length:0),!cachedPdfBase64)return logger.error("âŒ PDF nenÃ­ dostupnÃ© - cachedPdfBase64 je prÃ¡zdnÃ½!"),void showNotif("error","PDF nenÃ­ dostupnÃ©");try{showLoadingWithMessage(!0,"OdesÃ­lÃ¡m email...","ZÃ¡kaznÃ­kovi se odesÃ­lÃ¡ kompletnÃ­ PDF"),logger.log("ğŸ“§ OdesÃ­lÃ¡m PDF zÃ¡kaznÃ­kovi..."),logger.log("currentReklamaceId:",currentReklamaceId),logger.log("ğŸ”‘ ZÃ­skÃ¡vÃ¡m CSRF token...");const e=await fetchCsrfToken();logger.log("âœ… CSRF token zÃ­skÃ¡n:",e?"ANO":"NE"),logger.log("ğŸŒ OdesÃ­lÃ¡m fetch() na api/protokol_api.php..."),logger.log("   Action: send_email"),logger.log("   Reklamace ID:",currentReklamaceId),logger.log("   PDF velikost:",cachedPdfBase64.length,"znakÅ¯");const t=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"send_email",reklamace_id:currentReklamaceId,complete_pdf:cachedPdfBase64,csrf_token:e})});if(logger.log("ğŸ“¥ Response pÅ™ijata:",t.status,t.statusText),!t.ok){const e=await t.text();logger.error("Server error:",t.status,e);try{const o=JSON.parse(e);throw logger.error("Error detail:",o),new Error(o.error||o.message||`Server error ${t.status}`)}catch(o){throw new Error(`Server error ${t.status}: ${e.substring(0,200)}`)}}const o=await t.json();if(logger.log("ğŸ“¦ JSON parsed:",o),"success"===o.status){logger.log("âœ… Email ÃšSPÄšÅ NÄš odeslÃ¡n!"),"undefined"!=typeof WGSToast?WGSToast.zobrazit("Email odeslÃ¡n zÃ¡kaznÃ­kovi",{titulek:"WGS"}):showNotif("success","Email odeslÃ¡n zÃ¡kaznÃ­kovi"),logger.log("ğŸ’¾ UklÃ¡dÃ¡m protokol do DB..."),await saveProtokolToDB(),logger.log("âœ… Protokol uloÅ¾en"),logger.log("âœ… [List] OznaÄuji reklamaci jako hotovou...");const t=await fetch("app/controllers/save.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"update",id:currentReklamaceId,mark_as_completed:"1",csrf_token:e})}),o=await t.json();if(logger.log("ğŸ“¦ Mark result:",o),"success"===o.status?logger.log("âœ… Reklamace oznaÄena jako hotovÃ¡"):logger.warn("âš ï¸ NepodaÅ™ilo se oznaÄit jako hotovou:",o.message),currentReklamaceId){const e="photoSections_"+currentReklamaceId,t="photosPDF_"+currentReklamaceId;localStorage.removeItem(e),localStorage.removeItem(t),localStorage.removeItem("photosReadyForProtocol"),localStorage.removeItem("photosCustomerId"),logger.log("ğŸ—‘ï¸ Fotky a PDF vymazÃ¡ny z localStorage")}logger.log("ğŸ”„ PÅ™esmÄ›rovÃ¡vÃ¡m na seznam.php za 2 sekundy..."),setTimeout(()=>{logger.log('ğŸ”„ REDIRECT: window.location.href = "seznam.php"'),window.location.href="seznam.php"},2e3)}else logger.error("âŒ API vrÃ¡tilo chybu:",o.message),showNotif("error",o.message||"Chyba odesÃ­lÃ¡nÃ­")}catch(e){logger.error("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),logger.error("âŒ KRITICKÃ CHYBA v potvrditAOdeslat()"),logger.error("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),logger.error("Error:",e),logger.error("Message:",e.message),logger.error("Stack:",e.stack),showNotif("error","Chyba odesÃ­lÃ¡nÃ­: "+e.message)}finally{logger.log("ğŸ”š potvrditAOdeslat() KONÄŒÃ (finally block)"),showLoadingWithMessage(!1)}}async function saveProtokolToDB(){try{const e=await fetchCsrfToken(),t=parseFloat(document.getElementById("price-total").value)||0,o=await fetch("api/protokol_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"save_protokol",reklamace_id:currentReklamaceId,problem_description:document.getElementById("problem-cz").value,repair_proposal:document.getElementById("repair-cz").value,solved:document.getElementById("solved").value,dealer:document.getElementById("dealer")?.value||"NE",technician:document.getElementById("technician").value,cena_celkem:t,csrf_token:e})});"success"===(await o.json()).status&&logger.log("Protokol uloÅ¾en do DB (vÄetnÄ› cenovÃ½ch ÃºdajÅ¯)")}catch(e){logger.error("Chyba uklÃ¡dÃ¡nÃ­:",e)}}async function translateTextApi(e,t="cs",o="en"){if(!e||""===e.trim())return"";try{const a=await fetch("api/translate_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,source:t,target:o})}),n=await a.json();return"success"===n.status&&n.translated?n.translated:(logger.warn("PÅ™eklad selhal:",n.message||"NeznÃ¡mÃ¡ chyba"),"")}catch(e){return logger.error("Chyba pÅ™ekladu:",e),""}}async function translateText(e,t){const o=document.getElementById(e),a=document.getElementById(t);if(!o||!a)return void logger.error("Pole pro pÅ™eklad nenalezeno:",e,t);const n=o.value.trim();if(!n)return void showNotification("NejdÅ™Ã­ve napiÅ¡te text pro pÅ™eklad","error");const l=o.parentElement.querySelector(".translate-btn");l&&(l.classList.add("loading"),l.disabled=!0);try{logger.log("[Sync] PÅ™eklÃ¡dÃ¡m:",n.substring(0,50)+"...");const e=await translateTextApi(n,"cs","en");e?(a.value=e,logger.log("PÅ™eloÅ¾eno:",e.substring(0,50)+"..."),showNotification("Text pÅ™eloÅ¾en","success")):showNotification("PÅ™eklad selhal","error")}catch(e){logger.error("Chyba pÅ™i pÅ™ekladu:",e),showNotification("Chyba pÅ™i pÅ™ekladu","error")}finally{l&&(l.classList.remove("loading"),l.disabled=!1)}}async function autoTranslateField(e){const t=document.getElementById(e);if(!t)return;const o=t.value.trim();if(!o)return;logger.log("[Sync] PÅ™eklÃ¡dÃ¡m pole:",e);let a=t.parentElement.querySelector(".en-label");if(!a){const e=t.closest(".input-group, .form-group, div");e&&(a=e.querySelector(".en-label"))}if(!a)return void logger.warn("En-label pro",e,"nenalezen");const n=await translateTextApi(o,"cs","en");n&&(a.textContent=n,logger.log("PÅ™eloÅ¾eno:",e,"->",n.substring(0,50)+"..."))}function initAutoTranslation(){[{source:"description-cz",target:"description-en"},{source:"problem-cz",target:"problem-en"},{source:"repair-cz",target:"repair-en"}].forEach(({source:e,target:t})=>{const o=document.getElementById(e);if(!o)return void logger.warn("Auto-pÅ™eklad: Pole nenalezeno:",e);const a=debounce(()=>{translateText(e,t)},1500);o.addEventListener("input",a),o.addEventListener("blur",()=>{translateText(e,t)}),logger.log("Auto-pÅ™eklad aktivovÃ¡n pro:",e,"â†’",t)})}async function translateField(e,t=!1){const o=document.getElementById(e+"-cz"),a=document.getElementById(e+"-en");if(!o||!a)return;const n=o.value.trim();if(n&&!(n.length<5))try{a.value="Prekladam...";const t=await fetch("api/translate_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n,engine:"mymemory"})}),o=await t.json();"success"===o.status?(a.value=o.translated,logger.log("OK:",e)):a.value=""}catch(e){logger.error("Err:",e),a.value=""}}window.zavritFullscreenPodpis=zavritFullscreenPodpis,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initAutoTranslation):initAutoTranslation(),logger.log("AutomatickÃ½ pÅ™eklad aktivovÃ¡n"),window.addEventListener("load",()=>{["description","problem","repair"].forEach(e=>{const t=document.getElementById(e+"-cz");if(!t)return;let o;t.addEventListener("input",()=>{clearTimeout(o),o=setTimeout(()=>{t.value.trim().length>10&&translateField(e,!0)},2e3)})}),logger.log("Translate ready")}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;const o=t.getAttribute("data-action");"reload"!==o?void 0!==window.Utils&&window.Utils.ActionRegistry&&window.Utils.ActionRegistry.handlers&&window.Utils.ActionRegistry.handlers[o]||"function"==typeof window[o]&&window[o]():location.reload()}),document.addEventListener("click",e=>{const t=e.target.closest("[data-navigate]")?.getAttribute("data-navigate");t&&("function"==typeof navigateTo?navigateTo(t):location.href=t)}),document.addEventListener("change",e=>{const t=e.target.closest("[data-onchange]");if(!t)return;const o=t.getAttribute("data-onchange"),a=t.getAttribute("data-onchange-value")||t.value;"function"==typeof window[o]&&window[o](a)})}),function(){let e=null;function t(){if(window.zakaznikSchvaleniModal&&window.zakaznikSchvaleniModal.close)window.zakaznikSchvaleniModal.close();else{const e=document.getElementById("zakaznikSchvaleniOverlay");e&&e.classList.add("hidden"),window.scrollLock&&window.scrollLock.disable("zakaznik-schvaleni-overlay")}e&&e.clear();const t=document.getElementById("zakaznikVolbaPodpisu"),o=document.getElementById("zakaznikPodpisSekce"),a=document.getElementById("souhlasDilOverlay"),n=document.getElementById("prodlouzeniLhutyInfo");t&&(t.style.display="block"),o&&(o.style.display="none"),a&&(a.style.display="none"),n&&(n.style.display="none")}document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("btnPodepsatProtokol"),a=document.getElementById("zakaznikSchvaleniOverlay"),n=document.getElementById("zakaznikSchvaleniPouzit"),l=document.getElementById("zakaznikVymazatPodpis"),r=document.getElementById("zakaznikSchvaleniPad");if(!o||!a||!r)return;o.addEventListener("click",async()=>{o.disabled=!0,o.textContent="Pripravuji...";try{await async function(){document.getElementById("zakaznikSchvaleniPad");logger.log("[Podpis] Spoustim pojistku prekladu pred podpisem...");const e=["description","problem","repair"];for(const t of e){const e=document.getElementById(t+"-cz"),o=document.getElementById(t+"-en");if(e&&o&&e.value.trim().length>5&&(!o.value||"Prekladam..."===o.value||""===o.value.trim())){logger.log("[Podpis] Prekladam pole:",t);try{await translateField(t,!0)}catch(e){logger.warn("[Podpis] Preklad selhal pro:",t,e)}}}logger.log("[Podpis] Pojistka prekladu dokoncena"),function(){const e=document.getElementById("repair-cz")?.value||"",t=document.getElementById("zakaznikSchvaleniText");t&&(t.textContent=e||"(NenÃ­ vyplnÄ›no)");const o=document.getElementById("payment")?.value||"-";document.getElementById("souhrn-plati-zakaznik").textContent=o;const a=document.getElementById("sign-date")?.value||"-";let n="-";if(a&&"-"!==a){const e=new Date(a);n=isNaN(e.getTime())?a:e.toLocaleDateString("cs-CZ")}document.getElementById("souhrn-datum-podpisu").textContent=n;const l=document.getElementById("solved")?.value||"-";document.getElementById("souhrn-vyreseno").textContent=l;const r=document.getElementById("dealer")?.value||"-";document.getElementById("souhrn-prodejce").textContent=r;const i=document.getElementById("damage")?.value||"-";document.getElementById("souhrn-poskozeni").textContent=i}();const t=document.getElementById("typ-zakaznika")?.value||"",o=document.getElementById("btnNutnoObjednatDil"),a=!(t.toLowerCase().includes("iÄo")||t.toLowerCase().includes("ico")||t.toLowerCase().includes("firma")||t.toLowerCase().includes("company"));logger.log("[Podpis] Typ zÃ¡kaznÃ­ka:",t,"| Je fyzickÃ¡ osoba:",a),o&&(a?(o.style.display="block",logger.log("[Podpis] TlaÄÃ­tko NUTNO OBJEDNAT DÃL zobrazeno (fyzickÃ¡ osoba)")):(o.style.display="none",logger.log("[Podpis] TlaÄÃ­tko NUTNO OBJEDNAT DÃL skryto (firma/IÄŒO)")));const n=document.getElementById("zakaznikVolbaPodpisu"),l=document.getElementById("zakaznikPodpisSekce");n&&(n.style.display="block");l&&(l.style.display="none");const r=document.getElementById("prodlouzeniLhutyInfo");r&&(r.style.display="none");if(logger.log("[ZakaznikSchvaleni] FyzickÃ¡ osoba:",a,"| Typ:",t),window.zakaznikSchvaleniModal&&window.zakaznikSchvaleniModal.open)window.zakaznikSchvaleniModal.open();else{const e=document.getElementById("zakaznikSchvaleniOverlay");e&&e.classList.remove("hidden"),window.scrollLock&&window.scrollLock.enable("zakaznik-schvaleni-overlay")}}()}finally{o.disabled=!1,o.textContent="Podepsat protokol"}}),l?.addEventListener("click",()=>{e&&e.clear()}),n?.addEventListener("click",()=>{!function(){if(!e||e.isEmpty())return void("function"==typeof showNotif?showNotif("error","ProsÃ­m podepiÅ¡te se pÅ™ed potvrzenÃ­m"):wgsToast.warning("ProsÃ­m podepiÅ¡te se pÅ™ed potvrzenÃ­m"));const o=document.getElementById("signature-pad");if(!o)return console.error("[ZakaznikSchvaleni] HlavnÃ­ canvas nenalezen"),void("function"==typeof showNotif&&showNotif("error","Chyba pÅ™i pÅ™enosu podpisu"));const a=e.toDataURL(),n=new Image;n.onload=()=>{const e=o.getContext("2d");e.setTransform(1,0,0,1,0,0),e.fillStyle="white",e.fillRect(0,0,o.width,o.height);const a=o.width,l=o.height,r=n.width/n.height;let i,s,c,d;r>a/l?(i=.9*a,s=i/r):(s=.9*l,i=s*r),c=(a-i)/2,d=(l-s)/2,e.drawImage(n,c,d,i,s),"undefined"!=typeof WGSToast?WGSToast.zobrazit("Podpis byl pÅ™enesen do protokolu",{titulek:"WGS"}):"function"==typeof showNotif&&showNotif("success","Podpis byl pÅ™enesen do protokolu");const g=document.getElementById("checkboxProdlouzeniLhuty"),u=document.getElementById("prodlouzeniLhutyHlavni");g&&u&&(g.checked?(u.style.display="block",logger.log("[ZakaznikSchvaleni] Text prodlouÅ¾enÃ­ lhÅ¯ty zobrazen v hlavnÃ­m formulÃ¡Å™i")):u.style.display="none"),t(),[{source:"description-cz",target:"description-en"},{source:"problem-cz",target:"problem-en"},{source:"repair-cz",target:"repair-en"}].forEach(({source:e,target:t})=>{const o=document.getElementById(e);o&&o.value.trim()&&"function"==typeof translateText&&translateText(e,t)})},n.onerror=()=>{console.error("[ZakaznikSchvaleni] Chyba naÄtenÃ­ podpisu"),"function"==typeof showNotif&&showNotif("error","Chyba pÅ™i pÅ™enosu podpisu"),t()},n.src=a}()});const i=document.getElementById("btnNutnoObjednatDil"),s=document.getElementById("btnPouzePodpis"),c=document.getElementById("btnSouhlasim"),d=document.getElementById("btnNesouhlasim");window.textProdlouzeniLhuty="",window.zobrazitPodpisSekci=function(t){const o=document.getElementById("zakaznikVolbaPodpisu"),a=document.getElementById("zakaznikPodpisSekce"),n=document.getElementById("prodlouzeniLhutyInfo"),l=document.getElementById("prodlouzeniLhutyInfoText"),r=document.getElementById("zakaznikSchvaleniPad");logger.log("[Podpis] zobrazitPodpisSekci volÃ¡na s textem:",t),o&&(o.style.display="none",logger.log("[Podpis] Volba podpisu schovÃ¡na")),a&&(a.style.display="block",logger.log("[Podpis] Sekce podpisu zobrazena")),window.textProdlouzeniLhuty=t,t&&n&&l?(l.textContent=t,n.style.display="block",logger.log("[Podpis] Info text zobrazen")):n&&(n.style.display="none"),setTimeout(()=>{r?(logger.log("[Podpis] Inicializuji canvas..."),function(t){if(!t)return;if(e&&e.canvas===t)return void e.clear();const o=t.getBoundingClientRect();t.width=o.width,t.height=o.height;const a=t.getContext("2d");a.fillStyle="white",a.fillRect(0,0,t.width,t.height),e={canvas:t,ctx:a,isDrawing:!1,lastX:0,lastY:0,clear:function(){this.ctx.fillStyle="white",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},isEmpty:function(){const e=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height).data;for(let t=0;t<e.length;t+=4)if(255!==e[t]||255!==e[t+1]||255!==e[t+2])return!1;return!0},toDataURL:function(){return this.canvas.toDataURL("image/png")}},a.strokeStyle="#000000",a.lineWidth=2,a.lineCap="round",a.lineJoin="round";const n=e=>{const o=t.getBoundingClientRect();return e.touches&&e.touches.length>0?{x:e.touches[0].clientX-o.left,y:e.touches[0].clientY-o.top}:{x:e.clientX-o.left,y:e.clientY-o.top}},l=t=>{t.preventDefault(),e.isDrawing=!0;const o=n(t);e.lastX=o.x,e.lastY=o.y},r=t=>{if(!e.isDrawing)return;t.preventDefault();const o=n(t);a.beginPath(),a.moveTo(e.lastX,e.lastY),a.lineTo(o.x,o.y),a.stroke(),e.lastX=o.x,e.lastY=o.y},i=()=>{e.isDrawing=!1};t.addEventListener("mousedown",l),t.addEventListener("mousemove",r),t.addEventListener("mouseup",i),t.addEventListener("mouseout",i),t.addEventListener("touchstart",l,{passive:!1}),t.addEventListener("touchmove",r,{passive:!1}),t.addEventListener("touchend",i),t.addEventListener("touchcancel",i)}(r)):logger.error("[Podpis] Canvas nenalezen!")},100)},i&&i.addEventListener("click",()=>{const e=document.getElementById("souhlasDilOverlay");logger.log("[Podpis] Kliknuto na NUTNO OBJEDNAT DÃL"),e&&(e.style.display="flex",logger.log("[Podpis] Modal souhlasu zobrazen"))}),s&&s.addEventListener("click",()=>{logger.log("[Podpis] Kliknuto na PODPIS"),window.zobrazitPodpisSekci("")}),c&&c.addEventListener("click",()=>{logger.log("[Podpis] Kliknuto na SOUHLASÃM"),window.zobrazitPodpisSekci("ZÃ¡kaznÃ­k souhlasÃ­ s prodlouÅ¾enÃ­m lhÅ¯ty pro vyÅ™Ã­zenÃ­ reklamace za ÃºÄelem objednÃ¡nÃ­ nÃ¡hradnÃ­ch dÃ­lÅ¯ od vÃ½robce. DodacÃ­ lhÅ¯ta dÃ­lÅ¯ je mimo kontrolu servisu a mÅ¯Å¾e se prodlouÅ¾it (orientaÄnÄ› 3â€“4 tÃ½dny, v krajnÃ­m pÅ™Ã­padÄ› i dÃ©le). Servis se zavazuje provÃ©st opravu bez zbyteÄnÃ©ho odkladu po doruÄenÃ­ dÃ­lÅ¯.");const e=document.getElementById("souhlasDilOverlay");e&&(e.style.display="none",logger.log("[Podpis] Modal souhlasu schovÃ¡n"))}),d&&d.addEventListener("click",()=>{logger.log("[Podpis] Kliknuto na NESOUHLASÃM"),window.zobrazitPodpisSekci("ZÃ¡kaznÃ­k nesouhlasÃ­ s prodlouÅ¾enÃ­m lhÅ¯ty za ÃºÄelem objednÃ¡nÃ­ dÃ­lu. Tento postoj je povaÅ¾ovÃ¡n za nespoluprÃ¡ci se servisem.");const e=document.getElementById("souhlasDilOverlay");e&&(e.style.display="none",logger.log("[Podpis] Modal souhlasu schovÃ¡n"))})})}();
//# sourceMappingURL=protokol.min.js.map