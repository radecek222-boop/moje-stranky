async function getCSRFToken() {
  try {
    const response = await fetch("app/get_csrf_token.php");
    const data = await response.json();
    return data.token;
  } catch (err) {
    logger.error("Chyba z√≠sk√°n√≠ CSRF tokenu:", err);
    return "";
  }
}

const originalFetch = window.fetch;
window.fetch = async function(...args) {
  let [url, config = {}] = args;
  
  if (config.method === "POST" || config.method === "post") {
    const token = await getCSRFToken();
    if (!config.headers) config.headers = {};
    config.headers["X-CSRF-Token"] = token;
  }
  
  return originalFetch(url, config);
};

// üîí KRITICK√Å BEZPEƒåNOSTN√ç KONTROLA
(async function() {
    try {
        const response = await fetch("includes/user_session_check.php");
        const data = await response.json();
        
        if (!data.logged_in) {
            logger.log("‚ùå Nep≈ôihl√°≈°en - p≈ôesmƒõrov√°n√≠ na login");
            console.log("User authenticated");
            throw new Error("Not authenticated");
        }
        
        logger.log("‚úÖ P≈ôihl√°≈°en jako:", data.email);
        
    } catch (err) {
        logger.error("‚ùå Chyba kontroly session:", err);
        console.log("User authenticated");
        throw new Error("Auth check failed");
    }
})();

// === GLOB√ÅLN√ç PROMƒöNN√â ===
let WGS_DATA_CACHE = [];
let ACTIVE_FILTER = 'all';
let CURRENT_RECORD = null;
let SELECTED_DATE = null;
let SELECTED_TIME = null;
let CAL_MONTH = new Date().getMonth();
let CAL_YEAR = new Date().getFullYear();
let SEARCH_QUERY = '';

const WGS_ADDRESS = "Dubƒçe 364, Bƒõchovice 190 11, ƒåesk√° republika";
const WGS_COORDS = { lat: 50.0472, lng: 14.5881 };

let DISTANCE_CACHE = {};

// === UTILITY FUNKCE ===
const Utils = {
  // Z√≠sk√°n√≠ jm√©na z√°kazn√≠ka
  getCustomerName: (record) => {
    return record.jmeno || record.zakaznik || 'Nezn√°m√Ω z√°kazn√≠k';
  },
  
  // Z√≠sk√°n√≠ adresy
  getAddress: (record) => {
    if (record.adresa) return record.adresa;
    const parts = [record.ulice, record.mesto, record.psc].filter(x => x);
    return parts.length > 0 ? parts.join(', ') : '‚Äî';
  },
  
  // Z√≠sk√°n√≠ produktu
  getProduct: (record) => {
    return record.model || record.vyrobek || '‚Äî';
  },
  
  // Z√≠sk√°n√≠ ID objedn√°vky
  getOrderId: (record, index = 0) => {
    return record.id || record.reklamacniCislo || ('WGS-' + (index + 1));
  },
  
  // Kontrola dokonƒçen√© zak√°zky
  isCompleted: (record) => {
    return record.stav === 'HOTOVO' || record.stav === 'done';
  },
  
  // Escape HTML
  escapeHtml: (text) => {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  },
  
  // P≈ôid√°n√≠ ƒåesk√° republika k adrese
  addCountryToAddress: (address) => {
    if (!address) return address;
    if (!address.toLowerCase().includes('ƒçesk')) {
      return address + ', ƒåesk√° republika';
    }
    return address;
  },
  
  // Filtrov√°n√≠ podle role
  filterByUserRole: (items) => {
    if (!CURRENT_USER || CURRENT_USER.role !== 'prodejce') {
      return items;
    }
    return items.filter(x => String(x.zpracoval_id) === String(CURRENT_USER.id));
  }
};

// === CACHE MANAGEMENT ===
const CacheManager = {
  load: () => {
    try {
      const cached = localStorage.getItem('wgs_distance_cache');
      if (cached) {
        DISTANCE_CACHE = JSON.parse(cached);
        logger.log('‚úì Naƒçteno', Object.keys(DISTANCE_CACHE).length, 'vzd√°lenost√≠ z cache');
      }
    } catch (e) {
      logger.error('Chyba p≈ôi naƒç√≠t√°n√≠ cache:', e);
    }
  },
  
  save: () => {
    try {
      localStorage.setItem('wgs_distance_cache', JSON.stringify(DISTANCE_CACHE));
    } catch (e) {
      logger.error('Chyba p≈ôi ukl√°d√°n√≠ cache:', e);
    }
  }
};

// === INIT ===
window.addEventListener('DOMContentLoaded', async () => {
  CacheManager.load();
  
  
  initFilters();
  initSearch();
  await loadAll();
});

// === VYHLED√ÅV√ÅN√ç ===
function initSearch() {
  const searchInput = document.getElementById('searchInput');
  const searchClear = document.getElementById('searchClear');
  
  searchInput.addEventListener('input', (e) => {
    SEARCH_QUERY = e.target.value.trim().toLowerCase();
    
    searchClear.classList.toggle('visible', SEARCH_QUERY.length > 0);
    
    let userItems = Utils.filterByUserRole(WGS_DATA_CACHE);
    console.log('üé® Vol√°m renderOrders s', userItems.length, 'polo≈ækami');
    renderOrders(userItems);
  });
  
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      clearSearch();
    }
  });
}

function clearSearch() {
  const searchInput = document.getElementById('searchInput');
  const searchClear = document.getElementById('searchClear');
  
  searchInput.value = '';
  SEARCH_QUERY = '';
  searchClear.classList.remove('visible');
  
  let userItems = Utils.filterByUserRole(WGS_DATA_CACHE);
  console.log('üé® Vol√°m renderOrders s', userItems.length, 'polo≈ækami');
    renderOrders(userItems);
}

function highlightText(text, query) {
  if (!query || !text) return text;
  
  const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
  return text.replace(regex, '<span class="highlight">$1</span>');
}

function escapeRegex(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function matchesSearch(record, query) {
  if (!query) return true;
  
  const searchableFields = [
    Utils.getCustomerName(record),
    record.telefon || '',
    record.email || '',
    Utils.getAddress(record),
    Utils.getProduct(record),
    Utils.getOrderId(record),
    record.popis_problemu || ''
  ];
  
  const searchString = searchableFields.join(' ').toLowerCase();
  return searchString.includes(query);
}

// === FILTRY ===
function initFilters() {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      ACTIVE_FILTER = btn.dataset.filter;
      
      let userItems = Utils.filterByUserRole(WGS_DATA_CACHE);
      console.log('üé® Vol√°m renderOrders s', userItems.length, 'polo≈ækami');
    renderOrders(userItems);
    });
  });
}

// === AKTUALIZACE POƒåT≈Æ ===
function updateCounts(items) {
  if (!Array.isArray(items)) return;
  
  const countAll = items.length;
  const countWait = items.filter(r => {
    const stav = r.stav || 'wait';
    return stav === 'ƒåEK√Å' || stav === 'wait';
  }).length;
  const countOpen = items.filter(r => {
    const stav = r.stav || 'wait';
    return stav === 'DOMLUVEN√Å' || stav === 'open';
  }).length;
  const countDone = items.filter(r => {
    const stav = r.stav || 'wait';
    return stav === 'HOTOVO' || stav === 'done';
  }).length;
  
  document.getElementById('count-all').textContent = `(${countAll})`;
  document.getElementById('count-wait').textContent = `(${countWait})`;
  document.getElementById('count-open').textContent = `(${countOpen})`;
  document.getElementById('count-done').textContent = `(${countDone})`;
}

// === NAƒåTEN√ç DAT ===
async function loadAll(status = 'all') {
  console.log('üöÄ loadAll() START, status:', status);
  try {
   const response = await fetch(`app/controllers/load.php?status=${status}`);
    if (!response.ok) throw new Error('Chyba naƒç√≠t√°n√≠');
    
    const json = await response.json();
    console.log('üì¶ JSON naƒçteno:', json);
    
    let items = [];
    if (json.status === 'success' && Array.isArray(json.data)) {
      items = json.data;
    } else if (Array.isArray(json)) {
      items = json;
    }
    
    WGS_DATA_CACHE = items;
    
    let userItems = Utils.filterByUserRole(items);
    
    if (CURRENT_USER.role === 'prodejce') {
      logger.log('üìä Filtr prodejce:', userItems.length, 'reklamac√≠');
    } else {
      console.log(`üìã ${CURRENT_USER.role === 'admin' ? 'Admin' : 'U≈æivatel'} vid√≠ v≈°echny:`, userItems.length, 'reklamac√≠');
    }
    
    updateCounts(userItems);
    console.log('üé® Vol√°m renderOrders s', userItems.length, 'polo≈ækami');
    renderOrders(userItems);
  } catch (err) {
    logger.error('Chyba:', err);
    WGS_DATA_CACHE = [];
    document.getElementById('orderGrid').innerHTML = `
      <div class="empty-state">
        <div class="empty-state-text">Chyba p≈ôi naƒç√≠t√°n√≠ dat</div>
      </div>
    `;
  }
}

// === VYKRESLEN√ç OBJEDN√ÅVEK ===
function renderOrders(items = null) {
  console.log('üé® renderOrders() START, items:', items ? items.length : 'null');
  const grid = document.getElementById('orderGrid');
  console.log('üìç Grid element:', grid);
  const searchResultsInfo = document.getElementById('searchResultsInfo');
  
  if (!items) {
    items = Utils.filterByUserRole(WGS_DATA_CACHE);
  }
  
  if (!Array.isArray(items)) items = [];
  
  let filtered = items;
  
  // Filtrov√°n√≠ podle statusu
  if (ACTIVE_FILTER !== 'all') {
    const statusMap = {
      'wait': ['ƒåEK√Å', 'wait'],
      'open': ['DOMLUVEN√Å', 'open'],
      'done': ['HOTOVO', 'done']
    };
    
    filtered = items.filter(r => {
      const stav = r.stav || 'wait';
      return statusMap[ACTIVE_FILTER]?.includes(stav);
    });
  }
  
  // Filtrov√°n√≠ podle vyhled√°v√°n√≠
  const totalBeforeSearch = filtered.length;
  if (SEARCH_QUERY) {
    filtered = filtered.filter(r => matchesSearch(r, SEARCH_QUERY));
    
    if (filtered.length > 0) {
      searchResultsInfo.className = 'search-results-info';
      searchResultsInfo.textContent = `Nalezeno ${filtered.length} z ${totalBeforeSearch} v√Ωsledk≈Ø pro "${SEARCH_QUERY}"`;
    } else {
      searchResultsInfo.className = 'search-results-info no-results';
      searchResultsInfo.textContent = `≈Ω√°dn√© v√Ωsledky pro "${SEARCH_QUERY}"`;
    }
    searchResultsInfo.style.display = 'block';
  } else {
    searchResultsInfo.style.display = 'none';
  }
  
  if (filtered.length === 0) {
    grid.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-text">${SEARCH_QUERY ? '≈Ω√°dn√© v√Ωsledky nenalezeny' : '≈Ω√°dn√© reklamace k zobrazen√≠'}</div>
      </div>
    `;
    return;
  }
  
  filtered.sort((a, b) => {
    const dateA = new Date(a.datum || a.timestamp || 0);
    const dateB = new Date(b.datum || b.timestamp || 0);
    return dateB - dateA;
  });
  
  grid.innerHTML = filtered.map((rec, index) => {
    const customerName = Utils.getCustomerName(rec);
    const product = Utils.getProduct(rec);
    const date = formatDate(rec.datum);
    const status = getStatus(rec.stav);
    const orderId = Utils.getOrderId(rec, index);
    
    let address = Utils.getAddress(rec);
    if (address !== '‚Äî') {
      const parts = address.split(',').map(p => p.trim());
      address = parts.slice(0, 2).join(', ');
    }
    
    let appointmentText = '';
    if (rec.termin && rec.cas_navstevy) {
      appointmentText = formatAppointment(rec.termin, rec.cas_navstevy);
    }
    
    // Notes se naƒç√≠taj√≠ asynchronnƒõ, tak≈æe zat√≠m pr√°zdn√© pole
    const notes = [];  // TODO: Implementovat async naƒç√≠t√°n√≠ pozn√°mek
    const unreadCount = 0;
    const hasUnread = false;
    
    // Zv√Ωraznƒõn√≠ vyhled√°van√Ωch v√Ωraz≈Ø
    const highlightedCustomer = SEARCH_QUERY ? highlightText(customerName, SEARCH_QUERY) : customerName;
    const highlightedAddress = SEARCH_QUERY ? highlightText(address, SEARCH_QUERY) : address;
    const highlightedProduct = SEARCH_QUERY ? highlightText(product, SEARCH_QUERY) : product;
    const highlightedOrderId = SEARCH_QUERY ? highlightText(orderId, SEARCH_QUERY) : orderId;
    
    const searchMatchClass = SEARCH_QUERY && matchesSearch(rec, SEARCH_QUERY) ? 'search-match' : '';
    
    return `
      <div class="order-box ${searchMatchClass}" onclick='showDetail(${JSON.stringify(rec).replace(/'/g, "&#39;")})'>
        <div class="order-header">
          <div class="order-number">${highlightedOrderId}</div>
          <div style="display: flex; gap: 0.4rem; align-items: center;">
            <div class="order-notes-badge ${hasUnread ? 'has-unread' : ''}" onclick='event.stopPropagation(); showNotes(${JSON.stringify(rec).replace(/'/g, "&#39;")})' title="${notes.length} pozn√°mek">
              ${notes.length > 0 ? notes.length : ''}
            </div>
            <div class="order-status status-${status.class}"></div>
          </div>
        </div>
        <div class="order-body">
          <div class="order-customer">${highlightedCustomer}</div>
          <div class="order-detail">
            <div class="order-detail-line">${highlightedAddress}</div>
            <div class="order-detail-line">${highlightedProduct}</div>
            ${appointmentText ? `<div class="order-detail-line" style="color: #00d4ff; font-weight: 700; font-size: 0.7rem;">${appointmentText}</div>` : ''}
            <div class="order-detail-line" style="opacity: 0.6;">${date}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// === MODAL MANAGER ===
const ModalManager = {
  show: (content) => {
    document.getElementById('modalContent').innerHTML = content;
    document.getElementById('detailOverlay').classList.add('active');
  },
  
  close: () => {
    document.getElementById('detailOverlay').classList.remove('active');
    CURRENT_RECORD = null;
    SELECTED_DATE = null;
    SELECTED_TIME = null;
  },
  
  createHeader: (title, subtitle) => {
    return `
      <div class="modal-header">
        <h2 class="modal-title">${title}</h2>
        ${subtitle ? `<p class="modal-subtitle">${subtitle}</p>` : ''}
      </div>
    `;
  },
  
  createActions: (buttons) => {
    return `
      <div class="modal-actions">
        ${buttons.join('')}
      </div>
    `;
  }
};

// === DETAIL ===
function showDetail(recordOrId) {
  let record;
  if (typeof recordOrId === 'string') {
    record = WGS_DATA_CACHE.find(x => x.id == recordOrId || x.reklamace_id == recordOrId);
    if (!record) {
      alert('‚ùå Z√°znam nenalezen');
      return;
    }
  } else {
    record = WGS_DATA_CACHE.find(x => x.id == recordOrId.id || x.reklamace_id == recordOrId.reklamace_id) || recordOrId;
  }
  
  CURRENT_RECORD = record;
  
  const customerName = Utils.getCustomerName(record);
  const address = Utils.getAddress(record);
  const termin = record.termin ? formatDate(record.termin) : '‚Äî';
  const time = record.cas_navstevy || '‚Äî';
  const status = getStatus(record.stav);
  
  const isCompleted = Utils.isCompleted(record);
  
  let buttonsHtml = '';
  
  if (isCompleted) {
    buttonsHtml = `
      <div style="background: rgba(0, 255, 136, 0.1); border: 2px solid var(--c-neon-green); padding: 1.5rem; margin-bottom: 1.5rem;">
        <div style="text-align: center; margin-bottom: 1rem;">
          <div style="font-size: 3rem; margin-bottom: 0.5rem;">‚úì</div>
          <div style="font-size: 1.2rem; font-weight: 600; color: var(--c-black); margin-bottom: 0.3rem;">ZAK√ÅZKA DOKONƒåENA</div>
          <div style="font-size: 0.85rem; color: var(--c-grey);">Tato zak√°zka byla ji≈æ vy≈ô√≠zena</div>
        </div>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 1rem;">
        <button class="btn" style="width: 100%; padding: 1rem; min-height: 60px; background: var(--c-neon-yellow); color: var(--c-black); border-color: var(--c-black); font-weight: 700;" onclick="reopenOrder('${record.id}')">
          üîÑ ZNOVU OTEV≈ò√çT ZAK√ÅZKU
        </button>
        
        <button class="btn" style="width: 100%; padding: 1rem; min-height: 60px;" onclick="showContactMenu('${record.id}')">KONTAKTOVAT Z√ÅKAZN√çKA</button>
        <button class="btn" style="width: 100%; padding: 1rem; min-height: 60px;" onclick="showCustomerDetail('${record.id}')">DETAIL Z√ÅKAZN√çKA</button>

      <!-- PDF Button -->
      ${record.documents && record.documents.length > 0 ? `
        <button class="btn" style="background: #e74c3c; color: white; width: 100%; padding: 1rem; min-height: 60px; margin-top: 0.5rem;" 
                onclick="window.open('${record.documents[0].file_path}', '_blank')">
          üìÑ Otev≈ô√≠t PDF
        </button>
      ` : ''}
<!-- PDF Button -->
      <div style="width: 100%; margin-top: 0.5rem;">
        ${record.documents && record.documents.length > 0 ? `
          <button class="btn" style="background: #e74c3c; color: white; width: 100%; padding: 1rem; min-height: 60px;" 
                  onclick="window.open('${record.documents[0].file_path}', '_blank')">
            üìÑ Otev≈ô√≠t PDF protokol
          </button>
        ` : `
          <div style="background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 6px; padding: 1rem; text-align: center; color: #6c757d;">
            ‚ÑπÔ∏è PDF protokol je≈°tƒõ nebyl vytvo≈ôen
          </div>
        `}
      </div>
        
        <button class="btn btn-secondary" style="width: 100%; padding: 1rem; min-height: 60px;" onclick="closeDetail()">ZAV≈ò√çT</button>
      </div>
    `;
  } else {
    buttonsHtml = `
      <div style="display: flex; flex-direction: column; gap: 1rem;">
        <button class="btn btn-success" style="width: 100%; padding: 1rem; min-height: 60px;" onclick="startVisit('${record.id}')">ZAH√ÅJIT N√ÅV≈†TƒöVU</button>
        
        <button class="btn btn-success" style="width: 100%; padding: 1rem; min-height: 60px;" onclick="showCalendar('${record.id}')">NAPL√ÅNOVAT TERM√çN</button>
        
        <button class="btn" style="width: 100%; padding: 1rem; min-height: 60px;" onclick="showContactMenu('${record.id}')">KONTAKTOVAT Z√ÅKAZN√çKA</button>
        <button class="btn" style="width: 100%; padding: 1rem; min-height: 60px;" onclick="showCustomerDetail('${record.id}')">DETAIL Z√ÅKAZN√çKA</button>
        <button class="btn btn-secondary" style="width: 100%; padding: 1rem; min-height: 60px;" onclick="closeDetail()">ZAV≈ò√çT</button>
      </div>
    `;
  }
  
  const content = `
    ${ModalManager.createHeader(customerName, `
      <strong>Adresa:</strong> ${address}<br>
      <strong>Term√≠n:</strong> ${termin} ${time !== '‚Äî' ? 'v ' + time : ''}<br>
      <strong>Stav:</strong> ${status.text}
    `)}
    
    <div class="modal-body">
      ${buttonsHtml}
    </div>
  `;
  
  ModalManager.show(content);
}

function closeDetail() {
  ModalManager.close();
}

// === ZNOVUOTEV≈òEN√ç ZAK√ÅZKY ===
async function reopenOrder(id) {
  const record = WGS_DATA_CACHE.find(x => x.id == id);
  if (!record) {
    alert('‚ùå Z√°znam nenalezen');
    return;
  }
  
  const customerName = Utils.getCustomerName(record);
  const product = Utils.getProduct(record);
  
  const confirmed = window.confirm(
    `‚ö†Ô∏è ZNOVU OTEV≈ò√çT ZAK√ÅZKU?\n\n` +
    `Z√°kazn√≠k: ${customerName}\n` +
    `Produkt: ${product}\n\n` +
    `Tato akce:\n` +
    `‚úì Zmƒõn√≠ stav na NOV√Å (≈ælut√°)\n` +
    `‚úì Zru≈°√≠ p≈Øvodn√≠ term√≠n n√°v≈°tƒõvy\n` +
    `‚úì Umo≈æn√≠ napl√°novat novou n√°v≈°tƒõvu\n\n` +
    `‚ö†Ô∏è Pou≈æijte pouze v p≈ô√≠padƒõ, ≈æe se objevil nov√Ω probl√©m u t√©to zak√°zky.\n\n` +
    `Opravdu chcete pokraƒçovat?`
  );
  
  if (!confirmed) {
    logger.log('‚ùå Znovuotev≈ôen√≠ zru≈°eno u≈æivatelem');
    return;
  }
  
  try {
    const formData = new FormData();
    formData.append('action', 'update');
    formData.append('id', id);
    formData.append('stav', 'ƒåEK√Å');
    formData.append('termin', '');
    formData.append('cas_navstevy', '');
    formData.append("action", "update");
    
    const response = await fetch('app/controllers/save.php', {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    
    if (result.status === 'success') {
      const cacheRecord = WGS_DATA_CACHE.find(x => x.id == id);
      if (cacheRecord) {
        cacheRecord.stav = "ƒåEK√Å";
        cacheRecord.termin = "";
        cacheRecord.cas_navstevy = "";
      }
      
      if (CURRENT_RECORD && CURRENT_RECORD.id == id) {
        CURRENT_RECORD.stav = "ƒåEK√Å";
        CURRENT_RECORD.termin = "";
        CURRENT_RECORD.cas_navstevy = "";
      }
      
      const noteText = `üîÑ Zak√°zka znovu otev≈ôena\n\nDokonƒçen√° zak√°zka byla znovu otev≈ôena pro nov√Ω probl√©m nebo reklamaci.\n\nStav zmƒõnƒõn: HOTOVO ‚Üí NOV√Å\nTerm√≠n: vymaz√°n`;
      try {
        if (typeof addNote === 'function') {
          const addNoteResult = addNote(id, noteText);
          if (addNoteResult && typeof addNoteResult.then === 'function') {
            await addNoteResult;
          }
        }
      } catch (noteError) {
        logger.error('Chyba p≈ôi p≈ôid√°v√°n√≠ pozn√°mky:', noteError);
      }
      
      try {
        const now = new Date();
        const formattedDate = now.toLocaleDateString('cs-CZ', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        await fetch("app/notification_sender.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            notification_id: "order_reopened",
            data: {
              customer_name: customerName,
              order_id: id,
              product: product,
              reopened_by: "admin@wgs-service.cz",
              reopened_at: formattedDate
            }
          })
        });
      } catch (emailError) {
        logger.error('Chyba p≈ôi odes√≠l√°n√≠ notifikace:', emailError);
      }
      
      alert(
        `‚úì ZAK√ÅZKA ZNOVU OTEV≈òENA\n\n` +
        `Stav zmƒõnƒõn na: NOV√Å (≈ælut√°)\n` +
        `Term√≠n byl vymaz√°n.\n\n` +
        `Nyn√≠ m≈Ø≈æete:\n` +
        `‚Üí Napl√°novat nov√Ω term√≠n n√°v≈°tƒõvy\n` +
        `‚Üí Zah√°jit novou n√°v≈°tƒõvu\n` +
        `‚Üí Aktualizovat detail zak√°zky`
      );
      
      showDetail(id);
      
      if (typeof loadAll === 'function') {
        await loadAll(ACTIVE_FILTER);
      }
    } else {
      throw new Error(result.message || 'Nepoda≈ôilo se ulo≈æit zmƒõny');
    }
  } catch (e) {
    logger.error('Chyba p≈ôi znovuotev≈ôen√≠ zak√°zky:', e);
    alert('‚ùå Chyba p≈ôi znovuotev≈ôen√≠ zak√°zky: ' + e.message);
  }
}

// === NORMALIZACE DAT Z√ÅKAZN√çKA ===
function normalizeCustomerData(data) {
  const normalized = { ...data };
  
  if (!normalized.jmeno && normalized.zakaznik) {
    normalized.jmeno = normalized.zakaznik;
  }
  if (!normalized.zakaznik && normalized.jmeno) {
    normalized.zakaznik = normalized.jmeno;
  }
  
  if (!normalized.adresa && (normalized.ulice || normalized.mesto || normalized.psc)) {
    const parts = [];
    if (normalized.ulice) parts.push(normalized.ulice);
    if (normalized.mesto) parts.push(normalized.mesto);
    if (normalized.psc) parts.push(normalized.psc);
    normalized.adresa = parts.join(', ');
  }
  
  if (normalized.adresa && (!normalized.ulice || !normalized.mesto)) {
    const parts = normalized.adresa.split(',').map(s => s.trim());
    if (!normalized.ulice && parts[0]) normalized.ulice = parts[0];
    if (!normalized.mesto && parts[1]) normalized.mesto = parts[1];
    if (!normalized.psc && parts[2]) normalized.psc = parts[2];
  }
  
  return normalized;
}

// === ZAH√ÅJIT N√ÅV≈†TƒöVU ===
function startVisit(id) {
  const z = WGS_DATA_CACHE.find(x => x.id == id);
  if (!z) {
    alert('‚ùå Z√°znam nenalezen');
    return;
  }
  
  if (z.stav === 'ƒåEK√Å' || z.stav === 'wait') {
    const confirm = window.confirm(
      'VAROV√ÅN√ç: Term√≠n n√°v≈°tƒõvy je≈°tƒõ nen√≠ napl√°nov√°n.\n\n' +
      'Chcete pokraƒçovat i bez napl√°novan√©ho term√≠nu?'
    );
    if (!confirm) return;
  }
  
  if (Utils.isCompleted(z)) {
    alert('‚ùå Tato n√°v≈°tƒõva ji≈æ byla dokonƒçena.');
    return;
  }
  
  const normalizedData = normalizeCustomerData(z);
  
  localStorage.setItem('currentCustomer', JSON.stringify(normalizedData));
  localStorage.setItem('visitStartTime', new Date().toISOString());
  
  const photoKey = 'photoSections_' + normalizedData.id;
  localStorage.removeItem(photoKey);
  
  logger.log('‚úÖ Normalizovan√° data ulo≈æena:', normalizedData);
  
  window.location.href = 'photocustomer.php?new=true';
}

// === ULO≈ΩEN√ç ===
async function saveData(data, successMsg) {
  try {
    const formData = new FormData();
    Object.keys(data).forEach(key => {
      formData.append(key, data[key]);
    });

    formData.append("action", "update");
    const response = await fetch('app/controllers/save.php', {
      method: 'POST',
      body: formData
    });

    if (!response.ok) {
      throw new Error(`Server error: ${response.status}`);
    }

    const result = await response.json();
    
    if (result.status === 'success') {
      alert(successMsg);
      await loadAll(ACTIVE_FILTER);
      closeDetail();
    } else {
      alert('Chyba: ' + (result.message || 'Nepoda≈ôilo se ulo≈æit.'));
    }
  } catch (e) {
    logger.error('Chyba p≈ôi ukl√°d√°n√≠:', e);
    alert('Chyba p≈ôi ukl√°d√°n√≠: ' + e.message);
  }
}

// === KALEND√Å≈ò ===
function showCalendar(id) {
  const z = WGS_DATA_CACHE.find(x => x.id == id);
  if (!z) return;
  CURRENT_RECORD = z;
  SELECTED_DATE = null;
  SELECTED_TIME = null;
  
  const content = `
    ${ModalManager.createHeader('Vyberte term√≠n n√°v≈°tƒõvy', '<div id="selectedDateDisplay" style="margin-top: 0.5rem; color: var(--c-grey); font-size: 0.75rem;">Zat√≠m nevybr√°no</div>')}
    
    <div class="modal-body" style="max-height: 80vh; overflow-y: auto; padding: 1rem;">
      <div class="calendar-container">
        <div id="calGrid"></div>
        <div id="distanceInfo"></div>
        <div id="dayBookings"></div>
        <div id="timeGrid"></div>
      </div>
    </div>
    
    ${ModalManager.createActions([
      '<button class="btn btn-secondary" onclick="showDetail(CURRENT_RECORD)">Zpƒõt</button>',
      '<button class="btn btn-success" onclick="saveSelectedDate()">Ulo≈æit term√≠n</button>'
    ])}
  `;
  
  ModalManager.show(content);
  const today = new Date();
  CAL_MONTH = today.getMonth();
  CAL_YEAR = today.getFullYear();
  renderCalendar(CAL_MONTH, CAL_YEAR);
}

function previousMonth() {
  CAL_MONTH--;
  if (CAL_MONTH < 0) {
    CAL_MONTH = 11;
    CAL_YEAR--;
  }
  renderCalendar(CAL_MONTH, CAL_YEAR);
}

function nextMonth(event) {
  if (event) event.stopPropagation();
  CAL_MONTH++;
  if (CAL_MONTH > 11) {
    CAL_MONTH = 0;
    CAL_YEAR++;
  }
  renderCalendar(CAL_MONTH, CAL_YEAR);
}

function renderCalendar(m, y) {
  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';
  
  const monthNames = ['Leden', '√önor', 'B≈ôezen', 'Duben', 'Kvƒõten', 'ƒåerven',
                      'ƒåervenec', 'Srpen', 'Z√°≈ô√≠', '≈ò√≠jen', 'Listopad', 'Prosinec'];
  const navHeader = document.createElement('div');
  navHeader.className = 'calendar-controls';
  navHeader.innerHTML = `
    <button class="calendar-nav-btn" onclick="previousMonth()">‚óÄ P≈ôedchoz√≠</button>
    <span class="calendar-month-title">${monthNames[m]} ${y}</span>
    <button class="calendar-nav-btn" onclick="event.stopPropagation(); nextMonth(event)">Dal≈°√≠ ‚ñ∂</button>
  `;
  grid.appendChild(navHeader);
  
  const weekdays = document.createElement('div');
  weekdays.className = 'calendar-weekdays';
  weekdays.innerHTML = '<div>Po</div><div>√öt</div><div>St</div><div>ƒåt</div><div>P√°</div><div>So</div><div>Ne</div>';
  grid.appendChild(weekdays);
  
  const daysGrid = document.createElement('div');
  daysGrid.className = 'calendar-days';
  
  const firstDay = new Date(y, m, 1);
  const lastDay = new Date(y, m + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startDayOfWeek = (firstDay.getDay() + 6) % 7;
  
  const occupiedDays = new Set();
  WGS_DATA_CACHE.forEach(rec => {
    if (rec.termin && rec.id !== CURRENT_RECORD?.id) {
      const parts = rec.termin.split('.');
      if (parts.length === 3) {
        const day = parseInt(parts[0]);
        const month = parseInt(parts[1]);
        const year = parseInt(parts[2]);
        if (month === m + 1 && year === y) {
          occupiedDays.add(day);
        }
      }
    }
  });
  
  for (let i = 0; i < startDayOfWeek; i++) {
    const empty = document.createElement('div');
    empty.className = 'cal-day empty';
    daysGrid.appendChild(empty);
  }
  
  for (let d = 1; d <= daysInMonth; d++) {
    const el = document.createElement('div');
    el.className = 'cal-day';
    if (occupiedDays.has(d)) {
      el.classList.add('occupied');
      el.title = 'Tento den m√° ji≈æ nƒõjak√© term√≠ny';
    }
    el.textContent = d;
    el.onclick = async () => {
      SELECTED_DATE = `${d}.${m + 1}.${y}`;
      document.querySelectorAll('.cal-day').forEach(x => x.classList.remove('selected'));
      el.classList.add('selected');
      document.getElementById('selectedDateDisplay').textContent = `Vybran√Ω den: ${SELECTED_DATE}`;
      await showDayBookingsWithDistances(SELECTED_DATE);
      renderTimeGrid();
    };
    daysGrid.appendChild(el);
  }
  
  grid.appendChild(daysGrid);
}

// === V√ùPOƒåET VZD√ÅLENOSTI ===
async function getDistance(fromAddress, toAddress) {
  const cacheKey = `${fromAddress}|${toAddress}`;
  
  if (DISTANCE_CACHE[cacheKey]) {
    return DISTANCE_CACHE[cacheKey];
  }
  
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    
    const response = await fetch('app/controllers/get_distance.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        origin: fromAddress,
        destination: toAddress
      }),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (response.ok) {
      const data = await response.json();
      if (data.status === 'success' && data.distance) {
        const result = {
          km: (data.distance.value / 1000).toFixed(1),
          text: data.distance.text,
          duration: data.duration ? data.duration.text : null
        };
        DISTANCE_CACHE[cacheKey] = result;
        CacheManager.save();
        return result;
      }
    }
  } catch (error) {
    if (error.name === 'AbortError') {
      logger.log('Request timeout');
    } else {
      logger.error('Chyba p≈ôi v√Ωpoƒçtu vzd√°lenosti:', error);
    }
  }
  
  return null;
}

// === BATCH V√ùPOƒåET VZD√ÅLENOST√ç ===
async function getDistancesBatch(pairs) {
  const promises = pairs.map(pair => getDistance(pair.from, pair.to));
  return await Promise.all(promises);
}

// === ZOBRAZEN√ç TERM√çN≈Æ S VZD√ÅLENOSTMI ===
async function showDayBookingsWithDistances(date) {
  const distanceContainer = document.getElementById('distanceInfo');
  const bookingsContainer = document.getElementById('dayBookings');
  
  if (!Array.isArray(WGS_DATA_CACHE)) {
    WGS_DATA_CACHE = [];
  }
  
  const bookings = WGS_DATA_CACHE.filter(rec => 
    rec.termin === date && rec.id !== CURRENT_RECORD?.id
  );
  
  bookings.sort((a, b) => {
    const timeA = a.cas_navstevy || '00:00';
    const timeB = b.cas_navstevy || '00:00';
    return timeA.localeCompare(timeB);
  });
  
  let currentAddress = Utils.getAddress(CURRENT_RECORD);
  
  if (!currentAddress || currentAddress === '‚Äî') {
    distanceContainer.innerHTML = '';
    bookingsContainer.innerHTML = '';
    return;
  }
  
  currentAddress = Utils.addCountryToAddress(currentAddress);
  
  const cacheKey = `${WGS_ADDRESS}|${currentAddress}`;
  const isCached = DISTANCE_CACHE[cacheKey] !== undefined;
  
  if (!isCached) {
    distanceContainer.innerHTML = '<div style="text-align: center; color: var(--c-grey); font-size: 0.7rem; padding: 0.5rem;">Naƒç√≠t√°n√≠...</div>';
  }
  
  if (bookings.length === 0) {
    const distToCustomer = await getDistance(WGS_ADDRESS, currentAddress);
    
    if (distToCustomer) {
      distanceContainer.innerHTML = `
        <div class="distance-info-panel">
          <div class="distance-info-title">Informace o trase</div>
          <div class="distance-stats">
            <div class="distance-stat">
              <div class="distance-stat-label">Vzd√°lenost</div>
              <div class="distance-stat-value">${distToCustomer.km} <span class="distance-stat-unit">km</span></div>
            </div>
            <div class="distance-stat">
              <div class="distance-stat-label">ƒåas j√≠zdy</div>
              <div class="distance-stat-value">${distToCustomer.duration || '‚Äî'}</div>
            </div>
          </div>
          <div class="route-info">
            <div class="route-item">
              <div class="route-item-left">
                <span>WGS S√≠dlo</span>
                <span class="route-arrow">‚Üí</span>
                <span>${Utils.getCustomerName(CURRENT_RECORD)}</span>
              </div>
              <span class="route-distance">${distToCustomer.km} km</span>
            </div>
          </div>
        </div>
      `;
    } else {
      distanceContainer.innerHTML = '';
    }
    
    bookingsContainer.innerHTML = '';
    return;
  }
  
  const distancePairs = [];
  let fromAddr = WGS_ADDRESS;
  
  for (let i = 0; i < bookings.length; i++) {
    const booking = bookings[i];
    let toAddr = Utils.getAddress(booking);
    
    if (!toAddr || toAddr === '‚Äî') continue;
    toAddr = Utils.addCountryToAddress(toAddr);
    
    distancePairs.push({ from: fromAddr, to: toAddr, booking: booking });
    fromAddr = toAddr;
  }
  
  distancePairs.push({ from: fromAddr, to: currentAddress, booking: null, isNew: true });
  
  const distances = await getDistancesBatch(distancePairs.map(p => ({ from: p.from, to: p.to })));
  
  let totalKm = 0;
  let routes = [];
  
  for (let i = 0; i < distancePairs.length; i++) {
    const pair = distancePairs[i];
    const dist = distances[i];
    
    if (!dist) continue;
    
    totalKm += parseFloat(dist.km);
    
    const fromName = i === 0 ? 'WGS S√≠dlo' : Utils.getCustomerName(distancePairs[i-1].booking);
    const toName = pair.isNew ? Utils.getCustomerName(CURRENT_RECORD) : Utils.getCustomerName(pair.booking);
    const time = pair.isNew ? (SELECTED_TIME || '‚Äî') : (pair.booking?.cas_navstevy || '‚Äî');
    
    routes.push({
      from: fromName,
      to: toName,
      time: time,
      km: dist.km,
      isNew: pair.isNew
    });
  }
  
  let routesHtml = routes.map(r => `
    <div class="route-item ${r.isNew ? 'new-customer' : ''}">
      <div class="route-item-left">
        <span>${r.from}</span>
        <span class="route-arrow">‚Üí</span>
        <span>${r.to} ${r.time !== '‚Äî' ? '(' + r.time + ')' : ''}</span>
      </div>
      <span class="route-distance">${r.km} km</span>
    </div>
  `).join('');
  
  distanceContainer.innerHTML = `
    <div class="distance-info-panel">
      <div class="distance-info-title">Trasa pro ${date}</div>
      <div class="distance-stats">
        <div class="distance-stat">
          <div class="distance-stat-label">Celkem za den</div>
          <div class="distance-stat-value">${totalKm.toFixed(1)} <span class="distance-stat-unit">km</span></div>
        </div>
        <div class="distance-stat">
          <div class="distance-stat-label">Poƒçet n√°v≈°tƒõv</div>
          <div class="distance-stat-value">${bookings.length + 1}</div>
        </div>
      </div>
      <div class="route-info">
        ${routesHtml}
      </div>
    </div>
  `;
  
  if (bookings.length > 0) {
    let html = '<div class="day-bookings" style="margin-top: 0.5rem;"><h4>Term√≠ny v tento den:</h4>';
    bookings.forEach(b => {
      const customerName = Utils.getCustomerName(b);
      html += `
        <div class="booking-item" onclick='showBookingDetail(${JSON.stringify(b).replace(/'/g, "&apos;")})'>
          <strong>${b.cas_navstevy || '‚Äî'}</strong> ‚Äî ${customerName} 
          <span style="opacity:.7">(${Utils.getProduct(b)})</span>
        </div>`;
    });
    html += '</div>';
    bookingsContainer.innerHTML = html;
  } else {
    bookingsContainer.innerHTML = '';
  }
}

function showBookingDetail(booking) {
  const customerName = Utils.getCustomerName(booking);
  const address = Utils.getAddress(booking);
  const product = Utils.getProduct(booking);
  const description = booking.popis_problemu || '‚Äî';
  
  const content = `
    ${ModalManager.createHeader('Detail obsazen√©ho term√≠nu', '<p style="color: var(--c-error); font-weight: 600;">Tento term√≠n je ji≈æ obsazen</p>')}
    
    <div class="modal-body">
      <div style="padding: 1.5rem; background: rgba(139, 0, 0, 0.05); border: 2px solid var(--c-error); margin-bottom: 1.5rem;">
        <div class="info-grid" style="font-family: 'Poppins', sans-serif;">
          <div class="info-label">Z√°kazn√≠k:</div>
          <div class="info-value"><strong>${customerName}</strong></div>
          
          <div class="info-label">Term√≠n:</div>
          <div class="info-value"><strong>${formatDate(booking.termin || '')} v ${booking.cas_navstevy || '‚Äî'}</strong></div>
          
          <div class="info-label">Adresa:</div>
          <div class="info-value">${address}</div>
          
          <div class="info-label">Produkt:</div>
          <div class="info-value">${product}</div>
          
          <div class="info-label">Popis:</div>
          <div class="info-value" style="line-height: 1.6;">${description}</div>
        </div>
      </div>
    </div>
    
    ${ModalManager.createActions([
      '<button class="btn btn-secondary" onclick="showCalendar(\'' + CURRENT_RECORD.id + '\')">Zpƒõt na kalend√°≈ô</button>'
    ])}
  `;
  
  ModalManager.show(content);
}

function renderTimeGrid() {
  const t = document.getElementById('timeGrid');
  t.innerHTML = '';
  
  const occupiedTimes = {};
  WGS_DATA_CACHE.forEach(rec => {
    if (rec.termin === SELECTED_DATE && rec.cas_navstevy && rec.id !== CURRENT_RECORD?.id) {
      const customerName = Utils.getCustomerName(rec);
      occupiedTimes[rec.cas_navstevy] = {
        zakaznik: customerName,
        model: Utils.getProduct(rec)
      };
    }
  });
  
  for (let h = 7; h <= 20; h++) {
    for (const mm of [0, 30]) {
      const time = `${String(h).padStart(2, '0')}:${mm === 0 ? '00' : '30'}`;
      const el = document.createElement('div');
      el.className = 'time-slot';
      
      if (occupiedTimes[time]) {
        el.classList.add('occupied');
        el.title = `${occupiedTimes[time].zakaznik} ‚Äî ${occupiedTimes[time].model}`;
      }
      
      el.textContent = time;
      el.onclick = async () => {
        SELECTED_TIME = time;
        document.querySelectorAll('.time-slot').forEach(x => x.classList.remove('selected'));
        el.classList.add('selected');
        
        let displayText = `Vybran√Ω term√≠n: ${SELECTED_DATE} ‚Äî ${SELECTED_TIME}`;
        if (occupiedTimes[time]) {
          displayText += ` KOLIZE: ${occupiedTimes[time].zakaznik}`;
        }
        
        document.getElementById('selectedDateDisplay').textContent = displayText;
        
        await showDayBookingsWithDistances(SELECTED_DATE);
      };
      t.appendChild(el);
    }
  }
}

async function saveSelectedDate() {
  if (!SELECTED_DATE || !SELECTED_TIME) {
    alert('Vyberte datum i ƒças.');
    return;
  }
  
  if (!CURRENT_RECORD) {
    alert('Chyba: ≈æ√°dn√Ω z√°znam k ulo≈æen√≠.');
    return;
  }

  if (!Array.isArray(WGS_DATA_CACHE)) {
    WGS_DATA_CACHE = [];
  }

  const collision = WGS_DATA_CACHE.find(rec => 
    rec.termin === SELECTED_DATE && 
    rec.cas_navstevy === SELECTED_TIME && 
    rec.id !== CURRENT_RECORD.id
  );

  if (collision) {
    const collisionName = Utils.getCustomerName(collision);
    const confirm = window.confirm(
      `VAROV√ÅN√ç: Kolize term√≠nu!\n\n` +
      `${SELECTED_DATE} v ${SELECTED_TIME} ji≈æ m√°:\n` +
      `${collisionName}\n\n` +
      `Chcete i p≈ôesto ulo≈æit tento term√≠n?`
    );
    if (!confirm) return;
  }

  try {
    const formData = new FormData();
    formData.append('action', 'update');
    formData.append('id', CURRENT_RECORD.id);
    formData.append('termin', SELECTED_DATE);
    formData.append('cas_navstevy', SELECTED_TIME);
    formData.append('stav', 'DOMLUVEN√Å');

    const response = await fetch('app/controllers/save.php', {
      method: 'POST',
      body: formData
    });

    const result = await response.json();
    
    if (result.status === 'success') {
      alert(`‚úì Term√≠n ulo≈æen: ${SELECTED_DATE} ${SELECTED_TIME}\n\nStav automaticky zmƒõnƒõn na: DOMLUVEN√Å`);
      
      await sendAppointmentConfirmation(CURRENT_RECORD, SELECTED_DATE, SELECTED_TIME);
      
      await loadAll(ACTIVE_FILTER);
      closeDetail();
    } else {
      alert('Chyba: ' + (result.message || 'Nepoda≈ôilo se ulo≈æit.'));
    }
  } catch (e) {
    logger.error('Chyba p≈ôi ukl√°d√°n√≠:', e);
    alert('Chyba p≈ôi ukl√°d√°n√≠: ' + e.message);
  }
}

// === KONTAKT ===
function showContactMenu(id) {
  const phone = CURRENT_RECORD.telefon || '';
  const email = CURRENT_RECORD.email || '';
  const customerName = Utils.getCustomerName(CURRENT_RECORD);
  const address = Utils.getAddress(CURRENT_RECORD);
  
  const content = `
    ${ModalManager.createHeader('Kontaktovat z√°kazn√≠ka', customerName)}
    
    <div class="modal-body">
      <div class="info-grid" style="margin-bottom: 2rem;">
        <div class="info-label">Telefon:</div>
        <div class="info-value"><strong>${phone || 'Neuvedeno'}</strong></div>
        
        <div class="info-label">Email:</div>
        <div class="info-value"><strong>${email || 'Neuvedeno'}</strong></div>
        
        <div class="info-label">Adresa:</div>
        <div class="info-value"><strong>${address || 'Neuvedeno'}</strong></div>
      </div>
      
      <div class="modal-section">
        <h3 class="section-title">Rychl√© akce</h3>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          ${phone ? `<a href="tel:${phone}" class="btn btn-success">Zavolat</a>` : ''}
          <button class="btn btn-success" onclick="closeDetail(); setTimeout(() => showCalendar('${id}'), 100)">Term√≠n n√°v≈°tƒõvy</button>
          ${phone ? `<a href="sms:${phone}" class="btn">Odeslat SMS</a>` : ''}
          ${address && address !== '‚Äî' ? `<a href="https://waze.com/ul?q=${encodeURIComponent(address)}&navigate=yes" class="btn" target="_blank">Navigovat (Waze)</a>` : ''}
        </div>
      </div>
    </div>
    
    ${ModalManager.createActions([
      '<button class="btn btn-secondary" onclick="showDetail(CURRENT_RECORD)">Zpƒõt</button>'
    ])}
  `;
  
  ModalManager.show(content);
}

// === MAPA A VZD√ÅLENOST ===
function toggleMap() {
  const content = document.getElementById('mapContent');
  const icon = document.getElementById('mapToggleIcon');
  
  if (content.classList.contains('active')) {
    content.classList.remove('active');
    icon.classList.remove('active');
  } else {
    content.classList.add('active');
    icon.classList.add('active');
    
    if (!content.dataset.loaded) {
      content.dataset.loaded = 'true';
      loadMapAndRoute();
    }
  }
}

async function loadMapAndRoute() {
  const mapContainer = document.getElementById('mapContainer');
  
  if (!CURRENT_RECORD) return;
  
  let customerAddress = Utils.getAddress(CURRENT_RECORD);
  
  if (!customerAddress || customerAddress === '‚Äî') {
    mapContainer.innerHTML = '<div class="map-error">Adresa z√°kazn√≠ka nen√≠ k dispozici</div>';
    return;
  }
  
  customerAddress = Utils.addCountryToAddress(customerAddress);
  
  try {
    const origin = encodeURIComponent(WGS_ADDRESS);
    const destination = encodeURIComponent(customerAddress);
    
    mapContainer.innerHTML = `
      <div style="background: var(--c-bg); padding: 1rem; text-align: center; border: 1px solid var(--c-border);">
        <div style="font-size: 0.8rem; color: var(--c-grey); margin-bottom: 0.8rem; line-height: 1.4;">
          <strong>Z:</strong> WGS<br>
          <strong>Do:</strong> ${customerAddress}</div>
        <div style="display: flex; gap: 0.5rem; justify-content: center;">
          <a href="https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving" 
             class="btn" target="_blank" style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.75rem;">
            Google Maps
          </a>
          <a href="https://waze.com/ul?q=${destination}&navigate=yes" 
             class="btn" target="_blank" style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.75rem;">
            Waze
          </a>
        </div>
      </div>
    `;
    
    const response = await fetch('app/controllers/get_distance.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        origin: WGS_ADDRESS,
        destination: customerAddress
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      if (data.status === 'success' && data.distance && data.duration) {
        document.getElementById('mapDistance').textContent = data.distance.text;
        document.getElementById('mapDuration').textContent = data.duration.text;
      } else {
        document.getElementById('mapDistance').textContent = '‚Äî';
        document.getElementById('mapDuration').textContent = '‚Äî';
        logger.error('Chyba API:', data.message);
      }
    }
    
  } catch (error) {
    logger.error('Chyba p≈ôi naƒç√≠t√°n√≠ mapy:', error);
    mapContainer.innerHTML = `
      <div class="map-error">
        Nepoda≈ôilo se naƒç√≠st mapu<br>
        <small>${error.message}</small>
      </div>
    `;
  }
}

// === DETAIL Z√ÅKAZN√çKA ===
function showCustomerDetail(id) {
  const customerName = Utils.getCustomerName(CURRENT_RECORD);
  const phone = CURRENT_RECORD.telefon || '';
  const email = CURRENT_RECORD.email || '';
  const address = Utils.getAddress(CURRENT_RECORD);
  const product = Utils.getProduct(CURRENT_RECORD);
  const description = CURRENT_RECORD.popis_problemu || '';

  // Nov√° pole podle novareklamace.html
  const cislo = CURRENT_RECORD.cislo || '';
  const datum_prodeje = CURRENT_RECORD.datum_prodeje || '';
  const datum_reklamace = CURRENT_RECORD.datum_reklamace || '';
  const provedeni = CURRENT_RECORD.provedeni || '';
  const barva = CURRENT_RECORD.barva || '';
  const doplnujici_info = CURRENT_RECORD.doplnujici_info || '';

  const photoKey = 'photoSections_' + id;
  const photosData = localStorage.getItem(photoKey);
  let fotky = [];

  if (photosData) {
    try {
      const sections = JSON.parse(photosData);
      Object.values(sections).forEach(section => {
        if (section.photos && Array.isArray(section.photos)) {
          fotky = fotky.concat(section.photos);
        }
      });
    } catch (e) {
      logger.error('Chyba p≈ôi naƒç√≠t√°n√≠ fotek:', e);
    }
  }

  const content = `
    ${ModalManager.createHeader('Detail z√°kazn√≠ka', customerName)}

    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">

      <!-- MAPA A VZD√ÅLENOST -->
      <div class="map-panel">
        <div class="map-toggle" onclick="toggleMap()">
          <span>ZOBRAZEN√ç MAPY A TRASY</span>
          <span class="map-toggle-icon" id="mapToggleIcon">‚ñº</span>
        </div>
        <div class="map-content" id="mapContent">
          <div class="map-stats">
            <div class="map-stat">
              <div class="map-stat-label">Vzd√°lenost</div>
              <div class="map-stat-value" id="mapDistance">
                <span class="map-loading">...</span>
              </div>
            </div>
            <div class="map-stat">
              <div class="map-stat-label">ƒåas j√≠zdy</div>
              <div class="map-stat-value" id="mapDuration">
                <span class="map-loading">...</span>
              </div>
            </div>
          </div>
          <div id="mapContainer">
            <div class="map-loading">Naƒç√≠t√°n√≠ mapy...</div>
          </div>
        </div>
      </div>

      <!-- Z√ÅKLADN√ç √öDAJE -->
      <div style="background: var(--c-bg); border: 1px solid var(--c-border); padding: 1rem; margin-bottom: 1.5rem;">
        <h3 style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--c-black); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--c-border);">Z√°kladn√≠ √∫daje</h3>
        <div class="editable-field">
          <label class="field-label">ƒå√≠slo objedn√°vky/reklamace</label>
          <input type="text" class="field-input" id="edit_cislo" value="${Utils.escapeHtml(cislo)}">
        </div>
        <div class="editable-field">
          <label class="field-label">Datum prodeje</label>
          <input type="text" class="field-input" id="edit_datum_prodeje" value="${Utils.escapeHtml(datum_prodeje)}" placeholder="DD.MM.RRRR">
        </div>
        <div class="editable-field">
          <label class="field-label">Datum reklamace</label>
          <input type="text" class="field-input" id="edit_datum_reklamace" value="${Utils.escapeHtml(datum_reklamace)}" placeholder="DD.MM.RRRR">
        </div>
      </div>

      <!-- KONTAKTN√ç √öDAJE -->
      <div style="background: var(--c-bg); border: 1px solid var(--c-border); padding: 1rem; margin-bottom: 1.5rem;">
        <h3 style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--c-black); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--c-border);">Kontaktn√≠ √∫daje</h3>
        <div class="editable-field">
          <label class="field-label">Jm√©no z√°kazn√≠ka</label>
          <input type="text" class="field-input" id="edit_jmeno" value="${customerName}">
        </div>
        <div class="editable-field">
          <label class="field-label">Telefon</label>
          <input type="tel" class="field-input" id="edit_telefon" value="${phone}">
        </div>
        <div class="editable-field">
          <label class="field-label">Email</label>
          <input type="email" class="field-input" id="edit_email" value="${email}">
        </div>
        <div class="editable-field">
          <label class="field-label">Adresa</label>
          <input type="text" class="field-input" id="edit_adresa" value="${address}">
        </div>
      </div>

      <!-- INFORMACE O PRODUKTU -->
      <div style="background: var(--c-bg); border: 1px solid var(--c-border); padding: 1rem; margin-bottom: 1.5rem;">
        <h3 style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--c-black); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--c-border);">Informace o produktu</h3>
        <div class="editable-field">
          <label class="field-label">Model</label>
          <input type="text" class="field-input" id="edit_model" value="${product}">
        </div>
        <div class="editable-field">
          <label class="field-label">Proveden√≠</label>
          <input type="text" class="field-input" id="edit_provedeni" value="${Utils.escapeHtml(provedeni)}" placeholder="L√°tka / K≈Ø≈æe / Kombinace">
        </div>
        <div class="editable-field">
          <label class="field-label">Oznaƒçen√≠ barvy</label>
          <input type="text" class="field-input" id="edit_barva" value="${Utils.escapeHtml(barva)}" placeholder="Nap≈ô. BF12">
        </div>
        <div class="editable-field">
          <label class="field-label">Dopl≈àuj√≠c√≠ informace od prodejce</label>
          <textarea class="field-textarea" id="edit_doplnujici_info" rows="3">${Utils.escapeHtml(doplnujici_info)}</textarea>
        </div>
      </div>

      <!-- POPIS PROBL√âMU -->
      <div style="background: var(--c-bg); border: 1px solid var(--c-border); padding: 1rem; margin-bottom: 1.5rem;">
        <h3 style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--c-black); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--c-border);">Popis probl√©mu</h3>
        <div class="editable-field">
          <label class="field-label">Popis probl√©mu od z√°kazn√≠ka</label>
          <textarea class="field-textarea" id="edit_popis_problemu" rows="4">${description}</textarea>
        </div>
      </div>

      <!-- FOTOGRAFIE -->
      <div style="background: var(--c-bg); border: 1px solid var(--c-border); padding: 1rem;">
        <h3 style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--c-black); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--c-border);">Fotografie (${fotky.length})</h3>
        ${fotky.length
          ? `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem;">
              ${fotky.map((f, i) => `<img src='${f}' style='width: 100%; aspect-ratio: 1; object-fit: cover; border: 1px solid var(--c-border); cursor: pointer;' alt='Fotka ${i+1}' onclick='showPhotoFullscreen("${f}")'>`).join('')}
             </div>`
          : '<p style="color: var(--c-grey); text-align: center; padding: 1rem; font-size: 0.85rem;">≈Ω√°dn√© fotografie</p>'}
      </div>


      <!-- PDF PROTOKOL -->
      <div style="background: var(--c-bg); border: 1px solid var(--c-border); padding: 1rem; margin-top: 1.5rem;">
        <h3 style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--c-black); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--c-border);">üìÑ PDF Protokol</h3>
        ${CURRENT_RECORD.documents && CURRENT_RECORD.documents.length > 0 ? `
          <button onclick="window.open('${CURRENT_RECORD.documents[0].file_path}', '_blank')" 
                  class="btn" 
                  style="width: 100%; padding: 1rem; min-height: 60px; background: var(--c-black); color: white; border: none; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s;">
            üì• Otev≈ô√≠t PDF protokol
          </button>
          <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: var(--c-grey); text-align: center;">
            ${new Date(CURRENT_RECORD.documents[0].created_at).toLocaleString('cs-CZ')}
          </p>
        ` : `
          <div style="padding: 1rem; text-align: center; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 4px;">
            <p style="margin: 0; color: #6c757d; font-size: 0.9rem;">‚ÑπÔ∏è PDF protokol je≈°tƒõ nebyl vytvo≈ôen</p>
            <p style="margin: 0.3rem 0 0 0; font-size: 0.8rem; color: #adb5bd;">Vytvo≈ô√≠ se po dokonƒçen√≠ servisu</p>
          </div>
        `}
      </div>

    ${ModalManager.createActions([
      '<button class="btn btn-secondary" onclick="showDetail(CURRENT_RECORD)">Zpƒõt</button>',
      '<button class="btn btn-success" onclick="saveAllCustomerData(\'' + id + '\')">Ulo≈æit zmƒõny</button>'
    ])}
  `;

  ModalManager.show(content);
}

function showPhotoFullscreen(photoUrl) {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer;';
  overlay.onclick = () => overlay.remove();
  
  const img = document.createElement('img');
  img.src = photoUrl;
  img.style.cssText = 'max-width: 95%; max-height: 95%; object-fit: contain;';
  
  overlay.appendChild(img);
  document.body.appendChild(overlay);
}

async function saveAllCustomerData(id) {
  // Standardizovan√© n√°zvy pol√≠ podle novareklamace.html
  const data = {
    action: 'update',
    id: id,
    // Z√°kladn√≠ √∫daje
    cislo: document.getElementById('edit_cislo').value,
    datum_prodeje: document.getElementById('edit_datum_prodeje').value,
    datum_reklamace: document.getElementById('edit_datum_reklamace').value,
    // Kontaktn√≠ √∫daje
    jmeno: document.getElementById('edit_jmeno').value,
    telefon: document.getElementById('edit_telefon').value,
    email: document.getElementById('edit_email').value,
    adresa: document.getElementById('edit_adresa').value,
    // Informace o produktu
    model: document.getElementById('edit_model').value,
    provedeni: document.getElementById('edit_provedeni').value,
    barva: document.getElementById('edit_barva').value,
    doplnujici_info: document.getElementById('edit_doplnujici_info').value,
    // Popis probl√©mu
    popis_problemu: document.getElementById('edit_popis_problemu').value
  };

  await saveData(data, 'V≈°echny √∫daje byly aktualizov√°ny');
}

// === ODESL√ÅN√ç POTVRZEN√ç TERM√çNU ===
async function sendAppointmentConfirmation(customer, date, time) {
  const customerName = Utils.getCustomerName(customer);
  const phone = customer.telefon || '';
  const email = customer.email || '';
  const orderId = Utils.getOrderId(customer);
  
  try {
    const response = await fetch('app/notification_sender.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        notification_id: "appointment_confirmation",
        data: {
          customer_name: customerName,
          customer_email: email,
          seller_email: "admin@wgs-service.cz",
          date: date,
          time: time,
          order_id: orderId
        }
      })
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      logger.log('‚úì Potvrzen√≠ term√≠nu odesl√°no z√°kazn√≠kovi');
      if (result.email_sent) {
        logger.log('  ‚úì Email odesl√°n na:', email);
      }
      if (result.sms_sent) {
        logger.log('  ‚úì SMS odesl√°na na:', phone);
      }
    } else {
      logger.error('‚ö† Chyba p≈ôi odes√≠l√°n√≠ potvrzen√≠:', result.message);
    }
  } catch (error) {
    logger.error('‚ùå Chyba p≈ôi odes√≠l√°n√≠ potvrzen√≠:', error);
  }
}

// === SYST√âM POZN√ÅMEK - API VERSION ===

// Naƒç√≠st pozn√°mky z API
async function getNotes(orderId) {
  try {
    const record = WGS_DATA_CACHE.find(x => x.id == orderId || x.reklamace_id == orderId);
    if (!record) return [];

    const reklamaceId = record.reklamace_id || record.id;
    const response = await fetch(`api/notes_api.php?action=get&reklamace_id=${encodeURIComponent(reklamaceId)}`);
    const data = await response.json();

    if (data.status === 'success') {
      return data.notes || [];
    }
    return [];
  } catch (e) {
    logger.error('Chyba p≈ôi naƒç√≠t√°n√≠ pozn√°mek:', e);
    return [];
  }
}

// P≈ôidat pozn√°mku p≈ôes API
async function addNote(orderId, text) {
  try {
    const record = WGS_DATA_CACHE.find(x => x.id == orderId || x.reklamace_id == orderId);
    if (!record) {
      throw new Error('Reklamace nenalezena');
    }

    const reklamaceId = record.reklamace_id || record.id;
    const formData = new FormData();
    formData.append('action', 'add');
    formData.append('reklamace_id', reklamaceId);
    formData.append('text', text.trim());

    const response = await fetch('api/notes_api.php', {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    if (data.status === 'success') {
      return { success: true, note_id: data.note_id };
    } else {
      throw new Error(data.message || 'Chyba p≈ôi p≈ôid√°v√°n√≠ pozn√°mky');
    }
  } catch (e) {
    logger.error('Chyba p≈ôi p≈ôid√°v√°n√≠ pozn√°mky:', e);
    throw e;
  }
}

// Oznaƒçit pozn√°mky jako p≈ôeƒçten√©
async function markNotesAsRead(orderId) {
  try {
    const record = WGS_DATA_CACHE.find(x => x.id == orderId || x.reklamace_id == orderId);
    if (!record) return;

    const reklamaceId = record.reklamace_id || record.id;
    const formData = new FormData();
    formData.append('action', 'mark_read');
    formData.append('reklamace_id', reklamaceId);

    await fetch('api/notes_api.php', {
      method: 'POST',
      body: formData
    });
  } catch (e) {
    logger.error('Chyba p≈ôi oznaƒçov√°n√≠ pozn√°mek:', e);
  }
}

// Zobrazit pozn√°mky (async version)
async function showNotes(record) {
  CURRENT_RECORD = record;
  const customerName = Utils.getCustomerName(record);

  // Zobrazit loading state
  const loadingContent = `
    ${ModalManager.createHeader('Pozn√°mky', customerName)}
    <div class="modal-body" style="text-align: center; padding: 3rem;">
      <div class="loading">Naƒç√≠t√°n√≠ pozn√°mek...</div>
    </div>
  `;
  ModalManager.show(loadingContent);

  // Naƒç√≠st pozn√°mky z API
  const notes = await getNotes(record.id);

  // Se≈ôadit podle ƒçasu
  notes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  const content = `
    ${ModalManager.createHeader('Pozn√°mky', customerName)}

    <div class="modal-body">
      <div class="notes-container">
        ${notes.length > 0
          ? notes.map(note => `
              <div class="note-item ${note.read ? '' : 'unread'}">
                <div class="note-header">
                  <span class="note-author">${note.author_name || note.author}</span>
                  <span class="note-time">${formatDateTime(note.timestamp)}</span>
                </div>
                <div class="note-text">${Utils.escapeHtml(note.text)}</div>
              </div>
            `).join('')
          : '<div class="empty-notes">Zat√≠m ≈æ√°dn√© pozn√°mky</div>'
        }
      </div>

      <div class="note-input-area">
        <textarea
          class="note-textarea"
          id="newNoteText"
          placeholder="Napi≈°te pozn√°mku..."
        ></textarea>
      </div>

      <!-- PDF PROTOKOL -->
      <div style="background: var(--c-bg); border: 1px solid var(--c-border); padding: 1rem; margin-top: 1.5rem;">
        <h3 style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--c-black); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--c-border);">üìÑ PDF Protokol</h3>
        ${CURRENT_RECORD.documents && CURRENT_RECORD.documents.length > 0 ? `
          <button onclick="window.open('${CURRENT_RECORD.documents[0].file_path}', '_blank')" 
                  class="btn" 
                  style="width: 100%; padding: 1rem; min-height: 60px; background: var(--c-black); color: white; border: none; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s;">
            üì• Otev≈ô√≠t PDF protokol
          </button>
          <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: var(--c-grey); text-align: center;">
            ${new Date(CURRENT_RECORD.documents[0].created_at).toLocaleString('cs-CZ')}
          </p>
        ` : `
          <div style="padding: 1rem; text-align: center; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 4px;">
            <p style="margin: 0; color: #6c757d; font-size: 0.9rem;">‚ÑπÔ∏è PDF protokol je≈°tƒõ nebyl vytvo≈ôen</p>
            <p style="margin: 0.3rem 0 0 0; font-size: 0.8rem; color: #adb5bd;">Vytvo≈ô√≠ se po dokonƒçen√≠ servisu</p>
          </div>
        `}
      </div>

    ${ModalManager.createActions([
      '<button class="btn btn-secondary" onclick="closeNotesModal()">Zav≈ô√≠t</button>',
      '<button class="btn btn-success" onclick="saveNewNote(\'' + record.id + '\')">P≈ôidat pozn√°mku</button>'
    ])}
  `;

  ModalManager.show(content);

  // Oznaƒçit jako p≈ôeƒçten√©
  setTimeout(async () => {
    await markNotesAsRead(record.id);
    await loadAll(ACTIVE_FILTER); // Refresh data
  }, 1000);
}

// Ulo≈æit novou pozn√°mku (async version)
async function saveNewNote(orderId) {
  const textarea = document.getElementById('newNoteText');
  const text = textarea.value.trim();

  if (!text) {
    alert('Napi≈°te text pozn√°mky');
    return;
  }

  try {
    await addNote(orderId, text);

    const record = CURRENT_RECORD;
    await showNotes(record);

    await loadAll(ACTIVE_FILTER); // Refresh data
  } catch (e) {
    alert('Chyba p≈ôi ukl√°d√°n√≠ pozn√°mky: ' + e.message);
  }
}

function closeNotesModal() {
  closeDetail();
  renderOrders();
}

function formatDateTime(isoString) {
  const date = new Date(isoString);
  const now = new Date();
  const diff = now - date;
  
  if (diff < 60000) {
    return 'Pr√°vƒõ teƒè';
  }
  
  if (diff < 3600000) {
    const mins = Math.floor(diff / 60000);
    return `P≈ôed ${mins} min`;
  }
  
  if (diff < 86400000) {
    const hours = Math.floor(diff / 3600000);
    return `P≈ôed ${hours} h`;
  }
  
  return date.toLocaleDateString('cs-CZ', {
    day: 'numeric',
    month: 'numeric',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// === UTILITY ===
function getStatus(stav) {
  const statusMap = {
    'ƒåEK√Å': { class: 'wait', text: 'NOV√Å' },
    'wait': { class: 'wait', text: 'NOV√Å' },
    'DOMLUVEN√Å': { class: 'open', text: 'DOMLUVEN√Å' },
    'open': { class: 'open', text: 'DOMLUVEN√Å' },
    'HOTOVO': { class: 'done', text: 'HOTOVO' },
    'done': { class: 'done', text: 'HOTOVO' }
  };
  
  return statusMap[stav] || { class: 'wait', text: 'NOV√Å' };
}

function formatDate(dateStr) {
  if (!dateStr) return '‚Äî';
  const date = new Date(dateStr);
  if (isNaN(date)) return dateStr;
  return date.toLocaleDateString('cs-CZ');
}

function formatAppointment(dateStr, timeStr) {
  if (!dateStr || !timeStr) return '';
  
  const parts = dateStr.split('.');
  if (parts.length !== 3) return `${dateStr} ${timeStr}`;
  
  const day = parseInt(parts[0]);
  const month = parseInt(parts[1]);
  const year = parseInt(parts[2]);
  
  const date = new Date(year, month - 1, day);
  
  const weekdays = ['ne', 'po', '√∫t', 'st', 'ƒçt', 'p√°', 'so'];
  const weekday = weekdays[date.getDay()];
  
  return `${weekday} ${day}.${month}.-${timeStr}`;
}

// === HAMBURGER MENU ===
function toggleMenu() {
  const navLinks = document.getElementById('navLinks');
  const hamburger = document.querySelector('.hamburger');
  
  navLinks.classList.toggle('active');
  hamburger.classList.toggle('active');
}
// === UNIVERSAL EVENT DELEGATION FOR REMOVED INLINE HANDLERS ===
document.addEventListener('DOMContentLoaded', () => {
  // Handle data-action buttons
  document.addEventListener('click', (e) => {
    const target = e.target.closest('[data-action]');
    if (!target) return;
    
    const action = target.getAttribute('data-action');
    
    // Special cases
    if (action === 'reload') {
      location.reload();
      return;
    }
    
    // Try to call function if it exists
    if (typeof window[action] === 'function') {
      window[action]();
    }
  });

  // Handle data-navigate buttons
  document.addEventListener('click', (e) => {
    const navigate = e.target.closest('[data-navigate]')?.getAttribute('data-navigate');
    if (navigate) {
      if (typeof navigateTo === 'function') {
        navigateTo(navigate);
      } else {
        location.href = navigate;
      }
    }
  });

  // Handle data-onchange inputs
  document.addEventListener('change', (e) => {
    const target = e.target.closest('[data-onchange]');
    if (!target) return;
    
    const action = target.getAttribute('data-onchange');
    const value = target.getAttribute('data-onchange-value') || target.value;
    
    if (typeof window[action] === 'function') {
      window[action](value);
    }
  });
});
