!function(){"use strict";const e="pwa_last_reload",n="pwa_known_version",o=/iPad|iPhone|iPod/.test(navigator.userAgent),t=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone,a=o&&t?6e4:3e5;let i=null,s=!1,r=null;function l(){const n=parseInt(sessionStorage.getItem(e)||"0",10),o=Date.now()-n;return!(o<6e4)||(console.warn(`[PWA] Reload blokován - příliš brzy (${Math.round((6e4-o)/1e3)}s do dalšího povoleného)`),!1)}function c(){sessionStorage.setItem(e,Date.now().toString())}function d(){return l()?(c(),console.log("[PWA] Bezpečný reload..."),window.location.reload(),!0):(console.warn("[PWA] Reload přeskočen kvůli ochraně proti loop"),!1)}function p(e,n=2e3){if(document.getElementById("pwa-update-toast"))return;const o=document.createElement("div");o.id="pwa-update-toast",o.innerHTML='\n      <div style="\n        position: fixed;\n        bottom: 20px;\n        left: 50%;\n        transform: translateX(-50%);\n        background: #222;\n        color: #fff;\n        padding: 12px 20px;\n        border-radius: 8px;\n        box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n        z-index: 10003;\n        font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n        font-size: 14px;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n      ">\n        <span style="width: 16px; height: 16px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: pwa-spin 1s linear infinite;"></span>\n        <span>Aktualizuji aplikaci...</span>\n      </div>\n      <style>\n        @keyframes pwa-spin {\n          to { transform: rotate(360deg); }\n        }\n      </style>\n    ',document.body.appendChild(o),setTimeout(()=>{const e=document.getElementById("pwa-update-toast");e&&(console.warn("[PWA] Toast timeout - reload pravděpodobně selhal"),e.remove(),s=!1)},1e4),setTimeout(()=>{e&&e()},n)}function u(){console.log("[PWA] aktivovatNovouVerzi() volána"),console.log("[PWA] swRegistration:",i?"exists":"null"),console.log("[PWA] waiting:",i?.waiting?"exists":"null"),console.log("[PWA] installing:",i?.installing?"exists":"null"),console.log("[PWA] active:",i?.active?"exists":"null"),i&&i.waiting?(console.log("[PWA] Odesílám SKIP_WAITING"),i.waiting.postMessage("SKIP_WAITING")):i&&i.installing?(console.log("[PWA] SW se instaluje, cekam..."),i.installing.addEventListener("statechange",function(){"installed"===this.state&&(console.log("[PWA] Instalace dokoncena, aktivuji..."),i.waiting&&i.waiting.postMessage("SKIP_WAITING"))})):(console.log("[PWA] Zadny waiting SW - vynucuji aktualizaci..."),p(async()=>{try{const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e))),console.log("[PWA] Cache smazan")}catch(e){console.warn("[PWA] Chyba pri mazani cache:",e)}if(i)try{await i.update()}catch(e){console.warn("[PWA] Chyba pri update:",e)}c(),window.location.reload(!0)},1e3))}async function g(){return navigator.serviceWorker.controller?new Promise(e=>{const n=setTimeout(()=>{e(null)},3e3),o=t=>{"PONG_VERSION"===t.data?.type&&(clearTimeout(n),navigator.serviceWorker.removeEventListener("message",o),e(t.data.version))};navigator.serviceWorker.addEventListener("message",o),navigator.serviceWorker.controller.postMessage({type:"PING_VERSION",clientId:Math.random().toString(36).substr(2,9)})}):null}async function v(){if(i)try{await i.update()}catch(e){}}document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&i&&(console.log("[PWA] Stránka viditelná - kontroluji aktualizace"),v())}),window.addEventListener("focus",()=>{i&&v()}),navigator.serviceWorker.addEventListener("controllerchange",()=>{if(!s){if(s=!0,console.log("[PWA] Nový SW aktivován"),!l()){console.log("[PWA] Reload blokován ochranou - aktualizace proběhne při dalším načtení");const e=document.getElementById("pwa-update-toast");return e&&e.remove(),void(s=!1)}p(()=>{d()},1500)}}),navigator.serviceWorker.addEventListener("message",e=>{"SW_ACTIVATED"===e.data?.type&&(console.log("[PWA] SW aktivován, verze:",e.data.version),r=e.data.version,localStorage.setItem(n,e.data.version)),"CACHE_INFO"===e.data?.type&&console.log("[PWA] Cache info:",e.data)}),"serviceWorker"in navigator?window.addEventListener("load",async function(){try{i=await navigator.serviceWorker.register("/sw.php",{scope:"/",updateViaCache:"none"}),console.log("[PWA] Service Worker registrován:",i.scope),setTimeout(async()=>{r=await g(),r&&(console.log("[PWA] Aktuální SW verze:",r),localStorage.setItem(n,r))},1e3),await v(),i.addEventListener("updatefound",()=>{const e=i.installing;console.log("[PWA] Nalezena nová verze SW..."),e.addEventListener("statechange",()=>{"installed"===e.state&&navigator.serviceWorker.controller&&(console.log("[PWA] Nová verze připravena k aktivaci"),o&&t?(console.log("[PWA] iOS PWA - automatická aktivace"),u()):function(){if(document.getElementById("pwa-update-banner"))return;const e=document.createElement("div");e.id="pwa-update-banner",e.innerHTML='\n      <div style="\n        position: fixed;\n        bottom: 20px;\n        left: 50%;\n        transform: translateX(-50%);\n        background: #222;\n        color: #fff;\n        padding: 16px 24px;\n        border-radius: 8px;\n        box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n        display: flex;\n        align-items: center;\n        gap: 16px;\n        z-index: 10003;\n        font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n        font-size: 14px;\n        max-width: 90vw;\n      ">\n        <span>Je dostupna nova verze aplikace</span>\n        <button id="pwa-update-btn" style="\n          background: #fff;\n          color: #222;\n          border: none;\n          padding: 8px 16px;\n          border-radius: 4px;\n          font-weight: 600;\n          cursor: pointer;\n          white-space: nowrap;\n        ">Aktualizovat</button>\n        <button id="pwa-dismiss-btn" style="\n          background: transparent;\n          color: #999;\n          border: none;\n          padding: 8px;\n          cursor: pointer;\n          font-size: 18px;\n          line-height: 1;\n        ">&times;</button>\n      </div>\n    ',document.body.appendChild(e),document.getElementById("pwa-update-btn").addEventListener("click",()=>{u(),e.remove()}),document.getElementById("pwa-dismiss-btn").addEventListener("click",()=>{e.remove()})}())})}),setInterval(v,a)}catch(e){console.error("[PWA] Chyba registrace SW:",e)}}):console.log("[PWA] Service Worker není podporován"),window.zkontrolujAktualizace=async function(){if(!i)return void console.log("[PWA] SW není registrován");console.log("[PWA] Kontroluji aktualizace..."),await i.update();const e=await g();console.log("[PWA] Aktuální verze:",e)},window.vynutitReload=function(){return d()},window.vynutitAktualizaci=async function(){console.log("[PWA] Vynucuji kompletní aktualizaci...");const o=await caches.keys();await Promise.all(o.map(e=>caches.delete(e))),console.log("[PWA] Cache smazán");const t=await navigator.serviceWorker.getRegistrations();await Promise.all(t.map(e=>e.unregister())),console.log("[PWA] SW odregistrován"),sessionStorage.removeItem(e),localStorage.removeItem(n),window.location.reload(!0)},window.getSwInfo=async function(){const e=await g(),a=await caches.keys();return{version:e,registration:i?"OK":"NONE",caches:a,isIOS:o,isPWA:t,knownVersion:localStorage.getItem(n)}}}();