!function(){"use strict";const n=3e4,o="/api/notes_api.php?action=get_unread_counts",e="/api/push_subscription_api.php",t="/icon192.png",i="wgs-notes";let a={},r=0,c=null,s="default",l=null,d=null,u=null;const f=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,p=(f&&/Safari/.test(navigator.userAgent)&&/CriOS|FxiOS/.test(navigator.userAgent),window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone);const g=function(){if(!f)return 0;const n=navigator.userAgent.match(/OS (\d+)_(\d+)/);return n?parseFloat(n[1]+"."+n[2]):0}(),k=f&&g>=16.4&&p;async function b(){if(console.log("[Notifikace] Inicializace..."),console.log("[Notifikace] iOS:",f,"verze:",g,"PWA:",p),"serviceWorker"in navigator)try{l=await navigator.serviceWorker.ready,console.log("[Notifikace] Service Worker připraven"),"PushManager"in window&&(d=await l.pushManager.getSubscription(),d&&console.log("[Notifikace] Existujici push subscription nalezena"))}catch(n){console.log("[Notifikace] Service Worker není dostupný:",n)}"Notification"in window?(s=Notification.permission,console.log("[Notifikace] Aktualni povoleni:",s),"granted"===s&&l&&!d&&await h()):console.log("[Notifikace] Notification API neni podporovano"),await N(),z(),document.addEventListener("visibilitychange",P),console.log("[Notifikace] Inicializace dokoncena")}function v(n){const o=(n+"=".repeat((4-n.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),e=window.atob(o),t=new Uint8Array(e.length);for(let n=0;n<e.length;++n)t[n]=e.charCodeAt(n);return t}async function h(){if(!l||!("PushManager"in window))return console.log("[Notifikace] PushManager neni podporovan"),!1;try{const n=await async function(){if(u)return u;try{const n=await fetch(e+"?action=vapid-key"),o=await n.json();if("success"===o.status&&o.vapidPublicKey)return u=o.vapidPublicKey,console.log("[Notifikace] VAPID key nacten"),u;if("error"===o.status)return console.log("[Notifikace] VAPID key: "+(o.message||"neni nakonfigurovany")),null}catch(n){console.error("[Notifikace] Chyba pri nacitani VAPID key:",n)}return null}();if(!n)return console.log("[Notifikace] VAPID key nenacten - push neni nakonfigurovany"),!1;d=await l.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:v(n)}),console.log("[Notifikace] Push subscription vytvorena");if(await async function(n){try{const o=document.querySelector('input[name="csrf_token"]');let t=o?o.value:"";if(!t){const n=await fetch("/app/controllers/get_csrf_token.php"),o=await n.json();o.token&&(t=o.token)}const i=new FormData;i.append("action","subscribe"),i.append("csrf_token",t),i.append("subscription",JSON.stringify(n)),i.append("platforma",f?"ios":/Android/.test(navigator.userAgent)?"android":"desktop");const a=await fetch(e,{method:"POST",body:i});return"success"===(await a.json()).status}catch(n){return console.error("[Notifikace] Chyba pri ukladani subscription:",n),!1}}(d))return console.log("[Notifikace] Subscription ulozena na serveru"),!0}catch(n){console.error("[Notifikace] Chyba pri registraci push:",n),"NotAllowedError"===n.name&&console.log("[Notifikace] Uzivatel zamitnul push notifikace")}return!1}async function y(){if(!("Notification"in window))return console.log("[Notifikace] Notification API neni podporovano"),!1;if("granted"===Notification.permission)return s="granted",!d&&l&&await h(),!0;if("denied"===Notification.permission)return console.log("[Notifikace] Notifikace jsou zablokovane"),!1;try{const n=await Notification.requestPermission();return s=n,console.log("[Notifikace] Uzivatel odpoveděl:",n),"granted"===n&&l&&await h(),"granted"===n}catch(n){return console.error("[Notifikace] Chyba pri zadosti o povoleni:",n),!1}}async function w(n){if("setAppBadge"in navigator)try{n>0?(await navigator.setAppBadge(n),console.log("[Notifikace] Badge nastaven na:",n)):(await navigator.clearAppBadge(),console.log("[Notifikace] Badge smazan"))}catch(n){console.error("[Notifikace] Chyba pri nastaveni badge:",n)}}async function m(n,o,e={}){if("visible"===document.visibilityState)return window.WGSToast&&window.WGSToast.zobrazit(o,{titulek:n,claimId:e.claim_id||null}),void console.log("[Notifikace] Stranka viditelna, zobrazen toast");if("granted"===s)try{if(l&&(k||p))await l.showNotification(n,{body:o,icon:t,badge:t,tag:i,vibrate:[200,100,200],data:e,requireInteraction:!1}),console.log("[Notifikace] SW notifikace zobrazena:",n);else{new Notification(n,{body:o,icon:t,tag:i,badge:t,vibrate:[200,100,200],data:e,requireInteraction:!1}).onclick=function(){window.focus(),this.close(),e.claim_id&&(window.location.href="/seznam.php?highlight="+e.claim_id)},console.log("[Notifikace] Notifikace zobrazena:",n)}}catch(n){console.error("[Notifikace] Chyba pri zobrazeni notifikace:",n)}else console.log("[Notifikace] Notifikace nejsou povoleny")}async function N(){try{const n=await fetch(o);if(!n.ok)throw new Error("HTTP "+n.status);const e=await n.json();if("success"!==e.status)throw new Error(e.error||"Neznama chyba");const t=e.unread_counts||{},i=Object.values(t).reduce((n,o)=>n+parseInt(o,10),0);if(i-r>0&&r>0)for(const[n,o]of Object.entries(t)){if(o>(a[n]||0)){m("Nova poznamka",`Mate ${o} neprectenych poznamek`,{claim_id:n});break}}return a=t,r=i,await w(i),function(n){const o=document.title.replace(/^\(\d+\)\s*/,"");document.title=n>0?`(${n}) ${o}`:o}(i),i}catch(n){return console.error("[Notifikace] Chyba pri nacitani neprectenych:",n),r}}function z(){c&&clearInterval(c),c=setInterval(async()=>{await N()},n),console.log("[Notifikace] Polling spusten (interval:",n,"ms)")}function P(){"visible"===document.visibilityState&&(N(),z())}window.WGSNotifikace={init:b,pozadatOPovoleni:y,nastavitBadge:w,zobrazitNotifikaci:m,aktualizovat:N,zobrazitDialogPovoleni:function(){if("default"!==s)return;if("true"===localStorage.getItem("wgs_notif_asked"))return;const n=document.createElement("div");n.id="notif-permission-dialog",n.innerHTML='\n      <div style="\n        position: fixed;\n        bottom: 80px;\n        left: 50%;\n        transform: translateX(-50%);\n        background: #fff;\n        color: #222;\n        padding: 20px 24px;\n        border-radius: 12px;\n        box-shadow: 0 4px 24px rgba(0,0,0,0.2);\n        z-index: 10002;\n        font-family: \'Poppins\', sans-serif;\n        font-size: 14px;\n        max-width: 320px;\n        text-align: center;\n        border: 1px solid #ddd;\n      ">\n        <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">\n          Chcete dostávat upozornění?\n        </div>\n        <div style="color: #666; margin-bottom: 16px; line-height: 1.4;">\n          Budeme vás informovat o nových poznámkách k vašim zakázkám.\n        </div>\n        <div style="display: flex; gap: 10px; justify-content: center;">\n          <button id="notif-allow-btn" style="\n            background: #222;\n            color: #fff;\n            border: none;\n            padding: 10px 20px;\n            border-radius: 6px;\n            font-weight: 600;\n            cursor: pointer;\n          ">Povolit</button>\n          <button id="notif-deny-btn" style="\n            background: #f5f5f5;\n            color: #666;\n            border: 1px solid #ddd;\n            padding: 10px 20px;\n            border-radius: 6px;\n            cursor: pointer;\n          ">Nyní ne</button>\n        </div>\n      </div>\n    ',document.body.appendChild(n),document.getElementById("notif-allow-btn").addEventListener("click",async()=>{n.remove(),localStorage.setItem("wgs_notif_asked","true"),await y()}),document.getElementById("notif-deny-btn").addEventListener("click",()=>{n.remove(),localStorage.setItem("wgs_notif_asked","true")})},registrovatPush:h,zrusitPush:async function(){if(!d)return!0;try{const n=d.endpoint;await d.unsubscribe(),d=null;const o=document.querySelector('input[name="csrf_token"]'),t=o?o.value:"",i=new FormData;return i.append("action","unsubscribe"),i.append("csrf_token",t),i.append("endpoint",n),await fetch(e,{method:"POST",body:i}),console.log("[Notifikace] Push subscription zrusena"),!0}catch(n){return console.error("[Notifikace] Chyba pri ruseni subscription:",n),!1}},getTotal:()=>r,getPushSubscription:()=>d,isIOS:f,isPWA:p,iosVersion:g,iosSupportsWebPush:k},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(b,1e3)}):setTimeout(b,1e3)}();