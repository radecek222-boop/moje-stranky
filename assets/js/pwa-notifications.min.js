!function(){"use strict";const n=3e4,e="/api/notes_api.php?action=get_unread_counts",o="/api/push_subscription_api.php",t="/icon192.png",i="wgs-notes";let a={},r=0,c=null,s="default",l=null,u=null,d=null;const f=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,p=(f&&/Safari/.test(navigator.userAgent)&&/CriOS|FxiOS/.test(navigator.userAgent),window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone);const g=function(){if(!f)return 0;const n=navigator.userAgent.match(/OS (\d+)_(\d+)/);return n?parseFloat(n[1]+"."+n[2]):0}(),k=f&&g>=16.4&&p;async function b(){if(console.log("[Notifikace] Inicializace..."),console.log("[Notifikace] iOS:",f,"verze:",g,"PWA:",p),"serviceWorker"in navigator)try{l=await navigator.serviceWorker.ready,console.log("[Notifikace] Service Worker připraven"),"PushManager"in window&&(u=await l.pushManager.getSubscription(),u&&console.log("[Notifikace] Existujici push subscription nalezena"))}catch(n){console.log("[Notifikace] Service Worker není dostupný:",n)}"Notification"in window?(s=Notification.permission,console.log("[Notifikace] Aktualni povoleni:",s),"granted"===s&&l&&!u&&await y()):console.log("[Notifikace] Notification API neni podporovano"),await N(),z(),document.addEventListener("visibilitychange",S),console.log("[Notifikace] Inicializace dokoncena")}function v(n){const e=(n+"=".repeat((4-n.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),o=window.atob(e),t=new Uint8Array(o.length);for(let n=0;n<o.length;++n)t[n]=o.charCodeAt(n);return t}async function y(){if(!l||!("PushManager"in window))return console.log("[Notifikace] PushManager neni podporovan"),!1;try{const n=await async function(){if(d)return d;try{const n=await fetch(o+"?action=vapid-key"),e=await n.json();if("success"===e.status&&e.vapidPublicKey)return d=e.vapidPublicKey,console.log("[Notifikace] VAPID key nacten"),d;if("error"===e.status)return console.log("[Notifikace] VAPID key: "+(e.message||"neni nakonfigurovany")),null}catch(n){console.error("[Notifikace] Chyba pri nacitani VAPID key:",n)}return null}();if(!n)return console.log("[Notifikace] VAPID key nenacten - push neni nakonfigurovany"),!1;u=await l.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:v(n)}),console.log("[Notifikace] Push subscription vytvorena");if(await async function(n){try{const e=document.querySelector('input[name="csrf_token"]');let t=e?e.value:"";if(!t){const n=await fetch("/app/controllers/get_csrf_token.php"),e=await n.json();e.token&&(t=e.token)}const i=new FormData;i.append("action","subscribe"),i.append("csrf_token",t),i.append("subscription",JSON.stringify(n)),i.append("platforma",f?"ios":/Android/.test(navigator.userAgent)?"android":"desktop");const a=await fetch(o,{method:"POST",body:i});return"success"===(await a.json()).status}catch(n){return console.error("[Notifikace] Chyba pri ukladani subscription:",n),!1}}(u))return console.log("[Notifikace] Subscription ulozena na serveru"),!0}catch(n){console.error("[Notifikace] Chyba pri registraci push:",n),"NotAllowedError"===n.name&&console.log("[Notifikace] Uzivatel zamitnul push notifikace")}return!1}async function h(){if(!("Notification"in window))return console.log("[Notifikace] Notification API neni podporovano"),!1;if("granted"===Notification.permission)return s="granted",!u&&l&&await y(),!0;if("denied"===Notification.permission)return console.log("[Notifikace] Notifikace jsou zablokovane"),!1;try{const n=await Notification.requestPermission();return s=n,console.log("[Notifikace] Uzivatel odpoveděl:",n),"granted"===n&&l&&await y(),"granted"===n}catch(n){return console.error("[Notifikace] Chyba pri zadosti o povoleni:",n),!1}}async function w(n){if("setAppBadge"in navigator)try{n>0?(await navigator.setAppBadge(n),console.log("[Notifikace] Badge nastaven na:",n)):(await navigator.clearAppBadge(),console.log("[Notifikace] Badge smazan"))}catch(n){console.error("[Notifikace] Chyba pri nastaveni badge:",n)}}async function m(n,e,o={}){if("granted"===s)if("visible"!==document.visibilityState)try{if(l&&(k||p))await l.showNotification(n,{body:e,icon:t,badge:t,tag:i,vibrate:[200,100,200],data:o,requireInteraction:!1}),console.log("[Notifikace] SW notifikace zobrazena:",n);else{new Notification(n,{body:e,icon:t,tag:i,badge:t,vibrate:[200,100,200],data:o,requireInteraction:!1}).onclick=function(){window.focus(),this.close(),o.claim_id&&(window.location.href="/seznam.php?highlight="+o.claim_id)},console.log("[Notifikace] Notifikace zobrazena:",n)}}catch(n){console.error("[Notifikace] Chyba pri zobrazeni notifikace:",n)}else console.log("[Notifikace] Stranka je viditelna, preskakuji notifikaci");else console.log("[Notifikace] Notifikace nejsou povoleny")}async function N(){try{const n=await fetch(e);if(!n.ok)throw new Error("HTTP "+n.status);const o=await n.json();if("success"!==o.status)throw new Error(o.error||"Neznama chyba");const t=o.unread_counts||{},i=Object.values(t).reduce((n,e)=>n+parseInt(e,10),0);if(i-r>0&&r>0)for(const[n,e]of Object.entries(t)){if(e>(a[n]||0)){m("Nova poznamka",`Mate ${e} neprectenych poznamek`,{claim_id:n});break}}return a=t,r=i,await w(i),function(n){const e=document.title.replace(/^\(\d+\)\s*/,"");document.title=n>0?`(${n}) ${e}`:e}(i),i}catch(n){return console.error("[Notifikace] Chyba pri nacitani neprectenych:",n),r}}function z(){c&&clearInterval(c),c=setInterval(async()=>{await N()},n),console.log("[Notifikace] Polling spusten (interval:",n,"ms)")}function S(){"visible"===document.visibilityState&&(N(),z())}window.WGSNotifikace={init:b,pozadatOPovoleni:h,nastavitBadge:w,zobrazitNotifikaci:m,aktualizovat:N,zobrazitDialogPovoleni:function(){if("default"!==s)return;if("true"===localStorage.getItem("wgs_notif_asked"))return;const n=document.createElement("div");n.id="notif-permission-dialog",n.innerHTML='\n      <div style="\n        position: fixed;\n        bottom: 80px;\n        left: 50%;\n        transform: translateX(-50%);\n        background: #fff;\n        color: #222;\n        padding: 20px 24px;\n        border-radius: 12px;\n        box-shadow: 0 4px 24px rgba(0,0,0,0.2);\n        z-index: 10002;\n        font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n        font-size: 14px;\n        max-width: 320px;\n        text-align: center;\n        border: 1px solid #ddd;\n      ">\n        <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">\n          Chcete dostávat upozornění?\n        </div>\n        <div style="color: #666; margin-bottom: 16px; line-height: 1.4;">\n          Budeme vás informovat o nových poznámkách k vašim zakázkám.\n        </div>\n        <div style="display: flex; gap: 10px; justify-content: center;">\n          <button id="notif-allow-btn" style="\n            background: #222;\n            color: #fff;\n            border: none;\n            padding: 10px 20px;\n            border-radius: 6px;\n            font-weight: 600;\n            cursor: pointer;\n          ">Povolit</button>\n          <button id="notif-deny-btn" style="\n            background: #f5f5f5;\n            color: #666;\n            border: 1px solid #ddd;\n            padding: 10px 20px;\n            border-radius: 6px;\n            cursor: pointer;\n          ">Nyní ne</button>\n        </div>\n      </div>\n    ',document.body.appendChild(n),document.getElementById("notif-allow-btn").addEventListener("click",async()=>{n.remove(),localStorage.setItem("wgs_notif_asked","true"),await h()}),document.getElementById("notif-deny-btn").addEventListener("click",()=>{n.remove(),localStorage.setItem("wgs_notif_asked","true")})},registrovatPush:y,zrusitPush:async function(){if(!u)return!0;try{const n=u.endpoint;await u.unsubscribe(),u=null;const e=document.querySelector('input[name="csrf_token"]'),t=e?e.value:"",i=new FormData;return i.append("action","unsubscribe"),i.append("csrf_token",t),i.append("endpoint",n),await fetch(o,{method:"POST",body:i}),console.log("[Notifikace] Push subscription zrusena"),!0}catch(n){return console.error("[Notifikace] Chyba pri ruseni subscription:",n),!1}},getTotal:()=>r,getPushSubscription:()=>u,isIOS:f,isPWA:p,iosVersion:g,iosSupportsWebPush:k},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(b,1e3)}):setTimeout(b,1e3)}();