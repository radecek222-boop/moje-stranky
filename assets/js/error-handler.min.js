window.addEventListener("error",function(e){const n={type:"JavaScript Error",message:e.message,file:e.filename,line:e.lineno,column:e.colno,stack:e.error?e.error.stack:null,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent};console.error("JavaScript Error Caught:",n),displayJSError(n),logErrorToServer(n)}),window.addEventListener("unhandledrejection",function(e){const n={type:"Unhandled Promise Rejection",message:e.reason?e.reason.message||e.reason:"Unknown rejection",stack:e.reason?e.reason.stack:null,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent};console.error("Unhandled Promise Rejection:",n),displayJSError(n),logErrorToServer(n)});const originalConsoleError=console.error.bind(console);function displayJSError(e){if(document.getElementById("js-error-container"))return;const n=document.createElement("div");n.id="js-error-container",n.style.cssText="\n        position: fixed;\n        bottom: 20px;\n        right: 20px;\n        max-width: 500px;\n        background: #2d2d2d;\n        border: 3px solid #dc3545;\n        border-radius: 8px;\n        box-shadow: 0 10px 40px rgba(0,0,0,0.5);\n        z-index: 10003;\n        font-family: 'Courier New', monospace;\n        color: #f0f0f0;\n        overflow: hidden;\n    ";const t=document.createElement("div");t.style.cssText="\n        background: #dc3545;\n        color: white;\n        padding: 12px 15px;\n        font-weight: bold;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        font-size: 14px;\n    ",t.innerHTML=`\n        <span>${e.type}</span>\n        <button onclick="document.getElementById('js-error-container').remove()"\n                style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; line-height: 1;">\n            ×\n        </button>\n    `;const o=document.createElement("div");o.style.cssText="\n        padding: 15px;\n        max-height: 400px;\n        overflow-y: auto;\n        font-size: 12px;\n    ";let r=`\n        <div style="margin-bottom: 10px;">\n            <div style="color: #ffc107; font-weight: bold; margin-bottom: 5px;">[List] ZPRÁVA:</div>\n            <div style="color: #ff6b6b; word-break: break-word;">${escapeHtml(e.message)}</div>\n        </div>\n    `;if(e.file&&(r+=`\n            <div style="margin-bottom: 10px;">\n                <div style="color: #ffc107; font-weight: bold; margin-bottom: 5px;">[Loc] SOUBOR:</div>\n                <div style="color: #4dabf7; word-break: break-all;">${escapeHtml(e.file)}</div>\n            </div>\n        `),e.line&&(r+=`\n            <div style="margin-bottom: 10px;">\n                <div style="color: #ffc107; font-weight: bold; margin-bottom: 5px;">[Loc] ŘÁDEK:</div>\n                <div style="color: #51cf66; font-weight: bold;">\n                    ${e.line}${e.column?":"+e.column:""}\n                </div>\n            </div>\n        `),e.stack){const n=e.stack.split("\n").slice(0,10);r+=`\n            <div style="margin-bottom: 10px;">\n                <div style="color: #ffc107; font-weight: bold; margin-bottom: 5px;">STACK TRACE:</div>\n                <div style="background: #1a1a1a; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 150px;">\n                    <pre style="margin: 0; color: #868e96; font-size: 11px; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(n.join("\n"))}</pre>\n                </div>\n            </div>\n        `}r+='\n        <div style="text-align: center; margin-top: 15px;">\n            <button onclick="copyJSError()"\n                    style="background: #28a745; color: white; border: none; padding: 8px 15px;\n                           border-radius: 4px; cursor: pointer; font-family: \'Courier New\', monospace; font-size: 12px;">\n                Kopírovat chybový report\n            </button>\n            <div id="js-copy-status" style="color: #28a745; margin-top: 8px; display: none; font-size: 11px;">\n                Zkopírováno do schránky\n            </div>\n        </div>\n    ',o.innerHTML=r,n.appendChild(t),n.appendChild(o),document.body.appendChild(n),window._lastJSError=e}console.error=function(...e){if(originalConsoleError(...e),e[0]instanceof Error){displayJSError({type:"Console Error",message:e[0].message,stack:e[0].stack,timestamp:(new Date).toISOString(),url:window.location.href})}},window.copyJSError=function(){const e=window._lastJSError;if(!e)return;const n=`\nWGS JAVASCRIPT ERROR REPORT\n${"=".repeat(80)}\nType: ${e.type}\nMessage: ${e.message}\n${e.file?`File: ${e.file}`:""}\n${e.line?`Line: ${e.line}${e.column?":"+e.column:""}`:""}\n${e.stack?`\nStack Trace:\n${"-".repeat(80)}\n${e.stack}`:""}\n\nPage URL: ${e.url}\nTime: ${e.timestamp}\nUser Agent: ${e.userAgent}\n${"=".repeat(80)}\n    `.trim();navigator.clipboard.writeText(n).then(()=>{const e=document.getElementById("js-copy-status");e&&(e.style.display="block",setTimeout(()=>{e.style.display="none"},3e3))}).catch(e=>{console.error("Failed to copy:",e),alert("Kopírování selhalo. Zkopírujte chybu ručně z konzole.")})};const errorLogger={queue:new Map,lastSent:0,throttleMs:2e3,sending:!1,rateLimited:!1,hashError:e=>`${e.type}:${e.message}:${e.file}:${e.line}`,add(e){const n=this.hashError(e);this.queue.has(n)||this.queue.set(n,e),this.scheduleFlush()},scheduleFlush(){if(this.sending||this.rateLimited)return;const e=Date.now()-this.lastSent;if(e>=this.throttleMs)this.flush();else{const n=this.throttleMs-e;setTimeout(()=>this.flush(),n)}},async flush(){if(0===this.queue.size||this.sending||this.rateLimited)return;this.sending=!0;const e=Array.from(this.queue.values());this.queue.clear();try{const n=await fetch("/api/log_js_error.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({errors:e,count:e.length})});this.lastSent=Date.now(),429===n.status&&(this.rateLimited=!0,console.warn("Error logging rate limited - paused for 5 minutes"),setTimeout(()=>{this.rateLimited=!1,console.log("Error logging resumed")},3e5))}catch(e){console.warn("Failed to log errors to server:",e)}finally{this.sending=!1}}};function logErrorToServer(e){"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&errorLogger.add(e)}const originalFetch=window.fetch;function displayAPIError(e){displayJSError({type:"API Error",message:e.message||e.error,file:e.full_path||e.file,line:e.line,stack:e.backtrace?formatBacktrace(e.backtrace):null,timestamp:(new Date).toISOString(),url:window.location.href})}function formatBacktrace(e){return Array.isArray(e)?e.map((e,n)=>`#${n} ${(e.class?e.class+e.type:"")+(e.function||"unknown")}() at ${e.full_path||e.file}:${e.line}`).join("\n"):null}window.fetch=function(...e){return originalFetch.apply(this,e).then(async e=>{if(!e.ok){const n=e.clone();try{const n=await e.json();if(n.error||n.message){const t=new Error(n.message||n.error||"HTTP Error");throw t.httpStatus=e.status,t.responseData=n,n.file&&n.line&&(console.error("API Error:",{message:n.message||n.error,file:n.file,full_path:n.full_path,line:n.line,backtrace:n.backtrace}),displayAPIError(n)),t}throw new Error(`HTTP ${e.status}: ${JSON.stringify(n)}`)}catch(t){try{const t=await n.text();throw console.error("HTTP Error (non-JSON response):",{status:e.status,statusText:e.statusText,body:t,bodyLength:t.length}),new Error(`HTTP ${e.status}: ${t||e.statusText||"Empty response"}`)}catch(n){throw new Error(`HTTP ${e.status}: ${e.statusText||"Unknown error"}`)}}}return e}).catch(e=>{throw console.error("Fetch Error:",e),e})},console.log("WGS Error Handler loaded - All errors will be caught and displayed");