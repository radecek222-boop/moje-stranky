/**
 * Kalkulačka ceny - Ceník služeb (WIZARD)
 * @version 2.0.0
 */

(function() {
    'use strict';

    // ========================================
    // GLOBÁLNÍ PROMĚNNÉ
    // ========================================
    const WORKSHOP_COORDS = { lat: 50.056725, lon: 14.577261 }; // Běchovice
    const TRANSPORT_RATE = 0.28; // €/km

    // Režim kalkulačky: 'standalone' nebo 'protokol'
    let kalkulackaRezim = 'standalone';

    // Ceník služeb (aktualizováno 2025-11-24)
    const CENY = {
        diagnostika: 110, // Inspekce/diagnostika
        prvniDil: 205, // První díl čalounění
        dalsiDil: 70, // Každý další díl
        zakladniSazba: 165, // Základní servisní sazba (mechanické opravy)
        mechanismusPriplatek: 45, // Příplatek za mechanismus (relax, výsuv)
        druhaOsoba: 95, // Druhá osoba pro těžký nábytek nad 50kg
        material: 50, // Materiál (alternativní výplně)
        vyzvednutiSklad: 10 // Vyzvednutí dílu pro reklamaci na skladě
    };

    // Fallback preklady (kdyz window.t nefunguje)
    const PREKLADY = {
        // Tlacitka
        'btn.back': 'Zpět',
        'btn.addToProtocol': 'Započítat',
        'btn.exportPDF': 'Export do PDF',
        'btn.newCalculation': 'Nová kalkulace',

        // Souhrn
        'summary.transportation': 'Dopravné',
        'summary.inspection': 'Inspekce / diagnostika',
        'summary.upholsteryWork': 'Čalounické práce',
        'summary.part': 'díl',
        'summary.parts': 'díly',
        'summary.firstPart': 'První díl',
        'summary.additionalParts': 'Další díly',
        'summary.basicServiceRate': 'Základní servisní sazba',
        'summary.mechanicalParts': 'Mechanické opravy',
        'summary.mechanism': 'mechanismus',
        'summary.relaxMechanisms': 'Relax mechanismy',
        'summary.slidingMechanisms': 'Výsuvné mechanismy',
        'summary.secondPerson': 'Druhá osoba (těžký nábytek)',
        'summary.materialSupplied': 'Materiál od WGS',
        'summary.warehousePickup': 'Vyzvednutí dílu na skladě',
        'summary.claim': 'reklamace',
        'summary.claimNoTransport': 'Reklamace - bez dopravného',
        'summary.unknownAddress': 'Neznámá adresa',

        // Upozorneni
        'alert.selectAddress': 'Prosím vyberte adresu ze seznamu',
        'alert.pdfError': 'Chyba při generování PDF',
        'alert.distanceError': 'Chyba při výpočtu vzdálenosti',
        'alert.distanceCalculationError': 'Nelze vypočítat vzdálenost',
        'alert.pdfLoading': 'Generuji PDF...'
    };

    // Helper funkce pro preklad s fallbackem
    function preklad(klic) {
        // Zkusit window.t, pokud existuje a vrati neco jineho nez klic
        if (typeof window.t === 'function') {
            const vysledek = window.t(klic);
            if (vysledek && vysledek !== klic) {
                return vysledek;
            }
        }
        // Fallback na lokalni preklady
        return PREKLADY[klic] || klic;
    }

    // Výchozí stav kalkulačky
    const VYCHOZI_STAV = {
        krok: 1,
        adresa: null,
        vzdalenost: 0,
        dopravne: 0,
        reklamaceBezDopravy: false,
        vyzvednutiSklad: false,
        typServisu: 'calouneni', // diagnostika, calouneni, mechanika, kombinace

        // Čalounické práce
        sedaky: 0,
        operky: 0,
        podrucky: 0,
        panely: 0,

        // Mechanické práce
        relax: 0,
        vysuv: 0,

        // Další
        tezkyNabytek: false,
        material: false
    };

    // Stav kalkulačky (kopie výchozího stavu)
    let stav = { ...VYCHOZI_STAV };

    // DEBUG: Export stavu pro diagnostiku
    window.stav = stav;

    // Reset stavu na výchozí hodnoty
    function resetovatStav() {
        stav = { ...VYCHOZI_STAV };
        window.stav = stav; // DEBUG: Aktualizovat referenci

        // Resetovat DOM elementy
        document.querySelectorAll('input[type="number"]').forEach(input => {
            if (['sedaky', 'operky', 'podrucky', 'panely', 'relax', 'vysuv'].includes(input.id)) {
                input.value = 0;
            }
        });

        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            if (['tezky-nabytek', 'material', 'reklamace-bez-dopravy', 'vyzvednuti-sklad'].includes(checkbox.id)) {
                checkbox.checked = false;
            }
        });

        // Resetovat radio na výchozí (calouneni)
        const calouneniRadio = document.querySelector('input[name="service-type"][value="calouneni"]');
        if (calouneniRadio) {
            calouneniRadio.checked = true;
        }

        // Resetovat zobrazení adresy
        const distanceResult = document.getElementById('distance-result');
        if (distanceResult) {
            distanceResult.style.display = 'none';
        }

        const calcAddress = document.getElementById('calc-address');
        if (calcAddress) {
            calcAddress.value = '';
        }

        // Skrýt všechny kroky kromě prvního
        document.querySelectorAll('.wizard-step').forEach(step => {
            if (step.id === 'step-address') {
                step.classList.remove('hidden');
                step.style.display = 'flex';
            } else {
                step.classList.add('hidden');
                step.style.display = 'none';
            }
        });

        aktualizovatProgress();
    }

    // ========================================
    // INIT KALKULAČKY
    // ========================================
    window.addEventListener('DOMContentLoaded', () => {
        // Inicializovat kalkulačku pokud existuje na stránce
        if (document.getElementById('kalkulacka')) {
            initKalkulacka();
        }
    });

    function initKalkulacka() {
        const kalkulackaElement = document.getElementById('kalkulacka');
        if (!kalkulackaElement) {
            return;
        }

        // Resetovat stav při každé inicializaci
        resetovatStav();

        initAddressAutocomplete();
        initEventListeners();
        aktualizovatProgress();
        nastavitPevnouVysku();
    }

    /**
     * Nastavi pevnou vysku podle prvniho kroku
     * Ostatni kroky se prizpusobi teto vysce
     */
    function nastavitPevnouVysku() {
        const prvniKrok = document.getElementById('step-address');
        if (!prvniKrok) return;

        // Pockame az se vse vyrenderuje
        setTimeout(() => {
            const vyska = prvniKrok.offsetHeight;
            if (vyska > 0) {
                // Nastavit min-height pro vsechny kroky
                document.querySelectorAll('.wizard-step').forEach(krok => {
                    krok.style.minHeight = vyska + 'px';
                });
            }
        }, 100);
    }

    // Export pro použití z protokolu
    window.initKalkulacka = initKalkulacka;

    function initEventListeners() {
        // Radio buttony pro typ servisu
        document.querySelectorAll('input[name="service-type"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                stav.typServisu = e.target.value;
            });
        });

        // Checkboxy
        const checkboxy = ['tezky-nabytek', 'material', 'vyzvednuti-sklad'];
        checkboxy.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
                checkbox.addEventListener('change', (e) => {
                    const key = id.replace(/-/g, '');
                    if (key === 'tezkynabytek') {
                        stav.tezkyNabytek = e.target.checked;
                    } else if (key === 'vyzvednutisklad') {
                        stav.vyzvednutiSklad = e.target.checked;
                    } else {
                        stav[key] = e.target.checked;
                    }
                });
            }
        });

        // Checkbox reklamace bez dopravy - speciální handling
        const reklamaceCheckbox = document.getElementById('reklamace-bez-dopravy');
        if (reklamaceCheckbox) {
            reklamaceCheckbox.addEventListener('change', (e) => {
                stav.reklamaceBezDopravy = e.target.checked;

                if (e.target.checked) {
                    // Reklamace - dopravné = 0
                    stav.dopravne = 0;

                    // Aktualizovat zobrazení
                    const transportCost = document.getElementById('transport-cost');
                    if (transportCost) {
                        transportCost.textContent = '0.00 (' + preklad('summary.claim') + ')';
                    }
                } else {
                    // Není reklamace - přepočítat dopravné podle vzdálenosti
                    if (stav.vzdalenost > 0) {
                        stav.dopravne = Math.round(stav.vzdalenost * 2 * TRANSPORT_RATE * 100) / 100;

                        const transportCost = document.getElementById('transport-cost');
                        if (transportCost) {
                            transportCost.textContent = stav.dopravne.toFixed(2);
                        }
                    }
                }
            });
        }

        // Countery - live update souhrnu
        ['sedaky', 'operky', 'podrucky', 'panely', 'relax', 'vysuv'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('change', () => {
                    stav[id] = parseInt(input.value) || 0;
                    aktualizovatSouhrnDilu();
                });
            }
        });
    }

    // ========================================
    // AUTOCOMPLETE ADRES
    // ========================================
    function initAddressAutocomplete() {
        const input = document.getElementById('calc-address');
        const dropdown = document.getElementById('address-suggestions');

        if (!input) return;

        let debounceTimer;

        input.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            const query = e.target.value.trim();

            if (query.length < 3) {
                dropdown.classList.add('hidden');
                return;
            }

            debounceTimer = setTimeout(() => hledatAdresy(query, dropdown), 300);
        });
    }

    async function hledatAdresy(query, dropdown) {
        try {
            const data = await WGSMap.autocomplete(query, {
                type: 'street',
                limit: 5,
                country: 'CZ,SK'
            });

            if (data && data.features && data.features.length > 0) {
                zobrazitNavrhy(data.features, dropdown);
            } else {
                dropdown.classList.add('hidden');
            }
        } catch (error) {
            console.error('[Kalkulačka] Chyba autocomplete:', error);
            dropdown.classList.add('hidden');
        }
    }

    function zobrazitNavrhy(features, dropdown) {
        dropdown.innerHTML = '';

        features.slice(0, 5).forEach(feature => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = feature.properties.formatted || feature.properties.address_line1 || preklad('summary.unknownAddress');

            item.addEventListener('click', () => {
                const coords = feature.geometry.coordinates;
                vybratAdresu(feature.properties.formatted || feature.properties.address_line1, coords[1], coords[0]);
                dropdown.classList.add('hidden');
            });

            dropdown.appendChild(item);
        });

        dropdown.classList.remove('hidden');
    }

    // ========================================
    // VÝBĚR ADRESY & VÝPOČET VZDÁLENOSTI
    // ========================================
    async function vybratAdresu(formatted, lat, lon) {
        document.getElementById('calc-address').value = formatted;
        stav.adresa = formatted;

        try {
            const url = '/api/geocode_proxy.php?action=route&start_lat=' + WORKSHOP_COORDS.lat +
                        '&start_lon=' + WORKSHOP_COORDS.lon + '&end_lat=' + lat + '&end_lon=' + lon;
            const response = await fetch(url);
            const data = await response.json();

            if (data.routes && data.routes.length > 0) {
                const distanceMeters = data.routes[0].distance;
                const distanceKm = Math.round(distanceMeters / 1000);

                stav.vzdalenost = distanceKm;

                // Zkontrolovat checkbox "reklamace bez dopravy"
                const reklamaceBezDopravyCheckbox = document.getElementById('reklamace-bez-dopravy');
                const jeReklamace = reklamaceBezDopravyCheckbox && reklamaceBezDopravyCheckbox.checked;

                if (jeReklamace) {
                    stav.dopravne = 0;
                    stav.reklamaceBezDopravy = true;
                } else {
                    stav.dopravne = Math.round(distanceKm * 2 * TRANSPORT_RATE * 100) / 100;
                    stav.reklamaceBezDopravy = false;
                }

                document.getElementById('distance-value').textContent = distanceKm;
                document.getElementById('transport-cost').textContent = stav.dopravne.toFixed(2) + (jeReklamace ? ' (' + preklad('summary.claim') + ')' : '');
                document.getElementById('distance-result').classList.remove('hidden');

                // Uživatel pokračuje ručně tlačítkem "Pokračovat"
            } else {
                wgsToast.error(preklad('alert.distanceError'));
            }
        } catch (error) {
            console.error('[Kalkulačka] Chyba výpočtu vzdálenosti:', error);
            wgsToast.error(preklad('alert.distanceCalculationError'));
        }
    }

    // ========================================
    // WIZARD NAVIGACE
    // ========================================
    window.nextStep = function() {
        // Najít kontejner kalkulačky (může být na stránce nebo v modalu)
        const kalkulackaContainer = document.getElementById('kalkulacka') ||
                                    document.getElementById('calculatorModalBody');

        // Validace před pokračováním
        if (stav.krok === 1 && !stav.adresa) {
            // Zkontrolovat jestli je zaškrtnutý checkbox "reklamace bez dopravy"
            const reklamaceBezDopravyCheckbox = document.getElementById('reklamace-bez-dopravy');
            const jeReklamace = reklamaceBezDopravyCheckbox && reklamaceBezDopravyCheckbox.checked;

            if (!jeReklamace) {
                // Pokud není reklamace, adresa je povinná
                wgsToast.warning(preklad('alert.selectAddress'));
                return;
            } else {
                // Pokud je reklamace, nastavit dopravné a vzdálenost na 0
                stav.dopravne = 0;
                stav.vzdalenost = 0;
                stav.reklamaceBezDopravy = true;
                stav.adresa = preklad('summary.claimNoTransport');
            }
        }

        // Skrýt aktuální krok - hledat pouze v kontejneru kalkulačky
        const currentStep = kalkulackaContainer ?
            kalkulackaContainer.querySelector('.wizard-step:not(.hidden)') :
            document.querySelector('.wizard-step:not(.hidden)');

        if (currentStep) {
            currentStep.classList.add('hidden');
            currentStep.style.display = 'none';
        }

        stav.krok++;

        // Určit, který krok zobrazit
        let nextStepId;

        if (stav.krok === 2) {
            nextStepId = 'step-service-type';
        } else if (stav.krok === 3) {
            // Podle typu servisu
            if (stav.typServisu === 'diagnostika') {
                // Přeskočit na krok 4 (extras)
                stav.krok = 4;
                nextStepId = 'step-extras';
            } else if (stav.typServisu === 'calouneni') {
                nextStepId = 'step-upholstery';
            } else if (stav.typServisu === 'mechanika') {
                nextStepId = 'step-mechanics';
            } else if (stav.typServisu === 'kombinace') {
                nextStepId = 'step-upholstery'; // Nejdřív čalounění
            } else {
                // Fallback - neznámý typ servisu, jdi na čalounění
                nextStepId = 'step-upholstery';
            }
        } else if (stav.krok === 4) {
            // Pokud je kombinace a právě jsme byli na čalounění, jdi na mechaniku
            if (stav.typServisu === 'kombinace' && currentStep && currentStep.id === 'step-upholstery') {
                nextStepId = 'step-mechanics';
                stav.krok = 3; // Zůstat na kroku 3
            } else {
                nextStepId = 'step-extras';
            }
        } else if (stav.krok === 5) {
            // Souhrn
            zobrazitSouhrn();
            nextStepId = 'step-summary';
        }

        // Kontrola že nextStepId je definován
        if (!nextStepId) {
            return;
        }

        // Zobrazit další krok
        const nextStep = document.getElementById(nextStepId);
        if (nextStep) {
            nextStep.classList.remove('hidden');
            nextStep.style.display = 'flex';
        }

        aktualizovatProgress();
        scrollToTop();
    };

    window.previousStep = function() {
        // Skrýt aktuální krok
        const currentStep = document.querySelector('.wizard-step:not(.hidden)');
        if (currentStep) {
            currentStep.classList.add('hidden');
            currentStep.style.display = 'none';
        }

        stav.krok--;

        // Určit, který krok zobrazit
        let prevStepId;

        if (stav.krok === 1) {
            prevStepId = 'step-address';
        } else if (stav.krok === 2) {
            prevStepId = 'step-service-type';
        } else if (stav.krok === 3) {
            // Podle typu servisu
            if (stav.typServisu === 'calouneni' || stav.typServisu === 'kombinace') {
                prevStepId = 'step-upholstery';
            } else if (stav.typServisu === 'mechanika') {
                prevStepId = 'step-mechanics';
            }
        } else if (stav.krok === 4) {
            // Pokud je kombinace a jsme na mechanice, jdi zpět na čalounění
            if (stav.typServisu === 'kombinace' && currentStep && currentStep.id === 'step-mechanics') {
                prevStepId = 'step-upholstery';
                stav.krok = 3;
            } else {
                prevStepId = 'step-extras';
            }
        }

        // Zobrazit předchozí krok
        const prevStep = document.getElementById(prevStepId);
        if (prevStep) {
            prevStep.classList.remove('hidden');
            prevStep.style.display = 'flex';
        }

        aktualizovatProgress();
        scrollToTop();
    };

    function aktualizovatProgress() {
        const progressSteps = document.querySelectorAll('.progress-step');
        progressSteps.forEach((step, index) => {
            if (index < stav.krok) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
    }

    function scrollToTop() {
        const kalkulacka = document.getElementById('kalkulacka');
        if (kalkulacka) {
            kalkulacka.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // ========================================
    // COUNTER CONTROLS
    // ========================================
    window.incrementCounter = function(id) {
        const input = document.getElementById(id);
        if (input) {
            const max = parseInt(input.max) || 20;
            let value = parseInt(input.value) || 0;
            if (value < max) {
                input.value = value + 1;
                stav[id] = value + 1;
                aktualizovatSouhrnDilu();
            }
        }
    };

    window.decrementCounter = function(id) {
        const input = document.getElementById(id);
        if (input) {
            let value = parseInt(input.value) || 0;
            if (value > 0) {
                input.value = value - 1;
                stav[id] = value - 1;
                aktualizovatSouhrnDilu();
            }
        }
    };

    // ========================================
    // SOUHRN DÍLŮ (živý update)
    // ========================================
    function aktualizovatSouhrnDilu() {
        const celkemDilu = stav.sedaky + stav.operky + stav.podrucky + stav.panely;
        const totalPartsEl = document.getElementById('total-parts');
        const priceBreakdownEl = document.getElementById('parts-price-breakdown');

        if (totalPartsEl) {
            totalPartsEl.textContent = celkemDilu;
        }

        if (priceBreakdownEl && celkemDilu > 0) {
            let cena = 0;
            const firstPartText = preklad('summary.firstPart').toLowerCase();
            if (celkemDilu === 1) {
                cena = CENY.prvniDil;
                priceBreakdownEl.textContent = `(1× ${firstPartText} = ${CENY.prvniDil}€)`;
            } else {
                cena = CENY.prvniDil + (celkemDilu - 1) * CENY.dalsiDil;
                priceBreakdownEl.textContent = `(1× ${CENY.prvniDil}€ + ${celkemDilu - 1}× ${CENY.dalsiDil}€ = ${cena}€)`;
            }
        } else if (priceBreakdownEl) {
            priceBreakdownEl.textContent = '';
        }
    }

    // ========================================
    // ZOBRAZIT CENOVÝ SOUHRN
    // ========================================
    function zobrazitSouhrn() {
        const summaryDetails = document.getElementById('summary-details');
        const grandTotal = document.getElementById('grand-total');

        let html = '';
        let celkem = 0;

        // Dopravné
        html += `<div class="summary-line">
            <span>${preklad('summary.transportation')} (${stav.vzdalenost} km × 2 × ${TRANSPORT_RATE}€):</span>
            <span class="summary-price">${stav.dopravne.toFixed(2)} €</span>
        </div>`;
        celkem += stav.dopravne;

        // Diagnostika
        if (stav.typServisu === 'diagnostika') {
            html += `<div class="summary-line">
                <span>${preklad('summary.inspection')}:</span>
                <span class="summary-price">${CENY.diagnostika.toFixed(2)} €</span>
            </div>`;
            celkem += CENY.diagnostika;
        }

        // Čalounické práce
        if (stav.typServisu === 'calouneni' || stav.typServisu === 'kombinace') {
            const celkemDilu = stav.sedaky + stav.operky + stav.podrucky + stav.panely;

            if (celkemDilu > 0) {
                const cenaDilu = celkemDilu === 1 ?
                    CENY.prvniDil :
                    CENY.prvniDil + (celkemDilu - 1) * CENY.dalsiDil;

                const partsWord = celkemDilu === 1 ? preklad('summary.part') : preklad('summary.parts');
                html += `<div class="summary-line">
                    <span>${preklad('summary.upholsteryWork')} (${celkemDilu} ${partsWord}):</span>
                    <span class="summary-price">${cenaDilu.toFixed(2)} €</span>
                </div>`;

                if (celkemDilu > 1) {
                    html += `<div class="summary-subline">
                        ↳ ${preklad('summary.firstPart')}: ${CENY.prvniDil}€, ${preklad('summary.additionalParts')}: ${celkemDilu - 1}× ${CENY.dalsiDil}€
                    </div>`;
                }

                celkem += cenaDilu;
            }
        }

        // Mechanické práce
        if (stav.typServisu === 'mechanika' || stav.typServisu === 'kombinace') {
            const celkemMechanismu = stav.relax + stav.vysuv;

            // Pokud je POUZE mechanika, přidat základní sazbu
            if (stav.typServisu === 'mechanika') {
                html += `<div class="summary-line">
                    <span>${preklad('summary.basicServiceRate')}:</span>
                    <span class="summary-price">${CENY.zakladniSazba.toFixed(2)} €</span>
                </div>`;
                celkem += CENY.zakladniSazba;
            }

            if (celkemMechanismu > 0) {
                const cenaMechanismu = celkemMechanismu * CENY.mechanismusPriplatek;

                html += `<div class="summary-line">
                    <span>${preklad('summary.mechanicalParts')} (${celkemMechanismu}× ${preklad('summary.mechanism')}):</span>
                    <span class="summary-price">${cenaMechanismu.toFixed(2)} €</span>
                </div>`;

                if (stav.relax > 0) {
                    html += `<div class="summary-subline">
                        ↳ ${preklad('summary.relaxMechanisms')}: ${stav.relax}× ${CENY.mechanismusPriplatek}€
                    </div>`;
                }
                if (stav.vysuv > 0) {
                    html += `<div class="summary-subline">
                        ↳ ${preklad('summary.slidingMechanisms')}: ${stav.vysuv}× ${CENY.mechanismusPriplatek}€
                    </div>`;
                }

                celkem += cenaMechanismu;
            }
        }

        // Druhá osoba
        if (stav.tezkyNabytek) {
            html += `<div class="summary-line">
                <span>${preklad('summary.secondPerson')}:</span>
                <span class="summary-price">${CENY.druhaOsoba.toFixed(2)} €</span>
            </div>`;
            celkem += CENY.druhaOsoba;
        }

        // Materiál
        if (stav.material) {
            html += `<div class="summary-line">
                <span>${preklad('summary.materialSupplied')}:</span>
                <span class="summary-price">${CENY.material.toFixed(2)} €</span>
            </div>`;
            celkem += CENY.material;
        }

        // Vyzvednutí dílu na skladě
        if (stav.vyzvednutiSklad) {
            html += `<div class="summary-line">
                <span>${preklad('summary.warehousePickup')}:</span>
                <span class="summary-price">${CENY.vyzvednutiSklad.toFixed(2)} €</span>
            </div>`;
            celkem += CENY.vyzvednutiSklad;
        }

        summaryDetails.innerHTML = html;
        grandTotal.innerHTML = `<strong>${celkem.toFixed(2)} €</strong>`;

        // Upravit tlačítka podle režimu kalkulačky
        upravitTlacitkaProRezim();
    }

    function upravitTlacitkaProRezim() {
        const wizardButtons = document.querySelector('#step-summary .wizard-buttons');
        if (!wizardButtons) return;

        if (kalkulackaRezim === 'protokol') {
            // Protokol režim - zobrazit Zpět a Započítat
            wizardButtons.innerHTML = `
                <button class="btn-secondary" data-action="previousStep">${preklad('btn.back')}</button>
                <button class="btn-primary" data-action="zapocitatDoProtokolu">${preklad('btn.addToProtocol')}</button>
            `;
        } else {
            // Standalone režim - zobrazit Zpět, Export PDF a Nová kalkulace
            wizardButtons.innerHTML = `
                <button class="btn-secondary" data-action="previousStep">${preklad('btn.back')}</button>
                <button class="btn-primary" data-action="exportovatCenikPDF">${preklad('btn.exportPDF')}</button>
                <button class="btn-primary" data-action="resetovatKalkulacku">${preklad('btn.newCalculation')}</button>
            `;
        }
    }

    // ========================================
    // PŘEDVYPLNIT ADRESU Z TEXTU (pro protokol)
    // ========================================
    window.predvyplnitAdresu = async function(adresaText) {
        if (!adresaText || !adresaText.trim()) return;

        const calcAddress = document.getElementById('calc-address');
        if (calcAddress) {
            calcAddress.value = adresaText.trim();
        }

        // Geocoding přes WGSMap
        try {
            const data = await WGSMap.autocomplete(adresaText, {
                type: 'street',
                limit: 1,
                country: 'CZ,SK'
            });

            if (data && data.features && data.features.length > 0) {
                const feature = data.features[0];
                const coords = feature.geometry.coordinates;
                const formatted = feature.properties.formatted || adresaText;

                // Zavolat vybratAdresu s koordináty
                await vybratAdresu(formatted, coords[1], coords[0]);
            }
        } catch (error) {
            console.warn('[Kalkulačka] Nepodařilo se geocodovat adresu:', error);
            // I tak necháme adresu vyplněnou - uživatel může použít checkbox "reklamace bez dopravy"
        }
    };

    // ========================================
    // RESETOVAT KALKULAČKU
    // ========================================
    window.resetovatKalkulacku = function() {
        // Reset stavu
        stav = {
            krok: 1,
            adresa: null,
            vzdalenost: 0,
            dopravne: 0,
            reklamaceBezDopravy: false,
            vyzvednutiSklad: false,
            typServisu: 'calouneni',
            sedaky: 0,
            operky: 0,
            podrucky: 0,
            panely: 0,
            relax: 0,
            vysuv: 0,
            tezkyNabytek: false,
            material: false
        };
        window.stav = stav; // DEBUG: Aktualizovat referenci

        // Reset formuláře
        document.getElementById('calc-address').value = '';
        document.getElementById('distance-result').classList.add('hidden');
        document.getElementById('address-suggestions').classList.add('hidden');

        // Reset radio buttons
        document.querySelector('input[name="service-type"][value="calouneni"]').checked = true;

        // Reset counterů
        ['sedaky', 'operky', 'podrucky', 'panely', 'relax', 'vysuv'].forEach(id => {
            const input = document.getElementById(id);
            if (input) input.value = 0;
        });

        // Reset checkboxů
        ['tezky-nabytek', 'material', 'reklamace-bez-dopravy', 'vyzvednuti-sklad'].forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) checkbox.checked = false;
        });

        // Skrýt všechny kroky
        document.querySelectorAll('.wizard-step').forEach(step => {
            step.classList.add('hidden');
            step.style.display = 'none';
        });

        // Zobrazit první krok
        const firstStep = document.getElementById('step-address');
        firstStep.classList.remove('hidden');
        firstStep.style.display = 'flex';

        aktualizovatProgress();
        scrollToTop();
    };

    // ========================================
    // EXPORT DO PDF (pomocí html2canvas - stejně jako protokol.php)
    // ========================================
    window.exportovatCenikPDF = async function() {
        try {
            // Kontrola jestli jsou knihovny načteny
            if (typeof window.jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                wgsToast.info(preklad('alert.pdfLoading'));
                return;
            }

            // Počkat na načtení fontu Poppins (důležité pro české znaky)
            if (document.fonts && document.fonts.ready) {
                await document.fonts.ready;
                // Explicitně načíst Poppins pokud není
                try {
                    await document.fonts.load('400 16px Poppins');
                    await document.fonts.load('700 16px Poppins');
                } catch (e) {
                    console.warn('[Kalkulačka] Font Poppins nelze načíst, použije se fallback');
                }
            }

            // Vypočítat celkovou cenu
            let celkem = stav.dopravne;

            // Diagnostika
            if (stav.typServisu === 'diagnostika') {
                celkem += CENY.diagnostika;
            }

            // Čalounické práce
            if (stav.typServisu === 'calouneni' || stav.typServisu === 'kombinace') {
                const celkemDilu = stav.sedaky + stav.operky + stav.podrucky + stav.panely;
                if (celkemDilu > 0) {
                    const cenaDilu = celkemDilu === 1 ? CENY.prvniDil : CENY.prvniDil + (celkemDilu - 1) * CENY.dalsiDil;
                    celkem += cenaDilu;
                }
            }

            // Mechanické práce
            if (stav.typServisu === 'mechanika' || stav.typServisu === 'kombinace') {
                // Pokud je POUZE mechanika, přidat základní sazbu
                if (stav.typServisu === 'mechanika') {
                    celkem += CENY.zakladniSazba;
                }

                const celkemMechanismu = stav.relax + stav.vysuv;
                if (celkemMechanismu > 0) {
                    celkem += celkemMechanismu * CENY.mechanismusPriplatek;
                }
            }

            // Druhá osoba
            if (stav.tezkyNabytek) celkem += CENY.druhaOsoba;

            // Materiál
            if (stav.material) celkem += CENY.material;

            // Vyzvednutí na skladě
            if (stav.vyzvednutiSklad) celkem += CENY.vyzvednutiSklad;

            // Vytvořit HTML strukturu pro PDF (vždy desktop šířka, i na mobilu)
            const pdfContent = document.createElement('div');
            pdfContent.id = 'pdf-kalkulace-temp';
            pdfContent.style.cssText = `
                width: 794px !important;
                min-width: 794px !important;
                max-width: 794px !important;
                padding: 40px;
                background: white;
                font-family: 'Poppins', sans-serif;
                position: fixed;
                left: -9999px;
                top: 0;
                box-sizing: border-box;
            `;

            const datum = new Date().toLocaleDateString('cs-CZ');

            // Styl pro anglické překlady
            const enStyle = 'font-size: 0.75em; color: #888; font-style: italic; display: block; margin-top: 2px;';

            let htmlContent = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style="font-size: 28px; color: #4a4a4a; margin: 0 0 5px 0; font-weight: bold;">
                        KALKULACE CENY SERVISU
                    </h1>
                    <span style="${enStyle}">SERVICE PRICE CALCULATION</span>
                    <p style="font-size: 14px; color: #666; margin: 10px 0 0 0;">
                        Datum / Date: ${datum}
                    </p>
                </div>

                <hr style="border: none; border-top: 2px solid #4a4a4a; margin: 20px 0;">

                <div style="margin: 20px 0;">
                    <h3 style="font-size: 16px; color: #2a2a2a; margin: 0 0 3px 0; font-weight: bold;">
                        Adresa zákazníka
                    </h3>
                    <span style="${enStyle}">Customer Address</span>
                    <p style="font-size: 14px; margin: 8px 0 5px 0;">${stav.adresa || 'Neuvedeno / Not specified'}</p>
                    <p style="font-size: 14px; margin: 0;">Vzdálenost z dílny / Distance from workshop: ${stav.vzdalenost} km</p>
                </div>

                <div style="margin: 30px 0; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="font-size: 18px; color: #2a2a2a; margin: 0 0 3px 0; font-weight: bold;">
                        Specifikace zakázky
                    </h3>
                    <span style="${enStyle}">Order Specification</span>
            `;

            // Typ servisu
            const typyServisu = {
                'diagnostika': { cs: 'Inspekce / Diagnostika', en: 'Inspection / Diagnostics' },
                'calouneni': { cs: 'Čalounické práce', en: 'Upholstery Work' },
                'mechanika': { cs: 'Mechanické práce', en: 'Mechanical Work' },
                'kombinace': { cs: 'Kombinace čalounění a mechaniky', en: 'Combination of Upholstery and Mechanical' }
            };
            const typServisuData = typyServisu[stav.typServisu] || { cs: 'Neuveden', en: 'Not specified' };
            htmlContent += `
                    <p style="font-size: 14px; margin: 15px 0 8px 0;">
                        <strong>Typ servisu / Service type:</strong><br>
                        ${typServisuData.cs} <span style="color: #888; font-style: italic;">/ ${typServisuData.en}</span>
                    </p>
            `;

            // Čalounické práce - detaily
            if (stav.typServisu === 'calouneni' || stav.typServisu === 'kombinace') {
                htmlContent += `<p style="font-size: 14px; margin: 8px 0;"><strong>Čalounické práce</strong> <span style="color: #888; font-style: italic;">/ Upholstery Work</span></p>`;
                htmlContent += `<ul style="margin: 5px 0 5px 20px; font-size: 14px; line-height: 1.8;">`;

                if (stav.sedaky > 0) htmlContent += `<li>Sedáky / Seat cushions: ${stav.sedaky}×</li>`;
                if (stav.operky > 0) htmlContent += `<li>Opěrky / Backrests: ${stav.operky}×</li>`;
                if (stav.podrucky > 0) htmlContent += `<li>Područky / Armrests: ${stav.podrucky}×</li>`;
                if (stav.panely > 0) htmlContent += `<li>Panely / Panels: ${stav.panely}×</li>`;

                const celkemDilu = stav.sedaky + stav.operky + stav.podrucky + stav.panely;
                if (celkemDilu === 0) {
                    htmlContent += `<li style="color: #999;">Nebyly vybrány žádné díly / No parts selected</li>`;
                }

                htmlContent += `</ul>`;
            }

            // Mechanické práce - detaily
            if (stav.typServisu === 'mechanika' || stav.typServisu === 'kombinace') {
                htmlContent += `<p style="font-size: 14px; margin: 8px 0;"><strong>Mechanické práce</strong> <span style="color: #888; font-style: italic;">/ Mechanical Work</span></p>`;
                htmlContent += `<ul style="margin: 5px 0 5px 20px; font-size: 14px; line-height: 1.8;">`;

                if (stav.relax > 0) htmlContent += `<li>Relax mechanismy / Recliner mechanisms: ${stav.relax}×</li>`;
                if (stav.vysuv > 0) htmlContent += `<li>Elektrické díly / Electric parts: ${stav.vysuv}×</li>`;

                const celkemMechanismu = stav.relax + stav.vysuv;
                if (celkemMechanismu === 0) {
                    htmlContent += `<li style="color: #999;">Nebyly vybrány žádné mechanismy / No mechanisms selected</li>`;
                }

                htmlContent += `</ul>`;
            }

            // Doplňkové služby
            htmlContent += `<p style="font-size: 14px; margin: 8px 0;"><strong>Doplňkové služby</strong> <span style="color: #888; font-style: italic;">/ Additional Services</span></p>`;
            htmlContent += `<ul style="margin: 5px 0 5px 20px; font-size: 14px; line-height: 1.8;">`;

            if (stav.tezkyNabytek) {
                htmlContent += `<li>Druhá osoba / Second person (těžký nábytek / heavy furniture >50kg): Ano / Yes</li>`;
            }
            if (stav.material) {
                htmlContent += `<li>Materiál dodán od WGS / Material supplied by WGS: Ano / Yes</li>`;
            }
            if (stav.vyzvednutiSklad) {
                htmlContent += `<li>Vyzvednutí dílu na skladě / Part pickup at warehouse: Ano / Yes</li>`;
            }
            if (!stav.tezkyNabytek && !stav.material && !stav.vyzvednutiSklad) {
                htmlContent += `<li style="color: #999;">Žádné doplňkové služby / No additional services</li>`;
            }

            htmlContent += `</ul>`;
            htmlContent += `</div>`;

            // CENOVÝ SOUHRN
            htmlContent += `
                <div style="margin: 30px 0; background: #f0f0f0; padding: 20px; border-radius: 8px;">
                    <h3 style="font-size: 18px; color: #2a2a2a; margin: 0 0 3px 0; font-weight: bold;">
                        Cenová kalkulace
                    </h3>
                    <span style="${enStyle}">Price Calculation</span>

                    <table style="width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 15px;">
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px 0;">Dopravné / Transport (${stav.vzdalenost} km × 2 × ${TRANSPORT_RATE}€)</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: bold;">${stav.dopravne.toFixed(2)} €</td>
                        </tr>
            `;

            // Diagnostika
            if (stav.typServisu === 'diagnostika') {
                htmlContent += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 8px 0;">Inspekce / Diagnostika <span style="color: #888; font-style: italic;">/ Inspection / Diagnostics</span></td>
                        <td style="padding: 8px 0; text-align: right; font-weight: bold;">${CENY.diagnostika.toFixed(2)} €</td>
                    </tr>
                `;
            }

            // Čalounické práce
            if (stav.typServisu === 'calouneni' || stav.typServisu === 'kombinace') {
                const celkemDilu = stav.sedaky + stav.operky + stav.podrucky + stav.panely;
                if (celkemDilu > 0) {
                    const cenaDilu = celkemDilu === 1 ? CENY.prvniDil : CENY.prvniDil + (celkemDilu - 1) * CENY.dalsiDil;
                    const dilText = celkemDilu === 1 ? 'díl / part' : 'dílů / parts';
                    htmlContent += `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px 0;">Čalounické práce / Upholstery (${celkemDilu} ${dilText})</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: bold;">${cenaDilu.toFixed(2)} €</td>
                        </tr>
                    `;
                    if (celkemDilu > 1) {
                        htmlContent += `
                            <tr>
                                <td colspan="2" style="padding: 4px 0 8px 20px; font-size: 12px; color: #666;">
                                    ↳ První díl / First part: ${CENY.prvniDil}€, další / additional: ${celkemDilu - 1}× ${CENY.dalsiDil}€
                                </td>
                            </tr>
                        `;
                    }
                }
            }

            // Mechanické práce
            if (stav.typServisu === 'mechanika' || stav.typServisu === 'kombinace') {
                // Pokud je POUZE mechanika, přidat základní sazbu
                if (stav.typServisu === 'mechanika') {
                    htmlContent += `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px 0;">Základní servisní sazba / Basic service fee</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: bold;">${CENY.zakladniSazba.toFixed(2)} €</td>
                        </tr>
                    `;
                }

                const celkemMechanismu = stav.relax + stav.vysuv;
                if (celkemMechanismu > 0) {
                    const cenaMechanismu = celkemMechanismu * CENY.mechanismusPriplatek;
                    htmlContent += `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px 0;">Mechanické části / Mechanical parts (${celkemMechanismu}× mechanism)</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: bold;">${cenaMechanismu.toFixed(2)} €</td>
                        </tr>
                    `;
                    if (stav.relax > 0 || stav.vysuv > 0) {
                        let detaily = '';
                        if (stav.relax > 0) detaily += `Relax / Recliner: ${stav.relax}× ${CENY.mechanismusPriplatek}€`;
                        if (stav.vysuv > 0) {
                            if (detaily) detaily += ', ';
                            detaily += `Elektrické / Electric: ${stav.vysuv}× ${CENY.mechanismusPriplatek}€`;
                        }
                        htmlContent += `
                            <tr>
                                <td colspan="2" style="padding: 4px 0 8px 20px; font-size: 12px; color: #666;">
                                    ↳ ${detaily}
                                </td>
                            </tr>
                        `;
                    }
                }
            }

            // Druhá osoba
            if (stav.tezkyNabytek) {
                htmlContent += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 8px 0;">Druhá osoba / Second person (>50kg)</td>
                        <td style="padding: 8px 0; text-align: right; font-weight: bold;">${CENY.druhaOsoba.toFixed(2)} €</td>
                    </tr>
                `;
            }

            // Materiál
            if (stav.material) {
                htmlContent += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 8px 0;">Materiál od WGS / Material from WGS</td>
                        <td style="padding: 8px 0; text-align: right; font-weight: bold;">${CENY.material.toFixed(2)} €</td>
                    </tr>
                `;
            }

            // Vyzvednutí na skladě
            if (stav.vyzvednutiSklad) {
                htmlContent += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 8px 0;">Vyzvednutí dílu / Part pickup</td>
                        <td style="padding: 8px 0; text-align: right; font-weight: bold;">${CENY.vyzvednutiSklad.toFixed(2)} €</td>
                    </tr>
                `;
            }

            htmlContent += `
                        <tr style="border-top: 3px solid #4a4a4a;">
                            <td style="padding: 15px 0; font-size: 18px; font-weight: bold;">CELKOVÁ CENA / TOTAL PRICE</td>
                            <td style="padding: 15px 0; text-align: right; font-size: 18px; font-weight: bold; color: #2a2a2a;">
                                ${celkem.toFixed(2)} €
                            </td>
                        </tr>
                    </table>
                </div>

                <div style="background: #f5f5f5; border-left: 4px solid #666; padding: 15px; margin: 30px 0; font-size: 12px; color: #666;">
                    Ceny jsou uvedeny bez DPH. / Prices are excluding VAT.
                </div>

                <div style="text-align: center; margin-top: 50px; font-size: 11px; color: #999;">
                    <p style="margin: 5px 0;"><strong>White Glove Service s.r.o.</strong> | www.wgs-service.cz</p>
                    <p style="margin: 5px 0;">Do Dubče 364, Běchovice 190 11 | Tel: +420 725 965 826</p>
                    <p style="margin: 5px 0;">Vygenerováno / Generated: ${new Date().toLocaleString('cs-CZ')}</p>
                </div>
            `;

            pdfContent.innerHTML = htmlContent;
            document.body.appendChild(pdfContent);

            // Počkat na reflow
            await new Promise(resolve => setTimeout(resolve, 100));

            // Převést HTML na canvas (stejné nastavení jako protokol.php)
            const canvas = await html2canvas(pdfContent, {
                scale: 3,
                backgroundColor: '#ffffff',
                useCORS: true,
                logging: false,
                imageTimeout: 0,
                allowTaint: true,
                letterRendering: true
            });

            // Vytvořit PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            const imgData = canvas.toDataURL('image/jpeg', 0.98);

            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 10;

            const availableWidth = pageWidth - (margin * 2);
            const availableHeight = pageHeight - (margin * 2);

            const canvasRatio = canvas.height / canvas.width;

            let imgWidth = availableWidth;
            let imgHeight = imgWidth * canvasRatio;

            if (imgHeight > availableHeight) {
                imgHeight = availableHeight;
                imgWidth = imgHeight / canvasRatio;
            }

            const xOffset = (pageWidth - imgWidth) / 2;
            const yOffset = margin;

            doc.addImage(imgData, 'JPEG', xOffset, yOffset, imgWidth, imgHeight);

            // Odstranit dočasný element
            document.body.removeChild(pdfContent);

            // Stáhnout PDF
            const nazevSouboru = `kalkulace_${new Date().getTime()}.pdf`;
            doc.save(nazevSouboru);

        } catch (error) {
            console.error('[Kalkulačka] Chyba při exportu PDF:', error);
            wgsToast.error(preklad('alert.pdfError'));
        }
    };

    // ========================================
    // NASTAVENÍ REŽIMU KALKULAČKY
    // ========================================
    window.nastavitKalkulackuRezim = function(rezim) {
        kalkulackaRezim = rezim;
    };

    // ========================================
    // ZAPOČÍTAT DO PROTOKOLU
    // ========================================
    window.zapocitatDoProtokolu = function() {
        // Vypočítat celkovou cenu
        let celkovaCena = stav.dopravne;

        // Diagnostika
        if (stav.typServisu === 'diagnostika') {
            celkovaCena += CENY.diagnostika;
        }

        // Čalounické práce
        if (stav.typServisu === 'calouneni' || stav.typServisu === 'kombinace') {
            const celkemDilu = stav.sedaky + stav.operky + stav.podrucky + stav.panely;
            if (celkemDilu > 0) {
                const cenaDilu = celkemDilu === 1 ?
                    CENY.prvniDil :
                    CENY.prvniDil + (celkemDilu - 1) * CENY.dalsiDil;
                celkovaCena += cenaDilu;
            }
        }

        // Mechanické práce
        if (stav.typServisu === 'mechanika' || stav.typServisu === 'kombinace') {
            // Pokud je POUZE mechanika, přidat základní sazbu
            if (stav.typServisu === 'mechanika') {
                celkovaCena += CENY.zakladniSazba;
            }

            const celkemMechanismu = stav.relax + stav.vysuv;
            if (celkemMechanismu > 0) {
                celkovaCena += celkemMechanismu * CENY.mechanismusPriplatek;
            }
        }

        // Druhá osoba
        if (stav.tezkyNabytek) {
            celkovaCena += CENY.druhaOsoba;
        }

        // Materiál
        if (stav.material) {
            celkovaCena += CENY.material;
        }

        // Vyzvednutí na skladě
        if (stav.vyzvednutiSklad) {
            celkovaCena += CENY.vyzvednutiSklad;
        }

        // Sestavit data pro protokol
        const kalkulaceData = {
            celkovaCena: celkovaCena,
            adresa: stav.adresa,
            vzdalenost: stav.vzdalenost,
            dopravne: stav.dopravne,
            reklamaceBezDopravy: stav.reklamaceBezDopravy,
            vyzvednutiSklad: stav.vyzvednutiSklad,
            typServisu: stav.typServisu,
            rozpis: {
                diagnostika: stav.typServisu === 'diagnostika' ? CENY.diagnostika : 0,
                calouneni: {
                    sedaky: stav.sedaky,
                    operky: stav.operky,
                    podrucky: stav.podrucky,
                    panely: stav.panely
                },
                mechanika: {
                    relax: stav.relax,
                    vysuv: stav.vysuv
                },
                doplnky: {
                    tezkyNabytek: stav.tezkyNabytek,
                    material: stav.material,
                    vyzvednutiSklad: stav.vyzvednutiSklad
                }
            }
        };

        // Zavolat callback do protokolu
        if (typeof window.protokolKalkulacka !== 'undefined' &&
            typeof window.protokolKalkulacka.zpracovatVysledek === 'function') {
            window.protokolKalkulacka.zpracovatVysledek(kalkulaceData);
        } else {
            console.error('[Kalkulačka] Funkce protokolKalkulacka.zpracovatVysledek není dostupná!');
            wgsToast.error('Chyba: Nelze přenést data do protokolu.');
        }
    };

})();

// ========================================
// ACTION REGISTRY - Registrace akcí pro event delegation (Step 116)
// ========================================
if (typeof window.Utils !== 'undefined' && window.Utils.registerAction) {
    // Wizard navigace
    window.Utils.registerAction('nextStep', () => {
        if (typeof window.nextStep === 'function') {
            window.nextStep();
        }
    });

    window.Utils.registerAction('previousStep', () => {
        if (typeof window.previousStep === 'function') {
            window.previousStep();
        }
    });

    // Counter ovládání (s parametrem data-counter)
    window.Utils.registerAction('incrementCounter', (el, data) => {
        if (data.counter && typeof window.incrementCounter === 'function') {
            window.incrementCounter(data.counter);
        }
    });

    window.Utils.registerAction('decrementCounter', (el, data) => {
        if (data.counter && typeof window.decrementCounter === 'function') {
            window.decrementCounter(data.counter);
        }
    });

    // Export a reset
    window.Utils.registerAction('exportovatCenikPDF', () => {
        if (typeof window.exportovatCenikPDF === 'function') {
            window.exportovatCenikPDF();
        }
    });

    window.Utils.registerAction('resetovatKalkulacku', () => {
        if (typeof window.resetovatKalkulacku === 'function') {
            window.resetovatKalkulacku();
        }
    });

    // Protokol režim
    window.Utils.registerAction('zapocitatDoProtokolu', () => {
        if (typeof window.zapocitatDoProtokolu === 'function') {
            window.zapocitatDoProtokolu();
        }
    });
}
