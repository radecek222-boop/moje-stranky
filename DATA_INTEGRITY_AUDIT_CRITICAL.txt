â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          KOMPLETNÃ DATA INTEGRITY AUDIT - KRITICKÃ‰ NÃLEZY                          â•‘
â•‘                    WGS Service CMS - PHP Projekt                                   â•‘
â•‘                        Datum: 2025-11-14                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. KRITICKÃ‰ PROBLÃ‰MY - DATABASE TRANSACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ KRITICKÃ PROBLÃ‰M #1: VytvÃ¡Å™enÃ­ reklamace bez transakce
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FILE: /home/user/moje-stranky/app/controllers/save.php
LINES: 429-439 (CREATE action)
SEVERITY: KRITICKÃ‰
RISK: Data Corruption

PROBLÃ‰M:
- INSERT do wgs_reklamace bez beginTransaction()
- Pokud INSERT selÅ¾e, workflow ID (Å™Ã¡dka 375) je vygenerovÃ¡no ale neuloÅ¾eno
- Atomicita ztracena - Å¾Ã¡dnÃ½ rollback

KÃ“DOVÃ PÅ˜ÃKLAD:
    $sql = 'INSERT INTO wgs_reklamace (...) VALUES (...)';
    $stmt = $pdo->prepare($sql);
    if (!$stmt->execute($parameters)) {
        throw new Exception('Chyba pÅ™i uklÃ¡dÃ¡nÃ­ do databÃ¡ze');  // Ale workflow ID je ztraceno!
    }

Å˜EÅ ENÃ:
- PÅ™idat $pdo->beginTransaction() pÅ™ed generovÃ¡nÃ­m workflow ID
- PÅ™idat commit() po ÃºspÄ›Å¡nÃ©m INSERT
- PÅ™idat rollback() v catch bloku


âŒ KRITICKÃ PROBLÃ‰M #2: Upload fotky - Orphan files risk
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FILE: /home/user/moje-stranky/app/controllers/save_photos.php
LINES: 168-193 (fotografickÃ© operace)
SEVERITY: KRITICKÃ‰
RISK: Orphan Files + Database Inconsistency

PROBLÃ‰M:
1. Soubor je uloÅ¾en na disk PRVNÃ (Å™Ã¡dka 168):
   if (file_put_contents($filePath, $photoData) === false)
   
2. Database INSERT je DRUHÃ (Å™Ã¡dka 176-193):
   $stmt = $pdo->prepare("INSERT INTO wgs_photos ...")
   $stmt->execute([...])

POÅ˜ADÃ PROBLÃ‰M:
   File write âœ“ â†’ DB INSERT âœ— â†’ ORPHAN FILE NA DISKU!

Å˜EÅ ENÃ - MoÅ¾nost A (DoporuÄeno):
- ZaÄÃ­t s transakce: $pdo->beginTransaction()
- DB INSERT PRVNÃ (s test reklamace na existenci)
- Pak file_put_contents()
- Commit aÅ¾ kdyÅ¾ je vÅ¡e OK
- Rollback smaÅ¾e DB zÃ¡znam, file se neuloÅ¾Ã­

Å˜EÅ ENÃ - MoÅ¾nost B:
- File write v tmp adresÃ¡Å™i
- Pak DB INSERT
- Pak move temp file na finÃ¡lnÃ­ lokaci


âŒ KRITICKÃ PROBLÃ‰M #3: PDF upload - StejnÃ½ problÃ©m
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FILE: /home/user/moje-stranky/api/protokol_api.php
FUNCTION: savePdfDocument()
LINES: 177, 198-233
SEVERITY: KRITICKÃ‰
RISK: Orphan Files

PROBLÃ‰M:
1. PDF se uloÅ¾Ã­ na disk (Å™Ã¡dka 177)
2. Pak se INSERT/UPDATE do wgs_documents (Å™Ã¡dky 198-233)
3. Pokud DB operace selÅ¾e, PDF zÅ¯stane na disku

DODATEÄŒNÃ PROBLÃ‰M:
- UPDATE a INSERT nejsou v transakci (Å™Ã¡dky 196-233)
- Pokud je existujÃ­cÃ­ dokument (Å™Ã¡dka 196), UPDATE se provede
- Pokud UPDATE selÅ¾e, PDF je stÃ¡le na disku ale nebyl uloÅ¾en do DB

Å˜EÅ ENÃ: Jako u save_photos.php


âŒ KRITICKÃ PROBLÃ‰M #4: Email queue - Status transitions bez transakce
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FILE: /home/user/moje-stranky/includes/EmailQueue.php
LINES: 233-292 (processQueue)
LINES: 297-303 (updateStatus)
SEVERITY: KRITICKÃ‰
RISK: Permanent Lock of Emails

PROBLÃ‰M:
1. updateStatus($id, 'sending') - UPDATE bez transakce (Å™Ã¡dka 258)
2. sendEmail($email) - ExternÃ­ operace (Å™Ã¡dka 261)
3. updateStatus($id, 'sent') - DruhÃ½ UPDATE bez transakce (Å™Ã¡dka 265)

SELHÃNÃ SCÃ‰NÃÅ˜:
- Email se oznaÄÃ­ 'sending'
- sendEmail() timeout/crash
- updateStatus() se neprovolÃ¡ â†’ Email ZÅ®STANE V STAVU 'sending' NAVÅ½DY
- Cron nikdy nezkusÃ­ odeslat znovu

PROBLÃ‰M PARALLEL PROCESSING:
- 2 cron jobsy mohou paralelnÄ› zpracovÃ¡vat stejnÃ½ email
- ObÄ› nastavÃ­ status='sending'
- ObÄ› se pokusÃ­ odeslat stejnÃ½ email

Å˜EÅ ENÃ:
- Transakce kolem updateStatus + sendEmail
- SELECT ... FOR UPDATE pro zamÄenÃ­ Å™Ã¡dku
- Nebo: INSERT novÃ½ pokus s timestamp, UPDATE starÃ½ pokus jen pokud je v 'pending'


âŒ KRITICKÃ PROBLÃ‰M #5: GitHub Webhook - Orphaned records
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FILE: /home/user/moje-stranky/api/github_webhook.php
LINES: 168-201
SEVERITY: KRITICKÃ‰
RISK: Database Orphan Records

PROBLÃ‰M:
1. INSERT do wgs_github_webhooks (Å™Ã¡dka 168-182)
2. $webhookId = $pdo->lastInsertId() (Å™Ã¡dka 184)
3. INSERT do wgs_pending_actions s source_id=$webhookId (Å™Ã¡dka 188-200)

SELHÃNÃ SCÃ‰NÃÅ˜:
- Webhook INSERT âœ“
- lastInsertId() OK
- Pending Action INSERT âœ— â†’ Webhook zÅ¯stane bez action reference

DODATEÄŒNÃ PROBLÃ‰M:
- NenÃ­ FK constraint
- Pokud se webhook smaÅ¾e, orphan action zÅ¯stane

Å˜EÅ ENÃ:
- $pdo->beginTransaction() na zaÄÃ¡tku
- $pdo->commit() na konci
- $pdo->rollBack() v catch bloku


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
2. RACE CONDITIONS - UNIQUE CONSTRAINT PROBLEMY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸ PROBLÃ‰M #6: Email registration - Duplicate key race condition
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FILE: /home/user/moje-stranky/app/controllers/registration_controller.php
LINES: 40-65, 136-138
SEVERITY: VYSOKÃ (Race Condition)
RISK: Duplicate User Registration

PROBLÃ‰M:
1. beginTransaction() - Å™Ã¡dka 40
2. SELECT COUNT(*) na email - Å™Ã¡dka 62-65
3. Insert do wgs_users - Å™Ã¡dka 136

RACE CONDITION SCÃ‰NÃÅ˜ (Time-based):
T1: Request A - SELECT email 'test@example.com' â†’ NOT FOUND
T2: Request B - SELECT email 'test@example.com' â†’ NOT FOUND
T3: Request A - INSERT 'test@example.com' â†’ SUCCESS
T4: Request B - INSERT 'test@example.com' â†’ DUPLICATE KEY ERROR âœ—

PROBLÃ‰M:
- 2 SELECTs vidÃ­ stejnÃ½ stav (email neexistuje)
- Oba se pokusÃ­ INSERT se stejnou email
- Jeden selÅ¾e s DUPLICATE KEY ERROR
- User se nedokonÄÃ­ registrovat

Å˜EÅ ENÃ:
- ZmÄ›nit na SELECT ... FOR UPDATE (pessimistic lock)
- Nebo: INSERT ... ON DUPLICATE KEY UPDATE
- Nebo: Spolehnat se na UNIQUE constraint s error handling


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
3. ORPHAN FILES - SEZNAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ Fotky bez DB reference:
   FILE: /home/user/moje-stranky/app/controllers/save_photos.php:168
   â†’ Pokud file_put_contents() selÅ¾e a pak INSERT INTO wgs_photos selÅ¾e
   â†’ Fotka zÅ¯stane na /uploads/reklamace_XXX/photo_*.jpg

âŒ PDF bez DB reference:
   FILE: /home/user/moje-stranky/api/protokol_api.php:177
   â†’ Pokud file_put_contents() selÅ¾e a pak INSERT INTO wgs_documents selÅ¾e
   â†’ PDF zÅ¯stane na /uploads/protokoly/XXX.pdf

âœ… DELETE je sprÃ¡vnÄ›:
   FILE: /home/user/moje-stranky/api/delete_reklamace.php:163
   â†’ cleanupUploadedFiles() je volÃ¡n PO commit()
   â†’ Pokud file delete selÅ¾e, DB zmÄ›ny jsou already committed
   â†’ âš ï¸ Ale: Orphan files mohou zÅ¯stat pokud delete_reklamace.php selÅ¾e


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
4. CHYBÄšJÃCÃ FOREIGN KEY CONSTRAINTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸ Tabulky bez FK constraints na wgs_reklamace:
   - wgs_photos.reklamace_id - NEMA FK â†’ orphan photos
   - wgs_documents.claim_id - NEMA FK â†’ orphan documents
   - wgs_notes.claim_id - NEMA FK â†’ orphan notes
   - wgs_notifications.claim_id - NEMA FK â†’ orphan notifications

âŒ ManuÃ¡lnÃ­ cascade delete mÃ­sto FK:
   FILE: /home/user/moje-stranky/api/delete_reklamace.php:98-143
   - DELETE FROM wgs_photos WHERE reklamace_id = :id (Å™Ã¡dka 108)
   - DELETE FROM wgs_documents WHERE claim_id = :id (Å™Ã¡dka 123)
   - DELETE FROM wgs_notes WHERE claim_id = :id (Å™Ã¡dka 129)
   - DELETE FROM wgs_notifications WHERE claim_id = :id (Å™Ã¡dka 135)

   RIZIKO: Pokud delete_reklamace.php se neprovede (error, API call selhÃ¡n), 
           orphan records zÅ¯stanou v DB NAVÅ½DY

Å˜EÅ ENÃ:
- PÅ™idat FK constraints:
  ALTER TABLE wgs_photos ADD FOREIGN KEY (reklamace_id) 
    REFERENCES wgs_reklamace(reklamace_id) ON DELETE CASCADE;
  
- Pak s FK constraints se automatickÃ© cascade delete provede
- Nebudete potÅ™ebovat manuÃ¡lnÃ­ DELETEs


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
5. LOOP UPDATES BEZ TRANSAKCÃ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ PROBLÃ‰M #7: control_center_tools.php - Auto-fix visibility loop
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FILE: /home/user/moje-stranky/includes/control_center_tools.php
LINES: 25-66
SEVERITY: VYSOKÃ
RISK: Partial state corruption

PROBLÃ‰M:
foreach ($users as $user) {
    $stmt = $pdo->prepare("UPDATE wgs_reklamace SET created_by = :user_id ...");
    $stmt->execute([...]);  // UPDATE #1 OK
    $affected = $stmt->rowCount();
    // Pokud UPDATE #N selÅ¾e (N > 1), UPDATE #1 aÅ¾ #N-1 zÅ¯stanou committed
}

SELHÃNÃ SCÃ‰NÃÅ˜:
- UPDATE pro uÅ¾ivatele 1 â†’ OK (3 reklamace zmapovÃ¡ny)
- UPDATE pro uÅ¾ivatele 2 â†’ OK (5 reklamacÃ­ zmapovÃ¡ny)
- UPDATE pro uÅ¾ivatele 3 â†’ ERROR (DB error)
- VÃ½sledek: 8 z 10 reklamacÃ­ mÃ¡ created_by, 2 majÃ­ NULL

Å˜EÅ ENÃ:
- PÅ™idat beginTransaction() na zaÄÃ¡tku loopa
- PÅ™idat commit() na konci
- PÅ™idat rollback() v catch


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
6. CONTROL CENTER API - Theme updates bez transakce
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ PROBLÃ‰M #8: control_center_api.php - Save theme settings
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FILE: /home/user/moje-stranky/api/control_center_api.php
LINES: 122-160 (case 'save_theme')
SEVERITY: STÅ˜EDNÃ
RISK: Partial theme update

PROBLÃ‰M:
foreach ($settings as $key => $value) {
    $stmt->execute([...]);  // INSERT ON DUPLICATE KEY UPDATE
    // Pokud INSERT #N selÅ¾e, INSERT #1 aÅ¾ #N-1 zÅ¯stanou
}

SELHÃNÃ SCÃ‰NÃÅ˜:
- UloÅ¾it 10 theme nastavenÃ­
- 1-7 jsou OK
- #8 ERROR
- Theme bude v nekonzistentnÃ­m stavu (7 nastavenÃ­, 3 starÃ¡)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
7. SHRNUTÃ A PRIORITIZACE OPRAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”´ KRITICKÃ‰ (Fix immediately):
   1. save.php CREATE - Add transaction (Line: 429)
   2. save_photos.php - Reorder file+DB operations (Line: 168)
   3. protokol_api.php - Reorder file+DB operations (Line: 177)
   4. github_webhook.php - Add transaction (Line: 168)
   5. EmailQueue processQueue - Add transaction (Line: 258)

ğŸŸ  VYSOKÃ (Fix soon):
   1. registration_controller.php - Add SELECT FOR UPDATE (Line: 62)
   2. control_center_tools.php - Add transaction in loop (Line: 38)
   3. cron/process-email-queue.php - Add transaction (Line: 102)
   4. notes_api.php - Add transaction (Line: 119, 155)
   5. admin_api.php - Add transaction (Line: 149)

ğŸŸ¡ STÅ˜EDNÃ (Fix as part of refactoring):
   1. control_center_api.php - Add transaction in loop (Line: 141)
   2. Add FK constraints on orphan-prone tables
   3. Replace manual cascades with FK constraints
   4. Add file atomicity wrapper function


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
8. SOUBOR S KONKRÃ‰TNÃMI KÃ“DOVÃMI LOKACEMI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FILE: /home/user/moje-stranky/app/controllers/save.php
- PROBLÃ‰M #1: Lines 429-439 (CREATE bez transaction)
- Å˜EÅ ENÃ: PÅ™idat transaction wrapper

FILE: /home/user/moje-stranky/app/controllers/save_photos.php
- PROBLÃ‰M #2: Line 168 (File-first approach)
- Å˜EÅ ENÃ: Reorder operations + transaction

FILE: /home/user/moje-stranky/api/protokol_api.php
- PROBLÃ‰M #3: Line 177 (File-first approach)
- Å˜EÅ ENÃ: Reorder operations + transaction

FILE: /home/user/moje-stranky/includes/EmailQueue.php
- PROBLÃ‰M #4: Lines 258, 265, 274 (Status transitions)
- Å˜EÅ ENÃ: Transakce kolem status changes

FILE: /home/user/moje-stranky/api/github_webhook.php
- PROBLÃ‰M #5: Lines 168-200 (Orphaned INSERTs)
- Å˜EÅ ENÃ: Transakce kolem dvou INSERTs

FILE: /home/user/moje-stranky/app/controllers/registration_controller.php
- PROBLÃ‰M #6: Line 62-65 (Race condition)
- Å˜EÅ ENÃ: SELECT ... FOR UPDATE

FILE: /home/user/moje-stranky/includes/control_center_tools.php
- PROBLÃ‰M #7: Line 38-42 (Loop UPDATE)
- Å˜EÅ ENÃ: Transakce kolem loopa

FILE: /home/user/moje-stranky/cron/process-email-queue.php
- PROBLÃ‰M: Line 102 (Email status without transaction)
- Å˜EÅ ENÃ: Transakce kolem status updates

KONEC AUDITÅ®
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
